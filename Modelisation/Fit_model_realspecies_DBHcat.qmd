---
title: "Fit_model_realspecies_DBHcat"
author: "Vincyane Badouard"
format: html
editor: visual
---

# Objectives

Run the logistic quadratic model for real species, with the log of the transmittance as explanatory variable, and with DBH categorized.

For different form of species niche: 2 convex, sigmo, 2 concaves, 2 no-effects

Which species:  
- 2 convex: Licania_alba, Licania_membranacea
- sigmo: no ones
- 2 concaves: Oxandra_asbeckii, Iryanthera_hostmannii
- 2 no-effects: Lecythis_persistens, Eschweilera_sagotiana

DBH categories : 1-5, 10-20, >20

# Packages
```{r, include = F}
library(tidyverse)
library(rstan)
rstan_options(auto_write = TRUE) # option pour ne pas recompiler à chaque fois !!! gain de temps
options(mc.cores = parallel::detectCores()) #option pour ajouter des coeurs au calcul
rstan_options(disable_march_warning = TRUE)

library(bayesplot) # visualiser la chaine de Markov
# library(shinystan) # for interactive stan output visualization
library(rstanarm) # for Bayesian automatic regression modelling using stan
library(brms) # Bayesian generalized multivariate non-linear multilevel models using stan
library(foreach) # parallisation
library(parallel)
```

# Prepare data

```{r, include = F, message=F}
Inv <- read_csv("D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/P16_Paracou_InvandEnv.csv") %>% 
  select(-`...1`)
```

## Only sp enough abundant in < and > 10 cm DBH
```{r}
Inv <- Inv %>% 
  na.omit() %>% 
  mutate(logTransmittance =  log(Transmittance))

## Only sp enough abundant in < and > 10 cm DBH
data <- Inv %>%
  na.omit() %>% 
  mutate(ALT = ifelse(DBHcor <10, T, F))

Guyafor <- data %>% # 808
  filter(!ALT) %>% 
  group_by(ScientificName) %>%
  mutate(N = n()) %>%
  ungroup() %>%
  # Take only sp >= 30 ind
  filter(N >= 30)


ALT <- data %>% #5887
  filter(ALT) %>%  
  filter(ScientificName %in% Guyafor$ScientificName | Strategy=="Understory species") %>%
  group_by(ScientificName) %>%
  mutate(N = n()) %>%
  ungroup() %>%
  # Take only sp >= 30 ind
  filter(N >= 30)

s <- Guyafor$ScientificName %in% ALT$ScientificName

Guyafor <- Guyafor %>% # 736
  dplyr::filter(s) 

data <- ALT %>% #6623
  bind_rows(Guyafor) %>% 
  arrange(Strategy, N) %>% 
  mutate(cl = ifelse(Strategy =="Understory species" & !is.na(Strategy), "#009E73",
                     "#E7B800")) %>% # color per sp strategy
  select(-N) %>% 
  group_by(ScientificName) %>% 
  mutate(N = n()) %>% 
  ungroup() 

nrow(data)==(nrow(ALT)+nrow(Guyafor))
length(unique(data$ScientificName)) # 34 sp (4ha)

rm(Inv, ALT, Guyafor, s)
```

# Attribute DBH categories
1-10, 10-20, >20
```{r}
data <- data %>%
  mutate(Size = factor(case_when(
    # DBHcor < 10 ~ "1-10",
    # DBHcor >= 10 ~ ">10"), levels = c("1-10",">10")) 
    # DBHcor < 5 ~ "1-5",
    DBHcor < 10 ~ "1-10",
    # DBHcor >= 5 & DBHcor < 10 ~ "5-10",
    DBHcor >= 10 & DBHcor < 20 ~ "10-20",
    DBHcor >= 20 ~ ">20"), levels = c(
      # "1-5",
      "1-10",
      # "5-10",
      "10-20",
      ">20"))
  )

data <- data %>% 
  group_by(ScientificName, Size) %>% 
  mutate(NSt = n())

```

# Create presence-absence data format for each species

```{r}
# Create a list of the inventory replicated, 1 per ScientificName and per DBH category
datalist <- replicate(
  length(unique(data$ScientificName))*length(unique(data$Size)),
  data, simplify = F) 
# 34*3 = 102

names(datalist) <- sort(paste(
  rep(unique(data$ScientificName), length(unique(data$Size))),
  rep(unique(data$Size), length(unique(data$ScientificName))),
  sep= " - ")) # per ScientificName and per DBH category

# filter per DBH category
datalist <- lapply(names(datalist), function(name) {
  datalist[[name]] <- filter(datalist[[name]], Size==gsub(".*- ","",name))
  datalist[[name]]  # Return modified data frame
})
names(datalist) <- sort(paste(
  rep(unique(data$ScientificName), length(unique(data$Size))),
  rep(unique(data$Size), length(unique(data$ScientificName))),
  sep= " - ")) # per ScientificName and per DBH category

# Presence=1 if it's a the interest species, 0 if not
datalist <- lapply(names(datalist), function(name) {
  datalist[[name]]$Presence <- ifelse(
    datalist[[name]]$ScientificName == data.table::tstrsplit(name, split = " - ")[[1]], 1, 0)
  datalist[[name]]  # Return modified data frame
})
names(datalist) <- sort(paste(
  rep(unique(data$ScientificName), length(unique(data$Size))),
  rep(unique(data$Size), length(unique(data$ScientificName))),
  sep= " - ")) # per ScientificName and per DBH category

# view(datalist[["Anaxagorea_acuminata - 10-20"]])

# Remove data.frames without presence
datalist <- Filter(\(df) any(df$Presence==1), datalist) # 60

```

# Species filter 
```{r, eval = F}
sp <- c("Licania_alba" , "Licania_membranacea", "Oxandra_asbeckii",
        "Iryanthera_hostmannii", "Lecythis_persistens", "Eschweilera_sagotiana") # 6

datalist <- datalist[
  data.table::tstrsplit(names(datalist),
                        split = " - ")[[1]] %in% sp] # only species in sp
# 18

rm(data)
```

# Run models

```{r}
load("D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/Fits/Realsp_light_DBHcat.Rdata")
```

```{r Create a liste with data definitions as in the rstan file, eval=F}
dataM <- lapply(datalist, function(x) list(N = nrow(x), #les noms des var doivent etre les memes que dans le fichier stan
                                           Presence = x$Presence,
                                           Environment = x$logTransmittance))

Model <- stan_model("Bernoulli_EnvOnly_quadratic.stan") # remove rds file if doest work
# num <- 4
# fit <- stan(file= "Bernoulli_EnvOnly_quadratic.stan", data = dataM[[num]], chains = 4, iter = 2000) # 15h28 - 31


# fit
# 16h13 - 16h20 1er, 2e, 3 finissent quasi en meme temps, 16h22 le 4e finit - total 9 min
gc()
cores = min(c(length(dataM), 5)) # nbr of cores to use, not more than 5
# parallel::detectCores() # 8
i <- NULL
j = length(dataM)

# L'enregistrement des clusters
cl <- parallel::makeCluster(cores, outfile = "")
doSNOW::registerDoSNOW(cl)

writeLines(c(""), "Realsp_DBHcat_log.txt") # to create a log file

# Progress bar:
# pb <- txtProgressBar(min = 0, max = j, style = 3)
pb <- txtProgressBar(max=j)
# progress <- function(n) setTxtProgressBar(pb, n)
progress <- function(n) cat(sprintf("Run %d is complete\n", n))
opts <- list(progress = progress)

Sys.time()
fits <- foreach::foreach(
  i=1:j,
  .packages = c("rstan"), # necessary packages
  .options.snow = opts, # ProgressBar
  .combine = c
) %dopar% {
  sink("Realsp_DBHcat_log.txt", append=TRUE) # for the log file
  # the function to parallelise:
  stan(file= "Bernoulli_EnvOnly_quadratic.stan", data = dataM[[i]], chains = 4, iter = 2000)
}
# close progressbar and cluster
close(pb)
stopCluster(cl)
Sys.time() # 1h
names(fits) <- names(dataM) 
# fits[[1]]

save(fits, file = "D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/Fits/Realsp_light_DBHcat.Rdata") # need a absolute path after cluster
```

```{r}
# summaryfits <- lapply(names(fits), function(x)
as.data.frame(summary(fits[["Licania_membranacea"]],
                      pars = c("alpha", "beta1", "beta2", "o"))$summary[, c("50%", "2.5%", "97.5%")]) %>% 
  tibble::rownames_to_column("Parameters")
# )
names(summaryfits) <- names(fits)
# summaryfits <- bind_rows(summaryfits, .id = "type")
# 
# summaryM <- dataParamL %>% 
#   left_join(summaryfits, by = c("type", "Parameters")) %>% 
#   mutate(Difference = round(`50%`-Initial,2))
# 
# summaryM
```

# Diagnostic plots

## Chains

```{r, eval= F, visualiser la progression des chaînes pour chaque paramètres}
mcmc_trace(as.array(fit), #as.array = comme vecteurs
           pars = c("alpha", "beta1", "beta2"),
           np = nuts_params(fit))

# rank histogram plots (Vehtarh et al., 2021)
mcmc_rank_hist(as.array(fits[[behaviour]]), pars = c("alpha", "beta1", "beta2"), ref_line = TRUE)

lapply(names(fits), function(x) mcmc_trace(as.array(fits[[x]]), #as.array = comme vecteurs
                                           # facet_args=list(labeller=label_parsed), #pour mettre en lettre greques
                                           pars = c("alpha", "beta1", "beta2"),
                                           np = nuts_params(fits[[x]])) # np pour afficher la divergeance
)
```

## Parameters correlation

```{r, eval=F, visualiser la relation entre chaque paramètre}
mcmc_pairs(as.array(fit), pars = c("alpha", "beta1", "beta2", "lp__", "o"))

#les paramètres doivent être indépendants et former une patate à leur valeur correspondant aux données.
lapply(names(fits), function(x) mcmc_pairs(as.array(fits[[x]]), pars = c("alpha", "beta1", "beta2")))
```

## Posteriors

```{r, vue 3D des posteriors}
mcmc_areas(as.array(fit), prob=0.95, pars = c("alpha", "beta1", "beta2")) +
  labs(title=names(fit))

p <- lapply(names(fits), function(x) mcmc_areas(as.array(fits[[x]]), prob=0.95, pars = c("alpha", "beta1", "beta2")) +
              labs(title=paste(x,"b= -4; c= -0.8")))

save(p, file = "./Plots/Posteriors_PA_1-10.Rdata")
```

```{r, vue 2D des posteriors}
mcmc_intervals(as.array(fit), prob=0.95, pars = c("alpha", "beta1", "beta2"))

lapply(names(fits), function(x) mcmc_intervals(as.array(fits[[x]]), prob=0.95, pars = c("alpha", "beta1", "beta2"))) # + # vu du dessus
# scale_x_continuous(limits = c(-15, 15), breaks = seq(-15,15, by=1)) 
```

# Predictions plots

## for 1 dataset

```{r, eval=F}
# Simulations mean
pdata <- cbind(mu = apply(as.matrix(fit, pars = "p"), 2, median),# 2 for columns;  mean of all sim
               t(apply(as.matrix(fit, pars = "p"), 2,
                       quantile, probs = c(0.05, 0.95))),
               Opt = apply(as.matrix(fit, pars = "o"), 2, median)
               # Opt = t(apply(as.matrix(fit, pars = "o"), 2,
               #               quantile, probs = c(0.05, 0.95)))
) %>% # optimum
  cbind(datalist[[num]])

S <- unique(pdata[pdata$Presence==1,]$ScientificName)

ggplot(pdata, aes(x = logTransmittance)) +
  theme_minimal() +
  # Presences
  geom_point(aes(y = Presence, col = as.factor(Presence))) +
  # Probas
  geom_point(aes(y = mu), size=0.7) +
  geom_ribbon(aes(ymin = `5%`, ymax = `95%`), color = 'red', alpha = 0.2) + # 95% enveloppe
  # Optimum
  geom_vline(aes(xintercept = Opt), color = "#00AFBB") +
  # geom_vline(aes(xintercept = `Opt.5%`), linetype="dashed") +
  # geom_vline(aes(xintercept = `Opt.95%`), linetype="dashed") +
  labs(title = paste(S,"- Predicts median"), x ="logTransmittance", y = "Presence probability", col= "Presence-absence")

ggsave(paste(S,"_Predicts median.png", sep=""),
       path = "D:/Mes Donnees/PhD/Figures/Modelisation",
       width = 15, height = 15, units = "cm", dpi=800, bg="white")
```

## Facet

```{r}
# Sys.time() # 30 min
# 
# data <- lapply(as.list(names(dataM)), function(speciesSt)
#   cbind(speciesSt = speciesSt, datalist[[speciesSt]],
#         mu = apply(as.matrix(fits[[speciesSt]], pars = "p"), 2, median),
#         t(apply(as.matrix(fits[[speciesSt]], pars = "p"), 2,
#                 quantile, probs = c(0.05, 0.95))),
#         Opt = apply(as.matrix(fits[[speciesSt]], pars = "o"), 2, median),
#         as.data.frame(t(apply(as.matrix(fits[[speciesSt]], pars = "o"), 2,
#                       quantile, probs = c(0.05, 0.95))), row.names = NULL) %>%
#           rename(`Opt.5%` = `5%`) %>% rename(`Opt.95%` = `95%`)  
#   )) %>% 
#   bind_rows()
# Sys.time() 
# 
# save(data, file = "D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/Fits/Realsp_light_DBHcat_mediandata.Rdata")

load("D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/Fits/Realsp_light_DBHcat_mediandata.Rdata")
```

# log
```{r}
plist <- vector('list', length(unique(data$speciesSt)))

for(p in 1:length(unique(data$speciesSt))){
  plist[[p]] <- local({
    
    dataS <- data %>% 
      filter(speciesSt==unique(data$speciesSt)[p])
    
    cl <- unique((dataS[dataS$ScientificName == data.table::tstrsplit(dataS$speciesSt, split = " - ")[[1]],])$cl)
    
    # label <- dataS %>% 
    #   mutate(NSt = ifelse(
    #     ScientificName == data.table::tstrsplit(speciesSt,
    #                                             split = " - ")[[1]],
    #     paste("N: ", n()), NA)) %>% 
    #   filter(!is.na(NSt))
    
    NSt <- unique((dataS[dataS$ScientificName == data.table::tstrsplit(dataS$speciesSt, split = " - ")[[1]],])$NSt)
    
    ggplot(dataS, aes(x = logTransmittance)) +
      # xlim(0,1) +
      theme_classic() +
      theme(plot.title = element_text(colour = cl)) +
      # Presences
      # geom_point(aes(y = Presence, col = as.factor(Presence))) +
      # Probas
      geom_point(aes(y = mu), size=0.7) +
      geom_ribbon(aes(ymin = `5%`, ymax = `95%`), color = 'red', alpha = 0.2) +
      # Optimum
      geom_vline(aes(xintercept = Opt), color = "#00AFBB", linewidth=1) + # exp to delog
      geom_vline(aes(xintercept = `Opt.5%`), linetype="dashed") +
      geom_vline(aes(xintercept = `Opt.95%`), linetype="dashed") +
      labs(title = paste(unique(dataS$speciesSt), " N=",NSt, sep=""), y = "Presence probability", col= "Presence-absence")
    
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 3, ncol = 3)
# plots

ggsave("RealspPredictsMedian_DBHcat_log.pdf",
       path = "D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/Plots",
       plots, width = 15, height = 10)
Sys.time()
```

# Delog

```{r}
plist <- vector('list', length(unique(data$speciesSt)))

for(p in 1:length(unique(data$speciesSt))){
  plist[[p]] <- local({
    
    dataS <- data %>% 
      filter(speciesSt==unique(data$speciesSt)[p])
    
    cl <- unique((dataS[dataS$ScientificName == data.table::tstrsplit(dataS$speciesSt, split = " - ")[[1]],])$cl)
    
    # label <- dataS %>% 
    #   mutate(NSt = ifelse(
    #     ScientificName == data.table::tstrsplit(speciesSt,
    #                                             split = " - ")[[1]],
    #     paste("N: ", n()), NA)) %>% 
    #   filter(!is.na(NSt))
    
    NSt <- unique((dataS[dataS$ScientificName == data.table::tstrsplit(dataS$speciesSt, split = " - ")[[1]],])$NSt)
    
    ggplot(dataS, aes(x = Transmittance)) +
      xlim(0,1) +
      theme_classic() +
      theme(plot.title = element_text(colour = cl)) +
      # Presences
      # geom_point(aes(y = Presence, col = as.factor(Presence))) +
      # Probas
      geom_point(aes(y = mu), size=0.7) +
      geom_ribbon(aes(ymin = `5%`, ymax = `95%`), color = 'red', alpha = 0.2) +
      # Optimum
      geom_vline(aes(xintercept = exp(Opt)), color = "#00AFBB", linewidth=1) + # exp to delog
      geom_vline(aes(xintercept = exp(`Opt.5%`)), linetype="dashed") +
      geom_vline(aes(xintercept = exp(`Opt.95%`)), linetype="dashed") +
      labs(title = paste(unique(dataS$speciesSt), " N=",NSt, sep=""), y = "Presence probability", col= "Presence-absence")
    
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 3, ncol = 3)
# plots

ggsave("RealspPredictsMedian_DBHcat_notlog.pdf",
       path = "D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/Plots",
       plots, width = 15, height = 10)
Sys.time()
```
