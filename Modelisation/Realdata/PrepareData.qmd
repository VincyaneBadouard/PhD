# Prepare data

# Packages
```{r Setup, include = F}
library(readr)
library(tidyverse)
```

```{r, include = F, message=F}
Inv <- read_csv("D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/P16_Paracou_InvandEnv.csv")
```

```{r}
Inv <- Inv %>% 
  mutate(logTransmittance =  log(Transmittance)) %>% 
  mutate(logTWI = log(TWI)) %>% 
  mutate(logDBH = log(DBHcor))

```

```{r}
summary(Inv)
```

# Create presence-absence data format for each species
```{r}
sp <- (read.csv("D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/InterestSpecies.csv")[,2]) # 75
# length(unique(sp))

# Create a list of the inventory replicated, 1 per ScientificName
datalist <- replicate(length(sp), Inv, simplify = F) 
names(datalist) <- sp # 1 per ScientificName

# Presence=1 if it's the interest species, 0 if not
datalist <- lapply(names(datalist), function(name) {
  datalist[[name]]$Presence <- ifelse(
    !is.na(datalist[[name]]$ScientificName) & datalist[[name]]$ScientificName == name, 1, 0)
  
  datalist[[name]]  # Return modified data frame
})
names(datalist) <- sp # 75

# view(datalist[["Anaxagorea_dolichocarpa"]])
```

```{r}
save(datalist, file= "D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/Realdata/Realsp_25ha.Rdata")

# load("D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/Realdata/Realsp_25ha.Rdata")
```

# Balance presence and absence
```{r}
# Take all the presences and the same nbr of absences (allready done)
# pres <- Residuals %>% filter(y==1)
# abs <- Residuals %>%
#   filter(y==0) %>%
#   sample_n(nrow(pres))
# samp <- bind_rows(pres, abs)

datalist_bal <- lapply(names(datalist), function(name) {
  
  pres <- datalist[[name]] %>% filter(Presence==1)
  abs <- datalist[[name]] %>%
    filter(Presence==0) %>%
    sample_n(nrow(pres))
  samp <- bind_rows(pres, abs)
  datalist[[name]] <- samp
  datalist[[name]]  # Return modified data frame
})

names(datalist_bal) <- sp # 75

```

```{r}
save(datalist_bal, file= "D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/Realdata/Realsp_25ha_balanced.Rdata")

# load("D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/Realdata/Realsp_25ha_balanced.Rdata")
```

# Join eigenvectors
```{r}
filelist <- list.files("D:/Mes Donnees/PhD/Inventories/Data/Agregation/Eigenvectors/", full.names=T)
eigenval <- lapply(filelist, read_csv)
filelist <- gsub("D:/Mes Donnees/PhD/Inventories/Data/Agregation/Eigenvectors/", "", filelist)
filelist <- gsub(".csv", "", filelist)

names(eigenval) <- filelist
```

```{r}
datalist_eig <- datalist

# str(datalist_eig[[1]])

datalist_eig <- lapply(names(datalist), function(name) {
  
  if(name %in% names(eigenval)){
    datalist_eig[[name]] <- datalist_eig[[name]] %>%
      left_join(unique(eigenval[[name]]), by=c("Xutm", "Yutm"), copy = T)
  }
  datalist_eig[[name]]  # Return modified data frame
})

names(datalist_eig) <- names(datalist) 

datalist_eig[["Dicorynia_guianensis"]]
```


```{r}
save(datalist_eig, file= "D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/Realdata/Realsp_25ha_eigenvectors.Rdata")

# load("D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/Realdata/Realsp_25ha_eigenvectors.Rdata")
```

