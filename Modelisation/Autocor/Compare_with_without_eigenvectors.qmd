---
title: "Compare models with and without space predictors"
date: "`r Sys.Date()`"
format: html
self-contained: true
theme: cosmo
editor: source
code-fold: true
---

```{r setup}
library(tidyverse)
library(cmdstanr)
library(bayesplot)

sp <- (read.csv("D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/InterestSpecies.csv")[,3]) # 75

# sp <- c("Anaxagorea_dolichocarpa", "Tabernaemontana_macrocalyx", "Eperua_falcata", "Dicorynia_guianensis", "Paypayrola_hulkiana")

# sp <- "Dicorynia_guianensis"

PATH = '../Light_Topo'
```

```{r fit}
fits <- list()
for(S in sp){
  tryCatch({
    chain_path <- file.path(PATH, "Chains", "Hybrid", S)
    fits[[S]] <- as_cmdstan_fit(list.files(chain_path,
                                           full.names = TRUE))},
    error=function(e){cat("ERROR :",S, conditionMessage(e), "\n")}
  )
}

fits_eig <- list()
for(S in sp){
  tryCatch({
    chain_path <- file.path(PATH, "Chains", "Hybrid_eigenvectors", S)
    fits_eig[[S]] <- as_cmdstan_fit(list.files(chain_path,
                                               full.names = TRUE)[c(1,4)])
  },
  error=function(e){cat("ERROR :",S, conditionMessage(e), "\n")}
  )
}
names(fits_eig[["Dicorynia_guianensis"]])
```

```{r divergence, eval=F}
Div <- lapply(names(fits), function(x)
  data.frame(Species = x,
             Chain = c(1:4),
             Divergences = fits[[x]]$diagnostic_summary("divergences"), # divergences per chain
             Divergences_eigen = fits_eig[[x]]$diagnostic_summary("divergences") # divergences per chain
  ) 
) %>% 
  bind_rows() %>% 
  rename(Divergences = num_divergent) %>%
  rename(Divergences_eigen = num_divergent.1) %>%
  group_by(Species) %>% 
  mutate(`%divergence` = sum(Divergences)/4000*100) %>% 
  mutate(`%divergence_eigen` = sum(Divergences_eigen)/4000*100) %>% 
  ungroup()
```

# Rhat
R-hat convergence diagnostic, which compares the between- and within-chain estimates for model parameters and other univariate quantities of interest. If chains have not mixed well (ie, the between- and within-chain estimates don't agree), R-hat is larger than 1.01 (Vehtari et al., 2021). 
R-hat which is the maximum of rank normalized split-R-hat and rank normalized folded-split-R-hat, which works for thick tailed distributions and is sensitive also to differences in scale.
```{r Rhat, eval=F}
Rhat_table <- lapply(names(fits), function(x)
  fits[[x]]$summary(c("alpha", "beta1", "beta2_p", "tau"), "rhat") %>% 
    mutate(Species = x) %>% 
    select(Species, variable, rhat) %>% 
    mutate(rhat_eig = fits_eig[[x]]$summary(c("alpha", "beta1", "beta2_p", "tau"), "rhat")$rhat)
) %>% 
  bind_rows()

# bayesplot::rhat(fits[[1]],pars="beta2_p")
# posterior::rhat(extract_variable_matrix(fits[[1]], "beta2_p"))

all(Rhat_table$rhat_eig < 1.01)

badRhat <- Rhat_table %>% filter(rhat > 1.01 | rhat_eig > 1.01) %>%
  left_join(Div %>% select(Species, `%divergence`, `%divergence_eigen`) %>% unique(), by="Species")
```

```{r, eval=F}
lapply(unique(badRhat$Species) , function(x)
  fits[[x]]$draws(c("alpha", "beta1", "beta2_p", "tau")) %>% 
    mcmc_trace() +
    ggtitle(paste("Without eigenvectors - ",x))
)

lapply(unique(badRhat$Species) , function(x)
  fits_eig[[x]]$draws(c("alpha", "beta1", "beta2_p", "tau")) %>% 
    mcmc_trace() +
    ggtitle(paste("With eigenvectors - ",x))
)
```

# Posteriors
Plot central (quantile-based) posterior interval estimates from MCMC draws
```{r}
# Plot data
datap <- lapply(names(fits), function(x)
  mcmc_intervals_data(fits[[x]]$draws(c("a", "O", "tau")),
                      prob = 0.5, prob_outer = 0.95, point_est = "median") %>% 
    mutate(Eigenvectors = 'FALSE') %>% 
    bind_rows(
      mcmc_intervals_data(fits_eig[[x]]$draws(c("a", "O", "tau")),
                          prob = 0.5, prob_outer = 0.95, point_est = "median") %>% 
        mutate(Eigenvectors = 'TRUE')
    ) %>% 
    mutate(Species = x)  %>% 
    mutate(Eigenvectors = factor(Eigenvectors, levels = c('TRUE','FALSE')))
  
)  %>% 
  bind_rows()

O_sg <- datap %>% 
  # mutate(incertitude = hh-ll) %>% 
  # filter(parameter=="O"& incertitude > 4) %>%
  filter(parameter=="a"& m > -0.02) %>% # no light effect
  select(Species, Eigenvectors) %>% 
  mutate(parameter="O") %>% 
  mutate(Sg_effect = F)

datap <- datap %>%
  left_join(O_sg, by=c("Species", "Eigenvectors", "parameter")) %>% 
  # tau significantly different of 0
  mutate(Sg_effect = ifelse(parameter=="tau" & ll<0 & 0<hh, F, Sg_effect))  %>% 
  mutate(Sg_effect = ifelse(is.na(Sg_effect), T, Sg_effect))

# ll : outer start
# l : iner start
# m : point_est value
# h : iner end
# hh : outer end

# mcmc_intervals() code 
# trace(bayesplot::mcmc_intervals, edit=T)

# 0 line
x_lim <- range(c(datap$ll, datap$hh))
x_range <- diff(x_lim)
x_lim[1] <- x_lim[1] - 0.05 * x_range
x_lim[2] <- x_lim[2] + 0.05 * x_range

# 0 line
layer_vertical_line <- if (0 > x_lim[1] && 0 < x_lim[2]) {
  vline_0(color = "darkred", linewidth = 0.5, linetype = "dashed")
}
```

```{r}
ggplot(datap, aes(y = Species, col = Eigenvectors, alpha = Sg_effect)) +
  theme_minimal() + 
  # xlim(range(c(datap$ll, datap$hh))) +
  layer_vertical_line +
  geom_segment(aes(x=ll, xend=hh, y=Species, yend=Species), size = 0.5) +
  geom_segment(aes(x=l, xend=h, y=Species, yend=Species), size = 1) +
  geom_point(aes(x= m)) + # median
  scale_color_manual(values=c('TRUE' = "#009E73", 'FALSE' = "#FC4E07")) +
  # scale_color_manual(name = "Credible interval",
  #                    values = c("95%" = "#E7B800",
  #                               "50%"= "#FC4E07")) +
  theme(axis.title.x =element_blank()) +
  facet_grid(~parameter, scale= "free")


ggsave("Light_topo_posteriors_comparaison_autocor.pdf", path = "//amap-data.cirad.fr/work/users/VincyaneBadouard/Modelisation/Plots",
       width = 25, height = 26, units = "cm", dpi=800, bg="white")
```

Comparaison des résultats avec et sans autocor :  

+ de divergences avec le modèle avec autocor mais meilleur Rhat et meilleur mix des chaînes  

Tau (topo effect) :  
- valeurs proches en général  
- Ryania speciosa :  plateau > no effect  
- Pogonophora : plateau > no effect (Vincent 2011 : plateau)  
- esch sago : plateau > no effect  
- Dicorynia : plateau > no effect (Allié, Bonal : plateau)  
- Faramea : plateau incertain > no effect  
- guarea costata : BF > no effect  
- Palicourea : BF > no effect  
- ocotea argy : BF > no effect  
- mouriri sago :  BF > no effect  
- esch coria :  BF > no effect  
- Micropholis no effect > BF  
- poraqueiba : no effect > BF  

-> est-ce que c'est aberrant de ne pas trouver Dicorynia en plateau ? D'après le modèle avec ontogénie (sans autocor)   il se spécialise en plateau à l'âge adulte donc on pourrait le trouver généraliste à l'échelle spécifique  

a ( largeur de niche) :  
- valeurs similaires  

O (optimum de lumière) :  
- valeurs proches/similaires, diagnostic cohérent du no effect  