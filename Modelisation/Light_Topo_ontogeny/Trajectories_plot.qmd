---
title: "Trajectories plot"
date: "`r Sys.Date()`"
format: html
self-contained: true
theme: cosmo
editor: source
code-fold: true
---
pas de couleur mais ajouter wetter, drier
```{r setup}
library(tidyverse)
library(viridis)
library(posterior)
library(factoextra)
library(grid)
library(patchwork)

PATH <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Modelisation/Plots/Light_topo_onto/Autocor"

posteriors <- read_csv(paste(PATH, "/Posteriors.csv", sep =''))
muche <- read_csv(paste(PATH, "/Light_ontogenic_trajectories.csv", sep =''))
Summary <- read_csv(paste(PATH,'/Trajectories_summary_allsp_5-14.csv',sep='')) %>% 
  select(Mega_categories, N, `%`) %>% 
  unique()

```

```{r}
Q80 <- posteriors %>% 
  filter(variable =="O")

datap <- muche %>% 
  mutate(`O_>25` = as.character(`O_>25`)) %>% 
  pivot_longer(cols = starts_with("O_"),
               values_to = "O") %>% 
  mutate(DBH = str_remove(name, "O_")) %>% 
  select(-name) %>% 
  left_join(Q80, by = c("Species", "DBH")) %>% 
  mutate(DBH = factor(DBH, levels=c("1-3","3-10","10-25",">25"))) %>% 
  select(Species, Mega_categories, DBH, O) %>% 
  left_join(Summary, by ='Mega_categories') %>% 
  mutate(Mega_categories = factor(Mega_categories, levels = Summary$Mega_categories)) %>% 
  arrange(Mega_categories) %>% 
  mutate(Species = str_replace(Species, "_", " "))

```

# With smooth
```{r}
plist <- list()
# C = 'shade-light'
for(C in unique(datap$Mega_categories)){
  if(!grepl("generalist", C)){
    if(unique((datap %>% filter(Mega_categories==C))$N)>1){
      
      plist[[C]] <- local({
        
        # print(
        dataC <- datap %>% 
          filter(Mega_categories==C) %>% 
          mutate(O = as.numeric(O))
        ggplot(dataC, aes(x = DBH, y = O)) +
          theme_minimal() +
          # geom_segment(aes(y=ll, yend=hh, x=DBH, xend=DBH), size = 0.2, linetype = 'dashed') +
          # geom_segment(aes(y=l, yend=h, x=DBH, xend=DBH), size = 1, linetype = 'dashed') +
          # geom_point() +
          geom_line(aes(group=Species), linewidth=0.5, col= "grey") + 
          geom_smooth(aes(x = as.numeric(DBH), y = O), col = 'red', alpha=0.2) +
          scale_y_continuous(name = "Light (% transmittance)",
                             limits = c(min(as.numeric(datap$O), na.rm = T),0),
                             n.breaks = 10, labels = ~round(exp(.)*100,2)) +
          labs(title=paste(C, ' (',round(unique(dataC$`%`)),'%)', sep=""), x= 'DBH (cm)') +
          theme(axis.title=element_blank(), plot.title.position = "plot") +
          coord_flip()
        
        # )
      })
    }
  }
  
}

# plots <- gridExtra::marrangeGrob(plist, nrow = 3, ncol = 3) # 
# # plots
# 
# ggsave("Trajectories_nonflat_smooth_bigcategories.pdf",
#        path = PATH,
#        plots, width = 15, height = 10)
```
## Rares
```{r}
plist[['rare']] <- local({
  
  # print(
  rares <- datap %>% 
    filter(N==1) %>% 
    filter(!grepl("generalist", Mega_categories)) %>% 
    mutate(O = as.numeric(O))
  ggplot(rares, aes(x = DBH, y = O)) +
    theme_minimal() +
    geom_line(aes(group=Species), linewidth=0.5, col= "grey") + 
    geom_smooth(aes(x = as.numeric(DBH), y = O), col = 'red', alpha=0.2) +
    scale_y_continuous(name = "Light (% transmittance)",
                       limits = c(min(as.numeric(datap$O), na.rm = T),0),
                       n.breaks = 10, labels = ~round(exp(.)*100,2)) +
    labs(title=paste(paste(unique(rares$Mega_categories), collapse="/"),
                     ' (',round(sum(rares$`%`[c(1,nrow(rares))])),'%)', sep=''), x= 'DBH (cm)') +
    theme(axis.title=element_blank(), plot.title.position = "plot") +
    coord_flip()
})

```

```{r}
plots <- gridExtra::marrangeGrob(plist, nrow = 3, ncol = 3)

ggsave("Trajectories_nonflat_smooth_bigcategories_flip.pdf",
       path = PATH,
       plots, width = 15, height = 10)


multiplots <- ggpubr::ggarrange(plotlist = plist, nrow = 3, ncol = 3)
# ggpubr::annotate_figure(multiplots, left = textGrob("Light (% transmittance)", rot = 90, vjust = .5, gp = gpar(cex = 1.3)),
#                         bottom = textGrob("DBH (cm)", gp = gpar(cex = 1.3)))
ggpubr::annotate_figure(multiplots, left = textGrob("DBH (cm)", rot = 90, vjust = .5, gp = gpar(cex = 1.3)),
                        bottom = textGrob("Light (% transmittance)", gp = gpar(cex = 1.3)))


ggsave("Trajectories_nonflat_smooth_bigcategories_flip.png",
       path = PATH,
       width = 23, height = 15, units = "cm", dpi=800, bg="white")

```

## Flats
```{r}
# C="intermediate-generalist-light"
plist <- list()

data_flat <- datap %>% 
  filter(O!="NA") %>% 
  mutate(O = ifelse(O!="flat", as.character(round(exp(as.numeric(O))*100,2)), O))

for(C in unique(datap$Mega_categories)){
  if(grepl("generalist", C)){
    plist[[C]] <- local({
      
      data_C <- data_flat %>% 
        filter(Mega_categories==C)
      
      # print(
      data_C %>% 
        mutate(O = factor(O, levels = unique(data_C$O))) %>% 
        
        ggplot(aes(x = DBH, y = O, col=Species, group=Species)) +
        theme_minimal() +
        geom_point() +
        geom_line() +
        # scale_y_discrete(name = "Light (% transmittance)",
        # limits = c("0","100")) +
        # breaks = labels(data_flat$O)) + # [seq(1, length(levels(data_flat$O)), by = 2)]
        labs(title=C, x= 'DBH (cm)', y= 'Light (% transmittance)')
      
      # )
    })
  }
  
}

plots <- gridExtra::marrangeGrob(plist, nrow = 2, ncol = 2) # 75
# plots

# ggsave("Trajectories_withflat.pdf",
#        path = PATH,
#        plots, width = 15, height = 10)

```

# With species in colors
```{r}
marge <- -10
plist <- list()
# C = 'shade-light'
for(C in unique(datap$Mega_categories)){
  if(!grepl("generalist", C)){
    if(unique((datap %>% filter(Mega_categories==C))$N)>1){
      
      plist[[C]] <- local({
        
        # print(
        dataC <- datap %>% 
          filter(Mega_categories==C) %>% 
          mutate(O = as.numeric(O))
        ggplot(dataC, aes(x = DBH, y = O, group=Species, col=Species)) +
          theme_minimal() +
          # geom_segment(aes(y=ll, yend=hh, x=DBH, xend=DBH), size = 0.2, linetype = 'dashed') +
          # geom_segment(aes(y=l, yend=h, x=DBH, xend=DBH), size = 1, linetype = 'dashed') +
          # geom_point() +
          geom_line() + 
          scale_y_continuous(name = "Light (% transmittance)",
                             limits = c(min(as.numeric(datap$O), na.rm = T),0),
                             n.breaks = 10, labels = ~round(exp(.)*100,2)) +
          labs(title=paste(C, ' (',round(unique(dataC$`%`)),'%)', sep=""), x= 'DBH (cm)') +
          # {if(C == 'shade-light') guides(col= guide_legend(ncol = 2)) } +
          theme(axis.title=element_blank(), plot.title.position = "plot",
                legend.margin=margin(0,0,0,0),
                legend.box.margin=margin(marge,marge,marge,marge)) +
          coord_flip()
        
        # )
      })
    }
  }
  
}
```
## Rares
```{r}
plist[['rare']] <- local({
  
  # print(
  rares <- datap %>% 
    filter(N==1) %>% 
    filter(!grepl("generalist", Mega_categories)) %>% 
    mutate(O = as.numeric(O))
  ggplot(rares, aes(x = DBH, y = O, group=Species, col=Species)) +
    theme_minimal() +
    geom_line() + 
    scale_y_continuous(name = "Light (% transmittance)",
                       limits = c(min(as.numeric(datap$O), na.rm = T),0),
                       n.breaks = 10, labels = ~round(exp(.)*100,2)) +
    labs(title=paste(paste(unique(rares$Mega_categories), collapse="/"),
                     ' (',round(sum(rares$`%`[c(1,nrow(rares))])),'%)', sep=''), x= 'DBH (cm)') +
    theme(axis.title=element_blank(), plot.title.position = "plot",
          legend.margin=margin(0,0,0,0),
          legend.box.margin=margin(marge,marge,marge,marge)) +
    coord_flip()
})

```

```{r}
plots <- gridExtra::marrangeGrob(plist, nrow = 2, ncol = 2)

ggsave("Trajectories_nonflat_species_bigcategories_flip.pdf",
       path = PATH,
       plots, width = 15, height = 10)
```

```{r}

plist[[1]] | (plist[[2]] / plist[[3]])
ggsave("Trajectories_nonflat_species_bigcategories_flip_1.png",
       path = PATH,
       width = 23, height = 15, units = "cm", dpi=800, bg="white")

(plist[[4]] | plist[[5]]) / (plist[[6]] | plist[[7]]) 
ggsave("Trajectories_nonflat_species_bigcategories_flip_2.png",
       path = PATH,
       width = 23, height = 15, units = "cm", dpi=800, bg="white")


```

# Stature vs trajectories
```{r}
H_allometry <- read_csv('D:/Mes Donnees/PhD/Inventories/Data/Height-Diameter/H_allometry_method.csv')

Stature <- read_csv("D:/Mes Donnees/PhD/Inventories/Data/Adults_Understory/Paracou/P16_2019_Paracou_InvandEnv.csv") %>% 
  filter(SubPlot %in% c(13,14,15,18,19,20,23,24,25)) %>% 
  # select(ScientificName, TreeHeight)
  group_by(ScientificName) %>% 
  summarise(TreeHeightQ95 = quantile(TreeHeight, 0.95, na.rm=T)) %>%
  ungroup() %>% 
  left_join(H_allometry, by='ScientificName') %>% 
  mutate(Species = str_replace(ScientificName, "_", " "))

datapp <- datap %>% left_join(Stature, by='Species') %>% 
  select(Species, Mega_categories, TreeHeightQ95) %>% 
  unique() %>% 
  mutate(Mega_categories = factor(Mega_categories,
                                  levels = c("generalist", 'shade',
                                             "shade-intermediate", "generalist-intermediate", "intermediate-light",
                                             "intermediate-shade-light", "shade-light",
                                             "light-shade-light", "light-shade", "light-intermediate-light"))) 
```

```{r}
label <- datapp %>% 
  group_by(Mega_categories) %>% 
  summarise(N = paste("N: ", n()))

ggplot(datapp, aes(x=Mega_categories, y=TreeHeightQ95)) + 
  theme_minimal() + 
  geom_boxplot() +
  # stat_summary(fun = "length", hjust = 0.5, vjust = 0.9) +
  geom_text(data = label, aes(label = N, x= Mega_categories),
            y = Inf, vjust = 1.5, show.legend = F) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y= "Species Q95% tree height (m)", x= 'Species temperament trajectories accros ontogeny') +
  theme(legend.position="bottom")


ggsave("TreeHeightQ95_vs_trajectories.png", path = PATH,
       width = 14, height = 10, units = "cm", dpi=800, bg="white")
```

