---
params:
  species: Paypayrola_hulkiana
title: "Residuals explo plots"
subtitle: "*`r params$sp`*"
format: html
self-contained: true
theme: cosmo
editor: source
code-fold: true
---

# Objectives
to see how well our model is fitting the data.  
Residuals are the differences between what we observe and what our model predicts.  

Si les résidus sont uniformément distribués leur médiane est proche de 0, et la valeur mimimum et maximum <3 en absolu. Les résidus supérieurs à la valeur absolue de 3 se situent dans les queues d'une distribution normale standard et indiquent généralement une déformation du modèle.  


Aggregatives species :\
- Anaxagorea_dolichocarpa\
- Tabernaemontana_macrocalyx  
- Eperua_falcata  
- Dicorynia_guianensis  
- Paypayrola_hulkiana  

Raw residual : the difference between what we observe (Y~i~) and the predicted probability (P~i~) for each observation, it ranges between -1 and 1.  

https://library.virginia.edu/data/articles/understanding-deviance-residuals#:~:text=It%20turns%20out%20there%20are,probability%20(%5Epi  

# Packages
```{r setup, include = F}
library(tidyverse)
library(cmdstanr)

sp <- params$species
print(sp)
```

# Load residulas and Moran's I tables computed on the cluster
```{r}
rslts <- readRDS(paste("D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/Light_Topo_ontogeny/Residuals_explo/Residuals_Moran/Residuals_Moran_", sp, ".rds", sep=""))

# files <- list.files("D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/Light_Topo_ontogeny/Residuals_explo/Residuals_Moran",
#                     pattern = ".rds", full.names = T)
# rslts <- lapply(files, readRDS)
# 
# files <- str_remove(files, "D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/Light_Topo_ontogeny/Residuals_explo/Residuals_Moran/Residuals_Moran_")
# files <- str_remove(files, ".rds")

# names(rslts) <- files
```

```{r}
# sp <- c("Anaxagorea_dolichocarpa", "Tabernaemontana_macrocalyx", "Eperua_falcata", "Dicorynia_guianensis", "Paypayrola_hulkiana")

Residuals <- rslts$Residuals
Moran_raw <- rslts$Moran_raw %>% mutate(Type = "raw")
Moran_Pearson <- rslts$Moran_Pearson %>% mutate(Type = "Pearson")
Moran_Deviance <- rslts$Moran_Deviance %>% mutate(Type = "Deviance")

Moran <- bind_rows(Moran_raw, Moran_Pearson, Moran_Deviance)
```

```{r}
path <- "D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/"
load(paste(path, "Realdata/Realsp_25ha.Rdata", sep=''))
datalist <- datalist[names(datalist) %in% sp] # only species in sp

Residuals <- Residuals %>% 
  bind_cols(datalist[[sp]] %>% select(logDBH, Transmittance, logTransmittance, TWI, logTWI, Elevation, HAND))
```

```{r}
Residuals_covar <- Residuals %>% pivot_longer(cols = c(logDBH, logTransmittance, logTWI, Elevation, HAND),
                                        names_to = "Var", values_to = "Covar")
```

# Residus - relation with models variables
```{r}
library(patchwork)
xs <- split(Residuals_covar, f = Residuals_covar$y)

# Residuals_covar %>% 
p1 <- xs$`1` %>% 
  ggplot(aes(x= Covar, y= raw_e)) +
  theme_minimal() +
  geom_point() +
  geom_smooth(method='lm', formula= y~x, col="red") +
  ggpubr::stat_cor(aes(label = ..r.label..),
                   label.x.npc = "center", label.y.npc = "bottom", digits = 1, col="red") +
  theme(axis.title.x=element_blank()) +
  facet_wrap(~Var, scales ="free", nrow = 1, ncol = 5)

p2 <- p1 %+% xs$`0`

p1/p2 + plot_annotation(title = sp, tag_levels = list(c("1","0")))
```

```{r}
cor(Residuals$raw_e, Residuals$Pearson_e) # 3e
cor(Residuals$raw_e, Residuals$Deviance_e) # la cor la + haute
cor(Residuals$Pearson_e, Residuals$Deviance_e) # 2e
```

```{r}
Residuals <- Residuals %>% pivot_longer(cols = c(raw_e, Pearson_e, Deviance_e),
                                        names_to = "Type", values_to = "Residuals")
```

# Residuals distribution
```{r}
ggplot(Residuals) +
  theme_minimal() +
  geom_histogram(aes(x=log(Residuals)), fill="#009E73", col="white") +
  facet_grid(~Type, scales ="free") +
  labs(title = sp)
```

# Plots the residuals against the predicted proba
```{r}
ggplot(Residuals, aes(x = p_hat, y = Residuals, col = as.factor(y))) +
  theme_minimal() +
  geom_point() +
  facet_wrap(~ Type, scales ="free") +
  labs(title = sp, x= "Presence probabily prediction",col = "Presence observation")

```

```{r}
library(sf)
P16 <- terra::vect("D:/Mes Donnees/PhD/R_codes/PhD/test/Plot16.shp") %>% 
  st_as_sf()
TopoLevels <- st_read("D:/Mes Donnees/PhD/SIG_data/Topo_P16_4classes/Topo4Levels.shp") %>% 
  filter(Plot==16) %>% mutate(TopoTypeEn = ifelse(idTopo ==38, "Downslope", TopoTypeEn)) %>% 
  mutate(TopoTypeEn = recode(TopoTypeEn, "Plateau" = "Hilltop")) %>% 
  st_set_crs(st_crs(P16))

xs <- split(Residuals %>% filter(y == 1), f = Residuals$Type)

p1 <- xs$raw_e %>% 
  # filter(y == 1) %>%  
  ggplot() + 
  theme_classic() +
  geom_sf(data = TopoLevels, aes(fill = TopoTypeEn)) +
  geom_sf(data = sf::st_cast(P16, "LINESTRING")) +
  scale_fill_manual(values = c("Hilltop" = "#009E73",
                               "Slope"= "#E7B800",
                               "Downslope"= "#bfe6eb", 
                               "Bottomland" = "#1f78b4"),
                    breaks = c("Hilltop", "Slope", "Downslope", "Bottomland")) +
  
  geom_point(aes(x = Xutm, y = Yutm, colour = Residuals, size=DBHcor)) +
  scale_size_continuous(range = c(0.5, 5)) +
  # coord_fixed(ratio = 1) +
  scale_color_gradient(low = "blue", high = "red") +
  facet_wrap(~ Type, scales ="fixed") + 
  theme(axis.title= element_blank(), axis.text= element_blank()) +
  theme(legend.position="bottom") +
  guides(size = F, fill =F)

p2 <- p1 %+% xs$Deviance_e
p3 <- p1 %+% xs$Pearson_e

gridExtra::grid.arrange(p1,p2,p3, nrow = 1, ncol = 3, top = grid::textGrob(paste(sp, "- presences")))
```

```{r}
xs <- split(Residuals %>% filter(y == 0), f = Residuals$Type)

p1 <- xs$raw_e %>% 
  # filter(y == 1) %>%  
  ggplot(aes(x = Xutm, y = Yutm, colour = Residuals)) + 
  theme_classic() +
  geom_point(size=0.5) +
  # coord_fixed(ratio = 1) +
  scale_color_gradient(low = "blue", high = "red") +
  facet_wrap(~ Type, scales ="fixed") + 
  theme(axis.title= element_blank(), axis.text= element_blank()) +
  theme(legend.position="bottom")

p2 <- p1 %+% xs$Deviance_e
p3 <- p1 %+% xs$Pearson_e

gridExtra::grid.arrange(p1,p2,p3, nrow = 1, ncol = 3, top = grid::textGrob(paste(sp, "- absences")))
```

# Moran's I correlogram
```{r }
Moran %>% 
  filter(dist.class < 500) %>% 
  ggplot(aes(x = dist.class, y = coef)) + 
  theme_minimal() +
  geom_hline(yintercept = 0) +
  geom_point(aes(alpha = p.value < 0.05)) +
  geom_line(col="red", linewidth =0.8) +
  xlab("Distance (m)") + ylab("Moran\'s I") +
  # scale_x_log10() +
  # xlim(0, 500) +
  # ylim(-1, 1) +
  facet_wrap(~ Type, scales ="fixed") + 
  ggtitle(paste(sp,"- Residuals spatial auto-correlation"))
```
