---
title: "Diagnose all DBH classes"
date: "`r Sys.Date()`"
format: html
self-contained: true
theme: cosmo
editor: source
code-fold: true
---

Changements figures :
Monoplot posterior :
- noms sp en y pas en x
- enlver les _ dans les noms d'sp
- noms d'sp en italique
- tau en lettre greque
- remplacer more/less flood tolerant par wetter, drier
- remplacé non-null effect par significiant

Biplot :
travailler les étiquettes pour que ttes les sp soient visibles

Biplot O-tau :
pas de couleur mais ajouter wetter, drier
```{r setup}
library(tidyverse)
library(cmdstanr)
library(bayesplot)
library(viridis)
library(posterior)
library(factoextra)
library(grid)

sp <- (read.csv("D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/InterestSpecies.csv")[,3])#[1:10]

Comb <- read.csv("D:/Mes Donnees/PhD/R_codes/PhD_cluster/Data/Combin_Sp_DBHclas.csv")

unique(Comb$DBH_classes)
# 75
# mettre le 2 avec la correc bota

# strategy <- read_delim("~/PhD/Inventories/Data/Understory/Paracou/Species_strategy.csv") %>% 
#   select(ScientificName, Strategy_VB) %>%
#   rename(Strategy = Strategy_VB) %>% 
#   unique()

Inv <- read_csv("D:/Mes Donnees/PhD/Inventories/Data/Adults_Understory/Paracou/P16_2019_Paracou_InvandEnv.csv") %>% 
  # select(ScientificName, TreeHeight)
  group_by(ScientificName) %>% 
  summarise(MaxTreeHeight = max(TreeHeight))

PATH <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Modelisation/Plots/Light_topo_onto/Autocor"
# /First10sp
```

# Fits
```{r fit}
fits <- list()
for(S in sp){
  # Filter species with only one DBH class
  if(length(list.files(file.path("Chains", "Hybrid_eigenvectors", S)))>1){
    
    for(D in c("1-3","3-10","10-25","-25")){
      # for(D in c("1-5","5-10","10-20","-20")){
      tryCatch({
        chain_path <- file.path("Chains", "Hybrid_eigenvectors", S, D) #  Hybrid_eigenvectors Hybrid_no_iota
        
        if(D=="-25") D <- ">25"
        # if(D=="-20") D <- v">20"
        
        fits[[S]][[D]] <- as_cmdstan_fit(list.files(chain_path,
                                                    full.names = TRUE))},
        error=function(e){cat("ERROR :",S, D, conditionMessage(e), "\n")}
      )
    }
  }}
# names(fits[["Symphonia_sp.1"]])

names(fits)[names(fits) == "-25"] <- ">25"
# names(fits)[names(fits) == "-20"] <- ">20"

sp[!sp %in% names(fits)] # "Ryania_speciosa""Palicourea_quadrifolia" "Ixora_ferrea" "Faramea_paniculata" "Eugenia_albicans" only 1 dbh class with more than 10 ind
# 70 sp with more than 1 DBH class

saveRDS(fits, file = paste(PATH, "/fits.rds", sep=''))
```

# Divergence
```{r divergence}
d <- list()
for(S in names(fits)){
  for(D in c("1-3","3-10","10-25",">25")){
    # for(D in c("1-5","5-10","10-20",">20")){
    
    if(D %in% names(fits[[S]])){
      
      d[[S]][[D]] <- data.frame(Species = S,
                                DBH = D,
                                Chain = c(1:4),
                                Divergences = fits[[S]][[D]]$diagnostic_summary("divergences") # divergences per chain
      )
    }}}
Div <- list_rbind(list_flatten(d)) %>% 
  bind_rows() %>% 
  rename(Divergences = num_divergent) %>% 
  group_by(Species) %>% 
  mutate(`%divergence` = sum(Divergences)/4000*100)

badDiv <- Div %>% filter(`%divergence` > 19) %>% 
  select(Species,`%divergence`) %>% unique()
```

# Rhat
R-hat convergence diagnostic, which compares the between- and within-chain estimates for model parameters and other univariate quantities of interest. If chains have not mixed well (ie, the between- and within-chain estimates don't agree), R-hat is larger than 1.01 (Vehtari et al., 2021). 
R-hat which is the maximum of rank normalized split-R-hat and rank normalized folded-split-R-hat, which works for thick tailed distributions and is sensitive also to differences in scale.
```{r Rhat}
d <- list()
for(S in names(fits)){
  for(D in c("1-3","3-10","10-25",">25")){
    # for(D in c("1-5","5-10","10-20",">20")){
    
    if(D %in% names(fits[[S]])){
      
      d[[S]][[D]] <- fits[[S]][[D]]$summary(c("O")) %>% # "alpha", "beta1", "beta2_p", "tau"
        mutate(Species = S) %>% 
        mutate(DBH = D) %>% 
        select(Species, DBH, variable, rhat) 
    }}}
Rhat_table <- list_rbind(list_flatten(d))


# bayesplot::rhat(fits[[1]],pars="beta2_p")
# posterior::rhat(extract_variable_matrix(fits[[1]], "beta2_p"))

all(Rhat_table$rhat < 1.01)

badRhat <- Rhat_table %>% filter(rhat > 1.01) %>%
  left_join(Div %>% select(Species, `%divergence`) %>% unique(), by="Species")

length(unique(badRhat$Species))
# (40/70)*100 = 53% for 1-5 classes (sans filtre pour le nombre d'individu)
# (46/70)*100 = 66% for 1-3 classes
# (26/70)*100 = 37% for 1-3 classes with autocor
# (21/70)*100 = 30% for 1-3 classes with autocor + 2019 light + corrected coordinates
# only on 1-3 and 3-10 dbh classes
# (6/70)*100  pour badrhat > 1.05
write_csv(badRhat, paste(PATH, "/badRhat.csv", sep=''))
```


# Chains
```{r}
name <- 
  # very bad mix
  # names(fits)[names(fits) %in% c('Hymenopus_heteromorphus','Duroia_longiflora',
  #                                'Eschweilera_congestiflora','Couma_guianensis',
  #                                'Chaetocarpus_schomburgkianus')]
  # bad mix
  names(fits)[names(fits) %in% c('Bocoa_prouacensis','Eugenia_coffeifolia', 'Catostemma_fragrans','Pradosia_cochlearia','Paypayrola_hulkiana', 'Licaria_debilis')]
  # good mix
  # names(fits)[!names(fits) %in% c('Hymenopus_heteromorphus','Duroia_longiflora',
  #                                 'Eschweilera_congestiflora','Couma_guianensis',
  #                                 'Chaetocarpus_schomburgkianus',
  #                                 'Bocoa_prouacensis','Eugenia_coffeifolia', 'Catostemma_fragrans','Pradosia_cochlearia','Paypayrola_hulkiana', "Licaria_debilis")]

# unique(badRhat$Species)
# unique(badDiv$Species)
sort(names(fits))

plist <- list()

for(S in name){
  # for(D in c("1-3","3-10")){
  
  plist[[S]] <- local({
    # for(D in c("1-5","5-10","10-20",">20")){
    # if(D %in% names(fits[[S]])){
    # if(any(D %in% badRhat[badRhat$Species==S,]$DBH)){
    # if(any(D %in% badDiv[badDiv$Species==S,]$DBH)){
    # S = "Talisia_sylvatica"
    # D = "5-10"
    print(
      fits[[S]][[D]]$draws( # [["3-10"]]
        c("lp__", "alpha", "beta1", "beta2_p", "O", "tau")
        # c("lp__", "a", "O", "gamma", "tau")
      ) %>% 
        mcmc_trace() +
        # mcmc_dens() +
        ggtitle(paste(S, D))
    )
  })
}
# }}

plots <- gridExtra::marrangeGrob(plist, nrow = 2, ncol = 2) # 75
# plots

ggsave("Bad_chains_mix.pdf",
       path = PATH,
       plots, width = 15, height = 10)

```
```{r}
Badmix <- Rhat_table %>% filter((Species %in% c('Hymenopus_heteromorphus','Duroia_longiflora',
                                                'Eschweilera_congestiflora','Couma_guianensis',
                                                'Chaetocarpus_schomburgkianus') & DBH == "1-3") | (
                                                  Species %in% c('Bocoa_prouacensis','Eugenia_coffeifolia', 'Catostemma_fragrans','Pradosia_cochlearia','Paypayrola_hulkiana') & DBH == "3-10")) %>%  left_join(Div %>% select(Species, `%divergence`) %>% unique(), by="Species")

Goodmix <- Rhat_table %>% filter(!Species %in% c('Hymenopus_heteromorphus','Duroia_longiflora',
                                                'Eschweilera_congestiflora','Couma_guianensis',
                                                'Chaetocarpus_schomburgkianus','Bocoa_prouacensis',
                                                'Eugenia_coffeifolia','Catostemma_fragrans','Pradosia_cochlearia',
                                                'Paypayrola_hulkiana')) %>%  left_join(Div %>% select(Species, `%divergence`) %>% unique(), by="Species")

# Both
range(Badmix$rhat) # 1.0003 - 1.09
range(Badmix$`%divergence`) # 11.6 - 63.8

# Only very bad mix
# 1.01 - 1.09
# 19.8 - 63.8

# Only bad mix
# 1.0003 - 1.005
# 11.6 - 35.8

# Good mix
# 0.9998686 - 1.03
# 0.4 - 42.1
```

# Filter species with bad Rhat
```{r, eval =F}
fits <- fits[!names(fits) %in% c('Hymenopus_heteromorphus','Duroia_longiflora',
                                                'Eschweilera_congestiflora','Couma_guianensis',
                                                'Chaetocarpus_schomburgkianus','Bocoa_prouacensis',
                                                'Eugenia_coffeifolia','Catostemma_fragrans','Pradosia_cochlearia',
                                                'Paypayrola_hulkiana')] # 11 sp
```

# Prepare data for plots
```{r}
d <- list()
# Plot data
for(S in names(fits)){
  for(D in c("1-3","3-10","10-25",">25")){
    if(D %in% names(fits[[S]])){
      
      d[[S]][[D]] <- mcmc_intervals_data(fits[[S]][[D]]$draws(c("a", "O", "tau")), 
                                         prob = 0.5, prob_outer = 0.80, point_est = "median") %>% 
        mutate(Species = S) %>% 
        mutate(DBH = D)
      
    }}}
datap <- list_rbind(list_flatten(d))

# Light effect (not flat)
O_sg <- datap %>% 
  # filter(parameter=="O"& incertitude > 4) %>%
  filter(parameter=="a"& m > -0.02) %>% # no light effect
  select(Species, DBH) %>% 
  mutate(parameter="O") %>% 
  mutate(Sg_effect = F)

datap <- datap %>% 
  left_join(O_sg, by=c("Species", "DBH", "parameter")) %>% 
  # tau significantly different of 0
  mutate(Sg_effect = ifelse(parameter=="tau" & ll<0 & 0<hh, F, Sg_effect))  %>% 
  mutate(Sg_effect = ifelse(is.na(Sg_effect), T, Sg_effect))  %>% 
  mutate(DBH = factor(DBH, levels=c("1-3","3-10","10-25",">25"))) %>% 
  left_join(Inv, by = c("Species" = "ScientificName")) %>% 
  mutate(Guild = case_when(
    MaxTreeHeight <25 ~ "Understorey",
    MaxTreeHeight >40  ~ "Upper-canopy",
    .default = "Mid-canopy")
  ) %>% 
  mutate(Guild = factor(Guild, levels=c("Upper-canopy", "Mid-canopy", "Understorey"))) %>% 
  arrange(Species) %>% arrange(Guild) %>% 
  mutate(Species=factor(Species, levels=unique(Species))) %>% 
  mutate(Topo= case_when(
    parameter=="tau" & m > 0 ~ "Wetter habitat preference",
    parameter=="tau" & m < 0 ~ "Drier habitat preference")) %>% 
  mutate(Topo = ifelse(parameter=="tau" & ll<0 & 0<hh, "No significant effect", Topo)) %>% 
  mutate(incertitude = hh-ll) %>% 
  mutate(Species = str_replace(Species, "_", " "))


# -a
# datap <- datap %>%
#   mutate_at(vars(c("ll", "l", "m", "h","hh")), ~ ifelse(parameter=="a", (-.), .))

ord_sp <- unique(datap$Species)

species_to_number <- setNames(seq_along(ord_sp), ord_sp)

numeric_vector <- species_to_number[datap$Species]

datap$sp_code <- numeric_vector

# ll : outer start
# l : iner start
# m : point_est value
# h : iner end
# hh : outer end

write_csv(datap, paste(PATH, "/dataplot.csv",sep=''))
```

```{r, eval=F}
# no light effect (flat) :
no_light_effect <- c("Symphonia_sp.1", "Tachigali_melinonii", Lecythis_persistens, Licania_alba, Eschweilera_coriacea, Eschweilera_sagotiana, Pogonophora_schomburgkiana, Ruizterania_albiflora, Pouteria_gonggrijpii,
                     Mouriri_crassifolia, Tachigali_melinonii, Homalolepis_cedron, Hirtella_bicornis, Dicorynia_guianensis)

# a_Q95 > -0.07
# (a = 0 -> large niche)

noeffect <- datap %>%
  filter(parameter %in% c('a', "O")) %>% 
  filter(
    (DBH == '1-3' & Species %in% c("Symphonia_sp.1", "Lecythis_persistens", "Eschweilera_sagotiana", "Homalolepis_cedron", "Mouriri_crassifolia", "Hirtella_bicornis", "Dicorynia_guianensis")) |
      (DBH == '10-25' & Species %in% c("Licania_alba", "Eschweilera_coriacea", "Ruizterania_albiflora", "Mouriri_crassifolia", "Hirtella_bicornis", "Dicorynia_guianensis")) |
      (DBH == '3-10' & Species %in% c("Pogonophora_schomburgkiana", "Pouteria_gonggrijpii", "Tachigali_melinonii", "Mouriri_crassifolia", "Hirtella_bicornis", "Dicorynia_guianensis"))
  )

min(noeffect$m) # max a median : -0.019

```


# Posteriors
ajouter le alpha sur O
fixer y pour toutes les pages
```{r}
# mcmc_intervals() code 
# trace(bayesplot::mcmc_intervals, edit=T)

for(P in c('O', 'a', 'tau')){
  i = 10 # nbr of sp per page
  plist <- vector('list', round(length(names(fits))/i))
  
  for(p in 1:round(length(names(fits))/i)){
    # p1 to 8 for 10 sp each
    # message(s)
    plist[[p]] <- local({
      # p <- 7
      if (p==1) {start = 1
      }else{start = i*(p-1) + 1}
      stop = start + (i-1)
      
      # print(p) ;  print(P)
      
      datas <- datap %>% 
        filter(parameter==P) %>%
        filter(sp_code >= start & sp_code <= stop)
      
      ggplot(datas, aes(x= DBH, y = m, group=1)) +
        theme_minimal() + 
        geom_segment(aes(y=ll, yend=hh, x=DBH, xend=DBH,
                         color = "80%"), size = 0.5) +
        geom_segment(aes(y=l, yend=h, x=DBH, xend=DBH,
                         color = "50%"), size = 1) +
        scale_color_manual(name = "Credible interval", 
                           values = c("80%" = "#E7B800",
                                      "50%"= "#FC4E07")) + 
        {if(P=='a') geom_point() } + # median
        {if(P!='a') geom_point(aes(alpha = Sg_effect)) } +
        geom_line() +
        {if(P=='tau') geom_hline(yintercept=0, linetype = "dashed", col = "red") } +
        scale_x_discrete(position = "top") +
        
        scale_y_continuous(position = "right") +
        # {if(P=='O') scale_y_continuous(position = "right") } +
        # {if(P=='tau') scale_y_continuous(position = "right", limits = c(-20, NA))  } +
        # {if(P=='a')  scale_y_continuous(position = "right", limits = c(-3, NA)) } +
        
        # , limits = c(min(datas$ll), max(datas$hh))
        labs(x= 'DBH (cm)', y= P) +
        {if(P=='tau') ylab(expression(tau)) } +
        facet_grid(Species ~ ., switch = "y") +
        theme(strip.text.y.left = element_text(angle = 0))
    })
  }
  
  plots <- gridExtra::marrangeGrob(plist, nrow = 1, ncol = 1)
  # plots
  
  
  ggsave(paste(P,"_posteriors_stages.pdf", sep=''), path = PATH, # _sg
         plot = plots, width = 25, height = 26, units = "cm", dpi=800, bg="white")
}
```

# Parameters accross onto
```{r}
# for(S in c('Understory species', 'Canopy species')){
# S='Canopy species'
for(P in c('a', 'O', 'tau')){
  # P='a'
  
  print(
    datap %>% 
      filter(parameter==P) %>% 
      # filter(Strategy==S) %>% 
      mutate_at(vars(c("ll", "l", "m", "h","hh")), ~ ifelse(parameter=="a", (-.), .)) %>% 
      ggplot(aes(x= DBH, y = m, col = Species, group = Species, alpha= Sg_effect)) + # 
      theme_minimal() + 
      {if(P!='tau') list(geom_point(), geom_line() ) } + # ,guides(col = guide_legend(ncol = 2))
      {if(P=='tau') list(geom_point(aes(col=Topo)), geom_line(aes(col=Topo)) ) } + # , scale_y_continuous(limits = c(-20, NA))
      # geom_segment(aes(y=l, yend=h, x=DBH, xend=DBH), size = .5) + # 5O% CI
      
      {if(P=='O')  scale_y_continuous(limits = c(NA,0), n.breaks = 10, labels = ~round(exp(.)*100,2)) } +
      scale_alpha_manual(values = c("FALSE" = .5, "TRUE"= 1)) +
      # guides(color = F) +
      {if(P=='a')  list(guides(alpha = F),  
                        scale_y_continuous(name = 'log(-a)', trans="log", n.breaks = 8, labels = ~round(.,2))
      ) } + 
      
      {if(P=='tau') geom_hline(yintercept=0, linetype = "dashed", col = "red") } +
      {if(P!='O')  guides(alpha = F) } +
      labs(y=P)  +
      {if(P=='tau') ylab(expression(tau)) }
    # title=S,
  )
  ggsave(paste(P,"accross_onto.png", sep='_'), path = PATH,
         width = 15, height = 11, units = "cm", dpi=800, bg="white")
}
# }
```

```{r}
datap %>% 
  select(Species, DBH, Topo) %>% 
  na.omit() %>% 
  # summarise(N = n()) %>% 
  ggplot(aes(x= DBH, fill= Topo)) +
  theme_minimal() + 
  geom_histogram(stat="count") +
  labs(y = 'Species number', fill = "Topographic sensitivity")
```

# Boxplot parameters accross onto
```{r}
for(P in c('a', 'O', 'tau')){
  print(
    datap %>% 
      filter(parameter==P) %>% 
      mutate(m = ifelse(parameter=='a', -m, m)) %>%
      
      ggplot(aes(x= DBH, y = m)) +
      theme_minimal() + 
      geom_boxplot() +
      {if(P=='a') scale_y_continuous(trans="log",
                                     n.breaks = 8, labels = ~round(.,2)) } +
      
      theme(legend.position="bottom") +
      labs(y=P, x='DBH (cm)') + 
      {if(P=='tau') ylab(expression(tau)) } +
      {if(P=='a') ylab('-a') }
    
    # title=S, 
  )
  ggsave(paste(P,"_boxplot_accross_onto.png", sep='_'), path = PATH,
         width = 10, height = 10, units = "cm", dpi=800, bg="white")
}
# }
```

```{r}
# for(S in c('Understory species', 'Canopy species')){
for(P in c('a', 'O', 'tau')){
  print(
    datap %>% 
      filter(parameter==P) %>% 
      mutate(m = ifelse(parameter=='a', -m, m)) %>% 
      # filter(Strategy==S) %>% 
      ggplot(aes(x= DBH, y = m, col=Guild)) +
      theme_minimal() + 
      geom_boxplot() +
      {if(P=='a') scale_y_continuous(trans="log",
                                     n.breaks = 8, labels = ~round(.,2)) } +
      # scale_color_manual(values = c("Canopy species" = "#E7B800",
      #                               "Understory species"= "#009E73",
      #                               "NA" = "darkgrey")) +
      scale_color_manual(values = c("Upper-canopy" = "#E7B800",
                                    "Understorey"= "#009E73",
                                    "Mid-canopy" = "#D55E00"),
                         breaks=c("Upper-canopy", "Mid-canopy", "Understorey")) +
      
      theme(legend.position="bottom") +
      labs(y=P, x='DBH (cm)') + # title=S, 
      {if(P=='tau') ylab(expression(tau)) } +
      {if(P=='a') ylab('-a') }
    
    
  )
  ggsave(paste(P,"_boxplot_accross_onto_Guild.png", sep='_'), path = PATH,
         width = 11, height = 10, units = "cm", dpi=800, bg="white")
}
# }
```

# Predictions
il faut l'environnement de chaque classe onto...
1 plot par sp et une couleur par stade
```{r}
Envpred <- read_csv("D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/Realdata/Envrmt_prediction_25ha.csv") %>% 
  mutate(DBH_classes = recode(DBH_classes, "-25" = ">25"))
```


```{r predictions}
Sys.time()

datalist <- list()
Olist <- list()
alist <- list()
plist <- list()

for(s in names(fits)){
  plist[[s]] <- local({
    # s= "Lecythis_persistens"
    for(d in c("1-3","3-10","10-25",">25")){
      # d= ">25"
      if(d %in% names(fits[[s]])){
        
        datalist[[d]] <- fits[[s]][[d]]$summary("p") %>%  # p posterior
          # prediction environment 
          rowwise() %>% 
          mutate(DBH = d) %>% 
          mutate(Light = as.numeric(unlist(str_extract_all(variable, "\\d+"))[1])) %>% 
          # mutate(Topo = as.numeric(unlist(str_extract_all(variable, "\\d+"))[2])) %>% 
          mutate(logTransmittance = Envpred[Envpred$DBH_classes==d,]$Lightp[Light]) 
        # mutate(logTWI = Envpred[Envpred$DBH_classes==d,]$Topographyp[Topo])
        
        Olist[[d]] <- data.frame(
          DBH = d,
          O = fits[[s]][[d]]$summary("O", median)$median,
          fits[[s]][[d]]$summary("O",
                                 quantiles = ~ quantile2(., probs = c(0.2, 0.8)))
          # OQ5 = fits[[s]][[d]]$summary("O")$q5, # Opt Q5%
          # OQ95 =fits[[s]][[d]]$summary("O")$q95
        )
        alist[[d]] <- data.frame(
          DBH = d,
          a = fits[[s]][[d]]$summary("a", median)$median
        )
        
      }
    }
    DATA <- list_rbind(list_flatten(datalist)) %>% 
      mutate(DBH = factor(DBH, levels=c("1-3","3-10","10-25",">25")))
    
    aDATA <- list_rbind(list_flatten(alist)) %>% 
      mutate(DBH = factor(DBH, levels=c("1-3","3-10","10-25",">25")))
    
    ODATA <- list_rbind(list_flatten(Olist)) %>% 
      mutate(DBH = factor(DBH, levels=c("1-3","3-10","10-25",">25")))
    
    DATA <-  DATA %>% 
      left_join(aDATA, by="DBH") %>% 
      left_join(ODATA, by="DBH") %>% 
      mutate(Incertitude = q20-q80) %>% 
      mutate(Sg_effect = ifelse(a > -0.02 | Incertitude > 5, F, T)) # -0.02
    
    
    
    DATA %>% 
      ggplot(aes(col = DBH, fill=DBH)) +
      theme_minimal() +
      geom_line(aes(x = logTransmittance, y = median, linetype = Sg_effect), size=0.7) + # p posterior median
      scale_linetype_manual(values = c('TRUE' = "solid",
                                       'FALSE' = "dashed")) +
      
      geom_ribbon(aes(x = logTransmittance, ymin = q5, ymax = q95),
                  alpha = .1, col=NA, linewidth=0.5) + # P quantiles
      geom_vline(data = ODATA, aes(xintercept  = O, col= DBH), linewidth=0.8) + # Opt median
      
      geom_rect(data = ODATA, aes(xmin = q20, xmax = q80, # O quantiles
                                  ymin=0, ymax=Inf), fill=NA, linetype="dotted") +
      
      # geom_vline(data = ODATA, aes(xintercept  = OQ5, col= DBH),  linetype="dashed") + # Opt Q5%
      # geom_vline(data = ODATA, aes(xintercept  = OQ95, col= DBH),  linetype="dashed") + # Opt Q95%
      scale_color_manual(values = c("1-3" = "#00AFBB",
                                    "3-10"= "#CC79A7",
                                    "10-25"= "#E7B800",
                                    ">25" = "#FC4E07"),
                         breaks=c("1-3","3-10","10-25",">25")) + 
      
      scale_fill_manual(values = c("1-3" = "#00AFBB",
                                   "3-10"= "#CC79A7",
                                   "10-25"= "#E7B800",
                                   ">25" = "#FC4E07"),
                        breaks=c("1-3","3-10","10-25",">25")) + 
      
      scale_x_continuous(name = "Light (% transmittance)",
                         n.breaks = 10, labels = ~round(exp(.)*100,2)) + # delog
      ggtitle(paste(str_replace(s, "_", " "),"- at logTWI optimum")) +
      labs(y="Presence probabiblity median", col='DBH (cm)', fill='DBH (cm)')
    
  })
}


plots <- gridExtra::marrangeGrob(plist, nrow = 3, ncol = 3) # 75
# plots

ggsave("Allsp_Light_niche_atTWIoptimum_stages.pdf",
       path = PATH,
       plots, width = 15, height = 10)

Sys.time() # 4 min
```

# Biplot O vs a
```{r}
databp <- datap %>% 
  select(-c(outer_width, inner_width, point_est, Sg_effect, incertitude)) %>% 
  rename(Q5 = ll, Q80 = hh, median = m, Q50_0 = l, Q50_1 = h) %>% 
  filter(parameter %in% c("O", "a")) %>% 
  pivot_wider(names_from = parameter, values_from = c(Q5, Q50_0, median, Q50_1, Q80),
              names_glue = "{parameter}_{.value}") %>% 
  mutate(Sg_effect = ifelse(a_median > -0.02, F, T))  %>% # no light effect
  # mutate(a_median = -a_median) %>% 
  mutate(Incertitude =(exp(O_Q80)*100)-(exp(O_Q5)*100)) 
```

```{r}
databp %>% 
  # filter(Species %in% c("Ruizterania_albiflora", "Pouteria_gonggrijpii", "Trichilia_schomburgkii", "Virola_michelii", "Lecythis_corrugata", "Symphonia_sp.1", "Dicorynia_guianensis", "Anaxagorea_dolichocarpa", "Vouacapoua_americana")) %>% 
  mutate_at(vars(c(a_Q5, a_Q50_0, a_median, a_Q50_1, a_Q80)), ~ (-.)) %>% 
  ggplot(aes(col = DBH, group = Species, shape = Guild)) +
  theme_minimal() + 
  geom_vline(aes(xintercept=0.02), linetype='dashed') +
  # 80% credible interval
  # geom_segment(aes(x=a_Q5, xend=a_Q80, y=O_median, yend=O_median,
  #                  col = "80 and 50% CI"), size = .5) + # tau
  # geom_segment(aes(y=O_Q5, yend=O_Q80, x=a_median, xend=a_median,
  #                  col = "80 and 50% CI"), size = .5) + # O
  # geom_segment(aes(x=a_Q50_0, xend=a_Q50_1, y=O_median, yend=O_median,
  #                  col = "80 and 50% CI"), size = .6) + # tau
  # geom_segment(aes(y=O_Q50_0, yend=O_Q50_1, x=a_median, xend=a_median,
  #                  col = "80 and 50% CI"), size = .6) + # O
  
  # geom_line(aes(x= a_median, y = O_median), col = "grey") +
  geom_point(aes(x= a_median, y = O_median), size =3) + # median
  # scale_shape_manual(name="Light effect",
  #                    values=c("FALSE" = 1, "TRUE" = 19),
  #                    breaks = c("TRUE","FALSE")) +
  # scale_color_manual(name="", values = c("80 and 50% CI" = "darkgrey")) +
  scale_color_manual(values = c("1-3" = "#00AFBB",
                                "3-10"= "#CC79A7",
                                "10-25"= "#E7B800",
                                ">25" = "#FC4E07"),
                     breaks=c("1-3","3-10","10-25",">25")) + 
  
  
  # ggrepel::geom_text_repel(aes(x= a_median, y = O_median, label = Species_code),
  #                          col = "black", size = 2.5) +
  
  scale_y_continuous(n.breaks = 10, labels = ~round(exp(.)*100,2)) + # delog
  scale_x_continuous(limits = range(databp$a_median), trans="log",
                     n.breaks = 8, labels = ~round(.,2)) +
  
  theme(plot.margin = unit(c(1,1,1,1), "lines")) +
  coord_cartesian(clip = "off") + 
  annotation_custom(textGrob("Flat light niche", gp = gpar(fontsize=10)),
                    xmin= -4.8,xmax=-4.8,ymin=-7.2,ymax=-7.2) +
  annotation_custom(textGrob("Wide light\nniche", gp = gpar(fontsize=10)),
                    xmin= -3.5,xmax=-3.5,ymin=-7.2,ymax=-7.2) +
  annotation_custom(textGrob("Narrow light\nniche", gp = gpar(fontsize=10)),
                    xmin= 0.7,xmax=0.7,ymin=-7.2,ymax=-7.2) +
  
  theme(axis.title = ggtext::element_markdown(),
        legend.title = ggtext::element_markdown(),
        legend.position="bottom") +
  labs(x= "Niche width (log(-*a*))",
       y= "Light optimum (*O*) (% transmittance)")

# alpha sur les postériors imprécis

ggsave("O_a_biplot_onto.png", path = PATH, 
       width = 22, height = 15, units = "cm", dpi=800, bg="white")
```
niches plus étroites pour les >25 dbh donc à droite du plot quand log(-a)

## Per species
```{r}
Sys.time()
plist <- list()

for(s in names(fits)){
  plist[[s]] <- local({
    # s= "Qualea_rosea"
    
    
    databp %>% 
      filter(Species == str_replace(s, "_", " ")) %>%
      mutate_at(vars(c(a_Q5, a_Q50_0, a_median, a_Q50_1, a_Q80)), ~ (-.)) %>% 
      ggplot(aes(x= a_median, y = O_median, col = Incertitude, group = Species, shape = DBH)) +
      theme_minimal() + 
      geom_vline(aes(xintercept=0.02), linetype='dashed') +
      
      # 80% credible interval
      # geom_segment(aes(x=a_Q5, xend=a_Q80, y=O_median, yend=O_median), size = .5, col= "grey") + # tau
      geom_segment(aes(y=O_Q5, yend=O_Q80, x=a_median, xend=a_median), size = .5, col = "#E7B800") + # O
      geom_segment(aes(x=a_Q50_0, xend=a_Q50_1, y=O_median, yend=O_median), size = .6, col= "grey") + # tau
      geom_segment(aes(y=O_Q50_0, yend=O_Q50_1, x=a_median, xend=a_median), size = .6, col = "#FC4E07") + # O
      # scale_color_manual(name="", values = c("80 and 50% CI" = "darkgrey")) +
      
      # geom_line(col = "grey") +
      geom_path(arrow = arrow(angle = 17, length = unit(0.15, "inches"), type = "closed"), col = "black") +
      geom_point(size = 3) + # median
      # scale_color_viridis(limits = range(databp$Incertitude)) + # option = "mako"
      scale_color_gradient(limits = range(databp$Incertitude), low = "#F0E442", high = "red") +
      scale_shape_manual(values = c("1-3" = 16,
                                    "3-10"= 17,
                                    "10-25"= 18,
                                    ">25" = 15),
                         breaks=c("1-3","3-10","10-25",">25")) +
      
      # ggrepel::geom_text_repel(aes(x= a_median, y = O_median, label = Species_code), col = "black", size = 2.5) +
      scale_y_continuous(limits = c(-7, 0), n.breaks = 10, labels = ~round(exp(.)*100,2)) + # delog
      scale_x_continuous(limits = range(-(databp$a_median)), trans="log",
                         n.breaks = 8, labels = ~round(.,2)) +
      theme(axis.title = ggtext::element_markdown(),
            legend.title = ggtext::element_markdown()) +
      labs(x= "Niche width (-*a*)",
           y= "Light optimum (*O*) (% transmittance)",
           col="*O* 80% CI", shape='DBH (cm)') +
      ggtitle(str_replace(s, "_", " "))
  })
}


plots <- gridExtra::marrangeGrob(plist, nrow = 3, ncol = 3) # 75
# plots

ggsave("O_a_biplot_onto_perspecies.pdf",
       path = PATH,
       plots, width = 15, height = 10)

Sys.time() # 4 min



# ggsave("O_a_biplot_onto_perspecies.png", path = PATH, 
#        width = 32, height = 20, units = "cm", dpi=800, bg="white")

```

# Incertitude O vs a
```{r}
ggplot(databp, aes(x=Incertitude, y= a_median)) +
  theme_minimal() + 
  # geom_point() +
  geom_line() +
  # scale_x_continuous(trans="log", labels = ~round(.,1)) +
  geom_hline(yintercept = -0.02, linetype = 'dashed') +
  ggpubr::stat_cor(method = "pearson",
                   label.x.npc = 0.7, label.y.npc = 0.05) +
  labs(x='*O* 80% incertitude (transmittance %)', y= '*a* median') +
  theme(axis.title = ggtext::element_markdown(),
        legend.title = ggtext::element_markdown())

ggsave("O_incertitude_a_.png", path = PATH,
       width = 15, height = 10, units = "cm", dpi=800, bg="white")

cor(databp$Incertitude, databp$a_median)
cor(log(databp$Incertitude), databp$a_median)
# not log : -0.55
# log : -0.69
```

# ACP O, a, incertitude O, incertitude a
## For DBH class strategy
```{r}
data <- databp %>% 
  select(O_median, a_median, Incertitude) # Species, DBH, 

acp <- ade4::dudi.pca(data, scale=T, center=T, nf = 4, scannf = FALSE) # Principal Components Analysis
summary(acp)
pc <- round(acp$eig/sum(acp$eig)*100,2) # arrondi a 2 chiffres apres la virgule 
pc # ne retenir que les plus explicatifs (generalement > 10% de variation)
# % cumules
cumsum(pc)


res <- prcomp(data, center = TRUE, scale = TRUE) # Principal Components Analysis
summary(res)
get_eig(res) # Valeurs propres et variances
fviz_screeplot(res, addlabels = TRUE)

# Biplot variables - individus
fviz_pca_biplot(res, col.ind = databp$DBH, fill.ind = databp$DBH, label = "var",
                col.var = "black", repel = TRUE, addEllipses = T, legend.title = "DBH (cm)") +
  scale_color_manual(values = c("1-3" = "#00AFBB",
                                "3-10"= "#CC79A7",
                                "10-25"= "#E7B800",
                                ">25" = "#FC4E07"),
                     breaks=c("1-3","3-10","10-25",">25")) +
  scale_fill_manual(values = c("1-3" = "#00AFBB",
                               "3-10"= "#CC79A7",
                               "10-25"= "#E7B800",
                               ">25" = "#FC4E07"),
                    breaks=c("1-3","3-10","10-25",">25")) +
  scale_shape_manual(values=c(19,19,19,19))
```
## For species strategy
```{r}
datasp <- databp %>% 
  filter(Species %in% c("Oxandra_asbeckii", "Anaxagorea_dolichocarpa", "Iryanthera_hostmannii")) %>% 
  select(Species, O_median, a_median, Incertitude)# Species, DBH, 

data <- datasp %>% 
  select(-Species)


res <- prcomp(data, center = TRUE, scale = TRUE) # Principal Components Analysis


# Biplot variables - individus
fviz_pca_biplot(res, col.ind = as.character(datasp$Species), label = "var",
                col.var = "black", repel = TRUE, addEllipses = T, legend.title = "Species")


```

```{r}
datasp <- databp %>% 
  select(Species, DBH, O_median, a_median, Incertitude) %>% 
  pivot_wider(names_from = DBH,
              values_from = c(O_median, a_median, Incertitude)) %>% 
  na.omit()

data <- datasp %>% 
  select(-Species)

acp <- ade4::dudi.pca(data, scale=T, center=T, nf = 4, scannf = FALSE) # Principal Components Analysis
summary(acp)
pc <- round(acp$eig/sum(acp$eig)*100,2) # arrondi a 2 chiffres apres la virgule 
pc # ne retenir que les plus explicatifs (generalement > 10% de variation)
# % cumules
cumsum(pc)


res <- prcomp(data, center = TRUE, scale = TRUE) # Principal Components Analysis
summary(res)
get_eig(res) # Valeurs propres et variances
fviz_screeplot(res, addlabels = TRUE)

# Biplot variables - individus
fviz_pca_biplot(res, col.ind = datasp$Species, fill.ind = datasp$Species, label = "var",
                col.var = "black", repel = TRUE, addEllipses = T, legend.title = "Species") +
  theme(legend.position = "none")

```

