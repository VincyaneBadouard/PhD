---
title: "Diagnose all DBH classes"
date: "`r Sys.Date()`"
format: html
self-contained: true
theme: cosmo
editor: source
code-fold: true
---
```{r setup}
library(tidyverse)
library(cmdstanr)
library(bayesplot)

sp <- (read.csv("D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/InterestSpecies.csv")[,3])

Comb <- read.csv("D:/Mes Donnees/PhD/R_codes/PhD_cluster/Data/Combin_Sp_DBHclas.csv")

unique(Comb$DBH_classes)
# 75
# metrre le 2 avec la correc bota

# sp <- c("Anaxagorea_dolichocarpa", "Tabernaemontana_macrocalyx", "Eperua_falcata", "Dicorynia_guianensis", "Paypayrola_hulkiana", "Symphonia_sp.1", "Pogonophora_schomburgkiana")

# sp <- "Iryanthera_hostmannii"

strategy <- read_delim("~/PhD/Inventories/Data/Understory/Paracou/Species_strategy.csv") %>% 
  select(ScientificName, Strategy_VB) %>%
  rename(Strategy = Strategy_VB) %>% 
  unique()

```

# Fits
```{r fit}
fits <- list()
for(S in sp){
  for(D in c("1-5","5-10","10-20","-20")){
    tryCatch({
      chain_path <- file.path("Chains", "Hybrid_no_iota", S, D)
      if(D=="-20") D <- ">20"
      fits[[S]][[D]] <- as_cmdstan_fit(list.files(chain_path,
                                                  full.names = TRUE))},
      error=function(e){cat("ERROR :",S, D, conditionMessage(e), "\n")}
    )
  }
}
# names(fits[["Symphonia_sp.1"]])

names(fits)[names(fits) == "-20"] <- ">20"
```

# Divergence
```{r divergence}
d <- list()
for(S in names(fits)){
  for(D in c("1-5","5-10","10-20",">20")){
    if(D %in% names(fits[[S]])){
      
      d[[S]][[D]] <- data.frame(Species = S,
                                DBH = D,
                                Chain = c(1:4),
                                Divergences = fits[[S]][[D]]$diagnostic_summary("divergences") # divergences per chain
      )
    }}}
Div <- list_rbind(list_flatten(d)) %>% 
  bind_rows() %>% 
  rename(Divergences = num_divergent) %>% 
  group_by(Species) %>% 
  mutate(`%divergence` = sum(Divergences)/4000*100)

```

# Rhat
R-hat convergence diagnostic, which compares the between- and within-chain estimates for model parameters and other univariate quantities of interest. If chains have not mixed well (ie, the between- and within-chain estimates don't agree), R-hat is larger than 1.01 (Vehtari et al., 2021). 
R-hat which is the maximum of rank normalized split-R-hat and rank normalized folded-split-R-hat, which works for thick tailed distributions and is sensitive also to differences in scale.
```{r Rhat}
d <- list()
for(S in names(fits)){
  for(D in c("1-5","5-10","10-20",">20")){
    if(D %in% names(fits[[S]])){
      
      d[[S]][[D]] <- fits[[S]][[D]]$summary(c("alpha", "beta1", "beta2_p", "tau")) %>% 
        mutate(Species = S) %>% 
        mutate(DBH = D) %>% 
        select(Species, DBH, variable, rhat) 
    }}}
Rhat_table <- list_rbind(list_flatten(d))


# bayesplot::rhat(fits[[1]],pars="beta2_p")
# posterior::rhat(extract_variable_matrix(fits[[1]], "beta2_p"))

all(Rhat_table$rhat < 1.01)

badRhat <- Rhat_table %>% filter(rhat > 1.01) %>%
  left_join(Div %>% select(Species, `%divergence`) %>% unique(), by="Species")

length(unique(badRhat$Species)) # (44/75)*100 = 59%
```

# Chains
```{r}
name <- 
  # names(fits)[names(fits) %in% c("Anaxagorea_dolichocarpa", "Dicorynia_guianensis", "Iryanthera_hostmannii", "Protium_opacum", "Talisia_guianensis", "Talisia_sylvatica", "Eugenia_coffeifolia", "Ryania_speciosa", "Inga_loubryana", "Eschweilera_sagotiana", "Hirtella_bicornis", "Tabernaemontana_macrocalyx", "Talisia_mollis", "Eugenia_brownsbergii", "Duroia_longiflora", "Mouriri_sagotiana", "Ixora_ferrea")]
  unique(badRhat$Species)
# sort(names(fits))

for(S in name){
  for(D in c("1-5","5-10","10-20",">20")){
    # if(D %in% names(fits[[S]])){
    if(any(D %in% badRhat[badRhat$Species==S,]$DBH)){
      S = "Talisia_sylvatica"
      D = "5-10"
      print(
        fits[[S]][[D]]$draws(
          c("lp__", "alpha", "beta1", "beta2_p", "O", "tau")
          # c("lp__", "a", "O", "gamma", "tau")
        ) %>% 
          mcmc_trace() +
          # mcmc_dens() +
          ggtitle(paste(S, D))
      )
    }
  }}
```

# Prepare data for plots
```{r}
d <- list()
# Plot data
for(S in names(fits)){
  for(D in c("1-5","5-10","10-20",">20")){
    if(D %in% names(fits[[S]])){
      
      d[[S]][[D]] <- mcmc_intervals_data(fits[[S]][[D]]$draws(c("a", "O", "tau")),
                                         prob = 0.5, prob_outer = 0.95, point_est = "median") %>% 
        mutate(Species = S) %>% 
        mutate(DBH = D)
      
    }}}
datap <- list_rbind(list_flatten(d))

# Light effect (not flat)
O_sg <- datap %>% 
  filter(parameter=="a"& hh > -0.07) %>% select(Species, DBH) %>% 
  mutate(parameter="O") %>% 
  mutate(Sg_effect = F)

datap <- datap %>% 
  left_join(O_sg, by=c("Species", "DBH", "parameter")) %>% 
  # tau significantly different of 0
  mutate(Sg_effect = ifelse(parameter=="tau" & ll<0 & 0<hh, F, Sg_effect))  %>% 
  mutate(Sg_effect = ifelse(is.na(Sg_effect), T, Sg_effect))  %>% 
  mutate(DBH = factor(DBH, levels=c("1-5","5-10","10-20",">20"))) %>% 
  left_join(strategy, by = c("Species" = "ScientificName")) %>% 
  mutate(Strategy = factor(Strategy, levels=c("Canopy species","Understory species"))) %>% 
  arrange(Species) %>% arrange(Strategy) %>% 
  mutate(Species=factor(Species, levels=unique(Species))) 

ord_sp <- unique(datap$Species)

species_to_number <- setNames(seq_along(ord_sp), ord_sp)

numeric_vector <- species_to_number[datap$Species]

datap$sp_code <- numeric_vector

# ll : outer start
# l : iner start
# m : point_est value
# h : iner end
# hh : outer end

```

# Posteriors
ajouter le alpha sur O
fixer y pour toutes les pages
```{r}
# mcmc_intervals() code 
# trace(bayesplot::mcmc_intervals, edit=T)

for(P in c('O', 'a', 'tau')){
  i = 15 # nbr of sp per page
  plist <- vector('list', round(length(names(fits))/i))
  
  for(p in 1:round(length(names(fits))/i)){
    # p1 to 5 for 15 sp each
    # message(s)
    plist[[p]] <- local({
      # p <- 3
      if (p==1) {start = 1
      }else{start = i*(p-1) + (p-1)}
      stop = start + (i-1)
      
      datap %>% 
        filter(parameter==P) %>%
        filter(sp_code >= start & sp_code <= stop) %>% 
        
        ggplot(aes(x= DBH, y = m, group=1)) +
        theme_minimal() + 
        xlim(range(c(datap$ll, datap$hh))) +
        layer_vertical_line +
        geom_segment(aes(y=ll, yend=hh, x=DBH, xend=DBH,
                         color = "95%"), size = 0.5) +
        geom_segment(aes(y=l, yend=h, x=DBH, xend=DBH,
                         color = "50%"), size = 1) +
        scale_color_manual(name = "Credible interval", 
                           values = c("95%" = "#E7B800",
                                      "50%"= "#FC4E07")) + 
        geom_point(aes(alpha = Sg_effect)) + # median
        geom_line() +
        scale_x_discrete(position = "top") +
        scale_y_continuous(position = "right") +
        labs(x= 'DBH (cm)', y= P) +
        facet_grid(Species ~ ., switch = "y") +
        theme(strip.text.y.left = element_text(angle = 0))
    })
  }
  
  plots <- gridExtra::marrangeGrob(plist, nrow = 1, ncol = 1)
  # plots
  
  
  ggsave(paste(P,"_posteriors_stages_sg.pdf", sep=''), path = "//amap-data.cirad.fr/work/users/VincyaneBadouard/Modelisation/Plots",
         plot = plots, width = 25, height = 26, units = "cm", dpi=800, bg="white")
}
```
# Parameters accross onto
```{r}
for(S in c('Understory species', 'Canopy species')){
  for(P in c('a', 'O', 'tau')){
    
    datap %>% 
      filter(parameter==P) %>% 
      filter(Strategy==S) %>% 
      ggplot(aes(x= DBH, y = m, col = Species, group = Species, alpha= Sg_effect)) +
      theme_minimal() + 
      geom_point() +
      geom_line() +
      {if(P=='O')  scale_y_continuous(limits = c(NA,0), n.breaks = 10, labels = ~round(exp(.)*100,2)) } +
      scale_alpha_manual(values = c("FALSE" = .2, "TRUE"= 1)) +
      # guides(color = F) +
      guides(col = guide_legend(ncol = 2)) +
      {if(P=='a')  guides(alpha = F) } +
      labs(title=S, y=P)
    
    ggsave(paste(S,P,"accross_onto_sg.png", sep='_'), path = "//amap-data.cirad.fr/work/users/VincyaneBadouard/Modelisation/Plots",
           width = 25, height = 26, units = "cm", dpi=800, bg="white")
  }
}
```

# a boxplot accross onto
```{r}
for(S in c('Understory species', 'Canopy species')){
  for(P in c('a', 'O', 'tau')){
    print(
      datap %>% 
        filter(parameter==P) %>% 
        filter(Strategy==S) %>% 
        ggplot(aes(x= DBH, y = m)) +
        theme_minimal() + 
        geom_boxplot() +
        labs(title=S, y=P)
    )
    # ggsave(paste(S,"a_boxplot_accross_onto_sg.png", sep='_'), path = "//amap-data.cirad.fr/work/users/VincyaneBadouard/Modelisation/Plots",
    #        width = 25, height = 26, units = "cm", dpi=800, bg="white")
  }
}
```

# Predictions
il faut l'environnement de chaque classe onto...
1 plot par sp et une couleur par stade
```{r}
Envpred <- read_csv("D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/Realdata/Envrmt_prediction.csv") %>% 
  mutate(DBH_classes = recode(DBH_classes, "-20" = ">20"))
```

```{r predictions}
Sys.time()

datalist <- list()
Olist <- list()
plist <- list()

for(s in names(fits)){
  plist[[s]] <- local({
    # s= "Lecythis_persistens"
    for(d in c("1-5","5-10","10-20",">20")){
      # d= "1-5"
      if(d %in% names(fits[[s]])){
        
        datalist[[d]] <- fits[[s]][[d]]$summary("p") %>%  # p posterior
          # prediction environment 
          rowwise() %>% 
          mutate(DBH = d) %>% 
          mutate(Light = as.numeric(unlist(str_extract_all(variable, "\\d+"))[1])) %>% 
          # mutate(Topo = as.numeric(unlist(str_extract_all(variable, "\\d+"))[2])) %>% 
          mutate(logTransmittance = Envpred[Envpred$DBH_classes==d,]$Lightp[Light]) 
        # mutate(logTWI = Envpred[Envpred$DBH_classes==d,]$Topographyp[Topo])
        
        Olist[[d]] <- data.frame(
          DBH = d,
          O = fits[[s]][[d]]$summary("O", median)$median,
          OQ5 = fits[[s]][[d]]$summary("O")$q5, # Opt Q5%
          OQ95 =fits[[s]][[d]]$summary("O")$q95
        )
        
      }
    }
    DATA <- list_rbind(list_flatten(datalist)) %>% 
      mutate(DBH = factor(DBH, levels=c("1-5","5-10","10-20",">20")))
    ODATA <- list_rbind(list_flatten(Olist)) %>% 
      mutate(DBH = factor(DBH, levels=c("1-5","5-10","10-20",">20")))
    
    DATA %>% 
      ggplot(aes(col = DBH, fill=DBH)) +
      theme_minimal() +
      geom_line(aes(x = logTransmittance, y = median), size=0.7) + # p posterior median
      geom_ribbon(aes(x = logTransmittance, ymin = q5, ymax = q95),
                  alpha = .1, col=NA, linewidth=0.5) + # P quantiles
      geom_vline(data = ODATA, aes(xintercept  = O, col= DBH), linewidth=0.8) + # Opt median
      
      geom_rect(data = ODATA, aes(xmin = OQ5, xmax = OQ95, # O quantiles
                                  ymin=0, ymax=Inf), fill=NA, linetype="dotted") +
      
      # geom_vline(data = ODATA, aes(xintercept  = OQ5, col= DBH),  linetype="dashed") + # Opt Q5%
      # geom_vline(data = ODATA, aes(xintercept  = OQ95, col= DBH),  linetype="dashed") + # Opt Q95%
      scale_color_manual(values = c("1-5" = "#00AFBB",
                                   "5-10"= "#CC79A7",
                                   "10-20"= "#E7B800",
                                   ">20" = "#FC4E07"),
                        breaks=c("1-5","5-10","10-20",">20")) + 
      
      scale_fill_manual(values = c("1-5" = "#00AFBB",
                                   "5-10"= "#CC79A7",
                                   "10-20"= "#E7B800",
                                   ">20" = "#FC4E07"),
                        breaks=c("1-5","5-10","10-20",">20")) + 
      
      scale_x_continuous(name = "Light (% transmittance)",
                         n.breaks = 10, labels = ~round(exp(.)*100,2)) + # delog
      ggtitle(paste(s,"- at logTWI optimum")) +
      labs(y="Presence probabiblity median", col='DBH (cm)', fill='DBH (cm)')
    
  })
}


plots <- gridExtra::marrangeGrob(plist, nrow = 3, ncol = 3) # 75
# plots

ggsave("Allsp_Light_niche_atTWIoptimum_stages.pdf",
       path = "//amap-data.cirad.fr/work/users/VincyaneBadouard/Modelisation/Plots",
       plots, width = 15, height = 10)

Sys.time() # 4 min
```

