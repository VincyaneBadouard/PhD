---
title: "Predictions plot per species at 4 stages with gamma = 0"
date: "`r Sys.Date()`"
format: html
self-contained: true
theme: cosmo
editor: source
code-fold: true
---

```{r setup}
library(tidyverse)
library(cmdstanr)
library(bayesplot)
library(viridis)
library(posterior)
library(factoextra)
library(grid)

PATH <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Modelisation/Plots/Light_topo_onto/Autocor"
fits <- readRDS(paste(PATH, "/fits.rds", sep=''))

Envpred <- read_csv("D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/Realdata/Envrmt_prediction_25ha.csv") %>% 
  mutate(DBH_classes = recode(DBH_classes, "-25" = ">25")) %>% 
  rename(DBH = DBH_classes)
```

# Prepare data and plot
- applique l’équation avec a et O médian et mettre gamma à 0
- pas de la barre de O, sans incertitude
- citer en discussion pour se référer aux espèces et dans résultats
```{r}
Sys.time()

d <- list()
p <- list()
plist <- list()

# S= "Oxandra_asbeckii" 
# D="1-3"


for(S in names(fits)){
  plist[[S]] <- local({
  for(D in c("1-3","3-10","10-25",">25")){
    if(D %in% names(fits[[S]])){
      
      d[[S]][[D]] <- fits[[S]][[D]]$summary(c("O","a"), median) %>% # , "tau"
        pivot_wider(names_from = variable,
                    values_from = median) 
      
      p[[S]][[D]] <- Envpred %>% 
        select(-Topographyp) %>% 
        filter(DBH==D) %>% 
        mutate(P = rstanarm::invlogit(d[[S]][[D]]$a*(Lightp - d[[S]][[D]]$O)^2)) %>%  #  + tau*Topographyp
        mutate(Sg_effect = ifelse(d[[S]][[D]]$a > -0.02, F, T)) # -0.02
      
    }
  }
      DATA <- list_rbind(list_flatten(p)) %>% 
        mutate(Species = S) %>% 
      mutate(DBH = factor(DBH, levels=c("1-3","3-10","10-25",">25")))
      
      DATA %>% 
      ggplot(aes(col = DBH)) +
      theme_minimal() +
      geom_line(aes(x = Lightp, y = P, linetype = Sg_effect), size=0.7) + # p median
      scale_linetype_manual(values = c('TRUE' = "solid",
                                       'FALSE' = "dashed")) +
      
      scale_color_manual(values = c("1-3" = "#a4c2f4ff",
                                    "3-10"= "#3d85c6ff",
                                    "10-25"= "#0b5394ff",
                                    ">25" = "#073763ff"),
                         breaks=c("1-3","3-10","10-25",">25")) + 
      
      scale_fill_manual(values = c("1-3" = "#a4c2f4ff",
                                   "3-10"= "#3d85c6ff",
                                   "10-25"= "#0b5394ff",
                                   ">25" = "#073763ff"),
                        breaks=c("1-3","3-10","10-25",">25")) + 
      
      scale_x_continuous(name = "Light (% transmittance)",
                         n.breaks = 10, labels = ~round(exp(.)*100,2)) + # delog
      theme(legend.position="bottom") +
      ggtitle(str_replace(S, "_", " ")) +
      labs(y="Standardised presence probabiblity median", col='DBH (cm)', fill='DBH (cm)')
    
  })
}

legend <- cowplot::get_legend(plist[[3]])
plot(legend)

plist_nolegend <- lapply(plist, function(p) p + theme(legend.position = "none"))

pages <- gridExtra::marrangeGrob(plist_nolegend, nrow = 3, ncol = 3) # 70
# plots

# Common legend at the bottom
final_pages <- lapply(1:length(pages), function(i) {
  gridExtra::grid.arrange(pages[[i]], legend, ncol = 1, heights = c(10, 1))
})
all_pages <- gridExtra::marrangeGrob(grobs = final_pages, nrow = 1, ncol = 1, top=NULL)

ggsave("Allsp_Light_niche_atTWIoptimum_stages_gamma0_bluegradient.pdf", # Allsp_Light_niche_atTWIoptimum_stages_gamma0
       path = PATH,
       all_pages,
       width = 15, height = 10)

Sys.time() # 4 min

```
Topographyp : 1 valeur par espèce et pas stade : topo la plus représentée par l'sp à cette taille
comme gamma change juste la hauteur de la courbe
