---
title: "Canonical_forced_+bounds_all_niche_forms_realdata"
date: "`r Sys.Date()`"
format: html
self-contained: true
theme: cosmo
editor: source
code-fold: true
execute: 
  cache: true
---

**Objectives:**
Check if bounding the parmetres O, a and gamma forces a realistic optimum and avoids divergence for all forms of niches.    
Canonical form: *a* \* (Environment - *O*)\^2 + *gamma*  

*a* = *beta2*\
*O* = extremum : -*beta1*/(2\**beta2)\
gamma = alpha*-(*beta1^2^/*(4*\**beta2))

Tested bounds: 
- a [-300,-0.02]  
  -0.05 -> divergence en noeffect  
  0 for the no effect -> divergence en noeffect et negsigmoide  
- O [-7, 0.5]  
- gamma [-3, 200]  (-2 ça fait des divergences sur convex and positive sigmoide)
from the exploration carried out in O_bounds_explo.qmd  

**On which species:**
-    convex (Licania_membranacea)
-    sigmoid (Lecythis_persistens)
-    no effect (Piparea_multiflora)
-    concave (Iryanthera_hostmannii)

```{r, packages, include = F}
library(rstan)
rstan_options(auto_write = TRUE) # option pour ne pas recompiler à chaque fois - gain de temps
rstan_options(disable_march_warning = TRUE)
library(bayesplot)
library(rstanarm) # for Bayesian automatic regression modelling using stan
library(brms) # Bayesian generalized multivariate non-linear multilevel models using stan
library(foreach) # parallisation
library(parallel)
library(tidyverse)
```

# Prepare data

```{r}
path <- "D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/"

# load real presence-absences data on 4ha 
load(paste(path, "Realdata/Realsp_4ha.Rdata", sep=''))
# View(datalist[[1]])
```

```{r}
sp <- c("Licania_membranacea" , "Lecythis_persistens", "Piparea_multiflora", "Iryanthera_hostmannii") # 4

datalist <- datalist[names(datalist) %in% sp] # only species in sp
# View(datalist[["Licania_membranacea"]])
```

# Model
```{r, Model}
# quadratic - canonic form
# M_Quadra_can <- stan_model(model_name = "Quadra_can",
#                            paste(path, "Stanfiles/Bernoulli_EnvOnly_quadratic_canonic_forced.stan", sep=''))

M_Quadra_can <- stan_model(model_name = "Quadra_can_bounds",
                           paste(path, "Stanfiles/Bernoulli_EnvOnly_quadratic_canonic_forced_bounds.stan", sep=''))

M_Quadra_can
```

```{r, dataM}
Np <- 200 # number of predictions
Environmentp <- seq(-6, 0, length.out = Np) # environment of predictions

dataM <- lapply(datalist, function(x) list(N = nrow(x), #les noms des var doivent etre les memes que dans le fichier stan
                                       Presence = x$Presence,
                                       Environment = x$logTransmittance,
                                       # number of predictions
                                       Np = Np,
                                       # environment of predictions
                                       Environmentp = Environmentp)
)

names(dataM) <- names(datalist)
```

```{r, fit}
# fits <- lapply(list(dataM$Iryanthera_hostmannii), function(x) sampling(M_Quadra_can, data = x, chains = 4, cores = 4, iter = 2000))
# names(fits) <- "Iryanthera_hostmannii"

fits <- lapply(dataM, function(x) sampling(M_Quadra_can, data = x, chains = 4, cores = 4, iter = 2000))
names(fits) <- names(dataM)
```
->   

# Chains

```{r, chains}
lapply(names(fits), function(x) mcmc_trace(as.array(fits[[x]]), 
                                           pars = c("a", "O", "gamma"),
                                           np = nuts_params(fits[[x]])) + # np pour afficher la divergeance
         labs(title = x)
)
```

-> 

# Posteriors
```{r, eval=F}
lapply(names(fits), function(x) mcmc_intervals(as.array(fits[[x]]), prob=0.95, pars = c("a", "O", "gamma")) +
         labs(title = x)
)  
lapply(names(fits), function(x) mcmc_dens(as.array(fits[[x]]), prob=0.95, pars = c("a", "O", "gamma")) +
         labs(title = x)
)  
```


# Parameters link

```{r, Parameters link}
lapply(names(fits), function(x) mcmc_pairs(as.array(fits[[x]]), pars = c("a", "O", "gamma")))
```

# Predictions
```{r, Predictions}
dataplot <- lapply(as.list(names(fits)), function(type)
  data.frame(type = type, 
             Environmentp = Environmentp,
             mu = apply(as.matrix(fits[[type]], pars = "p"), 2, median),
             t(apply(as.matrix(fits[[type]], pars = "p"), 2, 
                     quantile, probs = c(0.05, 0.95))),
             Opt = apply(as.matrix(fits[[type]], pars = "O"), 2, median),
             Opt = t(apply(as.matrix(fits[[type]], pars = "O"), 2,
                           quantile, probs = c(0.05, 0.95)))
             
  )) %>% 
  bind_rows()

ggplot(dataplot, aes(x = Environmentp)) +
  # Probas
  geom_point(aes(y = mu), size=0.7) +
  geom_ribbon(aes(ymin = `X5.`, ymax = `X95.`), color = 'red', alpha = 0.2) +
  labs(title = "Simulations median", y = "Presence probability", col= "Presence-absence") +
  facet_wrap(~ type, scales = "fixed", nrow = 1)

ggplot(dataplot, aes(x = Environmentp)) +
  # Probas
  geom_point(aes(y = mu), size=0.7) +
  geom_ribbon(aes(ymin = `X5.`, ymax = `X95.`), color = 'red', alpha = 0.2) +
  
  # Optimum
  geom_vline(aes(xintercept = Opt), color = "#00AFBB", linewidth=1) + # exp to delog
  geom_vline(aes(xintercept = `Opt.5.`), linetype="dashed") +
  geom_vline(aes(xintercept = `Opt.95.`), linetype="dashed") +
  labs(title = "Simulations median", y = "Presence probability", col= "Presence-absence") +
  facet_wrap(~ type, scales = "free_x", nrow = 1)

# ggsave("Canonical_all_niche_forms.png", path = "D:/Mes Donnees/PhD/Figures/Modelisation", width = 35, height = 15, units = "cm", dpi=800, bg="white")
```

-> The distributions forms are well predicted, but it's not clear to diagnose no effect in the case convexbell and noeffect case  
-> The median extremum is interpretable and well positioned  
