---
title: "Diagnose all"
date: "`r Sys.Date()`"
format: html
self-contained: true
theme: cosmo
editor: source
code-fold: true
---

```{r setup}
library(tidyverse)
library(cmdstanr)
library(bayesplot)

sp <- (read.csv("D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/InterestSpecies.csv")[,3]) # 75

# sp <- c("Licania_membranacea" , "Lecythis_persistens", "Symphonia_sp.1", "Tachigali_melinonii",
#         "Iryanthera_hostmannii", "Tabernaemontana_macrocalyx", "Pouteria_singularis", "Ryania_speciosa") # 4 forms

# sp <- "Symphonia_sp.1"

model_name <- c("Affine", "Quadratic")
```

```{r fit}
fit <- list()
for(S in sp){
  for(M in model_name){
    chain_path <- file.path("Chains", M, S)
    fit[[S]][[M]] <- as_cmdstan_fit(list.files(chain_path, full.names = TRUE))
  }
}
# names(fit[["Symphonia_sp.1"]])
```

```{r BIC list}
BIC <- list()

for(S in sp){
  for(M in model_name){
    
    k <- length(fit[[S]][[M]]$metadata()$stan_variables[!fit[[S]][[M]]$metadata()$stan_variables %in% c("lp__", "p", "a","O","gamma","beta2_p")]) # parameters nbr
    N <- 47850 # observations nbr
    L <- max(fit[[S]][[M]]$draws("lp__"))# the maximized value of the likelihood function of the model (fit[[f]]$summary("lp__"))
    
    BIC[[S]][[M]] <- k*log(N) - 2*L
    
  }
}
```

```{r predictions, eval=F}
g <- lapply(names(fit[[1]]), function(f){
  # f = "Affine"
  
  fit[[1]][[f]]$summary("p") %>% # p posterior
    mutate(x = seq(1.358045, 2.400176, length.out = 50)) %>% # prediction environment
    ggplot(aes(x = x)) +
    geom_point(aes(y = median), size=0.7) + # p posterior median
    geom_ribbon(aes(ymin = q5, ymax = q95), color = 'red', alpha = 0.2) + # P quantiles
    # geom_vline(xintercept  = fit[[f]]$summary("O")$median, color = "#00AFBB", linewidth=1) + # Opt median
    # geom_vline(xintercept  = fit[[f]]$summary("O")$q5, linetype="dashed") + # Opt Q5%
    # geom_vline(xintercept  = fit[[f]]$summary("O")$q95, linetype="dashed") + # Opt Q95%
    # facet_wrap(~ var1 + var2) +
    ggtitle(f) + # gsub("_", " ", f)
    theme_minimal() +
    theme(axis.title = element_blank())
})

cowplot::plot_grid(plotlist = g)
```


```{r predictions}
Sys.time()

plist <- list()

for(s in sp){
  plist[[s]] <- local({
    
    g <- lapply(names(fit[[s]]), function(m){
      # m = "Affine" ; s= "Talisia_megaphylla"
      
      fit[[s]][[m]]$summary("p") %>% # p posterior
        mutate(x = seq(1.358045, 2.400176, length.out = 50)) %>% # prediction environment
        ggplot(aes(x = x)) +
        geom_point(aes(y = median), size=0.7) + # p posterior median
        geom_ribbon(aes(ymin = q5, ymax = q95), color = 'red', alpha = 0.2) + # P quantiles
        
        annotate("text", # BIC
                 label = paste("BIC =", round(BIC[[s]][[m]],2)),
                 x = Inf, hjust= 1, y=Inf, vjust = "top") +
        
        labs(title = s, x= "log(TWI)", y = "Presence probability") + #paste(s, "-", f)
        theme_minimal()
      # theme(axis.title = element_blank())
    })
    
    cowplot::plot_grid(plotlist = g, labels=c("Affine", "Quadratic"), vjust = 3, hjust=-0.8, label_size=12)
    
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 3, ncol = 3) # 75
# plots

ggsave("Allsp_logTWI_niche_affine_vs_quadratic.pdf",
       path = "//amap-data.cirad.fr/work/users/VincyaneBadouard/Modelisation/Plots",
       plots, width = 15, height = 10)

Sys.time() # 2min13
```


