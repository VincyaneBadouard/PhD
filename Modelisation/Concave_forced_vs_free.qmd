---
title: "Concave_forced_vs_free (developped form)"
format: html
self-contained: true
theme: cosmo
editor: source
code-fold: true
execute: 
  cache: true
---

**Objectives:**
We model a species light temperament with a quadratic equation in the developed form, and we want to compare a model forced to a concave form of the presence probabilites estimated, vs a free model, on a simulated sigmoid, convex or flat species niche.


```{r, packages, include = F}
library(rstan)
rstan_options(auto_write = TRUE) # option pour ne pas recompiler à chaque fois - gain de temps
options(mc.cores = parallel::detectCores()) #option pour ajouter des coeurs au calcul
rstan_options(disable_march_warning = TRUE)
library(bayesplot)
library(rstanarm) # for Bayesian automatic regression modelling using stan
library(brms) # Bayesian generalized multivariate non-linear multilevel models using stan
library(foreach) # parallisation
library(parallel)
library(tidyverse)
```

# Prepare data

```{r}
path <- "D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/"
```
sigmoid, convex or flat 
```{r}
dataParam <- data.frame(
  type = c("noeffect", "convexbell", "negsigmoid", "possigmoid"),
  alpha=0) %>% 
  mutate(beta1 = case_when(
    type == "noeffect" ~ 0,
    type == "convexbell" ~ -15,
    type == "negsigmoid" ~ -15,
    type == "possigmoid" ~ 15) 
  ) %>% 
  mutate(beta2 = case_when(
    type == "noeffect" ~ 0,
    type == "convexbell" ~ 15,
    type == "negsigmoid" ~ 0,
    type == "possigmoid" ~ 0) 
  )
dataParamL <- dataParam %>% pivot_longer(cols = c("alpha", "beta1", "beta2"),
                                         names_to = "Parameters",
                                         values_to = "Initial")

```

```{r, create concave data}
n <- 500 # abs + pres
X <- seq(0, 1, length.out = n) # env var
# Parameters
a <- 0 # intercept ; logit(0.5)= 0) autant de 0 que de 1

data <- list(
  # data.frame of simulated data
  noeffect = data.frame(b= 0,
                        c= 0, 
                        Environment = X) %>% 
    # Generate presence-absence data from probability
    mutate(Presence = rbinom(n, size = 1, # Bernoulli = 1 trial
                             # logistique transformation (inverse logit)
                             prob = 1 / (1 + exp(-(a + b * X + c * X^2))))),
  
  convexbell = data.frame(b=-15,
                          c= 15,
                          Environment = X) %>% 
    # Generate presence-absence data from probability
    mutate(Presence = rbinom(n, size = 1, # Bernoulli = 1 trial
                             # logistique transformation (inverse logit)
                             prob = 1 / (1 + exp(-(a + b * X + c * X^2))))), 
  
  negsigmoid = data.frame(b= -15,
                          c= 0,
                          Environment = X) %>% 
    # Generate presence-absence data from probability
    mutate(Presence = rbinom(n, size = 1, # Bernoulli = 1 trial
                             # logistique transformation (inverse logit)
                             prob = 1 / (1 + exp(-(a + b * X + c * X^2))))), 
  
  possigmoid = data.frame(b= 15,
                          c= 0,
                          Environment = X) %>% 
    # Generate presence-absence data from probability
    mutate(Presence = rbinom(n, size = 1, # Bernoulli = 1 trial
                             # logistique transformation (inverse logit)
                             prob = 1 / (1 + exp(-(a + b * X + c * X^2))))) 
)

# Visualisation of simulated data
for(x in names(data)){
  b <- unique(data[[x]]$b)
  c <- unique(data[[x]]$c)
  
  p <- ggplot(data[[x]], aes(x= Environment, y= Presence)) +
    geom_point() +
    theme_minimal() +
    stat_function(fun=function(x) 1 / (1 + exp(-(a + b * x + c * x^2))), col = "blue", linewidth = 1) +
    labs(title= x, y="Presence (1) / Absence (0)", x="Explicative variable (X)")
  
  print(p)
}

```

# Run models

-   quadratic - developed free form
-   quadratic - developed concave foreced form

```{r, models}
# 2 models:
# quadratic - développed form
M_Quadra_dvp <- stan_model(model_name = "Quadra_dvp",
                           paste(path, "Stanfiles/Bernoulli_EnvOnly_quadratic.stan", sep='')) 
# quadratic forcing the bell form
M_Quadra_forced <- stan_model(model_name = "Quadra_forced",
                              paste(path, "Stanfiles/Bernoulli_EnvOnly_quadratic_forced.stan", sep=''))
gc()
# Models <- list(Quadra_dvp= M_Quadra_dvp,
#                M_Quadra_can= M_Quadra_can) # a list of models to parallelise

# rm(M_Null, M_Affine, M_Quadra_dvp, M_Quadra_forced)
```

```{r, data list}
Np <- 200 # number of predictions
Environmentp <- seq(0, 1, length.out = Np) # environment of predictions

dataM <- lapply(data, function(x) list(N = nrow(x), #les noms des var doivent etre les memes que dans le fichier stan
                                       Presence = x$Presence,
                                       Environment = x$Environment,
                                       # number of predictions
                                       Np = Np,
                                       # environment of predictions
                                       Environmentp = Environmentp))

names(dataM) <- names(data)
# dataM
```

## Models launch
4 data and 2 models
```{r}
Sys.time() # 1min
Quadra_dvp <- sampling(M_Quadra_dvp, data = dataM[[4]], chains = 4, iter = 2000)
saveRDS(Quadra_dvp, file = "D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/Fits/ModelsFormsChoicePerSp/Quadra_dvp_free.rds")

Quadra_forced <- sampling(M_Quadra_forced, data = dataM[[4]], chains = 4, iter = 2000)
saveRDS(Quadra_forced, file = "D:/Mes Donnees/PhD/R_codes/PhD/Modelisation/Fits/ModelsFormsChoicePerSp/Quadra_dvp_forced.rds")
Sys.time() 
```
-> Developped : Avis : **There were 261 divergent transitions after warmup**.  
-> Forced : Avis : **There were 468  divergent transitions after warmup**.  

"divergences are likely if the log posterior density doesn’t have continuous derivative everywhere. Consequently the sampler misses those features and returns biased estimates."  

```{r}
fits <- list(Quadra_dvp, Quadra_forced)
names(fits) <- c("Quadra_dvp", "Quadra_forced")
```

## Chains

```{r, visualiser la progression des chaînes pour chaque paramètres}
mcmc_trace(as.array(Quadra_dvp), 
           pars = c("alpha", "beta1", "beta2"),
           np = nuts_params(Quadra_dvp)) +
  ggplot2::labs(title = "Quadratic developped free form")

mcmc_trace(as.array(Quadra_forced), 
           pars = c("alpha", "beta1", "beta2"),
           np = nuts_params(Quadra_forced)) +
  labs(title = "Quadratic developped forced form")
```

-\> divergence on both forms  

## Parameters link

```{r, visualiser la relation entre chaque paramètre}
mcmc_pairs(as.array(Quadra_dvp), pars = c("alpha", "beta1", "beta2"))

mcmc_pairs(as.array(Quadra_forced), pars = c("alpha", "beta1", "beta2"))
```

# Compare initial vs estimated parameters values

```{r, posteriors table}
summaryfits <- lapply(names(fits), function(x) as.data.frame(summary(fits[[x]], 
                                                                     pars = c("alpha", "beta1", "beta2"))$summary[, c("50%", "2.5%", "97.5%")]) %>% 
                        tibble::rownames_to_column("Parameters")
)
names(summaryfits) <- names(fits)
summaryfits <- bind_rows(summaryfits, .id = "model") %>% mutate(type = names(dataM)[4])

summaryM <- dataParamL %>% 
  left_join(summaryfits, by = c("type", "Parameters")) %>% 
  mutate(Difference = round(`50%`-Initial,2))

summaryM %>% filter(type == names(dataM)[4])
```
-> Forced form permit to estimate beta1 and beta2 closer of the initial parameters values, except for the intercept.    

# Predictions
```{r}
# form= "Quadra_dvp"
dataplot <- lapply(as.list(names(fits)), function(form)
  data.frame(form = form, 
             Environmentp = Environmentp,
             mu = apply(as.matrix(fits[[form]], pars = "p"), 2, median),
             t(apply(as.matrix(fits[[form]], pars = "p"), 2, 
                     quantile, probs = c(0.05, 0.95))),
             Opt = apply(as.matrix(fits[[form]], pars = "o"), 2, median),
             Opt = t(apply(as.matrix(fits[[form]], pars = "o"), 2,
                           quantile, probs = c(0.05, 0.95)))
             
  )) %>% 
  bind_rows()

ggplot(dataplot, aes(x = Environmentp)) +
  # xlim(0,1) +
  # Probas
  geom_point(aes(y = mu), size=0.7) +
  geom_ribbon(aes(ymin = `X5.`, ymax = `X95.`), color = 'red', alpha = 0.2) +
  labs(title = "Simulations median", y = "Presence probability", col= "Presence-absence") +
  facet_wrap(~ form, scales = "free", nrow = 1)

ggplot(dataplot, aes(x = Environmentp)) +
  # xlim(0,1) +
  # Probas
  geom_point(aes(y = mu), size=0.7) +
  geom_ribbon(aes(ymin = `X5.`, ymax = `X95.`), color = 'red', alpha = 0.2) +
  
  # Optimum
  geom_vline(aes(xintercept = Opt), color = "#00AFBB", linewidth=1) + # exp to delog
  geom_vline(aes(xintercept = `Opt.5.`), linetype="dashed") +
  geom_vline(aes(xintercept = `Opt.95.`), linetype="dashed") +
  labs(title = "Simulations median", y = "Presence probability", col= "Presence-absence") +
  facet_wrap(~ form, scales = "free", nrow = 1)

# ggsave("Developped_vs_canonic_quadratic.png", path = "D:/Mes Donnees/PhD/Figures/Modelisation", width = 35, height = 15, units = "cm", dpi=800, bg="white")
```

-> The distributions are similar, exept the intercept  
-> The forced form admit an interpretable extremum  
