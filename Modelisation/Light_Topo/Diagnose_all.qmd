---
title: "Diagnose all"
date: "`r Sys.Date()`"
format: html
self-contained: true
theme: cosmo
editor: source
code-fold: true
---

```{r setup}
library(tidyverse)
library(cmdstanr)
library(bayesplot)
library(patchwork)
library(grid)
library(stringr)

interestsp <- read.csv("D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/InterestSpecies.csv")
sp <- interestsp[,3] # 75
# mettre 2 pour treedatacor

# sp <- c("Licania_membranacea" , "Lecythis_persistens") # 4 forms
# , "Symphonia_sp.1", "Tachigali_melinonii",
#         "Iryanthera_hostmannii", "Tabernaemontana_macrocalyx", "Pouteria_singularis", "Ryania_speciosa"
# sp <- "Symphonia_sp.1"

strategy <- read_delim("~/PhD/Inventories/Data/Understory/Paracou/Species_strategy.csv") %>% 
  select(ScientificName, Strategy_VB, Q95, DBHmax) %>%
  rename(Strategy = Strategy_VB) %>% 
  unique()

PATH <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Modelisation/Plots/Light_topo/Autocor"
```

# Fits
```{r fit}
fits <- list()
for(S in sp){
  tryCatch({
    chain_path <- file.path("Chains", "Hybrid_eigenvectors", S)
    fits[[S]] <- as_cmdstan_fit(list.files(chain_path,
                                           full.names = TRUE))},
    error=function(e){cat("ERROR :",S, conditionMessage(e), "\n")}
  )
}
# names(fits[["Symphonia_sp.1"]])
```

# Divergence
```{r divergence}
Div <- lapply(names(fits), function(x)
  data.frame(Species = x,
             Chain = c(1:4),
             Divergences = fits[[x]]$diagnostic_summary("divergences") # divergences per chain
  ) 
) %>% 
  bind_rows() %>% 
  rename(Divergences = num_divergent) %>% 
  group_by(Species) %>% 
  mutate(`%divergence` = sum(Divergences)/4000*100)

```

# Rhat
R-hat convergence diagnostic, which compares the between- and within-chain estimates for model parameters and other univariate quantities of interest. If chains have not mixed well (ie, the between- and within-chain estimates don't agree), R-hat is larger than 1.01 (Vehtari et al., 2021). 
R-hat which is the maximum of rank normalized split-R-hat and rank normalized folded-split-R-hat, which works for thick tailed distributions and is sensitive also to differences in scale.
```{r Rhat}
Rhat_table <- lapply(names(fits), function(x)
  fits[[x]]$summary(c("alpha", "beta1", "beta2_p", "tau")) %>% 
    mutate(Species = x) %>% 
    select(Species, variable, rhat) 
) %>% 
  bind_rows()

# bayesplot::rhat(fits[[1]],pars="beta2_p")
# posterior::rhat(extract_variable_matrix(fits[[1]], "beta2_p"))

all(Rhat_table$rhat < 1.01) # TRUE

badRhat <- Rhat_table %>% filter(rhat > 1.01) %>% # 0
  left_join(Div %>% select(Species, `%divergence`) %>% unique(), by="Species")
```
# Chains
```{r chains}
name <- unique(badRhat$Species) # names(fits) #
lapply(name , function(x)
  fits[[x]]$draws(c("alpha", "beta1", "beta2_p", "tau")) %>% 
    mcmc_trace() +
    ggtitle(x)
)
```

```{r}
# no light effect (flat) :
# no_light_effect <- c("Iryanthera_sagotiana", "Symphonia_sp.1", "Inga_loubryana", "Virola_michelii", "Pouteria_guianensis", "Eschweilera_congestiflora", "Couratari_multiflora", "Tachigali_melinonii", "Pouteria_gonggrijpii", "Thyrsodium_puberulum", "Anacardium_spruceanum")

# a_Q95 > -0.07
# (a = 0 -> large niche)
```

# Prepare plots data
```{r}
# Plot data
datap <- lapply(names(fits), function(x)
  mcmc_intervals_data(fits[[x]]$draws(c("a", "O", "tau")),
                      prob = 0.5, prob_outer = 0.95, point_est = "median") %>% 
    mutate(Species = x)
)  %>% 
  bind_rows() 

# Light effect (not flat)
O_sg <- datap %>% 
  # mutate(incertitude = hh-ll) %>% 
  # filter(parameter=="O"& incertitude > 4) %>%
  filter(parameter=="a"& m > -0.02) %>% # no light effect
  select(Species) %>% 
  mutate(parameter="O") %>% 
  mutate(Sg_effect = F)

datap <- datap %>%
  left_join(O_sg, by=c("Species", "parameter")) %>% 
  # tau significantly different of 0 if 0 in the Q50%
  mutate(Sg_effect = ifelse(parameter=="tau" & l<0 & 0<h, F, Sg_effect))  %>% 
  mutate(Sg_effect = ifelse(is.na(Sg_effect), T, Sg_effect))  %>%
  left_join(strategy, by = c("Species" = "ScientificName"))
# -a
# datap <- datap %>%
#   mutate_at(vars(c("ll", "l", "m", "h","hh")), ~ ifelse(parameter=="a", (-.), .))
# ll : outer start
# l : iner start
# m : point_est value
# h : iner end
# hh : outer end

# mcmc_intervals() code 
# trace(bayesplot::mcmc_intervals, edit=T)

# 0 line
x_lim <- range(c(datap$ll, datap$hh))
x_range <- diff(x_lim)
x_lim[1] <- x_lim[1] - 0.05 * x_range
x_lim[2] <- x_lim[2] + 0.05 * x_range

# 0 line
layer_vertical_line <- if (0 > x_lim[1] && 0 < x_lim[2]) {
  vline_0(color = "darkred", linewidth = 0.5, linetype = "dashed")
}

# min((datap %>% filter(Species %in% no_light_effect & parameter=='a'))$m) # min a median : -0.019
# range((datap %>% filter(Species %in% no_light_effect & parameter=='O') %>% mutate(incertitude = hh-ll))$incertitude) # O incertitude : 4.5-6.5
```


# Check strategies
```{r}
datap %>% 
  filter(parameter=='O' & Sg_effect) %>% 
  filter(!Species %in% c('Talisia_sylvatica', 'Votomita_guianensis', 'Protium_opacum')) %>% # because misidentifications so wrong Q95
  ggplot(aes(x=Q95, y=m, col = Strategy)) +
  theme_minimal() + 
  scale_y_continuous("O median (transmittance %)", n.breaks = 10, labels = ~round(exp(.)*100,2)) + # delog
  ggrepel::geom_text_repel(aes(label = Species), col = "black", size = 2.5) +
  geom_point() +
  scale_color_manual(values = c("Canopy species" = "#E7B800",
                                "Understory species"= "#009E73",
                                "NA" = "darkgrey")) +
  labs(x= "DBH Q95% (cm)")


ggsave("Light_topo_checkstrategies.pdf", path = PATH,
       width = 25, height = 26, units = "cm", dpi=800, bg="white")
```

# Check extremes
```{r}
for(P in c("O", "tau")){
  # P="O"
  print(
    datap %>% 
      filter(parameter==P & Sg_effect) %>% 
      # summarise(N = n()) %>% 
      ggplot(aes(x= m)) +
      theme_minimal() + 
      geom_histogram(bins=10, fill="#69b3a2", color="#e9ecef", alpha=0.9) + # binwidth=1, 
      {if(P=='O') scale_x_continuous("O median (transmittance %)", n.breaks = 13, labels = ~round(exp(.)*100,2))} + # delog
      {if(P=='tau') xlab(P)} +
      labs(y = 'Species number')
  )}
```

# Posteriors
Plot central (quantile-based) posterior interval estimates from MCMC draws
```{r, eval=F}
datap %>% 
  mutate(parameter = factor(parameter,
                            levels=c("tau", "O", "a")
                            # levels=c("O","a","tau")
  )) %>% 
  group_by(parameter) %>%
  group_modify(~.x %>% 
                 arrange(if(.y == 'tau') m else desc(m))
               # arrange(if(.y == 'O') m else desc(m))
  ) %>%
  ungroup() %>%
  mutate(Species=factor(Species, levels=unique(Species))) %>% 
  ggplot(aes(y = Species, alpha = Sg_effect)) +
  theme_minimal() + 
  # xlim(range(c(datap$ll, datap$hh))) +
  layer_vertical_line +
  geom_segment(aes(x=ll, xend=hh, y=Species, yend=Species,
                   color = "95%"), size = 0.5) +
  geom_segment(aes(x=l, xend=h, y=Species, yend=Species,
                   color = "50%"), size = 1) +
  geom_point(aes(x= m)) + # median
  scale_color_manual(name = "Credible interval", 
                     values = c("95%" = "#E7B800",
                                "50%"= "#FC4E07")) + 
  scale_alpha_manual(name = "Non-null effect", values=c(1,.2),
                     breaks=c("TRUE","FALSE")) +
  theme(axis.title.x =element_blank()) +
  facet_grid(~parameter, scale= "free")

gridExtra::grid.arrange()

ggsave("Light_topo_posteriors.pdf", path = PATH,
       width = 25, height = 26, units = "cm", dpi=800, bg="white")

# O et tau iront dans le biplot
# les paramètres dont on veut la significativité : iota
# a on veut sa valeur absolue pour juger la largeur de niche
# gamma on s'en fout ?
```

## Posteriors with O deloged and -a logged
```{r}
datap_ord <- datap %>% 
  mutate(parameter = factor(parameter,
                            # levels=c("tau", "O", "a")
                            levels=c("O","a","tau")
  )) %>% 
  group_by(parameter) %>%
  group_modify(~.x %>% 
                 # arrange(if(.y == 'tau') m else desc(m))
                 arrange(if(.y == 'O') m else desc(m))
  ) %>%
  ungroup() %>%
  mutate(Species=factor(Species, levels=unique(Species))) 

xs <- split(datap_ord, f = datap_ord$parameter)

# Residuals_covar %>% 
p1 <- xs$O %>% 
  ggplot(aes(y = Species, alpha = Sg_effect)) +
  theme_minimal() + 
  # xlim(range(c(datap$ll, datap$hh))) +
  layer_vertical_line +
  geom_segment(aes(x=ll, xend=hh, y=Species, yend=Species,
                   color = "95%"), size = 0.5) +
  geom_segment(aes(x=l, xend=h, y=Species, yend=Species,
                   color = "50%"), size = 1) +
  geom_point(aes(x= m)) + # median
  scale_color_manual(name = "Credible interval", 
                     values = c("95%" = "#E7B800",
                                "50%"= "#FC4E07")) + 
  scale_alpha_manual(name = "Non-null effect", values=c(1,.2),
                     breaks=c("TRUE","FALSE"))+
  theme(axis.title.x =element_blank())

p2 <- p1 %+% xs$a +
  ggtitle("a") +
  # scale_x_continuous(trans="log") +
  theme(axis.title.y=element_blank(), axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  guides(color = FALSE, alpha = FALSE)

p3 <- p1 %+% xs$tau  +
  ggtitle("tau") +
  theme(axis.title.y=element_blank(), axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

p1 <- p1 + ggtitle("O (% transmittance)") +
  scale_x_continuous(n.breaks = 5, labels = ~round(exp(.)*100,2)) + # delog
  guides(color = FALSE, alpha = FALSE)


p1+p2+p3

ggsave("Light_topo_posteriors_delog.pdf", path = PATH,
       width = 25, height = 26, units = "cm", dpi=800, bg="white")

```

# Monoplots
```{r}
for(P in c('O', 'tau', 'a')){
  # P="O"
  print(
    datap %>% 
      filter(parameter==P) %>% 
      arrange(m) %>%
      mutate(Species=factor(Species, levels=unique(Species))) %>% 
      
      ggplot(aes(y = Species, alpha = Sg_effect)) +
      theme_minimal() + 
      {if(P=='tau') geom_vline(xintercept=0, linetype = "dashed", col = "red") } +
      {if(P=='a') list(geom_vline(xintercept=-0.02, linetype = "dashed", col = "red")#,
                       # scale_x_continuous(trans="log")
      )} + 
      
      # xlim(range(c(datap$ll, datap$hh))) +
      # layer_vertical_line +
      geom_segment(aes(x=ll, xend=hh, y=Species, yend=Species,
                       color = "95%"), size = 0.5) +
      geom_segment(aes(x=l, xend=h, y=Species, yend=Species,
                       color = "50%"), size = 1) +
      geom_point(aes(x= m)) + # median
      xlab(P) +
      {if(P=='O')  scale_x_continuous("O (% transmittance)", n.breaks = 14,labels = ~round(exp(.)*100,2)) } + #  breaks = log(c(.002, .01, .05, .1, .5, 1, .2, .3, 1))
      scale_color_manual(name = "Credible interval", 
                         values = c("95%" = "#E7B800",
                                    "50%"= "#FC4E07")) + 
      scale_alpha_manual(name = "Non-null effect", values=c(1,.2),
                         breaks=c("TRUE","FALSE"))+
      {if(P=='a') guides(alpha = FALSE) } +
      theme(axis.title.x =element_blank(), legend.position="bottom") +
      # coord_flip() + theme(axis.text.x = element_text(angle = 90, vjust = 0.3, hjust=1)) +
      
      # Annotations
      theme(plot.margin = unit(c(1,1,1,4), "lines")) +
      coord_flip(clip = "off") + theme(axis.text.x = element_text(angle = 90, vjust = 0.3, hjust=1)) +
      
      {if(P=='a') list(
        annotation_custom(textGrob("Wide light\nniche"),xmin= 0,xmax=0,ymin=-6,ymax=-6), 
        annotation_custom(textGrob("Narrow light\nniche"),xmin= -.7,xmax=-.7,ymin=-6,ymax=-6)
      ) } +
      {if(P=='O') list(
        annotation_custom(textGrob("Heliophile"),xmin= 0,xmax=0,ymin=-7,ymax=-7), 
        annotation_custom(textGrob("Sciaphile"),xmin= -7,xmax=-7,ymin=-7,ymax=-7)
      ) } +
      {if(P=='tau') list(
        annotation_custom(textGrob("More flood\ntolerant"),xmin= 2.5,xmax=2.5,ymin=-6,ymax=-6), 
        annotation_custom(textGrob("Less flood\ntolerant"),xmin= -6,xmax=-6,ymin=-6,ymax=-6)
      ) }
  )
  
  ggsave(paste(P,"monoplot.png", sep='_'), path = PATH,
         width = 23, height = 13, units = "cm", dpi=800, bg="white")
}

```

# Relation incertitude vs species abundance
```{r}
datap %>% 
  mutate(Incertitude = hh-ll) %>% 
  left_join(interestsp %>% select(ScientificName,N), by = c('Species' = 'ScientificName')) %>% 
  select(Species, N, parameter,Incertitude) %>% unique() %>% 
  
  ggplot(aes(x=N, y= Incertitude)) +
  theme_minimal() +
  # geom_point() +
  geom_line() +
  scale_x_continuous(trans="log", labels = ~round(.,0), breaks = c(30, 50, 100, 200, 500, 1000, 2140)) +
  ggpubr::stat_cor(aes(x=log(N), y= Incertitude), method = "pearson",
                   label.x.npc = 0.36, label.y.npc = 1) + 
  facet_wrap(~parameter, scale= "free") +
  labs(y= "Parameter 95% incertitude", x= 'Species abundance')
# N range : 30-2 140

ggsave("Incertitude_vs_sp_abundance.png", path = PATH,
         width = 23, height = 13, units = "cm", dpi=800, bg="white")
```

# Biplot O vs tau
O in y, tau in x
```{r, eval=F}
# color and alpha background for topo and light env
# rects <- data.frame(xstart = sort(rep(c(-7.5, .5, -0.5), times=2)), xend = sort(rep(c(-0.5, .5, 3), times=2)),
#                     ystart = rep(c(-7,log(0.5)), times =3), yend = rep(c(log(0.5),0), times =3), 
#                     col = rep(c("Hilltop", "No effect", "Bottomland"), each =2),
#                     light = rep(c("Sciaphile", "Heliophile"), times =3))

rects <- data.frame(xstart = c(-3, 0), xend = c(0, 3),
                    ystart = rep(-7, times =2), yend = rep(0, times =2),
                    col = c("Less flood\ntolerant", "More flood\ntolerant") #,
                    # light = rep(c("Sciaphile", "Heliophile"), times =3)
)

```

```{r}
O_sg <- datap %>% 
  # filter(parameter=="O"& incertitude > 4) %>%
  filter(parameter=="a"& m > -0.02) %>% # no light effect
  select(Species) %>% 
  mutate(Sg_light_effect = F)

databp <- datap %>% 
  select(-c(Sg_effect,Q95)) %>%
  select(-c(outer_width, inner_width, point_est)) %>% 
  filter(parameter %in% c("O", "tau")) %>%
  # Light effect (not flat)
  left_join(O_sg, by=c("Species")) %>%
  mutate(Sg_light_effect = ifelse(is.na(Sg_light_effect), T, Sg_light_effect)) %>% 
  rename(Q5 = ll, Q95 = hh, median = m, Q50_0 = l, Q50_1 = h) %>% 
  pivot_wider(names_from = parameter, values_from = c(Q5, Q50_0, median, Q50_1, Q95),
              names_glue = "{parameter}_{.value}") %>% 
  # tau significantly different of 0
  mutate(Tau_effect = ifelse(tau_Q50_0<0 & 0<tau_Q50_1, F, T))

exp(quantile(databp$O_median, probs = 0.5))*100


(nrow(databp %>% filter(Tau_effect))/nrow(databp))*100
# 56% sp with tau significantly (95% CI) different of 0
# 80% sp with tau significantly (50% CI) different of 0
(nrow(databp %>% filter(Sg_light_effect))/nrow(databp))*100 # 80% sp with 


range(databp$tau_median) # -2.9 ; 2.3
min(databp$tau_Q5) # -6
max(databp$tau_Q95) # 3

cor(databp$tau_median, databp$O_median, method = "pearson") #  -0.15

# hc <- hclust(dist(databp[c("tau_median", "O_median")])) # Hierarchical Clustering
# plot(hc)
# databp$cluster <- cutree(hc, k = 4) # Cut a Tree into Groups
```

## Complete
```{r}
ggplot(databp) +
  theme_minimal() + 
  geom_rect(data=rects, aes(ymin=ystart, ymax=yend, xmin=xstart,
                            xmax=xend, fill=col, alpha=light)) +
  scale_fill_manual(name = "Topographic preference",
                    values = c("Hilltop" = "#E7B800",
                               "Bottomland"= "steelblue",
                               "No effect"= "grey"),
                    breaks = c("Hilltop","No effect","Bottomland")) + 
  
  scale_alpha_manual(name = "Light preference", values=c(.2,.5)) +
  
  # geom_smooth(aes(x= tau_median, y = O_median), method='lm', formula= y~x, col = "#999999", alpha = 0.2) +
  ggpubr::stat_cor(aes(x= tau_median, y = O_median), method = "pearson", label.x = -7.5, label.y = .1) +
  
  geom_vline(xintercept = 0, col="red", linetype = "dashed") +
  
  # 95% credible interval
  geom_segment(aes(x=tau_Q5, xend=tau_Q95, y=O_median, yend=O_median,
                   col = "95 and 50% CI"), size = .5) + # tau
  geom_segment(aes(y=O_Q5, yend=O_Q95, x=tau_median, xend=tau_median,
                   col = "95 and 50% CI"), size = .5) + # O
  geom_segment(aes(x=tau_Q50_0, xend=tau_Q50_1, y=O_median, yend=O_median,
                   col = "95 and 50% CI"), size = .6) + # tau
  geom_segment(aes(y=O_Q50_0, yend=O_Q50_1, x=tau_median, xend=tau_median,
                   col = "95 and 50% CI"), size = .6) + # O
  
  
  geom_point(aes(x= tau_median, y = O_median, # median
                 col=Tau_effect, shape = Sg_light_effect)) + 
  scale_shape_manual(name="Light effect",
                     values=c("FALSE" = 1, "TRUE" = 19),
                     breaks = c("TRUE","FALSE")) +
  
  scale_color_manual(name = "Significant topographic effect",
                     values = c("FALSE" = "grey",
                                "TRUE"= "black",
                                "95 and 50% CI" = "darkgrey"),
                     breaks=c("TRUE",  "FALSE", 
                              "95 and 50% CI")) + 
  
  ggrepel::geom_text_repel(aes(x= tau_median, y = O_median, label = Species), col = "black", size = 2.5) +
  
  # stat_ellipse(aes(x= tau_median, y = O_median, color = as.factor(cluster)),
  #              type = "t",geom = "polygon",alpha = 0.4) +
  
  scale_y_continuous(n.breaks = 10, labels = ~round(exp(.)*100,2)) + # delog
  # scale_y_continuous(trans="exp") +
  guides(fill = guide_legend(nrow=2), alpha = guide_legend(nrow=2),
         col = guide_legend(nrow=2), shape = guide_legend(nrow=2)) +
  theme(axis.title = ggtext::element_markdown(),
        legend.title = ggtext::element_markdown(),
        legend.position="bottom") + # , legend.box="vertical"
  labs(x= "Topographic Wetness Index (TWI) linear effect (*tau*)",
       y= "Light optimum (*O*) (% transmittance)")

# alpha sur les postériors imprécis

ggsave("Light_topo_biplot_complete.png", path = PATH,
       width = 32, height = 20, units = "cm", dpi=800, bg="white")

```

## No error bar
```{r}
ggplot(databp) +
  theme_minimal() + 
  geom_rect(data=rects, aes(ymin=ystart, ymax=yend, xmin=xstart,
                            xmax=xend, fill=col), alpha=.4) + # , alpha=light
  scale_fill_manual(values = c("Less flood\ntolerant" = "#E7B800",
                               "More flood\ntolerant"= "steelblue"),
                    breaks = c("Less flood\ntolerant","More flood\ntolerant")) + 
  
  # scale_alpha_manual(name = "Light preference", values=c(.2,.5)) +
  
  # geom_smooth(aes(x= tau_median, y = O_median), method='lm', formula= y~x, col = "#999999", alpha = 0.2) +
  # ggpubr::stat_cor(aes(x= tau_median, y = O_median), method = "pearson", label.x = -3, label.y = .1) +
  
  geom_vline(xintercept = 0, col="red", linetype = "dashed") +
  
  geom_point(aes(x= tau_median, y = O_median, # median
                 col=Tau_effect, shape = Sg_light_effect)) + 
  scale_shape_manual(name="Light effect",
                     values=c("FALSE" = 1, "TRUE" = 19),
                     breaks = c("TRUE","FALSE")) +
  
  scale_color_manual(values = c("FALSE" = "#999999",
                                "TRUE"= "black",
                                "95 and 50% CI" = "darkgrey"),
                     breaks=c("TRUE",  "FALSE", 
                              "95 and 50% CI")) + 
  
  ggrepel::geom_text_repel(aes(x= tau_median, y = O_median, label = Species), col = "black", size = 3) +
  
  # stat_ellipse(aes(x= tau_median, y = O_median, color = as.factor(cluster)),
  #              type = "t",geom = "polygon",alpha = 0.4) +
  
  scale_y_continuous(n.breaks = 10, labels = ~round(exp(.)*100,2)) + # delog
  # scale_y_continuous(trans="exp") +
  guides(fill = guide_legend(nrow=2), alpha = guide_legend(nrow=2),
         col = guide_legend(nrow=2), shape = guide_legend(nrow=2)) +
  theme(axis.title = ggtext::element_markdown(),
        legend.title = ggtext::element_markdown(),
        legend.position="bottom") + # , legend.box="vertical"
  labs(x= "Topographic Wetness Index (TWI) linear effect (*tau*)",
       y= "Light optimum (*O*) (% transmittance)",
       fill="Topographic\npreference", col ="Significant\ntopographic effect")

# alpha sur les postériors imprécis

ggsave("Light_topo_biplot_noerrorbar.png", path = PATH,
       width = 21, height = 15, units = "cm", dpi=800, bg="white")

```

## Without no light effect
```{r}
databp %>% 
  filter(Sg_light_effect) %>% 
  ggplot() +
  theme_minimal() + 
  geom_rect(data=rects, aes(ymin=ystart, ymax=yend, xmin=xstart,
                            xmax=xend, fill=col, alpha=light)) +
  scale_fill_manual(name = "Topographic preference",
                    values = c("Hilltop" = "#E7B800",
                               "Bottomland"= "steelblue",
                               "No effect"= "grey"),
                    breaks = c("Hilltop","No effect","Bottomland")) + 
  
  scale_alpha_manual(name = "Light preference", values=c(.2,.5)) +
  
  # geom_smooth(aes(x= tau_median, y = O_median), method='lm', formula= y~x, col = "#999999", alpha = 0.2) +
  ggpubr::stat_cor(aes(x= tau_median, y = O_median), label.x = -7.5, label.y = .1) +
  
  geom_vline(xintercept = 0, col="red", linetype = "dashed") +
  
  geom_point(aes(x= tau_median, y = O_median, # median
                 col=Tau_effect)) + 
  
  scale_color_manual(name = "Significant topographic effect",
                     values = c("FALSE" = "grey",
                                "TRUE"= "black",
                                "95 and 50% CI" = "darkgrey"),
                     breaks=c("TRUE",  "FALSE", 
                              "95 and 50% CI")) + 
  
  ggrepel::geom_text_repel(aes(x= tau_median, y = O_median, label = Species), col = "black", size = 2.5) +
  
  # stat_ellipse(aes(x= tau_median, y = O_median, color = as.factor(cluster)),
  #              type = "t",geom = "polygon",alpha = 0.4) +
  
  scale_y_continuous(n.breaks = 10, labels = ~round(exp(.)*100,2)) + # delog
  # scale_y_continuous(trans="exp") +
  guides(fill = guide_legend(nrow=2), alpha = guide_legend(nrow=2),
         col = guide_legend(nrow=2), shape = guide_legend(nrow=2)) +
  theme(axis.title = ggtext::element_markdown(),
        legend.title = ggtext::element_markdown(),
        legend.position="bottom") + # , legend.box="vertical"
  labs(x= "Topographic Wetness Index (TWI) linear effect (*tau*)",
       y= "Light optimum (*O*) (% transmittance)")

# alpha sur les postériors imprécis

ggsave("Light_topo_biplot_noerrorbar_onlysg_light_effect.png", path = PATH,
       width = 32, height = 20, units = "cm", dpi=800, bg="white")

```
## With strategy
```{r}
ggplot(databp) +
  theme_minimal() + 
  geom_rect(data=rects, aes(ymin=ystart, ymax=yend, xmin=xstart,
                            xmax=xend, fill=col), alpha=.4) + # , alpha=light
  scale_fill_manual(name = "Topographic preference",
                    values = c("Less flood\ntolerant" = "#E7B800",
                               "More flood\ntolerant"= "steelblue"),
                    breaks = c("Less flood\ntolerant","More flood\ntolerant")) + 
  
  # scale_alpha_manual(name = "Light preference", values=c(.2,.5)) +
  
  # geom_smooth(aes(x= tau_median, y = O_median), method='lm', formula= y~x, col = "#999999", alpha = 0.2) +
  geom_vline(xintercept = 0, col="red", linetype = "dashed") +
  
  geom_point(aes(x= tau_median, y = O_median, # median
                 col=Strategy, shape = Sg_light_effect)) + 
  scale_shape_manual(name="Light effect",
                     values=c("FALSE" = 1, "TRUE" = 19),
                     breaks = c("TRUE","FALSE")) +
  
  scale_color_manual(values = c("Canopy species" = "#E7B800",
                                "Understory species"= "#009E73",
                                "NA" = "darkgrey"),
                     breaks=c("Canopy species", "Understory species", "NA")) + 
  
  ggrepel::geom_text_repel(aes(x= tau_median, y = O_median, label = Species), col = "black", size = 3) +
  
  scale_y_continuous(n.breaks = 10, labels = ~round(exp(.)*100,2)) + # delog
  # scale_y_continuous(trans="exp") +
  guides(fill = guide_legend(nrow=2), alpha = guide_legend(nrow=2),
         col = guide_legend(nrow=2), shape = guide_legend(nrow=2)) +
  theme(axis.title = ggtext::element_markdown(),
        legend.title = ggtext::element_markdown(),
        legend.position="bottom") + # , legend.box="vertical"
  labs(x= "Topographic Wetness Index (TWI) linear effect (*tau*)",
       y= "Light optimum (*O*) (% transmittance)")

# alpha sur les postériors imprécis

ggsave("Light_topo_biplot_strategy.png", path = PATH,
       width = 23, height = 20, units = "cm", dpi=800, bg="white")

```
# Experts validation
```{r, echo=F}
Experts <- read_csv("~/PhD/Inventories/Data/Database_niche_littérature.csv") %>% 
  filter(OurSpecies) %>% 
  select(-OurSpecies, -`...11`) %>%
  # select(Species, Temperament, Topography) %>% 
  mutate(Species = str_replace(Species, " ", "_"))

estimate <- databp %>% 
  select(Species, O_median, tau_median, Sg_light_effect, Tau_effect) %>% 
  mutate(Estimate_light_optimum = round(exp(O_median)*100, 2)) %>% 
  mutate(Chap2_TWI = case_when(
    !Tau_effect ~ "generalist",
    tau_median > 0 & Tau_effect ~ "positif",
    tau_median < 0 & Tau_effect ~ "negatif") 
  ) %>% 
  mutate(Chap2_Light = case_when(
    !Sg_light_effect ~ "generalist",
    Estimate_light_optimum >= 30 & Sg_light_effect ~ "Heliophile", # >30%
    # Estimate_light_optimum > log(30/100) & Sg_light_effect ~ "intermediate",
    Estimate_light_optimum <= 5 & Sg_light_effect ~ "Sciaphile",
    .default = "intermediate") # <5%
  ) %>% 
  select(Species, Chap2_Light, Chap2_TWI, Estimate_light_optimum, Sg_light_effect, tau_median, Tau_effect) # Estimate_light_optimum, Sg_light_effect, tau_median, Tau_effect, 

validation <- left_join(Experts, estimate, by= 'Species') %>% 
  # Validate topo
  left_join(interestsp %>% select(ScientificName,N), by = c('Species' = 'ScientificName')) %>% 
  mutate(Validate_topo = case_when(
    Topography == "Bottomland" & Chap2_TWI=="negatif" ~ F,
    Topography == "Hilltop" & Chap2_TWI=="positif" ~ F,
    
    Topography == "no associated" & Chap2_TWI=="generalist" ~ T,
    grepl("Bottomland", Topography) & Chap2_TWI=="positif" ~ T,
    grepl("Hilltop", Topography) & Chap2_TWI=="negatif" ~ T
  )) %>% 
  # Validate light
  mutate(Validate_light = case_when(
    Temperament == "Hard struggler" & Chap2_Light=="Heliophile" ~ F,
    Temperament == "Hard gambler" & Chap2_Light=="Sciaphile" ~ F,
    # Hard gambler	generalist
    
    grepl("Hard gambler", Temperament) & Chap2_Light=="Heliophile" ~ T,
    grepl("Hard struggler", Temperament) & Chap2_Light=="Sciaphile" ~ T,
    grepl("Shade tolerant", Temperament) & grepl("Favrichon", Temperament) & Chap2_Light=="Sciaphile" ~ T
  )) %>% 
  select(Species, N, Topography, Temperament, Chap2_TWI, Chap2_Light, Validate_topo, Validate_light, References)


# Check topo
unique((validation %>% filter(Chap2_TWI=="negatif" & !is.na(Topography)))$Topography)
unique((validation %>% filter(Chap2_TWI=="positif" & !is.na(Topography)))$Topography)

unique((validation %>% filter(is.na(Validate_topo) & !is.na(Topography)))$Topography)
validation %>% filter(is.na(Validate_topo) & !is.na(Topography)) %>% select(Species, N,Topography, Chap2_TWI) # Validate_topo: NA # 8

validation %>% filter(Validate_topo) %>% select(Species, N,Topography, Chap2_TWI) # Validate_topo: T # 18/27
validation %>% filter(!Validate_topo) %>% select(Species, N,Topography, Chap2_TWI) # Validate_topo: F # 2/27
validation %>% filter(is.na(Validate_topo) & !is.na(Topography)) %>% filter(Chap2_TWI=="generalist"|Topography=='no associated') %>% select(Species, N, Topography, Chap2_TWI) # Validate_topo: no effect # 7/27


# Check light
validation %>% filter(is.na(Validate_light) & !is.na(Temperament)) %>% select(Temperament, Chap2_Light) # Validate_topo: NA # 18

validation %>% filter(Validate_light) %>% select(Temperament, Chap2_Light) # Validate_light: T # 7/8
validation %>% filter(!Validate_light) %>% select(Temperament, Chap2_Light) # Validate_light: F # 0
validation %>% filter(is.na(Validate_light) & !is.na(Temperament)) %>% filter(grepl("Hard", Temperament) & Chap2_Light=="generalist") %>%  select(Species, N, Temperament, Chap2_Light) # Validate_light: no effect # 1/8


# conserve generalist info of lit and estimated

validation_table <- validation %>% 
  filter(!is.na(Topography) | !is.na(Temperament)) %>% 
  filter((!is.na(Validate_topo) | Chap2_TWI=="generalist" | Topography=='no associated') | ( !is.na(Validate_light) | grepl("Hard", Temperament) & Chap2_Light=="generalist")) %>%
  arrange(Validate_light, desc(Validate_topo)) %>% 
  rename(`Estimated light preference` = Chap2_Light,
         `Estimated wetness preference` = Chap2_TWI,
         `Literature light preference` = Temperament,
         `Literature wetness preference` = Topography,
         `Topographic effect validation` = Validate_topo,
         `Light effect validation` = Validate_light,
  )

write_csv(validation_table, paste(PATH, "/Model_validation_table.csv", sep=''))
```


# Biplot O vs a

O in y, a in x
```{r}
# color and alpha background for light env
# rects <- data.frame(xstart = rep(-0.75, times=2), xend = rep(0, times=2),
#                     ystart = c(-7,log(0.5)), yend = c(log(0.5),0), 
#                     light = c("Sciaphile", "Heliophile"))
```

```{r}
databp <- datap %>% 
  select(-Q95) %>% 
  select(-c(outer_width, inner_width, point_est, Sg_effect)) %>% 
  rename(Q5 = ll, Q95 = hh, median = m, Q50_0 = l, Q50_1 = h) %>% 
  filter(parameter %in% c("O", "a")) %>% 
  pivot_wider(names_from = parameter, values_from = c(Q5, Q50_0, median, Q50_1, Q95),
              names_glue = "{parameter}_{.value}") %>% 
  # Light effect (not flat)
  mutate(Sg_effect = ifelse(a_median > -0.02, F, T)) # no light effect

# databp <- databp %>%
#   mutate_at(vars(c(a_Q5, a_Q50_0, a_median, a_Q50_1, a_Q95)), ~ (-.))
```

```{r}
ggplot(databp) +
  theme_minimal() + 
  geom_vline(xintercept=-0.02, linetype = "dashed", col = "red") +
  # geom_rect(data=rects, aes(ymin=ystart, ymax=yend, xmin= xstart,
  #                           xmax=xend, alpha=light), fill="grey") +
  
  # geom_rect(data=rects, aes(ymin=ystart, ymax=yend, xmin= min(databp$a_Q5),
  #                           xmax=xend, alpha=light), fill="grey") +
  # scale_alpha_manual(name = "Light preference", values=c(.1,.5)) +
  
  # 95% credible interval
  # geom_segment(aes(x=a_Q5, xend=a_Q95, y=O_median, yend=O_median,
  #                  col = "95 and 50% CI"), size = .5) + # tau
  # geom_segment(aes(y=O_Q5, yend=O_Q95, x=a_median, xend=a_median,
  #                  col = "95 and 50% CI"), size = .5) + # O
  # geom_segment(aes(x=a_Q50_0, xend=a_Q50_1, y=O_median, yend=O_median,
  #                  col = "95 and 50% CI"), size = .6) + # tau
  # geom_segment(aes(y=O_Q50_0, yend=O_Q50_1, x=a_median, xend=a_median,
  #                  col = "95 and 50% CI"), size = .6) + # O
  
  
  geom_point(aes(x= a_median, y = O_median, shape = Sg_effect)) + # median
  scale_shape_manual(name="Light effect",
                     values=c("FALSE" = 1, "TRUE" = 19),
                     breaks = c("TRUE","FALSE")) +
  # scale_color_manual(name="", values = c("95 and 50% CI" = "darkgrey")) + 
  
  ggrepel::geom_text_repel(aes(x= a_median, y = O_median, label = Species), col = "black", size = 3) +
  
  # stat_ellipse(aes(x= a_median, y = O_median, color = as.factor(cluster)),
  #              type = "t",geom = "polygon",alpha = 0.4) +
  
  scale_y_continuous(n.breaks = 10, labels = ~round(exp(.)*100,2)) + # delog
  # scale_x_continuous(trans="log") +
  
  # ggpubr::stat_cor(aes(x= a_median, y = O_median), method = "pearson", label.x = -.35, label.y = .1) +
  
  # Annotations
  theme(plot.margin = unit(c(1,1,1,1), "lines")) +
  coord_cartesian(clip = "off") + 
  
  annotation_custom(textGrob("Narrow light\nniche"),xmin= -.35,xmax=-.35,ymin=-7.5,ymax=-7.5) +
  annotation_custom(textGrob("Wide light\nniche"),xmin= -.05,xmax=-.05,ymin=-7.5,ymax=-7.5) + 
  annotation_custom(textGrob("Flat light\nniche"),xmin= 0,xmax=0,ymin=-7.5,ymax=-7.5) + 
  
  theme(axis.title = ggtext::element_markdown(),
        legend.title = ggtext::element_markdown(),
        legend.position="bottom") +
  labs(x= "Niche width (*a*)",
       y= "Light optimum (*O*) (% transmittance)")

# alpha sur les postériors imprécis

ggsave("O_a_biplot.png", path = PATH,
       width = 21, height = 15, units = "cm", dpi=800, bg="white")

```

## Strategy
```{r}
ggplot(databp) +
  theme_minimal() + 
  geom_vline(xintercept=-0.02, linetype = "dashed", col = "red") +
  # geom_rect(data=rects, aes(ymin=ystart, ymax=yend, xmin= xstart,
  #                           xmax=xend, alpha=light), fill="grey") +
  # 
  # scale_alpha_manual(name = "Light preference", values=c(.1,.5)) +
  
  # geom_smooth(aes(x= tau_median, y = O_median), method='lm', formula= y~x, col = "#999999", alpha = 0.2) +
  # 95% credible interval
  # geom_segment(aes(x=a_Q5, xend=a_Q95, y=O_median, yend=O_median,
  #                  col = "95 and 50% CI"), size = .5) + # tau
  # geom_segment(aes(y=O_Q5, yend=O_Q95, x=a_median, xend=a_median,
  #                  col = "95 and 50% CI"), size = .5) + # O
  # geom_segment(aes(x=a_Q50_0, xend=a_Q50_1, y=O_median, yend=O_median,
  #                  col = "95 and 50% CI"), size = .6) + # tau
  # geom_segment(aes(y=O_Q50_0, yend=O_Q50_1, x=a_median, xend=a_median,
  #                  col = "95 and 50% CI"), size = .6) + # O
  
  
  geom_point(aes(x= a_median, y = O_median, col = Strategy, shape = Sg_effect)) + # median
  scale_shape_manual(name="Light effect",
                     values=c("FALSE" = 1, "TRUE" = 19),
                     breaks = c("TRUE","FALSE")) +
  scale_color_manual('Strategy', values = c("Canopy species" = "#E7B800",
                                            "Understory species"= "#009E73",
                                            "NA" = "darkgrey",
                                            "95 and 50% CI" = "darkgrey"),
                     breaks=c("Canopy species", "Understory species", "NA", "95 and 50% CI")) + 
  
  
  ggrepel::geom_text_repel(aes(x= a_median, y = O_median, label = Species), col = "black", size = 2.5) +
  
  # stat_ellipse(aes(x= a_median, y = O_median, color = as.factor(cluster)),
  #              type = "t",geom = "polygon",alpha = 0.4) +
  
  scale_y_continuous(n.breaks = 10, labels = ~round(exp(.)*100,2)) + # delog
  
  # Annotations
  theme(plot.margin = unit(c(1,1,1,1), "lines")) +
  coord_cartesian(clip = "off") + 
  
  annotation_custom(textGrob("Narrow light\nniche", gp = gpar(fontsize=10)),
                    xmin= -.35,xmax=-.35,ymin=-7,ymax=-7) +
  annotation_custom(textGrob("Wide light\nniche", gp = gpar(fontsize=10)),
                    xmin= -.05,xmax=-.05,ymin=-7,ymax=-7) + 
  annotation_custom(textGrob("Flat light\nniche", gp = gpar(fontsize=10)),
                    xmin= 0,xmax=0,ymin=-7,ymax=-7) + 
  
  theme(axis.title = ggtext::element_markdown(),
        legend.title = ggtext::element_markdown(),
        legend.position="bottom") +
  labs(x= "Niche width (*a*)",
       y= "Light optimum (*O*) (% transmittance)")

# alpha sur les postériors imprécis

ggsave("O_a_biplot_strategy.png", path = PATH,
       width = 17, height = 25, units = "cm", dpi=800, bg="white")

```

# Predictions
```{r predictions}
Sys.time()

plist <- list()

for(s in names(fits)){
  plist[[s]] <- local({
    # s= "Lecythis_persistens"
    
    DATA <- fits[[s]]$summary("p") %>%  # p posterior
      # prediction environment 
      rowwise() %>% 
      mutate(Light = as.numeric(unlist(str_extract_all(variable, "\\d+"))[1])) %>% 
      mutate(Topo = as.numeric(unlist(str_extract_all(variable, "\\d+"))[2])) %>% 
      mutate(logTransmittance = seq(-7.308724e+00, 8.941571e-08, length.out = 50)[Light]) %>% # -7.308724e+00 , 8.941571e-08
      mutate(logTWI = seq(1.358045, 2.400176, length.out = 50)[Topo]) # 1.358045 - 2.400176
    
    DATA %>% 
      group_by(Light) %>% 
      # At topo optimum (i.e. presence proba. max)
      filter(median==max(median)) %>% 
      ggplot(aes(x = logTransmittance)) +
      theme_minimal() +
      geom_point(aes(y = median), size=0.7) + # p posterior median
      geom_ribbon(aes(ymin = q5, ymax = q95), color = 'red', alpha = 0.2) + # P quantiles
      geom_vline(xintercept  = fits[[s]]$summary("O", median)$median, color = "#00AFBB", linewidth=1) + # Opt median
      geom_vline(xintercept  = fits[[s]]$summary("O")$q5, linetype="dashed") + # Opt Q5%
      geom_vline(xintercept  = fits[[s]]$summary("O")$q95, linetype="dashed") + # Opt Q95%
      # scale_x_continuous(trans="log") +
      scale_x_continuous(name = "Light (% transmittance)",
                         n.breaks = 10, labels = ~round(exp(.)*100,2)) + # delog
      ggtitle(paste(s,"- at logTWI optimum")) +
      ylab("Presence probabiblity median")
    
  })
}


plots <- gridExtra::marrangeGrob(plist, nrow = 3, ncol = 3) # 75
# plots

ggsave("Allsp_Light_niche_atTWIoptimum.pdf",
       path = PATH,
       plots, width = 15, height = 10)

Sys.time() # 32 min
```

# Strategies boxplot
```{r}
ggplot(datap, aes(x= Strategy, y= m, col= Strategy)) +
  theme_minimal() +
  geom_boxplot() +
  scale_color_manual(values = c("Canopy species" = "#E7B800",
                                "Understory species"= "#009E73",
                                "NA" = "darkgrey")) + 
  labs(y="Median") +
  theme(axis.title.x =element_blank(), axis.text.x =element_blank()) +
  facet_wrap(~parameter, scales = "free_y")

ggsave("Boxplots_parameters_strategy.png", path = PATH,
       width = 20, height = 10, units = "cm", dpi=800, bg="white")
```



