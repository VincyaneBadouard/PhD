---
title: "Diagnose all"
date: "`r Sys.Date()`"
format: html
self-contained: true
theme: cosmo
editor: source
code-fold: true
---

*nosgeffect tau at 80% CI*

Changements figures :
Monoplot posterior :
- noms sp en y pas en x
- enlver les _ dans les noms d'sp
- noms d'sp en italique
- tau en lettre greque
- remplacer more/less flood tolerant par wetter, drier
- remplacé non-null effect par significiant

Biplot :
travailler les étiquettes pour que ttes les sp soient visibles

Biplot O-tau :
pas de couleur mais ajouter wetter, drier

```{r setup}
library(tidyverse)
library(cmdstanr)
library(bayesplot)
library(patchwork)
library(grid)
library(stringr)

sp <- read.csv("D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/InterestSpecies.csv")[,3] # 75
abund <- read_csv("D:/Mes Donnees/PhD/Inventories/Data/Adults_Understory/Paracou/Species_abundance_DBHclass_9ha.csv")
# mettre 2 pour treedatacor

# sp <- c("Licania_membranacea" , "Lecythis_persistens") # 4 forms
# , "Symphonia_sp.1", "Tachigali_melinonii",
#         "Iryanthera_hostmannii", "Tabernaemontana_macrocalyx", "Pouteria_singularis", "Ryania_speciosa"
# sp <- "Symphonia_sp.1"

strategy <- read_delim("~/PhD/Inventories/Data/Understory/Paracou/Species_strategy.csv") %>% 
  select(ScientificName, Strategy_VB, Q95, DBHmax) %>%
  rename(Strategy = Strategy_VB) %>% 
  unique()

H_allometry <- read_csv('D:/Mes Donnees/PhD/Inventories/Data/Height-Diameter/H_allometry_method.csv')


Inv <- read_csv("D:/Mes Donnees/PhD/Inventories/Data/Adults_Understory/Paracou/P16_2019_Paracou_InvandEnv.csv") %>% 
  filter(SubPlot %in% c(13,14,15,18,19,20,23,24,25)) %>% 
  # select(ScientificName, TreeHeight)
  group_by(ScientificName) %>% 
  summarise(TreeHeightQ95 = quantile(TreeHeight, 0.95, na.rm=T)) %>%
  ungroup() %>% 
  left_join(H_allometry, by='ScientificName') 



PATH <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Modelisation/Plots/Light_topo/Autocor"
```

# Fits
```{r fit}
fits <- list()
for(S in sp){
  tryCatch({
    chain_path <- file.path("Chains", "Hybrid_eigenvectors", S)
    fits[[S]] <- as_cmdstan_fit(list.files(chain_path,
                                           full.names = TRUE))},
    error=function(e){cat("ERROR :",S, conditionMessage(e), "\n")}
  )
}
# names(fits[["Symphonia_sp.1"]])
```

# Divergence
```{r divergence}
Div <- lapply(names(fits), function(x)
  data.frame(Species = x,
             Chain = c(1:4),
             Divergences = fits[[x]]$diagnostic_summary("divergences") # divergences per chain
  ) 
) %>% 
  bind_rows() %>% 
  rename(Divergences = num_divergent) %>% 
  group_by(Species) %>% 
  mutate(`%divergence` = sum(Divergences)/4000*100)

```

# Rhat
R-hat convergence diagnostic, which compares the between- and within-chain estimates for model parameters and other univariate quantities of interest. If chains have not mixed well (ie, the between- and within-chain estimates don't agree), R-hat is larger than 1.01 (Vehtari et al., 2021). 
R-hat which is the maximum of rank normalized split-R-hat and rank normalized folded-split-R-hat, which works for thick tailed distributions and is sensitive also to differences in scale.
```{r Rhat}
Rhat_table <- lapply(names(fits), function(x)
  fits[[x]]$summary() %>% # c("alpha", "beta1", "beta2_p", "tau")
    mutate(Species = x) %>% 
    select(Species, variable, rhat) 
) %>% 
  bind_rows()

# bayesplot::rhat(fits[[1]],pars="beta2_p")
# posterior::rhat(extract_variable_matrix(fits[[1]], "beta2_p"))

all(Rhat_table$rhat < 1.01) # TRUE

badRhat <- Rhat_table %>% filter(rhat > 1.01) %>% # 0
  left_join(Div %>% select(Species, `%divergence`) %>% unique(), by="Species")
```
# Chains
```{r chains}
name <- unique(badRhat$Species) # names(fits) #
lapply(name , function(x)
  fits[[x]]$draws(c("alpha", "beta1", "beta2_p", "tau", "psi")) %>% 
    mcmc_trace() +
    ggtitle(x)
)
```

```{r, eval =F}
# no light effect (flat) :
no_light_effect <- c("Iryanthera_sagotiana", "Symphonia_sp.1", "Inga_loubryana", "Virola_michelii", "Pouteria_guianensis", "Eschweilera_congestiflora", "Couratari_multiflora", "Tachigali_melinonii", "Pouteria_gonggrijpii", "Thyrsodium_puberulum", "Anacardium_spruceanum")

# a_Q95 > -0.07
# (a = 0 -> large niche)
```

# Prepare plots data
```{r}
# Plot data
datap <- lapply(names(fits), function(x)
  mcmc_intervals_data(fits[[x]]$draws(), # c("a", "O", "tau")
                      prob = 0.50, prob_outer = 0.80, point_est = "median") %>% 
    mutate(Species = x)
)  %>% 
  bind_rows() %>% 
  filter(parameter %in% c("a", "O", "tau"))

# Light effect (not flat)
O_sg <- datap %>% 
  # mutate(incertitude = hh-ll) %>% 
  # filter(parameter=="O"& incertitude > 4) %>%
  filter(parameter=="a"& m > -0.02) %>% # no light effect
  select(Species) %>% 
  mutate(parameter="O") %>% 
  mutate(Sg_effect = F)

datap <- datap %>%
  left_join(O_sg, by=c("Species", "parameter")) %>% 
  # tau significantly different of 0 if 0 in the Q50%
  mutate(Sg_effect = ifelse(parameter=="tau" & ll<0 & 0<hh, F, Sg_effect))  %>% 
  mutate(Sg_effect = ifelse(is.na(Sg_effect), T, Sg_effect))  %>%
  left_join(strategy, by = c("Species" = "ScientificName")) %>% 
  left_join(Inv, by = c("Species" = "ScientificName")) %>% 
  mutate(ScientificName = Species) %>% 
  mutate(Species = str_replace(Species, "_", " "))
# -a
# datap <- datap %>%
#   mutate_at(vars(c("ll", "l", "m", "h","hh")), ~ ifelse(parameter=="a", (-.), .))
# ll : outer start
# l : iner start
# m : point_est value
# h : iner end
# hh : outer end

# mcmc_intervals() code 
# trace(bayesplot::mcmc_intervals, edit=T)

# 0 line
x_lim <- range(c(datap$ll, datap$hh))
x_range <- diff(x_lim)
x_lim[1] <- x_lim[1] - 0.05 * x_range
x_lim[2] <- x_lim[2] + 0.05 * x_range

# 0 line
layer_vertical_line <- if (0 > x_lim[1] && 0 < x_lim[2]) {
  vline_0(color = "darkred", linewidth = 0.5, linetype = "dashed")
}

# min((datap %>% filter(Species %in% no_light_effect & parameter=='a'))$m) # min a median : -0.022
# range((datap %>% filter(Species %in% no_light_effect & parameter=='gamma'))$m) # -9.041810 -0.528554
# range((datap %>% filter(!Species %in% no_light_effect & parameter=='gamma'))$m) # -9.406300  1.133145

# range((datap %>% filter(Species %in% no_light_effect & parameter=='O') %>% mutate(incertitude = hh-ll))$incertitude) # O incertitude : 4.5-6.5

write_csv(datap, paste(PATH, "/dataplot.csv",sep=''))
```


# Predictions
```{r predictions}
Sys.time()

plist <- list()

for(s in names(fits)){
  plist[[s]] <- local({
    # s= "Lecythis_persistens"
    
    DATA <- fits[[s]]$summary("p") %>%  # p posterior
      # prediction environment 
      rowwise() %>% 
      mutate(Light = as.numeric(unlist(str_extract_all(variable, "\\d+"))[1])) %>% 
      mutate(Topo = as.numeric(unlist(str_extract_all(variable, "\\d+"))[2])) %>% 
      mutate(logTransmittance = seq(-8.208173, 1.07194e-09, length.out = 50)[Light]) # %>% 
    # mutate(logTWI = seq(1.358045, 2.400176, length.out = 50)[Topo]) # 1.358045 - 2.400176
    
    DATA %>% 
      group_by(Light) %>% 
      # At topo optimum (i.e. presence proba. max)
      filter(median==max(median)) %>% 
      ggplot(aes(x = logTransmittance)) +
      theme_minimal() +
      geom_point(aes(y = median), size=0.7) + # p posterior median
      geom_ribbon(aes(ymin = q5, ymax = q95), color = 'red', alpha = 0.2) + # P quantiles
      geom_vline(xintercept  = fits[[s]]$summary("O", median)$median, color = "#00AFBB", linewidth=1) + # Opt median
      geom_vline(xintercept  = fits[[s]]$summary("O")$q5, linetype="dashed") + # Opt Q5%
      geom_vline(xintercept  = fits[[s]]$summary("O")$q95, linetype="dashed") + # Opt Q95%
      # scale_x_continuous(trans="log") +
      scale_x_continuous(name = "Light (% transmittance)",
                         n.breaks = 10, labels = ~round(exp(.)*100,2)) + # delog
      ggtitle(paste(s,"- at logTWI optimum")) +
      ylab("Presence probabiblity median")
    
  })
}


plots <- gridExtra::marrangeGrob(plist, nrow = 3, ncol = 3) # 75
# plots

ggsave("Allsp_Light_niche_atTWIoptimum.pdf",
       path = PATH,
       plots, width = 15, height = 10)

Sys.time() # 32 min
```
