---
title: "Pedology analysis"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: pdf_document
---

Problematics:
- Les caractéristiques du sol sont-elles liées à la topographie ?
- variance inter habitat plus forte qu'inter habitat ?
- La granulométrie estimée sur le terrain coincide-t-elle avec la granulométrie mesurée en labo ?
- La composition chimique des sols est-elle liée à la granulométrie ? à la topographie ?
- y a t-il une variation significative du contenu en P entre classe topographique


# Packages
```{r, include = F}
library(readr)
library(tidyverse)
library(corrplot)
library(RColorBrewer)
library(soiltexture)
```

# Import data
```{r}
# Labo data
Labo_data <- read_delim("~/PhD/Pédologie/Data/Raw/Analyses_sol_labo.csv", 
                        delim = ";", escape_double = FALSE, trim_ws = TRUE) # 27 col

# Quali data
Chimie <- read_csv("~/PhD/Pédologie/Data/Raw/Chimie.csv")

RU <- read_csv("~/PhD/Pédologie/Data/Raw/RU.csv")

Bulk_density <- read_csv("~/PhD/Pédologie/Data/Raw/Bulk_density.csv")

Drainage <- read_csv("~/PhD/Pédologie/Data/Raw/Drainage.csv")
```

# Join data
```{r}
Labo_data <- Labo_data %>%
  rename("Sample ID" = 'Code Echantillon') %>%
  left_join(Chimie, by = "Sample ID") %>%
  left_join(RU, by = "Sample ID") # 59 col

names(Labo_data)
# "Site", "Topography type", "Fresh weight", "Organic air dried weight", "Coarse elements air dried weight", "Air-dried fine soil weight.x", "Fine soil dry weight.x", "Labo weight.x"

Labo_data <- Labo_data %>%
  mutate( # 8 cols
    Site = coalesce(Site.x, Site.y),
    Topography = coalesce(`Topography type.x` , `Topography type.y`),
    Fresh_weight = coalesce(`Fresh weight.x`, `Fresh weight.y`),
    Organic_airdried_weight = coalesce(`Organic air dried weight.x`, `Organic air dried weight.y`),
    Coarse_elements_airdried_weight = coalesce(`Coarse elements air dried weight.x`, `Coarse elements air dried weight.y`),
    Airdried_fine_soil_weight = coalesce(`Air-dried fine soil weight.x`, `Air-dried fine soil weight.y`),
    Fine_soil_dry_weight = coalesce(`Fine soil dry weight.x`, `Fine soil dry weight.y`),
    Labo_weight = coalesce(`Labo weight.x`, `Labo weight.y`)) %>%
  select(-(contains(".x") | contains(".y"))) # 51 col

```

LD : limite de détection
Par définition, un résultat inférieur à la LD est trop faible pour pouvoir être interprété.
```{r}
Labo_data$`TS %` <- gsub("[[:punct:]]", "", Labo_data$`TS %`)

Labo_data[sapply(Labo_data, grepl, pattern = 'LD')] <- "0"
Labo_data[,3:27] <- lapply(Labo_data[,3:27], as.numeric)

NA_table <- Labo_data[rowSums(is.na(Labo_data[, 1:27])) > 0, 1:27] # NA only in granulo

```

# Decompose Sample ID
site-analyse-topo-sample-horizon
```{r}
Labo_data <- Labo_data %>% 
  mutate(`Sample ID` = ifelse(is.na(`Horizon thickness (cm)`),
                              paste0(`Sample ID`, '-H1'), `Sample ID`),
         Sample = transpose(strsplit(`Sample ID`, split = "-"))[[4]], # 4th elmt  
         Horizon = transpose(strsplit(`Sample ID`, split = "-"))[[5]] # 5th 
  )
```


# Create tripartite texture
```{r}
Labo_data <- Labo_data %>% 
  mutate(`Sand %` = `Sables fins %` + `Sables grossiers %`,
         `Silt %` = `Limons fins %` + `Limons grossiers %`,
         `Clay %` = `Argiles %`,
         `Coarse elements %` = (
           Coarse_elements_airdried_weight/(Fine_soil_dry_weight + Coarse_elements_airdried_weight)
         )*100
  )

# Texture selon triangle de Jamagne 1977 (Texture_Jamagne):
source("D:/Mes Donnees/PhD/R_codes/PhD/Pedology/get_soil_texture.R")
Labo_data <- get_soil_texture(Labo_data, Available_Water = T)
```

# Plot texture triangle (pas réussi)
```{r}
txturedata <- Labo_data %>% 
  mutate(SAND = round(Labo_data$`Sand %`),
         SILT = round(Labo_data$`Silt %`),
         CLAY = round(Labo_data$`Clay %`)) %>% 
  as.data.frame() %>% 
  TT.normalise.sum() %>% # Normalises the sum of the 3 particle size classes
  bind_cols(Labo_data)

library(plotrix) # for soil texture plot

soil.texture(Labo_data[,50:52],
             main = "Soil textures - Paracou & Nouragues",    # title
             col.symbols=1:8,
             bg.symbols=1:8,
             point.labels=Labo_data$Topography,
             pch=21)
legend(x=1, 
       legend=Labo_data$Topography,
       col=1:8, 
       fill=1:8)

TT.plot(
  main = "Soil textures - Paracou & Nouragues",    # title
  class.sys = "FR.AISNE.TT",    # use the texture triangle of the package
  tri.data = txturedata,          # data
  tri.sum.tst = F,            # do not test for exact sum(sand, silt, clay) == 100
  z.name      = "Topography", 
  cex.lab = 0.75,                 # scaling of label text
  cex.axis = 0.75,                # scaling of axis
  cex = 0.5,                      # scaling of point symbols
  col = alpha('royalblue', 0.5),  # color of point symbols, with 50% transparency
  frame.bg.col = 'white',         # background color
  class.lab.col = 'black',        # color for texture class labels
  lwd.axis=2                   # line thickness for axis
)
TT <- soiltexture::TT.plot(
  class.sys = "USDA-NCSS.TT",    # use "our" texture triangle
  main = 'Loafercreek\nall horizons',          # title
  tri.sum.tst = FALSE,            # do not test for exact sum(sand, silt, clay) == 100
  cex.lab = 0.75,                 # scaling of label text
  cex.axis = 0.75,                # scaling of axis
  frame.bg.col = 'white',         # background color
  class.lab.col = 'black',        # color for texture class labels
  lwd.axis = 1.5,
  lwd.lab = 2,
  arrows.show=TRUE
)

# add data
# screen coordinates are available for later use
TT.points(tri.data = txturedata, geo = TT, tri.sum.tst = FALSE, cex=0.5, col=alpha('royalblue', 0.5))
```

# Compute Available Water Capacity (AWC) (Reserve en eau utile)
```{r}
# Compute Available_Water (ml) for the sample mass
Labo_data <- Labo_data %>%
  mutate(`Available_Water (ml)` =
           (`Available_Water (ml/100g)`/100)*(Fine_soil_dry_weight + Coarse_elements_airdried_weight)
  )

# Compute AWC by horizon then for the core
Labo_data <- Labo_data %>% 
  mutate(AWC_by_H = round(`Horizon thickness (cm)` * (`Available_Water (ml)` / `Horizon thickness (cm)`)  * (1-(`Coarse elements %`/100)),2)
         # ou
         # AWC_by_H = `Available_Water (ml)` * "densité apparente" * (`Coarse elements %`)/100
  ) %>% 
  group_by(Site,Topography, Sample) %>% 
  mutate(AWC = sum(na.omit(AWC_by_H))) %>% # na.omit pour ne pas considérer les échantillons CH
  ungroup() %>% 
  mutate(AWC = ifelse(is.na(AWC_by_H), NA, AWC))

```

```{r}
write.csv(Labo_data, "~/PhD/Pédologie/Data/Labo_data_binded.csv")
```


# Correlations
## Tous sites
```{r}
DF_cor <- Labo_data %>% 
  filter(grepl(pattern = 'CH', Labo_data$`Sample ID`)) %>%
  mutate(Topography = as.numeric(factor(Topography, levels = c("Bottomland", "Lower slope", "Mid slope", "Upper slope", "Plateau")))) %>% 
  mutate(Site = as.numeric(factor(Site, levels = c("Nouragues", "Paracou"))))

DF_cor <- DF_cor[,colSums(is.na(DF_cor))==0] # remove column with only NA

DF_cor <- DF_cor[,-(31:35)] # remove useless colomn

DF_CH_cor <- DF_cor %>% select(- c(`N° Labo`, `Sample ID`, TreeNum1))
# DF_CH_cor <- DF_CH_cor[,colSums(DF_CH_cor)>0] # remove column with only 0


CorMatrixS <- Hmisc::rcorr(as.matrix(DF_CH_cor))
CorMatrix <- round(CorMatrixS$r, digits = 2)  # matrice de corrélation
Pval_corr <- CorMatrixS$P # p-values

# Plot de la matrice de corrélation :
png("D:/Mes Donnees/PhD/Figures/Corplot_pedo_chimie.png", width = 900, height = 800)
corrplot(CorMatrix, method="circle", type="lower",
         col=brewer.pal(n=8, name="PuOr"), tl.col="black", tl.cex = 1, tl.srt=45)
dev.off()

```
- Site - C org - argiles - sables fins - sables grossiers - P total
- Topo : faible

Trés corrélé positivement :
- C org - MO - N
- Sables fins - C org/N
- Al - N
- cations - N - argiles - Al - CEC
- CEC - N - argiles - Al - cations
- P olsen - P Bray I (pas avec P total)
- P total - N - argiles - Al - cations - CEC

Trés corrélé négativement :
- argiles - C org
- sables - argiles
- sables - (cations - CEC - Al - P total)

## Paracou
```{r}
DF_P_CH_cor <- DF_cor %>% 
  filter(grepl(pattern = 'P-CH', DF_cor$`Sample ID`)) %>%
  select(- c(`N° Labo`, `Sample ID`, TreeNum1, Site))
# DF_P_CH_cor <- DF_P_CH_cor[,colSums(DF_P_CH_cor)>0] # remove column with only 0


CorMatrixS <- Hmisc::rcorr(as.matrix(DF_P_CH_cor))
CorMatrix <- round(CorMatrixS$r, digits = 2)  # matrice de corrélation
Pval_corr <- CorMatrixS$P # p-values

# Plot de la matrice de corrélation :
png("D:/Mes Donnees/PhD/Figures/Corplot_pedo_chimie_Paracou.png", width = 900, height = 800)
corrplot(CorMatrix, method="circle", type="lower",
         col=brewer.pal(n=8, name="PuOr"), tl.col="black", tl.cex = 1, tl.srt=45)
dev.off()
```
Topography corrélations négatives avec : Ca, Na, et P Olsen, Bray I et P total !
positives : Mg
## Nouragues
```{r}
DF_N_CH_cor <- DF_cor %>% 
  filter(grepl(pattern = 'N-CH', DF_cor$`Sample ID`)) %>%
  select(- c(`N° Labo`, `Sample ID`, TreeNum1, Site))
# DF_N_CH_cor <- DF_N_CH_cor[,colSums(DF_N_CH_cor)>0] # remove column with only 0


CorMatrixS <- Hmisc::rcorr(as.matrix(DF_N_CH_cor))
CorMatrix <- round(CorMatrixS$r, digits = 2)  # matrice de corrélation
Pval_corr <- CorMatrixS$P # p-values

# Plot de la matrice de corrélation :
png("D:/Mes Donnees/PhD/Figures/Corplot_pedo_chimie_Nouragues.png", width = 900, height = 800)

corrplot(CorMatrix, method="circle", type="lower",
         col=brewer.pal(n=8, name="PuOr"), tl.col="black", tl.cex = 1, tl.srt=45)
dev.off()
```
Topography corrélations positives avec :
aluminium, cations, CEC, P total, MO, C org, N, Argiles

Topography corrélations négatives avec :
sables fins et grossiers, Mn, pH, Ca, K

Les P assimilables Olsen et Bray I n'ont pas été détectés dans les échantillons des Nouragues.
