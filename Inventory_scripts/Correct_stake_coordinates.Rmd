---
title: "Correct stake and trees coordinates"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: html_document
---

1) Faire une carte des piquets tels que placés réellement
 - Faire la moyenne de X et X2 , et la moyenne de Y et Y2 qui devraient être égaux mais qui à la re-mesure ne donne pas exactement la même valeur.
 - Les coordonnées x des piquets se calculent en ajoutant la moyenne X-X2 de chaque cadrat à la valeur x du quadrat précédent, en commençant de x = 0. Cela pour chaque quadrat Y. (d’ouest en est et du sud vers le nord, ligne par ligne)
 - Les coordonnées y des piquets se calculent en ajoutant la moyenne Y-Y2 de chaque cadrat à la valeur y du quadrat précédent, en commençant de y = 0. Cela pour chaque quadrat X. (du sud vers le nord et d’ouest en est, colonne par colonne)


2) Faire une carte de leur position théorique :  piquets espacés de 10x10

# Packages
```{r, include = F}
library(readr)
library(tidyverse)
```

# Import data
Site : Paracou - P16
Subplots :
- 13, 18, 23, 24 : oui
- 14-15-19-20 : pas encore 

```{r}
Piquets_Paracou <- read_delim("~/PhD/Inventories/Data/Piquets_ALT/Measures_piquets_Paracou.csv", 
                              delim = ";", escape_double = FALSE, trim_ws = TRUE)
View(Piquets_Paracou)
names(Piquets_Paracou) # "plot" "quadra.nb.X" "quadra.nb.Y" "q.length.X"  "q.length.X2" "q.length.Y"  "q.length.Y2"
summary(Piquets_Paracou) # Min q.length.X : 1.0
Piquets_Paracou <- Piquets_Paracou[complete.cases(Piquets_Paracou),] # enlever les lignes à NA
original <- Piquets_Paracou
```
"plot" : numéro du subplot  
"quadra.nb.X" : number of column where the 10m x 10m quadrat is placed (0 - 9. 0 = sud; 9 = north).  
"quadra.nb.Y" : number of row where the 10m x 10m quadrat is placed (0 - 9. 0 = west; 9 = east).  
"q.length.X" : size of the southern side of the 10m x 10m quadrat (m).  
"q.length.X2" : size of the northern side of the 10m x 10m quadrat (m).  
"q.length.Y" : size of the western side of the 10m x 10m quadrat (m).  
"q.length.Y2" : size of the eastern side of the 10m x 10m quadrat (m).  

# Real place

## Ajouter les lignes et colonnes manquantes pour les coordonnées des piquets
```{r}
nrow(Piquets_Paracou[Piquets_Paracou$quadra.nb.X==9,]) # 40
nrow(Piquets_Paracou[Piquets_Paracou$quadra.nb.Y==9,]) # 40
# 4 plots
Supp_rowsX <- data.frame(plot = rep(c(13, 18, 23, 24), times = 11),
                         quadra.nb.X = rep(10, times = 11),
                         quadra.nb.Y = rep(c(0:10), times = 4),
                         q.length.X = rep(NA, times = 11),
                         q.length.X2 = rep(NA, times = 11),
                         q.length.Y = rep(NA, times = 11),
                         q.length.Y2 = rep(NA, times = 11))

Supp_rowsY <- data.frame(plot = rep(c(13, 18, 23, 24), times = 11),
                         quadra.nb.X = rep(c(0:10), times = 4),
                         quadra.nb.Y = rep(10, times = 11),
                         q.length.X = rep(NA, times = 11),
                         q.length.X2 = rep(NA, times = 11),
                         q.length.Y = rep(NA, times = 11),
                         q.length.Y2 = rep(NA, times = 11))

Supp_rows <- unique(rbind(Supp_rowsX, Supp_rowsY))

Piquets_Paracou <- Piquets_Paracou %>% 
  rbind(Supp_rows) %>% 
  arrange(quadra.nb.Y) %>% 
  arrange(quadra.nb.X) %>% 
  arrange(plot) %>% 
  mutate(X = NA) %>% 
  mutate(Y = NA) 

```

## Ajouter les lignes et colonnes manquantes pour les coordonnées des piquets
```{r}
plots <- unique(Piquets_Paracou$plot)

for(p in plots){
  # for quadra Y = 10
  Piquets_Paracou[Piquets_Paracou$plot==p &
                    Piquets_Paracou$quadra.nb.Y == 10,]$q.length.X <- Piquets_Paracou[Piquets_Paracou$plot==p & Piquets_Paracou$quadra.nb.Y == 9,]$q.length.X2
  
  # For quadra X = 10
  Piquets_Paracou[Piquets_Paracou$plot==p &
                    Piquets_Paracou$quadra.nb.X == 10,]$q.length.Y <- Piquets_Paracou[Piquets_Paracou$plot==p & Piquets_Paracou$quadra.nb.X == 9,]$q.length.Y2
}
```

## Moyenne X-X2 et Y-Y2 (A FAIRE)
- Faire la moyenne de X et X2 , et la moyenne de Y et Y2 qui devraient être égaux mais qui à la re-mesure ne donne pas exactement la même valeur.
```{r}

```


## Data filling
 - Les coordonnées y des piquets se calculent en ajoutant la moyenne Y-Y2 de chaque cadrat à la valeur y du quadrat précédent, en commençant de y = 0. Cela pour chaque quadrat X. (du sud vers le nord et d’ouest en est, colonne par colonne)
```{r}
# Remplir Y pour tous les X

for(p in plots){ # for each plot
  for (x in 0:10){ # for each X

    Y <- c(0, rep(NA, 10))
    
    Y_length <- Piquets_Paracou[Piquets_Paracou$plot==p &
                                  Piquets_Paracou$quadra.nb.X == x,]$q.length.Y
    Y_length <- Y_length[-length(Y_length)]
    
    for(i in 1:10){ # for each subplot
      Y[i+1] = Y[i] + Y_length[i]
    }    
    
    # Y_length
    # Y
    
    Piquets_Paracou[Piquets_Paracou$plot==p &
                      Piquets_Paracou$quadra.nb.X == x,]$Y <- Y
  }
}
```
 - Les coordonnées x des piquets se calculent en ajoutant la moyenne X-X2 de chaque cadrat à la valeur x du quadrat précédent, en commençant de x = 0. Cela pour chaque quadrat Y. (d’ouest en est et du sud vers le nord, ligne par ligne)  

```{r}
# Remplir X pour tous les Y

for(p in plots){ # for each plot
  for (y in 0:10){ # for each Y
    X <- c(0, rep(NA, 10))
    
    X_length <- Piquets_Paracou[Piquets_Paracou$plot==p &
                                  Piquets_Paracou$quadra.nb.Y == y,]$q.length.X
    X_length <- X_length[-length(X_length)]
    
    for(i in 1:10){ # for each subplot
      X[i+1] = X[i] + X_length[i]
    }    
    
    Piquets_Paracou[Piquets_Paracou$plot==p &
                      Piquets_Paracou$quadra.nb.Y == y,]$X <- X
  }
}
```

## Plot
```{r}
ggplot(Piquets_Paracou) +
  aes(x = X, y = Y) +
  geom_point(shape = "circle", size = 1.5, colour = "#112446") +
  theme_minimal() +
  facet_wrap(vars(plot))
```

```{r}
write.csv(Piquets_Paracou, "~/PhD/Inventories/Data/Piquets_ALT/XY_Stakes_Paracou.csv") # à mettre en vraies coordonnées UTM
```

# Put in reel UTM coordinates 
Subplots :
- 13, 18, 23, 24 : oui
- 14-15-19-20 : pas encore 
```{r}

```

# Theoric place
piquets espacés de 10x10  
## Data filling
```{r}
Piquets_theor <- Piquets_Paracou %>% 
  select(plot, quadra.nb.X, quadra.nb.Y) %>% 
  mutate(X = NA) %>% 
  mutate(Y = NA)

# Remplir Y pour tous les X

for(p in plots){ # for each plot
  for (x in 0:10){ # for each X

    Y <- c(0, rep(NA, 10))
    
    Y_length <- rep(10, 10) # 10 m
    
    for(i in 1:10){ # for each subplot
      Y[i+1] = Y[i] + Y_length[i]
    }    
    
    # Y_length
    # Y
    
    Piquets_theor[Piquets_theor$plot==p &
                    Piquets_theor$quadra.nb.X == x,]$Y <- Y
  }
}
```

```{r}
# Remplir X pour tous les Y

for(p in plots){ # for each plot
  for (y in 0:10){ # for each Y
    X <- c(0, rep(NA, 10))
    
    X_length <- rep(10, 10)  # 10 m
    
    for(i in 1:10){ # for each subplot
      X[i+1] = X[i] + X_length[i]
    }    
    
    Piquets_theor[Piquets_theor$plot==p &
                    Piquets_theor$quadra.nb.Y == y,]$X <- X
  }
}
```

## Plot
```{r}
ggplot(Piquets_theor) +
  aes(x = X, y = Y) +
  geom_point(shape = "circle", size = 1.5, colour = "#112446") +
  theme_minimal() +
  facet_wrap(vars(plot))
```

## Plot both
```{r}
ggplot(Piquets_Paracou) +
  aes(x = X, y = Y, colour = quadra.nb.X) +
  geom_point(shape = "circle", size = 1.5,
             aes(colour = "Reality")) +
  theme_minimal() +
  facet_wrap(vars(plot)) +
  geom_point(data = Piquets_theor, aes(x = X, y = Y, colour = "Expectation"), shape = "circle", size = 1.5) +
  theme_minimal() +
  facet_wrap(vars(plot)) +
  scale_colour_manual(values = c("Reality" = "red",
                                 "Expectation" = "darkgrey"),
                      breaks=c("Reality", "Expectation")) +
  labs(color = "Stakes position")
```

```{r}
ggplot(Piquets_Paracou) +
  aes(x = X, y = Y, colour = as.character(quadra.nb.X)) +
  geom_point(shape = "circle", size = 1.5) +
  theme_minimal() +
  facet_wrap(vars(plot)) +
  geom_point(data = Piquets_theor, shape = "circle", size = 1.5) +
  theme_minimal() +
  facet_wrap(vars(plot)) +
  scale_fill_brewer(palette = "Blues") +
  # scale_colour_manual(breaks=c(as.character(0:10))) +
  labs(color = "Quadra number")
```

# Correction des coordonnées des arbres (A FAIRE)
1) Les 4 coins du carré de 1 ha on été géoréférencés en 2023 par des géomètres.  
Nous les prendrons comme référence en projetant les piquets de manière à ce que les 4 coins du carré de 1 ha soient bien représentés (100x100m) (= que le point rouge se superpose au point gris)  
Méthode à chercher : interpolation polynomiale de degré 2 (voir gdalwarp), sur qgis ou R  

Après avoir reprojeté les piquets selon ces bornes, on obtient les coordonnées corrigées de chaque piquet  

2) et on recalcule les coordonnées des arbres relatives au coin Sud-Ouest corrigé de chaque quadrat.  


Subsistera l’erreur de mesure des distances.  

## Reprojection des piquets selon les coins du carré
**"warping"**
### Importer les points géomètre
```{r}
Paracou_P16_9ha_coord_Subplot <- read.table("~/PhD/SIG_data/Understory-ALT/Geometre_2024/Sy23179-Paracou_P16_9ha_coord_Subplot.txt", quote="\"", comment.char="") # UTM 22 N

Paracou_P16_9ha_coord_Subplot <- Paracou_P16_9ha_coord_Subplot %>% 
  rename(ID = V1) %>% 
  rename(Xutm = V2) %>%
  rename(Yutm = V3) %>%
  rename(Zutm = V4)

P16shp <- st_as_sf(vect("D:/Mes Donnees/PhD/R_codes/PhD/test/Plot16.shp"))
SubplotCoordsf <- st_as_sf(Paracou_P16_9ha_coord_Subplot, coords = c('Xutm','Yutm'))
SubplotCoordsf <- st_set_crs(SubplotCoordsf, crs(P16shp))

ggplot() +
  geom_sf(data = sf::st_cast(P16shp, "LINESTRING")) +
  geom_sf(data = SubplotCoordsf, col = "red", size = 2) +
  ggtitle("Paracou P16 9ha - Geometre points")

ggsave("Paracou_P16_9ha_Geometre_points.png",
         path = "D:/Mes Donnees/PhD/Figures/inventory",
         width = 15, height = 15, units = "cm", dpi=800, bg="white")
```

### Reprojection des piquets
'gdalwarp' function is part of the Geospatial Data Abstraction Library (GDAL).

Resampling_methods available:
- near: nearest neighbour resampling (default, fastest algorithm, worst interpolation quality).
- average: average resampling, computes the average of all non-NODATA contributing pixels. (GDAL >= 1.10.0)
- interpolation polynomiale de degré 2

```{r}
library(sf)
library(stars)

ALT <- read.csv("D:/Mes Donnees/PhD/SIG_data/Understory-ALT/ALT_stakes_theoretical_UTM.csv")
P16shp <- st_as_sf(vect("D:/Mes Donnees/PhD/R_codes/PhD/test/Plot16.shp"))
ALT <- st_as_sf(ALT, coords = c('Xutm','Yutm'))
ALT <- st_set_crs(ALT, crs(P16shp))

ALTstars <- st_rasterize(ALT %>% dplyr::select(geometry))
geometreStars <- st_rasterize(SubplotCoordsf %>% dplyr::select(geometry))

plot(ALTstars)
plot(geometreStars)

rm(warp)
warp <- st_warp(ALTstars, # to warp
                geometreStars, # target 
        method = "average", use_gdal=TRUE)

ggplot() +
  geom_sf(data = st_as_sf(warp,as_points = T), col="green", size = 1) +
  geom_sf(data = SubplotCoordsf, col="darkgreen", size = 0.8) +
  ggtitle("Warping")

```


## Correction des coordonées des arbres selon les piquets S-O corrigés
```{r}

```

