---
title: "Theoretical_coordinates_P16"
author: "Vincyane"
date: "`r Sys.Date()`"
output: html_document
---
P16 : 25 ha
Coordonnées SO de la P16: (0;0)

```{r Setup, include = F}
library(tidyverse)
library(sf)
library(terra)
library(data.table)
library(tidyterra)

```

# Subplots grid for 25 ha
```{r}
grid <- data.frame(expand.grid(
  x = seq(0,500, by= 100),
  y = seq(0,500, by= 100)
)
)
ggplot() +
  geom_point(data=grid, aes(x = x, y = y)) + # il faut mettre l'argument data sinon ça ne marche pas
  coord_fixed(ratio=1) # same axis size
```
# ALT (9ha) stakes grid
```{r}
ALT <- data.frame(expand.grid(
  x = seq(200,500, by= 10),
  y = seq(0,300, by= 10)
)
)
ggplot() +
  geom_point(data=ALT, aes(x = x, y = y)) + # il faut mettre l'argument data sinon ça ne marche pas
  geom_point(data=grid, aes(x = x, y = y), col="red") +
  coord_fixed(ratio=1) # same axis size
```

# Understory (4ha) stakes grid
```{r}
Und <- data.frame(expand.grid(
  x = seq(300,500, by= 10),
  y = seq(100,300, by= 10)
)
)
ggplot() +
  geom_point(data=Und, aes(x = x, y = y)) + # il faut mettre l'argument data sinon ça ne marche pas
  geom_point(data=grid, aes(x = x, y = y), col="red") +
  coord_fixed(ratio=1) # same axis size
```


# LAI200 sensors theorical coordinates
- transect HOBO : 20 points espacés de *10m* : start =(390;110)  ; end = (390;300)
- transect layon : 26 points espacés de *2m* : start = (350;200) ; end = (400; 200)
```{r}
LAI2200_HOBO <- data.frame(
  Sensor = "LAI2200",
  Transect = "HOBO",
  Id = as.character(seq(1,20)), # S->N
  x = 390,
  y = seq(110,300, by= 10)
)
nrow(LAI2200_HOBO)==20

LAI2200_LAY <- data.frame(
  Sensor = "LAI2200",
  Transect = "LAY",
  Id = as.character(rev(seq(1,26))), # E->O
  x = seq(350,400, by= 2),
  y = 200
)
nrow(LAI2200_LAY)==26

LAI2200 <- rbind(LAI2200_HOBO, LAI2200_LAY)

library(ggrepel)
ggplot() +
  geom_point(data=grid, aes(x = x, y = y)) + # il faut mettre l'argument data sinon ça ne marche pas
  geom_point(data=LAI2200_HOBO, aes(x = x, y = y), color = "red", size = 1)+
  geom_text_repel(data = LAI2200_HOBO, aes(x = x, y = y, label = Id), color = "black", size = 2) +
  geom_point(data=LAI2200_LAY, aes(x = x, y = y), color = "green", size = 0.3)+
  # geom_text_repel(data = LAI2200_LAY, aes(x = x, y = y, label = Id), color = "black", size = 2) +
  coord_fixed(ratio=1) + # same axis size
  ggtitle("LAI2200 sensor theoretical coordinates")

ggsave("Paracou_P16_LAI2200_sensor_theoretical_positions.png",
       path = "D:/Mes Donnees/PhD/Figures/Sensors",
       width = 15, height = 15, units = "cm", dpi=800, bg="white")
```
# Tomst sensors theorical coordinates
- transect Jérome : 22 (20 HOBO) capteurs espacés de *10m* : start =(390;110)  ; end = (390;300)
- transect BF : 5 capteurs espacés de *10m* : x = seq(440,470, by= 10) ; y = 260 pour le 1er, y = 270 pour les autres
- transect gap : 5 capteurs espacés de *10m* : y = 0 pour le 1er, 10 pour les autres ; x =  seq(240,270, by= 10)

```{r}
Tomst_jerome <- data.frame(
  Sensor = "Tomst",
  Transect = "Jerome",
  Id = as.character(rev(seq(1,22))), # S->N
  x = 390,
  y = seq(90,300, by= 10) # HOBO : seq(110,300, by= 10)
)
nrow(Tomst_jerome)==22

Tomst_BF <- data.frame(
  Sensor = "Tomst",
  Transect = "BF",
  Id = as.character(seq(23,27)), # entrée Sud, virage à l'Est
  x = c(440, seq(440,470, by= 10)),
  y = c(260, rep(270, 4))
)
nrow(Tomst_BF)==5

Tomst_gap <- data.frame(
  Sensor = "Tomst",
  Transect = "Gap",
  Id = as.character(seq(28,32)), # entrée Sud, virage à l'Ouest
  y = c(0, rep(10, 4)),
  x = c(270, rev(seq(240,270, by= 10)))
)
nrow(Tomst_gap)==5

Tomst <- rbind(Tomst_jerome, Tomst_BF, Tomst_gap) ; nrow(Tomst)==32

library(ggrepel)
ggplot() +
  geom_point(data=ALT, aes(x = x, y = y), color = "darkgrey",  size = 0.3) +
  geom_point(data=grid, aes(x = x, y = y)) + # il faut mettre l'argument data sinon ça ne marche pas
  
  geom_point(data=Tomst_jerome, aes(x = x, y = y), color = "red", size = 1)+
  geom_text_repel(data = Tomst_jerome, aes(x = x, y = y, label = Id), color = "black", size = 2.5) +
  
  geom_point(data=Tomst_BF, aes(x = x, y = y), color = "blue", size = 1)+
  geom_text_repel(data = Tomst_BF, aes(x = x, y = y, label = Id), color = "black", size = 2.5) +
  
  geom_point(data=Tomst_gap, aes(x = x, y = y), color = "orange", size = 1)+
  geom_text_repel(data = Tomst_gap, aes(x = x, y = y, label = Id), color = "black", size = 2.5) +
  
  coord_fixed(ratio=1) + # same axis size
  ggtitle("Tomst sensors theoretical coordinates")

ggsave("Paracou_P16_Tomst_sensors_theoretical_positions.png",
       path = "D:/Mes Donnees/PhD/Figures/Sensors",
       width = 15, height = 15, units = "cm", dpi=800, bg="white")
```


# Coordinates in UTM 
P16 (x;y) :
NO	(285056;581678)
NE (285536;581821)
SE (285680; 581343)
SO (285201; 581199)

```{r}
data <- LAI2200 # Tomst # LAI2200 # grid # ALT # Und

tab <- read_delim("D:/Mes Donnees/PhD/R_codes/PhD/local2UTM/CoordCoinsP1_16.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)

P=16 # Plot 16
limx = 500 # à changer pour la parcelle concernée
limy = 500 # à changer pour la parcelle concernée

dataUTM <- data %>% 
  mutate(Xutm = (1-x/limx)*(1-y/limy)*tab[P,]$`so x`+(x/limx)*(1-y/limy)*tab[P,]$`se x`+(y/limy)*(1-x/limx)*tab[P,]$`no x`+((x*y)/(limx*limy))*tab[P,]$`ne x`) %>% 
  mutate(Yutm = (1-x/limx)*(1-y/limy)*tab[P,]$`so y`+(x/limx)*(1-y/limy)*tab[P,]$`se y`+(y/limy)*(1-x/limx)*tab[P,]$`no y`+((x*y)/(limx*limy))*tab[P,]$`ne y`)

P16shp <- st_as_sf(vect("D:/Mes Donnees/PhD/R_codes/PhD/test/Plot16.shp"))

P16shp <- st_as_sf(vect("D:/Mes Donnees/PhD/SIG_data/Understory-ALT/Parcelles_Understory.shp"))
CHM <- terra::rast("D:/Mes Donnees/PhD/Lidar/ALS2023/Rasters/Paracou_P16_2023_4ha_ALS_CHM.tif")

ggplot() +
  geom_spatraster(data = CHM, aes(fill = Z)) +
  # scale_fill_gradientn(name = "Elevation (m)",
  #                      colors = terrain.colors(30, rev=T),
  #                      na.value="white") +
  scale_fill_gradientn(name = "Canopy height (m)",
                       colors = height.colors(25), na.value="white") +
  geom_sf(data = sf::st_cast(P16shp, "LINESTRING"), col = "white") +
  geom_sf(data = dataUTMsf, col = "black", size = 0.5) +
  theme_classic() +
  ggtitle("Paracou P16 - sensors positions")

ggsave("Paracou_P16_sensors_theoretical_UTM_positions_onCHM.png",
       path = "D:/Mes Donnees/PhD/Figures/Sensors",
       width = 15, height = 15, units = "cm", dpi=800, bg="white")

# write.csv(dataUTM, "D:/Mes Donnees/PhD/SIG_data/Understory/ALT_stakes_theoretical_UTM.csv")
# write.csv(dataUTM, "D:/Mes Donnees/PhD/SIG_data/Understory/Understory_stakes_theoretical_UTM.csv")
# write.csv(LAI2200UTM, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LAI2200_theoretical_UTM.csv")
# write.csv(dataUTM, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Tomst_theoretical_UTM.csv")
```

```{r}
MNT_ALT <- terra::rast("D:/Mes Donnees/PhD/R_codes/PhD/test/Paracou_ALT_mnt.tif")
ALT_stakes <- read.csv("D:/Mes Donnees/PhD/SIG_data/Understory/ALT_stakes_theoretical_UTM.csv")

ggplot() + 
  geom_spatraster(data = MNT_ALT, aes(fill = Z)) +
  scale_fill_gradientn(name = "Elevation (m)",
                       colors = terrain.colors(30, rev=T),
                       na.value="white") +
  geom_sf(data = sf::st_cast(P16shp, "LINESTRING")) +
  geom_point(data = ALT_stakes, size = 0.5,
             aes(Xutm, Yutm)) +
  theme_classic() +
  ggtitle("Paracou P16 4ha - ALS Low Altitude - Light map 1m") +  
  coord_sf()
```

# Extract Z coord MNT to Points
```{r}
MNT <- terra::rast(
  # "//amap-data.cirad.fr/safe/lidar/ALS/Paracou/2023/rasters/PARACOU2023_DTM_1m.tif" # MNT
  # "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/dtm2023_4ha_HighAlt_buffer.asc"
  # "//amap-data.cirad.fr/work/users/VincyaneBadouard/DZ_test/MNT/dtm2023_HighAlt_DZ_buffer.asc" # DZ
)

crs(MNT) <- crs(P16shp)

# dataUTMsf <- st_as_sf(data.frame(Xutm = c(286536.53, 286541.3), Yutm = c(582611.45, 582605.2)), coords = c('Xutm','Yutm')) # DZ

alt <- extract(MNT, dataUTMsf) %>% # extract z
  rename(Zutm = MNT_0.5m_IRD_500m_Paracou_284000_579500) %>% 
  # select(-ID) %>% 
  mutate(Zutm = Zutm +1) # 1 m above the ground

dataxyz <- dataUTM %>% cbind(alt)

# write.csv(LAI2200UTMxyz, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LAI2200_theoretical_UTMxyz.csv")
# write.csv(alt, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Tomst_theoretical_UTMxyz.csv")


generate_new_rows <- function(df, by = 1) {
  new_rows <- data.frame()
  for (i in 1:nrow(df)) {
    new <- data.frame( # pour chaque x;y créer 59 incrémentations de Zutm
      x = df[i, "x"],
      y = df[i, "y"],
      Xutm = df[i, "Xutm"],
      Yutm = df[i, "Yutm"],
      Zutm = seq(from = df[i, "Zutm"], to = (df[i, "Zutm"] + 59), by = by)
      # Zutm = df[i, "Zutm"]:(df[i, "Zutm"] + 59) # 
    )
    new_rows <- rbind(new_rows, new)
  }
  return(new_rows)
}
dataxyz <- generate_new_rows(dataxyz, by= 5) # 1

# write.csv(dataxyz, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Coordinates/Grid_4ha_10x10m_each5mZ_UTMxyz.csv")
# write.csv(dataxyz, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Grid_4ha_10x10m_each1mZ_UTMxyz.csv")
# write.csv(dataxyz, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Grid10x10m_each1mZ_UTMxyz.csv")
```

# Coordinates in local positions (use VOP)
```{r}
# path <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Grid_4ha_10x10m_each1mZ_UTMxyz.csv"
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LAI2200_theoretical_UTMxyz.csv"

dataxyz <- as.data.table(dataxyz)
# dataxyz <- as.data.table(read.csv(path))
VOP <- as.matrix(read.table("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/VOP_P16_9ha.txt"))

# matrix <- as.matrix(data.frame(Xutm = c(286536.53, 286541.3), Yutm = c(582611.45, 582605.2), c = 0, d = 1)) # DZ

matrix <- as.matrix(dataxyz[, `:=`(c = 0 , d = 1)][,.(Xutm, Yutm, c, d)]) # as matrix of the same dimensions, without Z

datalocal <- matrix %*% t(VOP) # same dimensions

datalocal <- cbind(datalocal,dataxyz[,Zutm])[, -c(3,4)] # add Zutm

# datalocal <- cbind(datalocal,data.frame(Zutm=39.3))[, -c(3,4)] # add DZ Zutm

ggplot() +
  geom_point(data=as.data.frame(datalocal), aes(x = V1, y = V2), col = "red", size = 0.3) 

write.csv(datalocal,
          # "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Coordinates/Grid_4ha_10x10m_each5mZ_local.csv"
          # "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Grid_4ha_10x10m_each1mZ_local.csv"
          # "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LAI2200_theoretical_local.csv"
          # "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Tomst_theoretical_local.csv"
          "//amap-data.cirad.fr/work/users/VincyaneBadouard/DZ_test/AMAPVox/DZ_centre_local.csv"
)

```

