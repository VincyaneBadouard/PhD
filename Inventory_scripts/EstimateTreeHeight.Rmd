---
title: "Estimate tree height"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: pdf_document
---

**PRENDRE DBHcor** !!!!


faire un mod√®le toutes esp√®ces confondues

# Packages
```{r Setup, include = F}
library(tidyverse)
library(data.table)
library(readr)
library(BIOMASS)
```

# Import cleaned inventory data
```{r,include = F, message=F}
Understory <- read_csv("~/PhD/Inventories/Data/Understory/Paracou/ALT_Paracou_9ha_CLEAN.csv")
```

# Import allometry data
```{r, include = F}
# Claudia's CanopyConstructor data (simulations average)
CC <- read_csv("~/PhD/Inventories/Data/Height-Diameter/CanopyConstructorDataP16.csv") %>% 
  select(DBH, Height, CrownRadius) %>% 
  mutate(HeightHow = "CanopyConstructor")

# Giacomo FTH data
FTH <- read_csv("~/PhD/Inventories/Data/Understory/Paracou/Allometry_FTH_GSellan_Paracou_20240125.csv") %>% 
  select(DBH, Htot, Hbranch, r1, r2, r3, r4) %>%
  rename(Height = Htot, CrownBase = Hbranch) %>% 
  mutate(HeightHow = "Trigonometry (FTH)") %>% 
  mutate(r2 = as.numeric((r2))) %>% 
  mutate(r4 = as.numeric((r4))) 


range(na.omit(FTH$DBH)) # 0.90 96.12959
# petits arbres mesur√©s, grands: mesure angle au clinom√®tre entre le haut et le bas de la plante -W trigonom√©trie

data <- CC %>%
  bind_rows(FTH) %>% 
  filter(!is.na(DBH)) %>% filter(!is.na(Height))
```

# Plot H-D data
```{r}
data %>%
  ggplot() +
  aes(x = DBH, y = Height, colour=HeightHow) +
  geom_point(shape = "circle", size = 0.2) + # , colour = "#440154"
  geom_smooth(span = 0.75, linewidth = 0.8) + # using method = 'gam' and formula 'y ~ s(x, bs = "cs")'
  theme_minimal() +
  labs(x ="DBH (cm)", y = "Height (m)", colour = "Method") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16),
        legend.position="bottom") 

ggsave("DBH_height_methods.png", path = "D:/Mes Donnees/PhD/Figures/inventory",
       width = 20, height = 20, units = "cm", dpi=800, bg="white")


data %>%
  ggplot() +
  aes(x = DBH, y = Height) +
  geom_point(shape = "circle", size = 0.2) + # , colour = "#440154"
  geom_smooth(span = 0.75, linewidth = 0.8) +
  theme_minimal() +
  labs(x ="DBH (cm)", y = "Height (m)") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16)) 


ggsave("DBH_height_CCandFTH.png", path = "D:/Mes Donnees/PhD/Figures/inventory",
       width = 20, height = 20, units = "cm", dpi=800, bg="white")
```

# Fits and compares height-diameter models (BIOMASS)
toutes esp√®ces confondues
```{r}
ModelsresultGuiana <- modelHD( # fits and compares (optional) height-diameter models
  D = data$DBH,
  H = data$Height,
  useWeight = F
)
knitr::kable(ModelsresultGuiana)
# the lowest RSE: log2 (RSE= 2.792)

HDmodelGuiana <- modelHD(
  D = data$DBH,
  H = data$Height,
  method = "log2", # Compute the H-D model with the lowest RSE.
  useWeight = F # T = larger trees have a stronger influence during the construction of the model 
)
HDmodelGuiana$coefficients
# log2 : exp(0.6988852 + 1.1989242*log(DBH) + -0.1187707*log(DBH)^2)

Understory <- Understory %>%
  mutate(TreeHeight = retrieveH(D= DBH, model = HDmodelGuiana)$H)
```

```{r}
Understory %>% filter(is.na(TreeHeight))
```

# Plot estimated heights
```{r}
Understory %>%
  ggplot() +
  aes(x = DBH, y = TreeHeight) +
  geom_point(shape = "circle", size = 0.2) + 
  # geom_smooth(span = 0.75, linewidth = 0.8) +
  theme_minimal() +
  labs(x ="DBH (cm)", y = "Height (m)") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16)) 


ggsave("Estimated_TreeHeight_CCandFTH.png", path = "D:/Mes Donnees/PhD/Figures/inventory",
       width = 35, height = 20, units = "cm", dpi=800, bg="white")
```

# Crown allometry
## Crown radius
```{r}
data %>%
  ggplot() +
  aes(x = DBH) +
  geom_point(aes(y = CrownRadius, color = "CanopyConstructor"), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = CrownRadius, color = "CanopyConstructor"), span = 0.75, linewidth = 0.8) +
  
  geom_point(aes(y = r1, color = "FTH-r1"), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = r1, color = "FTH-r1"), span = 0.75, linewidth = 0.8) +
  
  geom_point(aes(y = r2, color = "FTH-r2"), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = r2, color = "FTH-r2"), span = 0.75, linewidth = 0.8) +
  
  geom_point(aes(y = r3, color = "FTH-r3"), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = r3, color = "FTH-r3"), span = 0.75, linewidth = 0.8) +
  
  geom_point(aes(y = r4, color = "FTH-r4"), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = r4, color = "FTH-r4"), span = 0.75, linewidth = 0.8) +
  
  scale_color_manual(name = "Crown radius",
                     values = c("CanopyConstructor" = "#00AFBB",
                              "FTH-r1"= "#CC79A7",
                              "FTH-r2"= "#E7B800",
                              "FTH-r3" = "#FC4E07",
                              "FTH-r4" = "#009E73")) +
  
  theme_minimal() +
  labs(x ="DBH (cm)", y = "Crown radius (m)") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16),
        legend.position="bottom") 


ggsave("DBH_CrownRadius_CCandFTH.png", path = "D:/Mes Donnees/PhD/Figures/inventory",
       width = 25, height = 20, units = "cm", dpi=800, bg="white")
```
```{r}
data %>%
  ggplot() +
  aes(x = Height) +
  geom_point(aes(y = CrownRadius, color = "CanopyConstructor"), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = CrownRadius, color = "CanopyConstructor"), span = 0.75, linewidth = 0.8) +
  
  geom_point(aes(y = r1, color = "FTH-r1"), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = r1, color = "FTH-r1"), span = 0.75, linewidth = 0.8) +
  
  geom_point(aes(y = r2, color = "FTH-r2"), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = r2, color = "FTH-r2"), span = 0.75, linewidth = 0.8) +
  
  geom_point(aes(y = r3, color = "FTH-r3"), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = r3, color = "FTH-r3"), span = 0.75, linewidth = 0.8) +
  
  geom_point(aes(y = r4, color = "FTH-r4"), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = r4, color = "FTH-r4"), span = 0.75, linewidth = 0.8) +
  
  scale_color_manual(name = "Crown radius",
                     values = c("CanopyConstructor" = "#00AFBB",
                              "FTH-r1"= "#CC79A7",
                              "FTH-r2"= "#E7B800",
                              "FTH-r3" = "#FC4E07",
                              "FTH-r4" = "#009E73")) +
  
  theme_minimal() +
  labs(x ="Tree height (m)", y = "Crown radius (m)") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16),
        legend.position="bottom") 


ggsave("TreeHeight_CrownRadius_CCandFTH.png", path = "D:/Mes Donnees/PhD/Figures/inventory",
       width = 25, height = 20, units = "cm", dpi=800, bg="white")
```

## Crown base height
```{r}
FTH %>%
  ggplot() +
  aes(x = DBH, y = CrownBase) +
  geom_point(shape = "circle", size = 0.2) + # , colour = "#440154"
  geom_smooth(span = 0.75, linewidth = 0.8) +
  theme_minimal() +
  labs(x ="DBH (cm)", y = "Crown base height (m)") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16)) 

ggsave("DBH_CrownBase_CanopyConstructor.png", path = "D:/Mes Donnees/PhD/Figures/inventory",
       width = 20, height = 20, units = "cm", dpi=800, bg="white")

FTH %>%
  ggplot() +
  aes(x = Height, y = CrownBase) +
  geom_point(shape = "circle", size = 0.2) + # , colour = "#440154"
  geom_smooth(span = 0.75, linewidth = 0.8) +
  theme_minimal() +
  labs(x ="Tree height (m)", y = "Crown base height (m)") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16)) 

ggsave("Height_CrownBase_CanopyConstructor.png", path = "D:/Mes Donnees/PhD/Figures/inventory",
       width = 20, height = 20, units = "cm", dpi=800, bg="white")

mean(FTH$CrownBase/FTH$Height, na.rm = T) # 0.58
2/3 = 0.7
3/5 = 0.6
```


CrownDiameterAllometry ln(DBH) = ùú∂ +ùú∑ ln(H*CD) + ùú∫, with ùú∫~N(0,œÉ^2)
and mean œÉ^2 = 0.0295966977 with the crown diameter (CD), the tree height
(H) in m, and the DBH in cm. (Aubry-Kientz et al.2019)(function)

```{r}
exp(((log(DBH)- alpha - rnorm(length(DBH), 0, 0.0295966977))/beta))/TreeHeight
# CrownRadius
# CrownBase,
# r1, r2, r3, r4
```

