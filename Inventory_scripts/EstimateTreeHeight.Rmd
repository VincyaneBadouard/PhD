---
title: "Estimate tree height and crown dimensions"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

Arbres communs avec ceux de Claudia -> prendre l'estimation de Claudia de la hauteur de l'arbre et du rayon de la couronne 
Autres arbres :
- **TreeHeight** : par une allom√©trie issue des donn√©es de Claudia et FTH
- **CrownDiameter** : par une allom√©trie CC (√† faire en dernier)

Pour tout le monde : 
- **CrownHeight** = TreeHeight * 0.3

**PRENDRE DBHcor** !!!!
**sauf pour les multistems : il faut prendre DBH de la 1√®re tige**


faire un mod√®le toutes esp√®ces confondues

# Packages
```{r Setup, include = F}
library(tidyverse)
library(data.table)
library(readr)
library(BIOMASS)
```

# Import cleaned inventory data
```{r,include = F, message=F}
Understory <- read.csv("~/PhD/Inventories/Data/Understory/Paracou/ALT_Paracou_9ha_Filtred.csv")
Adults <- read.csv("~/PhD/Inventories/Data/Adults/Paracou/AdultsP16_filtred.csv") # 25 ha

```

# Import allometry data
```{r, include = F}
# Claudia's CanopyConstructor data (simulations average)
CC <- read_csv("~/PhD/Inventories/Data/Height-Diameter/CanopyConstructorDataP16.csv") %>% 
  select(idTree, DBH, Height, CrownRadius) %>% 
  rename(TreeHeight = Height) %>% 
  mutate(HeightHow = "CanopyConstructor")

# Giacomo FTH data
FTH <- read_csv("~/PhD/Inventories/Data/Understory/Paracou/Allometry_FTH_GSellan_Paracou_20240125.csv") %>% 
  select(Genus, species, DBH, Htot, Hbranch, r1, r2, r3, r4) %>%
  unite(col = "ScientificName", c("Genus", "species"),
        sep = "_", na.rm = TRUE, remove = F) %>%
  rename(TreeHeight = Htot, CrownBase = Hbranch) %>% 
  mutate(HeightHow = "Trigonometry (FTH)") %>% 
  mutate(r2 = as.numeric((r2))) %>% # √† v√©rifier
  mutate(r4 = as.numeric((r4))) %>% 
  mutate(CrownRadius = rowMeans(select(., r1,r2,r3,r4), na.rm=T)) # average of the 4 measurements (north, south, east, west)

length(sort(unique(FTH$ScientificName))) # ya des sp, indet
range(na.omit(FTH$DBH)) # 0.90 96.12959
# petits arbres mesur√©s au ruban, grands: mesure angle au clinom√®tre entre le haut et le bas de la plante (trigonom√©trie)

data <- CC %>%
  bind_rows(FTH) %>% 
  filter(!is.na(DBH)) %>% filter(!is.na(TreeHeight))
```

# Plot H-D data
```{r}
data %>%
  ggplot() +
  aes(x = DBH, y = TreeHeight, colour=HeightHow) +
  geom_point(shape = "circle", size = 0.2) + # , colour = "#440154"
  geom_smooth(span = 0.75, linewidth = 0.8) + # using method = 'gam' and formula 'y ~ s(x, bs = "cs")'
  theme_minimal() +
  labs(x ="DBH (cm)", y = "Height (m)", colour = "Method") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16),
        legend.position="bottom") 

# ggsave("DBH_height_methods.png", path = "D:/Mes Donnees/PhD/Figures/inventory",
#        width = 20, height = 20, units = "cm", dpi=800, bg="white")


data %>%
  ggplot() +
  aes(x = DBH, y = TreeHeight) +
  geom_point(shape = "circle", size = 0.2) + # , colour = "#440154"
  geom_smooth(span = 0.75, linewidth = 0.8) +
  theme_minimal() +
  labs(x ="DBH (cm)", y = "Height (m)") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16)) 


# ggsave("DBH_height_CCandFTH.png", path = "D:/Mes Donnees/PhD/Figures/inventory",
#        width = 20, height = 20, units = "cm", dpi=800, bg="white")
```

# Claudia's trees
```{r}
Adults <- Adults %>% 
  left_join((CC %>% select(-DBH)), by="idTree") # + TreeHeight, CrownRadius
```

# Other trees

## Fits and compares height-diameter models (BIOMASS)
toutes esp√®ces confondues
```{r}
ModelsresultGuiana <- modelHD( # fits and compares (optional) height-diameter models
  D = data$DBH,
  H = data$TreeHeight,
  useWeight = F
)
knitr::kable(ModelsresultGuiana)
# the lowest RSE: log2 (RSE= 2.792), michaelis :	2.796711

HDmodelGuiana <- modelHD(
  D = data$DBH,
  H = data$TreeHeight,
  method = "michaelis", # Compute the H-D model with the lowest RSE.
  useWeight = F # T = larger trees have a stronger influence during the construction of the model 
)
HDmodelGuiana$coefficients
# log2 : exp(0.6988852 + 1.1989242*log(DBH) + -0.1187707*log(DBH)^2)
# michaelis : (48.87652 * DBH)/(18.59470 + DBH) *exp(error)

Estim <- Adults %>%
  filter(is.na(TreeHeight)) %>% # 24 trees
  mutate(TreeHeight = retrieveH(D= DBHcor, model = HDmodelGuiana)$H) %>% 
  mutate(HeightHow = "Local allometry")

Adults <- Adults %>%
  filter(!is.na(TreeHeight)) %>% 
  bind_rows(Estim) %>% 
  mutate(CrownHeight = TreeHeight*0.3)

Understory <- Understory %>% # 28 711
  mutate(TreeHeight = retrieveH(D= DBHcor, model = HDmodelGuiana)$H) %>% 
  mutate(CrownHeight = TreeHeight*0.3) %>% 
  mutate(HeightHow = "Local allometry")
```

```{r}
Understory %>% filter(is.na(TreeHeight))
```

## Plot Tree and crown heights estimation
```{r}
Adults %>%
  ggplot() +
  aes(x = DBHcor, y = TreeHeight, colour= HeightHow) +
  geom_point(shape = "circle", size = 0.2) + 
  geom_smooth(span = 0.75, linewidth = 0.8) + # using method = 'gam' and formula 'y ~ s(x, bs = "cs")'
  geom_point(data= Understory, shape = "circle", size = 0.2, aes(color = "Local allometry")) + 
  theme_minimal() +
  scale_color_manual(values = c("Local allometry" = "#00AFBB",
                              "CanopyConstructor"= "#E7B800")) +
  labs(x ="DBH (cm)", y = "Tree height (m)", colour = "Method") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16),
        legend.position="bottom")

Adults %>%
  ggplot() +
  aes(x = DBHcor, y = CrownHeight) +
  geom_point(aes(col = "Crown height"), size = 1) + 
  geom_smooth(span = 0.75, linewidth = 0.8, aes(color = "Crown height")) + # using method = 'gam' and formula 'y ~ s(x, bs = "cs")'
  geom_point(data= Understory, size = 1, aes(color = "Crown height")) + 
  geom_point(size = 1, aes(y = CrownRadius, color = "Crown radius")) + 
  geom_smooth(span = 0.75, linewidth = 0.8, aes(y = CrownRadius, color = "Crown radius")) + # using method = 'gam' and formula 'y ~ s(x, bs = "cs")'

  theme_minimal() +
  scale_color_manual(values = c("Crown height" = "#CC79A7",
                              "Crown radius"= "#E7B800")) +
  labs(x ="DBH (cm)", y = "Crown dimension (m)") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_blank(), legend.text= element_text(size=16),
        legend.position="bottom")
```

## Crown radius allometry
### Plot data - relation CrownRadius-DBH
```{r}
data %>%
  ggplot() +
  aes(x = DBH) +
  geom_point(aes(y = CrownRadius, color = "CanopyConstructor"), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = CrownRadius, color = "CanopyConstructor"), span = 0.75, linewidth = 0.8) +
  
  geom_point(aes(y = r1, color = "FTH-r1"), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = r1, color = "FTH-r1"), span = 0.75, linewidth = 0.8) +
  
  geom_point(aes(y = r2, color = "FTH-r2"), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = r2, color = "FTH-r2"), span = 0.75, linewidth = 0.8) +
  
  geom_point(aes(y = r3, color = "FTH-r3"), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = r3, color = "FTH-r3"), span = 0.75, linewidth = 0.8) +
  
  geom_point(aes(y = r4, color = "FTH-r4"), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = r4, color = "FTH-r4"), span = 0.75, linewidth = 0.8) +
  
  scale_color_manual(name = "Crown radius",
                     values = c("CanopyConstructor" = "#00AFBB",
                                "FTH-r1"= "#CC79A7",
                                "FTH-r2"= "#E7B800",
                                "FTH-r3" = "#FC4E07",
                                "FTH-r4" = "#009E73")) +
  
  theme_minimal() +
  labs(x ="DBH (cm)", y = "Crown radius (m)") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16),
        legend.position="bottom") 


# ggsave("DBH_CrownRadius_CCandFTH.png", path = "D:/Mes Donnees/PhD/Figures/inventory",
#        width = 25, height = 20, units = "cm", dpi=800, bg="white")

# Average FTH
data %>%
  ggplot() +
  aes(x = DBH, col=HeightHow) +
  geom_point(aes(y = CrownRadius), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = CrownRadius), span = 0.75, linewidth = 0.8) +
  theme_minimal() +
  labs(x ="DBH (cm)", y = "Crown radius (m)") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16),
        legend.position="bottom") 

# together
data %>%
  ggplot() +
  aes(x = DBH) +
  geom_point(aes(y = CrownRadius), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = CrownRadius), span = 0.75, linewidth = 0.8) +
  theme_minimal() +
  labs(x ="DBH (cm)", y = "Crown radius (m)") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16),
        legend.position="bottom") 
```
### Plot data - relation CrownRadius-TreeHeight
```{r}
data %>%
  ggplot() +
  aes(x = TreeHeight) +
  geom_point(aes(y = CrownRadius, color = "CanopyConstructor"), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = CrownRadius, color = "CanopyConstructor"), span = 0.75, linewidth = 0.8) +
  
  geom_point(aes(y = r1, color = "FTH-r1"), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = r1, color = "FTH-r1"), span = 0.75, linewidth = 0.8) +
  
  geom_point(aes(y = r2, color = "FTH-r2"), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = r2, color = "FTH-r2"), span = 0.75, linewidth = 0.8) +
  
  geom_point(aes(y = r3, color = "FTH-r3"), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = r3, color = "FTH-r3"), span = 0.75, linewidth = 0.8) +
  
  geom_point(aes(y = r4, color = "FTH-r4"), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = r4, color = "FTH-r4"), span = 0.75, linewidth = 0.8) +
  
  scale_color_manual(name = "Crown radius",
                     values = c("CanopyConstructor" = "#00AFBB",
                                "FTH-r1"= "#CC79A7",
                                "FTH-r2"= "#E7B800",
                                "FTH-r3" = "#FC4E07",
                                "FTH-r4" = "#009E73")) +
  
  theme_minimal() +
  labs(x ="Tree height (m)", y = "Crown radius (m)") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16),
        legend.position="bottom") 


# ggsave("TreeHeight_CrownRadius_CCandFTH.png", path = "D:/Mes Donnees/PhD/Figures/inventory",
#        width = 25, height = 20, units = "cm", dpi=800, bg="white")

# Average FTH
data %>%
  ggplot() +
  aes(x = TreeHeight, col=HeightHow) +
  geom_point(aes(y = CrownRadius), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = CrownRadius), span = 0.75, linewidth = 0.8) +
  theme_minimal() +
  labs(x ="Tree height (m)", y = "Crown radius (m)") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16),
        legend.position="bottom") 

# together
data %>%
  ggplot() +
  aes(x = TreeHeight) +
  geom_point(aes(y = CrownRadius), shape = "circle", size = 0.2) + 
  geom_smooth(aes(y = CrownRadius), span = 0.75, linewidth = 0.8) +
  theme_minimal() +
  labs(x ="Tree height (m)", y = "Crown radius (m)") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16),
        legend.position="bottom")
```

### Plot crown base height
```{r}
FTH %>%
  ggplot() +
  aes(x = DBH, y = CrownBase) +
  geom_point(shape = "circle", size = 0.2) + # , colour = "#440154"
  geom_smooth(span = 0.75, linewidth = 0.8) +
  theme_minimal() +
  labs(x ="DBH (cm)", y = "Crown base height (m)") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16)) 

# ggsave("DBH_CrownBase_CanopyConstructor.png", path = "D:/Mes Donnees/PhD/Figures/inventory",
#        width = 20, height = 20, units = "cm", dpi=800, bg="white")

FTH %>%
  ggplot() +
  aes(x = TreeHeight, y = CrownBase) +
  geom_point(shape = "circle", size = 0.2) + # , colour = "#440154"
  geom_smooth(span = 0.75, linewidth = 0.8) +
  theme_minimal() +
  labs(x ="Tree height (m)", y = "Crown base height (m)") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16)) 

# ggsave("Height_CrownBase_CanopyConstructor.png", path = "D:/Mes Donnees/PhD/Figures/inventory",
# width = 20, height = 20, units = "cm", dpi=800, bg="white")

mean(FTH$CrownBase/FTH$TreeHeight, na.rm = T) # 0.58
# 2/3 = 0.7
# 3/5 = 0.6
```

### Estimate CrownRadius
Pour estimer le rayon de la couronne des arbres absents des donn√©es de Claudia, je dois utiliser l'allom√©trie de CanopyConstructor dont je ne connais pas la valeur des param√®tres. Donc je dois les estimer √† partir des donn√©es de Claudia.
```{r}
# La relation allom√©trique de CanopyConstructor : exp(alpha + epsilon) * DBH^beta

# Mod√®le lin√©aire pour estimation initiale
lm_fit <- lm(log(data$CrownRadius) ~ log(data$DBH), data = data)

# Estimations initiales
alpha_init <- coef(lm_fit)[1]
beta_init <- coef(lm_fit)[2]

# Ajustement avec nls (Nonlinear Least Squares)
nls_fit <- nls(CrownRadius ~ exp(alpha) * (DBH^beta),
               data = data,
               start = list(alpha = alpha_init, beta = beta_init))

# R√©cup√©rer les param√®tres estim√©s
coef <- coef(nls_fit)

# Estimation
Estim <- Adults %>%
  filter(is.na(CrownRadius)) %>% # 24 trees
  mutate(CrownRadius = exp(coef["alpha"]) * (DBHcor^coef["beta"]))

Adults <- Adults %>%
  filter(!is.na(CrownRadius)) %>% 
  bind_rows(Estim)

Understory <- Understory %>% # 28 711
  mutate(CrownRadius = exp(coef["alpha"]) * (DBHcor^coef["beta"]))
```

### Check
```{r}
FTH <- FTH %>% 
  mutate(CrownRadius_est = exp(coef["alpha"]) * (DBH^coef["beta"]))

FTH %>%
  ggplot() +
  aes(x = DBH, y = CrownRadius) +
  geom_point(size = 0.2, aes(color = "Average measurement")) + 
  geom_smooth(span = 0.75, linewidth = 0.8, aes(color = "Average measurement")) +
  geom_point(aes(y = CrownRadius_est, color = "Estimated"), size = 0.2) +
    geom_smooth(aes(y = CrownRadius_est, color = "Estimated"), span = 0.75, linewidth = 0.8) +

  theme_minimal() +
  scale_color_manual(values = c("Average measurement" = "#009E73",
                              "Estimated"= "#D55E00")) +
  labs(x ="DBH (cm)", y = "CrownRadius (m)") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_blank(), legend.text= element_text(size=16),
        legend.position="bottom")

CC <- CC %>% 
  mutate(CrownRadius_est = exp(coef["alpha"]) * (DBH^coef["beta"]))

CC %>%
  ggplot() +
  aes(x = DBH, y = CrownRadius) +
  geom_point(size = 0.2, aes(color = "Average measurement")) + 
  # geom_smooth(span = 0.75, linewidth = 0.8, aes(color = "Average measurement")) +
  geom_point(aes(y = CrownRadius_est, color = "Estimated"), size = 0.2) +
    geom_smooth(aes(y = CrownRadius_est, color = "Estimated"), span = 0.75, linewidth = 0.8) +

  theme_minimal() +
  scale_color_manual(values = c("Average measurement" = "#009E73",
                              "Estimated"= "#D55E00")) +
  labs(x ="DBH (cm)", y = "CrownRadius (m)") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_blank(), legend.text= element_text(size=16),
        legend.position="bottom")

```

### Plot Crown radius estimation
```{r}
Adults %>%
  ggplot() +
  aes(x = DBHcor, y = CrownRadius, colour= HeightHow) +
  geom_point(shape = "circle", size = 0.2) + 
  geom_smooth(span = 0.75, linewidth = 0.8) + # using method = 'gam' and formula 'y ~ s(x, bs = "cs")'
  geom_point(data= Understory, shape = "circle", size = 0.2, aes(color = "Local allometry")) + 
  theme_minimal() +
  scale_color_manual(values = c("Local allometry" = "#00AFBB",
                              "CanopyConstructor"= "#E7B800")) +
  labs(x ="DBH (cm)", y = "CrownRadius (m)", colour = "Method") +
  theme(axis.title= element_text(size=16), axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16),
        legend.position="bottom")
```

## Osol√®te - Version allom√©trie de M√©laine
CrownDiameterAllometry ln(DBH) = ùú∂ +ùú∑ ln(H*CD) + ùú∫, with ùú∫~N(0,œÉ^2)
and mean œÉ^2 = 0.0295966977 with the crown diameter (CD), the tree height
(H) in m, and the DBH in cm. (Aubry-Kientz et al.2019)

```{r}
exp(((log(DBH)- alpha - rnorm(length(DBH), 0, 0.0295966977))/beta))/TreeHeight
```

