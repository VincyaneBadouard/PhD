---
title: "Clean inventories"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: pdf_document
---
Début de l’inventaire :  novembre 2020
Fin de l'inventaire : décembre 2023

Paracou - P16:
4 ha : 19,20,14,15 
9 ha : 13,14,15,18,19,20,23,24,25

Pour les  4 1ers ha les arbres CIRAD n'ont pas été mesurés par l'équipe ALT, ce sont les DBH du dataset CIRAD 2020.

Pour les autres subplots, les DBH des arbres CIRAD ont été mesuré par l'équipe ALT.

Nouragues - Petit Plateau:
202,203,204,212,213,214

# Packages
```{r Setup, include = F}
library(tidyverse)
library(data.table)
library(readr)
library(sf)

# remotes::install_github("EcoFoG/EcoFoG", build_vignettes = F)
# library(EcoFoG)
```

# Import inventory data
Paracou Plot 16
Nouragues Petit Plateau
```{r}
# Adults <- Guyafor2df(UID = "Vincyane.Badouard", PWD = "Vincyane973+", Driver = "SQL Server",WHERE="Forest='Paracou' AND Plot='16'") #  AND CensusYear=2020
# write.csv(Adults, "D:/Mes Donnees/PhD/Inventories/Data/Adults/Paracou16_2020.csv")
# rm(Adults)
# Adults <- Guyafor2df(UID = "Vincyane.Badouard", PWD = "Vincyane973+", Driver = "SQL Server",WHERE="Forest='Nouragues'AND Plot='Petit_Plateau' AND CensusYear=2022")
# write.csv(Adults, "D:/Mes Donnees/PhD/Inventories/Data/Adults/NouraguesPetitPlateau_2022.csv")
# rm(Adults)
```

```{r,include = F, message=F}
UnderstoryP <- 
  read_csv("~/PhD/Inventories/Data/Understory/Paracou/ALT_Paracou9ha_20250129.csv") # last raw data

UnderstoryN <- read_csv("~/PhD/Inventories/Data/Understory/Nouragues/Nouragues_ALT_20240910.csv") 

AdultsP <- read_csv("~/PhD/Inventories/Data/Adults/Paracou/Paracou16_2020.csv") %>% 
  filter(SubPlot %in% c(13,14,15,18,19,20,23,24,25)) %>%  # 9 ha
  # Circ to DBH
  mutate(DBH = CircCorr/pi)
AdultsN <- read_csv("~/PhD/Inventories/Data/Adults/Nouragues/NouraguesPetitPlateau_2022.csv") %>%
  filter(SubPlot %in% c(202,203,204,212,213,214)) # 6 ha
```

# Manage columns names
```{r}
# to detect differences in column names between datasets
names(UnderstoryN)[!names(UnderstoryN) %in% names(UnderstoryP)]
names(UnderstoryP)[!names(UnderstoryP) %in% names(UnderstoryN)]

names(UnderstoryN) <- str_to_sentence(names(UnderstoryN)) # start by uppercase
UnderstoryN <- UnderstoryN %>%
  select(- "...1") %>%
  rename_at(c("Pom", "Dbh"), # uppercase
            .funs = toupper) %>%
  rename(TreeID = Treeid, IdStem = Stemid, SubPlot=Plot,
         CensusYear = Censusyear, CensusDate = Censusdate, Dead = Mort,
         BotaCertainty = Botacertainty, ScientificName = Scientificname, Cod.CTFS=Codctfs) %>%
  mutate(Site = "Nouragues") %>%
  mutate(Plot = "Petit_Plateau") %>%
  mutate(ProjectArea = 6)

UnderstoryP <- UnderstoryP %>% 
  select(-"X.1") %>% 
  rename(Xutm = XTreeUTM, Yutm = YTreeUTM) %>% 
  rename(DBH = Diameter) %>% 
  rename(SubPlot = Subplot) %>%
  mutate(Plot = "16") %>% 
  mutate(ProjectArea = 9)

# "Diam_cirad"
```

# Strategy data (canopy vs understory species)
```{r}
strategy <- read_delim("~/PhD/Inventories/EFT2023_Understory/dcl.csv", 
                       delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  select(genre_esp, Strategy) %>%
  rename(ScientificName = genre_esp) %>%
  mutate(Strategy = ifelse(Strategy== "#N/A", NA, Strategy)) %>%
  mutate(Strategy = recode(Strategy, "TallSp" = "Canopy species" , "UnderstorySp" = "Understory species")) %>% 
  unique()
unique(strategy$Strategy)

Understory <- list(UnderstoryP, UnderstoryN)
Understory <- lapply(Understory, function(x) left_join(x, strategy, by="ScientificName"))

UnderstoryP <- Understory[[1]]
UnderstoryN <- Understory[[2]]

sum(is.na(UnderstoryP$Strategy)) # 6871
sum(is.na(UnderstoryN$Strategy)) # 20005
```

# Checks
Vérifications :
- the 9 subplots (done)
- données manquantes (done)
- idStem uniques (done)
- noms d'espèces uniques A FAIRE
- DBH au même POM (1.30) ? que faire pour les ALT ? A FAIRE
- arbres cirad tous présents A TRAITER (attention arbres sans stem 1)
- joindre les infos manquantes des cirad (**DBH le plus récent**, bota, coordonnées)

# Only subplots of interest
P : c(13,14,15,18,19,20,23,24,25)
N : c(202,203,204,212,213,214)
```{r, eval = F}
unique(UnderstoryN$SubPlot)
all(UnderstoryP$SubPlot %in% c(13,14,15,18,19,20,23,24,25))
all(UnderstoryN$SubPlot  %in% c(202,203,204,212,213,214))
```

```{r}
data <- UnderstoryP
Adults <- AdultsP
```

# General Errors Detection
```{r}
source("~/PhD/R_codes/PhD/Inventory_scripts/Functions/GeneralErrorsDetection.R")

# rename columns for the function
Data <- data %>%
  select(-Comment) %>% # # remove previous Comments of my function of errors detection, Léa a gardé la colonne 
  rename(XTreeUTM=Xutm, YTreeUTM=Yutm, Diameter=DBH, Subplot=SubPlot)

Data <- GeneralErrorsDetection(Data)

Data %>% filter(Comment!="") %>% # 21311
  select(Comment, IdTree, IdStem, XTreeUTM, YTreeUTM, Family, Genus, Species, ScientificName, Diameter, Code_problem) 
```

## Missing data
```{r}
# unique(Data$Comment)

length(Data$Comment[grepl("Missing value in Species", Data$Comment)])/nrow(Data)*100 # 9%
length(Data$Comment[grepl("Missing value in Diameter", Data$Comment)])/nrow(Data)*100 # 0.2%
length(Data$Comment[grepl("TreeUTM", Data$Comment)])/nrow(Data)*100 # 0.4%
length(Data$Comment[grepl("Missing value in IdStem", Data$Comment)])/nrow(Data)*100 # 0.002%
```

## Unique IdStem
- Unique IdStem in the census
- Unique IdTree-IdStem association
- Unique IdStem-coordinates association
```{r}
length(Data$Comment[grepl("Duplicated 'IdStem'", Data$Comment)])/nrow(Data)*100 # 0.5%
length(Data$Comment[grepl("Duplicated row", Data$Comment)])/nrow(Data)*100 # 0.3%

Duplistems <- Data[grepl("Duplicated 'IdStem'", Data$Comment)]

length(unique(Duplistems$IdTree))

# Data %>% filter(Comment!="") %>% # 21311
#   select(Comment, IdTree, IdStem, XTreeUTM, YTreeUTM, Family, Genus, Species, ScientificName, Diameter, Code_problem) 
```

```{r}
length(Data$Comment[grepl("Different coordinates", Data$Comment)])/nrow(Data)*100 # 0.009%
length(Data$Comment[grepl("Non-unique combinaison", Data$Comment)])/nrow(Data)*100 # 0.03%
# combination 
```

# Bota
```{r}
# check if ScientificName is coherent with Genus and Species column ...
ScfcNamecheck <- Data %>% 
unite(col = "ScfcName", c("Genus", "Species"),
        sep = "_", na.rm = TRUE, remove = F)

ScfcNamecheck %>% 
  select(IdTree,IdStem, Guyafor.nb, ScientificName,  Genus, Species, ScfcName, Comments, Comment) %>% 
  filter(ScientificName!= ScfcName)
```

```{r}
# Endilcheria multiflora est une erreur d'orthographe d'Endlicheria melinonii 
# Maytenus_oblongata -> Monteverdia_oblongata
Data <- Data %>% 
  mutate(ScientificName = recode(ScientificName,
                                 "Endilcheria_multiflora" = "Endlicheria_melinonii",
                                 "Maytenus_oblongata" = "Monteverdia_oblongata"))

source("~/PhD/R_codes/PhD/Inventory_scripts/Functions/BotanicalCorrection.R")
Data <- BotanicalCorrection(Data, DetectOnly = T)

length(Data$Comment[grepl("Different botanical informations", Data$Comment)])/nrow(Data)*100 # 0.02%

test <- Data %>%
  filter(grepl("Different botanical informations", Comment)) %>% # 16
  select(Comment, IdTree, IdStem, Guyafor.nb, Diameter, Family, Genus, Species, ScientificName, Code_problem)


# Check the scientific names list
sort(unique(data$ScientificName))

# - genre_sp
# - genre_cf_espèce 
# - .subsp. 
# -.var.
# - _aff. c'est quoi ?
# - Rinorea_idem181298 (138 individus)
# attention ya un "Rinorea_idem181298"


data %>%
  # filter(grepl("_sp", ScientificName) & grepl("\\.", ScientificName)) %>%
  # filter(grepl("_cf_", ScientificName)) %>%
  filter(grepl("_aff", ScientificName) & grepl("\\.", ScientificName)) %>%
  # filter(grepl("subsp", ScientificName) & grepl("\\.", ScientificName)) %>%
  # filter(grepl("var", Species) & grepl("\\.", ScientificName)) %>%
  select(Species) %>% unique()

sp_abundances <- data %>%
  filter(!is.na(ScientificName)) %>%
  filter(ScientificName!="Tres haut") %>%
  filter(!grepl("indet", ScientificName)) %>%
  filter(!grepl("Indet", ScientificName)) %>%
  filter(!grepl("aceae", ScientificName)) %>%
  filter(!(grepl("_sp", ScientificName) & grepl("\\.", ScientificName))) %>% # only genus
  filter(!(grepl("_aff", ScientificName) & grepl("\\.", ScientificName))) %>% # identif not sure
  filter(!grepl("_cf_", ScientificName)) %>% # identif not sure
  mutate(ScientificName_c = sub("\\..*", "", ScientificName)) %>% 
  mutate(SubSpecies = str_extract(ScientificName,"(?<=\\.).*")) %>% 
  rename(ScientificName_old = ScientificName,
         ScientificName = ScientificName_c) %>% 
  group_by(ScientificName) %>%
  summarise(N = n()) %>%
  ungroup() # 557 sp

# write.csv(sp_abundances, "~/PhD/Inventories/Data/Understory/Paracou/Species_abundances.csv")
```

```{r}
unique(Data$Comment)

length(Data %>% filter(Comment!=""))/nrow(Data)*100 # 0.12%

Data %>% filter(Comment!="") %>% # 21311
  select(Comment, IdTree, IdStem, XTreeUTM, YTreeUTM, Family, Genus, Species, ScientificName, Diameter, Code_problem)
```

# POM
```{r, eval = F}
length(Data$Comment[grepl("Missing value in POM", Data$Comment)])/nrow(Data)*100 # 45% without POM info

# small trees with POM!=130
DiffPOM <- data %>% 
  filter(DBH<10) %>%  filter(POM!=130) %>% select(DBH,POM) # 61/42,524 ind
range(DiffPOM$POM) # 120-190
range(DiffPOM$DBH) # 1-9.4

small <- data %>% 
  filter(DBH<10)

nrow(DiffPOM)/nrow(small)*100 # 0.16 % of small trees have POM!=130

ggplot(DiffPOM, aes(x=POM)) +
  geom_bar(width = 1)
```


# Check if the cirad trees are all in the understory inventories
Guyafor.nb = TreeFieldNum_SubPlot
IdTree = SubPlot_id
Subplot

- tous les arbres cirad

**! ALT et Guyafor n’ont pas exactement les même limites de subplot -> ils ne sont pas considérés dans le même subplot dans ALT et Guyafor..!**

## Guyafor.nb
```{r}
data <- data %>% 
  mutate(CIRADid= tstrsplit(Guyafor.nb, split = "_")[[1]]) %>% #1er elmt  
  mutate(CIRADplot= tstrsplit(Guyafor.nb, split = "_")[[2]]) %>%  #2nd
  mutate(subplot = tstrsplit(IdTree, split = "_")[[1]]) %>% #1er elmt  
  mutate(ID = tstrsplit(IdTree, split = "_")[[2]]) #2nd


all(na.omit(data$CIRADplot == data$SubPlot)) # il ya des erreurs dans les n° de subplots des identifiants cirad
data %>% filter(CIRADplot != SubPlot) # 27 cirad trees with different subplot informations
all(na.omit(data$subplot == data$SubPlot)) # pas d'erreur dans les n° de subplots des IdTree

Adults <- Adults %>% 
  filter(CodeAlive == T) %>%
  unite(col = "CIRAD", c("TreeFieldNum", "SubPlot"), # ! ALT et Guyafor n’ont pas exactement les même limites de subplot -> ils ne sont pas considérés dans le même subplot dans ALT et Guyafor..!.
        sep = "_", na.rm = F, remove = F) %>% 
  mutate(CIRAD = gsub("[[:space:]]", "", CIRAD)) %>%
  mutate(CIRAD = str_squish(CIRAD)) # remove double spaces

data <- data %>% 
  unite(col = "CIRAD", c("CIRADid", "SubPlot"),
        sep = "_", na.rm = F, remove = F) %>% 
  mutate(CIRAD = gsub("[[:space:]]", "", CIRAD)) %>% 
  mutate(CIRAD = str_squish(CIRAD)) # remove double spaces

Adults$CIRAD %in% data$CIRAD | Adults$CIRAD %in% data$Guyafor.nb # Guyafor.nb has some different subplot number than SubPlot

MissingCirad <- Adults %>% 
  filter(!(CIRAD %in% data$CIRAD|CIRAD %in% data$Guyafor.nb)) # 241

length(unique(MissingCirad$CIRAD)) # 241 cirad trees oubliés
unique(MissingCirad$SubPlot) %in% c(13,14,15,18,19,20,23,24,25)
length(unique(data$CIRAD)); length(unique(Adults$CIRAD))- length(unique(data$Guyafor.nb))
MissingCirad %>% filter(CodeAlive==F) # no dead trees

all(data[!is.na(data$Guyafor.nb),]$Stem.nb==1) # cirad stem id
stems <- data[!is.na(data$Guyafor.nb) & data$Stem.nb!=1,]$Guyafor.nb # cirad stem id >1
stem1 <- data[data$Guyafor.nb %in% stems & data$Stem.nb==1,]$Guyafor.nb # cirad stem id == 1

#!! cirad trees without stem 1 !! 
stems[!stems %in% stem1] # 1 cirad with multiple stems but without a stem 1
```

# Missing cirad positions
```{r}
data_sf <- data %>% 
  mutate(CIRAD = ifelse(!is.na(Guyafor.nb), T, F)) %>% 
  select(IdStem, CIRAD, SubPlot, Xutm, Yutm) %>% na.omit() %>% 
  mutate(SubPlot = as.factor(SubPlot)) %>% 
  st_as_sf(coords = c("Xutm", "Yutm"))

missingCIRAD_sf <- MissingCirad %>% 
  # select(IdStem, CIRAD, SubPlot, Xutm, Yutm) %>% na.omit() %>% 
  # mutate(SubPlot = as.factor(SubPlot)) %>% 
  st_as_sf(coords = c("Xutm", "Yutm"))


ggplot() +
  geom_sf(data=missingCIRAD_sf, aes(fill="missingCIRAD"), size = 0.5) +
  geom_sf(data=data_sf, aes(col=SubPlot), size = 0.5) +
  scale_fill_manual(name = "Missing CIRAD trees",
                    values = c("missingCIRAD" = "black")) +
  theme_classic()

ggsave(paste("ALT", unique(data$Site), unique(data$Plot),"missingCIRAD.png", sep="_"), path = "D:/Mes Donnees/PhD/Figures/inventory", width = 30, height = 20, units = "cm", dpi=800, bg="white")


for(p in c(13,14,15,18,19,20,23,24,25)){
  
  missing <- missingCIRAD_sf %>% 
    filter(SubPlot== as.character(p))
  
  print(
    data_sf %>% 
      filter(SubPlot== as.character(p)) %>% 
      ggplot() +
      geom_sf(data=missing, col="black", size = 1) +
      geom_sf(aes(col=CIRAD),size = 1.5) +
      theme_classic() +
      labs(title = paste("Plot",p))
  )
}
```

# Stem number
```{r}
#!! ATTENTION trees without stem 1 !!
length(Data$Comment[grepl("Trees without stem 1", Data$Comment)])/nrow(Data)*100 # 0.02%
```

# Size distribution
```{r, eval = F}
data %>% 
  filter(Liana!=TRUE | is.na(Liana)) %>% filter(Strategy!="liane"| is.na(Strategy)) %>% 
  ggplot(aes(x=DBH)) +
  geom_histogram(breaks=seq(0,60, by=5), aes(fill= Strategy), color="#e9ecef", alpha=0.9) + # color to have the lines of the bars
  scale_x_continuous(limits = c(0, 60), breaks = seq(0,60, by=5)) +
  scale_y_continuous(breaks = seq(0,35000, by=5000)) +
  theme_minimal() +
  labs(title= paste("ALT", unique(data$Site), unique(data$Plot),"- Size distribution"), x ="DBH (cm)", y = "Individuals number")
# ggsave(paste("ALT", unique(data$Site), unique(data$Plot),"- Size_distribution.png"), path = "D:/Mes Donnees/PhD/Figures/inventory", width = 20, height = 10, units = "cm", dpi=800, bg="white")
```

## divide by hectares (à faire)
```{r, eval = F}
data %>% 
  filter(Liana!=TRUE | is.na(Liana)) %>% filter(Strategy!="liane"| is.na(Strategy)) %>% 
  ggplot(aes(x=DBH)) +
  geom_histogram(breaks=seq(0,60, by=5), aes(fill= Strategy), color="#e9ecef", alpha=0.9) + # color to have the lines of the bars
  scale_x_continuous(limits = c(0, 60), breaks = seq(0,60, by=5)) +
  scale_y_continuous(breaks = seq(0,35000, by=5000)) +
  theme_minimal() +
  labs(title= paste("ALT", unique(data$Site), unique(data$Plot),"- Size distribution"), x ="DBH (cm)", y = "Individuals number")
# ggsave(paste("ALT", unique(data$Site), unique(data$Plot),"- Size_distribution.png"), path = "D:/Mes Donnees/PhD/Figures/inventory", width = 20, height = 10, units = "cm", dpi=800, bg="white")
```


```{r, eval = F}
nrow(data[data$DBH<10,])/nrow(data) # 0.88 : les moins de 10 cm
nrow(data[data$Strategy=="Understory species",])/nrow(data) # 0.28 : espèces de sous-bois
nrow(data[data$DBH<10 & data$Strategy=="Canopy species",])/nrow(data) # 0.76 : juvéniles de canopée
```

# Species abundances
y: n species
x: n individuals
```{r, eval = F}
data %>%
  filter(!is.na(ScientificName)) %>% 
  filter(ScientificName!="Tres haut") %>% 
  filter(!grepl("indet", ScientificName)) %>% 
  filter(!grepl("Indet", ScientificName)) %>% 
  filter(!grepl("aceae", ScientificName)) %>% 
  group_by(ScientificName) %>%
  summarise(N = n()) %>%
  ungroup() %>% 
  filter(N<200) %>% 
  ggplot(aes(x= N)) + # fill = as.factor(Strategy)
  geom_histogram(breaks= seq(0,200, by=10), fill="#69b3a2", color="#e9ecef",alpha=0.9) +
  geom_vline(xintercept = 30) +
  scale_x_continuous(limits = c(0, 200), breaks =  seq(0,200, by=10)) +
  scale_y_continuous(breaks = seq(0,500, by=25)) +
  labs(x ="Individuals number", y = "Species number")


# ggsave(paste("ALT", unique(data$Site), unique(data$Plot),"Species_abundances.png", sep="_"),
#        path = "D:/Mes Donnees/PhD/Figures/inventory", width = 50, height = 10, units = "cm", dpi=800, bg="white")
```

```{r, eval = F}
# length(unique(test$ScientificName))

data %>%
  filter(!is.na(ScientificName)) %>% 
  filter(ScientificName!="Tres haut") %>% 
  filter(!grepl("indet", ScientificName)) %>% 
  filter(!grepl("Indet", ScientificName)) %>% 
  filter(!grepl("aceae", ScientificName)) %>% 
  group_by(ScientificName) %>%
  summarise(N = n()) %>%
  ungroup() %>% 
  ggplot(aes(x= N)) +
  stat_ecdf(aes(y = (1 - after_stat(y))), geom = "point") +
  stat_ecdf(aes(y = (1 - after_stat(y))), geom = "step") +
  scale_y_continuous("Density", position = "right",
                     sec.axis = sec_axis(name = "Decumulative species number", trans = ~.x*732, breaks = seq(1,732, by=25))) +
  
  geom_vline(xintercept = 30, col="red") +
  scale_x_continuous(limits = c(1, 200), breaks =  c(1, seq(10,200, by=10))) +
  labs(x ="Minimum individuals number")

# ggsave(paste("ALT", unique(data$Site), unique(data$Plot),"Decumulative_speciesnbr.png", sep="_"),
#        path = "D:/Mes Donnees/PhD/Figures/inventory", width = 25, height = 20, units = "cm", dpi=800, bg="white")
```

# Species rank abundance
```{r, eval = F}
data %>%
  filter(!is.na(ScientificName)) %>% 
  filter(ScientificName!="Tres haut") %>% 
  filter(!grepl("indet", ScientificName)) %>% 
  filter(!grepl("Indet", ScientificName)) %>% 
  filter(!grepl("aceae", ScientificName)) %>% 
  group_by(ScientificName) %>%
  summarise(N = n()) %>%
  ungroup() %>% 
  group_by(N) %>%
  summarise(n_sp = n()) %>%
  mutate(N = arrange(desc(N))) %>% 
  mutate(n_sp_cum = cumsum(n_sp)) %>% 
  
  ggplot(aes(x= N)) +
  geom_col(aes(y=n_sp_cum)) +
  geom_vline(xintercept = 30, col="red") +
  scale_x_continuous(limits = c(1, 200), breaks =  c(1, seq(10,220, by=10))) + #  2500
  scale_y_continuous(breaks = seq(0,732, by=25)) +
  labs(x ="Individuals number", y="Decumulative species number")

# ggsave(paste("ALT", unique(data$Site), unique(data$Plot),"Decumulative_speciesnbr_geomcol.png", sep="_"),
#        path = "D:/Mes Donnees/PhD/Figures/inventory", width = 30, height = 20, units = "cm", dpi=800, bg="white")
```


```{r, eval = F}
data %>%
  filter(!is.na(ScientificName)) %>% 
  filter(ScientificName!="Tres haut") %>% 
  filter(!grepl("indet", ScientificName)) %>% 
  filter(!grepl("Indet", ScientificName)) %>% 
  filter(!grepl("aceae", ScientificName)) %>% 
  group_by(ScientificName) %>%
  summarise(Anbundances = n()) %>%
  ungroup() %>% 
  mutate(Anbundances = sort(Anbundances, decreasing = T)) %>% 
  # filter(Anbundances >=30) %>% 
  mutate(rank = 1:n()) %>%  
  ggplot(aes(x= rank, y=Anbundances)) +
  geom_point(size=1) +
  geom_line() +
  geom_hline(yintercept = 30, col="red") +
  # scale_x_continuous(limits = c(1, 732), breaks =  c(seq(10,100, by=25), seq(200,732, by=100))) +
  scale_y_continuous(limits = c(1, 2500), breaks =  c(1, seq(100,2500, by=100))) + #  2500
  labs(x="Species rank")

# ggsave(paste("ALT", unique(data$Site), unique(data$Plot),"Species_abundances_rank.png", sep="_"),
#        path = "D:/Mes Donnees/PhD/Figures/inventory", width = 25, height = 20, units = "cm", dpi=800, bg="white")
```

# Remove duplicated rows
```{r}
# DuplicatedID <- unique(data[duplicated(data),]$IdStem)
# 
# data[data$IdStem%in%DuplicatedID,]
# 
# data <- data[!duplicated(data),]
# P: 42524 -> 42366 (158 rows removed)
# N: 29370 -> 29363 (7 rows removed)
```

```{r}
data <- Data %>% 
  rename(DBH=Diameter, Xutm = XTreeUTM, Yutm = YTreeUTM) # %>%
# Only measured trees
# filter(!is.na(DBH))

```

# Detect real and not sure multistems
on ne se fie qu'au DBH et aux idTree, la numérotation des stems contient des erreurs  
Multistem = for a same idtree: 
- T : number of different DBH values >1, same ScientificName and coordinates, all duplicated the same times number (it can be 0 duplication)  
- F :  only 1 measurement   
- NA : the rest (soit pas même ScientificName ou coordonnées, soit memes DBHs pour tout l'idTree, soit certains DBH sont dupliqués mais pas tous)  
```{r}
data <- data %>% 
  group_by(IdTree) %>% 
  # TRUE for real multistems: number of different DBH values >1, same ScientificName and coordinates, all duplicated the same times number
  mutate(Multistem = ifelse(length(table(DBH)) > 1 & # number of different DBH values >1
                              # same ScientificName and coordinates
                              length(unique(ScientificName))==1 & length(unique(Xutm))==1 & length(unique(Yutm))==1 & 
                              # all duplicated the same times number
                              length(unique(table(DBH))) == 1, T, NA)) %>%
  mutate(Multistem = ifelse(n()==1, F, Multistem)) %>% # only 1 measurement -> not multistem
  ungroup()

# According to the Comments -------
falsemultistem <- (data %>% filter(grepl("False pas double tige", Comments)))$IdTree
data <- data %>% 
  mutate(Multistem = ifelse(IdTree==falsemultistem, F, Multistem)) %>%  
  mutate(Stem.nb = ifelse(IdTree==falsemultistem, 1, Stem.nb)) %>%  
  mutate(IdTree = ifelse(IdTree==falsemultistem, c("18_1761", "falseM"), IdTree)) %>% 
  mutate(IdStem = ifelse(IdTree=="falseM", "falseM_1", IdStem))

data <- data %>% 
  mutate(Multistem = ifelse(grepl("Rejet", Comments), T, Multistem)) 


# Les NA : multistem_not sure !! -------
test4 <- data %>% 
  filter(is.na(Multistem)) %>% # the not sure cases (105) (soit pas même ScientificName ou coordonnées, soit memes DBHs pour tout l'idTree, soit certains DBH sont dupliqués mais pas tous)
  filter(!grepl("Duplicated 'IdStem'", Comment))
# Est-ce que je peux considérer que coctfs = M = multistem sure ?

# write.csv(test4, "~/PhD/Inventories/Data/Understory/Paracou/Problems/Multistems_notsure.csv")
length(unique(test4$IdTree)) # 34 trees

test5 <- data %>% 
  filter(is.na(Multistem)) %>% # the not sure cases (127) (soit pas même ScientificName ou coordonnées, soit memes DBHs pour tout l'idTree, soit certains DBH sont dupliqués mais pas tous)
  filter(grepl("Duplicated 'IdStem'", Comment)) # 14

```

# Manage multistems (sum the basal area, and keep only 1 stem) (Stem.nb pas codé)
**que fait on des Multistems= NA ?!** !!! pour l'instant je les ai considéré comme des multistems
```{r}
# pas codé si Stem.nb bien codé (1, 2, n)
# unique(data$Comment) 
# unique(data$Comments)

dupliMultistems <- data %>%
  filter(Multistem & !is.na(Multistem)) %>% # only sure multistems
    filter(grepl("Duplicated 'IdStem'", Comment)) # 14


Multistems <- data %>% # 1 245
  # filter(Multistem & !is.na(Multistem)) %>% # only sure multistems
  filter(Multistem | is.na(Multistem)) %>% # sure and not sure multistems
  distinct(IdTree, DBH, .keep_all = T) %>% # Résolution cas 2: remove duplicates -> clean real multistems trop bourain pcq des DBH peuvent etre égaux par hasard
  mutate(BasalArea = pi*(DBH/2)^2) %>% 
  group_by(IdTree) %>% 
  arrange(desc(DBH)) %>% 
  mutate(Stem.nb = 1:n()) %>% # numérote les stems par ordre décroissant de DBH
  unite(col = "IdStem", c("IdTree", "Stem.nb"), # recode the IdStem
        sep = "_", na.rm = TRUE, remove = F) %>% # numérote les stems par ordre décroissant de DBH
  mutate(BasalAreacor = sum(BasalArea)) %>% # somme des surfaces terrières
  mutate(DBHcor = 2*sqrt(BasalAreacor/pi)) %>% 
  arrange(desc(DBHcor)) %>% 
  fill(Xutm, Yutm, X, Y,
       Guyafor.nb,
       ScientificName, Genus, Species, Family,
       .direction = "downup") %>% 
  ungroup() 
# select(IdTree, Guyafor.nb, Stem.nb, DBH, DBHcor, ScientificName, Comment, Comments)

# unique(Multistems$Comment)
# Different botanical informations (Family, ScientificName) for a same IdTree"
# Missing value in XTreeUTM
# Missing value in Species
# unique(Multistems$Comments) # attention "False pas double tige" (traité)

# write.csv(test, "D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/Multistems_DBHcor.csv")

data <- data %>% 
  filter(!(Multistem | is.na(Multistem))) %>% # supprimer les Multistem=T (40997)
  mutate(DBHcor = DBH) %>%
  bind_rows(Multistems)

nrow(data)== nrow(UnderstoryP)
```

# Write cleaned data
**! vérifier que si ya DBH ya DBHcor !**
```{r}
nrow(data) # 42460
length(unique(data$ScientificName)) # 686

write.csv(data, "D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/ALT_Paracou_9ha_CLEAN.csv")
```

# Filters for my analyses
DBH>=1
Only alive trees
Only the principal stem
Only measured trees
Only botanical identified
Take only sp >= 30 ind
**ne pas enlever 1 seul arbre de l'inventaire !! Ce sont nos absences !**
on veut juste un vecteur d'espèce à étudier
```{r}
SpeciesA <- (read.csv("~/PhD/Inventories/Data/Adults/Paracou/AdultsP16_species_filtred.csv")[,2]) # 64

data <- data %>% 
  rowwise() %>% 
  filter(ScientificName %in% SpeciesA | Strategy=="Understory species") %>%
  ungroup() %>% 
  # & DBH<10 only ALT data for the moment
  filter(DBH>=1 & DBH<10) %>%
  # Only alive trees
  filter(Dead == F) %>% # filter(CodeAlive == T) %>%
  # Only measured trees
  filter(!is.na(DBH)) %>% 
  # Only the principal stem
  filter(Stem.nb == 1) %>%
  # Only spatialised trees
  filter(!is.na(Xutm) & !is.na(Yutm)) %>%
  # Only botanical identified
  filter(!is.na(ScientificName)) %>%
  # filter(ScientificName!="Tres haut") %>%
  # filter(!grepl("indet", ScientificName)) %>%
  # filter(!grepl("Indet", ScientificName)) %>%
  # filter(!grepl("aceae", ScientificName)) %>%
  # filter(!(grepl("_sp", ScientificName) & grepl("\\.", ScientificName))) %>% # garder les sp.numéro ?
  # filter(!(grepl("_aff", ScientificName) & grepl("\\.", ScientificName))) %>%
  # filter(!grepl("_cf_", ScientificName)) %>%
  # mutate(ScientificName_c = sub("\\..*", "", ScientificName)) %>% 
  # mutate(SubSpecies = str_extract(ScientificName,"(?<=\\.).*")) %>% 
  # rename(ScientificName_old = ScientificName,
  #        ScientificName = ScientificName_c) %>% 
  
  # attention Rinorea_idem181298 (138 individus)
  
  # Count individuals by species
  group_by(ScientificName) %>% 
  mutate(N = n()) %>% 
  ungroup() %>% 
  # Take only sp >= 30 ind
  filter(N >= 30)

unique(data$Comment)
SpeciesA[!SpeciesA %in% data$ScientificName]
# "Chrysophyllum_prieurii", "Theobroma_guianense" : DBH >10 uniquement
# "Caryocar_glabrum", "Eperua_rubiginosa", "Oenocarpus_bataua", "Goupia_glabra"         
# "Carapa_surinamensis", "Chrysophyllum_prieurii", "Sterculia_speciosa", "Siparuna_decipiens"    
# "Theobroma_guianense", "Ambelania_acida", "Euterpe_oleracea" # not enough >10     
```

# Write cleaned and filtred data
```{r}
nrow(data) # 19827
length(unique(data$ScientificName)) # 86

write.csv(data, "D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/ALT_Paracou_9ha_Filtred.csv")
```

# Mis de coté pour l'instant (gestion noms scientifiques)
```{r, eval = F}
Understory <- Understory %>% 
  mutate(ScientificName = str_squish(ScientificName)) %>% # remove double spaces
  mutate(ScientificName = ifelse(ScientificName=="Astrocaryum sciophylum", "Astrocaryum sciophilum", ScientificName)) %>% 
  mutate(ScientificName = ifelse(ScientificName=="Micropholis guyanensis subsp.Duckeana", "Micropholis guyanensis_subsp.duckeana", ScientificName))

Adults <- Adults %>% 
  # add a column identifying the two datasets
  add_column(Dataset = "Standard") %>%
  # idTree as character
  mutate(idTree = as.character(idTree)) %>% 
  # Circ to DBH
  mutate(DBH = CircCorr/pi) %>% 
  select(Dataset, idTree, Family, Genus, Species, DBH, MeasCode, CodeAlive, Xutm, Yutm)


# Join the 2 datasets
Total_inv <- bind_rows(Understory, Adults) %>% 
  # Only alive trees
  filter(CodeAlive == T) %>%
  # Create the ScientificName column
  unite(col = "ScientificName", c("Genus", "Species"),
        sep = "_", na.rm = TRUE, remove = F) %>%
  mutate(ScientificName = ifelse(ScientificName=="", NA, ScientificName)) %>% 
  mutate(ScientificName = str_squish(ScientificName)) %>% # remove double spaces
  mutate(ScientificName = ifelse(ScientificName=="Astrocaryum sciophylum", "Astrocaryum sciophilum", ScientificName)) %>% 
  mutate(ScientificName = ifelse(ScientificName=="Micropholis guyanensis subsp.Duckeana", "Micropholis guyanensis_subsp.duckeana", ScientificName))

# unique individuals
length(Total_inv$idTree) # 45997
unique(length(Total_inv$idTree)) # 45997

# Conceveiba  guianensis
# unique(Total_inv$ScientificName)

```

# Obsolete
```{r, eval = F}
# Understory <- Understory %>% 
#   select(-"...1" ) %>% 
#   unique() %>% 
#   
#   # Standardise columns names
#   rename(idTree = TreeID) %>% 
#   rename(Species = species) %>% 
#   rename(SubPlot = subplot) %>%
#   rename(CIRAD1 = CIRAD.BigTreeID) %>%
#   mutate(CodeAlive = as.logical(recode(Dead,
#                                        "FALSE" = "TRUE",
#                                        "FAUX" = "TRUE",
#                                        "(false)" = "TRUE",
#                                        "TRUE" = "FALSE",
#                                        "VRAI" = "FALSE"))) %>% 
#   # remove parentheses
#   mutate(Genus = gsub("[()]", "", Genus)) %>% 
#   mutate(Family = gsub("[()]", "", Family)) %>% 
#   
#   # add a column identifying the two datasets
#   add_column(Dataset = "ALT") %>% 
#   
#   # Create the ScientificName column
#   unite(col = "ScientificName", c("Genus", "Species"),
#         sep = " ", na.rm = TRUE, remove = F) %>%
#   mutate(ScientificName = ifelse(ScientificName=="", NA, ScientificName)) %>% 
#   mutate(ScientificName = str_squish(ScientificName)) %>% # remove double spaces
#   mutate(ScientificName = ifelse(ScientificName=="Astrocaryum sciophylum", "Astrocaryum sciophilum", ScientificName)) %>% 
#   mutate(ScientificName = ifelse(ScientificName=="Micropholis guyanensis subsp.Duckeana", "Micropholis guyanensis_subsp.duckeana", ScientificName)) %>% 
#   
#   # Only the needed columns
#   select(Dataset, SubPlot, Stem.number, idTree, CIRAD1, ScientificName, Family, Genus, Species, DBH, POM, CodeAlive, Xutm, Yutm)
```

!! ATTENTION !! il y a des dupliqués : différents DBH pour le meme idTree et la meme stem
```{r, eval = F}
# unique(Understory$Dead)
# 
# Understory <- Understory %>% 
#   select(-"...1" ) %>% 
#   unique() %>%
#   filter(DBH>=1) %>% 
#   rename(idTree = TreeID) %>% 
#   rename(Species = species) %>% 
#   rename(SubPlot = subplot) %>% 
#   # rename(CodeAlive = Dead) %>% 
#   mutate(CodeAlive = as.logical(recode(Dead,
#                                        "FALSE" = "TRUE",
#                                        "FAUX" = "TRUE",
#                                        "(false)" = "TRUE",
#                                        "TRUE" = "FALSE",
#                                        "VRAI" = "FALSE"))) %>% 
#   # remove parentheses
#   mutate(Genus = gsub("[()]", "", Genus)) %>% 
#   mutate(Family = gsub("[()]", "", Family))

# test <- select(Understory, Dead, CodeAlive)
```
