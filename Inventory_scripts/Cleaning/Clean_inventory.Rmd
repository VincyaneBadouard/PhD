---
title: "Clean inventories"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: pdf_document
---
Début de l’inventaire :  novembre 2020
Fin de l'inventaire : décembre 2023

Paracou - P16:
4 ha : 19,20,14,15 
9 ha : 13,14,15,18,19,20,23,24,25

Pour les  4 1ers ha les arbres CIRAD n'ont pas été mesurés par l'équipe ALT, ce sont les DBH du dataset CIRAD 2020.

Pour les autres subplots, les DBH des arbres CIRAD ont été mesuré par l'équipe ALT.

Nouragues - Petit Plateau:
202,203,204,212,213,214

# Packages
```{r Setup, include = F}
library(tidyverse)
library(data.table)
library(readr)
library(sf)

# remotes::install_github("EcoFoG/EcoFoG", build_vignettes = F)
# library(EcoFoG)
```

# Import inventory data
Paracou Plot 16
Nouragues Petit Plateau
```{r}
# Adults <- Guyafor2df(UID = "Vincyane.Badouard", PWD = "Vincyane973+", Driver = "SQL Server",WHERE="Forest='Paracou' AND Plot='16'") #  AND CensusYear=2020
# write.csv(Adults, "D:/Mes Donnees/PhD/Inventories/Data/Adults/Paracou16_2020.csv")
# rm(Adults)
# Adults <- Guyafor2df(UID = "Vincyane.Badouard", PWD = "Vincyane973+", Driver = "SQL Server",WHERE="Forest='Nouragues'AND Plot='Petit_Plateau' AND CensusYear=2022")
# write.csv(Adults, "D:/Mes Donnees/PhD/Inventories/Data/Adults/NouraguesPetitPlateau_2022.csv")
# rm(Adults)
```

```{r,include = F, message=F}
UnderstoryP <- 
  read_csv("~/PhD/Inventories/Data/Understory/Paracou/Raw/ALT_Paracou9ha_20250129.csv") # last raw data

UnderstoryN <- read_csv("~/PhD/Inventories/Data/Understory/Nouragues/Nouragues_ALT_20240910.csv") 

AdultsP <- read_csv("~/PhD/Inventories/Data/Adults/Paracou/Paracou16_2020.csv") %>% 
  filter(SubPlot %in% c(13,14,15,18,19,20,23,24,25)) %>%  # 9 ha
  # Circ to DBH
  mutate(DBH = CircCorr/pi)
AdultsN <- read_csv("~/PhD/Inventories/Data/Adults/Nouragues/NouraguesPetitPlateau_2022.csv") %>%
  filter(SubPlot %in% c(202,203,204,212,213,214)) # 6 ha
```

# Manage columns names
```{r}
# to detect differences in column names between datasets
names(UnderstoryN)[!names(UnderstoryN) %in% names(UnderstoryP)]
names(UnderstoryP)[!names(UnderstoryP) %in% names(UnderstoryN)]

names(UnderstoryN) <- str_to_sentence(names(UnderstoryN)) # start by uppercase
UnderstoryN <- UnderstoryN %>%
  select(- "...1") %>%
  rename_at(c("Pom", "Dbh"), # uppercase
            .funs = toupper) %>%
  rename(TreeID = Treeid, IdStem = Stemid, SubPlot=Plot,
         CensusYear = Censusyear, CensusDate = Censusdate, Dead = Mort,
         BotaCertainty = Botacertainty, ScientificName = Scientificname, Cod.CTFS=Codctfs) %>%
  mutate(Site = "Nouragues") %>%
  mutate(Plot = "Petit_Plateau") %>%
  mutate(ProjectArea = 6)

UnderstoryP <- UnderstoryP %>% 
  select(-"X.1") %>% 
  rename(Xutm = XTreeUTM, Yutm = YTreeUTM) %>% 
  rename(DBH = Diameter) %>% 
  rename(SubPlot = Subplot) %>%
  mutate(Plot = "16") %>% 
  mutate(ProjectArea = 9)

# "Diam_cirad"
```

# Strategy data (canopy vs understory species)
```{r}
# EFT2023_Understory/dcl.csv
strategy <- read_delim("~/PhD/Inventories/Data/Understory/Paracou/Species_strategy.csv") %>% 
  select(ScientificName, Strategy_VB) %>%
  rename(Strategy = Strategy_VB) %>% 
  unique()
unique(strategy$Strategy)

Understory <- list(UnderstoryP, UnderstoryN)
Understory <- lapply(Understory, function(x) left_join(x, strategy, by="ScientificName"))

UnderstoryP <- Understory[[1]]
UnderstoryN <- Understory[[2]]

sum(is.na(UnderstoryP$Strategy)) # 6871
sum(is.na(UnderstoryN$Strategy)) # 20005
```

# Checks
Vérifications :
- the 9 subplots (done)
- données manquantes (done)
- idStem uniques (done)
- noms d'espèces uniques A FAIRE
- DBH au même POM (1.30) ? que faire pour les ALT ? A FAIRE
- arbres cirad tous présents A TRAITER (attention arbres sans stem 1)
- joindre les infos manquantes des cirad (**DBH le plus récent**, bota, coordonnées)

# Only subplots of interest
P : c(13,14,15,18,19,20,23,24,25)
N : c(202,203,204,212,213,214)
```{r, eval = F}
unique(UnderstoryN$SubPlot)
all(UnderstoryP$SubPlot %in% c(13,14,15,18,19,20,23,24,25))
all(UnderstoryN$SubPlot  %in% c(202,203,204,212,213,214))
```

```{r}
data <- UnderstoryP
Adults <- AdultsP
```

# General Errors Detection
```{r}
source("~/PhD/R_codes/PhD/Inventory_scripts/Functions/GeneralErrorsDetection.R")

# rename columns for the function
Data <- data %>%
  select(-Comment) %>% # # remove previous Comments of my function of errors detection, Léa a gardé la colonne 
  rename(XTreeUTM=Xutm, YTreeUTM=Yutm, Diameter=DBH, Subplot=SubPlot)

Data <- GeneralErrorsDetection(Data)

Data %>% filter(Comment!="") %>% # 21311
  select(Comment, IdTree, IdStem, XTreeUTM, YTreeUTM, Family, Genus, Species, ScientificName, Diameter, Code_problem) 
```

## Missing data
```{r}
# unique(Data$Comment)

length(Data$Comment[grepl("Missing value in Species", Data$Comment)])/nrow(Data)*100 # 9%
length(Data$Comment[grepl("Missing value in Diameter", Data$Comment)])/nrow(Data)*100 # 0.2%
length(Data$Comment[grepl("TreeUTM", Data$Comment)])/nrow(Data)*100 # 0.4%
length(Data$Comment[grepl("Missing value in IdStem", Data$Comment)])/nrow(Data)*100 # 0.002%
```

## Unique IdStem
- Unique IdStem in the census
- Unique IdTree-IdStem association
- Unique IdStem-coordinates association
```{r}
length(Data$Comment[grepl("Duplicated 'IdStem'", Data$Comment)])/nrow(Data)*100 # 0.5%
length(Data$Comment[grepl("Duplicated row", Data$Comment)])/nrow(Data)*100 # 0%

Duplistems <- Data[grepl("Duplicated 'IdStem'", Data$Comment)] %>%
  select(IdTree, IdStem, ScientificName, Diameter, X,Y, Comment)

length(unique(Duplistems$IdTree))

# Data %>% filter(Comment!="") %>% # 21311
#   select(Comment, IdTree, IdStem, XTreeUTM, YTreeUTM, Family, Genus, Species, ScientificName, Diameter, Code_problem) 
```

```{r}
length(Data$Comment[grepl("Different coordinates", Data$Comment)])/nrow(Data)*100 # 0.009% (4 stems, 2 trees, 4 guyafor.nb.., 4 noms différents)
length(Data$Comment[grepl("Non-unique combination of IdTree and Guyafor.nb", Data$Comment)])/nrow(Data)*100 # 0.03% (12 idtree, 6 guyafor.nb)

diffcoord <- Data[grepl("Different coordinates", Data$Comment)]
```

# Bota
```{r}
# check if ScientificName is coherent with Genus and Species column ...
ScfcNamecheck <- Data %>% 
  unite(col = "ScfcName", c("Genus", "Species"),
        sep = "_", na.rm = TRUE, remove = F)

ScfcNamecheck %>% 
  select(IdTree,IdStem, Guyafor.nb, ScientificName,  Genus, Species, ScfcName, Comments, Comment) %>% 
  filter(ScientificName!= ScfcName)
```

```{r}
# Endilcheria multiflora est une erreur d'orthographe d'Endlicheria melinonii 
# Maytenus_oblongata -> Monteverdia_oblongata
# Eugenia.sp.FG9 vs Eugenia.sp.FG9-Holst  -> Eugenia.sp.FG9-Holst
# Garcinia.benthaminia vs Garcinia.benthamiana -> Garcinia.benthamiana

# Rinorea.idem181298 -> pas de bota au 18_1298
Data <- Data %>% 
  mutate(ScientificName = recode(ScientificName,
                                 "Endilcheria_multiflora" = "Endlicheria_melinonii",
                                 "Maytenus_oblongata" = "Monteverdia_oblongata",
                                 "Garcinia_benthaminia" = "Garcinia_benthamiana",
                                 "Eugenia_sp.FG9" = "Eugenia_sp.FG9-Holst",
                                 "Sloanea_sp.8" = "Sloanea_sp.8-CAY",
                                 "Sloanea_sp.14" = "Sloanea_sp.14-CAY",
                                 "Inga_sp.18" = "Inga_sp.18-CAY")) %>% 
  mutate(ScientificName = ifelse(ScientificName=="Caraipa_idem181381", Data[Data$IdTree=="18_1381"]$ScientificName,
                                 ScientificName)) %>%
  
  mutate(ScientificName = ifelse(ScientificName=="Annona_amboty", "Annona_ambotay", ScientificName)) %>%
  mutate(Species = ifelse(Species=="amboty"& Genus=="Annona", "ambotay", Species)) %>%
  
  mutate(Family = ifelse(Family=="Lecithidaceae", "Lecythidaceae", Family)) %>%
  mutate(Genus = ifelse(Genus=="Lecithidaceae", "Lecythidaceae", Genus)) %>%
  mutate(ScientificName = str_replace(ScientificName, "Lecithidaceae", "Lecythidaceae"))


source("~/PhD/R_codes/PhD/Inventory_scripts/Functions/BotanicalCorrection.R")
Data <- BotanicalCorrection(Data, DetectOnly = T)

length(Data$Comment[grepl("Different botanical informations", Data$Comment)])/nrow(Data)*100 # 0.02%

Botadiff <- Data %>%
  filter(grepl("Different botanical informations", Comment)) %>% # 8
  select(Comment, IdTree, IdStem, Guyafor.nb, Diameter, Family, Genus, Species, ScientificName, Code_problem)

Data[grepl("The family name does not end in 'aceae'", Data$Comment)] # 1

Data <- Data %>%
  mutate(ScientificName = ifelse(grepl("The family name does not end in 'aceae'", Comment), Family, ScientificName)) %>% 
  mutate(Family = ifelse(grepl("The family name does not end in 'aceae'", Comment), NA, Family)) %>% 
  mutate(Family = ifelse(ScientificName == "Symphonia_sp.1", "Clusiaceae", Family))

```

```{r, eval=F}
# Check the scientific names list
sort(unique(data$ScientificName))

# - genre_sp
# - genre_cf_espèce 
# - .subsp. 
# -.var.
# - _aff. c'est quoi ?
# - Rinorea_idem181298 (138 individus)
# attention ya un "Rinorea_idem181298"


data %>%
  # filter(grepl("_sp", ScientificName) & grepl("\\.", ScientificName)) %>%
  # filter(grepl("_cf_", ScientificName)) %>%
  filter(grepl("_aff", ScientificName) & grepl("\\.", ScientificName)) %>%
  # filter(grepl("subsp", ScientificName) & grepl("\\.", ScientificName)) %>%
  # filter(grepl("var", Species) & grepl("\\.", ScientificName)) %>%
  select(Species) %>% unique()

sp_abundances <- data %>%
  filter(!is.na(ScientificName)) %>%
  filter(ScientificName!="Tres haut") %>%
  filter(!grepl("indet", ScientificName)) %>%
  filter(!grepl("Indet", ScientificName)) %>%
  filter(!grepl("aceae", ScientificName)) %>%
  filter(!(grepl("_sp", ScientificName) & grepl("\\.", ScientificName))) %>% # only genus
  filter(!(grepl("_aff", ScientificName) & grepl("\\.", ScientificName))) %>% # identif not sure
  filter(!grepl("_cf_", ScientificName)) %>% # identif not sure
  mutate(ScientificName_c = sub("\\..*", "", ScientificName)) %>% 
  mutate(SubSpecies = str_extract(ScientificName,"(?<=\\.).*")) %>% 
  rename(ScientificName_old = ScientificName,
         ScientificName = ScientificName_c) %>% 
  group_by(ScientificName) %>%
  summarise(N = n()) %>%
  ungroup() # 557 sp

# write.csv(sp_abundances, "~/PhD/Inventories/Data/Understory/Paracou/Species_abundances.csv")
```

```{r}
unique(Data$Comment)

length(Data %>% filter(Comment!=""))/nrow(Data)*100 # 0.12%

Data %>% filter(Comment!="") %>% # 21 762
  select(Comment, IdTree, IdStem, XTreeUTM, YTreeUTM, Family, Genus, Species, ScientificName, Diameter, Code_problem)
```

# POM
```{r, eval = F}
length(Data$Comment[grepl("Missing value in POM", Data$Comment)])/nrow(Data)*100 # 45% without POM info

# small trees with POM!=130
DiffPOM <- data %>% 
  filter(DBH<10) %>%  filter(POM!=130) %>% select(DBH,POM) # 61/42,524 ind
range(DiffPOM$POM) # 120-190
range(DiffPOM$DBH) # 1-9.4

small <- data %>% 
  filter(DBH<10)

nrow(DiffPOM)/nrow(small)*100 # 0.16 % of small trees have POM!=130

ggplot(DiffPOM, aes(x=POM)) +
  geom_bar(width = 1)
```


# Check if the cirad trees are all in the understory inventories
Guyafor.nb = TreeFieldNum_SubPlot
IdTree = SubPlot_id
Subplot

- tous les arbres cirad

**! ALT et Guyafor n’ont pas exactement les même limites de subplot -> ils ne sont pas considérés dans le même subplot dans ALT et Guyafor..!**

## Guyafor.nb
```{r, eval=F}
data <- data %>% 
  mutate(CIRADid= tstrsplit(Guyafor.nb, split = "_")[[1]]) %>% #1er elmt  
  mutate(CIRADplot= tstrsplit(Guyafor.nb, split = "_")[[2]]) %>%  #2nd
  mutate(subplot = tstrsplit(IdTree, split = "_")[[1]]) %>% #1er elmt  
  mutate(ID = tstrsplit(IdTree, split = "_")[[2]]) #2nd


all(na.omit(data$CIRADplot == data$SubPlot)) # il ya des erreurs dans les n° de subplots des identifiants cirad
data %>% filter(CIRADplot != SubPlot) # 27 cirad trees with different subplot informations
all(na.omit(data$subplot == data$SubPlot)) # pas d'erreur dans les n° de subplots des IdTree

Adults <- Adults %>% 
  filter(CodeAlive == T) %>%
  unite(col = "CIRAD", c("TreeFieldNum", "SubPlot"), # ! ALT et Guyafor n’ont pas exactement les même limites de subplot -> ils ne sont pas considérés dans le même subplot dans ALT et Guyafor..!.
        sep = "_", na.rm = F, remove = F) %>% 
  mutate(CIRAD = gsub("[[:space:]]", "", CIRAD)) %>%
  mutate(CIRAD = str_squish(CIRAD)) # remove double spaces

data <- data %>% 
  unite(col = "CIRAD", c("CIRADid", "SubPlot"),
        sep = "_", na.rm = F, remove = F) %>% 
  mutate(CIRAD = gsub("[[:space:]]", "", CIRAD)) %>% 
  mutate(CIRAD = str_squish(CIRAD)) # remove double spaces

Adults$CIRAD %in% data$CIRAD | Adults$CIRAD %in% data$Guyafor.nb # Guyafor.nb has some different subplot number than SubPlot

MissingCirad <- Adults %>% 
  filter(!(CIRAD %in% data$CIRAD|CIRAD %in% data$Guyafor.nb)) # 241

length(unique(MissingCirad$CIRAD)) # 241 cirad trees oubliés
unique(MissingCirad$SubPlot) %in% c(13,14,15,18,19,20,23,24,25)
length(unique(data$CIRAD)); length(unique(Adults$CIRAD))- length(unique(data$Guyafor.nb))
MissingCirad %>% filter(CodeAlive==F) # no dead trees

all(data[!is.na(data$Guyafor.nb),]$Stem.nb==1) # cirad stem id
stems <- data[!is.na(data$Guyafor.nb) & data$Stem.nb!=1,]$Guyafor.nb # cirad stem id >1
stem1 <- data[data$Guyafor.nb %in% stems & data$Stem.nb==1,]$Guyafor.nb # cirad stem id == 1

#!! cirad trees without stem 1 !! 
stems[!stems %in% stem1] # 1 cirad with multiple stems but without a stem 1
```

# Missing cirad positions
```{r, eval=F}
data_sf <- data %>% 
  mutate(CIRAD = ifelse(!is.na(Guyafor.nb), T, F)) %>% 
  select(IdStem, CIRAD, SubPlot, Xutm, Yutm) %>% na.omit() %>% 
  mutate(SubPlot = as.factor(SubPlot)) %>% 
  st_as_sf(coords = c("Xutm", "Yutm"))

missingCIRAD_sf <- MissingCirad %>% 
  # select(IdStem, CIRAD, SubPlot, Xutm, Yutm) %>% na.omit() %>% 
  # mutate(SubPlot = as.factor(SubPlot)) %>% 
  st_as_sf(coords = c("Xutm", "Yutm"))


ggplot() +
  geom_sf(data=missingCIRAD_sf, aes(fill="missingCIRAD"), size = 0.5) +
  geom_sf(data=data_sf, aes(col=SubPlot), size = 0.5) +
  scale_fill_manual(name = "Missing CIRAD trees",
                    values = c("missingCIRAD" = "black")) +
  theme_classic()

ggsave(paste("ALT", unique(data$Site), unique(data$Plot),"missingCIRAD.png", sep="_"), path = "D:/Mes Donnees/PhD/Figures/inventory", width = 30, height = 20, units = "cm", dpi=800, bg="white")


for(p in c(13,14,15,18,19,20,23,24,25)){
  
  missing <- missingCIRAD_sf %>% 
    filter(SubPlot== as.character(p))
  
  print(
    data_sf %>% 
      filter(SubPlot== as.character(p)) %>% 
      ggplot() +
      geom_sf(data=missing, col="black", size = 1) +
      geom_sf(aes(col=CIRAD),size = 1.5) +
      theme_classic() +
      labs(title = paste("Plot",p))
  )
}
```

# Stem number
```{r}
#!! ATTENTION trees without stem 1 !!
length(Data$Comment[grepl("Trees without stem 1", Data$Comment)])/nrow(Data)*100 # 0.02%
```

# Remove doubtful rows
- Duplicated IdStem: 0.5% (209 rows, 52 trees) -> virer que si le nom bota ou le DBH est diff, s’il est le même en garder 1  
- Different botanical informations (Family, ScientificName) for a same IdTree: 0.02%  (8 trees)  
- Different coordinates (XTreeUTM, YTreeUTM) for a same 'IdStem' :  0.009% (4 stems, 2 trees, 4 guyafor.nb.., 4 noms différents)  

```{r}
start <- nrow(UnderstoryP)
startsp <- length(unique(UnderstoryP$ScientificName))

Data %>% 
  filter(grepl("Different botanical informations", Comment) | grepl("Different coordinates", Comment)) %>% 
  select(IdTree, IdStem, Guyafor.nb, ScientificName, X, Y, Comment)

Data <- Data %>% 
  filter(!grepl("Different botanical informations", Comment)) %>% 
  filter(!grepl("Different coordinates", Comment)) # 4 rows, 2 trees

filt <- nrow(Data)
filtsp <- length(unique(Data$ScientificName))
start-filt # 8 lignes pcq info bota et coordonnées incohérentes
startsp-filtsp # 3 sp pcq info bota et coordonnées incohérentes


Duplistempurge <- Data %>% 
  filter(grepl("Duplicated 'IdStem'", Comment)) %>% # 205
  group_by(IdStem) %>% 
  filter(length(table(ScientificName, useNA="no"))==1 & length(table(Diameter, useNA="no"))==1) %>% # remove incoherant rows -> 191 (14 rows removed)
  # select(IdTree, IdStem, Guyafor.nb, ScientificName, X, Y, Diameter, Comment) %>% 
  ungroup() %>% 
  distinct(IdTree, IdStem, Guyafor.nb, ScientificName, X, Y, Diameter, .keep_all = T) %>% # remove duplicates -> 88 (103 rows removed)
  mutate(Comment = str_replace(Comment, "Duplicated 'IdStem' in the census/", "")) # actualise comment column

length(unique(Duplistempurge$IdStem)) == nrow(Duplistempurge) # if T IdStem are now unique
any(is.na(Duplistempurge$ScientificName)) | any(is.na(Duplistempurge$Diameter)) # if F no NA to manage

Data <- Data %>% # 42452
  filter(!grepl("Duplicated 'IdStem'", Comment)) %>% 
  bind_rows(Duplistempurge)

filtdupli <- nrow(Data)
filtduplisp <- length(unique(Data$ScientificName))
filt-filtdupli # 117 lignes enlevées pour gérer les idstems dupliqués
filtsp-filtduplisp # 0 sp enlevées pour gérer les idstems dupliqués

nrow(Data)/nrow(UnderstoryP)*100 # il reste 99.7% par rapport au jeu de donnée brut


```

```{r}
data <- Data %>% 
  rename(DBH=Diameter, Xutm = XTreeUTM, Yutm = YTreeUTM) # %>%
# Only measured trees
# filter(!is.na(DBH))

```

# Detect real and not sure multistems
on ne se fie qu'au DBH et aux idTree, la numérotation des stems contient des erreurs  
Multistem = for a same idtree: 
- T : number of different DBH values >1, same ScientificName and coordinates, all duplicated the same times number (it can be 0 duplication)  
- F :  only 1 measurement   
- NA : the rest (soit pas même ScientificName ou coordonnées, soit memes DBHs pour tout l'idTree, soit certains DBH sont dupliqués mais pas tous)  
```{r}
data <- data %>% 
  group_by(IdTree) %>% 
  # TRUE for real multistems: number of different DBH values >1, same ScientificName and coordinates, all duplicated the same times number
  mutate(Multistem = ifelse(length(table(DBH)) > 1 & # number of different DBH values >1
                              # same ScientificName and coordinates
                              length(unique(ScientificName))==1 & length(unique(Xutm))==1 & length(unique(Yutm))==1 & 
                              # all duplicated the same times number
                              length(unique(table(DBH))) == 1, T, NA)) %>%
  mutate(Multistem = ifelse(n()==1, F, Multistem)) %>% # only 1 measurement -> not multistem
  ungroup()

# According to the Comments -------
falsemultistem <- (data %>% filter(grepl("False pas double tige", Comments)))$IdTree
data <- data %>% 
  mutate(Multistem = ifelse(IdTree==falsemultistem, F, Multistem)) %>%  
  mutate(Stem.nb = ifelse(IdTree==falsemultistem, 1, Stem.nb)) %>%  
  mutate(IdTree = ifelse(IdTree==falsemultistem, c("18_1761", "falseM"), IdTree)) %>% 
  mutate(IdStem = ifelse(IdTree=="falseM", "falseM_1", IdStem))

data <- data %>% 
  mutate(Multistem = ifelse(grepl("Rejet", Comments), T, Multistem)) 


# Les NA : multistem_not sure !! -------
test4 <- data %>% 
  filter(is.na(Multistem)) # the not sure cases (105) (soit pas même ScientificName ou coordonnées, soit memes DBHs pour tout l'idTree, soit certains DBH sont dupliqués mais pas tous)
# Est-ce que je peux considérer que coctfs = M = multistem sure ?

# write.csv(test4, "~/PhD/Inventories/Data/Understory/Paracou/Problems/Multistems_notsure.csv")
length(unique(test4$IdTree)) # 31 trees

```

# Multistems %
```{r}
# Sure multistem
nrow(data %>% 
       filter(Multistem & !is.na(Multistem)))/nrow(data)*100 # 2.9% 
stemssup1 <- data %>% 
  filter(Multistem & !is.na(Multistem)) %>% filter(Stem.nb>1) # tiges surnuméraires
range(stemssup1$DBH) # 0.9 10.2

stem1 <- data %>% 
  filter(Multistem & !is.na(Multistem)) %>% filter(Stem.nb==1) # tiges surnuméraires
range(stem1$DBH) # 1.0 45.9


# unique(data$Cod.CTFS)

# Cod.CTFS M
nrow(data %>% 
       filter(grepl("M", Cod.CTFS)))/nrow(data)*100 # 3.2%

stemssup1 <- data %>% 
  filter(grepl("M", Cod.CTFS)) %>% filter(Stem.nb>1)
range(stemssup1$DBH)

# not sure multistem
nrow(data %>% 
       filter(is.na(Multistem)))/nrow(data)*100 # 0.2%
```


# Manage multistems (sum the basal area, and keep only 1 stem) (Stem.nb pas codé)
```{r}
# pas codé si Stem.nb bien codé (1, 2, n)
# unique(data$Comment) 
# unique(data$Comments)

Multistems_notsure <- data %>% # 100
  filter(is.na(Multistem)) %>% 
  select(IdTree, IdStem, Guyafor.nb, Stem.nb, DBH, ScientificName, Comment, Comments) %>% 
  # distinct(IdTree, IdStem, Guyafor.nb, ScientificName, DBH, .keep_all = T) %>% # tjrs 100
  mutate(BasalArea = pi*(DBH/2)^2) %>% 
  group_by(IdTree) %>% 
  arrange(desc(DBH)) %>% 
  mutate(Stem.nb = 1:n()) %>% # numérote les stems par ordre décroissant de DBH
  unite(col = "IdStem", c("IdTree", "Stem.nb"), # recode the IdStem
        sep = "_", na.rm = TRUE, remove = F) %>% # numérote les stems par ordre décroissant de DBH
  mutate(BasalAreacor = sum(BasalArea)) %>% # somme des surfaces terrières
  ungroup() %>% 
  mutate(DBHcor = 2*sqrt(BasalAreacor/pi)) %>% 
  mutate(Diff= DBHcor-DBH)

length(unique(Multistems_notsure$IdStem)) # 100 stems
length(unique(Multistems_notsure$IdTree)) # 31 trees
range((filter(Multistems_notsure, Stem.nb==1))$Diff, na.rm=T) # 0.4142136 1.4272992 -> ça change pas grand chose


Multistems <- data %>% # 1 332
  # filter(Multistem & !is.na(Multistem)) %>% # only sure multistems
  filter(Multistem | is.na(Multistem)) %>% # sure and not sure multistems
  # distinct(IdTree, IdStem, DBH, .keep_all = T) %>% # Résolution cas 2: remove duplicates (dupliidstems déjà réglé au dessus)
  mutate(BasalArea = pi*(DBH/2)^2) %>% 
  group_by(IdTree) %>% 
  arrange(desc(DBH)) %>% 
  mutate(Stem.nb = 1:n()) %>% # numérote les stems par ordre décroissant de DBH
  unite(col = "IdStem", c("IdTree", "Stem.nb"), # recode the IdStem
        sep = "_", na.rm = TRUE, remove = F) %>% # numérote les stems par ordre décroissant de DBH
  mutate(BasalAreacor = sum(BasalArea)) %>% # somme des surfaces terrières
  mutate(DBHcor = 2*sqrt(BasalAreacor/pi)) %>% 
  arrange(desc(DBHcor)) %>% 
  fill(Xutm, Yutm, X, Y,
       Guyafor.nb,
       ScientificName, Genus, Species, Family,
       .direction = "downup") %>% 
  ungroup() 
# select(IdTree, Guyafor.nb, Stem.nb, DBH, DBHcor, ScientificName, Comment, Comments)



# unique(Multistems$Comment)
# Different botanical informations (Family, ScientificName) for a same IdTree"
# Missing value in XTreeUTM
# Missing value in Species
# unique(Multistems$Comments) # attention "False pas double tige" (traité)

# write.csv(test, "D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/Multistems_DBHcor.csv")

data <- data %>% 
  # filter(!(Multistem | is.na(Multistem))) %>% # supprimer les Multistem=T ou NA (40997)
  filter(!Multistem | is.na(Multistem)) %>% # supprimer les Multistem=T (40997)
  mutate(DBHcor = DBH) %>%
  bind_rows(Multistems)

nrow(data)== nrow(Data)
```

# % de multistems par sp d'intérêt ?
```{r}
Sp <- (read.csv("D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/InterestSpecies.csv")[,2]) # 86

multistem_interest <- data %>% 
  filter(ScientificName %in% Sp) %>% 
  group_by(ScientificName) %>% 
  mutate(N = n()) %>% 
  ungroup() %>% 
  mutate(MultistemInterest = ifelse(Multistem & !is.na(Multistem), T, F)) %>%
  group_by(ScientificName, MultistemInterest) %>% 
  mutate(N_multistems = n()) %>% 
  mutate(`Multistems%` = (N_multistems/N)*100) %>% 
  ungroup() %>% 
  select(ScientificName, MultistemInterest, N, N_multistems, `Multistems%`) %>% 
  unique() %>% 
  mutate(MultistemInterest = ifelse(`Multistems%`==100, T, MultistemInterest)) %>%
  mutate(N_multistems = ifelse(`Multistems%`==100, 0, N_multistems)) %>%
  mutate(`Multistems%` = ifelse(`Multistems%`==100, 0, `Multistems%`)) %>%
  filter(MultistemInterest) %>% 
  mutate(N_withoutMultistems = N-N_multistems)
# 59 sp / 86
ggplot(multistem_interest, aes(x=`Multistems%`)) +
  geom_histogram(binwidth=1, fill="#69b3a2", color="#e9ecef") +
  labs(x = "Multistems % in each species of interest")

write.csv(multistem_interest,
          "D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/Multistems%_per_interest_species.csv")
```

# Rrépartition spatiale des multistems
```{r}
TopoLevels <- st_read("D:/Mes Donnees/PhD/SIG_data/Topo_P16_4classes/Topo4Levels.shp") %>% 
  filter(Plot==16) %>% mutate(TopoTypeEn = ifelse(idTopo ==38, "Lower slope", TopoTypeEn))

Multistem_plot <- data %>% 
  filter(ScientificName %in% Sp) %>% 
  filter(Stem.nb ==1) %>% 
  filter(!is.na(Xutm)) %>% 
  filter(!is.na(Yutm)) %>% 
  st_as_sf(coords = c("Xutm", "Yutm")) %>% 
  st_set_crs(st_crs(TopoLevels))

ggplot() +
  geom_sf(data = TopoLevels, aes(fill = TopoTypeEn), alpha = 0.5) +
  geom_sf(data = Multistem_plot %>% 
            filter(Multistem & !is.na(Multistem)), size = 3, aes(col= Genus)) + # , aes(col= Genus)
  scale_fill_manual(values = c("Plateau" = "#009E73",
                               "Slope"= "#E7B800",
                               "Lower slope"= "#bfe6eb",
                               "Bottomland" = "#1f78b4")) +
  theme_classic() +
  labs(fill= "Topography")

ggplot() +
  geom_sf(data = TopoLevels, aes(fill = TopoTypeEn), alpha = 0.3) +
  geom_sf(data = Multistem_plot %>% 
            filter(ScientificName %in% c("Abuta_grandifolia", "Guarea_costata", "Tabernaemontana_macrocalyx", "Miconia_argyrophylla")), size =0.5, aes(col= Multistem)) + # , aes(col= Genus)
  scale_fill_manual(values = c("Plateau" = "#009E73",
                               "Slope"= "#E7B800",
                               "Lower slope"= "#bfe6eb",
                               "Bottomland" = "#1f78b4")) +
  theme_void() +
  guides(fill = FALSE) +
  # labs(title = S) +
  facet_wrap(~ ScientificName)

ggsave("Multistems_sup5%_interest_species.png", path = "D:/Mes Donnees/PhD/Figures/inventory/",
       width = 15, height = 10, units = "cm", dpi=800, bg="white")
```

# Write cleaned data
**! vérifier que si ya DBH ya DBHcor !**
```{r}
nrow(data) # 42335
length(unique(data$ScientificName)) # 678
```

# Filters for my analyses
DBH>=1
Only alive trees
Only the principal stem
Only measured trees
Only spatialised trees
```{r}
# test <- data %>% 
#   # & DBH<10 only ALT data for the moment
#   filter(DBH>=1 & is.na(Guyafor.nb)& DBH>20 & 
#            # Family!="Arecaceae" & Comment != "PALMIER" &
#            !Code_problem %in% c("No_num_cirad", "Not_ided", "CheckID"))

data_filtred <- data %>% 
  # & DBH<10 only ALT data for the moment
  filter(DBH>=1 & is.na(Guyafor.nb) & DBH<20 &
           !grepl("num_cirad", Code_problem)) %>% # filter ce qui a un guyafor.nb pas bcp plus grand que 10 cm (recrus) (pas sous le critère <10 cm dbh pcq recrus) -> reste 88% par rapport aux filtres précédents
  # Only alive trees
  filter(Dead == F) %>% # filter(CodeAlive == T) %>%
  # Only measured trees
  filter(!is.na(DBH)) %>% 
    # Only spatialised trees
  filter(!is.na(Xutm) & !is.na(Yutm)) %>% # -> reste 87% par rapport aux filtres précédents
  # Only the principal stem
  filter(Stem.nb == 1)

nrow(data_filtred)/nrow(data)*100 # il reste 86% par rapport aux filtres précédents
nrow(data_filtred)/nrow(UnderstoryP)*100 # il reste 86% par rapport au jeu de donnée brut
```

# Write cleaned data
```{r}
nrow(data_filtred) # 36338
length(unique(data_filtred$ScientificName)) # 576

write.csv(data_filtred, "D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/ALT_Paracou_9ha_CLEAN.csv")
```

# Species selection
Only botanical identified
Take only sp >= 30 ind
```{r}
SpeciesA <- (read.csv("~/PhD/Inventories/Data/Adults/Paracou/AdultsP16_species_filtred.csv")[,2]) # 64

spSelection <- data_filtred %>% 
  rowwise() %>% 
  filter(ScientificName %in% SpeciesA | Strategy=="Understory species") %>%
  ungroup() %>% 
  # Only botanical identified
  filter(!is.na(ScientificName)) %>%
  # filter(ScientificName!="Tres haut") %>% # pas nécessaire
  # filter(!grepl("indet", ScientificName)) %>%
  # filter(!grepl("Indet", ScientificName)) %>%
  # filter(!grepl("aceae", ScientificName)) %>%
  # filter(!(grepl("_sp", ScientificName) & grepl("\\.", ScientificName))) %>% # garder les sp.numéro ?
  # filter(!(grepl("_aff", ScientificName) & grepl("\\.", ScientificName))) %>%
  # filter(!grepl("_cf_", ScientificName)) %>%
  # mutate(ScientificName_c = sub("\\..*", "", ScientificName)) %>% 
  # mutate(SubSpecies = str_extract(ScientificName,"(?<=\\.).*")) %>% 
  # rename(ScientificName_old = ScientificName,
  #        ScientificName = ScientificName_c) %>% 
  
  # attention Rinorea_idem181298 (138 individus)
  # Count individuals by species
  group_by(ScientificName) %>% 
  mutate(N = n()) %>% 
  ungroup() %>% 
  # Take only sp >= 30 ind
  filter(N >= 30)

# Lianes : Tabernaemontana_macrocalyx ?
# il reste des infos douteuses dans les colonnes de Léa A GERER
  
unique(spSelection$Comment) # C'est le Symphonia.sp1 qui était initialment dans Family
SpeciesA[!SpeciesA %in% spSelection$ScientificName]
# "Chrysophyllum_prieurii" : DBH >10 uniquement
# "Caryocar_glabrum" "Eperua_rubiginosa" "Oenocarpus_bataua" "Goupia_glabra"         
# "Carapa_surinamensis"  "Sterculia_speciosa""Siparuna_decipiens" "Theobroma_guianense"


Sp <- spSelection %>% 
  select(ScientificName, Family, N) %>% unique() %>% arrange(desc(N)) # 75
length(unique(Sp$Family)) # 28 families

write.csv(Sp, "D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/InterestSpecies.csv")
```


# Mis de coté pour l'instant (gestion noms scientifiques)
```{r, eval = F}
Understory <- Understory %>% 
  mutate(ScientificName = str_squish(ScientificName)) %>% # remove double spaces
  mutate(ScientificName = ifelse(ScientificName=="Astrocaryum sciophylum", "Astrocaryum sciophilum", ScientificName)) %>% 
  mutate(ScientificName = ifelse(ScientificName=="Micropholis guyanensis subsp.Duckeana", "Micropholis guyanensis_subsp.duckeana", ScientificName))

Adults <- Adults %>% 
  # add a column identifying the two datasets
  add_column(Dataset = "Standard") %>%
  # idTree as character
  mutate(idTree = as.character(idTree)) %>% 
  # Circ to DBH
  mutate(DBH = CircCorr/pi) %>% 
  select(Dataset, idTree, Family, Genus, Species, DBH, MeasCode, CodeAlive, Xutm, Yutm)


# Join the 2 datasets
Total_inv <- bind_rows(Understory, Adults) %>% 
  # Only alive trees
  filter(CodeAlive == T) %>%
  # Create the ScientificName column
  unite(col = "ScientificName", c("Genus", "Species"),
        sep = "_", na.rm = TRUE, remove = F) %>%
  mutate(ScientificName = ifelse(ScientificName=="", NA, ScientificName)) %>% 
  mutate(ScientificName = str_squish(ScientificName)) %>% # remove double spaces
  mutate(ScientificName = ifelse(ScientificName=="Astrocaryum sciophylum", "Astrocaryum sciophilum", ScientificName)) %>% 
  mutate(ScientificName = ifelse(ScientificName=="Micropholis guyanensis subsp.Duckeana", "Micropholis guyanensis_subsp.duckeana", ScientificName))

# unique individuals
length(Total_inv$idTree) # 45997
unique(length(Total_inv$idTree)) # 45997

# Conceveiba  guianensis
# unique(Total_inv$ScientificName)

```

# Obsolete
```{r, eval = F}
# Understory <- Understory %>% 
#   select(-"...1" ) %>% 
#   unique() %>% 
#   
#   # Standardise columns names
#   rename(idTree = TreeID) %>% 
#   rename(Species = species) %>% 
#   rename(SubPlot = subplot) %>%
#   rename(CIRAD1 = CIRAD.BigTreeID) %>%
#   mutate(CodeAlive = as.logical(recode(Dead,
#                                        "FALSE" = "TRUE",
#                                        "FAUX" = "TRUE",
#                                        "(false)" = "TRUE",
#                                        "TRUE" = "FALSE",
#                                        "VRAI" = "FALSE"))) %>% 
#   # remove parentheses
#   mutate(Genus = gsub("[()]", "", Genus)) %>% 
#   mutate(Family = gsub("[()]", "", Family)) %>% 
#   
#   # add a column identifying the two datasets
#   add_column(Dataset = "ALT") %>% 
#   
#   # Create the ScientificName column
#   unite(col = "ScientificName", c("Genus", "Species"),
#         sep = " ", na.rm = TRUE, remove = F) %>%
#   mutate(ScientificName = ifelse(ScientificName=="", NA, ScientificName)) %>% 
#   mutate(ScientificName = str_squish(ScientificName)) %>% # remove double spaces
#   mutate(ScientificName = ifelse(ScientificName=="Astrocaryum sciophylum", "Astrocaryum sciophilum", ScientificName)) %>% 
#   mutate(ScientificName = ifelse(ScientificName=="Micropholis guyanensis subsp.Duckeana", "Micropholis guyanensis_subsp.duckeana", ScientificName)) %>% 
#   
#   # Only the needed columns
#   select(Dataset, SubPlot, Stem.number, idTree, CIRAD1, ScientificName, Family, Genus, Species, DBH, POM, CodeAlive, Xutm, Yutm)
```

!! ATTENTION !! il y a des dupliqués : différents DBH pour le meme idTree et la meme stem
```{r, eval = F}
# unique(Understory$Dead)
# 
# Understory <- Understory %>% 
#   select(-"...1" ) %>% 
#   unique() %>%
#   filter(DBH>=1) %>% 
#   rename(idTree = TreeID) %>% 
#   rename(Species = species) %>% 
#   rename(SubPlot = subplot) %>% 
#   # rename(CodeAlive = Dead) %>% 
#   mutate(CodeAlive = as.logical(recode(Dead,
#                                        "FALSE" = "TRUE",
#                                        "FAUX" = "TRUE",
#                                        "(false)" = "TRUE",
#                                        "TRUE" = "FALSE",
#                                        "VRAI" = "FALSE"))) %>% 
#   # remove parentheses
#   mutate(Genus = gsub("[()]", "", Genus)) %>% 
#   mutate(Family = gsub("[()]", "", Family))

# test <- select(Understory, Dead, CodeAlive)
```
