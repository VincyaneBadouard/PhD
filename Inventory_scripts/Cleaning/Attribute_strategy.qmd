---
title: "Attribute_strategy"
format: html
editor: source
---

Methode Giacomo :   
Espèces de sous-bois = toutes les espèces dont 95% des individus ont un DBH inférieur à 15cm sur l'ensemble de la base de données Guyafor.  
Espèce de canopée = toutes les espèces qui ont des individus >= 20 cm DBH.  

Autre idée de méthode : "Néanmoins, il existe (au moins) une autre façon de classer les espèces en sous-bois ou en canopée. Nous en avons discuté avec Stuart Davies et Geraldine. Cette méthode calcule avec une estimation bayésienne le taux de croissance et la mortalité de chaque espèce et crée ensuite un groupe comprenant également la hauteur maximale."  

Autre idée de méthode : créer une troisième classe (mid-canopy) pour capturer plus de variation, ou même de faire une variable continue basée sur le DBH médian

J'ai pris toute la base de donnée Guyafor (1968-2024) pour avoir le DBHmax de l'espèce et intégré "toutes les espèces qui ont des individus >= 20 cm DBH -> espèce de canopée"
Et pour calculer le quantile à 95% j'ai pris la dernière mesure de chaque arbre dans tout Guyafor et considéré que les inventaires à partir de 2020 (pcq les inventaires de chaque site n'est pas fait au même moment)
tout ça sans ALT du coup.
Et pour les espèces de ALT qui n'étaient pas dans Guyafor , j'ai calculé leur DBHmax et leur Q95% à l'échelle de ALT uniquement.  

-> ok pour cette méthode stratégie de l’spcar utilisée uniquement pour la selection d'espèce

# Packages
```{r Setup, include = F}
library(tidyverse)
library(data.table)
library(readr)
library(sf)
```

```{r,include = F, message=F}
# Endlicheria_multiflora est une erreur d'orthographe d'Endlicheria_melinonii 
# Maytenus_oblongata -> Monteverdia_oblongata
Understory <- 
  read_csv("~/PhD/Inventories/Data/Understory/Paracou/ALT_Paracou9ha_20250107.csv") %>%  # last raw data
  mutate(ScientificName = recode(ScientificName,
                                 "Endlicheria_multiflora" = "Endlicheria_melinonii",
                                 "Maytenus_oblongata" = "Monteverdia_oblongata"))


SpeciesALT <- unique(Understory$ScientificName) # 688
SpeciesALT <- SpeciesALT[!is.na(SpeciesALT) & !grepl("indet", SpeciesALT) & !grepl("Indet", SpeciesALT) & !grepl("aceae", SpeciesALT) & !(grepl("_sp", SpeciesALT) & grepl("\\.", SpeciesALT)) & !(grepl("_aff", SpeciesALT) & grepl("\\.", SpeciesALT)) & !grepl("_cf_", SpeciesALT) 
]
SpeciesALT <- sort(SpeciesALT)




# Guyafor <- vroom::vroom("~/PhD/Inventories/Data/Adults/AllGuyafor.csv") %>% 
#   filter(!(Plot=="16" & SubPlot %in% c(13,14,15,18,19,20,23,24,25))) %>% # without ALT
#   select(Genus, Species, CircCorr, Circ) %>% 
#   unite(col = "ScientificName", c("Genus", "Species"),
#         sep = "_", na.rm = TRUE, remove = F) %>%
#   filter(!grepl("indet", ScientificName)) %>%
#   filter(!grepl("Indet", ScientificName)) %>%
#   mutate(Diameter = ifelse(!is.na(CircCorr), CircCorr/pi, Circ/pi)) %>% 
#   select(ScientificName, Diameter) %>% 
#   filter(ScientificName %in% Species)
# 
# data <- bind_rows(Understory, Guyafor)
# nrow(data) == (nrow(Understory) + nrow(Guyafor))
# rm(Guyafor)
```


```{r}
Guyafor <- vroom::vroom("~/PhD/Inventories/Data/Adults/AllGuyafor.csv")

data <- Guyafor %>% 
  select(Forest, CensusYear, idTree, Genus, Species, CircCorr, Circ) %>% 
  unite(col = "ScientificName", c("Genus", "Species"),
        sep = "_", na.rm = TRUE, remove = F) %>%
  filter(!grepl("indet", ScientificName)) %>%
  filter(!grepl("Indet", ScientificName))

length(na.omit(unique(data$ScientificName))) # 1169

data <- data %>%
  
  # Only ALT species
  filter(ScientificName %in% SpeciesALT) %>% 
  
  mutate(Diameter = ifelse(!is.na(CircCorr), CircCorr/pi, Circ/pi)) %>% 
  
  # DBHmax on all Guayfor (1968-2024)
  group_by(ScientificName) %>% 
  mutate(DBHmax = max(Diameter, na.rm=T)) %>% 
  ungroup() %>% 
  
  # Take the last measurement of each tree (Giacomo a pris ts les census)
  group_by(idTree) %>% 
  mutate(maxYear = max(CensusYear, na.rm = T)) %>% 
  ungroup() %>% 
  filter(CensusYear == maxYear) %>%
  # filter(CensusYear>=2020) %>% # take all to maximise rare species
  select(Forest, CensusYear, maxYear, ScientificName, Diameter, DBHmax) 

# sort(unique(data$CensusYear))

```

```{r, include=F}
strategy <- read_delim("~/PhD/Inventories/EFT2023_Understory/dcl.csv", # Giacomo data (437)
                       delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  select(genre_esp, Strategy) %>%
  rename(ScientificName = genre_esp) %>%
  mutate(Strategy = ifelse(Strategy== "#N/A", NA, Strategy)) %>%
  mutate(Strategy = recode(Strategy, "TallSp" = "Canopy species" , "UnderstorySp" = "Understory species")) %>% 
  unique()
unique(strategy$Strategy)

```


```{r}
test <- data %>% 
  group_by(ScientificName) %>% 
  mutate(N = n()) %>% 
  mutate(Q95 = quantile(Diameter, 0.95, na.rm=T)) %>% 
  # mutate(DBHmax = max(Diameter, na.rm=T)) %>% # déjà fait pour tt Guyafor
  mutate(Strategy = ifelse(Q95 <15, "Understory species", "Canopy species")) %>% 
  mutate(Strategy = ifelse(DBHmax>=20, "Canopy species", Strategy)) %>% 
  ungroup() %>% 
  select(ScientificName, N, Q95, DBHmax, Strategy) %>% 
  unique() %>% 
  mutate(Origine = "Guyafor") # 688 ; 1377 with guyafor

# Species in ALT and not in Guyafor
ALTonlysp <- Understory %>% 
  filter(!is.na(Diameter)) %>% 
  filter(!ScientificName %in% test$ScientificName & (ScientificName %in% SpeciesALT)) %>% 
  group_by(ScientificName) %>% 
  mutate(N = n()) %>% 
  filter(N>=30) %>%
  mutate(Q95 = quantile(Diameter, 0.95, na.rm=T)) %>% 
  mutate(DBHmax = max(Diameter, na.rm=T)) %>% 
  mutate(Strategy = ifelse(Q95 <15, "Understory species", "Canopy species")) %>% 
  mutate(Strategy = ifelse(DBHmax>=20, "Canopy species", Strategy)) %>% 
  ungroup() %>% 
  select(ScientificName, N, Q95, DBHmax, Strategy) %>% 
  unique() %>% # 214
  mutate(Origine = "ALTonly")

test <- bind_rows(test, ALTonlysp)

```

```{r}
check <- test %>% left_join(strategy, by="ScientificName", suffix = c("_VB", "_GS")) %>% 
  mutate(Strategy_VB = ifelse(Strategy_GS=="liane", Strategy_GS, Strategy_VB)) 
```

# Modulo des sp qui ne respectent pas cette méthode
*Talisia_guianensis* is definitely un understory, it fruits at 1.5m tall and 1cm DBH! 

*Protium_pilosum*  this is known to be tall up to 12m, a real understory  

*Talisia_sylvatica* All IDs come form BAFOG, and all are in BotaCertainty '3', not sure we can say these are really T. sylvatica. Also, flowering samples, from the herbarium, are noted as "small trees". I'd keep it in Understory  

*Votomita_guianensis* : but i think these are misidentifications: Votomita guyanensis is an understory treelet even to Aublet in 1775 (https://www.biodiversitylibrary.org/page/362067#page/125/mode/1up 6 feet tall)

*Miconia_plukenetii* c'est une plante « pas strictement du sous-bois »

Source : Giacomo Sellan

```{r}
check <- check %>% 
  mutate(Strategy_VB = ifelse(
    ScientificName %in% c("Talisia_guianensis", "Protium_pilosum", "Talisia_sylvatica", "Votomita_guianensis"),
    "Understory species", Strategy_VB))

# check <- check %>% 
#   mutate(Strategy_VB = case_when(
#     ScientificName == "Talisia_guianensis" ~ "Understory species",
#     ScientificName == "Protium_pilosum" ~ "Understory species",
#     ScientificName == "Talisia_sylvatica" ~ "Understory species",
#     ScientificName == "Votomita_guianensis" ~ "Understory species",
#     .default = Strategy_VB) # le reste reste comme c'est
#   )

check %>%
  filter(ScientificName %in% c("Talisia_guianensis", "Protium_pilosum", "Talisia_sylvatica", "Votomita_guianensis"))
```

```{r}
mismatch <- test %>% left_join(strategy, by="ScientificName", suffix = c("_VB", "_GS")) %>% 
  filter(Strategy_VB != Strategy_GS) %>% # 15 non-NA  | is.na(Strategy_GS)
  arrange(N) %>% 
  filter(N>=30)

mismatch # validé par Giacomo

write.csv(mismatch, "~/PhD/Inventories/Data/Understory/Paracou/Problems/Strategy_mismatch.csv")
```


```{r}
write.csv(check, "~/PhD/Inventories/Data/Understory/Paracou/Species_strategy.csv")
```

