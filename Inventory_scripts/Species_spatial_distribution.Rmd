---
title: "Spatial distribution of species"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: pdf_document
---
faire une carte par sp ? et gradient de couleurs par DBH ?
- with X-Yutm coordinates
- Scientific names (done)

carte env - espèce, DBH
- relations env -distrib : density plot ( x : env, y abondances par espèce)
- ou points en couleur selon le diamètre

# Packages
```{r Setup, include = F}
library(tidyverse)
library(data.table)
library(ggforce)
library(sf)
library(raster)
library(terra)
library(tidyterra)
```

# Import cleaned inventory data
```{r,include = F, message=F}
Understory <- read_csv("~/PhD/Inventories/Data/Understory/Paracou/ALT_Paracou_9ha_CLEAN.csv")
```

## On the MNT of the ALT zone 
!! ATTENTION !! les individus sont en UTM et le mnt est en latitude/longitude
```{r}
data <- Understory %>% 
  filter(!is.na(Xutm)) %>% 
  filter(!is.na(Yutm)) %>% 
  filter(All_ScientificName=="Ocotea nigra") 

ggplot(data, mapping = aes(x = Xutm, y = Yutm)) +
  geom_point(aes(col=All_ScientificName))

ALTmnt <- terra::rast("D:/Mes Donnees/PhD/R_codes/PhD/test/Paracou_ALT_mnt.tif")
ALT <- st_as_sf(raster::shapefile("D:/Mes Donnees/PhD/R_codes/PhD/test/ALT.shp"))


ggplot() + 
  geom_spatraster(data = ALTmnt, aes(fill = Z)) +
  scale_fill_gradientn(name = "Elevation (m)",
                       colors = terrain.colors(30, rev=T, alpha = 0.9),
                       na.value="white") +
  geom_sf(data = sf::st_cast(ALT, "LINESTRING")) +
  geom_point(data, mapping = aes(x = Xutm, y = Yutm, colour = DBH)) +
  scale_colour_gradient(name = "DBH (cm)",
                        low = "#56B1F7", high = "#132B43", n.breaks = 4) +
  theme_classic() +
  coord_sf()

```
Plot for each species
```{r}
Understory <- Understory %>% 
  filter(!is.na(Xutm)) %>% 
  filter(!is.na(Yutm))

sp <- Understory$All_ScientificName

# Define nrow and ncol for the facet
n <- length(unique(sp))
if(n<4) {i = 1}else{ i = 4}


pdf("Spatial distribution_of_each_species.pdf", width = 15, height = 10)
for(p in 1:(ceiling(length(unique(sp))/16))){
  print(
    
    ggplot(Understory) + 
      geom_spatraster(data = ALTmnt, aes(fill = Z)) +
      scale_fill_gradientn(name = "Elevation (m)",
                           colors = terrain.colors(30, rev=T, alpha = 0.9),
                           na.value="white") +
      geom_sf(data = sf::st_cast(ALT, "LINESTRING")) +
      
      geom_point(Understory, mapping = aes(x = Xutm, y = Yutm, colour = DBH)) +
      scale_colour_gradient(name = "DBH (cm)",
                            low = "#56B1F7", high = "#132B43") +
      theme_classic() +
      coord_sf() +
      facet_wrap(~All_ScientificName)
    # ggforce::facet_wrap_paginate(vars(All_ScientificName, N),
    #                              scales = "free",
    #                              ncol = min(n,4), nrow = i, page = p)
    
  )
}
dev.off() # Close the final graphics device
```

## On the light map of the ALT zone 

