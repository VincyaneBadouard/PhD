---
title: "Spatial distribution of species"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: pdf_document
---
faire une carte par sp ? et gradient de couleurs par DBH ?
- with X-Yutm coordinates
- Scientific names (done)

- carte env - espèce, DBH
- relations env - distrib : density plot (x : env, y abondances par espèce)
- ou points en couleur selon le diamètre

Environnment (à partir de l'ALS low alt ?) :
- topographie (DTM)
- drainage du sol (TWI)
- relative elevation
- light ( (à générer sur les 9 ha + 100 m buffer))

# Packages
```{r Setup, include = F}
library(tidyverse)
library(data.table)
library(ggforce)
library(sf)
library(raster)
library(terra)
library(tidyterra)
```

# Import cleaned inventory data
```{r,include = F, message=F}
Understory <- read_csv("~/PhD/Inventories/Data/Understory/Paracou/ALT_Paracou_9ha_CLEAN.csv")
```

# Import environmental data
```{r}
# Zone
ALT <- st_as_sf(raster::shapefile("D:/Mes Donnees/PhD/R_codes/PhD/test/ALT.shp"))

# Topography
MNT <- terra::rast("D:/Mes Donnees/PhD/R_codes/PhD/test/Paracou_ALT_mnt.tif")

# TWI
TWI <- terra::rast("D:/Mes Donnees/PhD/R_codes/PhD/test/Paracou_ALT_TWI_5m.tif")

# Relative elevation
elev <- terra::rast("D:/Mes Donnees/PhD/R_codes/PhD/test/Paracou_ALT_RelativeElev.tif")

# Light (à faire)

```

# On the MNT 

conseillerai la topo en nuance de gris et le dbh en taille de point ou en viridis pour mieux voir
```{r}
data <- Understory %>% 
  filter(!is.na(Xutm)) %>% 
  filter(!is.na(Yutm)) %>% 
  filter(All_ScientificName=="Ocotea_nigra") %>% 
  st_as_sf(coords = c("Xutm", "Yutm")) %>% 
  st_set_crs(st_crs(MNT))

ggplot() + 
  geom_spatraster(data = MNT, aes(fill = Z)) +
  # scale_fill_gradientn(name = "Elevation (m)",
  #                      colors = terrain.colors(30, rev=T, alpha = 0.9),
  #                      na.value="white") +
  scale_fill_gradientn(name = "Elevation (m)",
                       colors = gray.colors(4, start = 0.9, end = 0),
                       na.value="white") +
  geom_sf(data = sf::st_cast(ALT, "LINESTRING")) +
  geom_sf(data, mapping = aes(colour = DBH)) +
  viridis::scale_colour_viridis(name = "DBH (cm)", direction=-1, trans = "log", labels=round) + 
  # scale_colour_gradient(name = "DBH (cm)",
  #                       low = "#56B1F7", high = "#132B43") +
  
  theme_classic() +
  coord_sf()

```

## For each species
```{r}
data <- Understory %>% 
  select(StemID, All_ScientificName, DBH, Xutm, Yutm) %>% 
  filter(All_ScientificName %in% c("Maytenus_oblongata", "Iryanthera_sagotiana",
                                   "Oxandra_asbeckii", "Hymenopus_heteromorphus", "Unonopsis_stipitata")) %>%
  filter(!is.na(Xutm)) %>% 
  filter(!is.na(Yutm)) %>% 
  st_as_sf(coords = c("Xutm", "Yutm")) %>% 
  st_set_crs(st_crs(MNT))


plist <- vector('list', length(unique(data$All_ScientificName)))

for(p in 1:length(unique(data$All_ScientificName))){
  # message(s)
  plist[[p]] <- local({
    # s <- s
   data <- data %>% 
      filter(All_ScientificName==unique(data$All_ScientificName)[p]) 
   
      ggplot(data) + 
      geom_spatraster(data = MNT, aes(fill = Z)) +
      # scale_fill_gradientn(name = "Elevation (m)",
      #                      colors = terrain.colors(30, rev=T, alpha = 0.9),
      #                      na.value="white") +
      # geom_sf(data = sf::st_cast(ALT, "LINESTRING")) +
      # 
      # geom_sf(mapping = aes(colour = DBH)) +
      # scale_colour_gradient(name = "DBH (cm)",
      #                       low = "#56B1F7", high = "#132B43") +
      scale_fill_gradientn(name = "Elevation (m)",
                           colors = gray.colors(4, start = 0.9, end = 0),
                           na.value="white") +
      geom_sf(data = sf::st_cast(ALT, "LINESTRING")) +
      geom_sf(mapping = aes(colour = DBH)) +
      viridis::scale_colour_viridis(name = "DBH (cm)", direction=-1, labels=round) +
      theme_classic() +
      guides(fill="none") +
      # geom_text(label = max(data$DBH), position ="top")
      annotate(geom = 'text', label = paste("DBH max: ",round(max(data$DBH),0),"cm"), x = -Inf, y = Inf, hjust = -0.2, vjust = 1.5) +
      coord_sf() +
      labs(title = unique(data$All_ScientificName))
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 2, ncol = 2)

ggsave("Spatial_distribution_of_each_species_on_MNT_notlog.pdf", plots, width = 15, height = 10) 
```



# On the TWI 
```{r}
data <- Understory %>% 
  filter(!is.na(Xutm)) %>% 
  filter(!is.na(Yutm)) %>% 
  filter(All_ScientificName=="Ocotea_nigra") %>% 
  st_as_sf(coords = c("Xutm", "Yutm")) %>% 
  st_set_crs(st_crs(MNT))

ggplot() + 
  geom_spatraster(data = TWI, aes(fill = Paracou_TWI_5m)) +
  scale_fill_gradientn(name = "TWI",
                       colors =  hcl.colors(12, "Blues", rev = T),
                       na.value="white") + 
  geom_sf(data = sf::st_cast(ALT, "LINESTRING")) +
  geom_sf(data, mapping = aes(colour = DBH)) +
  scale_colour_gradient(name = "DBH (cm)",
                        low = "#E7B800", high = "#FC4E07") +
  theme_classic() +
  coord_sf()

```

## For each species
```{r}
plist <- vector('list', length(unique(data$All_ScientificName)))

for(p in 1:length(unique(data$All_ScientificName))){
  message(s)
  plist[[p]] <- local({
    # s <- s
    data %>% 
      filter(All_ScientificName==unique(data$All_ScientificName)[p]) %>% 
      ggplot() + 
      geom_spatraster(data = TWI, aes(fill = Paracou_TWI_5m)) +
      scale_fill_gradientn(name = "TWI",
                           colors =  hcl.colors(12, "Blues", rev = T),
                           na.value="white") +
      geom_sf(data = sf::st_cast(ALT, "LINESTRING")) +
      
      geom_sf(mapping = aes(colour = DBH)) +
      scale_colour_gradient(name = "DBH (cm)",
                            low = "#E7B800", high = "#FC4E07") + 
      theme_classic() +
      guides(fill="none") +
      coord_sf() +
      labs(title = unique(data$All_ScientificName)[p])
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 2, ncol = 2)

ggsave("Spatial_distribution_of_each_species_on_TWI.pdf", plots, width = 15, height = 10) 

```

# On the relative elevation 
```{r}
data <- Understory %>% 
  filter(!is.na(Xutm)) %>% 
  filter(!is.na(Yutm)) %>% 
  filter(All_ScientificName=="Ocotea_nigra") %>% 
  st_as_sf(coords = c("Xutm", "Yutm")) %>% 
  st_set_crs(st_crs(MNT))


ggplot(data, mapping = aes(x = Xutm, y = Yutm)) +
  geom_point(aes(col=All_ScientificName))

ggplot() + 
  geom_spatraster(data = elev, aes(fill = re)) +
  scale_fill_gradientn(name = "Relative elevation to the creek (m)",
                       colors = hcl.colors(45, "Blues"),
                       na.value="white") +
  geom_sf(data = sf::st_cast(ALT, "LINESTRING")) +
  geom_sf(data, mapping = aes(colour = DBH)) +
  scale_colour_gradient(name = "DBH (cm)",
                        low = "#E7B800", high = "#FC4E07") +
  theme_classic() +
  coord_sf()

```

## For each species
```{r}
plist <- vector('list', length(unique(data$All_ScientificName)))

for(p in 1:length(unique(data$All_ScientificName))){
  message(s)
  plist[[p]] <- local({
    # s <- s
    data %>% 
      filter(All_ScientificName==unique(data$All_ScientificName)[p]) %>% 
      ggplot() + 
      geom_spatraster(data = elev, aes(fill = re)) +
      scale_fill_gradientn(name = "Relative elevation to the creek (m)",
                           colors = hcl.colors(45, "Blues"),
                           na.value="white") +
      geom_sf(data = sf::st_cast(ALT, "LINESTRING")) +
      
      geom_sf(mapping = aes(colour = DBH)) +
      scale_colour_gradient(name = "DBH (cm)",
                            low = "#E7B800", high = "#FC4E07") + 
      theme_classic() +
      guides(fill="none") +
      coord_sf() +
      labs(title = unique(data$All_ScientificName)[p])
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 2, ncol = 2)

ggsave("Spatial_distribution_of_each_species_on_relativeelevation.pdf", plots, width = 15, height = 10) 
```


## On the light map of the ALT zone 

