---
title: "Environmental variables exploration"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: pdf_document
---

Environnment (à partir de l'ALS High alt) :
- classes topo (4 classes)
- topographie (DTM)
- drainage du sol (TWI)
- Height Above the Nearest Drainage (HAND)
- light (à générer sur les 25 ha + 100 m buffer, res 1m) (au-dessus (de combien) de chaque arbre)

# Packages
```{r Setup, include = F}
library(tidyverse)
library(data.table)
library(ggforce)
library(sf)
library(raster)
library(terra)
library(tidyterra)
library(corrplot)
library(RColorBrewer)
```

# Import environmental data
```{r}
# Topography
MNT <- terra::rast("D:/Mes Donnees/PhD/R_codes/PhD/test/Paracou_P16_MNT.tif")

# TWI
TWI <- terra::rast("D:/Mes Donnees/PhD/R_codes/PhD/test/Paracou_P16_TWI_5m.tif")

# Height Above the Nearest Drainage (HAND)
elev <- terra::rast("D:/Mes Donnees/PhD/R_codes/PhD/test/Paracou_P16_RelativeElev.tif")

# Zone
P16 <- st_as_sf(raster::shapefile("D:/Mes Donnees/PhD/R_codes/PhD/test/Plot16.shp")) %>% 
  st_set_crs(st_crs(MNT))
# plot(P16)
ALT <- st_as_sf(raster::shapefile("D:/Mes Donnees/PhD/R_codes/PhD/test/ALT.shp")) %>% 
  st_set_crs(st_crs(MNT))

# Classes topo (4 classes)
TopoLevels <- st_read("D:/Mes Donnees/PhD/SIG_data/Topo_P16_4classes/Topo4Levels.shp") %>% 
  filter(Plot==16) %>% mutate(TopoTypeEn = ifelse(idTopo ==38, "Downslope", TopoTypeEn)) %>% 
  mutate(TopoTypeEn = recode(TopoTypeEn, "Plateau" = "Hilltop")) %>% 
  st_set_crs(st_crs(MNT)) #%>% 
# st_intersection(P16)

# Light (à faire 25ha)
Light <- read_csv("~/PhD/Env_data_forModel/TreeLightMeth3_4ha.csv") %>% 
  st_as_sf(coords = c('Xutm','Yutm')) %>% 
  st_set_crs(st_crs(MNT))

crs(MNT) == crs(TWI); crs(MNT) == crs(elev); crs(MNT) == crs(TopoLevels) ; crs(MNT) == crs(Light)
```
# Plot maps
```{r, eval = F}
ggplot(TopoLevels) +
  geom_sf(data = TopoLevels, aes(fill = TopoTypeEn)) +
  geom_sf(data = sf::st_cast(P16, "LINESTRING")) +
  scale_fill_manual(values = c("Hilltop" = "#009E73",
                               "Slope"= "#E7B800",
                               "Downslope"= "#bfe6eb", 
                               "Bottomland" = "#1f78b4"),
                    breaks = c("Hilltop", "Slope", "Downslope", "Bottomland")) +
  theme_classic() +
  theme(axis.text= element_text(size=10),
        legend.title= element_text(size=16), legend.text= element_text(size=16)) +
  labs(fill= "Topography")

ggsave("Paracou_P16_topolevels.png",
       path = "D:/Mes Donnees/PhD/Figures/EnvVar_explo/",
       width = 20, height = 15, units = "cm", dpi=800, bg="white")

ggplot() + 
  geom_spatraster(data = MNT, aes(fill = Z)) +
  scale_fill_gradientn(name = "Elevation (m)",
                       colors = terrain.colors(30, rev=T, alpha = 0.9),
                       na.value="white") +
  geom_sf(data = st_cast(st_cast(TopoLevels, "POLYGON"), "LINESTRING")) +
  geom_sf(data = st_cast(st_cast(P16, "POLYGON"), "LINESTRING")) +
  theme_classic() +
  theme(axis.text= element_text(size=10),
        legend.title= element_text(size=16), legend.text= element_text(size=16))

ggsave("Paracou_P16_DEM_topolevels.png",
       path = "D:/Mes Donnees/PhD/Figures/EnvVar_explo/",
       width = 20, height = 15, units = "cm", dpi=800, bg="white")

ggplot() + 
  geom_spatraster(data = TWI, aes(fill = Paracou_TWI_5m)) +
  scale_fill_gradientn(name = "TWI",
                       colors =  hcl.colors(12, "Blues", rev = T),
                       na.value="white") +
  geom_sf(data = st_cast(st_cast(TopoLevels, "POLYGON"), "LINESTRING")) +
  geom_sf(data = st_cast(st_cast(P16, "POLYGON"), "LINESTRING")) +
  theme_classic() +
  theme(axis.text= element_text(size=10),
        legend.title= element_text(size=16), legend.text= element_text(size=16))

ggsave("Paracou_P16_TWI_topolevels.png",
       path = "D:/Mes Donnees/PhD/Figures/EnvVar_explo/",
       width = 20, height = 15, units = "cm", dpi=800, bg="white")

ggplot() + 
  geom_spatraster(data = elev, aes(fill = HAND)) +
  scale_fill_gradientn(name = "HAND (m)",
                       colors = hcl.colors(45, "Blues"),
                       na.value="white") +
  geom_sf(data = st_cast(st_cast(TopoLevels, "POLYGON"), "LINESTRING")) +
  geom_sf(data = st_cast(st_cast(P16, "POLYGON"), "LINESTRING")) +
  theme_classic() +
  theme(axis.text= element_text(size=10),
        legend.title= element_text(size=16), legend.text= element_text(size=16))

ggsave("Paracou_P16_HAND_topolevels.png",
       path = "D:/Mes Donnees/PhD/Figures/EnvVar_explo/",
       width = 20, height = 15, units = "cm", dpi=800, bg="white")

Light %>% 
  arrange(Z) %>% 
  ggplot() + 
  geom_sf(aes(col = Transmittance), size=0.3) +
  scale_color_gradientn(name = "Transmittance",
                        colors = terrain.colors(30, rev=T),
                        na.value="white") +
  geom_sf(data = st_cast(st_cast(TopoLevels, "POLYGON"), "LINESTRING"), col="red") +
  geom_sf(data = st_cast(st_cast(P16, "POLYGON"), "LINESTRING")) +
  theme_classic() +
  theme(axis.text= element_text(size=10),
        legend.title= element_text(size=16), legend.text= element_text(size=16))

ggsave("Paracou_P16_Light_topolevels.png",
       path = "D:/Mes Donnees/PhD/Figures/EnvVar_explo/",
       width = 20, height = 15, units = "cm", dpi=800, bg="white")
```

# Remove pinotière from MNT (pas besoin on filtre à <6m)
```{r, eval=F}
nopinotiere <- P16 %>% st_intersection(TopoLevels) %>% # TopoLevels by subplot
  # without pinotière
  filter(!(TopoTypeEn == "Bottomland" &
             SubPlot %in% c("11","12","16","17","21","22")))
# plot(nopinotiere)

pinotiere <- P16 %>% st_intersection(TopoLevels) %>% # TopoLevels by subplot
  # without pinotière
  filter((TopoTypeEn == "Bottomland" &
            SubPlot %in% c("11","12","16","17","21","22")))

truc <- MNT %>% 
  raster::mask(pinotiere) %>% raster::crop(nopinotiere) # remove pinotière
plot(truc)
truc

MNT <- MNT %>% 
  raster::mask(nopinotiere) %>% raster::crop(nopinotiere) # remove pinotière
# plot(MNT_withoutpinot)
TWI <- TWI %>% 
  raster::mask(nopinotiere) %>% raster::crop(nopinotiere) # remove pinotière
# plot(TWI)
elev <- elev %>% 
  raster::mask(nopinotiere) # remove pinotière
# plot(elev)
```
# Where are MNT values <6 m (in the same zone or dispatched)
```{r}
MNT[MNT[] < 6] = NA 
# plot(MNT)

TWI <- TWI %>% 
  resample(MNT) %>% 
  crop(MNT) %>% 
  mask(MNT)
# plot(TWI)

elev <- elev %>% 
  resample(MNT) %>% 
  crop(MNT) %>% 
  mask(MNT)
# plot(elev)


# MNTalt2 <- MNTalt
# MNTalt2[MNTalt2[] < 6] = NA 
# plot(MNTalt2)
```

# Distribution
```{r}
# Topography
MNTalt <- terra::rast("D:/Mes Donnees/PhD/R_codes/PhD/test/Paracou_ALT_mnt.tif")
MNTalt$Z # 25ha : 3.52 - 23.80 ; 9ha : 6.39 - 23.80 ; without pinotiere : 3.52-23.80

# TWI
TWIalt <- terra::rast("D:/Mes Donnees/PhD/R_codes/PhD/test/Paracou_ALT_TWI_5m.tif")
TWIalt$Paracou_TWI_5m # 25ha : 3.888584 - 13.227507 ; 9ha : 4.729557 - 11.025112 ; without pinotiere :

# Height Above the Nearest Drainage (HAND)
elevalt <- terra::rast("D:/Mes Donnees/PhD/R_codes/PhD/test/Paracou_ALT_RelativeElev.tif")
elevalt$re # 25ha : -0.4487296 - 23.3439674 ; 9ha : -0.3905195 - 23.3439674 ; without pinotiere :
```

```{r, eval=F}
# Elevation
MNT$Z # 3.52 - 23.80 
terra::global(MNT, fun="mean", na.rm=TRUE)[,1] # 12.54061 
sqrt(terra::global(MNT, fun="sd", na.rm=TRUE)[,1]) # 2.120244
hist(MNT$Z) 
ggplot() +
  geom_histogram(data=MNT, aes(x=Z),binwidth=1, fill="#69b3a2", color="#e9ecef", alpha=0.9) +
  geom_histogram(data=MNTalt, aes(x=Z), binwidth=1, fill="grey", color="#e9ecef", alpha=0.9) +
  scale_x_continuous(breaks = seq(3, 24, 1))

ggsave("Paracou_P16_altitude_distrib_filtr6m.png",
       path = "D:/Mes Donnees/PhD/Figures/EnvVar_explo/",
       width = 20, height = 15, units = "cm", dpi=800, bg="white")

# TWI
TWI$Paracou_TWI_5m # 3.888584 - 13.227507
terra::global(TWI, fun="mean", na.rm=TRUE)[,1] # 6.761383
sqrt(terra::global(TWI, fun="sd", na.rm=TRUE)[,1]) # 1.25684
hist(TWI$Paracou_TWI_5m) 
ggplot() +
  geom_histogram(data= TWI, aes(x=Paracou_TWI_5m),
                 binwidth=1, fill="#69b3a2", color="#e9ecef", alpha=0.9) +
  geom_histogram(data= TWIalt, aes(x=Paracou_TWI_5m),
                 binwidth=1, fill="grey", color="#e9ecef", alpha=0.9) +
  
  scale_x_continuous(breaks = seq(4, 14, 1))

ggsave("Paracou_P16_TWI_distrib_filtr6m.png",
       path = "D:/Mes Donnees/PhD/Figures/EnvVar_explo/",
       width = 20, height = 15, units = "cm", dpi=800, bg="white")


# Relative elevation
elev$re # -0.4487296 - 23.3439674
terra::global(elev, fun="mean", na.rm=TRUE)[,1] # 5.980169
sqrt(terra::global(elev, fun="sd", na.rm=TRUE)[,1]) # 2.374534
hist(elev$re) 
ggplot() +
  geom_histogram(data = elev, aes(x=re),
                 binwidth=1, fill="#69b3a2", color="#e9ecef", alpha=0.9) +
  geom_histogram(data = elevalt, aes(x=re),
                 binwidth=1, fill="grey", color="#e9ecef", alpha=0.9) +
  scale_x_continuous(breaks = seq(-0.5, 24, 1))

ggsave("Paracou_P16_HAND_distrib_filtr6m.png",
       path = "D:/Mes Donnees/PhD/Figures/EnvVar_explo/",
       width = 20, height = 15, units = "cm", dpi=800, bg="white")



# Light
range(Light$Transmittance) # 5.16304e-05 - 1.00000e+00
toodark <- Light[Light$Transmittance < 0.001,]
nrow(toodark) # 110/10315 trees (=1%)
mean(Light$Transmittance) # 0.07
median(Light$Transmittance) # 0.014
var(Light$Transmittance) # 0.03
hist(Light$Transmittance) 

ggplot(Light, aes(x=Transmittance)) +
  xlim(0,0.001)+
  geom_histogram(binwidth=0.0001, fill="grey", color="#e9ecef", alpha=0.9) +
  labs(title="< 0.001 estimated transmittance")

ggplot(toodark, aes(x=Z)) + # light height
  geom_histogram(binwidth=1, fill="grey", color="#e9ecef", alpha=0.9) +
  labs(title="Height (m) of the < 0.001 estimated transmittance")

ggplot(Light, aes(x=Transmittance)) +
  geom_histogram(binwidth=0.01, fill="grey", color="#e9ecef", alpha=0.9) +
  scale_x_continuous(breaks = seq(0, 1, 0.1))

ggsave("Paracou_P16_Light_distrib.png",
       path = "D:/Mes Donnees/PhD/Figures/EnvVar_explo/",
       width = 20, height = 15, units = "cm", dpi=800, bg="white")
```


# Data transformation
```{r}
NotT <- ggplot(Light, aes(x=Transmittance)) +
  theme_minimal() +
  geom_histogram(binwidth=0.01, fill="#69b3a2", color="#e9ecef", alpha=0.9) +
  scale_x_continuous(breaks = c(0.001, seq(0.1, 1, 0.1)),
                     labels = as.character(c(0.001, seq(0.1, 1, 0.1))) ) +
  geom_vline(xintercept = 0.001, col= "darkgreen") +
  labs(title = "not transformed")

log <- ggplot(Light, aes(x=Transmittance)) +
  theme_minimal() +
  geom_histogram(binwidth=0.25, closed ="left", fill="#69b3a2", color="#e9ecef", alpha=0.9) +
  scale_x_continuous(trans="log",
                     breaks = c(0, min(Light$Transmittance),
                                0.001, 0.01, 0.1, 1),
                     labels = as.character(c(0,                                             format(round(min(Light$Transmittance),5), scientific=FALSE),
                                             0.001, 0.01, 0.1, 1)) ) +
  geom_vline(xintercept =  0.001, col= "darkgreen") +
  labs(title = "log transformed")

log10 <- ggplot(Light, aes(x=Transmittance)) +
  theme_minimal() +
  geom_histogram(binwidth=0.25, closed ="left", fill="#69b3a2", color="#e9ecef", alpha=0.9) +
  scale_x_continuous(trans="log10",
                     breaks = c(0, min(Light$Transmittance),
                                0.001, 0.01, 0.1, 1),
                     labels = as.character(c(0,                                             format(round(min(Light$Transmittance),5), scientific=FALSE),
                                             0.001, 0.01, 0.1, 1)) ) +
  geom_vline(xintercept =  0.001, col= "darkgreen") +
  labs(title = "log10 transformed")

sqrt <- ggplot(Light, aes(x=Transmittance)) +
  theme_minimal() +
  geom_histogram(binwidth=0.06, fill="#69b3a2", color="#e9ecef", alpha=0.9) +
  scale_x_continuous(trans="sqrt",
                     breaks = c(0.001, 0.01,
                                seq(0.1, 1, 0.1)),
                     labels = as.character(c(0.001, 0.01, seq(0.1, 1, 0.1))) ) +
  geom_vline(xintercept =  0.001, col= "darkgreen") +
  labs(title = "sqrt transformed")

ggpubr::ggarrange(NotT, sqrt, log, log10,
                  # labels = c("not transformed", "sqrt transformed", "log transformed"),
                  ncol = 1, nrow = 4)

ggpubr::ggarrange(NotT, log, log10,
                  ncol = 1, nrow = 3)

ggsave("Light_distrib_transformation.png",
       path = "D:/Mes Donnees/PhD/Figures/EnvVar_explo/",
       width = 20, height = 15, units = "cm", dpi=800, bg="white")

```

# Join env data
```{r}
# TWI_1m <- resample(TWI, MNT, method="bilinear") # 5m to 1m TWI
# plot(TWI); plot(TWI_1m)
# TWI_1m ; MNT

alt <- extract(MNT, Light) %>% # extract z
  rename(Elev = Z) %>% select(-ID)
twi <- extract(TWI, Light) %>% # extract twi
  rename(TWI = `Paracou_TWI_5m`) %>% select(-ID)
re <- extract(elev, Light) %>%  rename(HAND = re) %>% select(-ID) # extract re

Env <- Light %>% cbind(alt) %>% cbind(twi) %>% cbind(re)

# raster to data.frame
# MNT_df <- as.data.frame(MNT, xy=T)
# TWI_df <- as.data.frame(TWI_1m, xy=T)
# elev_df <- as.data.frame(elev, xy=T)
# 
# # join data.frame
# Env <- MNT_df %>% left_join(elev_df, by=c("x", "y")) %>% left_join(TWI_df, by=c("x", "y"))
```

# Env values for each topo level
```{r}
# terra::extract(x= MNT, y= TopoLevels, fun=table) # extract z from MNT # xy=T, bind=T, , fun=table

Env_all <- Env %>% 
  # st_as_sf(coords = c("x","y")) %>% st_set_crs(st_crs(MNT)) %>% 
  st_intersection(TopoLevels) %>% 
  mutate(TopoTypeEn = factor(TopoTypeEn, levels= c("Bottomland", "Downslope", "Slope", "Hilltop")))

# ggplot() +
#   geom_sf(data = Env_all, aes(colour = Z)) +
#   geom_sf(data = st_cast(st_cast(TopoLevels, "POLYGON"), "LINESTRING")) +
#   geom_sf(data = st_cast(st_cast(P16, "POLYGON"), "LINESTRING")) +
#   scale_colour_gradientn(name = "Elevation (m)",
#                          colors = terrain.colors(30, rev=T, alpha = 0.9),
#                          na.value="white") +
#   theme_classic()
```

# Boxplot var to topo level
```{r, eval=F}
ggplot(Env_all, aes(x= TopoTypeEn, y= Elev, fill= TopoTypeEn)) +
  geom_boxplot() +
  scale_fill_manual(values = c("Hilltop" = "#009E73",
                               "Slope"= "#E7B800",
                               "Downslope"= "#bfe6eb", 
                               "Bottomland" = "#1f78b4")) +
  guides(fill = FALSE) +
  theme_minimal() +
  theme(axis.title= element_text(size=18), axis.text= element_text(size=18)) +
  labs(x= "Topography", y= "Elevation (m)")

ggsave("Elevation_VS_topolevels.png", path = "D:/Mes Donnees/PhD/Figures/EnvVar_explo", width = 25, height = 15, units = "cm", dpi=800, bg="white")

ggplot(Env_all, aes(x= TopoTypeEn, y= TWI, fill= TopoTypeEn)) +
  geom_boxplot() +
  scale_fill_manual(values = c("Hilltop" = "#009E73",
                               "Slope"= "#E7B800",
                               "Downslope"= "#bfe6eb", 
                               "Bottomland" = "#1f78b4")) +
  guides(fill = FALSE) +
  theme_minimal() +
  theme(axis.title= element_text(size=18), axis.text= element_text(size=18)) +
  labs(x= "Topography", y= "TWI")

ggsave("TWI_VS_topolevels.png", path = "D:/Mes Donnees/PhD/Figures/EnvVar_explo", width = 25, height = 15, units = "cm", dpi=800, bg="white")

ggplot(Env_all, aes(x= TopoTypeEn, y= HAND, fill= TopoTypeEn)) +
  geom_boxplot() +
  scale_fill_manual(values = c("Hilltop" = "#009E73",
                               "Slope"= "#E7B800",
                               "Downslope"= "#bfe6eb", 
                               "Bottomland" = "#1f78b4")) +
  guides(fill = FALSE) +
  theme_minimal() +
  theme(axis.title= element_text(size=18), axis.text= element_text(size=18)) +
  labs(x= "Topography", y= "Height Above the Nearest Drainage (HAND) (m)")

ggsave("HAND_VS_topolevels.png", path = "D:/Mes Donnees/PhD/Figures/EnvVar_explo", width = 25, height = 15, units = "cm", dpi=800, bg="white")

ggplot(Env_all, aes(x= TopoTypeEn, y= Transmittance, fill= TopoTypeEn)) +
  geom_boxplot() +
  scale_fill_manual(values = c("Hilltop" = "#009E73",
                               "Slope"= "#E7B800",
                               "Downslope"= "#bfe6eb", 
                               "Bottomland" = "#1f78b4")) +
  guides(fill = FALSE) +
  theme_minimal() +
  theme(axis.title= element_text(size=18), axis.text= element_text(size=18)) +
  labs(x= "Topography", y= "Transmittance")

ggsave("Light_VS_topolevels.png", path = "D:/Mes Donnees/PhD/Figures/EnvVar_explo", width = 25, height = 15, units = "cm", dpi=800, bg="white")

```

# Relations var to var
```{r, eval=F}
ggplot(Env_all) +
  geom_point(aes(x= Elev, y= HAND, col = TopoTypeEn)) +
  scale_colour_manual(values = c("Hilltop" = "#009E73",
                                 "Slope"= "#E7B800",
                                 "Downslope"= "#bfe6eb", 
                                 "Bottomland" = "#1f78b4"),
                      breaks = c("Hilltop", "Slope", "Downslope", "Bottomland")) +
  theme_minimal() +
  theme(axis.title= element_text(size=18), axis.text= element_text(size=18),
        legend.title=element_blank(), legend.text= element_text(size=18)) +
  labs(x= "Elevation (m)", y= "Height Above the Nearest Drainage (HAND) (m)")

ggsave("Elevation_VS_HAND.png", path = "D:/Mes Donnees/PhD/Figures/EnvVar_explo", width = 25, height = 15, units = "cm", dpi=800, bg="white")

ggplot(Env_all) +
  geom_point(aes(x= Elev, y= Paracou_TWI_5m, col = TopoTypeEn)) +
  scale_colour_manual(values = c("Hilltop" = "#009E73",
                                 "Slope"= "#E7B800",
                                 "Downslope"= "#bfe6eb", 
                                 "Bottomland" = "#1f78b4"),
                      breaks = c("Hilltop", "Slope", "Downslope", "Bottomland")) +
  theme_minimal() +
  theme(axis.title= element_text(size=18), axis.text= element_text(size=18),
        legend.title=element_blank(), legend.text= element_text(size=18)) +
  labs(x= "Elevation (m)", y= "TWI")

ggsave("Elevation_VS_TWI.png", path = "D:/Mes Donnees/PhD/Figures/EnvVar_explo", width = 25, height = 15, units = "cm", dpi=800, bg="white")

ggplot(Env_all) +
  geom_point(aes(x= HAND, y= Paracou_TWI_5m, col = TopoTypeEn)) +
  scale_colour_manual(values = c("Hilltop" = "#009E73",
                                 "Slope"= "#E7B800",
                                 "Downslope"= "#bfe6eb", 
                                 "Bottomland" = "#1f78b4"),
                      breaks = c("Hilltop", "Slope", "Downslope", "Bottomland")) +
  theme_minimal() +
  theme(axis.title= element_text(size=18), axis.text= element_text(size=18),
        legend.title=element_blank(), legend.text= element_text(size=18)) +
  labs(x= "Height Above the Nearest Drainage (HAND) (m)", y= "TWI")

ggsave("HAND_VS_TWI.png", path = "D:/Mes Donnees/PhD/Figures/EnvVar_explo", width = 25, height = 15, units = "cm", dpi=800, bg="white")

ggplot(Env_all) +
  geom_point(aes(x= Elev, y= Transmittance)) + # , col = TopoTypeEn
  theme_minimal() +
  theme(axis.title= element_text(size=18), axis.text= element_text(size=18),
        legend.title=element_blank(), legend.text= element_text(size=18)) +
  labs(x= "Elevation (m)", y= "Transmittance")

ggsave("Elevation_VS_Light.png", path = "D:/Mes Donnees/PhD/Figures/EnvVar_explo", width = 25, height = 15, units = "cm", dpi=800, bg="white")

ggplot(Env_all) +
  geom_point(aes(x= HAND, y= Transmittance)) + # , col = TopoTypeEn
  theme_minimal() +
  theme(axis.title= element_text(size=18), axis.text= element_text(size=18),
        legend.title=element_blank(), legend.text= element_text(size=18)) +
  labs(x= "Height Above the Nearest Drainage (HAND) (m)", y= "Transmittance")

ggsave("HAND_VS_Light.png", path = "D:/Mes Donnees/PhD/Figures/EnvVar_explo", width = 25, height = 15, units = "cm", dpi=800, bg="white")

ggplot(Env_all) +
  geom_point(aes(x= TWI, y= Transmittance)) + # , col = TopoTypeEn
  theme_minimal() +
  theme(axis.title= element_text(size=18), axis.text= element_text(size=18),
        legend.title=element_blank(), legend.text= element_text(size=18)) +
  labs(x= "TWI", y= "Transmittance")

ggsave("TWI_VS_Light.png", path = "D:/Mes Donnees/PhD/Figures/EnvVar_explo", width = 25, height = 15, units = "cm", dpi=800, bg="white")

```
# Why there are NAs
```{r}

```

# Correlations
```{r}
Env_cor <- Env %>% 
  select(Transmittance, Elev,HAND,TWI) %>% st_drop_geometry() %>% 
  na.omit()

CorMatrixS <- Hmisc::rcorr(as.matrix(Env_cor))
CorMatrix <- round(CorMatrixS$r, digits = 2)  # matrice de corrélation
Pval_corr <- CorMatrixS$P # p-values

# write.csv(CorMatrix, "D:/Mes Donnees/PhD/Figures//Correlation_plot_topo.csv")

# Plot de la matrice de corrélation :
png("D:/Mes Donnees/PhD/Figures/EnvVar_explo/Correlation_plot_Env.png",
    width = 700, height = 500, pointsize=20) # width = 600, height = 600 for only topo

corrplot(CorMatrix, method="circle", col=brewer.pal(n=6, name="PuOr"),  
         type="upper",
         # # order="hclust", 
         tl.col="black", tl.cex = 1.5, tl.srt=45, #Text label color and rotation
         addCoef.col = "black", # Add coefficient of correlation
         number.cex = 1.5, # values
         cl.pos = 'n',
         diag=FALSE # hide correlation coefficient on the principal diagonal
)
dev.off()
```

