---
title: "Spatial distribution of species"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: pdf_document
---
- carte env - espèce, DBH
- relations env - distrib : density plot (x : env, y abondances par espèce)
- ou points en couleur selon le diamètre

Environnment (à partir de l'ALS low alt ?) :
- topographie (DTM)
- drainage du sol (TWI)
- relative elevation
- light (à générer sur les 9 ha + 100 m buffer) (au-dessus (de combien) de chaque arbre, quelle résolution ?)

# Packages
```{r Setup, include = F}
library(tidyverse)
library(data.table)
library(ggforce)
library(sf)
library(raster)
library(terra)
library(tidyterra)

Path = "//amap-data.cirad.fr/work/users/VincyaneBadouard/Inventories/Explo_plots"
# "D:/Mes Donnees/PhD/R_codes/PhD/Inventory_scripts/Exploration/pdf"

sp <- (read.csv("D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/InterestSpecies.csv")[,3]) # 75

```

# Import cleaned inventory data
```{r, include = F, message=F}
Inventory <- read_csv(
  "D:/Mes Donnees/PhD/Inventories/Data/Adults_Understory/Paracou/P16_2019_Paracou_InvandEnv.csv"
) %>% 
  arrange(DBHcor)
```

# Import environmental data
HAND : Height Above the Nearest Drainage
```{r}
# Topography
MNT <- terra::rast("D:/Mes Donnees/PhD/R_codes/PhD/test/Paracou_P16_MNT.tif")
plot(MNT)

# TWI
TWI <- terra::rast("D:/Mes Donnees/PhD/R_codes/PhD/test/Paracou_P16_TWI_5m.tif")

# Height Above the Nearest Drainage (HAND)
elev <- terra::rast("D:/Mes Donnees/PhD/R_codes/PhD/test/Paracou_P16_RelativeElev.tif")

# Zone
P16 <- st_as_sf(raster::shapefile("D:/Mes Donnees/PhD/R_codes/PhD/test/Plot16.shp")) %>% 
  st_set_crs(st_crs(MNT))

# Classes topo (4 classes)
TopoLevels <- st_read("D:/Mes Donnees/PhD/SIG_data/Topo_P16_4classes/Topo4Levels.shp") %>% 
  filter(Plot==16) %>% mutate(TopoTypeEn = ifelse(idTopo ==38, "Downslope", TopoTypeEn)) %>% 
  mutate(TopoTypeEn = recode(TopoTypeEn, "Plateau" = "Hilltop")) %>% 
  st_set_crs(st_crs(MNT)) #%>% 
# st_intersection(P16)

# Light (à faire 25ha)
# Light <- read_csv("~/PhD/Env_data_forModel/TreeLightMeth3_4ha.csv") #%>% 
# st_as_sf(coords = c('Xutm','Yutm')) %>% 
# st_set_crs(st_crs(MNT))

crs(MNT) == crs(TWI); crs(MNT) == crs(elev); crs(MNT) == crs(TopoLevels) ; crs(MNT) == crs(P16)

```

```{r, eval = F}
ggplot(TopoLevels) +
  geom_sf(data = TopoLevels, aes(fill = TopoTypeEn)) +
  geom_sf(data = sf::st_cast(P16, "LINESTRING")) +
  scale_fill_manual(values = c("Hilltop" = "#009E73",
                               "Slope"= "#E7B800",
                               "Downslope"= "#bfe6eb", 
                               "Bottomland" = "#1f78b4")) +
  theme_classic() +
  labs(fill= "Topography")

ggplot() + 
  geom_spatraster(data = MNT, aes(fill = Z)) +
  scale_fill_gradientn(name = "Elevation (m)",
                       colors = terrain.colors(30, rev=T, alpha = 0.9),
                       na.value="white") +
  geom_sf(data = sf::st_cast(P16, "LINESTRING")) +
  theme_classic()

ggplot() + 
  geom_spatraster(data = TWI, aes(fill = Paracou_TWI_5m)) +
  scale_fill_gradientn(name = "TWI",
                       colors =  hcl.colors(12, "Blues", rev = T),
                       na.value="white") +
  geom_sf(data = sf::st_cast(P16, "LINESTRING")) +
  theme_classic()

ggplot() + 
  geom_spatraster(data = elev, aes(fill = re)) +
  scale_fill_gradientn(name = "Relative elevation to the creek (m)",
                       colors = hcl.colors(45, "Blues"),
                       na.value="white") +
  geom_sf(data = sf::st_cast(P16, "LINESTRING")) +
  theme_classic()

```

# On the MNT 
```{r, eval = F}
data <- Inventory %>% 
  filter(!is.na(Xutm)) %>% 
  filter(!is.na(Yutm)) %>% 
  filter(ScientificName=="Symphonia_globulifera") %>% 
  st_as_sf(coords = c("Xutm", "Yutm")) %>% 
  st_set_crs(st_crs(MNT))

ggplot() + 
  geom_spatraster(data = MNT, aes(fill = Z)) +
  # scale_fill_gradientn(name = "Elevation (m)",
  #                      colors = terrain.colors(30, rev=T, alpha = 0.9),
  #                      na.value="white") +
  scale_fill_gradientn(name = "Elevation (m)",
                       colors = gray.colors(4, start = 0.9, end = 0),
                       na.value="white") +
  geom_sf(data = sf::st_cast(P16, "LINESTRING")) +
  geom_sf(data, mapping = aes(colour = DBHcor), size = 3) +
  viridis::scale_colour_viridis(name = "DBH (cm)", direction=-1, labels=round) + # trans = "log", 
  # scale_colour_gradient(name = "DBH (cm)",
  #                       low = "#56B1F7", high = "#132B43") +
  labs(title = "Symphonia globulifera distribution") +
  theme_classic() +
  theme(title= element_text(size=16),axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16)) +
  coord_sf()

# ggsave("Spatial_distribution_of_Symphonia_globulifera_on_MNT.png", width = 15, height = 10)
```

## For each species
```{r}
data <- Inventory %>% 
  select(idTree, ScientificName, Strategy, DBHcor, Xutm, Yutm, TreeHeight,
         Transmittance, Elevation, TWI) %>% 
  group_by(ScientificName) %>% 
  mutate(N = n()) %>%
  ungroup() %>% 
  mutate(cl = ifelse(Strategy =="Understory species" & !is.na(Strategy), "#009E73",
                     "#E7B800")) %>%  # color per sp strategy
  
  # filter(ScientificName %in% c("Maytenus_oblongata", "Iryanthera_sagotiana",
  #                                  "Oxandra_asbeckii", "Hymenopus_heteromorphus", "Unonopsis_stipitata")) %>%
  # filter(!is.na(Xutm)) %>% 
  # filter(!is.na(Yutm)) %>% 
  st_as_sf(coords = c("Xutm", "Yutm")) %>% 
  st_set_crs(st_crs(MNT))

```

```{r, eval=F}
plist <- vector('list', length(sp))

for(p in 1:length(sp)){
  plist[[p]] <- local({
    dataS <- data %>% 
      filter(ScientificName==sp[p]) 
    
    ggplot(dataS) + 
      geom_spatraster(data = mask(crop(MNT,P16), P16), aes(fill = Z)) +
      # scale_fill_gradientn(name = "Elevation (m)",
      #                      colors = terrain.colors(30, rev=T, alpha = 0.9),
      #                      na.value="white") +
      # scale_colour_gradient(name = "DBH (cm)",
      #                       low = "#56B1F7", high = "#132B43") +
      scale_fill_gradientn(name = "Elevation (m)",
                           colors = gray.colors(2, start = 0.9, end = 0, alpha=1),
                           na.value="white") +
      geom_sf(data = sf::st_cast(P16, "LINESTRING")) +
      geom_sf(mapping = aes(colour = DBHcor), alpha = 0.7, size = 0.7) +
      viridis::scale_colour_viridis(name = "DBH (cm)", direction=-1, labels=round) + # , trans = "log"
      theme_classic() +
      guides(fill="none") +
      # geom_text(label = max(dataS$DBHcor), position ="top")
      annotate(geom = 'text', label = paste("DBH max: ",round(max(dataS$DBHcor),0),"cm"),
               x = -Inf, y = Inf, hjust = -0.2, vjust = 1.5) +
      coord_sf() +
      labs(title = unique(dataS$ScientificName))
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 2, ncol = 2)
# plots

ggsave("P16_Spatial_distribution_of_each_species_on_MNT_notlog.pdf",
       path = "//amap-data.cirad.fr/work/users/VincyaneBadouard/Inventories/Explo_plots",
       plots, width = 15, height = 10)
```

# On TWI
```{r, eval = F}
data <- Inventory %>% 
  filter(!is.na(Xutm)) %>% 
  filter(!is.na(Yutm)) %>% 
  filter(ScientificName=="Guarea_costata") %>% 
  st_as_sf(coords = c("Xutm", "Yutm")) %>% 
  st_set_crs(st_crs(MNT))

ggplot() + 
  geom_spatraster(data = TWI, aes(fill = Paracou_TWI_5m)) +
  scale_fill_gradientn(name = "TWI",
                       colors =  hcl.colors(12, "Blues", rev = T),
                       na.value="white",
                       transform = "log") +
  geom_sf(data = sf::st_cast(P16, "LINESTRING")) +
  
  geom_sf(data, mapping = aes(colour = DBHcor), size = 1) +
  viridis::scale_colour_viridis(name = "DBH (cm)", direction=-1, labels=round) + # trans = "log", 
  # scale_colour_gradient(name = "DBH (cm)",
  #                       low = "#56B1F7", high = "#132B43") +
  labs(title = "Guarea costata distribution") +
  theme_classic() +
  theme(title= element_text(size=16),axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16)) +
  coord_sf()

# ggsave("Spatial_distribution_of_Guarea_costata_on_logTWI.png", width = 15, height = 10)
```

```{r, eval=F}
plist <- vector('list', length(sp))

for(p in 1:length(sp)){
  plist[[p]] <- local({
    dataS <- data %>% 
      filter(ScientificName==sp[p]) 
    
    ggplot(dataS) + 
      geom_spatraster(data = TWI, aes(fill = Paracou_TWI_5m)) +
  scale_fill_gradientn(name = "TWI",
                       colors =  hcl.colors(12, "Blues", rev = T),
                       na.value="white",
                       transform = "log") +
      geom_sf(data = sf::st_cast(P16, "LINESTRING")) +
      geom_sf(mapping = aes(colour = DBHcor), alpha = 0.7, size = 0.7) +
      viridis::scale_colour_viridis(name = "DBH (cm)", direction=-1, labels=round) + # , trans = "log"
      theme_classic() +
      guides(fill="none") +
      # geom_text(label = max(dataS$DBHcor), position ="top")
      annotate(geom = 'text', label = paste("DBH max: ",round(max(dataS$DBHcor),0),"cm"),
               x = -Inf, y = Inf, hjust = -0.2, vjust = 1.5) +
      coord_sf() +
      labs(title = unique(dataS$ScientificName))
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 2, ncol = 2)
# plots

ggsave("P16_Spatial_distribution_of_each_species_on_TWI_log.pdf",
       path = "//amap-data.cirad.fr/work/users/VincyaneBadouard/Inventories/Explo_plots",
       plots, width = 15, height = 10)
```

# Niches
relations env  
- distrib : density plot (x : env, y abondances par espèce)  
- ou points en couleur selon le diamètre  

## Env
```{r, eval=F}
# data %>% filter(is.na(geometry))
alt <- extract(MNT, data) %>% # extract z from MNT
  rename(Elevation = dtm2023_HighAlt_25ha_buffer) %>% 
  select(-ID)

data <- data %>% cbind(alt)

XY <- st_coordinates(data) # stock coordinates
st_geometry(data) <- NULL # no more sf object
data <- cbind(data, XY) %>% # bind XY coord
  rename(Xutm = X) %>% rename(Yutm = Y)

data <- data %>% left_join(Light, by=c("idTree","Xutm","Yutm"))

rm(alt)
```

## Age
```{r}
data <- data %>%
  mutate(Size = factor(case_when(
    # DBHcor < 10 ~ "1-10",
    # DBHcor >= 10 ~ ">10"), levels = c("1-10",">10")) 
    DBHcor < 5 ~ "1-5",
    DBHcor >= 5 & DBHcor < 10 ~ "5-10",
    DBHcor >= 10 & DBHcor < 20 ~ "10-20",
    DBHcor >= 20 ~ ">20"), levels = c("1-5","5-10","10-20",">20"))
  )
```

## Only sp enough abundant in < and > 10 cm DBH
```{r, eval=F}
data <- data %>%
  na.omit() %>% 
  mutate(ALT = ifelse(DBHcor <10, T, F))

Guyafor <- data %>% # 808
  filter(!ALT) %>% 
  group_by(ScientificName) %>%
  mutate(N = n()) %>%
  ungroup() %>%
  # Take only sp >= 30 ind
  filter(N >= 30)


ALT <- data %>% #5887
  filter(ALT) %>%  
  filter(ScientificName %in% Guyafor$ScientificName | Strategy=="Understory species") %>%
  group_by(ScientificName) %>%
  mutate(N = n()) %>%
  ungroup() %>%
  # Take only sp >= 30 ind
  filter(N >= 30)

s <- Guyafor$ScientificName %in% ALT$ScientificName

Guyafor <- Guyafor %>% # 736
  dplyr::filter(s) 

data <- ALT %>% #6623
  bind_rows(Guyafor) %>% 
  arrange(Strategy, N) %>% 
  mutate(cl = ifelse(Strategy =="Understory species" & !is.na(Strategy), "#009E73",
                     "#E7B800")) # color per sp strategy

nrow(data)==(nrow(ALT)+nrow(Guyafor))
length(unique(data$ScientificName)) # 34 (4ha)
```

# Plot for which var
```{r}
## MNT :
# var <- "Elevation"
# bin <- 1
## Light :
var <- "Transmittance"
bin <- 0.1

# data <- data %>% filter(SubPlot %in% c(14,15,19,20)) # TEMPORAIRE 4ha seulement # 10315 rows
```

```{r, eval=F}
data %>% 
  na.omit() %>% # des NA pcq MNT pas assez grand (a faire)
  filter(ScientificName == "Iryanthera_hostmannii") %>% 
  group_by(Size) %>% 
  mutate(med=median(get(var))) %>% 
  ungroup() %>% 
  ggplot(aes(x= get(var), color= Size, fill= Size)) +
  geom_histogram(binwidth=bin,alpha=0.2) +
  geom_vline(aes(xintercept=med, color=Size), linetype="dashed", size=0.8) +
  theme_classic() +
  facet_wrap(~ Size, scales = "free_y", ncol=1) +
  guides(fill = FALSE) +
  labs(x= var, y="Abundances", color= "DBH (cm)") # Abundances
```
## Without ontogeny
### Density + points
```{r, eval=F}
data %>% 
  na.omit() %>% # des NA pcq MNT pas assez grand (a faire)
  filter(ScientificName == "Iryanthera_hostmannii" | 
           ScientificName ==  "Tachigali_melinonii" | 
           ScientificName == "Cordia_sprucei"|
           ScientificName == "Licania_alba" |
           ScientificName == "Pogonophora_schomburgkiana") %>% 
  ggplot(aes(x= get(var), y= ScientificName)) +
  ggridges::geom_density_ridges(aes(colour = Size), scale = 0.6,
                                jittered_points = T, alpha=0, point_alpha  = 0.7) +
  theme_classic() +
  labs(x= var, y="Density", color= "DBH (cm)") 
```


```{r}
data %>% 
  group_by(ScientificName) %>% 
  mutate(MaxTreeHeight = max(TreeHeight)) %>% 
  group_by(Strategy) %>% 
  summarise(MinMaxTreeHeight = min(MaxTreeHeight),
            MaxMaxTreeHeight = max(MaxTreeHeight)
  )
```

### Density plot
```{r, eval=F}
# datainit <- data
plist <- vector('list', length(sp))

for(p in 1:length(sp)){
  # message(s)
  plist[[p]] <- local({
    # s <- s
    dataS <- data %>% 
      # na.omit() %>% # des NA pcq MNT pas assez grand (a faire)
      filter(ScientificName==sp[p]) %>% 
      mutate(med=median(get(var))) %>% 
      ungroup() 
    
    label <- dataS %>% 
      summarise(N = paste("N: ", n()),
                MaxTreeHeight = paste("MaxTreeHeight: ", round(max(TreeHeight),0),"m")
      )
    
    if(all(is.na(dataS$Strategy))){cl = "black"
    }else if(unique(na.omit(dataS$Strategy))=="Canopy species"){cl = "#E7B800"
    }else if(unique(na.omit(dataS$Strategy=="Understory species"))){cl = "#009E73"}
    
    ggplot(dataS, aes(x= get(var))) +
      geom_histogram(binwidth=bin, alpha=0.2) + #  binwidth=1, aes(y=..density..), 
      # geom_density(aes(y = after_stat(count)), alpha=0.4) + # aes(y = after_stat(count)),
      geom_vline(aes(xintercept=med), linetype="dashed", size=0.8) +
      
      geom_text(data = label, aes(label = N),
                x = Inf, y = Inf, hjust = 2, vjust = 3, show.legend = F) + # hjust = -2, vjust = 1.5
      
      geom_text(data = label, aes(label = MaxTreeHeight),
                x = Inf, y = Inf, hjust = 1.3, vjust = 4.5, show.legend = F) +
      
      geom_text(data = dataS, aes(label = Strategy), col = cl,
                x = Inf, y = Inf, hjust = 2, vjust = 2, show.legend = F) +
      
      theme_classic() +
      guides(fill = FALSE) +
      labs(title = unique(dataS$ScientificName),
           x= var, y="Abundances") # Density
    
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 3, ncol = 3)
# plots

ggsave(paste("P16_Species_",var,"_niche_hist_without_ontogeny.pdf",sep=""),
       path = Path,
       plots, width = 15, height = 10)
```

### Density + points transmittance not log
```{r, eval=F}
plist <- vector('list', length(sp))

for(p in 1:length(sp)){
  # message(s)
  plist[[p]] <- local({
    # s <- s
    dataS <- data %>% 
      # na.omit() %>% # des NA pcq MNT pas assez grand (a faire)
      filter(ScientificName==sp[p])
    
    label <- dataS %>% 
      summarise(MaxTreeHeight = paste("MaxTreeHeight: ", round(max(TreeHeight),0),"m"))
    
    if(all(is.na(dataS$Strategy))){cl = "black"
    }else if(unique(na.omit(dataS$Strategy))=="Canopy species"){cl = "#E7B800"
    }else if(unique(na.omit(dataS$Strategy=="Understory species"))){cl = "#009E73"}
    
    ggplot(dataS, aes(x= get(var), y= ScientificName)) +
      xlim(0,1) +
      # shaded area
      geom_rect(aes(xmin=min(Transmittance),
                    xmax=max(Transmittance),
                    ymin=-Inf,ymax=Inf), fill='#009E73', alpha= 0.01) +
      
      ggridges::geom_density_ridges(scale = 0.6,
                                    jittered_points = T,
                                    alpha=0, point_alpha  = 0.7) +
      
      geom_text(data = label, aes(label = MaxTreeHeight),
                x = Inf, y = Inf, hjust = 1, vjust = 3, show.legend = F) +
      
      
      theme_classic() +
      theme(plot.title = element_text(colour = cl),
            axis.text.y = element_blank()) + 
      guides(fill = FALSE) +
      labs(title = unique(dataS$ScientificName),
           x= var, y="Density", color= "DBH (cm)") 
    
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 2, ncol = 3)
# plots

ggsave(paste("P16_Species_",var,"_density_points_notlog_withoutonto.pdf",sep=''),
       path = Path,
       plots, width = 15, height = 10)
```

### Density + points transmittance log
```{r, eval=F}
plist <- vector('list', length(sp))

for(p in 1:length(sp)){
  # message(s)
  plist[[p]] <- local({
    # s <- s
    dataS <- data %>% 
      # na.omit() %>% # des NA pcq MNT pas assez grand (a faire)
      filter(ScientificName==sp[p])
    
    label <- dataS %>% 
      summarise(MaxTreeHeight = paste("MaxTreeHeight: ", round(max(TreeHeight),0),"m"))
    
    if(all(is.na(dataS$Strategy))){cl = "black"
    }else if(unique(na.omit(dataS$Strategy))=="Canopy species"){cl = "#E7B800"
    }else if(unique(na.omit(dataS$Strategy=="Understory species"))){cl = "#009E73"}
    
    ggplot(dataS, aes(x= get(var), y= ScientificName)) +
      xlim(0,1) +
      # shaded area
      geom_rect(aes(xmin=min(Transmittance),
                    xmax=max(Transmittance),
                    ymin=-Inf,ymax=Inf), fill='#009E73', alpha= 0.01) +
      
      
      ggridges::geom_density_ridges(scale = 0.6,
                                    jittered_points = T,
                                    alpha=0, point_alpha  = 0.7) +
      
      geom_text(data = label, aes(label = MaxTreeHeight),
                x = Inf, y = Inf, hjust = 1, vjust = 3, show.legend = F) +
      
      # scale_x_log10() +
      scale_x_continuous(trans="log") +
      theme_classic() +
      theme(plot.title = element_text(colour = cl),
            axis.text.y = element_blank()) + 
      guides(fill = FALSE) +
      labs(title = unique(dataS$ScientificName),
           x= var, y="Density", color= "DBH (cm)") 
    
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 2, ncol = 3)
# plots

ggsave(paste("Species_",var,"_density_points_log_withoutonto.pdf",sep=''),
       path = Path,
       plots, width = 15, height = 10)
```

## With ontogeny
### Hist per size class
```{r, eval=F}
plist <- vector('list', length(sp))

for(p in 1:length(sp)){
  # message(s)
  plist[[p]] <- local({
    # s <- s
    dataS <- data %>% 
      # na.omit() %>% # des NA pcq MNT pas assez grand (a faire)
      filter(ScientificName==sp[p]) %>% 
      group_by(Size) %>% 
      mutate(med=median(get(var))) %>% 
      ungroup() 
    
    label <- dataS %>% 
      group_by(Size) %>% 
      summarise(N = paste("N: ", n()))
    
    if(all(is.na(dataS$Strategy))){cl = "black"
    }else if(unique(na.omit(dataS$Strategy))=="Canopy species"){cl = "#E7B800"
    }else if(unique(na.omit(dataS$Strategy=="Understory species"))){cl = "#009E73"}
    
    ggplot(dataS, aes(x= get(var))) +
      geom_histogram(binwidth=bin , aes(color= Size, fill= Size),
                     alpha=0.2) + 
      geom_vline(aes(xintercept=med, color=Size), linetype="dashed", linewidth=0.8) +
      
      scale_color_manual(values = c("1-5" = "#00AFBB",
                                    "5-10"= "#CC79A7",
                                    "10-20"= "#E7B800",
                                    ">20" = "#FC4E07"),
                         breaks=c("1-5","5-10","10-20",">20")) + 
      
      scale_fill_manual(values = c("1-5" = "#00AFBB",
                                   "5-10"= "#CC79A7",
                                   "10-20"= "#E7B800",
                                   ">20" = "#FC4E07"),
                        breaks=c("1-5","5-10","10-20",">20")) +
      
      facet_wrap(~ Size, scales = "free_y", ncol=1) +
      
      geom_text(data = label, aes(label = N, color=Size),
                # x = -Inf, y = Inf, hjust = -0.2, vjust = 1.5, show.legend = F) +
                x = Inf, y = Inf, hjust = 2, vjust = 3, show.legend = F) + # hjust = -2, vjust = 1.5
      
      
      theme_classic() +
      theme(plot.title = element_text(colour = cl)) + 
      guides(fill = FALSE) +
      labs(title = unique(dataS$ScientificName),
           x= var, y="Abundances") # Density
    
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 2, ncol = 3)
# plots

ggsave(paste("Species_",var,"_niche_hist.pdf",sep=''),
       path = Path,
       plots, width = 15, height = 10)
```

### Hist relative abundances to the community per size class
```{r, eval=F}
data <- data %>% 
  group_by(Size) %>% 
  mutate(ComAbundSize = n()) %>% ungroup() # Community abundances per size class

plist <- vector('list', length(sp))

for(p in 1:length(sp)){
  # message(s)
  plist[[p]] <- local({
    # s <- s
    dataS <- data %>% 
      filter(ScientificName==sp[p]) %>% 
      group_by(Size) %>% 
      mutate(RelativeAbund = n()/ComAbundSize) %>%
      mutate(med=median(get(var))) %>% 
      ungroup() 
    
    label <- dataS %>% 
      group_by(Size) %>% 
      summarise(N = paste("RelAbund: ", round((n()/ComAbundSize)*100,0), "%"))
    
    if(all(is.na(dataS$Strategy))){cl = "black"
    }else if(unique(na.omit(dataS$Strategy))=="Canopy species"){cl = "#E7B800"
    }else if(unique(na.omit(dataS$Strategy=="Understory species"))){cl = "#009E73"}
    
    ggplot(dataS, aes(x= get(var))) +
      geom_histogram(aes(y = after_stat(count/sum(data$count)), # relative abund
                         color= Size, fill= Size),
                     binwidth=bin, alpha=0.2) + 
      scale_y_continuous(labels = scales::percent) + # in percent
      geom_vline(aes(xintercept=med, color=Size),
                 linetype="dashed", linewidth=0.8) +
      
      scale_color_manual(values = c("1-5" = "#00AFBB",
                                    "5-10"= "#CC79A7",
                                    "10-20"= "#E7B800",
                                    ">20" = "#FC4E07"),
                         breaks=c("1-5","5-10","10-20",">20")) + 
      
      scale_fill_manual(values = c("1-5" = "#00AFBB",
                                   "5-10"= "#CC79A7",
                                   "10-20"= "#E7B800",
                                   ">20" = "#FC4E07"),
                        breaks=c("1-5","5-10","10-20",">20")) +
      
      facet_wrap(~ Size, scales = "free_y", ncol=1) +
      
      geom_text(data = label, aes(label = N, color=Size),
                x = Inf, y = Inf, hjust = 2, vjust = 3, show.legend = F) + 
      theme_classic() +
      theme(plot.title = element_text(colour = cl)) + 
      guides(fill = FALSE) +
      labs(title = unique(dataS$ScientificName),
           x= var, y="Relatives abundances") 
    
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 2, ncol = 3)
# plots

ggsave(paste("Species_",var,"_niche_hist_RelAbun.pdf",sep=''),
       path = Path,
       plots, width = 15, height = 10)
```

### Density + points transmittance not log
```{r, eval=F}
plist <- vector('list', length(sp))

for(p in 1:length(sp)){
  # message(s)
  plist[[p]] <- local({
    # s <- s
    dataS <- data %>% 
      # na.omit() %>% # des NA pcq MNT pas assez grand (a faire)
      filter(ScientificName==sp[p])
    
    label <- dataS %>% 
      summarise(MaxTreeHeight = paste("MaxTreeHeight: ", round(max(TreeHeight),0),"m"))
    
    if(all(is.na(dataS$Strategy))){cl = "black"
    }else if(unique(na.omit(dataS$Strategy))=="Canopy species"){cl = "#E7B800"
    }else if(unique(na.omit(dataS$Strategy=="Understory species"))){cl = "#009E73"}
    
    ggplot(dataS, aes(x= get(var), y= ScientificName)) +
      ggridges::geom_density_ridges(aes(colour = Size), scale = 0.6,
                                    jittered_points = T,
                                    alpha=0, point_alpha  = 0.7) +
      
      scale_color_manual(values = c("1-5" = "#00AFBB",
                                    "5-10"= "#CC79A7",
                                    "10-20"= "#E7B800",
                                    ">20" = "#FC4E07"),
                         breaks=c("1-5","5-10","10-20",">20")) + 
      
      
      geom_text(data = label, aes(label = MaxTreeHeight),
                x = Inf, y = Inf, hjust = 1, vjust = 3, show.legend = F) +
      
      
      theme_classic() +
      theme(plot.title = element_text(colour = cl),
            axis.text.y = element_blank()) + 
      guides(fill = FALSE) +
      labs(title = unique(dataS$ScientificName),
           x= var, y="Density", color= "DBH (cm)") 
    
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 2, ncol = 3)
# plots

ggsave(paste("Species_",var,"_density_points_notlog.pdf",sep=''),
       path = Path,
       plots, width = 15, height = 10)
```
### Density + points transmittance log
```{r, eval=F}
plist <- vector('list', length(sp))

for(p in 1:length(sp)){
  # message(s)
  plist[[p]] <- local({
    # s <- s
    dataS <- data %>% 
      # na.omit() %>% # des NA pcq MNT pas assez grand (a faire)
      filter(ScientificName==sp[p])
    
    label <- dataS %>% 
      summarise(MaxTreeHeight = paste("MaxTreeHeight: ", round(max(TreeHeight),0),"m"))
    
    if(all(is.na(dataS$Strategy))){cl = "black"
    }else if(unique(na.omit(dataS$Strategy))=="Canopy species"){cl = "#E7B800"
    }else if(unique(na.omit(dataS$Strategy=="Understory species"))){cl = "#009E73"}
    
    ggplot(dataS, aes(x= get(var), y= ScientificName)) +
      ggridges::geom_density_ridges(aes(colour = Size), scale = 0.6,
                                    jittered_points = T,
                                    alpha=0, point_alpha  = 0.7) +
      
      scale_color_manual(values = c("1-5" = "#00AFBB",
                                    "5-10"= "#CC79A7",
                                    "10-20"= "#E7B800",
                                    ">20" = "#FC4E07"),
                         breaks=c("1-5","5-10","10-20",">20")) + 
      
      
      geom_text(data = label, aes(label = MaxTreeHeight),
                x = Inf, y = Inf, hjust = 1, vjust = 3, show.legend = F) +
      
      # scale_x_log10() +
      scale_x_continuous(trans="log") +
      theme_classic() +
      theme(plot.title = element_text(colour = cl),
            axis.text.y = element_blank()) + 
      guides(fill = FALSE) +
      labs(title = unique(dataS$ScientificName),
           x= var, y="Density", color= "DBH (cm)") 
    
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 2, ncol = 3)
# plots

ggsave(paste("Species_",var,"_density_points_log.pdf",sep=''),
       path = Path,
       plots, width = 15, height = 10)
```
### Box-plots
```{r, eval=F}
plist <- vector('list', length(sp))

for(p in 1:length(sp)){
  # message(s)
  plist[[p]] <- local({
    # p <- p
    dataS <- data %>% 
      na.omit() %>% 
      filter(ScientificName==sp[p]) %>% 
      group_by(Size) %>% 
      mutate(med=median(get(var))) %>% 
      ungroup() 
    
    label <- dataS %>% 
      group_by(Size) %>% 
      summarise(N = paste("N: ", n()))
    
    if(all(is.na(dataS$Strategy))){cl = "black"
    }else if(unique(na.omit(dataS$Strategy))=="Canopy species"){cl = "#E7B800"
    }else if(unique(na.omit(dataS$Strategy=="Understory species"))){cl = "#009E73"}
    
    
    ggplot(dataS, aes(y= get(var), x= Size, color= Size)) +
      geom_boxplot() +
      geom_point(position = position_jitter(seed = 1, width = 0.2), size=0.3) +
      scale_color_manual(values = c("1-5" = "#00AFBB",
                                    "5-10"= "#CC79A7",
                                    "10-20"= "#E7B800",
                                    ">20" = "#FC4E07"),
                         breaks=c("1-5","5-10","10-20",">20")) + 
      
      geom_text(data = label, aes(label = N, x= Size),
                y = Inf, hjust = -0.1, vjust = 1.5, show.legend = F) +
      
      theme_classic() +
      theme(plot.title = element_text(colour = cl)) + 
      guides(fill = FALSE) +
      labs(title = unique(dataS$ScientificName),
           y= var, color= "DBH (cm)") # Abundances
    
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 3, ncol = 3)
# plots

ggsave(paste("Species_",var,"_niche_boxplot.pdf",sep=''),
       path = Path,
       plots, width = 15, height = 10)

```

### Boxplot per ages - all species
```{r, eval=F}
# bug
plist <- vector('list', round(length(sp)/10))

for(p in 1:round(length(sp)/10)){
  # message(s)
  plist[[p]] <- local({
    # p <- 8
    if (p==1) {start = 1
    }else{start = 10*(p-1) + (p-1)}
    stop = start + 9
    
    S <- data %>%
      select(ScientificName,Strategy,N, cl) %>%
      unique() %>% 
      arrange(Strategy, N) %>%
      slice(start:stop)
    
    dataS <- data %>% 
      filter(ScientificName %in% S$ScientificName) %>% 
      arrange(Strategy, N) %>%
      group_by(ScientificName, Size)  %>% 
      mutate(N_text = paste("N: ", n())) %>% ungroup() 
    
    # str <- dataS %>% select(ScientificName, Strategy, N) %>%
    #   unique() %>% arrange(Strategy, N) 
    
    # cl <- ifelse(str$Strategy =="Understory species" & !is.na(str$Strategy), "#009E73", "#E7B800")
    
    ggplot(dataS, aes(x= get(var), y= ScientificName, fill= Size)) +
      xlim(0,1) +
      geom_boxplot(outlier.colour = NULL, position = "dodge") +
      stat_summary(geom = 'text', aes(label = N_text), fun = max, size=3,
                   position = position_dodge(width = 0.75), hjust = -0.15) +
      
      # geom_point(position = position_jitter(seed = 1, width = 0.2), size=0.3) +
      scale_fill_manual(values = c("1-5" = "#00AFBB",
                                   "5-10"= "#CC79A7",
                                   "10-20"= "#E7B800",
                                   ">20" = "#FC4E07"),
                        breaks=c("1-5","5-10","10-20",">20")) + 
      theme_classic() +
      theme(axis.text.y = element_text(size=12)) +
      # theme(axis.text.y = element_text(colour = cl, size=12)) +
      labs(x= var, col= "DBH (cm)") 
    
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 1, ncol = 1)
# plots

ggsave(paste("Species_",var,"_niche_boxplot_allsp.pdf",sep=''),
       path = Path,
       plots, width = 15, height = 10)

```

### Point plot
```{r, eval=F}
plist <- vector('list', length(sp))

for(p in 1:length(sp)){
  # message(s)
  plist[[p]] <- local({
    # p <- 11
    dataS <- data %>% 
      na.omit() %>% 
      filter(ScientificName==sp[p]) %>% 
      mutate(med = median(get(var)))
    
    if(all(is.na(dataS$Strategy))){cl = "black"
    }else if(unique(na.omit(dataS$Strategy))=="Canopy species"){cl = "#E7B800"
    }else if(unique(na.omit(dataS$Strategy=="Understory species"))){cl = "#009E73"}
    
    
    ggplot(dataS, aes(y= get(var), x= DBHcor, color= DBHcor)) +
      geom_point() +
      geom_hline(aes(yintercept=med), linetype="dashed", size=0.8) +
      
      # scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, by=0.1)) + # fix y
      scale_y_continuous(trans="log", limits = c(0.001, 1)) +
      scale_x_continuous(trans="log") +
      geom_smooth()+
      geom_smooth(method='lm', formula= y~x, col="red") +
      ggpubr::stat_cor(label.x.npc = "left", label.y.npc = "top", col="red") +
      theme_classic() +
      theme(plot.title = element_text(colour = cl)) + 
      guides(fill = FALSE) +
      labs(title = unique(dataS$ScientificName),
           x= "DBH", y= var, color= "DBH (cm)") # Abundances
    
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 3, ncol = 3)
# plots

ggsave(paste("Species_",var,"_niche_points_fixy_log.pdf",sep=''),
       path = Path,
       plots, width = 15, height = 10)

```

# Relation between transmittance and tree height 
```{r}
data <- data %>% 
  filter(!is.na(Transmittance)) %>% 
  filter(!is.na(DBHcor))
```

```{r, eval=F}
COR <- round(cor(data$TreeHeight, data$Transmittance),2) # 0.76

ggplot(data, aes(x= TreeHeight, y= Transmittance)) + 
  geom_point() +
  # geom_quantile(size = 1) +
  # geom_smooth(method= "gam", col="red") +
  geom_text(aes(label = paste("r =",COR)), size = 8, 
            x = -Inf, y = Inf, hjust = -0.2, vjust = 3, show.legend = F) + # hjust = -2, vjust = 1.5
  theme_classic() +
  theme(axis.title= element_text(size=18), axis.text= element_text(size=18)) +
  labs(x= "Tree height (m)", y= "Transmittance")

ggsave("D:/Mes Donnees/PhD/Figures/EnvVar_explo/TreeHeight_vs_Transmittance.png",
       width = 15, height = 10)

```

## Per species
```{r, eval=F}
plist <- vector('list', length(sp))

for(p in 1:length(sp)){
  # message(s)
  plist[[p]] <- local({
    # s <- s
    dataS <- data %>% 
      na.omit() %>% 
      filter(ScientificName==sp[p]) %>% 
      mutate(med = median(get(var)))
    
    if(all(is.na(dataS$Strategy))){cl = "black"
    }else if(unique(na.omit(dataS$Strategy))=="Canopy species"){cl = "#E7B800"
    }else if(unique(na.omit(dataS$Strategy=="Understory species"))){cl = "#009E73"}
    
    
    COR <- round(cor(dataS$TreeHeight, dataS$Transmittance),2) # correlation
    
    ggplot(dataS, aes(x= TreeHeight, y= Transmittance)) + 
      geom_point() +
      # geom_quantile(size = 1) +
      # geom_smooth(method= "gam", col="red") +
      geom_text(aes(label = paste("r =",COR)), size = 5, 
                x = -Inf, y = Inf, hjust = -0.2, vjust = 3, show.legend = F) + # hjust = -2, vjust = 1.5
      theme_classic() +
      theme(axis.title= element_text(size=18), axis.text= element_text(size=18),
            plot.title = element_text(colour = cl)) + 
      labs(title = unique(dataS$ScientificName), x= "Tree height (m)", y= "Transmittance")
    
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 3, ncol = 3)
# plots

ggsave("Species_TreeHeight_vs_Transmittance.pdf",
       path = Path,
       plots, width = 15, height = 10)

```


# Relation between transmittance and DBH 
```{r, eval=F}
COR <- round(cor(data$DBHcor, data$Transmittance),2) # 0.81

ggplot(data, aes(x= DBHcor, y= Transmittance)) + 
  geom_point() +
  # geom_smooth(col="red") +
  geom_text(aes(label = paste("r =",COR)), size = 8, 
            x = Inf, y = -Inf, hjust = 1.5, vjust = -1, show.legend = F) + # hjust = -2, vjust = 1.5
  theme_classic() +
  theme(axis.title= element_text(size=18), axis.text= element_text(size=18)) +
  labs(x= "DBH (cm)", y= "Transmittance")

ggsave("D:/Mes Donnees/PhD/Figures/EnvVar_explo/DBH_vs_Transmittance.png",
       width = 15, height = 10)

```

## Per species
```{r, eval=F}
plist <- vector('list', length(sp))

for(p in 1:length(sp)){
  # message(s)
  plist[[p]] <- local({
    # s <- s
    Data <- data %>% 
      # na.omit() %>% 
      filter(ScientificName==sp[p]) %>% 
      mutate(med = median(get(var)))
    
    COR <- round(cor(Data$DBHcor, Data$Transmittance),2) # correlation
    
    ggplot(Data, aes(x= DBHcor, y= Transmittance)) + 
      geom_point() +
      # geom_smooth(method = "lm", col="red") +
      geom_text(aes(label = paste("r =",COR)), size = 5, 
                x = Inf, y = -Inf, hjust = 1.5, vjust = -1, show.legend = F) + # hjust = -2, vjust = 1.5
      theme_classic() +
      theme(plot.title = element_text(colour = unique(Data$cl)),
            axis.title= element_text(size=18), axis.text= element_text(size=18)) +
      labs(title = sp, x= "DBH (cm)", y= "Transmittance")
    
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 3, ncol = 3)
# plots

ggsave("Species_DBH_vs_Transmittance.pdf",
       path = Path,
       plots, width = 15, height = 10)

```


## MaxTreeHeight
```{r}
data <- data %>% 
  group_by(ScientificName) %>% 
  mutate(MaxDBH = max(DBHcor)) %>% 
  mutate(MaxTreeHeight = max(TreeHeight)) %>% 
  mutate(N = n()) %>% 
  arrange(MaxTreeHeight) %>% 
  ungroup() %>% 
  # select(ScientificName, MaxDBH, MaxTreeHeight, Strategy, N) %>% 
  unique() %>% 
  filter(N>=30)

Q95 = quantile(SpeciesInf$MaxTreeHeight, .95, na.rm=T) # quantile 95%
Q50 = median(SpeciesInf$MaxTreeHeight)
Q05 = quantile(SpeciesInf$MaxTreeHeight, .05, na.rm=T) # quantile 5%
Q05; Q50 ; Q95

ggplot(data, aes(x=MaxTreeHeight)) +
  geom_histogram(bins = 3, fill="#69b3a2", color="#e9ecef", alpha=0.9) #+ # binwidth=5, 
# scale_x_continuous(breaks = seq(-0.5, 24, 1))
# <25; 25-40; 45-48
```

# Relation between transmittance and tree height per category
```{r, eval=F}
minH <- 40
maxH <- round(max(data$MaxTreeHeight),0)
# minH <- as.integer(min(data$MaxTreeHeight))
# maxH <- 23

data %>% 
  # filter(MaxTreeHeight>=minH & MaxTreeHeight< maxH) %>% 
  ggplot(aes(x= TreeHeight, y= Transmittance, col=ScientificName)) + 
  # geom_point(alpha=0.5) +
  # geom_quantile(size = 1) +
  geom_smooth(method= "gam", se=F, size =1) +
  # geom_text(aes(label = paste("Sp max tree height ]",minH,";",maxH,"m]", sep='')),
  #           size = 8, col="black",
  #           x = -Inf, y = Inf, hjust = -0.1, vjust = 3, show.legend = F) + # hjust = -2, vjust = 1.5
  
  facet_wrap(~ Strategy, scales = "free_x", ncol=2) +
  
  theme_classic() +
  theme(strip.text.x = element_text(size=18),
        axis.title= element_text(size=18), axis.text= element_text(size=18),
        legend.title= element_text(size=16), legend.text= element_text(size=16)) +
  guides(color = FALSE) +
  labs(x= "Tree height (m)", y= "Transmittance")

ggsave(paste("D:/Mes Donnees/PhD/Figures/EnvVar_explo/TreeHeight_vs_Transmittance_Strategy",
             minH,"-",maxH,"m.png", sep=''),
       width = 15, height = 10)
```

## Understory species 
```{r, eval=F}
test <- data %>% 
  filter(Strategy=="Understory species") %>%
  mutate(Label = if_else(TreeHeight == MaxTreeHeight, ScientificName, NA_character_))
ggplot(test, aes(x= TreeHeight, y= Transmittance, col=ScientificName)) + 
  geom_smooth(method= "gam", se=F, size =1) +
  
  geomtextpath::geom_textsmooth(data=test, aes(label = ScientificName), method = "gam",
                                hjust = 1, vjust=1, size=6) +
  
  # ggrepel::geom_text_repel(aes(label = label), nudge_x = 2.5) +
  
  # directlabels::geom_dl(data=test,label=test$label, method="maxvar.points", inherit.aes=T) +
  
  # ggrepel::geom_label_repel(aes(label = label),
  #                 nudge_y = 0.01,
  #                 na.rm = TRUE) +
  
  theme_classic() +
  theme(axis.title= element_text(size=18), axis.text= element_text(size=18),
        legend.title= element_text(size=16), legend.text= element_text(size=16)) +
  # guides(color = FALSE) +
  guides(col = guide_legend(ncol = 1)) +
  labs(x= "Tree height (m)", y= "Transmittance")

ggsave(paste("D:/Mes Donnees/PhD/Figures/EnvVar_explo/TreeHeight_vs_Transmittance_UnderstorySplabels.png", sep=''),
       width = 15, height = 10)
```
