---
title: "Spatial distribution of species"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: pdf_document
---
- carte env - espèce, DBH
- relations env - distrib : density plot (x : env, y abondances par espèce)
- ou points en couleur selon le diamètre

Environnment (à partir de l'ALS low alt ?) :
- topographie (DTM)
- drainage du sol (TWI)
- relative elevation
- light (à générer sur les 9 ha + 100 m buffer) (au-dessus (de combien) de chaque arbre, quelle résolution ?)

# Packages
```{r Setup, include = F}
library(tidyverse)
library(data.table)
library(ggforce)
library(sf)
library(raster)
library(terra)
library(tidyterra)
```

# Import cleaned inventory data
```{r, include = F, message=F}
Inventory <- read_csv(
  # "~/PhD/Inventories/Data/Understory/Paracou/ALT_Paracou_9ha_Filtred.csv"
  # "~/PhD/Inventories/Data/Understory/Paracou/ALT_Paracou_9ha_CLEAN.csv"
  "~/PhD/Inventories/Data/Adults_Understory/Paracou/AllP16_filtred.csv"
) %>% 
  arrange(DBHcor)
```

# Import environmental data
HAND : Height Above the Nearest Drainage
```{r}
# Topography
MNT <- terra::rast("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/MNT/dtm2023_HighAlt_25ha_buffer.asc")

# TWI
TWI <- terra::rast("D:/Mes Donnees/PhD/R_codes/PhD/test/Paracou_P16_TWI_5m.tif")

# Height Above the Nearest Drainage (HAND)
elev <- terra::rast("D:/Mes Donnees/PhD/R_codes/PhD/test/Paracou_P16_RelativeElev.tif")

# Zone
P16 <- st_as_sf(raster::shapefile("D:/Mes Donnees/PhD/R_codes/PhD/test/Plot16.shp")) %>% 
  st_set_crs(st_crs(MNT))

# Classes topo (4 classes)
TopoLevels <- st_read("D:/Mes Donnees/PhD/SIG_data/Topo_P16_4classes/Topo4Levels.shp") %>% 
  filter(Plot==16) %>% mutate(TopoTypeEn = ifelse(idTopo ==38, "Downslope", TopoTypeEn)) %>% 
  mutate(TopoTypeEn = recode(TopoTypeEn, "Plateau" = "Hilltop")) %>% 
  st_set_crs(st_crs(MNT)) #%>% 
# st_intersection(P16)

# Light (à faire 25ha)
Light <- read_csv("~/PhD/Env_data_forModel/TreeLightMeth3_4ha.csv") #%>% 
# st_as_sf(coords = c('Xutm','Yutm')) %>% 
# st_set_crs(st_crs(MNT))
```

```{r, eval = F}
ggplot(TopoLevels) +
  geom_sf(data = TopoLevels, aes(fill = TopoTypeEn)) +
  geom_sf(data = sf::st_cast(ALT, "LINESTRING")) +
  scale_fill_manual(values = c("Plateau" = "#009E73",
                               "Slope"= "#E7B800",
                               "Lower slope"= "#bfe6eb", 
                               "Bottomland" = "#1f78b4")) +
  theme_classic() +
  labs(fill= "Topography")

ggplot() + 
  geom_spatraster(data = MNT, aes(fill = Z)) +
  scale_fill_gradientn(name = "Elevation (m)",
                       colors = terrain.colors(30, rev=T, alpha = 0.9),
                       na.value="white") +
  geom_sf(data = sf::st_cast(ALT, "LINESTRING")) +
  theme_classic()

ggplot() + 
  geom_spatraster(data = TWI, aes(fill = Paracou_TWI_5m)) +
  scale_fill_gradientn(name = "TWI",
                       colors =  hcl.colors(12, "Blues", rev = T),
                       na.value="white") +
  geom_sf(data = sf::st_cast(ALT, "LINESTRING")) +
  theme_classic()

ggplot() + 
  geom_spatraster(data = elev, aes(fill = re)) +
  scale_fill_gradientn(name = "Relative elevation to the creek (m)",
                       colors = hcl.colors(45, "Blues"),
                       na.value="white") +
  geom_sf(data = sf::st_cast(ALT, "LINESTRING")) +
  theme_classic()

```

# On the MNT 
```{r, eval = F}
data <- Inventory %>% 
  filter(!is.na(Xutm)) %>% 
  filter(!is.na(Yutm)) %>% 
  filter(ScientificName=="Virola_surinamensis") %>% 
  st_as_sf(coords = c("Xutm", "Yutm")) %>% 
  st_set_crs(st_crs(MNT))

ggplot() + 
  geom_spatraster(data = MNT, aes(fill = Z)) +
  # scale_fill_gradientn(name = "Elevation (m)",
  #                      colors = terrain.colors(30, rev=T, alpha = 0.9),
  #                      na.value="white") +
  scale_fill_gradientn(name = "Elevation (m)",
                       colors = gray.colors(4, start = 0.9, end = 0),
                       na.value="white") +
  geom_sf(data = sf::st_cast(ALT, "LINESTRING")) +
  geom_sf(data, mapping = aes(colour = DBHcor), size = 3) +
  viridis::scale_colour_viridis(name = "DBH (cm)", direction=-1, labels=round) + # trans = "log", 
  # scale_colour_gradient(name = "DBH (cm)",
  #                       low = "#56B1F7", high = "#132B43") +
  labs(title = "Symphonia globulifera distribution") +
  theme_classic() +
  theme(title= element_text(size=16),axis.text= element_text(size=16),
        legend.title= element_text(size=16), legend.text= element_text(size=16)) +
  coord_sf()

# ggsave("Spatial_distribution_of_Symphonia_globulifera_on_MNT.png", width = 15, height = 10)
```

## For each species
```{r}
data <- Inventory %>% 
  select(idTree, SubPlot, ScientificName, DBHcor, Xutm, Yutm, TreeHeight) %>% 
  # filter(ScientificName %in% c("Maytenus_oblongata", "Iryanthera_sagotiana",
  #                                  "Oxandra_asbeckii", "Hymenopus_heteromorphus", "Unonopsis_stipitata")) %>%
  # filter(!is.na(Xutm)) %>% 
  # filter(!is.na(Yutm)) %>% 
  st_as_sf(coords = c("Xutm", "Yutm")) %>% 
  st_set_crs(st_crs(MNT))

```

```{r, eval=F}
plist <- vector('list', length(unique(data$ScientificName)))

for(p in 1:length(unique(data$ScientificName))){
  plist[[p]] <- local({
    data <- data %>% 
      filter(ScientificName==unique(data$ScientificName)[p]) 
    
    ggplot(data) + 
      geom_spatraster(data = MNT, aes(fill = Z)) +
      # scale_fill_gradientn(name = "Elevation (m)",
      #                      colors = terrain.colors(30, rev=T, alpha = 0.9),
      #                      na.value="white") +
      # scale_colour_gradient(name = "DBH (cm)",
      #                       low = "#56B1F7", high = "#132B43") +
      scale_fill_gradientn(name = "Elevation (m)",
                           colors = gray.colors(4, start = 0.9, end = 0),
                           na.value="white") +
      geom_sf(data = sf::st_cast(ALT, "LINESTRING")) +
      geom_sf(mapping = aes(colour = DBHcor), alpha = 0.7) +
      viridis::scale_colour_viridis(name = "DBH (cm)", direction=-1, labels=round) + # , trans = "log"
      theme_classic() +
      guides(fill="none") +
      # geom_text(label = max(data$DBHcor), position ="top")
      annotate(geom = 'text', label = paste("DBH max: ",round(max(data$DBHcor),0),"cm"),
               x = -Inf, y = Inf, hjust = -0.2, vjust = 1.5) +
      coord_sf() +
      labs(title = unique(data$ScientificName))
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 2, ncol = 2)
# plots

# ggsave("Spatial_distribution_of_each_species_on_MNT_notlog.pdf", plots, width = 15, height = 10)
```



# On the TWI 
```{r, eval=F}
data <- Inventory %>% 
  filter(!is.na(Xutm)) %>% 
  filter(!is.na(Yutm)) %>% 
  filter(ScientificName=="Ocotea_nigra") %>% 
  st_as_sf(coords = c("Xutm", "Yutm")) %>% 
  st_set_crs(st_crs(MNT))

ggplot() + 
  geom_spatraster(data = TWI, aes(fill = Paracou_TWI_5m)) +
  scale_fill_gradientn(name = "TWI",
                       colors =  hcl.colors(12, "Blues", rev = T),
                       na.value="white") + 
  geom_sf(data = sf::st_cast(ALT, "LINESTRING")) +
  geom_sf(data, mapping = aes(colour = DBHcor)) +
  scale_colour_gradient(name = "DBH (cm)",
                        low = "#E7B800", high = "#FC4E07") +
  theme_classic() +
  coord_sf()

```

## For each species
```{r, eval=F}
plist <- vector('list', length(unique(data$ScientificName)))

for(p in 1:length(unique(data$ScientificName))){
  message(s)
  plist[[p]] <- local({
    # s <- s
    data %>% 
      filter(ScientificName==unique(data$ScientificName)[p]) %>% 
      ggplot() + 
      geom_spatraster(data = TWI, aes(fill = Paracou_TWI_5m)) +
      scale_fill_gradientn(name = "TWI",
                           colors =  hcl.colors(12, "Blues", rev = T),
                           na.value="white") +
      geom_sf(data = sf::st_cast(ALT, "LINESTRING")) +
      
      geom_sf(mapping = aes(colour = DBHcor)) +
      scale_colour_gradient(name = "DBH (cm)",
                            low = "#E7B800", high = "#FC4E07") + 
      theme_classic() +
      guides(fill="none") +
      coord_sf() +
      labs(title = unique(data$ScientificName)[p])
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 2, ncol = 2)

# ggsave("Spatial_distribution_of_each_species_on_TWI.pdf", plots, width = 15, height = 10) 

```

# On the relative elevation 
```{r, eval=F}
data <- Inventory %>% 
  filter(!is.na(Xutm)) %>% 
  filter(!is.na(Yutm)) %>% 
  filter(ScientificName=="Ocotea_nigra") %>% 
  st_as_sf(coords = c("Xutm", "Yutm")) %>% 
  st_set_crs(st_crs(MNT))


ggplot(data, mapping = aes(x = Xutm, y = Yutm)) +
  geom_point(aes(col=ScientificName))

ggplot() + 
  geom_spatraster(data = elev, aes(fill = re)) +
  scale_fill_gradientn(name = "Relative elevation to the creek (m)",
                       colors = hcl.colors(45, "Blues"),
                       na.value="white") +
  geom_sf(data = sf::st_cast(ALT, "LINESTRING")) +
  geom_sf(data, mapping = aes(colour = DBHcor)) +
  scale_colour_gradient(name = "DBH (cm)",
                        low = "#E7B800", high = "#FC4E07") +
  theme_classic() +
  coord_sf()

```

## For each species
```{r, eval=F}
plist <- vector('list', length(unique(data$ScientificName)))

for(p in 1:length(unique(data$ScientificName))){
  message(s)
  plist[[p]] <- local({
    # s <- s
    data %>% 
      filter(ScientificName==unique(data$ScientificName)[p]) %>% 
      ggplot() + 
      geom_spatraster(data = elev, aes(fill = re)) +
      scale_fill_gradientn(name = "Relative elevation to the creek (m)",
                           colors = hcl.colors(45, "Blues"),
                           na.value="white") +
      geom_sf(data = sf::st_cast(ALT, "LINESTRING")) +
      
      geom_sf(mapping = aes(colour = DBHcor)) +
      scale_colour_gradient(name = "DBH (cm)",
                            low = "#E7B800", high = "#FC4E07") + 
      theme_classic() +
      guides(fill="none") +
      coord_sf() +
      labs(title = unique(data$ScientificName)[p])
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 2, ncol = 2)

# ggsave("Spatial_distribution_of_each_species_on_relativeelevation.pdf", plots, width = 15, height = 10) 
```

# Niches
relations env - distrib : density plot (x : env, y abondances par espèce)
- ou points en couleur selon le diamètre

## Env
```{r}
# data %>% filter(is.na(geometry))
alt <- extract(MNT, data) %>% # extract z from MNT
  rename(Elevation = Z) %>% 
  select(-ID)

data <- data %>% cbind(alt)

XY <- st_coordinates(data) # stock coordinates
st_geometry(data) <- NULL # no more sf object
data <- cbind(data, XY) %>% # bind XY coord
  rename(Xutm = X) %>% rename(Yutm = Y)

data <- data %>% left_join(Light, by=c("idTree","Xutm","Yutm"))
```

## Age
```{r}
data <- data %>%
  mutate(Size = factor(case_when(
    # DBHcor < 10 ~ "1-10",
    # DBHcor >= 10 ~ ">10"), levels = c("1-10",">10")) 
    DBHcor < 5 ~ "1-5",
    DBHcor >= 5 & DBHcor < 10 ~ "5-10",
    DBHcor >= 10 & DBHcor < 20 ~ "10-20",
    DBHcor >= 20 ~ ">20"), levels = c("1-5","5-10","10-20",">20"))
  )
```

# Plot for which var
```{r}
## MNT :
# var <- "Elevation"
# bin <- 1
## Light :
var <- "Transmittance"
bin <- 0.1
data <- data %>% filter(SubPlot %in% c(14,15,19,20)) # TEMPORAIRE 4ha seulement # 8026 rows
```

```{r, eval=F}
data %>% 
  na.omit() %>% # des NA pcq MNT pas assez grand (a faire)
  filter(ScientificName == "Iryanthera_hostmannii") %>% 
  group_by(Size) %>% 
  mutate(med=median(get(var))) %>% 
  ungroup() %>% 
  ggplot(aes(x= get(var), color= Size, fill= Size)) +
  geom_histogram(binwidth=1,alpha=0.2) +
  geom_vline(aes(xintercept=med, color=Size), linetype="dashed", size=0.8) +
  theme_classic() +
  facet_wrap(~ Size, scales = "free_y", ncol=1) +
  guides(fill = FALSE) +
  labs(x= var, y="Abundances", color= "DBH (cm)") # Abundances
```

## Density plot (without ontogeny)
```{r, eval=F}
# datainit <- data
plist <- vector('list', length(unique(data$ScientificName)))

for(p in 1:length(unique(data$ScientificName))){
  # message(s)
  plist[[p]] <- local({
    # s <- s
    dataS <- data %>% 
      na.omit() %>% # des NA pcq MNT pas assez grand (a faire)
      filter(ScientificName==unique(data$ScientificName)[p]) %>% 
      mutate(med=median(get(var))) %>% 
      ungroup() 
    
    label <- dataS %>% 
      summarise(N = paste("N: ", n()))
    
    
    ggplot(dataS, aes(x= get(var))) +
      geom_histogram(binwidth=bin, alpha=0.2) + #  binwidth=1, aes(y=..density..), 
      # geom_density(aes(y = after_stat(count)), alpha=0.4) + # aes(y = after_stat(count)),
      geom_vline(aes(xintercept=med), linetype="dashed", size=0.8) +
      
      geom_text(data = label, aes(label = N),
                x = Inf, y = Inf, hjust = 2, vjust = 3, show.legend = F) + # hjust = -2, vjust = 1.5
      
      theme_classic() +
      guides(fill = FALSE) +
      labs(title = unique(dataS$ScientificName),
           x= var, y="Abundances") # Density
    
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 3, ncol = 3)
# plots

ggsave(paste("Species_",var,"_niche_density_without_ontogeny.pdf",sep=""), plots, width = 15, height = 10)
```

## With ontogeny
### Hist per size class
```{r, eval=F}
plist <- vector('list', length(unique(data$ScientificName)))

for(p in 1:length(unique(data$ScientificName))){
  # message(s)
  plist[[p]] <- local({
    # s <- s
    data <- data %>% 
      na.omit() %>% # des NA pcq MNT pas assez grand (a faire)
      filter(ScientificName==unique(data$ScientificName)[p]) %>% 
      group_by(Size) %>% 
      mutate(med=median(get(var))) %>% 
      ungroup() 
    
    label <- data %>% 
      group_by(Size) %>% 
      summarise(N = paste("N: ", n()))
    
    
    ggplot(data, aes(x= get(var))) +
      geom_histogram(binwidth=bin , aes(color= Size, fill= Size),
                     alpha=0.2) + 
      geom_vline(aes(xintercept=med, color=Size), linetype="dashed", size=0.8) +
      
      scale_color_manual(values = c("1-5" = "#00AFBB",
                                    "5-10"= "#CC79A7",
                                    "10-20"= "#E7B800",
                                    ">20" = "#FC4E07"),
                         breaks=c("1-5","5-10","10-20",">20")) + 
      
      scale_fill_manual(values = c("1-5" = "#00AFBB",
                                   "5-10"= "#CC79A7",
                                   "10-20"= "#E7B800",
                                   ">20" = "#FC4E07"),
                        breaks=c("1-5","5-10","10-20",">20")) +
      
      facet_wrap(~ Size, scales = "free_y", ncol=1) +
      
      geom_text(data = label, aes(label = N, color=Size),
                # x = -Inf, y = Inf, hjust = -0.2, vjust = 1.5, show.legend = F) +
                x = Inf, y = Inf, hjust = 2, vjust = 3, show.legend = F) + # hjust = -2, vjust = 1.5
      
      
      theme_classic() +
      guides(fill = FALSE) +
      labs(title = unique(data$ScientificName),
           x= var, y="Abundances") # Density
    
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 2, ncol = 3)
# plots

ggsave(paste("Species_",var,"_niche_hist.pdf",sep=''), plots, width = 15, height = 10)
```

### Box-plots
```{r, eval=F}
plist <- vector('list', length(unique(data$ScientificName)))

for(p in 1:length(unique(data$ScientificName))){
  # message(s)
  plist[[p]] <- local({
    # s <- s
    data <- data %>% 
      na.omit() %>% # des NA pcq MNT pas assez grand (a faire)
      filter(ScientificName==unique(data$ScientificName)[p]) %>% 
      group_by(Size) %>% 
      mutate(med=median(get(var))) %>% 
      ungroup() 
    
    label <- data %>% 
      group_by(Size) %>% 
      summarise(N = paste("N: ", n()))
    
    
    ggplot(data, aes(y= get(var), x= Size, color= Size)) +
      geom_boxplot() +
      geom_point(position = position_jitter(seed = 1, width = 0.2), size=0.3) +
      scale_color_manual(values = c("1-5" = "#00AFBB",
                                    "5-10"= "#CC79A7",
                                    "10-20"= "#E7B800",
                                    ">20" = "#FC4E07"),
                         breaks=c("1-5","5-10","10-20",">20")) + 
      
      geom_text(data = label, aes(label = N, x= Size),
                y = Inf, hjust = -0.1, vjust = 1.5, show.legend = F) +
      
      theme_classic() +
      guides(fill = FALSE) +
      labs(title = unique(data$ScientificName),
           y= var, color= "DBH (cm)") # Abundances
    
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 3, ncol = 3)
# plots

ggsave(paste("Species_",var,"_niche_boxplot.pdf",sep=''), plots, width = 15, height = 10)

```

### Point plot
```{r, eval=F}
plist <- vector('list', length(unique(data$ScientificName)))

for(p in 1:length(unique(data$ScientificName))){
  # message(s)
  plist[[p]] <- local({
    # s <- s
    data <- data %>% 
      na.omit() %>% # des NA pcq MNT pas assez grand (a faire)
      filter(ScientificName==unique(data$ScientificName)[p]) %>% 
      mutate(med = median(get(var)))
    
    ggplot(data, aes(y= get(var), x= DBHcor, color= DBHcor)) +
      geom_point() +
      geom_hline(aes(yintercept=med), linetype="dashed", size=0.8) +
      theme_classic() +
      guides(fill = FALSE) +
      labs(title = unique(data$ScientificName),
           x= "DBH", y= var, color= "DBH (cm)") # Abundances
    
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 3, ncol = 3)
# plots

ggsave(paste("Species_",var,"_niche_points.pdf",sep=''), plots, width = 15, height = 10)

```
# Relation between transmittance and tree height 
```{r, eval=F}
COR <- round(cor(data$TreeHeight, data$Transmittance),2) # 0.76

ggplot(data, aes(x= TreeHeight, y= Transmittance)) + 
  geom_point() +
  geom_quantile(size = 1) +
  geom_smooth(method= "gam", col="red") +
  geom_text(aes(label = paste("r =",COR)), size = 8, 
            x = -Inf, y = Inf, hjust = -0.2, vjust = 3, show.legend = F) + # hjust = -2, vjust = 1.5
  theme_classic() +
  theme(axis.title= element_text(size=18), axis.text= element_text(size=18)) +
  labs(x= "Tree height (m)", y= "Transmittance")

ggsave("D:/Mes Donnees/PhD/Figures/EnvVar_explo/TreeHeight_vs_Transmittance.png",
       width = 15, height = 10)

```

## Per species
```{r, eval=F}
plist <- vector('list', length(unique(data$ScientificName)))

for(p in 1:length(unique(data$ScientificName))){
  # message(s)
  plist[[p]] <- local({
    # s <- s
    data <- data %>% 
      na.omit() %>% # des NA pcq MNT pas assez grand (a faire)
      filter(ScientificName==unique(data$ScientificName)[p]) %>% 
      mutate(med = median(get(var)))
    
    COR <- round(cor(data$TreeHeight, data$Transmittance),2) # correlation
    
    ggplot(data, aes(x= TreeHeight, y= Transmittance)) + 
      geom_point() +
      geom_quantile(size = 1) +
      geom_smooth(method= "gam", col="red") +
      geom_text(aes(label = paste("r =",COR)), size = 5, 
                x = -Inf, y = Inf, hjust = -0.2, vjust = 3, show.legend = F) + # hjust = -2, vjust = 1.5
      theme_classic() +
      theme(axis.title= element_text(size=18), axis.text= element_text(size=18)) +
      labs(x= "Tree height (m)", y= "Transmittance")
    
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 3, ncol = 3)
# plots

ggsave("Species_TreeHeight_vs_Transmittance.pdf", plots, width = 15, height = 10)

```

## Strategy
```{r}
strategy <- read_delim("~/PhD/Inventories/EFT2023_Understory/dcl.csv", 
                       delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  select(genre_esp, Strategy) %>%
  rename(ScientificName = genre_esp) %>%
  mutate(Strategy = ifelse(Strategy== "#N/A", NA, Strategy)) %>%
  mutate(Strategy = recode(Strategy, "TallSp" = "Canopy species" , "UnderstorySp" = "Understory species")) %>% 
  unique()
unique(strategy$Strategy)

data <- data %>% left_join(strategy, by="ScientificName")
```
## MaxTreeHeight
```{r}
data <- data %>% 
  group_by(ScientificName) %>% 
  mutate(MaxDBH = max(DBHcor)) %>% 
  mutate(MaxTreeHeight = max(TreeHeight)) %>% 
  mutate(N = n()) %>% 
  arrange(MaxTreeHeight) %>% 
  ungroup() %>% 
  # select(ScientificName, MaxDBH, MaxTreeHeight, Strategy, N) %>% 
  unique() %>% 
  filter(N>=30)

Q95 = quantile(SpeciesInf$MaxTreeHeight, .95, na.rm=T) # quantile 95%
Q50 = median(SpeciesInf$MaxTreeHeight)
Q05 = quantile(SpeciesInf$MaxTreeHeight, .05, na.rm=T) # quantile 5%
Q05; Q50 ; Q95

ggplot(SpeciesInf, aes(x=MaxTreeHeight)) +
  geom_histogram(bins = 3, fill="#69b3a2", color="#e9ecef", alpha=0.9) #+ # binwidth=5, 
# scale_x_continuous(breaks = seq(-0.5, 24, 1))
# <25; 25-40; 45-48
```

# Relation between transmittance and tree height per category
```{r, eval=F}
minH <- 40
maxH <- round(max(data$MaxTreeHeight),0)
# minH <- as.integer(min(data$MaxTreeHeight))
# maxH <- 23

data %>% 
  filter(MaxTreeHeight>=minH & MaxTreeHeight< maxH) %>% 
  ggplot(aes(x= TreeHeight, y= Transmittance, col=ScientificName)) + 
  # geom_point(alpha=0.5) +
  # geom_quantile(size = 1) +
  geom_smooth(method= "gam", se=F, size =1) +
  geom_text(aes(label = paste("Sp max tree height ]",minH,";",maxH,"m]", sep='')),
            size = 8, col="black",
            x = -Inf, y = Inf, hjust = -0.1, vjust = 3, show.legend = F) + # hjust = -2, vjust = 1.5
  theme_classic() +
  theme(axis.title= element_text(size=18), axis.text= element_text(size=18),
        legend.title= element_text(size=16), legend.text= element_text(size=16)) +
  labs(x= "Tree height (m)", y= "Transmittance")

ggsave(paste("D:/Mes Donnees/PhD/Figures/EnvVar_explo/TreeHeight_vs_Transmittance_SpMaxTreeTeight",
             minH,"-",maxH,"m.png", sep=''),
       width = 15, height = 10)
```
