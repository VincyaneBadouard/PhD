---
title: "Clean inventories"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: pdf_document
---
Début de l’inventaire :  novembre 2020
Fin de l'inventaire : décembre 2023

Paracou - P16:
4 ha : 19,20,14,15 
9 ha : 13,14,15,18,19,20,23,24,25

Pour les  4 1ers ha les arbres CIRAD n'ont pas été mesurés par l'équipe ALT, ce sont les DBH du dataset CIRAD 2020.

Pour les autres subplots, les DBH des arbres CIRAD ont été mesuré par l'équipe ALT.

Nouragues - Petit Plateau:
202,203,204,212,213,214

# Packages
```{r Setup, include = F}
library(tidyverse)
library(data.table)
library(readr)
library(sf)
# library() # TreeData

# remotes::install_github("EcoFoG/EcoFoG", build_vignettes = F)
# library(EcoFoG)
```

# Import inventory data
Paracou Plot 16
Nouragues Petit Plateau
```{r}
# Adults <- Guyafor2df(UID = "Vincyane.Badouard", PWD = "Vincyane973+", Driver = "SQL Server",WHERE="Forest='Paracou' AND Plot='16'") #  AND CensusYear=2020
# write.csv(Adults, "D:/Mes Donnees/PhD/Inventories/Data/Adults/Paracou16_2020.csv")
# rm(Adults)
# Adults <- Guyafor2df(UID = "Vincyane.Badouard", PWD = "Vincyane973+", Driver = "SQL Server",WHERE="Forest='Nouragues'AND Plot='Petit_Plateau' AND CensusYear=2022")
# write.csv(Adults, "D:/Mes Donnees/PhD/Inventories/Data/Adults/NouraguesPetitPlateau_2022.csv")
# rm(Adults)
```

```{r,include = F, message=F}
UnderstoryP <- read_csv("~/PhD/Inventories/Data/Understory/Paracou/ALT_Paracou9ha_20240906F.csv")
UnderstoryN <- read_csv("~/PhD/Inventories/Data/Understory/Nouragues/Nouragues_ALT_20240910.csv")

AdultsP <- read_csv("~/PhD/Inventories/Data/Adults/Paracou16_2020.csv") %>% 
  filter(SubPlot %in% c(13,14,15,18,19,20,23,24,25)) # 9 ha
AdultsN <- read_csv("~/PhD/Inventories/Data/Adults/NouraguesPetitPlateau_2022.csv") %>%
  filter(SubPlot %in% c(202,203,204,212,213,214)) # 6 ha
```

# Manage columns names
```{r}
# to detect differences in column names between datasets
names(UnderstoryN)[!names(UnderstoryN) %in% names(UnderstoryP)]
names(UnderstoryP)[!names(UnderstoryP) %in% names(UnderstoryN)]

names(UnderstoryN) <- str_to_sentence(names(UnderstoryN)) # start by uppercase
UnderstoryN <- UnderstoryN %>%
  select(- "...1") %>%
  rename_at(c("Pom", "Dbh"), # uppercase
            .funs = toupper) %>%
  rename(TreeID = Treeid, StemID = Stemid, Subplot=Plot,
         CensusYear = Censusyear, CensusDate = Censusdate, Dead = Mort,
         BotaCertainty = Botacertainty, ScientificName = Scientificname, Cod.CTFS=Codctfs) %>%
  mutate(Site = "Nouragues") %>%
  mutate(Plot = "Petit_Plateau") %>%
  mutate(ProjectArea = 6)

UnderstoryP <- UnderstoryP %>% 
  select(-c("...1", "X.1")) %>% 
  mutate(Plot = "16") %>% 
  mutate(ProjectArea = 9)

# "Diam_cirad"
```

# Strategy data (canopy vs understory species)
```{r}
strategy <- read_delim("~/PhD/Inventories/EFT2023_Understory/dcl.csv", 
                       delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  select(genre_esp, Strategy) %>%
  rename(ScientificName = genre_esp) %>%
  mutate(Strategy = ifelse(Strategy== "#N/A", NA, Strategy)) %>%
  mutate(Strategy = recode(Strategy, "TallSp" = "Canopy species" , "UnderstorySp" = "Understory species")) %>% 
  unique()
unique(strategy$Strategy)

Understory <- list(UnderstoryP, UnderstoryN)
Understory <- lapply(Understory, function(x) left_join(x, strategy, by="ScientificName"))

UnderstoryP <- Understory[[1]]
UnderstoryN <- Understory[[2]]

sum(is.na(UnderstoryP$Strategy)) # 6875
sum(is.na(UnderstoryN$Strategy)) # 20005
```

# Checks
Vérifications :
- the 9 subplots (done)
- données manquantes (done)
- idStem uniques (done)
- noms d'espèces uniques A FAIRE
- DBH au même POM (1.30) ? que faire pour les ALT ? A FAIRE
- arbres cirad tous présents A TRAITER (attention arbres sans stem 1)
- joindre les infos manquantes des cirad (**DBH le plus récent**, bota, coordonnées)

# Only subplots of interest
P : c(13,14,15,18,19,20,23,24,25)
N : c(202,203,204,212,213,214)
```{r, eval = F}
unique(UnderstoryN$Subplot)
all(UnderstoryP$Subplot %in% c(13,14,15,18,19,20,23,24,25))
all(UnderstoryN$Subplot  %in% c(202,203,204,212,213,214))
```

```{r}
data <- UnderstoryP
Adults <- AdultsP
```

# Missing data (NA)
```{r, eval = F}
data %>%
  filter(DBH==0)

data <- data %>% # UnderstoryP
  filter(DBH>=1 | is.na(DBH)) # P : 41763, N : 29010
# names(data)[sapply(data, anyNA)]

mycols <- data %>% select("TreeID","StemID", 
                          "DBH","Xutm","Yutm", "X", "Y", "ScientificName") # "X", "Y"

mycols[!complete.cases(mycols), ] # with NA
# P: 3,688, 177 rows  en enlevant le scientifname
# N: 12,746, 6 rows en enlevant le scientifname

# Missing DBH
data %>% filter(is.na(DBH) & is.na(Guyafor.nb)) %>% select("Guyafor.nb", "TreeID","StemID", 
                                                           "DBH","Xutm","Yutm", "X", "Y", "ScientificName") #  31 ALT
data %>% filter(is.na(DBH) & !is.na(Guyafor.nb)) %>% select("Guyafor.nb", "TreeID","StemID", 
                                                            "DBH","Xutm","Yutm", "X", "Y", "ScientificName") #  92 cirad

# Missing ID
data %>% filter((is.na(TreeID) | is.na(StemID)) & is.na(Guyafor.nb)) %>% select("Guyafor.nb", "TreeID","StemID", 
                                                                                "DBH","Xutm","Yutm", "X", "Y", "ScientificName") # 0

data %>% filter((is.na(TreeID) | is.na(StemID)) & !is.na(Guyafor.nb)) %>% select("Guyafor.nb", "TreeID","StemID", 
                                                                                 "DBH","Xutm","Yutm", "X", "Y", "ScientificName") # 13
# Missing coordinates
data %>% filter(((is.na(Xutm) | is.na(Yutm)) & (is.na(X) | is.na(Y))) & is.na(Guyafor.nb)) %>% select("Guyafor.nb", "TreeID","StemID", 
                                                                                                      "DBH","Xutm","Yutm", "X", "Y", "ScientificName")
data %>% filter(((is.na(Xutm) | is.na(Yutm)) & (is.na(X) & is.na(Y))) & !is.na(Guyafor.nb)) %>% select("Guyafor.nb", "TreeID","StemID", 
                                                                                                       "DBH","Xutm","Yutm", "X", "Y", "ScientificName")

```
# Unique IdStem
- Unique IdStem in the census
- Unique IdTree-IdStem association
- Unique IdStem-coordinates association
```{r, eval = F}
# Check duplicated StemID
data[!is.na(data$StemID) & duplicated(data$StemID),] # oui il y a des StemID dupliqués

source("~/PhD/R_codes/PhD/Inventory_scripts/Functions/GeneralErrorsDetection.R")

# rename columns for the function
Data <- data %>%
  rename(IdStem = StemID, IdTree = TreeID,
         Year = CensusYear,
         XTreeUTM=Xutm, YTreeUTM=Yutm, Diameter=DBH)

Data <- GeneralErrorsDetection(Data)

unique(Data$Comment)
Data %>% filter(Comment!="") %>% select(Comment, IdTree, IdStem, XTreeUTM, YTreeUTM, Family, Genus, Species, ScientificName, Diameter) 

multistems <- Data %>% filter(!is.na(IdStem)) %>% filter(grepl("Duplicated 'IdStem'", Comment)) %>%
  select(Comment, IdTree, IdStem, Guyafor.nb, Diameter, Genus, ScientificName, XTreeUTM, YTreeUTM, Probleme)

dupli <- unique((multistems %>% filter(grepl("Duplicated row", Comment)))$IdStem)

multistems <- multistems %>% filter(!IdStem %in% dupli)
multistems 
length(unique(multistems$IdStem))
```

# Bota
```{r, eval = F}
source("~/PhD/R_codes/PhD/Inventory_scripts/Functions/BotanicalCorrection.R")
Data <- BotanicalCorrection(Data, DetectOnly = T)

unique(Data$Comment)
Data %>% filter(Comment!="") %>% select(Comment, IdTree, IdStem, Family, Genus, Species, ScientificName)
Data %>% filter(Comment=="Different botanical informations (Family, ScientificName) for a same IdTree") %>%
  select(Comment, IdTree, IdStem, Guyafor.nb, Diameter, Family, Genus, Species, ScientificName)

# Check the scientific names list
sort(unique(data$ScientificName))

# - genre_sp
# - genre_cf_espèce 
# - .subsp. 
# -.var.
# - _aff. c'est quoi ?
# - Rinorea_idem181298 (138 individus)
# attention ya un "Rinorea_idem181298"


data %>%
  # filter(grepl("_sp", ScientificName) & grepl("\\.", ScientificName)) %>%
  # filter(grepl("_cf_", ScientificName)) %>%
  filter(grepl("_aff", ScientificName) & grepl("\\.", ScientificName)) %>%
  # filter(grepl("subsp", ScientificName) & grepl("\\.", ScientificName)) %>%
  # filter(grepl("var", Species) & grepl("\\.", ScientificName)) %>%
  select(Species) %>% unique()

sp_abundances <- data %>%
  filter(!is.na(ScientificName)) %>%
  filter(ScientificName!="Tres haut") %>%
  filter(!grepl("indet", ScientificName)) %>%
  filter(!grepl("Indet", ScientificName)) %>%
  filter(!grepl("aceae", ScientificName)) %>%
  filter(!(grepl("_sp", ScientificName) & grepl("\\.", ScientificName))) %>% # only genus
  filter(!(grepl("_aff", ScientificName) & grepl("\\.", ScientificName))) %>% # identif not sure
  filter(!grepl("_cf_", ScientificName)) %>% # identif not sure
  mutate(ScientificName_c = sub("\\..*", "", ScientificName)) %>% 
  mutate(SubSpecies = str_extract(ScientificName,"(?<=\\.).*")) %>% 
  rename(ScientificName_old = ScientificName,
         ScientificName = ScientificName_c) %>% 
  group_by(ScientificName) %>%
  summarise(N = n()) %>%
  ungroup() # 557 sp

# write.csv(sp_abundances, "~/PhD/Inventories/Data/Understory/Paracou/Species_abundances.csv")
```

# POM
```{r, eval = F}
DiffPOM <- data %>% 
  filter(DBH<10) %>%  filter(POM!=130) %>% select(DBH,POM) # 61/42,524 ind
range(DiffPOM$POM) ; range(DiffPOM$DBH)

small <- data %>% 
  filter(DBH<10)

nrow(DiffPOM)/nrow(small)*100 # 0.16 %

ggplot(DiffPOM, aes(x=POM)) +
  geom_bar(width = 1)
```


# Check if the cirad trees are all in the understory inventories
Guyafor.nb
TreeID
Subplot

- tous les arbres cirad

## Guyafor.nb
```{r, eval = F}
guyafor <- data %>% filter(!is.na(Guyafor.nb)) %>% filter(DBH < 10)
# %>% select(StemID) %>% unique()
range(guyafor$DBH) # 1.1 - 9.8
```

```{r, eval = F}
data <- data %>% 
  mutate(CIRADid= tstrsplit(Guyafor.nb, split = "_")[[1]]) %>% #1er elmt  
  mutate(CIRADplot= tstrsplit(Guyafor.nb, split = "_")[[2]]) %>%  #2nd
  mutate(suplot = tstrsplit(TreeID, split = "_")[[1]]) %>% #1er elmt  
  mutate(ID = tstrsplit(TreeID, split = "_")[[2]]) #2nd


all(na.omit(data$CIRADplot == data$Subplot)) # il ya des erreurs dans les n° de subplots des identifiants cirad
data %>% filter(CIRADplot != Subplot)
all(na.omit(data$suplot == data$Subplot)) # il ya des erreurs dans les n° de subplots les TreeID

Adults <- Adults %>% 
  filter(CodeAlive == T) %>%
  unite(col = "CIRAD", c("TreeFieldNum", "SubPlot"),
        sep = "_", na.rm = F, remove = F) %>% 
  mutate(CIRAD = gsub("[[:space:]]", "", CIRAD)) %>%
  mutate(CIRAD = str_squish(CIRAD)) # remove double spaces

data <- data %>% 
  unite(col = "CIRAD", c("CIRADid", "Subplot"),
        sep = "_", na.rm = F, remove = F) %>% 
  mutate(CIRAD = gsub("[[:space:]]", "", CIRAD)) %>% 
  mutate(CIRAD = str_squish(CIRAD)) # remove double spaces

Adults$CIRAD %in% data$CIRAD | Adults$CIRAD %in% data$Guyafor.nb # Guyafor.nb has some different suplot numer than SubPlot

MissingCirad <- Adults %>% 
  filter(!(CIRAD %in% data$CIRAD|CIRAD %in% data$Guyafor.nb))

length(unique(MissingCirad$CIRAD)) # 315 cirad trees oubliés
unique(MissingCirad$SubPlot) %in% c(13,14,15,18,19,20,23,24,25)
length(unique(data$CIRAD)); length(unique(Adults$CIRAD))- length(unique(data$Guyafor.nb))
MissingCirad %>% filter(CodeAlive==F)

all(data[!is.na(data$Guyafor.nb),]$Stem.nb==1) # cirad stem id
stems <- data[!is.na(data$Guyafor.nb) & data$Stem.nb!=1,]$Guyafor.nb # cirad stem id >1
stem1 <- data[data$Guyafor.nb %in% stems & data$Stem.nb==1,]$Guyafor.nb # cirad stem id == 1

#!! ATTENTION cirad trees without stem 1 !! (plus maintenant)
stems[!stems %in% stem1] # cirad with multiple stems but without a stem 1
```

# Positions
```{r, eval = F}
data_sf <- data %>% 
  mutate(CIRAD = ifelse(!is.na(Guyafor.nb), T, F)) %>% 
  select(StemID, CIRAD, Subplot, Xutm, Yutm) %>% na.omit() %>% 
  mutate(Subplot = as.factor(Subplot)) %>% 
  st_as_sf(coords = c("Xutm", "Yutm"))

missingCIRAD_sf <- MissingCirad %>% 
  # select(StemID, CIRAD, Subplot, Xutm, Yutm) %>% na.omit() %>% 
  # mutate(Subplot = as.factor(SubPlot)) %>% 
  st_as_sf(coords = c("Xutm", "Yutm"))


ggplot() +
  geom_sf(data=missingCIRAD_sf, aes(fill="missingCIRAD"), size = 0.5) +
  geom_sf(data=data_sf, aes(col=Subplot), size = 0.5) +
  scale_fill_manual(name = "Missing CIRAD trees",
                    values = c("missingCIRAD" = "black")) +
  theme_classic()

ggsave(paste("ALT", unique(data$Site), unique(data$Plot),"missingCIRAD.png", sep="_"), path = "D:/Mes Donnees/PhD/Figures/inventory", width = 30, height = 20, units = "cm", dpi=800, bg="white")


for(p in c(13,14,15,18,19,20,23,24,25)){
  
  missing <- missingCIRAD_sf %>% 
    filter(SubPlot== as.character(p))
  
  print(
    data_sf %>% 
      filter(Subplot== as.character(p)) %>% 
      ggplot() +
      geom_sf(data=missing, col="black", size = 1) +
      geom_sf(aes(col=CIRAD),size = 1.5) +
      theme_classic() +
      labs(title = paste("Plot",p))
  )
}


```

# Stem number
```{r, eval = F}
all(data[!is.na(data$TreeID),]$Stem.nb==1) # cirad stem id
stems <- data[!is.na(data$TreeID) & data$Stem.nb!=1,]$TreeID # cirad stem id >1
stem1 <- data[data$TreeID %in% stems & data$Stem.nb==1,]$TreeID # cirad stem id == 1

#!! ATTENTION trees without stem 1 !!
stems[!stems %in% stem1] # trees with multiple stems but without a stem 1

stems <- data[!is.na(data$Stem.nb) & data$Stem.nb!=1,] # multistems identifiées
(nrow(stems) + (nrow(multistems)-length(unique(multistems$IdStem))))/nrow(data)*100 # 0.09 % que stems,  1.5 % avec les stems mal codées

multistems <- multistems %>% rename(StemID = IdStem, TreeID = IdTree, DBH=Diameter, Xutm = XTreeUTM, Yutm = YTreeUTM) # multistems probables

totalmultistems <- stems %>% bind_rows(multistems) %>% filter(!is.na(ScientificName))
length(unique(totalmultistems$TreeID))/length(unique(data$TreeID))*100 # 1299 trees; 1.4%

nrow(totalmultistems %>% filter(is.na(Guyafor.nb)) %>% select(TreeID) %>% unique())/length(unique(data$TreeID))*100 # 433; 1.2% ALT

nrow(totalmultistems %>% filter(!is.na(Guyafor.nb)) %>% select(TreeID) %>% unique())/length(unique(data$TreeID))*100 # 46; 0.1 % Cirad

Multistems_sp <- multistems %>%  # sans stems pcq il sont apparemment dupliqué (Probleme)
  select(TreeID, ScientificName) %>%  unique() %>% 
  group_by(ScientificName) %>%
  summarise(N = n()) %>% # mutate
  # select(ScientificName,Strategy, DBH, N) %>% 
  arrange(desc(N))

write.csv(Multistems_sp, "D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/Multistems_sp.csv")

# On bottomlands ?
TopoLevels <- st_read("D:/Mes Donnees/PhD/SIG_data/Topo_P16_4classes/Topo4Levels.shp") %>% 
  filter(Plot==16) %>% mutate(TopoTypeEn = ifelse(idTopo ==38, "Lower slope", TopoTypeEn))

multistems_plot <- multistems %>% 
  select(TreeID, ScientificName, Xutm, Yutm) %>%  unique() %>% 
  filter(ScientificName=="Guarea_costata") %>% 
  filter(!is.na(Xutm)) %>% 
  filter(!is.na(Yutm)) %>% 
  st_as_sf(coords = c("Xutm", "Yutm")) %>% 
  st_set_crs(st_crs(TopoLevels))

ggplot() +
  geom_sf(data = TopoLevels, aes(fill = TopoTypeEn)) +
  geom_sf(data = multistems_plot) + # , aes(col= Genus)
  scale_fill_manual(values = c("Plateau" = "#009E73",
                               "Slope"= "#E7B800",
                               "Lower slope"= "#bfe6eb", 
                               "Bottomland" = "#1f78b4")) +
  theme_classic() +
  labs(fill= "Topography")

```

# Size distribution
```{r, eval = F}
data %>% 
  filter(Liana!=TRUE | is.na(Liana)) %>% filter(Strategy!="liane"| is.na(Strategy)) %>% 
  ggplot(aes(x=DBH)) +
  geom_histogram(breaks=seq(0,60, by=5), aes(fill= Strategy), color="#e9ecef", alpha=0.9) + # color to have the lines of the bars
  scale_x_continuous(limits = c(0, 60), breaks = seq(0,60, by=5)) +
  scale_y_continuous(breaks = seq(0,35000, by=5000)) +
  theme_minimal() +
  labs(title= paste("ALT", unique(data$Site), unique(data$Plot),"- Size distribution"), x ="DBH (cm)", y = "Individuals number")
# ggsave(paste("ALT", unique(data$Site), unique(data$Plot),"- Size_distribution.png"), path = "D:/Mes Donnees/PhD/Figures/inventory", width = 20, height = 10, units = "cm", dpi=800, bg="white")
```

## divide by hectares (à faire)
```{r, eval = F}
data %>% 
  filter(Liana!=TRUE | is.na(Liana)) %>% filter(Strategy!="liane"| is.na(Strategy)) %>% 
  ggplot(aes(x=DBH)) +
  geom_histogram(breaks=seq(0,60, by=5), aes(fill= Strategy), color="#e9ecef", alpha=0.9) + # color to have the lines of the bars
  scale_x_continuous(limits = c(0, 60), breaks = seq(0,60, by=5)) +
  scale_y_continuous(breaks = seq(0,35000, by=5000)) +
  theme_minimal() +
  labs(title= paste("ALT", unique(data$Site), unique(data$Plot),"- Size distribution"), x ="DBH (cm)", y = "Individuals number")
# ggsave(paste("ALT", unique(data$Site), unique(data$Plot),"- Size_distribution.png"), path = "D:/Mes Donnees/PhD/Figures/inventory", width = 20, height = 10, units = "cm", dpi=800, bg="white")
```


```{r, eval = F}
nrow(data[data$DBH<10,])/nrow(data) # 0.88 : les moins de 10 cm
nrow(data[data$Strategy=="Understory species",])/nrow(data) # 0.35 : espèces de sous-bois
nrow(data[data$DBH<10 & data$Strategy=="Canopy species",])/nrow(data) # 0.78 : juvéniles de canopée
```

# Species abundances
y: n species
x: n individuals
```{r, eval = F}
data %>%
  filter(!is.na(ScientificName)) %>% 
  filter(ScientificName!="Tres haut") %>% 
  filter(!grepl("indet", ScientificName)) %>% 
  filter(!grepl("Indet", ScientificName)) %>% 
  filter(!grepl("aceae", ScientificName)) %>% 
  group_by(ScientificName) %>%
  summarise(N = n()) %>%
  ungroup() %>% 
  filter(N<200) %>% 
  ggplot(aes(x= N)) + # fill = as.factor(Strategy)
  geom_histogram(breaks= seq(0,200, by=10), fill="#69b3a2", color="#e9ecef",alpha=0.9) +
  geom_vline(xintercept = 30) +
  scale_x_continuous(limits = c(0, 200), breaks =  seq(0,200, by=10)) +
  scale_y_continuous(breaks = seq(0,500, by=25)) +
  labs(x ="Individuals number", y = "Species number")


# ggsave(paste("ALT", unique(data$Site), unique(data$Plot),"Species_abundances.png", sep="_"),
#        path = "D:/Mes Donnees/PhD/Figures/inventory", width = 50, height = 10, units = "cm", dpi=800, bg="white")
```

```{r, eval = F}
# length(unique(test$ScientificName))

data %>%
  filter(!is.na(ScientificName)) %>% 
  filter(ScientificName!="Tres haut") %>% 
  filter(!grepl("indet", ScientificName)) %>% 
  filter(!grepl("Indet", ScientificName)) %>% 
  filter(!grepl("aceae", ScientificName)) %>% 
  group_by(ScientificName) %>%
  summarise(N = n()) %>%
  ungroup() %>% 
  ggplot(aes(x= N)) +
  stat_ecdf(aes(y = (1 - after_stat(y))), geom = "point") +
  stat_ecdf(aes(y = (1 - after_stat(y))), geom = "step") +
  scale_y_continuous("Density", position = "right",
                     sec.axis = sec_axis(name = "Decumulative species number", trans = ~.x*732, breaks = seq(1,732, by=25))) +
  
  geom_vline(xintercept = 30, col="red") +
  scale_x_continuous(limits = c(1, 200), breaks =  c(1, seq(10,200, by=10))) +
  labs(x ="Minimum individuals number")

# ggsave(paste("ALT", unique(data$Site), unique(data$Plot),"Decumulative_speciesnbr.png", sep="_"),
#        path = "D:/Mes Donnees/PhD/Figures/inventory", width = 25, height = 20, units = "cm", dpi=800, bg="white")
```

# Species rank abundance
```{r, eval = F}
data %>%
  filter(!is.na(ScientificName)) %>% 
  filter(ScientificName!="Tres haut") %>% 
  filter(!grepl("indet", ScientificName)) %>% 
  filter(!grepl("Indet", ScientificName)) %>% 
  filter(!grepl("aceae", ScientificName)) %>% 
  group_by(ScientificName) %>%
  summarise(N = n()) %>%
  ungroup() %>% 
  group_by(N) %>%
  summarise(n_sp = n()) %>%
  mutate(N = arrange(desc(N))) %>% 
  mutate(n_sp_cum = cumsum(n_sp)) %>% 
  
  ggplot(aes(x= N)) +
  geom_col(aes(y=n_sp_cum)) +
  geom_vline(xintercept = 30, col="red") +
  scale_x_continuous(limits = c(1, 200), breaks =  c(1, seq(10,220, by=10))) + #  2500
  scale_y_continuous(breaks = seq(0,732, by=25)) +
  labs(x ="Individuals number", y="Decumulative species number")

# ggsave(paste("ALT", unique(data$Site), unique(data$Plot),"Decumulative_speciesnbr_geomcol.png", sep="_"),
#        path = "D:/Mes Donnees/PhD/Figures/inventory", width = 30, height = 20, units = "cm", dpi=800, bg="white")
```


```{r, eval = F}
data %>%
  filter(!is.na(ScientificName)) %>% 
  filter(ScientificName!="Tres haut") %>% 
  filter(!grepl("indet", ScientificName)) %>% 
  filter(!grepl("Indet", ScientificName)) %>% 
  filter(!grepl("aceae", ScientificName)) %>% 
  group_by(ScientificName) %>%
  summarise(Anbundances = n()) %>%
  ungroup() %>% 
  mutate(Anbundances = sort(Anbundances, decreasing = T)) %>% 
  # filter(Anbundances >=30) %>% 
  mutate(rank = 1:n()) %>%  
  ggplot(aes(x= rank, y=Anbundances)) +
  geom_point(size=1) +
  geom_line() +
  geom_hline(yintercept = 30, col="red") +
  # scale_x_continuous(limits = c(1, 732), breaks =  c(seq(10,100, by=25), seq(200,732, by=100))) +
  scale_y_continuous(limits = c(1, 2500), breaks =  c(1, seq(100,2500, by=100))) + #  2500
  labs(x="Species rank")

# ggsave(paste("ALT", unique(data$Site), unique(data$Plot),"Species_abundances_rank.png", sep="_"),
#        path = "D:/Mes Donnees/PhD/Figures/inventory", width = 25, height = 20, units = "cm", dpi=800, bg="white")
```

# Filters for my analyses
DBH>=1
Only alive trees
Only the principal stem
Only measured trees
Only botanical identified
Take only sp >= 30 ind

# Remove duplicated rows
```{r}
# DuplicatedID <- unique(data[duplicated(data),]$StemID)
# 
# data[data$StemID%in%DuplicatedID,]
# 
# data <- data[!duplicated(data),]
# P: 42524 -> 42366 (158 rows removed)
# N: 29370 -> 29363 (7 rows removed)
```

```{r}
data <- Data %>% 
  rename(StemID = IdStem, TreeID = IdTree, DBH=Diameter, Xutm = XTreeUTM, Yutm = YTreeUTM) %>%
  
  filter(DBH>=1) %>%
  # Only alive trees
  filter(Dead == F) %>% # filter(CodeAlive == T) %>%
  # Only measured trees
  filter(!is.na(DBH))
  
```

# Manage multistems (sum the diameters, and keep only 1 stem) (Stem.nb pas codé)
```{r}
# pas codé si Stem.nb bien codé (1, 2, n)
unique(data$Comment) 
unique(data$Comments)

test <- data %>% 
  filter(grepl("Duplicated 'IdStem' in the census", Comment)) %>% # seulement les dupliqués
  group_by(TreeID) %>% 
  arrange(desc(DBH)) %>% 
  mutate(Stem.nb = 1:n()) %>% # numérote les stems par ordre décroissant de DBH
  mutate(DBHcor = sum(DBH)) %>% 
  arrange(desc(DBHcor)) %>% 
  fill(Xutm, Yutm, X, Y,
       Guyafor.nb,
       ScientificName, Genus, Species, Family,
       .direction = "downup") %>% 
  ungroup() %>% 
  mutate(DBHcor = ifelse(grepl("False pas double tige", Comments), DBH, DBHcor)) #%>% 
  # select(TreeID, Guyafor.nb, Stem.nb, DBH, DBHcor, ScientificName, Comment, Comments)
  
unique(test$Comment)
# Different botanical informations (Family, ScientificName) for a same IdTree"
# Missing value in XTreeUTM
# Missing value in Species
unique(test$Comments) # attention "False pas double tige" (traité)

# write.csv(test, "D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/Multistems_DBHcor.csv")

data <- data %>% 
  filter(!grepl("Duplicated 'IdStem' in the census", Comment)) %>% # supprimer les dupliqués
  bind_rows(test)

 # Only the principal stem
filter(Stem.nb == 1) %>%
# Only spatialised trees
filter(!is.na(Xutm) & !is.na(Yutm)) %>%
  # & DBH<10 only ALT data ?
# Only botanical identified
  filter(!is.na(ScientificName)) %>%
  filter(ScientificName!="Tres haut") %>%
  filter(!grepl("indet", ScientificName)) %>%
  filter(!grepl("Indet", ScientificName)) %>%
  filter(!grepl("aceae", ScientificName)) %>%
  filter(!(grepl("_sp", ScientificName) & grepl("\\.", ScientificName))) %>%
  filter(!(grepl("_aff", ScientificName) & grepl("\\.", ScientificName))) %>%
  filter(!grepl("_cf_", ScientificName)) %>%
  mutate(ScientificName_c = sub("\\..*", "", ScientificName)) %>% 
  mutate(SubSpecies = str_extract(ScientificName,"(?<=\\.).*")) %>% 
  rename(ScientificName_old = ScientificName,
         ScientificName = ScientificName_c) %>% 
  
  # attention Rinorea_idem181298 (138 individus)
  
  # Count individuals by species
  group_by(ScientificName) %>% 
  mutate(N = n()) %>% 
  ungroup() %>% 
  # Take only sp >= 30 ind
  filter(N >= 30)

```

# Write cleaned data
```{r}
nrow(data) # 33337
length(unique(data$ScientificName)) # 197

# write.csv(data, "D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/ALT_Paracou_9ha_CLEAN.csv")
```

# Mis de coté pour l'instant (gestion noms scientifiques)
```{r, eval = F}
Understory <- Understory %>% 
  mutate(ScientificName = str_squish(ScientificName)) %>% # remove double spaces
  mutate(ScientificName = ifelse(ScientificName=="Astrocaryum sciophylum", "Astrocaryum sciophilum", ScientificName)) %>% 
  mutate(ScientificName = ifelse(ScientificName=="Micropholis guyanensis subsp.Duckeana", "Micropholis guyanensis_subsp.duckeana", ScientificName))

Adults <- Adults %>% 
  # add a column identifying the two datasets
  add_column(Dataset = "Standard") %>%
  # idTree as character
  mutate(idTree = as.character(idTree)) %>% 
  # Circ to DBH
  mutate(DBH = CircCorr/pi) %>% 
  select(Dataset, idTree, Family, Genus, Species, DBH, MeasCode, CodeAlive, Xutm, Yutm)


# Join the 2 datasets
Total_inv <- bind_rows(Understory, Adults) %>% 
  # Only alive trees
  filter(CodeAlive == T) %>%
  # Create the ScientificName column
  unite(col = "ScientificName", c("Genus", "Species"),
        sep = "_", na.rm = TRUE, remove = F) %>%
  mutate(ScientificName = ifelse(ScientificName=="", NA, ScientificName)) %>% 
  mutate(ScientificName = str_squish(ScientificName)) %>% # remove double spaces
  mutate(ScientificName = ifelse(ScientificName=="Astrocaryum sciophylum", "Astrocaryum sciophilum", ScientificName)) %>% 
  mutate(ScientificName = ifelse(ScientificName=="Micropholis guyanensis subsp.Duckeana", "Micropholis guyanensis_subsp.duckeana", ScientificName))

# unique individuals
length(Total_inv$idTree) # 45997
unique(length(Total_inv$idTree)) # 45997

# Conceveiba  guianensis
# unique(Total_inv$ScientificName)

```

# Obsolete
```{r, eval = F}
# Understory <- Understory %>% 
#   select(-"...1" ) %>% 
#   unique() %>% 
#   
#   # Standardise columns names
#   rename(idTree = TreeID) %>% 
#   rename(Species = species) %>% 
#   rename(SubPlot = subplot) %>%
#   rename(CIRAD1 = CIRAD.BigTreeID) %>%
#   mutate(CodeAlive = as.logical(recode(Dead,
#                                        "FALSE" = "TRUE",
#                                        "FAUX" = "TRUE",
#                                        "(false)" = "TRUE",
#                                        "TRUE" = "FALSE",
#                                        "VRAI" = "FALSE"))) %>% 
#   # remove parentheses
#   mutate(Genus = gsub("[()]", "", Genus)) %>% 
#   mutate(Family = gsub("[()]", "", Family)) %>% 
#   
#   # add a column identifying the two datasets
#   add_column(Dataset = "ALT") %>% 
#   
#   # Create the ScientificName column
#   unite(col = "ScientificName", c("Genus", "Species"),
#         sep = " ", na.rm = TRUE, remove = F) %>%
#   mutate(ScientificName = ifelse(ScientificName=="", NA, ScientificName)) %>% 
#   mutate(ScientificName = str_squish(ScientificName)) %>% # remove double spaces
#   mutate(ScientificName = ifelse(ScientificName=="Astrocaryum sciophylum", "Astrocaryum sciophilum", ScientificName)) %>% 
#   mutate(ScientificName = ifelse(ScientificName=="Micropholis guyanensis subsp.Duckeana", "Micropholis guyanensis_subsp.duckeana", ScientificName)) %>% 
#   
#   # Only the needed columns
#   select(Dataset, SubPlot, Stem.number, idTree, CIRAD1, ScientificName, Family, Genus, Species, DBH, POM, CodeAlive, Xutm, Yutm)
```

!! ATTENTION !! il y a des dupliqués : différents DBH pour le meme idTree et la meme stem
```{r, eval = F}
# unique(Understory$Dead)
# 
# Understory <- Understory %>% 
#   select(-"...1" ) %>% 
#   unique() %>%
#   filter(DBH>=1) %>% 
#   rename(idTree = TreeID) %>% 
#   rename(Species = species) %>% 
#   rename(SubPlot = subplot) %>% 
#   # rename(CodeAlive = Dead) %>% 
#   mutate(CodeAlive = as.logical(recode(Dead,
#                                        "FALSE" = "TRUE",
#                                        "FAUX" = "TRUE",
#                                        "(false)" = "TRUE",
#                                        "TRUE" = "FALSE",
#                                        "VRAI" = "FALSE"))) %>% 
#   # remove parentheses
#   mutate(Genus = gsub("[()]", "", Genus)) %>% 
#   mutate(Family = gsub("[()]", "", Family))

# test <- select(Understory, Dead, CodeAlive)
```
