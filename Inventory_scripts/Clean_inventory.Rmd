---
title: "Clean inventories"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: pdf_document
---
Début de l’inventaire :  novembre 2020
Fin de l'inventaire : décembre 2023

Paracou - P16:
4 ha : 19,20,14,15 
9 ha : 13,14,15,18,19,20,23,24,25

Pour les  4 1ers ha les arbres CIRAD n'ont pas été mesurés par l'équipe ALT, ce sont les DBH du dataset CIRAD 2020.

Pour les autres subplots, les DBH des arbres CIRAD ont été mesuré par l'équipe ALT.

Nouragues - Petit Plateau:
202,203,204,212,213,214

# Packages
```{r Setup, include = F}
library(tidyverse)
library(data.table)
library(readr)
# library() # TreeData

# remotes::install_github("EcoFoG/EcoFoG", build_vignettes = F)
library(EcoFoG)
```

# Import inventory data
Paracou Plot 16
Nouragues Petit Plateau
```{r}
# Adults <- Guyafor2df(UID = "Vincyane.Badouard", PWD = "Vincyane973+", Driver = "SQL Server",WHERE="Forest='Paracou' AND Plot='16'") #  AND CensusYear=2020
# write.csv(Adults, "D:/Mes Donnees/PhD/Inventories/Data/Adults/Paracou16_2020.csv")
# rm(Adults)
# Adults <- Guyafor2df(UID = "Vincyane.Badouard", PWD = "Vincyane973+", Driver = "SQL Server",WHERE="Forest='Nouragues'AND Plot='Petit_Plateau' AND CensusYear=2022")
# write.csv(Adults, "D:/Mes Donnees/PhD/Inventories/Data/Adults/NouraguesPetitPlateau_2022.csv")
# rm(Adults)
```


```{r,include = F, message=F}
UnderstoryP <- read_csv("~/PhD/Inventories/Data/Understory/Paracou/ALT_Paracou9ha_20240906F.csv")
UnderstoryN <- read_csv("~/PhD/Inventories/Data/Understory/Nouragues/Nouragues_ALT_20240910.csv")

AdultsP <- read_csv("~/PhD/Inventories/Data/Adults/Paracou16_2020.csv") %>% 
  filter(SubPlot %in% c(13,14,15,18,19,20,23,24,25)) # 9 ha
AdultsN <- read_csv("~/PhD/Inventories/Data/Adults/NouraguesPetitPlateau_2022.csv") %>% 
  filter(SubPlot %in% c(202,203,204,212,213,214)) # 6 ha
```

# Manage names
```{r}
# to detect differences in column names between datasets
names(UnderstoryN)[!names(UnderstoryN) %in% names(UnderstoryP)]
names(UnderstoryP)[!names(UnderstoryP) %in% names(UnderstoryN)]

names(UnderstoryN) <- str_to_sentence(names(UnderstoryN)) # start by uppercase
UnderstoryN <- UnderstoryN %>% 
  rename_at(c("Pom", "Dbh"), # uppercase
            .funs = toupper) %>% 
  rename(TreeID = Treeid, StemID = Stemid,
         CensusYear = Censusyear, CensusDate = Censusdate,
         BotaCertainty = Botacertainty, ScientificName = Scientificname, Dead = Mort, Subplot=Plot) %>% 
  mutate(Site = "Nouragues") %>% 
  mutate(Plot = "Petit_Plateau") %>% 
  mutate(ProjectArea = 6)

UnderstoryP <- UnderstoryP %>% 
  mutate(Plot = "16") %>% 
  mutate(ProjectArea = 9)

```

# Strategy data (canopy vs understory species)
```{r}
strategy <- read_delim("~/PhD/Inventories/EFT2023_Understory/dcl.csv", 
                       delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  select(genre_esp, Strategy) %>%
  rename(ScientificName = genre_esp) %>%
  mutate(Strategy = ifelse(Strategy== "#N/A", NA, Strategy)) %>%
  mutate(Strategy = recode(Strategy, "TallSp" = "Canopy species" , "UnderstorySp" = "Understory species")) %>% 
  unique()

Understory <- list(UnderstoryP, UnderstoryN)
Understory <- lapply(Understory, function(x) left_join(x, strategy, by="ScientificName"))
```


# Plot size distribution
```{r}
for(d in c(1, 2)){
  print(
    Understory[[d]] %>% 
      filter(Liana!=TRUE | is.na(Liana)) %>% filter(Strategy!="liane"| is.na(Strategy)) %>% 
      ggplot(aes(x=DBH)) +
      geom_histogram(breaks=seq(0,60, by=5), aes(fill= Strategy), color="#e9ecef", alpha=0.9) + # color to have the lines of the bars
      scale_x_continuous(limits = c(0, 60), breaks = seq(0,60, by=5)) +
      scale_y_continuous(breaks = seq(0,35000, by=5000)/unique(Understory[[d]]$ProjectArea)) +
      theme_minimal() +
      labs(title= paste("ALT", unique(Understory[[d]]$Site), unique(Understory[[d]]$Plot),"- Size distribution"), x ="DBH (cm)", y = "Individuals number")
  )
  # ggsave(paste("ALT", unique(Understory[[d]]$Site), unique(Understory[[d]]$Plot),"- Size_distribution.png"), path = "D:/Mes Donnees/PhD/Figures/inventory", width = 20, height = 10, units = "cm", dpi=800, bg="white")
}
```

# divide by hectares (à faire)
```{r}
for(d in c(1, 2)){
  print(
    Understory[[d]] %>% 
      filter(Liana!=TRUE | is.na(Liana)) %>% filter(Strategy!="liane"| is.na(Strategy)) %>% 
      ggplot(aes(x=DBH)) +
      geom_bar(breaks=seq(0,60, by=5), aes(fill= Strategy), color="#e9ecef", alpha=0.9) + # color to have the lines of the bars
      scale_x_continuous(limits = c(0, 60), breaks = seq(0,60, by=5)) +
      scale_y_continuous(breaks = seq(0,35000, by=5000)/unique(Understory[[d]]$ProjectArea)) +
      theme_minimal() +
      labs(title= paste("ALT", unique(Understory[[d]]$Site), unique(Understory[[d]]$Plot),"- Size distribution"), x ="DBH (cm)", y = "Individuals number")
  )
  # ggsave(paste("ALT", unique(Understory[[d]]$Site), unique(Understory[[d]]$Plot),"- Size_distribution.png"), path = "D:/Mes Donnees/PhD/Figures/inventory", width = 20, height = 10, units = "cm", dpi=800, bg="white")
}
```

```{r}
nrow(Understory[Understory$DBH<10,])/nrow(Understory) # 0.88 : les moins de 10 cm
nrow(Understory[Understory$Strategy=="Understory species",])/nrow(Understory) # 0.35 : espèces de sous-bois
nrow(Understory[Understory$DBH<10 & Understory$Strategy=="Canopy species",])/nrow(Understory) # 0.78 : juvéniles de canopée
```

Vérifications :
- the 9 subplots
- idTree uniques A FAIRE
- DBH au même POM (1.30) ? que faire pour les ALT ? A FAIRE
- DBH >= 1 < ? A FAIRE
- noms d'espèces uniques A FAIRE
- arbres cirad tous présents A TRAITER (attention arbres sans stem 1)
- joindre les infos manquantes des cirad (DBH, bota, coordonnées)


Ne prendre que :
- les mesurés
- les identifiés botaniquement
- la tige principale (?)
- les vivants
- les mesures les plus récentes des arbres cirad A FAIRE
- Take only sp >= 30 ind (?)

```{r}
# check that we have the 9 subplots
sort(unique(Understory$subplot)) == c(13,14,15,18,19,20,23,24,25)
names(Understory)

Understory <- Understory %>% 
  select(-"...1" ) %>% 
  unique() %>% 
  
  # Standardise columns names
  rename(idTree = TreeID) %>% 
  rename(Species = species) %>% 
  rename(SubPlot = subplot) %>%
  rename(CIRAD1 = CIRAD.BigTreeID) %>%
  mutate(CodeAlive = as.logical(recode(Dead,
                                       "FALSE" = "TRUE",
                                       "FAUX" = "TRUE",
                                       "(false)" = "TRUE",
                                       "TRUE" = "FALSE",
                                       "VRAI" = "FALSE"))) %>% 
  # remove parentheses
  mutate(Genus = gsub("[()]", "", Genus)) %>% 
  mutate(Family = gsub("[()]", "", Family)) %>% 
  
  # add a column identifying the two datasets
  add_column(Dataset = "ALT") %>% 
  
  # Create the ScientificName column
  unite(col = "ScientificName", c("Genus", "Species"),
        sep = " ", na.rm = TRUE, remove = F) %>%
  mutate(ScientificName = ifelse(ScientificName=="", NA, ScientificName)) %>% 
  mutate(ScientificName = str_squish(ScientificName)) %>% # remove double spaces
  mutate(ScientificName = ifelse(ScientificName=="Astrocaryum sciophylum", "Astrocaryum sciophilum", ScientificName)) %>% 
  mutate(ScientificName = ifelse(ScientificName=="Micropholis guyanensis subsp.Duckeana", "Micropholis guyanensis_subsp.duckeana", ScientificName)) %>% 
  
  # Only the needed columns
  select(Dataset, SubPlot, Stem.number, idTree, CIRAD1, ScientificName, Family, Genus, Species, DBH, POM, CodeAlive, Xutm, Yutm)
```

```{r}
# Check duplicated idTree
Understory[duplicated(Understory$idTree),] # oui il y a des idTree dupliqués

# Check the scientific names list
unique(Understory$ScientificName)
```

# Check if the cirad trees are all in the understory inventories
```{r}
Understory <- Understory %>% 
  mutate(CIRADid= tstrsplit(CIRAD1, split = "_")[[1]]) %>% #1er elmt  
  mutate(CIRADplot= tstrsplit(CIRAD1, split = "_")[[2]]) #2nd

all(na.omit(Understory$CIRADplot == Understory$SubPlot)) # il ya des erreurs dans les n° de subplots des identifiants cirad

Adults <- Adults %>% 
  filter(CodeAlive == T) %>%
  unite(col = "CIRAD", c("TreeFieldNum", "SubPlot"),
        sep = "_", na.rm = F, remove = F) %>% 
  mutate(CIRAD = gsub("[[:space:]]", "", CIRAD)) %>%
  mutate(CIRAD = str_squish(CIRAD)) # remove double spaces

Understory <- Understory %>% 
  unite(col = "CIRAD", c("CIRADid", "SubPlot"),
        sep = "_", na.rm = F, remove = F) %>% 
  mutate(CIRAD = gsub("[[:space:]]", "", CIRAD)) %>% 
  mutate(CIRAD = str_squish(CIRAD)) # remove double spaces

Adults$CIRAD %in% Understory$CIRAD | Adults$CIRAD %in% Understory$CIRAD1 # CIRAD1 has some different suplot numer than SubPlot

MissingCirad <- Adults %>% 
  filter(!(CIRAD %in% Understory$CIRAD|CIRAD %in% Understory$CIRAD1))

unique(MissingCirad$CIRAD)

Understory[!is.na(Understory$CIRAD1),]$Stem.number # cirad stem id
stems <- Understory[!is.na(Understory$CIRAD1) & Understory$Stem.number!=1,]$CIRAD1 # cirad stem id >1
stem1 <- Understory[Understory$CIRAD1 %in% stems & Understory$Stem.number==1,]$CIRAD1 # cirad stem id == 1

#!! ATTENTION cirad trees without stem 1 !!
stems[!stems %in% stem1] # "392_14" "340_19" "106_15" "356_20" "131_14" cirad with multiple stems but without a stem 1
```



# For my analyses
```{r}
Understory <- Understory %>% 
  filter(DBH>=1) %>% 
  # Only alive trees
  filter(CodeAlive == T) %>%
  # Only the principal stem
  filter(Stem.number == 1) %>% 
  
  # Only measured trees
  filter(!is.na(DBH)) %>%
  
  # Only botanical identified
  filter(!is.na(ScientificName)) %>% 
  filter(ScientificName!="Tres haut") %>% 
  filter(!grepl("indet", ScientificName)) %>% 
  filter(!grepl("Indet", ScientificName)) %>% 
  
  # Count individuals by species
  group_by(ScientificName) %>% 
  mutate(N = n()) %>% 
  ungroup() %>% 
  # Take only sp >= 30 ind
  filter(N >= 30)


```

# Check if the cirad trees are all in the understory inventories
```{r}
Understory <- Understory %>% 
  mutate(CIRADid= tstrsplit(CIRAD1, split = "_")[[1]]) %>% #1er elmt  
  mutate(CIRADplot= tstrsplit(CIRAD1, split = "_")[[2]]) #2nd

all(na.omit(Understory$CIRADplot == Understory$SubPlot)) # il ya des erreurs dans les n° de subplots des identifiants cirad

Adults <- Adults %>% 
  unite(col = "CIRAD", c("TreeFieldNum", "SubPlot"),
        sep = "_", na.rm = F, remove = F)

Understory <- Understory %>% 
  unite(col = "CIRAD", c("CIRADid", "SubPlot"),
        sep = "_", na.rm = F, remove = F)

Adults$CIRAD %in% Understory$CIRAD | Adults$CIRAD %in% Understory$CIRAD1 # CIRAD1 has some different suplot numer than SubPlot

MissingCirad <- Adults %>% 
  filter(!(CIRAD %in% Understory$CIRAD|CIRAD %in% Understory$CIRAD1))
```

