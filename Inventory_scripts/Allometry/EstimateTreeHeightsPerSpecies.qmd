---
title: "Estimate TreeHeights Per Species"
date: "`r Sys.Date()`"
format: html
self-contained: true
theme: cosmo
editor: source
  markdown: 
    wrap: 72
code-fold: true
execute: 
  cache: true
---

Objective:

-   utiliser l’allométrie complète de Claudia avec posteriors par espèce plutôt que ces données tant que le paramètre existe pour l’espèce et avec allométrie générale de Claudia si on n’a pas l’espèce
-   https://github.com/chuertas18/local_allometries_LIDAR/blob/main/model_1_4_PW_MM.r (MM4 - Model 4 Michaelis-Menten)
-   pour les petits comparer modèle spécifique ou général
-   prédire avec fct de brms (predict)
-   https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/

```{r, packages, include=F}
library(terra)
library(sf)
library(tidyverse)
library(tidybayes)
```


# Claudia fit - Michaelis-Menten LCH and species identity (MM4)
**//amap-data.cirad.fr/work/users/VincyaneBadouard/modèlesAlloClaudia**
```{r}
load("//amap-data.cirad.fr/work/users/VincyaneBadouard/modèlesAlloClaudia/model4_MM_dataCCmean.Rdata")
fit <- fit2_MM4_5s_2023
rm(fit2_MM4_5s_2023)
fit
get_variables(fit)
str(fit, maxlevels = 1)
summary(fit)
str(fit$fit) # stanfit
options(max.print=1000000)
fit$fit
str(rstan::extract(fit$fit)) # matrix sp en col # $r_1_alpha_1
str(fit$data$species_noSing) # character
levels(as.factor(fit$data$species_noSing)) # à mettre en colonne et mettre dans la matrice
# et verifier en fesant la moyenne avec la moyenne du fit$fit


```
Data : data_cc_cirad
*data_cc_cirad = trees.final.PL + bd_paracou_HC*

bd_paracou_HC = Dataset2.csv  Data from CIRAD plots (Dataset2), available for consultation with permission:
Derroire, G., Hérault, B., Rossi, V., Blanc, L., Gourlet- Fleury, S., & Schmitt, L. (2023). Paracou permanent plots. CIRAD Dataverse. https://doi.org/10.18167/DVN1/8G8AHY

trees.final.PL = "/Data/P1to16_00006_0010/P1to16.MM",pattern = "final.txt"

*dbh.y>=20*

Variables : 
- dbh.y
- "CHM2015_25ppm_fo_comp" -> 'HC'
- species_noSing (470)
- "idtree","dbh", "wd",  "HC","species_allo", "plot","habitat","trait","square_125"

# Create a developpment dataset
*pour vérifier que c'est tout bon, tu peux peut-être te faire un jeu de données de vérif avec 1 indiv par espèce, tous avec un même DBH => pour les espèces de Claudia, tu peux vérifier si le ranking et cohérent avec tes param. Et pour les autres espèces, elles devraient avoir toutes sensiblement la même hauteur*

```{r, dvp dataset, eval=F}
match <- read.csv("D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/Species_correspondence_Claudia.csv")  # 398

same_sp <- match %>% 
  mutate(dbh.y = 30) %>% 
  mutate(HC = 30)

other_sp <- data.frame(species_noSing = c("A", "B", "C", "D"),
                       dbh.y = 30,
                       HC = 30)
```

# Cleaned inventory data
```{r, message=F}
Understory <- read.csv("~/PhD/Inventories/Data/Understory/Paracou/ALT_Paracou_9ha_CLEAN.csv") %>% 
  rename(idTree = IdTree) %>% # 28 711
  rename(SubPlot = Subplot)
Adults <- read.csv("~/PhD/Inventories/Data/Adults/Paracou/AdultsP16_filtred.csv") %>%  # 25 ha
  mutate(idTree = as.character(idTree))

Inventory <- bind_rows(Understory, Adults)
```

# Modify inventory for predictions
```{r}
match <- read.csv("D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/Species_correspondence_Claudia.csv")  # 398

sum(duplicated(match$species_noSing)) # 19

Inventory <- Inventory %>% 
  left_join(match, by= "ScientificName")

length(!is.na(unique(Inventory$species_noSing))) # 380 (=398-19-NA)

all(sort(unique(Inventory$species_noSing)) == sort(unique(match$species_noSing))) # TRUE
match$species_noSing[!match$species_noSing %in% unique(Inventory$species_noSing)] # 0
```

# Predictions
## Hauteur médiane de canopée avoisinante (LCH)
Local canopy height (LCH) was defined as the **median** canopy height in a circular *30m* (= twice the radius of the largest crowns in the dataset) buffer (selected based on the smallest AIC value of the allometry)
Pixels from the target tree itself were excluded from the local canopy height calculations to avoid a circular relationship with predicted height.  
En mode prédiction on ne masque pas l'arbre cible (car on n'a pas en général de détourage de sa couronne : le cas échéant on aurait alors directement accès sa hauteur).  
On utilise la hauteur dans un voisinage qui comprend l'arbre cible. L'idée est de capter la hauteur locale de la canopée sur une surface bien plus grande que la surface projetée de la couronne (~3000m2).  
```{r}
# P16 25ha CHM 1m res (SpatRaster) A CREER
CHM <- rast("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Paracou_P16_2023_25ha_50mbuffer_HighAlt_CHM_1mres.tif")

#  focal ("moving window") weight matrix   
disk_weights <- terra::focalMat(terra::rast(matrix(0, nrow=31, ncol=31)), 15, type = "circle") # 30m radius of the circle

disk_weights[disk_weights[]>0] <- 1

# Calculate focal ("moving window") values for each cell
CHMPP_median30cir <- focal(CHM, w=disk_weights, fun="median", na.policy="all",
                           fillvalue=NA, expand=FALSE, silent=TRUE)
# values in the focal window will be multiplied by the corresponding weight prior to 'fun' being applied.

plot(CHM) ; plot(CHMPP_median30cir)
```

```{r}
Inventory <- Inventory %>% 
  filter(!is.na(Xutm) & !is.na(Yutm)) %>% 
  st_as_sf(coords = c("Xutm", "Yutm")) %>% 
  st_set_crs(st_crs(CHM))

LCH <- raster::extract(CHMPP_median30cir, Inventory) %>% 
  rename(HC = focal_median) %>% dplyr::select(-ID)

Inventory <- Inventory %>% 
  cbind(LCH)
```

```{r}
ggplot(Inventory, aes(x=DBHcor, y=HC)) +
  geom_point() +
  labs(x= "DBH (cm)", y= "Local canopy height (m)")
```

```{r, eval=F}
# Sylvain - extraire les paramètres
fit %>% 
  tidybayes::spread_draws(b_hmax_Intercept, r_species__hmax[species,], # or manipulating posteriors directly; support a wider range of models
                          b_ah_Intercept, r_species__ah[species,]) %>% 
  mutate(ah = b_ah_Intercept + r_species__ah) %>% 
  mutate(hmax = b_hmax_Intercept + r_species__hmax) %>% 
  group_by(species) %>% 
  summarise(ah = median(ah), hmax = median(hmax)) %>% 
  filter(species != "unknown") %>% 
  mutate(species = gsub(".", " ", species, fixed = TRUE)) %>% 
  left_join(read_csv("data/species/tallo.csv") %>% 
              filter(longitude <= -39, longitude >= -79, latitude >= -18, latitude <= 10) %>% 
              select(family, genus, species) %>% unique()) %>% 
  write_tsv("outputs/tallo_pars.tsv")
```

prédire avec quelle incertitude paramètres et/ou distribution ? incertitude paramètres seulement
max de vraissemblance ou mediane ? mediane de toutes les itérations 

# Predict tree height for  Claudia's species
```{r}
?add_predicted_draws
truc <- brms::bf(height~(alpha*dbh.y)/(beta+dbh.y),
                 alpha ~ HC + 1|species_noSing,
                 beta ~ 1|species_noSing, # que cette ligne donne des valeurs négatives
                 nl = TRUE) # donne la meme valeur pour ttes les espèces

same_sp_pred <- same_sp %>%
  add_epred_draws(fit, re_formula = ~ (HC + 1|species_noSing), 
                  allow_new_levels = F, 
                  value = "pred") %>% # 398 sp * 6000 iterations
  group_by(species_noSing) %>% 
  mutate(TreeHeight = round(median(pred), 1)) %>% # compute median of the iterations
  ungroup() %>% 
  select(-c(".row", ".chain", ".iteration", ".draw", "pred")) %>% 
  unique()

# add_predicted_draws propage l'incertitude
# add_epred_draws gives you the posterior expectation (the predicted average value, excluding residual variance)
```

```{r, eval=F}
# Abarema jupunba 24.6

# MEAN
dbh.y = 30
HC = 30
alpha_intercept = 42.79
beta_intercept = 14.57
# alpha_HC = -0.98

alpha_intercept_sp = -8.35
alpha_HC_sp = 0.07
beta_sp = -0.30
alpha = (alpha_HC_sp)*HC + alpha_intercept + alpha_intercept_sp
beta = beta_intercept + beta_sp

(alpha * dbh.y)/(beta + dbh.y) # mean 22.7

# MEDIAN
dbh.y = 30
HC = 30
alpha_intercept = 42.78
beta_intercept = 14.57
alpha_HC = -0.98

alpha_intercept_sp = -8.41
alpha_HC_sp = 0.07
beta_sp = -0.34
alpha = (alpha_HC + alpha_HC_sp)*HC + alpha_intercept + alpha_intercept_sp
beta = beta_intercept + beta_sp

(alpha * dbh.y)/(beta + dbh.y) # median 22.7

# Agonandra silvatica 27.2

# MEAN
dbh.y = 30
HC = 30
alpha_intercept = 42.79
beta_intercept = 14.57
# alpha_HC = -0.98 # cor_species_noSing__alpha_Intercept__alpha_HC

alpha_intercept_sp = -7.54
alpha_HC_sp = 0.21
beta_sp = 2.24
alpha = (alpha_HC_sp)*HC + alpha_intercept + alpha_intercept_sp
beta = beta_intercept + beta_sp

(alpha * dbh.y)/(beta + dbh.y) # mean 22.1
```

# Predict tree height for species absent of the Claudia's selection (works)
si tu prends pas en compte l'effet de l'espèce, tu ne garde que l'effet moyen entre espèce (le mu de ta distribution des effets aléatoires des espèces). Donc tu considères toutes les espèces comme des espèces "moyennes"
```{r}
other_sp_pred <- other_sp %>%
  add_epred_draws(fit, re_formula = NA,
                  allow_new_levels = T,
                  value = "pred") %>%  # n sp * 6000 iterations
  group_by(species_noSing) %>% 
  mutate(TreeHeight = round(median(pred), 1)) %>% # compute median of the iterations
  ungroup() %>% 
  select(-c(".row", ".chain", ".iteration", ".draw", "pred")) %>% 
  unique()

```

