---
title: "Estimate TreeHeights Per Species"
date: "`r Sys.Date()`"
format: html
self-contained: true
theme: cosmo
editor: source
  markdown: 
    wrap: 72
code-fold: true
execute: 
  cache: true
---

Objective:

-   utiliser l’allométrie complète de Claudia avec posteriors par espèce plutôt que ces données tant que le paramètre existe pour l’espèce et avec allométrie générale de Claudia si on n’a pas l’espèce
-   MM4 - Model 4 Michaelis-Menten
- \\amap-data.cirad.fr\work\users\ClaudiaHuertas\AllometryData\Scripts\Allometry_main\Scripts_paper\Figures Results_Allometry_paper
-   pour les petits comparer modèle spécifique ou général
-   prédire avec fct de brms (predict)
-   https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/

```{r, packages, include=F}
library(terra)
library(sf)
library(tidyverse)
library(tidybayes)
```


# Claudia fit - Michaelis-Menten LCH and species identity (MM4)
**//amap-data.cirad.fr/work/users/VincyaneBadouard/modèlesAlloClaudia**
```{r}
load("//amap-data.cirad.fr/work/users/VincyaneBadouard/modèlesAlloClaudia/model4_MM_dataCCmean.Rdata")
fit <- fit2_MM4_5s_2023
rm(fit2_MM4_5s_2023)
fit
# get_variables(fit)
# str(fit, maxlevels = 1)
# summary(fit)
# str(fit$fit) # stanfit
# options(max.print=1000000)
# fit$fit
# str(rstan::extract(fit$fit)) # matrix sp en col # $r_1_alpha_1
# str(fit$data$species_noSing) # character
# levels(as.factor(fit$data$species_noSing)) # à mettre en colonne et mettre dans la matrice
# et verifier en fesant la moyenne avec la moyenne du fit$fit
```

Data : data_cc_cirad
*data_cc_cirad = trees.final.PL + bd_paracou_HC*

bd_paracou_HC = Dataset2.csv  Data from CIRAD plots (Dataset2), available for consultation with permission:
Derroire, G., Hérault, B., Rossi, V., Blanc, L., Gourlet- Fleury, S., & Schmitt, L. (2023). Paracou permanent plots. CIRAD Dataverse. https://doi.org/10.18167/DVN1/8G8AHY

trees.final.PL = "/Data/P1to16_00006_0010/P1to16.MM",pattern = "final.txt"

*dbh.y>=20*

Variables : 
- dbh.y
- "CHM2015_25ppm_fo_comp" -> 'HC'
- species_noSing (470)
- "idtree","dbh", "wd",  "HC","species_allo", "plot","habitat","trait","square_125"

# Create a developpment dataset
*pour vérifier que c'est tout bon, tu peux peut-être te faire un jeu de données de vérif avec 1 indiv par espèce, tous avec un même DBH => pour les espèces de Claudia, tu peux vérifier si le ranking et cohérent avec tes param. Et pour les autres espèces, elles devraient avoir toutes sensiblement la même hauteur*

```{r, dvp dataset, eval=F}
match <- read.csv("D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/Species_correspondence_Claudia.csv")  # 398

same_sp <- match %>% 
  mutate(dbh.y = 30) %>% 
  mutate(HC = 30)

other_sp <- data.frame(species_noSing = c("A", "B", "C", "D"),
                       dbh.y = 30,
                       HC = 30)
```

# Cleaned inventory data
```{r, message=F}
Understory <- read.csv(
    # "~/PhD/Inventories/Data/Understory/Paracou/ALT_Paracou_9ha_CLEAN_corcord.csv" # at final
  "~/PhD/Inventories/Data/Understory/Paracou/ALT_Paracou_9ha_CLEAN.csv" # for the moment
  ) %>% 
  rename(idTree = IdTree) %>% # 28 711
  rename(SubPlot = Subplot)
Adults <- read.csv("~/PhD/Inventories/Data/Adults/Paracou/AdultsP16_filtred.csv") %>%  # 25 ha
  mutate(idTree = as.character(idTree))

Inventory <- bind_rows(Understory, Adults)

nrow(Inventory) == nrow(Understory) + nrow(Adults)
```

# Modify inventory for predictions
```{r}
match <- read.csv("D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/Species_correspondence_Claudia.csv")  # 399
# Generated with Modify_data_for_predictions.Rmd

sum(duplicated(match$species_noSing)) # 20

Inventory <- Inventory %>% 
  left_join(match, by= "ScientificName") %>% # add species_noSing
  rename(dbh.y = DBHcor)

length(!is.na(unique(Inventory$species_noSing))) # 380 (=399-20-NA)

all(sort(unique(Inventory$species_noSing)) == sort(unique(match$species_noSing))) # TRUE
match$species_noSing[!match$species_noSing %in% unique(Inventory$species_noSing)] # 0
```

# Predictions
## Hauteur médiane de canopée avoisinante (LCH)
Local canopy height (LCH) was defined as the **median** canopy height in a circular *30m* (= twice the radius of the largest crowns in the dataset) buffer (selected based on the smallest AIC value of the allometry)
Pixels from the target tree itself were excluded from the local canopy height calculations to avoid a circular relationship with predicted height.  
En mode prédiction on ne masque pas l'arbre cible (car on n'a pas en général de détourage de sa couronne : le cas échéant on aurait alors directement accès sa hauteur).  
On utilise la hauteur dans un voisinage qui comprend l'arbre cible. L'idée est de capter la hauteur locale de la canopée sur une surface bien plus grande que la surface projetée de la couronne (~3000m2).  
```{r}
# P16 25ha CHM 1m res (SpatRaster)
CHM <- rast("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Paracou_P16_2023_25ha_50mbuffer_HighAlt_CHM_1mres.tif")

#  focal ("moving window") weight matrix   
disk_weights <- terra::focalMat(terra::rast(matrix(0, nrow=61, ncol=61)), 30, type = "circle") # 30m radius of the circle
# with target tree
disk_weights[disk_weights[]>0] <- 1

# Calculate focal ("moving window") values for each cell
CHMPP_median30cir <- focal(CHM, w=disk_weights, fun="median", na.policy="all",
                           fillvalue=NA, expand=FALSE, silent=TRUE)
# values in the focal window will be multiplied by the corresponding weight prior to 'fun' being applied.

plot(CHM) ; plot(CHMPP_median30cir)
```

```{r}
Inventory_sf <- Inventory %>% 
  filter(!is.na(Xutm) & !is.na(Yutm)) %>% 
  st_as_sf(coords = c("Xutm", "Yutm")) %>% 
  st_set_crs(st_crs(CHM))

LCH <- raster::extract(CHMPP_median30cir, Inventory_sf) %>% 
  rename(HC = focal_median) %>% dplyr::select(-ID)

Inventory <- Inventory %>% 
  cbind(LCH)

```

```{r}
ggplot(Inventory, aes(x=dbh.y, y=HC)) +
  geom_point() +
  labs(x= "DBH (cm)", y= "Local canopy height (m)")
```

prédire avec quelle incertitude paramètres et/ou distribution ? incertitude paramètres seulement
max de vraissemblance ou mediane ? mediane de toutes les itérations 

# Predict tree height for Claudia's species
```{r}
same_sp <- Inventory %>% 
  filter(!is.na(species_noSing))

other_sp <- Inventory %>% 
  filter(is.na(species_noSing))

nrow(Inventory) == nrow(same_sp) + nrow(other_sp)
```

```{r}
same_sp_pred <- predict(fit, newdata = same_sp, robust=T, na.action = na.omit) # 1 min, robust=T to take the posterior median
same_sp$TreeHeight <- same_sp_pred[,1]
range(same_sp$TreeHeight) #  2.003142 49.087198
```
## Plot
```{r}
ggplot(same_sp, aes(x=dbh.y, y=TreeHeight, col = species_noSing)) + 
  geom_point()+
  labs(y = "H model 4 Michaelis Menten", x="DBH (cm)") +
  guides(color = F)
```

# Predict tree height for species absent of the Claudia's selection (works)
si tu prends pas en compte l'effet de l'espèce, tu ne garde que l'effet moyen entre espèce (le mu de ta distribution des effets aléatoires des espèces). Donc tu considères toutes les espèces comme des espèces "moyennes"
```{r}
other_sp_pred <- predict(fit, newdata = other_sp, re_formula = NA, robust=T, na.action = na.omit) # 1 min; , robust=T to take the posterior median
other_sp$TreeHeight <- other_sp_pred[,1]
range(other_sp$TreeHeight) # 2.646925 36.729651
```
## Plot
```{r}
ggplot(other_sp, aes(x=dbh.y, y=TreeHeight, col = ScientificName)) + 
  geom_point()+
  labs(y = "H model 4 Michaelis Menten", x="DBH (cm)") +
  guides(color = F)

ggplot(same_sp, aes(x=dbh.y, y=TreeHeight, col = ScientificName)) + 
  theme_minimal() +
  geom_point() +
  geom_point(data = other_sp, col= "black") +
  labs(y = "H model 4 Michaelis Menten", x="DBH (cm)") +
  guides(color = F)

```

# Compare small trees predictions with FTH data
```{r, eval=F}
# Giacomo FTH data
FTH <- read_delim("~/PhD/Inventories/Data/Height-Diameter/Understory/Allometry_FTH_GSellan_Paracou_idTree.csv") %>% # 931
  select(ScientificName, DBH, TreeHeight) %>% 
  mutate(dbh.y = as.numeric(gsub(",", ".", DBH)))

ggplot(same_sp, aes(x=dbh.y, y=TreeHeight)) + 
  # xlim(1,20) +
  theme_minimal() +
  geom_point(col= "grey", size=1, alpha=0.2) +
  geom_point(data = other_sp, col= "darkgrey",size=1, alpha=0.2) +
  geom_point(data = FTH, col= "darkgreen", size=1, alpha=0.2) +
  # scale_x_continuous(breaks =seq(0, 20, by= 5)) +
  labs(y = "H model 4 Michaelis Menten", x="DBH (cm)") +
  guides(color = F)
```

```{r, eval=F}
plist <- vector('list')

for(S in unique(FTH$ScientificName)[unique(FTH$ScientificName) %in% unique(same_sp$ScientificName)]){
  # S = "Licania_alba"
  plist[[S]] <- local({
    same_sp %>% 
      filter(ScientificName == S) %>% 
      ggplot(aes(x=dbh.y, y=TreeHeight)) + 
      # xlim(1,20) +
      theme_minimal() +
      geom_point(col= "grey") + # species effect
      geom_line(data = other_sp, col= "black", linewidth = 1) + # no species effect
      geom_point(data = filter(FTH, ScientificName == S), col= "red") + # FTH data
      scale_x_continuous(breaks =seq(0, 150, by= 5)) +
      labs(title = S, y = "H model 4 Michaelis Menten", x="DBH (cm)") +
      guides(color = F)
  })
}

plots <- gridExtra::marrangeGrob(plist, nrow = 2, ncol = 2)
# plots

ggsave("Treeheights_species_vs_nospecies_effect_vs_FTH.pdf",
       path = "D:/Mes Donnees/PhD/R_codes/PhD/Inventory_scripts/Exploration/pdf",
       plots, width = 15, height = 10)
```
Pour :
species effect:
Mouriri_huberi
Couepia_caryophylloides
Licaria_cannella

no species effect:
Virola_michelii
Qualea_rosea
Hebepetalum_humiriifolium
Licania_canescens
Licania_membranacea
Chimarrhis_turbinata
Quiina_obovata
Ecclinusa_ramiflora

les 2 conviennent:
Oxandra_asbeckii 
Protium_opacum
Eugenia_cupulata
Talisia_hexaphylla
Pouteria_guianensis

# Rebind & rename columns
```{r}
pred <- same_sp %>%
  bind_rows(other_sp) %>% 
  rename(DBHcor = dbh.y)


nrow(pred) == nrow(Inventory)
length(unique(pred$ScientificName)) == length(unique(Inventory$ScientificName)) 
```

```{r}
ggplot(pred, aes(x=TreeHeight, y=HC)) +
  geom_point() +
  labs(x= "Tree height (m)", y= "Local canopy height (m)")
```
```{r}
pred %>% 
  filter(ScientificName=="Lecythis_poiteaui") %>% 
ggplot(aes(x=DBHcor, y=TreeHeight)) +
  geom_point()

```

# Write data
```{r}
write.csv(pred, "D:/Mes Donnees/PhD/Inventories/Data/Adults_Understory/Paracou/AllP16_TreeHeights.csv")
```


# Obsolete
```{r, eval=F}
?add_predicted_draws
truc <- brms::bf(height~(alpha*dbh.y)/(beta+dbh.y),
                 alpha ~ HC + 1|species_noSing,
                 beta ~ 1|species_noSing, # que cette ligne donne des valeurs négatives
                 nl = TRUE) # donne la meme valeur pour ttes les espèces

same_sp_pred <- same_sp %>%
  add_epred_draws(fit, re_formula = ~ (HC + 1|species_noSing), 
                  allow_new_levels = F, 
                  value = "pred") %>% # 398 sp * 6000 iterations
  group_by(species_noSing) %>% 
  mutate(TreeHeight = round(median(pred), 1)) %>% # compute median of the iterations
  ungroup() %>% 
  select(-c(".row", ".chain", ".iteration", ".draw", "pred")) %>% 
  unique()

# add_predicted_draws propage l'incertitude
# add_epred_draws gives you the posterior expectation (the predicted average value, excluding residual variance)

other_sp_pred <- other_sp %>%
  add_epred_draws(fit, re_formula = NA,
                  allow_new_levels = T,
                  value = "pred") %>%  # n sp * 6000 iterations
  group_by(species_noSing) %>% 
  mutate(TreeHeight = round(median(pred), 1)) %>% # compute median of the iterations
  ungroup() %>% 
  select(-c(".row", ".chain", ".iteration", ".draw", "pred")) %>% 
  unique()

# Sylvain - extraire les paramètres
fit %>% 
  tidybayes::spread_draws(b_hmax_Intercept, r_species__hmax[species,], # or manipulating posteriors directly; support a wider range of models
                          b_ah_Intercept, r_species__ah[species,]) %>% 
  mutate(ah = b_ah_Intercept + r_species__ah) %>% 
  mutate(hmax = b_hmax_Intercept + r_species__hmax) %>% 
  group_by(species) %>% 
  summarise(ah = median(ah), hmax = median(hmax)) %>% 
  filter(species != "unknown") %>% 
  mutate(species = gsub(".", " ", species, fixed = TRUE)) %>% 
  left_join(read_csv("data/species/tallo.csv") %>% 
              filter(longitude <= -39, longitude >= -79, latitude >= -18, latitude <= 10) %>% 
              select(family, genus, species) %>% unique()) %>% 
  write_tsv("outputs/tallo_pars.tsv")
```

