---
title: "HOBO_data_script"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: html_document
---
**les données très fortes de lumière = sunflex étude sunflecks**

Objectives: 
- open the HOBO data
- create a script to open HOBO data in several folders
- prepare HOBO data for analysis
- spatialiser tous les capteurs en x,y (trilateration) (A FAIRE)
- descriptive analysis

Problematics:
- A quelle échelle la variabilité est la plus forte (saison, mois, jour, jour/nuit, 15min) ?
- La température de l'air et la lumière sont-elles liées à l'ouverture de canopée ? à la topographie ?

Variables à calculer :
- moyenne de l’année
- moyenne diurne
- moyenne nocturne
- moyenne saison sèche
    - diurne
    - nocturne
- moyenne saison des pluies
    - diurne
    - nocturne
- coefficient variation à ces échelles

# Packages
```{r echo = T,results = 'hide', message=FALSE}
library(tidyverse)
library(readr)
library(stringr)
library(lubridate) # for dates and time
library(chron) # for dates and time
library(corrplot)
library(RColorBrewer)
```

# Read 
```{r , include = F}
HOBO_Paracou_env <- read_csv("~/PhD/Microclimate/HOBO_Tomst_environment/Tomst-HOBO sensors - Paracou - Data.csv")

# catch the name of all the files of the folder
filenames <- list.files("~/PhD/Microclimate/HOBO/25_05_2023/csv", pattern="*.csv", full.names=TRUE) 

# dans l'ordre du numéro des capteurs
filenames <- gtools::mixedsort(sort(filenames)) 

# read all the files
df_list <- lapply(filenames, read_delim, 
                  delim = ";", escape_double = FALSE,
                  col_types =
                    cols(`#` = col_character(),
                         `Ch: 1 - Température   (°C)` = col_number(), 
                         `Ch: 2 - Lumière   (lux)` = col_number()),
                  locale = locale(decimal_mark = ","), 
                  trim_ws = TRUE) # read all the folder files

# bind all the files
HOBOdata <- bind_rows(df_list, .id = "HoboID")
```
# Combine data and environnment
```{r}
HOBOdata <- HOBOdata %>% 
  mutate(HoboID = as.numeric(HoboID)) %>% 
  left_join(HOBO_Paracou_env, by = "HoboID")
```

# Rename files
```{r , include = F}
# truc <- sub("D:/Mes Donnees/PhD/Microclimate/HOBO/25_05_2023", "", filenames)
# truc2 <- stringr::str_replace(truc, "(Data French Guiana Standard Time)", "")
# truc3 <- stringr::str_replace(truc2, ".csv", "")
# truc4 <- stringr::str_replace(truc3, " AST ", "")
# truc5 <- gsub("[()]", "", truc4)
# 
# names(df_list) <- truc5
```


# Understand the HOBO file
Les 30 capteurs ont été posés le 30/03/23 et ont commencé à collecter des données ce même jour à 18h.
Ils collectent bien toutes les 15 minutes.
```{r}
# str(df_list) # list of 30 data.frames with 5364 obs and 8 columns each
names(HOBOdata)
range(HOBOdata$HoboID) # 30 sensors
range(HOBOdata$`Date et heure (French Guiana Standard Time)`)
# filter à > "30/03/23 18:00:00"
```

# Prepare HOBO data for analysis
Rename variables
```{r}
HOBOdata <- HOBOdata %>% 
  rename(Index = '#') %>%
  rename(Time = 'Date et heure (French Guiana Standard Time)') %>%
  rename(Temp = 'Ch: 1 - Température   (°C)') %>%
  rename(Light = 'Ch: 2 - Lumière   (lux)')

HOBOdata
```

## Manage date and hours
```{r}
class(HOBOdata$Time) # the time is in character

HOBOdata <- HOBOdata %>% 
  separate(Time, sep = " ", into = c("Date", "Hour"), remove = F) %>% 
  mutate(Date = as_date(Date, format = "%m/%d/%Y")) %>% 
  mutate(Month = month(Date)) %>%
  mutate(Hour = hms::as_hms(Hour)) %>% 
  mutate(Time = mdy_hms(Time)) %>% # format Date-times: 2023-03-30 18:15:00
  filter(Time >= mdy_hms("03/30/2023 18:00:00")) 


range(HOBOdata$Time)
max(HOBOdata$Date) # "2023-05-25" the collect date
max(HOBOdata$Date) - min(HOBOdata$Date) # 56 days of collect
```

## NA ?
```{r}
Na_tabble <- HOBOdata %>%
  filter(is.na(Light) | is.na(Temp))
# 
# NA1 <- HOBOdata %>% 
#   filter(Date == "2023-04-04")
# 
# # Remove what is between the 15 minutes
# HOBOdata <- HOBOdata %>%
#   filter(minute(HOBOdata$Time) %in% c("0", "15", "30", "45"))
```


## Different time steps
```{r}
# Average per day
HOBO_stats <- HOBOdata %>%
  group_by(Date) %>%
  mutate(Mean_Temp = mean(Temp)) %>%
  mutate(Sd_Temp = sd(Temp)) %>%
  mutate(Max_Temp = max(Temp)) %>%
  mutate(Min_Temp = min(Temp)) %>%
  mutate(Mean_Light = mean(Light)) %>%
  mutate(Sd_Light = sd(Light)) %>%
  mutate(Max_Light = max(Light)) %>%
  mutate(Min_Light = min(Light)) %>%
  select(-Temp,-Light, -Index,-Time, -Date, -Month, -Hour) %>%
  ungroup() %>% 
  unique()

# By Hour
HOBO_Hour_stats <- HOBOdata %>%
  group_by(Hour) %>%
  mutate(Mean_Temp = mean(Temp)) %>%
  mutate(Sd_Temp = sd(Temp)) %>%
  mutate(Max_Temp = max(Temp)) %>%
  mutate(Min_Temp = min(Temp)) %>%
  mutate(Mean_Light = mean(Light)) %>%
  mutate(Sd_Light = sd(Light)) %>%
  mutate(Max_Light = max(Light)) %>%
  mutate(Min_Light = min(Light)) %>%
  select(-Temp,-Light, -Index,-Time, -Date) %>%
  ungroup() %>% 
  unique()


# Day and night averages (A FAIRE)
# Night: 19-5h 
HOBOdata <- HOBOdata %>%
  mutate(Phase = ifelse((Hour >= hms::as_hms("19:00:00") |
                           Hour <= hms::as_hms("05:00:00")), 
                        "Night", "Day"))

max(as.character(HOBOdata[HOBOdata$Phase == "Day",]$Hour)) # 18:45
min(as.character(HOBOdata[HOBOdata$Phase == "Day",]$Hour)) # 5:15
max(HOBOdata[HOBOdata$Phase == "Night",]$Light) # 0.2 lux
min(HOBOdata[HOBOdata$Phase == "Day",]$Light)


HOBO_NightDay_stats <- HOBOdata %>%
  group_by(Date,Phase) %>%
  mutate(Mean_Temp = mean(Temp)) %>%
  mutate(Sd_Temp = sd(Temp)) %>%
  mutate(Max_Temp = max(Temp)) %>%
  mutate(Min_Temp = min(Temp)) %>%
  mutate(Mean_Light = mean(Light)) %>%
  mutate(Sd_Light = sd(Light)) %>%
  mutate(Max_Light = max(Light)) %>%
  mutate(Min_Light = min(Light)) %>%
  select(-Temp,-Light, -Index,-Time,-Hour) %>%
  ungroup() %>% 
  unique()

```

# Quick view of the temperature and light over time (dates)
```{r}
# over time: dates
ggplot(HOBOdata, aes(x = Date, y = Temp)) +
  geom_point() +
  scale_x_date(date_breaks = "1 week")

ggplot(HOBOdata, aes(x = Date, y = Light)) +
  geom_point() +
  # scale_y_continuous(limits = c(0, 2000)) +
  scale_x_date(date_breaks = "1 week")

# Over a day
oneday <- HOBOdata %>% 
  filter(Date == "2023-04-04")

ggplot(oneday, aes(x = Hour,y = Light)) +
  geom_line() +
  labs(title="Light over a day (2023-04-04)",
       x ="Hour", y = "Light (lux)")

ggplot(oneday, aes(x = Hour,y = Temp)) +
  geom_line() +
  labs(title="Temperature over a day (2023-04-04)",
       x ="Hour", y = "Temperature (°C)")

# together
mean(max(oneday$Light)/max(oneday$Temp))
coeff <- 96
ggplot(oneday, aes(x = Hour)) +
  geom_line(aes(y = Temp), col = "red") +
  geom_line(aes(y = Light/coeff), col = "orange") +
  scale_y_continuous(
    # Features of the first axis
    name = "Temperature (°C)",
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*coeff, name="Light (lux)")
  ) +
  theme(
    axis.title.y = element_text(color = "red"),
    axis.title.y.right = element_text(color = "orange")
  ) +
  labs(title="Temperature and light over a day (2023-04-04)")

```

# Descriptive analysis

## Descriptive stats
```{r}
# for full data
mean(HOBOdata$Light) # 150 lux
sd(HOBOdata$Light) # 529 lux
min(HOBOdata$Light) # 0 lux
max(HOBOdata$Light) # 21944 lux

mean(HOBOdata$Temp) # 25 °C
sd(HOBOdata$Temp) # 1 °C
min(HOBOdata$Temp) # 21 °C
max(HOBOdata$Temp) # 31 °C

```
# Variables à calculer
```{r}
annual_stats <- HOBOdata %>%
  group_by(HoboID) %>%
  summarise(across(c("Temp", "Light"),
                   list(annual_mean = ~mean(.),
                        annual_sd = ~sd(.),
                        annual_varcoef = ~(sd(.) / mean(.)) * 100,
                        annual_max = ~max(.),
                        annual_min = ~min(.)),
                   .names = "{.col}_{.fn}"))

phase_stats <- HOBOdata %>%
  group_by(HoboID,Phase) %>%
  summarise(across(c("Temp", "Light"),
                   list(mean = ~mean(.),
                        sd = ~sd(.),
                        varcoef = ~(sd(.) / mean(.)) * 100,
                        max = ~max(.),
                        min = ~min(.)),
                   .names = "{.col}_{.fn}")) %>% 
  # "Phase" variable as an index for the computed variables
  pivot_wider(names_from = Phase,
              values_from = c("Temp_mean", "Temp_sd", "Temp_varcoef", "Temp_max", "Temp_min","Light_mean", "Light_sd", "Light_varcoef", "Light_max", "Light_min"),
              names_glue = "{.value}_{Phase}")


season_stats <- HOBOdata %>%
  group_by(HoboID,Season) %>%
  summarise(across(c("Temp", "Light"),
                   list(mean = ~mean(.),
                        sd = ~sd(.),
                        varcoef = ~(sd(.) / mean(.)) * 100,
                        max = ~max(.),
                        min = ~min(.)),
                   .names = "{.col}_{.fn}")) %>% 
  
  # "Season" variable as an index for the computed variables
  pivot_wider(names_from = Season,
              values_from = c("Temp_mean", "Temp_sd", "Temp_varcoef", "Temp_max", "Temp_min","Light_mean", "Light_sd", "Light_varcoef", "Light_max", "Light_min"),
              names_glue = "{.value}_{Season}")

```

# Stats dataset

```{r}
stats <- annual_stats %>% 
  left_join(season_stats, by="HoboID") %>%
  left_join(phase_stats, by="HoboID")

stats[is.na(stats)] <- 0
stats <- stats[,colSums(stats)>0] # remove column with only 0 (min light)


stats <- left_join(stats, env, by="HoboID")
```

## Corrélations
```{r}
cor(HOBOdata$Light,HOBOdata$Temp) # 0.34
plot(HOBOdata$Temp,HOBOdata$Light) 
plot(HOBOdata$Temp[HOBOdata$Light<1000],HOBOdata$Light[HOBOdata$Light<1000]) 
cor(HOBOdata$Light,as.numeric(HOBOdata$Hour)) # 0.023
cor(HOBOdata$Temp,as.numeric(HOBOdata$Hour)) # 0.31
# corrélation entre température et lumière
# corrélation entre l'heure de la journée et la température 
# pas de corrélation entre l'heure de la journée et la lumière

DF_cor <- HOBOdata %>% 
  select(- Index, -Time) %>% 
  mutate(Hour = as.numeric(Hour)) %>% 
  mutate(Date = as.numeric(Date)) %>% 
  select(-Phase)

CorMatrixS <- Hmisc::rcorr(as.matrix(DF_cor))
CorMatrix <- round(CorMatrixS$r, digits = 2)  # matrice de corrélation
Pval_corr <- CorMatrixS$P # p-values

# Plot de la matrice de corrélation :
corrplot(CorMatrix, method="circle", type="lower",
         col=brewer.pal(n=8, name="PuOr"), tl.col="black", tl.srt=45)
#, p.mat = Pval_corr, sig.level = 0.05) #avec une croix pour les p-value > 0.05.

```


## Descriptive plots
Plot evolution of the light (lux) and temperature (°C)
between the "2023-03-30" and the "2023-05-24"
```{r}
mean(max(HOBOdata$Light)/max(HOBOdata$Temp))
coeff <- 715
ggplot(HOBOdata, aes(x = Date)) +
  geom_point(aes(y = Temp), col = "red") +
  geom_point(aes(y = Light/coeff), col = "orange") +
  scale_y_continuous(
    # Features of the first axis
    name = "Temperature (°C)",
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*coeff, name="Light (lux)")
  ) +
  theme(
    axis.title.y = element_text(color = "red"),
    axis.title.y.right = element_text(color = "orange")
  ) +
  scale_x_date(date_breaks = "1 week")

```

```{r}
ggplot(HOBOdata, aes(x = as.character(Date), y = Light)) +
  geom_boxplot() +
  labs(y = "Light (lux)") +
  scale_y_continuous(limits = c(0, 1000))
```
Bon par date c'est pas une bonne manière d'observer le comportement des variables lumière et température

### Per day:
```{r}
HOBObis <- HOBOdata %>% 
  mutate(Date = as.character(Date)) %>% mutate(Time = as.character(Time)) # %>% mutate(Hour = format(Hour, as.POSIXct("%H:%M")))

ggplot(HOBObis) +
  aes(x = Hour, y = Temp) +
  geom_point(shape = "circle", size = 1.5, colour = "#112446") +
  theme_minimal() +
  facet_wrap(vars(Date), scales="free_y") +
  labs(y = "Temperature (°C)") +
  scale_x_time(breaks = hms::hms(hours = seq(0, 24, 12)))+
  labs(title = "HOBO 1 : Temperature over the day for each date")

HOBObis %>%
  ggplot() +
  aes(x = Hour, y = Light) +
  geom_col(fill = "#112446") +
  theme_minimal() +
  facet_wrap(vars(Date), scales="free_y") +
  labs(y = "Light (lux)")+
  scale_x_time(breaks = hms::hms(hours = seq(0, 24, 12)))+
  labs(title = "HOBO 1 : Light over the day for each date")

```

### Average per day (pas intéressant, ça fluctue au cours de la journée)
```{r}
coeff <- 700
ggplot(HOBO_stats, aes(x = Date)) +
  geom_line(aes(y = Mean_Temp), col = "red", linewidth=2) +
  geom_errorbar(aes(ymin= Min_Temp, ymax= Max_Temp), col = "red") +
  geom_line(aes(y = Mean_Light/coeff), col = "orange", linewidth=2) +
  geom_errorbar(aes(ymin=Min_Light/coeff, ymax=Max_Light/coeff), col = "orange") +
  scale_y_continuous(
    # Features of the first axis
    name = "Average daily temperature (°C)",
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*coeff, name=" Average daily light (lux)")
  ) +
  theme(
    axis.title.y = element_text(color = "red"),
    axis.title.y.right = element_text(color = "orange")
  ) +
  scale_x_date(date_labels = "%b %d", date_breaks = "1 week")
```

### Night/Day
```{r}
# Over a day
oneday <- HOBOdata %>% 
  filter(Date == "2023-04-04")

ggplot(oneday, aes(x = Hour,y = Light)) +
  geom_line() +
  labs(title="Light over a day (2023-04-04)",
       x ="Hour", y = "Light (lux)")

ggplot(oneday, aes(x = Hour,y = Temp)) +
  geom_line() +
  labs(title="Temperature over a day (2023-04-04)",
       x ="Hour", y = "Temperature (°C)")

HOBO_Hour_stats %>%
  filter(Max_Light <= 5000) %>%
  ggplot(aes(x = Hour, y = Mean_Light)) +
  geom_errorbar(aes(ymin=Min_Light, ymax=Max_Light, color = "Min and max value of Light"))+
  geom_line(linewidth=2, aes(color = "Mean of Light (lux)")) +
  scale_color_manual(name = "Legend",values=c('black', "grey"))+
  scale_x_time(breaks = hms::hms(hours = seq(0, 24, 4))) +
  labs(y = "Light (lux)",
       title ="HOBO 1: Average light for all dates over the day for (maximum light <= 5000 lux)")

ggplot(HOBO_Hour_stats, aes(x = Hour, y = Mean_Temp)) +
  geom_errorbar(aes(ymin=Min_Temp, ymax=Max_Temp, color = "Min and max value of temperature"))+
  geom_line(linewidth=2, aes(color = "Mean of temperature (C°)")) +
  scale_color_manual(name = "Legend",values=c('black', "grey"))+
  scale_x_time(breaks = hms::hms(hours = seq(0, 24, 4))) +
  labs(y = "Temperature (C°)",
       title ="HOBO 1: Average temperatures for all dates over the day")

```


# Sensors coordinates (mis de côté, à continuer, attente script Sylvain)
```{r}
coord_table <- HOBO_Paracou_env %>% 
  select(HoboID, SubPlot,
         TreeNum1, TreeNum2, TreeNum3, # IDs of neighbouring trees
         DTree1, DTree2, DTree3) # distances to neighbouring trees

idTrees <- unique(c(coord_table$TreeNum1, coord_table$TreeNum2, coord_table$TreeNum3))

Paracou16_2020 <- read_csv("~/PhD/Inventories/Data/Adults/Paracou16_2020.csv") %>% 
  filter(TreeFieldNum %in% idTrees) %>% 
  filter(SubPlot %in% unique(coord_table$SubPlot)) %>% 
  select(SubPlot, TreeFieldNum, Xfield, Yfield, Xutm, Yutm)

stop("Sensors coordinates: mis de côté, à continuer")
```
