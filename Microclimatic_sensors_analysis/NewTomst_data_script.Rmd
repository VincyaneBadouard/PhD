---
title: "Tomst data script"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: html_document
---
2 sites :
- Paracou (pour comparaison aux données Lidar)
- Nouragues **(?)**

Objectives: 
- open the Tomst data
- create a script to open Tomst data in several folders
- prepare Tomst data for analysis
- spatialiser tous les capteurs en x,y (trilateration) (A FAIRE)
- descriptive analysis

Problematics:
- A quelle échelle la variabilité est la plus forte (saison, mois, jour, jour/nuit, 15min) ?
- La température de l'air et la lumière sont-elles liées à l'ouverture de canopée ? à la topographie ?

Variables à calculer :
moyenne, sd, coefficient de variation, min, max :
- de l’année
- diurne
- nocturne
- saison sèche
- saison des pluies

# Packages
```{r echo = T,results = 'hide', message=FALSE}
library(readr)
library(tidyverse)
library(stringr)
library(lubridate) # for dates and time
library(chron) # for dates and time
library(corrplot)
library(RColorBrewer)
```

# Read 
## Sensor environnment data
```{r}
Tomst_Paracou_env <- read_csv("~/PhD/Microclimate/HOBO_Tomst_environment/Tomst-HOBO sensors - Paracou - Data.csv") %>% 
  mutate(TopoHabitat = factor(TopoHabitat, levels = c("Bottomland", "Lower slope", "Mid slope", "Upper slope", "Plateau")))
Tomst_Nouragues_env <- read_csv("~/PhD/Microclimate/HOBO_Tomst_environment/Tomst sensors - Nouragues - Data.csv") %>% 
  mutate(TopoHabitat = factor(TopoHabitat, levels = c("Bottomland", "Lower slope", "Mid slope", "Upper slope", "Plateau")))


env_Par <- Tomst_Paracou_env %>% 
  select(TomstID,Transect,LightHabitat,TopoHabitat)

env_Nour <- Tomst_Nouragues_env %>% 
  select(TomstID,Transect,LightHabitat,TopoHabitat)
```
## Sensor data
```{r , include = F}
# catch the name of all the files of the folder
filenames <- list.files("~/PhD/Microclimate/Tomst - data and scripts/LollyData/Paracou/Paracou_2023_05_25_1311", pattern="data", full.names=TRUE) 

# dans l'ordre du numéro des capteurs
filenames <- gtools::mixedsort(sort(filenames)) 

# read all the files
df_list <- lapply(filenames, read_delim, 
                  delim = ";", escape_double = FALSE,
                  col_types =
                    cols(`#` = col_character(),
                         `Ch: 1 - Température   (°C)` = col_number(), 
                         `Ch: 2 - Lumière   (lux)` = col_number()),
                  locale = locale(decimal_mark = ","), 
                  trim_ws = TRUE) # read all the folder files

# bind all the files
Tomstdata <- bind_rows(df_list, .id = "TomstID") # df number -> TomstID column
```

# Data formatting function
Columns :
- index number of the measure,
- date and time in UTC,
- time zone = 4 (French Guiana is UTC-3)
- T1, T2, T3,
- soil moisture count,
- shake = 0
- errFlag (if =1 the device couldn’t convert time from PCF chip) = NA

```{r}
format_tms <- function(
    data_path # path of the data (character) with ".csv"
){
  
  # Data name
  file_name <- data_path 
  
  # Subset data
  data <- read.csv2(data_path, header = F); # row 1 is not the headers
  
  # The date
  date1 <- strptime(data$V2,"%Y.%m.%d %H:%M")
  # Convert time in UTC-3 (ToDO!)
  
  # Temperature data
  SoilTemp <- data$V4
  SurfaceTemp <- data$V5
  AirTemp <- data$V6
  
  # Moisture data
  Moisture <- data$V7
  
  # Bind columns
  data2 <- cbind(as.data.frame(date1),
                 as.data.frame(SoilTemp), # soil T°
                 as.data.frame(SurfaceTemp), # surface T°
                 as.data.frame(AirTemp), # air T°
                 as.data.frame(Moisture))
  
  Output <- list("data" = data2 #,# dataset
                 # "file_name" = file_name, 
                 # "length" = length(SoilTemp)
                 ) # length of eah dataset
  
  return(Output)
}
```

# Format all the files
```{r}
path <- "~/PhD/Microclimate/Tomst - data and scripts/LollyData/Paracou/Paracou_2023_05_25_1311"
files <- list.files(path, pattern = "data", full.names = T)# [1:20] # 20 files

data <- lapply(files, format_tms)

names(data) <- files

Tomstdata <- bind_rows(data, .id = "TomstID") %>% # df number -> TomstID column
  unnest() %>% 
  mutate(TomstID = gsub(paste0(path, "/"), "", TomstID)) %>% 
  mutate(date = lubridate::as_datetime(date1)) # %>% 
  # select(date, SoilTemp, SurfaceTemp, AirTemp, Moisture) %>% 
  # reshape2::melt("date") # c'était pour le facet_wrap

# Rename TomstID
# date1 ou date ?
# filtrer à partir de la date d'installation sur le site

ggplot(Tomstdata, aes(date, value)) +
  geom_point() +
  geom_line() +
  facet_wrap(~variable, scales = "free_y") +
  theme_bw()
```


# Combine data and environnment
```{r}
Tomstdata <- Tomstdata %>% 
  mutate(TomstID = as.numeric(TomstID)) %>%
  left_join(Tomst_Paracou_env, by = "TomstID") %>%
  select(-Tomst_Material_info_30_03_23, -Operator)
```

## NA ?
```{r}
Na_tabble <- Tomstdata %>%
  filter(is.na(Light) | is.na(Temp))
```

# Manage date and hours


# Day/night 
```{r}
# See when it's the night
ggplot(HOBOdata, aes(x = Hour,y = Light)) +
  geom_line() +
  labs(title="Light over a day",
       x ="Hour", y = "Light (lux)")

HOBOdata <- HOBOdata %>%
  mutate(Phase = ifelse((Hour <= hms::as_hms("18:45:00") &
                           Hour >= hms::as_hms("06:15:00")),
                        "Day", "Night"))# %>%
# mutate(Phase = ifelse(Light == 0, "Night", "Day"))

ggplot(HOBOdata, aes(x = Hour,y = Light)) +
  geom_point(aes(color = Phase)) +
  labs(title="Light over a day",
       x ="Hour", y = "Light (lux)")

ggplot(HOBOdata[HOBOdata$Phase=="Night",], aes(x = Hour,y = Light)) +
  geom_point() +
  labs(title="Night over a day",
       x ="Hour", y = "Light (lux)")

max(HOBOdata[HOBOdata$Phase == "Night",]$Light) # 1.7 lux
min(HOBOdata[HOBOdata$Phase == "Day",]$Light) # 0 lux
```

# Seasons
```{r}
HOBOdata <- HOBOdata %>%
  mutate(Season = ifelse(Month  %in% c(7:11,3), # juill-nov et mars
                         "Dry", "Wet"))

ggplot(HOBOdata, aes(x = Month,y = Temp)) +
  geom_point(aes(color = Season)) +
  labs(title="Temperature over the seasons",
       x ="Month", y = "Temp (°C)")
```

# Variables à calculer
à l'échelle du capteur :
- moyenne de l’année
- moyenne diurne
- moyenne nocturne
- moyenne saison sèche
- diurne
- nocturne
- moyenne saison des pluies
- diurne
- nocturne
- coefficient variation à ces échelles
```{r}
annual_stats <- HOBOdata %>%
  group_by(HoboID) %>%
  summarise(across(c("Temp", "Light"),
                   list(annual_mean = ~mean(.),
                        annual_sd = ~sd(.),
                        annual_varcoef = ~(sd(.) / mean(.)) * 100,
                        annual_max = ~max(.),
                        annual_min = ~min(.)),
                   .names = "{.col}_{.fn}"))

phase_stats <- HOBOdata %>%
  group_by(HoboID,Phase) %>%
  summarise(across(c("Temp", "Light"),
                   list(mean = ~mean(.),
                        sd = ~sd(.),
                        varcoef = ~(sd(.) / mean(.)) * 100,
                        max = ~max(.),
                        min = ~min(.)),
                   .names = "{.col}_{.fn}")) %>% 
  # "Phase" variable as an index for the computed variables
  pivot_wider(names_from = Phase,
              values_from = c("Temp_mean", "Temp_sd", "Temp_varcoef", "Temp_max", "Temp_min","Light_mean", "Light_sd", "Light_varcoef", "Light_max", "Light_min"),
              names_glue = "{.value}_{Phase}")


season_stats <- HOBOdata %>%
  group_by(HoboID,Season) %>%
  summarise(across(c("Temp", "Light"),
                   list(mean = ~mean(.),
                        sd = ~sd(.),
                        varcoef = ~(sd(.) / mean(.)) * 100,
                        max = ~max(.),
                        min = ~min(.)),
                   .names = "{.col}_{.fn}")) %>% 
  
  # "Season" variable as an index for the computed variables
  pivot_wider(names_from = Season,
              values_from = c("Temp_mean", "Temp_sd", "Temp_varcoef", "Temp_max", "Temp_min","Light_mean", "Light_sd", "Light_varcoef", "Light_max", "Light_min"),
              names_glue = "{.value}_{Season}")

```

# Stats dataset
```{r}
stats <- annual_stats %>% 
  left_join(season_stats, by="HoboID") %>%
  left_join(phase_stats, by="HoboID")

stats[is.na(stats)] <- 0
stats <- stats[,colSums(stats)>0] # remove column with only 0 (min light)


stats <- left_join(stats, env, by="HoboID")
```

# Some plots
```{r}
# esquisse::esquisser()
```

# Correlation test
```{r}
DF_cor <- stats %>% 
  mutate(TopoHabitat = as.numeric(TopoHabitat)) %>% 
  mutate(LightHabitat = as.numeric(factor(LightHabitat, levels = c("Understory", "Sunfleck", "Gap border", "Gap")))) %>% 
  mutate(Transect = as.numeric(factor(Transect, levels = c("Topo", "Gap")))) %>% 
  na.omit()

CorMatrixS <- Hmisc::rcorr(as.matrix(DF_cor))
CorMatrix <- round(CorMatrixS$r, digits = 2)  # matrice de corrélation
Pval_corr <- CorMatrixS$P # p-values

# Plot de la matrice de corrélation :
# png("D:/Mes Donnees/PhD/Figures/Corplot_pedo_chimie.png", width = 900, height = 800)
corrplot(CorMatrix, method="circle", type="lower",
         col=brewer.pal(n=8, name="PuOr"), tl.col="black", tl.cex = 0.5, tl.srt=45)
# dev.off()
```

# Sensors coordinates (mis de côté, à continuer, attente script Sylvain)
```{r}
coord_table <- HOBO_Paracou_env %>% 
  select(HoboID, SubPlot,
         TreeNum1, TreeNum2, TreeNum3, # IDs of neighbouring trees
         DTree1, DTree2, DTree3) %>% # distances to neighbouring trees
  na.omit()

idTrees <- unique(c(coord_table$TreeNum1, coord_table$TreeNum2, coord_table$TreeNum3))

Paracou16_2020 <- read_csv("~/PhD/Inventories/Data/Adults/Paracou16_2020.csv") %>% 
  filter(TreeFieldNum %in% idTrees) %>% 
  filter(SubPlot %in% unique(coord_table$SubPlot)) %>% 
  select(SubPlot, TreeFieldNum, Xfield, Yfield, Xutm, Yutm)

RefTrees <- Paracou16_2020
Target <- coord_table
# stop("Sensors coordinates: mis de côté, à continuer")
```

## Trilateration
```{r}

```

# Save the stats dataset
```{r}
write.csv(stats, "~/PhD/Microclimate/HOBO/HOBO_stats.csv")
```
