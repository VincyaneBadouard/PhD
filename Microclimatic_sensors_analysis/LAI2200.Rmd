---
title: "LAI2200 script"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

The LAI-2200 Plant Canopy Analyzer measures: 
the interception of blue light (320-490 nm) at 5 zenith angles (148° field-of-view) simultaneously.


```{r, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE, echo = FALSE, fig.width = 6
)
```

```{r}
library(readr)
library(data.table)
library(tidyverse)
library(ggrepel)
```

# Functions
```{r}
# names(data)
readLAI2200 <- function(path){
  data <- fread(path,
                sep = "\t", 
                skip= "Observations") %>% 
    separate(V3, sep = " ", into = c("Date", "Time"), remove = F) %>% 
    rename(DateTime = V3) %>% 
    rename(Position = '### Observations') %>% 
    rename(Index = V2) %>% 
    rename(Sensor = V4) %>% 
    rename(Ring1 = V5) %>% 
    rename(Ring2 = V6) %>% 
    rename(Ring3 = V7) %>% 
    rename(Ring4 = V8) %>% 
    rename(Ring5 = V9) %>% 
    mutate(Position = case_when(
      Position == "B" ~ "BELOW",
      Position == "A" ~ "ABOVE")) #%>% 
  # mutate(Time = hms::as.hms(Time))
  # filter(Time != "17:10:37") %>% # pour PIPO1
  # filter(Time != "17:10:53") %>%
  # filter(Time != "17:11:09")
}
```

# Calibration between both sensors
Protocol: Take data in the same location and in the same time to check the difference of measurement and correct it.
```{r}
path <- "D:/Mes Donnees/PhD/Light/LAI-2200/DATA/TEST.TXT"

data <- readLAI2200(path)
```

# Join data
```{r}
# path <- "D:/Mes Donnees/PhD/Light/LAI-2200/DATA/P16LAYA.TXT"
# Above <- readLAI2200(path) %>% 
#   filter(Date==20231021) %>% 
#   filter(Time > "17:18:00") %>% 
#   mutate(Sensor = "ABOVE")

path <- "D:/Mes Donnees/PhD/Light/LAI-2200/DATA/"

# Below <- readLAI2200(paste(path,"P16LAY1.TXT", sep="")) %>% 
#   bind_rows(readLAI2200(paste(path,"P16LAY2.TXT", sep=""))) %>% 
#   bind_rows(readLAI2200(paste(path,"P16LAY3.TXT", sep=""))) %>% 
#   bind_rows(readLAI2200(paste(path,"P16LAY4.TXT", sep="")))

# Path of all the transect
files <- list.files(path, pattern = "P16LAY", full.names = T)# [1:20] # 20 files

# Read all the files of the transect
data <- lapply(files, readLAI2200)

# Just keep the file id
files <- str_remove(files, path)
files <- str_remove(files, ".TXT")

names(data) <- files

data <- bind_rows(data, .id = "File_Id") %>% # df number -> File_Id column
  # Filter date and time
  filter(Date==20231021) %>%
  filter(Time > "17:18:00") %>% 
  # Recode the file attribution
  mutate(File_Id = case_when( 
    File_Id == "P16LAY3" ~ "P16LAY2", 
    File_Id == "P16LAY4" ~ "P16LAY3",
    .default = File_Id)) %>% 
  # Recode the measurement id
  group_by(File_Id) %>% 
  mutate(Id = seq(1:n())) %>% 
  ungroup() %>% 
  mutate(Id = as.character(Id))



# data <- bind_rows(Above, Below)
data <- data[order(data$Time),] # temps par ordre croissant
```

```{r}
# To check the Id
data %>% 
  filter(File_Id == "P16LAY1") %>% 
  ggplot(aes(x = Time, y = Ring1, label = Id)) + 
  geom_point() +
  geom_text_repel() 

# Wide to long format
data_long <- data %>% 
  pivot_longer(
    cols = c("Ring1", "Ring2", "Ring3", "Ring4", "Ring5"), 
    names_to = "Ring",
    values_to = "Value"
  )

# Plot with all rings
ggplot(data_long, aes(x = Time, y = Value, col = Position, shape = File_Id)) + 
  geom_point() +
  facet_grid(vars(Ring), scales = "free")

data_long_B <- data_long %>% 
  filter(Position != "ABOVE") %>%
  mutate(Time = hms::as_hms(Time))

data_long_B %>% 
  ggplot(aes(x = Time, y = Value, col = File_Id)) + 
  geom_point() +
  scale_x_time(breaks = hms::hms(minutes = seq(0, 3600, 5))) +
  facet_grid(vars(Ring), scales = "free")
```

# Check if transmittance change over time
Transmittance = Below/Above for each angle (doit être <= 1)

```{r}

data_wide_AB <- data_long %>%
  mutate(BELOW = ifelse(Position == "BELOW", Value, NA)) %>% 
  mutate(ABOVE = ifelse(Position == "ABOVE", Value, NA)) %>% 
  mutate(Time = hms::as.hms(Time)) %>%
  mutate(TimeB = hms::as.hms(ifelse(!is.na(BELOW), Time, NA))) %>% 
  mutate(TimeA = hms::as.hms(ifelse(!is.na(ABOVE), Time, NA)))


# data_wide_AB <- data_long %>% 
#   select(-c(File_Id, Sensor, Id, Index)) %>%
#   pivot_wider(names_from = Position,
#               values_from = "Value",
#               names_glue = "{Position}") %>% 
#   mutate(Time = hms::as.hms(Time)) %>%
#   mutate(TimeB = hms::as.hms(ifelse(!is.na(BELOW), Time, NA))) %>% 
#   mutate(TimeA = hms::as.hms(ifelse(!is.na(ABOVE), Time, NA)))


# Take the closest Above time of Below time
for(n in seq(1:nrow(data_wide_AB[!is.na(data_wide_AB$BELOW),]))){
  data_wide_AB$TimeA[n] <- data_wide_AB$TimeA[which.min(abs(
    data_wide_AB$TimeA - data_wide_AB$TimeB[n]))
  ]
}

Above <- na.omit(select(data_wide_AB, c(TimeA, Ring, ABOVE))) %>% 
  unique()

Transmittance_data <- data_wide_AB %>% 
  left_join(Above, by = c("TimeA", "Ring")) %>% 
  mutate(ABOVE = coalesce(ABOVE.x, ABOVE.y)) %>%  # pour combiner les valeurs de .x et .y %>% 
  select(-(contains(".x") | contains(".y"))) %>%
  filter(!is.na(BELOW)) %>% 
  mutate(Transmittance = BELOW/ABOVE)

```

```{r}
ggplot(Transmittance_data, aes(x = Time, y = Transmittance, col = File_Id)) + 
  geom_point() +
  facet_grid(vars(Ring), scales = "free")

# Check that all the Transmittance are < 1
all(Transmittance_data$Transmittance < 1)

# Check correlation between Transmittance of each location (Id), for each Ring, between iteration (File_Id)
Transmittance_cor <- Transmittance_data %>% 
  select(File_Id, Id, Ring, Transmittance) %>% 
  pivot_wider(names_from = File_Id,
              values_from = "Transmittance",
              names_glue = "{.value}_{File_Id}")
  
Transmittance_cor <- Transmittance_cor %>% 
  select(-Ring)
  
By <- by(Transmittance_cor[2:4], Transmittance_cor[-(2:4)], cor)


sink("D:/Mes Donnees/PhD/Light/LAI-2200/DATA/Transmittance_cor.txt")
#write this string to file
By
#close the external connection
sink() 
  
```

```{r}
# Long to wide format
data_wide_ring <- data %>% 
  select(-c(File_Id, Index, Id, Sensor)) %>%
  pivot_wider(names_from = Position,
              values_from = c("Ring1", "Ring2", "Ring3", "Ring4", "Ring5"),
              names_glue = "{.value}_{Position}")

names(data_wide_ring)
ggplot(data_wide_ring, aes(x = Ring1_ABOVE, y = Ring1_BELOW)) + 
  geom_point() +
  geom_line()

data_wide <- data_long %>% 
  select(-c(1:2)) %>% 
  pivot_wider(names_from = Position,
              values_from = "Value",
              names_glue = "{Position}")

# Plot with all rings
ggplot(data_wide, aes(x = ABOVE, y = BELOW)) + 
  geom_point() +
  geom_line() +
  facet_grid(vars(Ring), scales = "free")
```
si pente significativement différente de 1, l'utiliser comme facteur correctif 
```{r}
# -1 pour forcer l'intercept à 0
Calibration_factors <- data.frame(
  Ring1_cor = lm(data_wide_ring$Ring1_BELOW ~ data_wide_ring$Ring1_ABOVE-1)$coefficients,
  
  Ring2_cor = lm(data_wide_ring$Ring2_BELOW ~ data_wide_ring$Ring2_ABOVE-1)$coefficients,
  
  Ring3_cor = lm(data_wide_ring$Ring3_BELOW ~ data_wide_ring$Ring3_ABOVE-1)$coefficients,
  
  Ring4_cor = lm(data_wide_ring$Ring4_BELOW ~ data_wide_ring$Ring4_ABOVE-1)$coefficients,
  
  Ring5_cor = lm(data_wide_ring$Ring5_BELOW ~ data_wide_ring$Ring5_ABOVE-1)$coefficients,
  row.names = "BELOW ~ ABOVE-1"
)

write.csv(Calibration_factors, "D:/Mes Donnees/PhD/Light/LAI-2200/DATA/Calibration_factors.csv")

summary(lm(data_wide_ring$Ring5_BELOW ~ data_wide_ring$Ring5_ABOVE-1))
```

```{r}
Calibration_factors <- read_csv("~/PhD/Light/LAI-2200/DATA/Calibration_factors.csv")
```


# Test DZ (Drop Zone)
3 répétitions
et une en poste fixe en sous bois en attendant que la nuit tombe.
```{r}
data <- fread("D:/Mes Donnees/PhD/Light/LAI-2200/DATA/DZ1.TXT",
              sep = "\t", 
              skip= "Observations") %>% 
  separate(V3, sep = " ", into = c("Date", "Time"), remove = F) %>% 
  rename(DateTime = V3) %>% 
  rename(Index = V2) %>% 
  rename(Sensor = V4) %>% 
  rename(Ring1 = V5) %>% 
  rename(Ring2 = V6) %>% 
  rename(Ring3 = V7) %>% 
  rename(Ring4 = V8) %>% 
  rename(Ring5 = V9) %>% 
  mutate(Sensor = case_when(
    Sensor == "W1" ~ "BELOW",
    Sensor == "W2" ~ "ABOVE")) %>% 
  mutate(Time = hms::as_hms(data$Time))

data <- data[1:68,]
```

```{r}
# Wide to long format
data_long <- data %>% 
  pivot_longer(
    cols = c("Ring1", "Ring2", "Ring3", "Ring4", "Ring5"), 
    names_to = "Ring",
    values_to = "Value"
  )

# Plot with all rings
ggplot(data_long, aes(x = Time, y = Value, col = Sensor)) + 
  geom_point() +
  facet_grid(vars(Ring), scales = "free") +
  scale_x_time(breaks = hms::hms(minutes = seq(0, 3600, 5)))
```
