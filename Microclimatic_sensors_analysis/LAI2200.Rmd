---
title: "LAI2200 script"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

The LAI-2200 Plant Canopy Analyzer measures:  
the interception of blue light (320-490 nm) at 5 zenith angles (148° field-of-view) simultaneously.  

Sensors calibration:  
1) Compute calibration factors between the 2 sensors  
2) Calibrate B sensor from A sensor  

Sensibility analyses:
1) Compute correlation of B/A over time for a same location  
If low, measurement are sufficient and we can take the mean for each location.  
If strong, measurement are insufficient.  


```{r, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE, echo = FALSE, fig.width = 6
)
```

```{r}
library(readr)
library(data.table)
library(tidyverse)
library(ggrepel)
```

# Functions
```{r}
# names(data)
readLAI2200 <- function(path){
  data <- fread(path,
                sep = "\t", 
                skip= "Observations") %>% 
    separate(V3, sep = " ", into = c("Date", "Time"), remove = F) %>% 
    rename(DateTime = V3) %>% 
    rename(Position = '### Observations') %>% 
    rename(Index = V2) %>% 
    rename(Sensor = V4) %>% 
    rename(Ring1 = V5) %>% 
    rename(Ring2 = V6) %>% 
    rename(Ring3 = V7) %>% 
    rename(Ring4 = V8) %>% 
    rename(Ring5 = V9) %>% 
    mutate(Position = case_when(
      Position == "B" ~ "BELOW",
      Position == "A" ~ "ABOVE")) #%>% 
  # mutate(Time = hms::as_hms(Time))
  # filter(Time != "17:10:37") %>% # pour PIPO1
  # filter(Time != "17:10:53") %>%
  # filter(Time != "17:11:09")
}
```

# Calibration between both sensors
Protocol: Take data with the two sensors in the same location and in the same time to check the difference of measurement and correct it.  
```{r}
path <- "D:/Mes Donnees/PhD/Light/LAI-2200/DATA/TEST.TXT"

data <- readLAI2200(path)
```

```{r}
# Wide to long format
data_long <- data %>% 
  pivot_longer(
    cols = c("Ring1", "Ring2", "Ring3", "Ring4", "Ring5"), 
    names_to = "Ring",
    values_to = "Value"
  ) #%>% 
# mutate(Time = hms::as_hms(Time))

# Plot with all rings
ggplot(data_long, aes(x = Time, y = Value, col = Position)) + 
  geom_point() +
  facet_grid(vars(Ring), scales = "free") #+
# scale_x_time(breaks = hms::hms(minutes = seq(0, 3600, 5)))
```

Faire la régression entre les données des 2 capteurs  
Si pente significativement différente de 1, l'utiliser comme facteur correctif  
```{r}
# Long to wide format
data_wide_ring <- data %>% 
  select(-c(Index, Sensor)) %>%
  pivot_wider(names_from = Position,
              values_from = c("Ring1", "Ring2", "Ring3", "Ring4", "Ring5"),
              names_glue = "{.value}_{Position}")

ggplot(data_wide_ring, aes(x = Ring1_ABOVE-1, y = Ring1_BELOW)) +
  geom_point() +
  stat_smooth(method = "lm", formula = y ~ x)
```

```{r}
# -1 pour forcer l'intercept à 0
Calibration_factors <- data.frame(
  Ring1_cor = lm(data_wide_ring$Ring1_BELOW ~ data_wide_ring$Ring1_ABOVE-1)$coefficients,
  
  Ring2_cor = lm(data_wide_ring$Ring2_BELOW ~ data_wide_ring$Ring2_ABOVE-1)$coefficients,
  
  Ring3_cor = lm(data_wide_ring$Ring3_BELOW ~ data_wide_ring$Ring3_ABOVE-1)$coefficients,
  
  Ring4_cor = lm(data_wide_ring$Ring4_BELOW ~ data_wide_ring$Ring4_ABOVE-1)$coefficients,
  
  Ring5_cor = lm(data_wide_ring$Ring5_BELOW ~ data_wide_ring$Ring5_ABOVE-1)$coefficients,
  row.names = "BELOW ~ ABOVE-1"
)
Calibration_factors

write.csv(Calibration_factors, "D:/Mes Donnees/PhD/Light/LAI-2200/DATA/Calibration_factors.csv")

summary(lm(data_wide_ring$Ring5_BELOW ~ data_wide_ring$Ring5_ABOVE-1))
```

# Test DZ (Drop Zone)
Protocol:
- 3 repetitions over a canopy opening gradient with the below sensor. Above sensor in above location.  
- from 6:0 pm: acquisitions in fix position, in understory, until the night arrive.  
```{r}
path <- "D:/Mes Donnees/PhD/Light/LAI-2200/DATA/DZ1.TXT"
data <- readLAI2200(path)

data <- data[1:68,]
```
Plot
```{r}
# Wide to long format
data_long <- data %>% 
  pivot_longer(
    cols = c("Ring1", "Ring2", "Ring3", "Ring4", "Ring5"), 
    names_to = "Ring",
    values_to = "Value"
  ) %>% 
  mutate(Time = hms::as_hms(Time))

# Plot with all rings
ggplot(data_long, aes(x = Time, y = Value, col = Position)) + 
  geom_point() +
  facet_grid(vars(Ring), scales = "free") +
  scale_x_time(breaks = hms::hms(minutes = seq(0, 3600, 5)))
```

# Work on our data
P16LAY : data (26 locations) from the plot 16 of Paracou, at the edge between 14 et 19 subplots. 2 m between each location.  

P16HOBO : data (30 locations) from the plot 16 of Paracou, on the HOBO sensors gradient, over the 14 et 19 subplots. 10 m between each location.  
```{r}
# rm(list = ls()) # Vider l'envrmt
path <- "D:/Mes Donnees/PhD/Light/LAI-2200/DATA/"

pattern <- "P16LAY"
# ou 
pattern <- "P16HOBO"
```

```{r}
# Path of all the files of the transect
files <- list.files(path, pattern = pattern, full.names = T)

# Read all the files of the transect
data <- lapply(files, readLAI2200)

# Just keep the file id
files <- str_remove(files, path)
files <- str_remove(files, ".TXT")

names(data) <- files

data <- bind_rows(data, .id = "File_Id") # df number -> File_Id column
```

## For P16LAY
```{r}
data <- data %>% 
  # Filter date and time
  filter(Date==20231021) %>%
  filter(Time > "17:18:00") %>% # before it's Above sensor alone
  # Recode the file attribution
  mutate(File_Id = case_when( 
    File_Id == "P16LAY3" ~ "P16LAY2", 
    File_Id == "P16LAY4" ~ "P16LAY3",
    .default = File_Id))
```

## For P16HOBO
```{r}
data <- data %>% 
  # Filter time
  filter(Time > "17:12:15") %>%
  # Recode the file attribution
  mutate(File_Id = ifelse(File_Id == "P16HOBO2", "P16HOBO1", File_Id)) %>% 
  mutate(File_Id = ifelse(File_Id ==  "P16HOBO3", "P16HOBO2", File_Id))

unique(data$File_Id) # "P16HOBO1"   "P16HOBO2"   "P16HOBO4"   "P16HOBO5"   "P16HOBOA", "P16HOBOA_2"
nrow(data[data$File_Id=="P16HOBO5",])

```

# Recode the measurement id
```{r}
data <- data %>% 
  # Recode the measurement id
  group_by(File_Id) %>% 
  mutate(Id = seq(1:n())) %>% 
  ungroup() %>% 
  mutate(Id = factor(as.numeric(Id)))

data[data$File_Id=="P16HOBO5",]$Id # P16HOBO5

# To check the Id
data %>% 
  filter(File_Id == "P16LAY3") %>% # P16HOBO1
  ggplot(aes(x = Time, y = Ring1, label = as.character(Id))) + 
  geom_point() +
  geom_text_repel() # P16LAY3 has only 21/26 values
```

Plots the measurements
```{r}
# Wide to long format
data_long <- data %>% 
  pivot_longer(
    cols = c("Ring1", "Ring2", "Ring3", "Ring4", "Ring5"), 
    names_to = "Ring",
    values_to = "Value"
  )

# Plot of A and B sensors over the canopy opening gradient, for each ring, for the 3 repetitions
ggplot(data_long, aes(x = Time, y = Value, col = Position, shape = File_Id)) + 
  geom_point() +
  facet_grid(vars(Ring), scales = "free")

data_long_B <- data_long %>% 
  filter(Position != "ABOVE") %>%
  mutate(Time = hms::as_hms(Time))

# Plot of only B sensor, for each ring, for the 3 repetitions
data_long_B %>% 
  ggplot(aes(x = Time, y = Value, col = File_Id)) + 
  geom_point() +
  scale_x_time(breaks = hms::hms(minutes = seq(0, 3600, 5))) +
  facet_grid(vars(Ring), scales = "free")
```

## Attribute an Above measurement to a Below measurement 
```{r}
AB <- data_long %>%
  mutate(BELOW = ifelse(Position == "BELOW", Value, NA)) %>% # new column BELOW
  mutate(ABOVE = ifelse(Position == "ABOVE", Value, NA)) %>% # new column ABOVE
  mutate(Time = hms::as_hms(Time)) %>%
  mutate(TimeB = hms::as_hms(ifelse(!is.na(BELOW), Time, NA))) %>% # take time of B data
  mutate(TimeA = hms::as_hms(ifelse(!is.na(ABOVE), Time, NA))) # take time of A data

AB1 <- AB %>% filter(Date == unique(AB$Date)[1]) # day 1

AB2 <- AB %>% filter(Date == unique(AB$Date)[2]) # day 2

AB <- list(AB1, AB2)

# Take the closest Above time of Below time
for(i in 1:length(AB)){
  for(n in seq(1:nrow(AB[[i]][!is.na(AB[[i]]$BELOW),]))){
    
    AB[[i]]$TimeA[n] <- # A time
      
      AB[[i]]$TimeA[which.min(abs( # le temps A dont l'écart est le plus petit au temps B
        AB[[i]]$TimeA - AB[[i]]$TimeB[n]
      ))
      ]
  }
}

AB <- bind_rows(AB)


# Only Above data
Above <- na.omit(select(AB, c(Date, TimeA, Ring, ABOVE))) %>% 
  unique()

AB <- AB %>% 
  left_join(Above, by = c("Date", "TimeA", "Ring")) %>% # Join above data
  mutate(ABOVE = coalesce(ABOVE.x, ABOVE.y)) %>%  # pour combiner les valeurs de .x et .y %>% 
  select(-(contains(".x") | contains(".y"))) %>%
  filter(!is.na(BELOW)) # remove NA rows
```

## Correct data with calibration data
Sensors calibration:  
1) Compute calibration factors between the 2 sensors  
2) Calibrate B sensor from A sensor  

BELOW = (ABOVE-1) * Calibration_factors (ABOVE = the reference)  
so BELOW_cor = (BELOW / Calibration_factors)  
```{r}
Calibration_factors <- read_csv("~/PhD/Light/LAI-2200/DATA/Calibration_factors.csv")
Calibration_factors

# Correct measurements
data_correct <- AB %>% 
  mutate(BELOW = case_when(
    Ring == "Ring1" ~ BELOW / Calibration_factors$Ring1_cor,
    Ring == "Ring2" ~ BELOW / Calibration_factors$Ring2_cor,
    Ring == "Ring3" ~ BELOW / Calibration_factors$Ring3_cor,
    Ring == "Ring4" ~ BELOW / Calibration_factors$Ring4_cor,
    Ring == "Ring5" ~ BELOW / Calibration_factors$Ring5_cor,
    .default = BELOW) # le reste reste comme c'est
  )
```

## Check if transmittance change over time
Sensibility analyses: 
Compute correlation of B/A over time for a same location  
- If low, measurement are sufficient and we can take the mean for each location.  
- If strong, measurement are insufficient.  

Transmittance = Below/Above for each angle (doit être <= 1) 
```{r, Transmittance}
# Compute Transmittance
Transmittance_data <- data_correct %>% 
  mutate(Transmittance = BELOW/ABOVE)

# Check that all the Transmittance are < 1
all(Transmittance_data$Transmittance < 1)
```

```{r, Transmittance plots}
# Transmittance over time by ring
ggplot(Transmittance_data, aes(x = Time, y = Transmittance, col = File_Id)) + 
  geom_point() +
  facet_grid(vars(Ring), scales = "free")

# Transmittance by ring for each location 
ggplot(Transmittance_data, aes(x = Id, y = Transmittance, col = File_Id)) + 
  geom_point() +
  facet_grid(vars(Ring), scales = "free")
# Les 2 1ers rings sont les plus liés à l'ouverture locale de canopée

Transmittance_data %>% 
  filter(Ring=="Ring1") %>% 
  ggplot() + 
  geom_point(aes(x = factor(Id), y = Transmittance, col = File_Id))

Transmittance_data %>% 
  filter(Ring=="Ring2") %>% 
  ggplot() + 
  geom_point(aes(x = factor(Id), y = Transmittance, col = File_Id))

# id 12 : P16HOBO4 très mauvais
```

### Compute correlations between transmittance of different iterations
```{r, Transmittance corr}
# Check correlation between Transmittance of each location (Id), for each Ring, between iteration (File_Id)
Transmittance_cor1 <- Transmittance_data %>% 
  select(File_Id, Id, Ring, Transmittance) %>% # only var for cor test
  pivot_wider(names_from = File_Id,
              values_from = "Transmittance",
              names_glue = "{.value}_{File_Id}") # ARRETE LA

ggplot(Transmittance_cor1, aes(x = Transmittance_P16HOBO1, y = Transmittance_P16HOBO5)) + 
  geom_point() +
  facet_grid(vars(Ring), scales = "free")

# By Id ------------------------------------------------------------------------
# Transmittances comparées au meme id et au meme ring dans tous les cas, c'est juste summarisé par id ou par ring
Transmittance_cor <- Transmittance_cor1 %>% 
  select(-Ring)

By <- by(Transmittance_cor[-1], INDICES = Transmittance_cor[1], cor) # by() apply a Function to a Data Frame Split by Factors

# P16HOBO5 moins bien corrélé à P16HOBO1 pour l'id 1 (0.38) et 7 (0.47)
# id 5 : P16HOBO1 très mauvais
# id 12 : P16HOBO4 très mauvais
# id 17 :  P16HOBO1 très mauvais

# id 19 : P16LAY3 moins bon

# Write Transmittances correlation in text file
sink("D:/Mes Donnees/PhD/Light/LAI-2200/Transmittance_P16HOBO_cor_byId.txt") # path
By[1:max(as.numeric(Transmittance_cor$Id))]
sink() # close the external connection

# By Ring ----------------------------------------------------------------------
Transmittance_cor <- Transmittance_cor1 %>% 
  select(-Id)

By <- by(Transmittance_cor[-1], INDICES = Transmittance_cor[1], cor)

# Write Transmittances correlation in text file
sink("D:/Mes Donnees/PhD/Light/LAI-2200/Transmittance_P16HOBO_cor_byRing.txt") # path
By
sink() # close the external connection

# Ring 5 : acquisitions moins corrélées (0.7)
# Ring 4 : P16HOBO4 moins bon (0.6)
```

## Plot regression between transmittance of different iterations
```{r}
ggplot(Transmittance_cor1, aes(x = Transmittance_P16HOBO1, y = Transmittance_P16HOBO2))+
  geom_point()+
  stat_smooth(method = "lm", formula = y ~ x) +
  facet_grid(vars(Ring), scales = "free")

ring <- "Ring1"
Transmittance_cor1 %>% 
  filter(Ring == ring) %>% 
  ggplot(aes(x = Transmittance_P16HOBO1, y = Transmittance_P16HOBO2)) +
  geom_point() +
  stat_smooth(method = "lm", formula = y ~ x)

reg <- Transmittance_cor1 %>% 
  filter(Ring == ring)

summary(lm(reg$Transmittance_P16HOBO1 ~ reg$Transmittance_P16HOBO2))

```

```{r}
# Transmittance ~ location + Ring + iter

Transmittance_data <- Transmittance_data %>% 
  mutate(Id = as.factor(Id)) %>% 
  mutate(Ring = as.factor(Ring)) %>% 
  mutate(File_Id = as.factor(File_Id))

M1 <- lm(Transmittance ~ Id, data=Transmittance_data) # Id10 : 0.1
M1 <- lm(Transmittance ~ Ring, data=Transmittance_data) # rings ordonnés dans leur caractérisation de la transmittance
M1 <- lm(Transmittance ~ File_Id, data=Transmittance_data)

M2 <- lm(Transmittance ~ Id + Ring, data=Transmittance_data)
M3 <- lm(Transmittance ~ Id + Ring + File_Id, data=Transmittance_data)

aov(lm(Transmittance ~ Id, data=Transmittance_data[Transmittance_data$Ring=="Ring1",])) # 0.45 pour Ring1 et décroit fortement sur les autres rings
# erreur de 3%

hist(Transmittance_data$Transmittance[which(Transmittance_data$Ring=="Ring1")], breaks=50)
```

# Moyenner les transmittances par location, for each ring
```{r}
mean <- Transmittance_data %>% 
  select(-c(Position, Sensor, Index)) %>% 
  group_by(Id, Ring) %>% 
  mutate(Transmittance_mean = mean(Transmittance))

# Mean transmittance by ring for each location 
ggplot(mean, aes(x = Id, y = Transmittance_mean, col = File_Id)) + 
  geom_point() +
  facet_grid(vars(Ring), scales = "free")

mean %>% 
  filter(Ring=="Ring1") %>% 
  ggplot() + 
  geom_point(aes(x = factor(Id), y = Transmittance_mean))


# agrégéer (mean) à plutot 2 catégories : sous-bois et trouée, ou catégorie par transmittance

write.csv(mean, "D:/Mes Donnees/PhD/Light/LAI-2200/LAI2200_data_P16HOBO_mean.csv")
```

# Add environment data
```{r}
# For LAY
LAY <- read_csv("~/PhD/Light/LAI-2200/LAI2200_data_P16LAY_mean.csv")

LAYenv <- read_csv("~/PhD/Light/LAI-2200/LAI2200_environment.csv")

LAY <- LAY %>% 
  left_join(LAYenv, by= c('Id' = 'SampleID')) %>%
  mutate(Id = as.factor(Id))  %>% 
  mutate(Plot = as.character(Plot))

ggplot(LAY, aes(x = Id, y = Transmittance_mean, col = LightHabitat)) + 
  geom_point() +
  facet_grid(vars(Ring), scales = "free")

# For HOBO
HOBO <- read_csv("~/PhD/Light/LAI-2200/LAI2200_data_P16HOBO_mean.csv")

HOBOenv <- read_csv("~/PhD/Microclimate/HOBO_Tomst_environment/Tomst-HOBO sensors - Paracou - Data.csv") %>% 
  select(Site, Plot, SubPlot, HoboID, LightHabitat, TopoHabitat, LayonEdge) %>% 
  filter(HoboID<=20)

HOBO <- HOBO %>% 
  left_join(HOBOenv, by= c('Id' = 'HoboID')) %>%
  mutate(Id = as.factor(Id)) %>% 
  mutate(Transect = "HOBO") %>% 
  mutate(Plot = "16") %>% 
  mutate(SubPlot = as.character(SubPlot))

ggplot(HOBO, aes(x = Id, y = Transmittance_mean, col = LightHabitat)) + 
  geom_point() +
  facet_grid(vars(Ring), scales = "free")

# names(LAY)[!(names(LAY) %in% names(HOBO))]
# names(HOBO)[!(names(HOBO) %in% names(LAY))]

# Merge LAY and HOBO data with their environment
LAI2200 <- bind_rows(LAY, HOBO) %>% select(-c("...1","...2" )) %>%  # 22 col, 765 rows
  select(c(Site, Plot, Transect, SubPlot, File_Id : LayonEdge)) # reorder columns

write.csv(LAI2200, "D:/Mes Donnees/PhD/Light/LAI-2200/LAI2200_data.csv")
```

# Spacialisation (A FAIRE)
Attribute stakes coordinates to the sensors
each 10 m
Theorical_coordinates_P16.Rmd
```{r}
# stakes coordinates data


# attribute coordinates to the sensors
# LAI2200 <- 



# write.csv(LAI2200, "D:/Mes Donnees/PhD/Light/LAI-2200/LAI2200_data_spatialised.csv")
```

