---
title: "LAI2200 script"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

The LAI-2200 Plant Canopy Analyzer measures: 
the interception of blue light (320-490 nm) at 5 zenith angles (148° field-of-view) simultaneously.


```{r, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE, echo = FALSE, fig.width = 6
)
```

```{r}
library(readr)
library(data.table)
library(tidyverse)
```

# Calibration between both sensors
Protocol: Take data in the same location and in the same time to check the difference of measurement and correct it.
```{r}
calib <- fread("D:/Mes Donnees/PhD/Light/LAI-2200/DATA/TEST.TXT",
               sep = "\t", 
               skip= "Observations") %>% 
  separate(V3, sep = " ", into = c("Date", "Time"), remove = F) %>% 
  rename(DateTime = V3) %>% 
  rename(Index = V2) %>% 
  rename(Sensor = V4) %>% 
  rename(Ring1 = V5) %>% 
  rename(Ring2 = V6) %>% 
  rename(Ring3 = V7) %>% 
  rename(Ring4 = V8) %>% 
  rename(Ring5 = V9) %>% 
  mutate(Sensor = case_when(
    Sensor == "W1" ~ "BELOW",
    Sensor == "W2" ~ "ABOVE")) #%>% 
# filter(Time != "17:10:37") %>% # pour PIPO1
# filter(Time != "17:10:53") %>%
# filter(Time != "17:11:09")
```

```{r}
# Wide to long format
calib_long <- calib %>% 
  pivot_longer(
    cols = c("Ring1", "Ring2", "Ring3", "Ring4", "Ring5"), 
    names_to = "Ring",
    values_to = "Value"
  )

# Plot with all rings
ggplot(calib_long, aes(x = Time, y = Value, col = Sensor)) + 
  geom_point() +
  facet_grid(vars(Ring), scales = "free")
```

```{r}
# Long to wide format
calib_wide_ring <- calib %>% 
  select(-c(1:2)) %>% 
  pivot_wider(names_from = Sensor,
              values_from = c("Ring1", "Ring2", "Ring3", "Ring4", "Ring5"),
              names_glue = "{.value}_{Sensor}")

names(calib_wide)
ggplot(calib_wide, aes(x = Ring1_ABOVE, y = Ring1_BELOW)) + 
  geom_point() +
  geom_line()

calib_wide <- calib_long %>% 
  select(-c(1:2)) %>% 
  pivot_wider(names_from = Sensor,
              values_from = "Value",
              names_glue = "{Sensor}")

# Plot with all rings
ggplot(calib_wide, aes(x = ABOVE, y = BELOW)) + 
  geom_point() +
  geom_line() +
  facet_grid(vars(Ring), scales = "free")
```
si pente significativement différente de 1, l'utiliser comme facteur correctif 
```{r}
# -1 pour forcer l'intercept à 0
Calibration_factors <- data.frame(
  Ring1_cor = lm(calib_wide_ring$Ring1_BELOW ~ calib_wide_ring$Ring1_ABOVE-1)$coefficients,
  
  Ring2_cor = lm(calib_wide_ring$Ring2_BELOW ~ calib_wide_ring$Ring2_ABOVE-1)$coefficients,
  
  Ring3_cor = lm(calib_wide_ring$Ring3_BELOW ~ calib_wide_ring$Ring3_ABOVE-1)$coefficients,
  
  Ring4_cor = lm(calib_wide_ring$Ring4_BELOW ~ calib_wide_ring$Ring4_ABOVE-1)$coefficients,
  
  Ring5_cor = lm(calib_wide_ring$Ring5_BELOW ~ calib_wide_ring$Ring5_ABOVE-1)$coefficients,
  row.names = "BELOW ~ ABOVE-1"
)

write.csv(Calibration_factors, "D:/Mes Donnees/PhD/Light/LAI-2200/DATA/Calibration_factors.csv")

summary(lm(calib_wide_ring$Ring5_BELOW ~ calib_wide_ring$Ring5_ABOVE-1))
```

```{r}
Calibration_factors <- read_csv("~/PhD/Light/LAI-2200/DATA/Calibration_factors.csv")
```


# Test DZ (Drop Zone)
```{r}
calib <- fread("D:/Mes Donnees/PhD/Light/LAI-2200/DATA/DZ1.TXT",
               sep = "\t", 
               skip= "Observations") %>% 
  separate(V3, sep = " ", into = c("Date", "Time"), remove = F) %>% 
  rename(DateTime = V3) %>% 
  rename(Index = V2) %>% 
  rename(Sensor = V4) %>% 
  rename(Ring1 = V5) %>% 
  rename(Ring2 = V6) %>% 
  rename(Ring3 = V7) %>% 
  rename(Ring4 = V8) %>% 
  rename(Ring5 = V9) %>% 
  mutate(Sensor = case_when(
    Sensor == "W1" ~ "BELOW",
    Sensor == "W2" ~ "ABOVE"))
```

