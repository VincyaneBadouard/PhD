---
title: "LAI2200 script"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

The LAI-2200 Plant Canopy Analyzer measures: 
the interception of blue light (320-490 nm) at 5 zenith angles (148° field-of-view) simultaneously.


```{r, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE, echo = FALSE, fig.width = 6
)
```

```{r}
library(readr)
library(data.table)
library(tidyverse)
library(ggrepel)
```

# Functions
```{r}
# names(data)
readLAI2200 <- function(path){
  data <- fread(path,
                sep = "\t", 
                skip= "Observations") %>% 
    separate(V3, sep = " ", into = c("Date", "Time"), remove = F) %>% 
    rename(DateTime = V3) %>% 
    rename(Position = '### Observations') %>% 
    rename(Index = V2) %>% 
    rename(Sensor = V4) %>% 
    rename(Ring1 = V5) %>% 
    rename(Ring2 = V6) %>% 
    rename(Ring3 = V7) %>% 
    rename(Ring4 = V8) %>% 
    rename(Ring5 = V9) %>% 
    mutate(Position = case_when(
      Position == "B" ~ "BELOW",
      Position == "A" ~ "ABOVE")) #%>% 
  # mutate(Time = hms::as.hms(Time))
  # filter(Time != "17:10:37") %>% # pour PIPO1
  # filter(Time != "17:10:53") %>%
  # filter(Time != "17:11:09")
}
```

# Calibration between both sensors
Protocol: Take data in the same location and in the same time to check the difference of measurement and correct it.
```{r}
path <- "D:/Mes Donnees/PhD/Light/LAI-2200/DATA/TEST.TXT"

data <- readLAI2200(path)
```

```{r}
# Wide to long format
data_long <- data %>% 
  pivot_longer(
    cols = c("Ring1", "Ring2", "Ring3", "Ring4", "Ring5"), 
    names_to = "Ring",
    values_to = "Value"
  ) #%>% 
# mutate(Time = hms::as.hms(Time))

# Plot with all rings
ggplot(data_long, aes(x = Time, y = Value, col = Position)) + 
  geom_point() +
  facet_grid(vars(Ring), scales = "free") #+
# scale_x_time(breaks = hms::hms(minutes = seq(0, 3600, 5)))
```

Faire la régression entre les données des 2 capteurs
Si pente significativement différente de 1, l'utiliser comme facteur correctif

```{r}
# Long to wide format
data_wide_ring <- data %>% 
  select(-c(Index, Sensor)) %>%
  pivot_wider(names_from = Position,
              values_from = c("Ring1", "Ring2", "Ring3", "Ring4", "Ring5"),
              names_glue = "{.value}_{Position}")

ggplot(data_wide_ring, aes(x = Ring1_ABOVE-1, y = Ring1_BELOW)) +
  geom_point() +
  stat_smooth(method = "lm", formula = y ~ x)
```

```{r}
# -1 pour forcer l'intercept à 0
Calibration_factors <- data.frame(
  Ring1_cor = lm(data_wide_ring$Ring1_BELOW ~ data_wide_ring$Ring1_ABOVE-1)$coefficients,
  
  Ring2_cor = lm(data_wide_ring$Ring2_BELOW ~ data_wide_ring$Ring2_ABOVE-1)$coefficients,
  
  Ring3_cor = lm(data_wide_ring$Ring3_BELOW ~ data_wide_ring$Ring3_ABOVE-1)$coefficients,
  
  Ring4_cor = lm(data_wide_ring$Ring4_BELOW ~ data_wide_ring$Ring4_ABOVE-1)$coefficients,
  
  Ring5_cor = lm(data_wide_ring$Ring5_BELOW ~ data_wide_ring$Ring5_ABOVE-1)$coefficients,
  row.names = "BELOW ~ ABOVE-1"
)
Calibration_factors

write.csv(Calibration_factors, "D:/Mes Donnees/PhD/Light/LAI-2200/DATA/Calibration_factors.csv")

summary(lm(data_wide_ring$Ring5_BELOW ~ data_wide_ring$Ring5_ABOVE-1))
```

# Test DZ (Drop Zone)
3 répétitions
et une en poste fixe en sous bois en attendant que la nuit tombe.
```{r}
path <- "D:/Mes Donnees/PhD/Light/LAI-2200/DATA/DZ1.TXT"
data <- readLAI2200(path)

data <- data[1:68,]
```
Plot
```{r}
# Wide to long format
data_long <- data %>% 
  pivot_longer(
    cols = c("Ring1", "Ring2", "Ring3", "Ring4", "Ring5"), 
    names_to = "Ring",
    values_to = "Value"
  ) %>% 
  mutate(Time = hms::as.hms(Time))

# Plot with all rings
ggplot(data_long, aes(x = Time, y = Value, col = Position)) + 
  geom_point() +
  facet_grid(vars(Ring), scales = "free") +
  scale_x_time(breaks = hms::hms(minutes = seq(0, 3600, 5)))
```

# Work on our data
```{r}
# rm(list = ls()) # Vider l'envrmt
path <- "D:/Mes Donnees/PhD/Light/LAI-2200/DATA/"

pattern <- "P16LAY"
# ou 
pattern <- "P16HOBO"
```

```{r}
# Path of all the files of the transect
files <- list.files(path, pattern = pattern, full.names = T)

# Read all the files of the transect
data <- lapply(files, readLAI2200)

# Just keep the file id
files <- str_remove(files, path)
files <- str_remove(files, ".TXT")

names(data) <- files

data <- bind_rows(data, .id = "File_Id") # df number -> File_Id column
```

## For P16LAY
```{r}
data <- data %>% 
  # Filter date and time
  filter(Date==20231021) %>%
  filter(Time > "17:18:00") %>% 
  # Recode the file attribution
  mutate(File_Id = case_when( 
    File_Id == "P16LAY3" ~ "P16LAY2", 
    File_Id == "P16LAY4" ~ "P16LAY3",
    .default = File_Id))
```

## For P16HOBO
```{r}
data <- data %>% 
  # Filter time
  filter(Time > "17:12:15") %>%
  # Recode the file attribution
  mutate(File_Id = ifelse(File_Id == "P16HOBO2", "P16HOBO1", File_Id)) %>% 
  mutate(File_Id = ifelse(File_Id ==  "P16HOBO3", "P16HOBO2", File_Id))

unique(data$File_Id) # "P16HOBO1"   "P16HOBO2"   "P16HOBO4"   "P16HOBO5"   "P16HOBOA", "P16HOBOA_2"
nrow(data[data$File_Id=="P16HOBO5",])

```

```{r}
data <- data %>% 
  # Recode the measurement id
  group_by(File_Id) %>% 
  mutate(Id = seq(1:n())) %>% 
  ungroup() %>% 
  mutate(Id = as.character(Id))

data[data$File_Id=="P16HOBO5",]$Id

# To check the Id
data %>% 
  filter(File_Id == "P16HOBO4") %>% # P16HOBO1
  ggplot(aes(x = Time, y = Ring1, label = Id)) + 
  geom_point() +
  geom_text_repel() 
```

Plots the measurements
```{r}
# Wide to long format
data_long <- data %>% 
  pivot_longer(
    cols = c("Ring1", "Ring2", "Ring3", "Ring4", "Ring5"), 
    names_to = "Ring",
    values_to = "Value"
  )

# Plot with all rings
ggplot(data_long, aes(x = Time, y = Value, col = Position, shape = File_Id)) + 
  geom_point() +
  facet_grid(vars(Ring), scales = "free")

data_long_B <- data_long %>% 
  filter(Position != "ABOVE") %>%
  mutate(Time = hms::as_hms(Time))

data_long_B %>% 
  ggplot(aes(x = Time, y = Value, col = File_Id)) + 
  geom_point() +
  scale_x_time(breaks = hms::hms(minutes = seq(0, 3600, 5))) +
  facet_grid(vars(Ring), scales = "free")
```

## Attribute an Above measurement to a Below measurement 
```{r}
AB <- data_long %>%
  mutate(BELOW = ifelse(Position == "BELOW", Value, NA)) %>% 
  mutate(ABOVE = ifelse(Position == "ABOVE", Value, NA)) %>% 
  mutate(Time = hms::as.hms(Time)) %>%
  mutate(TimeB = hms::as.hms(ifelse(!is.na(BELOW), Time, NA))) %>% 
  mutate(TimeA = hms::as.hms(ifelse(!is.na(ABOVE), Time, NA)))

AB1 <- AB %>% filter(Date == unique(AB$Date)[1])

AB2 <- AB %>% filter(Date == unique(AB$Date)[2])

AB <- list(AB1, AB2)

# Take the closest Above time of Below time
for(i in 1:length(AB)){
  for(n in seq(1:nrow(AB[[i]][!is.na(AB[[i]]$BELOW),]))){
    AB[[i]]$TimeA[n] <- 
      AB[[i]]$TimeA[which.min(abs(
        AB[[i]]$TimeA - AB[[i]]$TimeB[n]))
      ]
  }
}

AB <- bind_rows(AB)


# Above data
Above <- na.omit(select(AB, c(Date, TimeA, Ring, ABOVE))) %>% 
  unique()

AB <- AB %>% 
  left_join(Above, by = c("Date", "TimeA", "Ring")) %>% 
  mutate(ABOVE = coalesce(ABOVE.x, ABOVE.y)) %>%  # pour combiner les valeurs de .x et .y %>% 
  select(-(contains(".x") | contains(".y"))) %>%
  filter(!is.na(BELOW)) 
```

## Correct data with calibration data (A FAIRE)
BELOW = (ABOVE-1) * Calibration_factors (ABOVE = the reference)
so BELOW_cor = (BELOW / Calibration_factors)
```{r, a placer bon au bon endroit}
Calibration_factors <- read_csv("~/PhD/Light/LAI-2200/DATA/Calibration_factors.csv")
Calibration_factors

# Correct measurements
data_correct <- AB %>% 
  mutate(BELOW = ifelse(Ring == "Ring1",
                        (BELOW / Calibration_factors$Ring1_cor),
                        BELOW)) %>% 
  mutate(BELOW = ifelse(Ring == "Ring2",
                        (BELOW / Calibration_factors$Ring2_cor),
                        BELOW)) %>% 
  mutate(BELOW = ifelse(Ring == "Ring3",
                        (BELOW / Calibration_factors$Ring3_cor),
                        BELOW)) %>% 
  mutate(BELOW = ifelse(Ring == "Ring4",
                        (BELOW / Calibration_factors$Ring4_cor),
                        BELOW)) %>% 
  mutate(BELOW = ifelse(Ring == "Ring5",
                        (BELOW / Calibration_factors$Ring5_cor),
                        BELOW))

```

## Check if transmittance change over time
Transmittance = Below/Above for each angle (doit être <= 1)
```{r}
# Compute Transmittance
Transmittance_data <- data_correct %>% 
  mutate(Transmittance = BELOW/ABOVE)
```

## Compute correlations between transmittance of different iterations
```{r}
ggplot(Transmittance_data, aes(x = Time, y = Transmittance, col = File_Id)) + 
  geom_point() +
  facet_grid(vars(Ring), scales = "free")

ggplot(Transmittance_data, aes(x = Id, y = Transmittance, col = File_Id)) + 
  geom_point() +
  facet_grid(vars(Ring), scales = "free")

# Check that all the Transmittance are < 1
all(Transmittance_data$Transmittance < 1)

# Check correlation between Transmittance of each location (Id), for each Ring, between iteration (File_Id)
Transmittance_cor1 <- Transmittance_data %>% 
  select(File_Id, Id, Ring, Transmittance) %>% 
  pivot_wider(names_from = File_Id,
              values_from = "Transmittance",
              names_glue = "{.value}_{File_Id}")

Transmittance_cor <- Transmittance_cor1 %>% 
  select(-Ring)

# P16HOBO
By <- by(Transmittance_cor[2:5], Transmittance_cor[-(2:5)], cor)

# Write Transmittances correlation in text file
sink("D:/Mes Donnees/PhD/Light/LAI-2200/DATA/Transmittance_cor.txt") # path
By
sink() # close the external connection

```
## Plot regression between transmittance of different iterations
```{r}
ggplot(Transmittance_cor1, aes(x = Transmittance_P16HOBO1, y = Transmittance_P16HOBO2))+
  geom_point()+
  stat_smooth(method = "lm", formula = y ~ x) +
  facet_grid(vars(Ring), scales = "free")

ring <- "Ring1"
Transmittance_data %>% 
  filter(Ring == ring) %>% 
  ggplot(aes(x = Transmittance_P16LAY1, y = Transmittance_P16LAY2)) +
  geom_point() +
  stat_smooth(method = "lm", formula = y ~ x)

reg <- Transmittance_data %>% 
  filter(Ring == ring)
summary(lm(reg$Transmittance_P16HOBO1 ~ reg$Transmittance_P16HOBO2))

```
```{r}
# Transmittance ~ location + Ring + iter

Transmittance_data <- Transmittance_data %>% 
  mutate(Id = as.factor(Id)) %>% 
  mutate(Ring = as.factor(Ring)) %>% 
  mutate(File_Id = as.factor(File_Id))

M1 <- lm(Transmittance ~ Id, data=Transmittance_data)
M1 <- lm(Transmittance ~ Ring, data=Transmittance_data)
M1 <- lm(Transmittance ~ File_Id, data=Transmittance_data)

M2 <- lm(Transmittance ~ Id + Ring, data=Transmittance_data)
M3 <- lm(Transmittance ~ Id + Ring + File_Id, data=Transmittance_data)

aov(lm(Transmittance ~ Id, data=Transmittance_data[Transmittance_data$Ring=="Ring1",]))
# erreur de 3%

mean(Transmittance_data$Transmittance)

# agrégéer (mean) à plutot 2 catégories : sous-bois et trouée, ou catégorie par transmittance

hist(Transmittance_data$Transmittance[which(Transmittance_data$Ring=="Ring1")], breaks=50)


```

