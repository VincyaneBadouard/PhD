---
title: "HOBO data script"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE, echo = FALSE, fig.width = 6
)
```

**Métriques climatiques** (a traiter) :
https://www.worldclim.org/data/bioclim.html . Ce sont vraiment les métriques annuelles les plus utilisées.

Il y a ce package qui semble faire du calcul sur le même type de sensor pour calculer des variables journalières puis mensuelles : https://github.com/GregGuerin/microclimate .

Aussi en regardant rapidement, je viens de voir que Eva a sortie un papier sur le sujet dans MEE : https://www.researchgate.net/publication/366841092_Slope_and_equilibrium_A_parsimonious_and_flexible_approach_to_model_microclimate .

**les données très fortes de lumière = sunflex étude sunflecks**

HOBO : variabilité intra-annuelle entre envir lumineux (corriger mon horloge), effet de la saison sur la lumière ? qui varie en fct de l’ouverture de canopée

Objectives:

\- open the HOBO data

\- create a script to open HOBO data in several folders

\- prepare HOBO data for analysis - spatialiser tous les capteurs en x,y
(trilateration) (A FAIRE) - descriptive analysis

Problematics:

\- A quelle échelle la variabilité est la plus forte (saison, mois,
jour, jour/nuit, 15min) ?

\- La température de l'air et la lumière sont-elles liées à l'ouverture
de canopée ? à la topographie ?

Variables à calculer : moyenne, sd, coefficient de variation, min, max :

\- de l'année

\- diurne

\- nocturne

\- saison sèche

\- saison des pluies

# Packages

```{r}
library(readr)
library(tidyverse)
library(stringr)
library(lubridate) # for dates and time
library(chron) # for dates and time
library(corrplot)
library(RColorBrewer)
```

# Read

```{r , include = F}
# Sensor environnment data
HOBO_Paracou_env <- read_csv("~/PhD/Microclimate/HOBO_Tomst_environment/Tomst-HOBO sensors - Paracou - Data.csv")

# Set the categorical variable as a factor with the custom order
HOBO_Paracou_env$TopoHabitat <- factor(HOBO_Paracou_env$TopoHabitat, levels = c("Bottomland", "Lower slope", "Mid slope", "Upper slope", "Plateau"))

env <- HOBO_Paracou_env %>% 
  select(HoboID,Transect,LightHabitat,TopoHabitat)

# Sensor data
# catch the name of all the files of the folder
filenames <- list.files("~/PhD/Microclimate/HOBO/25_05_2023/csv", pattern="*.csv", full.names=TRUE) 

# dans l'ordre du numéro des capteurs
filenames <- gtools::mixedsort(sort(filenames)) 

# read all the files
df_list <- lapply(filenames, read_delim, 
                  delim = ";", escape_double = FALSE,
                  col_types =
                    cols(`#` = col_character(),
                         `Ch: 1 - Température   (°C)` = col_number(), 
                         `Ch: 2 - Lumière   (lux)` = col_number()),
                  locale = locale(decimal_mark = ","), 
                  trim_ws = TRUE) # read all the folder files

# bind all the files
HOBOdata <- bind_rows(df_list, .id = "HoboID") # df number -> HoboID column
```

# Combine data and environment

```{r}
HOBOdata <- HOBOdata %>% 
  mutate(HoboID = as.numeric(HoboID)) %>%
  left_join(HOBO_Paracou_env, by = "HoboID") %>%
  select(-Tomst_Material_info_30_03_23, -Operator)
```

# Rename files

```{r , include = F}
# truc <- sub("D:/Mes Donnees/PhD/Microclimate/HOBO/25_05_2023", "", filenames)
# truc2 <- stringr::str_replace(truc, "(Data French Guiana Standard Time)", "")
# truc3 <- stringr::str_replace(truc2, ".csv", "")
# truc4 <- stringr::str_replace(truc3, " AST ", "")
# truc5 <- gsub("[()]", "", truc4)
# 
# names(df_list) <- truc5
```

# Understand the HOBO file

Les 30 capteurs ont été posés le 30/03/23 et ont commencé à collecter
des données ce même jour à 18h. Ils collectent bien toutes les 15
minutes.

```{r}
# str(df_list) # list of 30 data.frames with 5364 obs and 8 columns each
names(HOBOdata)
cat("Sensors number range:",range(HOBOdata$HoboID)) # 30 sensors
cat("Sensors time range:",range(HOBOdata$`Date et heure (French Guiana Standard Time)`))
# filter à > "30/03/23 18:00:00"
```

# Prepare HOBO data for analysis

Rename variables

```{r}
HOBOdata <- HOBOdata %>% 
  rename(Index = '#') %>%
  rename(Time = 'Date et heure (French Guiana Standard Time)') %>%
  rename(Temp = 'Ch: 1 - Température   (°C)') %>%
  rename(Light = 'Ch: 2 - Lumière   (lux)')
```

## Manage date and hours

```{r}
class(HOBOdata$Time) # the time is in character

HOBOdata <- HOBOdata %>% 
  separate(Time, sep = " ", into = c("Date", "Hour"), remove = F) %>% 
  mutate(Date = as_date(Date, format = "%m/%d/%Y")) %>% 
  mutate(Month = month(Date)) %>%
  mutate(Hour = hms::as_hms(Hour)) %>% 
  mutate(Time = mdy_hms(Time)) %>% # format Date-times: 2023-03-30 18:15:00
  # filtrer sur les dates d'étude (1 an):
  filter(Time >= mdy_hms("03/30/2023 18:00:00") & Time < mdy_hms("03/30/2024 18:00:00")) 


cat("Sensors time range:",range(HOBOdata$Time))
cat("The collect date:",max(HOBOdata$Date)) # "2023-05-25" the collect date
max(HOBOdata$Date) - min(HOBOdata$Date) # 56 days of collect
```

## NA ?

```{r}
Na_tabble <- HOBOdata %>%
  filter(is.na(Light) | is.na(Temp))
# 
# NA1 <- HOBOdata %>% 
#   filter(Date == "2023-04-04")
# 
# # Remove what is between the 15 minutes
# HOBOdata <- HOBOdata %>%
#   filter(minute(HOBOdata$Time) %in% c("0", "15", "30", "45"))
```

# Relation between light and temperature

```{r}
HOBOdata %>% 
  # filter(Light>10) %>% 
  ggplot() +
  aes(x = Light, y = Temp) +
  geom_point(size = 0.2) +
  stat_smooth(method = "lm",
              formula = y ~ x) +
  labs(x ="Light (lux)", y = "Temperature (°C)")

HOBOdata %>% 
  ggplot() +
  aes(x = Light, y = Temp) +
  geom_point(size = 0.2) +
geom_smooth(span = 0.75) +
  labs(x ="Light (lux)", y = "Temperature (°C)")

cat("cor:",cor(HOBOdata$Light, HOBOdata$Temp)) # 0.44
```

# Day/night

See when it's the night.

```{r}
ggplot(HOBOdata, aes(x = Hour,y = Light)) +
  geom_line() +
  labs(title="Light over a day",
       x ="Hour", y = "Light (lux)")

cat("Day: 06:15 - 18:45")

HOBOdata <- HOBOdata %>%
  mutate(Phase = ifelse((Hour <= hms::as_hms("18:45:00") &
                           Hour >= hms::as_hms("06:15:00")),
                        "Day", "Night"))# %>%
# mutate(Phase = ifelse(Light == 0, "Night", "Day"))

ggplot(HOBOdata, aes(x = Hour,y = Light)) +
  geom_point(aes(color = Phase)) +
  labs(title="Light over a day",
       x ="Hour", y = "Light (lux)")

ggplot(HOBOdata[HOBOdata$Phase=="Night",], aes(x = Hour,y = Light)) +
  geom_point() +
  labs(title="Night over a day",
       x ="Hour", y = "Light (lux)")

cat("Maximum light by night:", max(HOBOdata[HOBOdata$Phase == "Night",]$Light)) # 1.7 lux
cat("Minimum light by day:", min(HOBOdata[HOBOdata$Phase == "Day",]$Light)) # 0 lux
```

# Seasons

```{r}
HOBOdata <- HOBOdata %>%
  mutate(Season = ifelse(Month  %in% c(7:11,3), # juill-nov et mars
                         "Dry", "Wet"))

ggplot(HOBOdata, aes(x = as.character(Month),y = Temp)) +
  geom_boxplot(aes(color = Season)) +
  labs(title="Temperature over the seasons",
       x ="Month", y = "Temp (°C)")
```

# Variables à calculer

à l'échelle du capteur :

\- moyenne de l'année

\- moyenne diurne

\- moyenne nocturne

\- moyenne saison sèche

\- moyenne saison des pluies

\- coefficient variation à ces échelles

```{r}
annual_stats <- HOBOdata %>%
  group_by(HoboID) %>%
  summarise(across(c("Temp", "Light"),
                   list(annual_mean = ~mean(.),
                        annual_sd = ~sd(.),
                        annual_varcoef = ~(sd(.) / mean(.)) * 100,
                        annual_max = ~max(.),
                        annual_min = ~min(.)),
                   .names = "{.col}_{.fn}"))

phase_stats <- HOBOdata %>%
  group_by(HoboID,Phase) %>%
  summarise(across(c("Temp", "Light"),
                   list(mean = ~mean(.),
                        sd = ~sd(.),
                        varcoef = ~(sd(.) / mean(.)) * 100,
                        max = ~max(.),
                        min = ~min(.)),
                   .names = "{.col}_{.fn}")) %>% 
  # "Phase" variable as an index for the computed variables
  pivot_wider(names_from = Phase,
              values_from = c("Temp_mean", "Temp_sd", "Temp_varcoef", "Temp_max", "Temp_min","Light_mean", "Light_sd", "Light_varcoef", "Light_max", "Light_min"),
              names_glue = "{.value}_{Phase}")


season_stats <- HOBOdata %>%
  group_by(HoboID,Season) %>%
  summarise(across(c("Temp", "Light"),
                   list(mean = ~mean(.),
                        sd = ~sd(.),
                        varcoef = ~(sd(.) / mean(.)) * 100,
                        max = ~max(.),
                        min = ~min(.)),
                   .names = "{.col}_{.fn}")) %>% 
  
  # "Season" variable as an index for the computed variables
  pivot_wider(names_from = Season,
              values_from = c("Temp_mean", "Temp_sd", "Temp_varcoef", "Temp_max", "Temp_min","Light_mean", "Light_sd", "Light_varcoef", "Light_max", "Light_min"),
              names_glue = "{.value}_{Season}")

```

# Stats dataset

```{r}
stats <- annual_stats %>% 
  left_join(season_stats, by="HoboID") %>%
  left_join(phase_stats, by="HoboID")

stats[is.na(stats)] <- 0
stats <- stats[,colSums(stats)>0] # remove column with only 0 (min light)


stats <- left_join(stats, env, by="HoboID")
```

# Some plots

```{r}
stats %>%
  filter(!is.na(LightHabitat)) %>%
  ggplot() +
  aes(x = LightHabitat, y = Light_annual_mean) +
  geom_boxplot(fill = "#FFAE00") +
  labs(x ="Light Habitat", y = "Average annual light (lux)") +
  theme_minimal()

stats %>%
  filter(!is.na(LightHabitat)) %>%
  ggplot() +
  aes(x = LightHabitat, y = Light_annual_max) +
  geom_boxplot(fill = "#FFAE00") +
  labs(x ="Light Habitat", y = "Maximum annual light (lux)") +
  theme_minimal()

stats %>%
  filter(!is.na(LightHabitat)) %>%
  ggplot() +
  aes(x = LightHabitat, y = Light_mean_Wet) +
  geom_boxplot(fill = "#FFAE00") +
  labs(x ="Light Habitat", y = "Average wet season light (lux)") +
  theme_minimal()

stats %>%
  filter(!is.na(LightHabitat)) %>%
  ggplot() +
  aes(x = LightHabitat, y = Light_max_Day) +
  geom_boxplot(fill = "#FFAE00") +
  labs(x ="Light Habitat", y = "Maximum daily light (lux)") +
  theme_minimal()

cat("Les gaps sont bien les zones les plus lumineuses. Le sous-bois connait des variations de lumière importantes au cours de la journée")


stats %>%
  filter(!is.na(TopoHabitat)) %>%
  ggplot() +
  aes(x = TopoHabitat, y = Temp_annual_mean) +
  geom_boxplot(fill = "#DA2217") +
  labs(x ="Topographic Habitat", y = "Average annual temperature (°C)") +
  theme_minimal()

stats %>%
  filter(!is.na(TopoHabitat)) %>%
  ggplot() +
  aes(x = TopoHabitat, y = Temp_mean_Wet) +
  geom_boxplot(fill = "#DA2217") +
  labs(x ="Topographic Habitat", y = "Average wet season temperature (°C)") +
  theme_minimal()

stats %>%
  filter(!is.na(TopoHabitat)) %>%
  ggplot() +
  aes(x = TopoHabitat, y = Temp_mean_Day) +
  geom_boxplot(fill = "#DA2217") +
  labs(x ="Topographic Habitat", y = "Average daily temperature (°C)") +
  theme_minimal()

cat("La température augmente avec la topographie")
```

# Correlation test

```{r, fig.height = 10}
DF_cor <- stats %>% 
  mutate(TopoHabitat = as.numeric(factor(TopoHabitat, levels = c("Bottomland", "Lower slope", "Mid slope", "Upper slope", "Plateau")))) %>% 
  mutate(LightHabitat = as.numeric(factor(LightHabitat, levels = c("Understory", "Sunfleck", "Gap border", "Gap")))) %>% 
  mutate(Transect = as.numeric(factor(Transect, levels = c("Topo", "Gap")))) %>% 
  na.omit()

CorMatrixS <- Hmisc::rcorr(as.matrix(DF_cor))
CorMatrix <- round(CorMatrixS$r, digits = 2)  # matrice de corrélation
Pval_corr <- CorMatrixS$P # p-values

# Plot de la matrice de corrélation :
# png("D:/Mes Donnees/PhD/Figures/Corplot_pedo_chimie.png", width = 900, height = 800)
corrplot(CorMatrix, method="circle", type="lower",
         col=brewer.pal(n=8, name="PuOr"), tl.col="black", tl.cex = 0.5, tl.srt=45)
# dev.off()
```

Ces métriques de lumière et de température ne semblent pas être
fortement reliées à la topographie. Pourtant les boxplots laissent à
penser que la température augmente du bas-fond vers le plateau.

Les relations à la topographie les plus importantes cor entre 0.25 et
0.5 :

-   Average annual, dry, wet, day temperature

-   Maximum night temperature

-   Minimum day light

Sont lié à l'habitat lumineux : tout sauf les coefficient de variation
et la température maximum nocturne.

# Sensors coordinates (mis de côté, à continuer)

```{r}
# jeux de données test : 

coord_table <- HOBO_Paracou_env %>% 
  select(HoboID, SubPlot,
         TreeNum1, TreeNum2, TreeNum3, # IDs of neighbouring trees
         DTree1, DTree2, DTree3) %>% # distances to neighbouring trees
  na.omit() %>% 
  mutate(TreeNum2 = ifelse(HoboID == "2", "410", TreeNum2)) %>% # just for test
  mutate(TreeNum3 = ifelse(HoboID == "2", "411", TreeNum2))

idTrees <- unique(c(coord_table$TreeNum1, coord_table$TreeNum2, coord_table$TreeNum3))

Paracou16_2020 <- read_csv("~/PhD/Inventories/Data/Adults/Paracou16_2020.csv") %>% 
  filter(TreeFieldNum %in% idTrees) %>% 
  filter(SubPlot %in% unique(coord_table$SubPlot)) %>% 
  select(SubPlot, TreeFieldNum, Xutm, Yutm) %>%  # Xfield, Yfield, 
  distinct()

RefTrees <- Paracou16_2020
Target <- coord_table %>% rename(ID_measure = HoboID) 
# stop("Sensors coordinates: mis de côté, à continuer")

```

## Trilateration

```{r}
source("~/PhD/R_codes/PhD/trilateration_code.R", echo=TRUE)

coord_table <- trilateration(Target, RefTrees)
```

# Save the stats dataset

```{r}
# write.csv(stats, "~/PhD/Microclimate/HOBO/HOBO_stats.csv")
```
