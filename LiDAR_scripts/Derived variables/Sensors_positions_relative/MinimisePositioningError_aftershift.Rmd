---
title: "Minimise sensors positioning error"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: pdf_document
---
On cherche à minimiser l'écart entre les transmittances dérivées du LiDAR et celles de capteurs LAI2200 (données de validation).

1) Générer une grille dans R : res 0.5, max 1m (discret).
) Calculer les transmittances à ces coordonnées dans AMAPVox (xml LAI2200)

Décaller
- capteurs par capteurs pour le transect 10m (à traiter d’abord car plus simple car moins contraints)
- l’ensemble des capteurs pour le transect 1m (partir de la coordonnée géomètre) 
- si incohérent à notre protocole on reverra la méthode

```{r Setup, include = F}
library(tidyverse)
library(sf)
library(terra)
library(data.table)
library(tidyterra)
library(corrplot)
library(RColorBrewer)
```

```{r}
P16shp <- st_as_sf(terra::vect("D:/Mes Donnees/PhD/SIG_data/Understory-ALT/Parcelles_Understory.shp"))
```

# Global shift according to the layon visible on the DEM in Qgis
```{r}
Optimised_coord_globalshift_qgis <- st_as_sf(terra::vect("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Coordinates/Optimised_coord_globalshift_qgis8.shp"))
plot(Optimised_coord_globalshift_qgis)

# from sf to df with original coordinates
XY <- st_coordinates(Optimised_coord_globalshift_qgis) # stock coordinates
st_geometry(Optimised_coord_globalshift_qgis) <- NULL # no more sf object
Optimised_coord_globalshift_qgis <- cbind(Optimised_coord_globalshift_qgis, XY) # bind XY coord

Optimised_coord_globalshift_qgis <- Optimised_coord_globalshift_qgis %>% 
  rename(Xutm_init = Xutm) %>% rename(Yutm_init = Yutm) %>%
  rename(Xutm = X) %>% rename(Yutm = Y) %>% 
  select(-c(x,y, Zutm))

dataUTMsf <- st_as_sf(Optimised_coord_globalshift_qgis, coords = c('Xutm','Yutm'))
dataUTMsf <- st_set_crs(dataUTMsf, terra::crs(P16shp))

ggplot() +
  geom_sf(data = sf::st_cast(P16shp, "LINESTRING")) +
  geom_sf(data = dataUTMsf, col = "red", size = 0.01) +
  ggtitle("Paracou P16 - LAI2200 grid simulation UTM")
```

# Extract Z coord MNT to Points
```{r}
MNT <- terra::rast("//amap-data.cirad.fr/safe/lidar/ALS/Paracou/2023/rasters/PARACOU2023_DTM_1m.tif") # MNT
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/dtm2023_4ha_HighAlt_buffer.asc"

crs(MNT) <- crs(P16shp)

alt <- extract(MNT, dataUTMsf) %>% # extract z
  rename(Zutm = MNT_0.5m_IRD_500m_Paracou_284000_579500) %>% 
  select(-ID) %>% 
  mutate(Zutm = Zutm +1) # 1 m above the ground

dataxyz <- Optimised_coord_globalshift_qgis %>% cbind(alt)
```

# Coordinates in local positions (use VOP)
```{r}
# path <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Grid_4ha_10x10m_each1mZ_UTMxyz.csv"
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LAI2200_theoretical_UTMxyz.csv"

dataxyz <- as.data.table(dataxyz)
# dataxyz <- as.data.table(read.csv(path))
VOP <- as.matrix(read.table("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/VOP_P16_9ha.txt"))

matrix <- as.matrix(dataxyz[, `:=`(c = 0 , d = 1)][,.(Xutm, Yutm, c, d)]) # as matrix of the same dimensions, without Z

datalocal <- matrix %*% t(VOP) # same dimensions

datalocal <- cbind(dataxyz[,.(Transect, Id, Xutm, Yutm, Zutm)], datalocal)[, -c("V3","V4")] # add Zutm

datalocal <-datalocal %>% 
  rename(x = V1) %>% rename(y = V2) %>% select(Transect, Id, x,y, Xutm,Yutm,Zutm)

ggplot() +
  geom_point(data=as.data.frame(datalocal), aes(x = x, y = y), col = "red", size = 0.1) 

```

```{r}
write.csv(datalocal, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Coordinates/LAI2200_coordshift_Qgis_local.csv")
```

# Coordinates optimisation
```{r, include = F}
LAI2200_coord <- as.data.frame(read_csv("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Coordinates/LAI2200_coordshift_Qgis_local.csv")) # LAI2200 sensors coordinates
# names(LAI2200_coord)
# LAI2200_coord <- LAI2200_coord %>% select(Transect, Id, x,y)
nrow(LAI2200_coord) # 46
```

# Generate a grid of 0.5 res and 1m max
```{r}
est <- data.frame(Transect = LAI2200_coord$Transect,
                  Id=LAI2200_coord$Id,
                  outer(LAI2200_coord$Xutm, seq(0, 1, by=0.5), FUN = '+'), # previously 2m max
                  y=LAI2200_coord$Yutm)
ouest <- data.frame(Transect = LAI2200_coord$Transect,
                    Id=LAI2200_coord$Id,
                    outer(LAI2200_coord$Xutm, seq(0, 1, by=0.5), FUN = '-'), # previously 2m max
                    y=LAI2200_coord$Yutm)

x <- rbind(est, ouest) # 46*2 =92

x <- unique(pivot_longer(x,cols=X1:X3, names_to=NULL, values_to="x")) # 46*5 = 230

x <- x %>%
  cbind(data.frame(outer(x$y, seq(0, 1, by=0.5), FUN = '+'))) %>%
  rename_with(.fn = tolower, .cols = X1:X3) %>% 
  cbind(data.frame(outer(x$y, seq(0, 1, by=0.5), FUN = '-')))

x <- pivot_longer(x,cols=x1:X3, names_to=NULL, values_to="Y") %>%
  select(-y) %>% rename(y=Y) %>% unique() # 25 par id -> 46*25 = 1150

data <- x %>% 
  rename(Xutm = x) %>% rename(Yutm = y) %>% unique()
```

```{r}
ggplot() +
  geom_point(data=data, aes(x = Xutm, y = Yutm), color = "red",  size = 0.1)+
  geom_point(data=LAI2200_coord, aes(x = Xutm, y = Yutm), color = "black",  size = 0.1)+
  coord_fixed(ratio=1)
```

```{r}
P16shp <- st_as_sf(terra::vect("D:/Mes Donnees/PhD/SIG_data/Understory-ALT/Parcelles_Understory.shp"))
dataUTMsf <- st_as_sf(data, coords = c('Xutm','Yutm'))
dataUTMsf <- st_set_crs(dataUTMsf, terra::crs(P16shp))

ggplot() +
  geom_sf(data = sf::st_cast(P16shp, "LINESTRING")) +
  geom_sf(data = dataUTMsf, col = "red", size = 0.01) +
  ggtitle("Paracou P16 - LAI2200 grid simulation UTM")

# ggsave("Paracou_P16_LAI2200_grid_simulation_UTM_positions.png",
#          path = "D:/Mes Donnees/PhD/Figures/Sensors",
#          width = 15, height = 15, units = "cm", dpi=800, bg="white")
```

# Extract Z coord MNT to Points
```{r}
MNT <- terra::rast("//amap-data.cirad.fr/safe/lidar/ALS/Paracou/2023/rasters/PARACOU2023_DTM_1m.tif") # MNT
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/dtm2023_4ha_HighAlt_buffer.asc"

crs(MNT) <- crs(P16shp)

alt <- extract(MNT, dataUTMsf) %>% # extract z
  rename(Zutm = MNT_0.5m_IRD_500m_Paracou_284000_579500) %>% 
  select(-ID) %>% 
  mutate(Zutm = Zutm +1) # 1 m above the ground

dataxyz <- data %>% cbind(alt)
```

```{r}
write.csv(dataxyz, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Coordinates/LAI2200_gridsimulation_aftershift_UTMxyz.csv")
```

# Coordinates in local positions (use VOP)
```{r}
# path <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Grid_4ha_10x10m_each1mZ_UTMxyz.csv"
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LAI2200_theoretical_UTMxyz.csv"

dataxyz <- as.data.table(dataxyz)
# dataxyz <- as.data.table(read.csv(path))
VOP <- as.matrix(read.table("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/VOP_P16_9ha.txt"))

matrix <- as.matrix(dataxyz[, `:=`(c = 0 , d = 1)][,.(Xutm, Yutm, c, d)]) # as matrix of the same dimensions, without Z

datalocal <- matrix %*% t(VOP) # same dimensions

datalocal <- cbind(datalocal,dataxyz[,Zutm])[, -c(3,4)] # add Zutm

ggplot() +
  geom_point(data=as.data.frame(datalocal), aes(x = V1, y = V2), col = "red", size = 0.1) 

```

```{r}
write.csv(datalocal, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Coordinates/LAI2200_gridsimulation_aftershift_local.csv")
```

# AMAPVox
```{r}
# xmlfile <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/Intensity_1m/XML/Light/P16_2023_4ha_buffer_LowAlt_LAI2200_coordsimulations_intensity1m.xml"
# 
AMAPVox::run(jvm.option = "-Xms16g") # pour allouer 16Go de RAM 
# AMAPVox::run(xml = xmlfile, jvm.option = "-Xms16g") # pour allouer 16Go de RAM # 

```

# After AMAPVox
```{r}
Read_LAI2200_Transfile <- function(path){
  data <- read_table(path) %>% 
    # mutate(LiDAR = "HighAlt") %>% 
    rename(Transmittance = transmittance) %>% 
    select(-c(position.ID, pathLength, isOut, elevation, cross_NA))
}
```

```{r}
# LiDAR <- unique(Read_LAI2200_Transfile("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/Intensity_1m/P16_2023_LowAlt_4ha_buffer_LAI2200sim_coordshiftQgis_intensity1m_test.txt")) %>% mutate(Transmittance = as.numeric(Transmittance))

LiDAR <- unique(Read_LAI2200_Transfile("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/Intensity_1m/P16_2023_LowAlt_4ha_buffer_LAI2200sim_coordsimulations_aftershift_intensity1m_test.txt")) %>% mutate(Transmittance = as.numeric(Transmittance))
```

```{r}
unique(setDT(LiDAR)[Transmittance==0, .(position.x, position.y, position.z, ring)])
```

```{r}
LiDAR <- LiDAR %>% 
  group_by(`position.x`, `position.y`, `position.z`, ring) %>%
  mutate(MeanTransmittance_LowInt1m = mean(Transmittance)) %>%
  mutate(SdTransmittance_LowInt1m = sd(Transmittance)) %>%
  mutate(SeTransmittance_LowInt1m = plotrix::std.error(Transmittance)) %>%
  ungroup() %>%
  select(-c(Transmittance, azimut)) %>%
  unique() 

```

## Local to UTM coord
```{r}
# Lecture matrice de transformation
VOP <- as.matrix(read.table("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/VOP_P16_9ha.txt"))

# Apply inverse of VOP matrix to convert back to UTM
LiDAR <- setDT(LiDAR)
xyz <- tcrossprod(as.matrix(LiDAR[, .(`position.x`, `position.y`, `position.z`, c=1)]), solve(VOP))
LiDAR[, `:=`(Xutm = xyz[, 1], Yutm = xyz[, 2], Zutm = xyz[, 3])]
LiDAR <- setDF(LiDAR) %>% rename(Ring = ring) # %>%
# mutate(Xutm = round(Xutm),
#        Yutm = round(Yutm),
#        Zutm = round(Zutm))
rm(VOP,xyz)
```

# Add transect and Id info in LiDAR data
```{r}
grid <- read.csv("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Coordinates/LAI2200_gridsimulation_aftershift_UTMxyz.csv") %>% 
  select(Xutm,Yutm,Zutm, Transect, Id) %>% 
  mutate(Xutm = round(as.numeric(Xutm), digits = 3)) %>%
  mutate(Yutm = round(as.numeric(Yutm), digits = 3)) %>%
  mutate(Zutm = round(as.numeric(Zutm), digits = 3)) %>%
  unique()


LiDAR <- LiDAR %>% 
  mutate(Xutm = round(as.numeric(Xutm), digits = 3)) %>%
  mutate(Yutm = round(as.numeric(Yutm), digits = 3)) %>%
  mutate(Zutm = round(as.numeric(Zutm), digits = 3)) %>%
  left_join(grid, by= c("Xutm","Yutm","Zutm")) 
```

## Load LAI2200 data
```{r, include = F}
LAI2200_coord <- read_csv("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Coordinates/LAI2200_coordshift_Qgis_local.csv") # LAI2200 sensors coordinates
LAI2200_data <- read_csv("D:/Mes Donnees/PhD/Microclimate/Light/LAI-2200/LAI2200_data.csv") # LAI2200 sensors data

# names(LAI2200_coord) # "Transect", "Id", "Xutm","Yutm","Zutm"
# names(LAI2200_data) # "Id", "Transect", "Ring", "MeanTransmittance_LAI2200" (MeanTransmittance_LAI2200 for each sensor and for each ring)

LAI2200_data <- LAI2200_data %>% 
  select(Transect, Id, Ring, MeanTransmittance_LAI2200, SdTransmittance_LAI2200, SeTransmittance_LAI2200) %>% unique()

LAI2200_data <- LAI2200_data %>% 
  # select(Transect, Id, Xutm, Yutm, Zutm) %>% 
  # left_join(LAI2200_data, by= c("Transect", "Id")) %>% 
  mutate(Ring = case_when(
    Ring == "Ring1" ~ 1,
    Ring == "Ring2" ~ 2,
    Ring == "Ring3" ~ 3,
    Ring == "Ring4" ~ 4,
    Ring == "Ring5" ~ 5)) %>% 
  # mutate(Xutm = round(as.numeric(Xutm), digits = 3)) %>% 
  # mutate(Yutm = round(as.numeric(Yutm), digits = 3)) %>% 
  # mutate(Zutm = round(as.numeric(Zutm), digits = 3)) %>% # LAI2200_LiDAR
  # Correction des rings 4 et 5 d'après la transmittance estimée de la DZ au LiDAR
  mutate(MeanTransmittance_LAI2200 = ifelse(Ring==4, MeanTransmittance_LAI2200 * 0.96,
                                            MeanTransmittance_LAI2200)) %>% 
  mutate(MeanTransmittance_LAI2200 = ifelse(Ring==5, MeanTransmittance_LAI2200 * 0.23,
                                            MeanTransmittance_LAI2200)) 

LAI2200 <- LAI2200_coord %>% 
  select(Transect, Id, Xutm, Yutm, Zutm) %>%
  left_join(LAI2200_data, by= c("Transect", "Id")) %>% 
  mutate(Xutm = round(Xutm, digits = 3), 
         Yutm = round(Yutm, digits = 3),
         Zutm = round(Zutm, digits = 3)) %>% 
  filter(!(Transect=="HOBO" & Id==10))

HOBO10 <- LAI2200 %>% filter(Transect=="LAY" & Id==6) %>% 
  mutate(Transect = "HOBO") %>% mutate(Id= 10) 

LAI2200 <- rbind(LAI2200, HOBO10) 

nrow(unique(LAI2200 %>% select(Xutm,Yutm,Zutm))) # 45 <- 20+26 LAI2200 dont un en commun

rm(LAI2200_coord)
```

```{r}
LAI2200 <- LAI2200 %>%
  select(Transect,Id, Xutm,Yutm, Zutm, Ring, MeanTransmittance_LAI2200, SdTransmittance_LAI2200, SeTransmittance_LAI2200) %>% 
  unique()
```

## Combine LiDAR and LAI2200 data
```{r}
LiDAR <- LiDAR %>%
  filter(!(Transect=="HOBO" & Id==10))

HOBO10 <- LiDAR %>% filter(Transect=="LAY" & Id==6) %>% 
  mutate(Transect = "HOBO") %>% mutate(Id= 10)

LiDAR <- rbind(LiDAR, HOBO10) 



LAI2200_LiDAR <- LiDAR %>% 
  left_join(LAI2200, by= c("Transect", "Id", "Ring"), suffix = c(".sim", ".init"))
# .init : theorical shifted coordinates used in the study
# .sim : the simulated coordinates to study the spatialisation error of the sensors

# NA_table <- LAI2200_LiDAR[rowSums(is.na(LAI2200_LiDAR[, c(25, 34:36)])) > 0,] # NA ?
```

# Compute differences
```{r}
# names(LAI2200_LiDAR)
LAI2200_LiDAR <- LAI2200_LiDAR %>% 
  select(-c(position.x, position.y, position.z)) %>%
  unique() %>% 
  # compute differences (4-3=1, le rslt informe sur la valeur à laquelle on soustrait)
  mutate(Transmittance_LowInt1mvsLAI2200 = MeanTransmittance_LowInt1m - MeanTransmittance_LAI2200) 
```

```{r}
range(LAI2200_LiDAR$Transmittance_LowInt1mvsLAI2200) 
#2m res: grid: -0.6222959  0.3474904 ; shift: -0.4079501  0.1057501 ; shift+grid : -0.4521806  0.3234892
# 1m res : shift+grid : -0.4546291  0.5623316
```
# Difference plots
```{r}
P16shp <- st_as_sf(terra::vect("D:/Mes Donnees/PhD/SIG_data/Understory-ALT/Parcelles_Understory.shp"))

LAI2200_LiDAR1 <- LAI2200_LiDAR %>% filter(Ring==1)

LAI2200_LiDARsf <- st_as_sf(LAI2200_LiDAR1, coords = c('Xutm.sim','Yutm.sim'))
LAI2200_LiDARsf <- st_set_crs(LAI2200_LiDARsf, crs(P16shp))

# LAI2200_LiDARsf <- LAI2200_LiDARsf %>% filter(Ring==1)

ggplot() +
  # geom_sf(data = sf::st_cast(P16shp, "LINESTRING")) + # zone of interest
  geom_sf(data = LAI2200_LiDARsf, aes(color = Transmittance_LowInt1mvsLAI2200), size = 1) + 
  scale_color_gradient2(name = "Transmittance LowInt1m vs LAI2200",
                        low="blue", high="red", mid = "white", midpoint = 0) +
  theme(title=element_text(size=16),  axis.text=element_text(size=14),
        legend.title=element_text(size=16), legend.text=element_text(size=16)) +
  ggtitle("Paracou P16 4ha - Transmittances differences - simulations")

ggsave("P16_2023_4ha_Transmittances_LowInt1m_diff_simulations.png",
       path = "D:/Mes Donnees/PhD/Figures/lidar/Coordinates_simulations",
       width = 30, height = 35, units = "cm", dpi=800, bg="white")
```

```{r}
LAI2200_LiDARsf %>% 
  filter(Transect=="LAY" & Id ==6) %>% 
  ggplot() +
  # geom_sf(data = sf::st_cast(P16shp, "LINESTRING")) + # zone of interest
  geom_sf(aes(color = Transmittance_LowInt1mvsLAI2200), size = 3) + 
  scale_color_gradient2(name = "Transmittance LowInt1m vs LAI2200",
                        low="blue", high="red", mid = "white", midpoint = 0) +
  theme(title=element_text(size=16),  axis.text=element_text(size=14),
        legend.title=element_text(size=16), legend.text=element_text(size=16)) +
  ggtitle("Paracou P16 4ha - Transmittances differences - simulations - LAY6")

# ggsave("P16_2023_4ha_Transmittances_LowInt1m_diff_simulations_LAY6.png",
#        path = "D:/Mes Donnees/PhD/Figures/lidar/Coordinates_simulations",
#        width = 30, height = 35, units = "cm", dpi=800, bg="white")
```

# Select the coordinates with the minimum difference
```{r}
Betters <- LAI2200_LiDAR %>%
  filter(Ring==1 | Ring==2) %>% 
  group_by(Transect, Id, Xutm.sim, Yutm.sim) %>% 
  mutate(TransDiffR12 = sum(Transmittance_LowInt1mvsLAI2200)) %>% 
  ungroup() %>% 
  group_by(Transect, Id, Ring) %>% 
  slice(which.min(abs(TransDiffR12))) %>% 
  ungroup()
```

```{r}
range(Betters[Betters$Ring==1,]$Transmittance_LowInt1mvsLAI2200)
# res 2m :
# grid :
# -0.6222959  0.3474904 -> -0.249562979  0.005005201 (filtre que Ring1)
# filtre ring 1 et 2 : -0.24956298  0.06700863
# Shift + grid : -0.14298754  0.07133755

# res 1m :
# Shift + grid : -0.06978786  0.03806944
```

# Difference plots
```{r}
Betters_sf <- st_as_sf(Betters, coords = c('Xutm.sim','Yutm.sim'))
Betters_sf <- st_set_crs(Betters_sf, crs(P16shp))

for(R in c(1,2)){
  print(Betters_sf %>% 
          filter(Ring==R) %>% 
          ggplot() +
          # geom_sf(data = sf::st_cast(P16shp, "LINESTRING")) + # zone of interest
          geom_sf(aes(color = Transmittance_LowInt1mvsLAI2200), size = 3) + 
          scale_color_gradient2(name = "Transmittance LiDAR vs LAI2200",
                                low="blue", high="red", mid = "white", midpoint = 0) +
          # theme_dark() +
          theme(title=element_text(size=16),  axis.text=element_text(size=6),
                legend.title=element_text(size=16), legend.text=element_text(size=16)) +
          ggtitle(paste("Mimimum transmittances differences - Ring",R, sep=""))
  )
  
  ggsave(paste("P16_2023_4ha_Mimimum_transmittances_LowInt1m_diff_simulations_optR12_Ring",R,".png", sep=""),
         path = "D:/Mes Donnees/PhD/Figures/lidar/Coordinates_simulations",
         width = 20, height = 20, units = "cm", dpi=800, bg="white")
}
```

```{r}
UTM <- Betters %>% 
  select(Transect, Id, Xutm.sim, Yutm.sim, Zutm.sim) %>% unique()
```

```{r}
write.csv(UTM, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Coordinates/LAI2200_bettercoord_aftershift_UTMxyz.csv")
```

# Difference between initial and best coordinates
```{r}
LAI2200_LiDAR <- LAI2200_LiDAR %>% 
  filter(Ring ==1 | Ring ==2) %>% 
  left_join(UTM, by=c("Transect", "Id"), suffix = c("_all", "_best")) %>%
  mutate(Xtest = Xutm.init - Xutm.sim_all) %>% mutate(Ytest = Yutm.init - Yutm.sim_all) %>% 
  mutate(Xerror = Xutm.init - Xutm.sim_best) %>% mutate(Yerror = Yutm.init - Yutm.sim_best)  # écart entre la coord initiale et l'optimisée

range(LAI2200_LiDAR$Xtest) # -2.5  2.5 ; aftershift : -1  1 ; Res1m: -1 1
range(LAI2200_LiDAR$Ytest)  # -2.5  2.5 ; aftershift : -1  1 ; Res1m: -1  1.031

range(LAI2200_LiDAR$Xerror) # -2.5  2.5 ; aftershift : -1  1 ; Res1m: -1  1
median(LAI2200_LiDAR$Xerror) # -0.6 ; aftershift : -0.5 ; Res1m: -0.5
hist(LAI2200_LiDAR$Xerror)
range(LAI2200_LiDAR$Yerror) # -2.2  2.4 ; aftershift : -1  1 ; Res1m: -1  1
median(LAI2200_LiDAR$Yerror) # 0.8 ; aftershift : -0.5 ; Res1m: 0
hist(LAI2200_LiDAR$Yerror)

```

# Difference between initial and best transmittance
```{r}
init <- unique(LAI2200_LiDAR[which
                             (LAI2200_LiDAR$Xutm.sim_all == LAI2200_LiDAR$Xutm.init &
                                 LAI2200_LiDAR$Yutm.sim_all == LAI2200_LiDAR$Yutm.init), c("Transect", "Id", "Ring", "Xutm.sim_all","Yutm.sim_all","MeanTransmittance_LowInt1m", "SeTransmittance_LowInt1m")]) %>% mutate(choice = "init")

best <- unique(LAI2200_LiDAR[which
                             (LAI2200_LiDAR$Xutm.sim_all == LAI2200_LiDAR$Xutm.sim_best &
                                 LAI2200_LiDAR$Yutm.sim_all == LAI2200_LiDAR$Yutm.sim_best), c("Transect", "Id", "Ring", "Xutm.sim_all","Yutm.sim_all", "MeanTransmittance_LowInt1m", "SeTransmittance_LowInt1m")]) %>% mutate(choice = "best")

comp <- init %>% left_join(best, by=c("Transect", "Id", "Ring"), suffix = c("_init", "_best"))

range(comp$MeanTransmittance_LowInt1m_init - comp$MeanTransmittance_LowInt1m_best) # -0.26753640  0.06314267; aftershift : -0.24461143  0.06133353. Res 1m : -0.07772691  0.05452369
median(comp$MeanTransmittance_LowInt1m_init - comp$MeanTransmittance_LowInt1m_best) #  -0.0002733797; aftershift : -7.201415e-06. Res 1m : -0.0009259017
mean(comp$MeanTransmittance_LowInt1m_init - comp$MeanTransmittance_LowInt1m_best) #  -0.009024111; aftershift : -0.002866147. Res 1m : -0.0007919723
quantile(comp$MeanTransmittance_LowInt1m_init - comp$MeanTransmittance_LowInt1m_best, .95) # 0.007983491; aftershift : 0.006590541. Res 1m : 0.03518973
quantile(comp$MeanTransmittance_LowInt1m_init - comp$MeanTransmittance_LowInt1m_best, .05) # -0.0634546; aftershift : -0.01607339. Res 1m : -0.02763386 

```

```{r}
init_sf <- st_as_sf(init, coords = c('Xutm.sim_all','Yutm.sim_all'))
init_sf <- st_set_crs(init_sf, st_crs(P16shp))
best_sf <- st_as_sf(best, coords = c('Xutm.sim_all','Yutm.sim_all'))
best_sf <- st_set_crs(best_sf, st_crs(P16shp))



ggplot() +
  # geom_sf(data = sf::st_cast(P16shp, "LINESTRING")) + # zone of interest
  geom_sf(data= init_sf, aes(col = "red"), size = 3) + 
  geom_sf(data= best_sf, aes(col = "green"), size = 3) + 
  theme(title=element_text(size=16),  axis.text=element_text(size=6),
        legend.title=element_text(size=16), legend.text=element_text(size=16)) +
  ggtitle("Initial and optimised coordinates")

ggsave(paste("P16_2023_4ha_Init_and_optimisedcoordinates_simulations_optR12_Ring",R,".png", sep=""),
       path = "D:/Mes Donnees/PhD/Figures/lidar/Coordinates_simulations",
       width = 20, height = 20, units = "cm", dpi=800, bg="white")
```

```{r}
LAI2200_LiDAR <- LAI2200_LiDAR %>% 
  left_join(comp, by=c("Transect", "Id", "Ring"))
```

```{r}
# Best
LAI2200_LiDAR %>% 
  st_as_sf(coords = c('Xutm.sim_best','Yutm.sim_best')) %>% 
  st_set_crs(crs(P16shp)) %>% 
  filter(Ring==1) %>% 
  ggplot() +
  # geom_sf(data = sf::st_cast(P16shp, "LINESTRING")) + # zone of interest
  geom_sf(aes(color = Transmittance_LowInt1mvsLAI2200), size = 3) + 
  scale_color_gradient2(name = "Transmittance LowInt1m vs LAI2200",
                        low="blue", high="red", mid = "white", midpoint = 0) +
  theme(title=element_text(size=16),  axis.text=element_text(size=14),
        legend.title=element_text(size=16), legend.text=element_text(size=16)) +
  ggtitle("Paracou P16 4ha - Mimimum transmittances differences - simulations - Ring 1")

# ggsave("P16_2023_4ha_Mimimum_transmittances_LowInt1m_diff_simulations_Ring1.png",
#        path = "D:/Mes Donnees/PhD/Figures/lidar/Coordinates_simulations",
#        width = 30, height = 35, units = "cm", dpi=800, bg="white")
```

# Coordinates in local positions (use VOP)
```{r}
# path <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Grid_4ha_10x10m_each1mZ_UTMxyz.csv"
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LAI2200_theoretical_UTMxyz.csv"

UTM <- as.data.table(UTM)
# UTM <- as.data.table(read.csv(path))
VOP <- as.matrix(read.table("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/VOP_P16_9ha.txt"))

matrix <- as.matrix(UTM[, `:=`(c = 0 , d = 1)][,.(Xutm.sim, Yutm.sim, c, d)]) # as matrix of the same dimensions, without Z

datalocal <- matrix %*% t(VOP) # same dimensions

datalocal <- cbind(datalocal,UTM[,Zutm.sim])[, -c(3,4)] # add Zutm

ggplot() +
  geom_point(data=as.data.frame(datalocal), aes(x = V1, y = V2), col = "red", size = 0.1) 

```

```{r}
write.csv(datalocal, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Coordinates/LAI2200_bettercoord_aftershift_local.csv")
```

# Profils en long avec optimisation pour comparer
```{r}

# for(t in c("HOBO", "LAY")){
#   for(R in 1:2){

idmax = max(LAI2200_LiDAR[LAI2200_LiDAR$Transect==t,]$Id) # last sensor Id

print(
  LAI2200_LiDAR %>% 
    mutate(Transect = factor(Transect, levels = c("LAY", "HOBO"))) %>% 
    select(Transect, Id, Ring,
           MeanTransmittance_LAI2200, SeTransmittance_LAI2200,
           MeanTransmittance_LowInt1m_init, MeanTransmittance_LowInt1m_best,
           SeTransmittance_LowInt1m_init, SeTransmittance_LowInt1m_best) %>% unique() %>%
    # filter(Transect==t) %>% # LAY # HOBO
    # filter(Ring==R) %>%
    ggplot(aes(x = Id)) +
    
    # LAI2200
    geom_point(aes(y = MeanTransmittance_LAI2200, colour = "LAI2200")) +
    geom_line(aes(y = MeanTransmittance_LAI2200, colour = "LAI2200"), linewidth = 1.2) +
    geom_errorbar(aes(ymin=MeanTransmittance_LAI2200-SeTransmittance_LAI2200,
                      ymax=MeanTransmittance_LAI2200+SeTransmittance_LAI2200, colour = "LAI2200"), width=.2, alpha=.4) +
    
    # LiDAR
    geom_point(aes(y = MeanTransmittance_LowInt1m_init, colour = "Low altitude - initial coordinates")) +
    geom_line(aes(y = MeanTransmittance_LowInt1m_init, colour = "Low altitude - initial coordinates")) +
    geom_errorbar(aes(ymin=MeanTransmittance_LowInt1m_init-SeTransmittance_LowInt1m_init,
                      ymax=MeanTransmittance_LowInt1m_init+SeTransmittance_LowInt1m_init, colour = "Low altitude - initial coordinates"), width=.2, alpha=.4) +
    
    # geom_point(aes(y = MeanTransmittance_LowInt1m, colour = "Low altitude - shifted coordinates")) +
    # geom_line(aes(y = MeanTransmittance_LowInt1m, colour = "Low altitude - shifted coordinates")) +
    # geom_errorbar(aes(ymin=MeanTransmittance_LowInt1m-SeTransmittance_LowInt1m,
    #                   ymax=MeanTransmittance_LowInt1m+SeTransmittance_LowInt1m, colour = "Low altitude - shifted coordinates"), width=.2, alpha=.4) +
    
    geom_point(aes(y = MeanTransmittance_LowInt1m_best, colour = "Low altitude - optimised coordinates")) +
    geom_line(aes(y = MeanTransmittance_LowInt1m_best, colour = "Low altitude - optimised coordinates")) +
    geom_errorbar(aes(ymin=MeanTransmittance_LowInt1m_best-SeTransmittance_LowInt1m_best,
                      ymax=MeanTransmittance_LowInt1m_best+SeTransmittance_LowInt1m_best, colour = "Low altitude - optimised coordinates"), width=.2, alpha=.4) +
    
    scale_colour_manual(values = c("Low altitude - optimised coordinates" = "#009E73",
                                   # "Low altitude - shifted coordinates" = "#009E73",
                                   "Low altitude - initial coordinates" = "#56B4E9",
                                   "LAI2200" = "#D55E00"),
                        breaks=c("LAI2200",
                                 # "Low altitude - shifted coordinates"
                                 "Low altitude - optimised coordinates",
                                 "Low altitude - initial coordinates"
                        )) +
    
    # labs(title = paste(t," transect - Ring ",R), y="Mean transmittance", x="Sensor ID", color = "Acquisition") +
    labs(y="Mean transmittance", x="Sensor ID") +
    # scale_x_continuous(breaks = seq(1:idmax)) + # 26 # 20
    # theme(title= element_text(size=18), axis.title= element_text(size=18), axis.text= element_text(size=18), legend.title= element_text(size=18), legend.text= element_text(size=18)) +
    theme_minimal() +
    facet_wrap(~ Transect + Ring, scales = "free",
               labeller = labeller(Ring = c('1'='Ring 1', '2'='Ring 2'))) +
    ggh4x::facetted_pos_scales(
      x = list(
        Transect == "LAY" ~ scale_x_continuous(breaks = seq(1:26)),
        Transect == "HOBO" ~ scale_x_continuous(breaks = seq(1:20))
      )
    ) +
    theme(legend.position="bottom",legend.title= element_blank(), strip.text = element_text(size=15), axis.title= element_text(size=15), axis.text= element_text(size=15), legend.text= element_text(size=15))
)

ggsave("P16_2023_4ha_Long_profile_facet_LowAlt_Intensity1m_optimised_aftershift.png",
       path = "D:/Mes Donnees/PhD/Figures/lidar/Correlations/Coord_optimised",
       width = 40, height = 30, units = "cm", dpi=800, bg="white")

# ggsave(paste("P16_2023_4ha_Long_profile_",t,"_transect_Ring",R,"_se_LowAlt_Intensity1m_optimised_aftershift.png", sep=""),
#        path = "D:/Mes Donnees/PhD/Figures/lidar/Correlations/Coord_optimised",
#        width = 25, height = 20, units = "cm", dpi=800, bg="white")
#   }
# }

```


# Profils en long (moyennes des Transmittances par acquisition, par ring)
```{r}
vars <- c(
  # "MeanTransmittance_LowInt1m",
  "MeanTransmittance_LowInt1m_init", "MeanTransmittance_LowInt1m_best",
  "MeanTransmittance_LAI2200")

LAI2200_LiDAR_ring <- LAI2200_LiDAR %>%
  group_by(Ring) %>% # variables selon lesquelles grouper
  summarise(across(c(all_of(vars)), # Variables à analyser
                   list(mean = ~mean(.), # les stats
                        sd = ~sd(.),
                        se = ~plotrix::std.error(.)),
                   .names = "{.col}_{.fn}"))

LAI2200_LiDAR_ring %>% 
  ggplot(aes(x = Ring)) +
  
  geom_errorbar(aes(ymin=MeanTransmittance_LAI2200_mean-MeanTransmittance_LAI2200_se,
                    ymax=MeanTransmittance_LAI2200_mean+MeanTransmittance_LAI2200_se,
                    colour = "LAI2200"), alpha =.4, width=.2) +
  
  geom_errorbar(aes(ymin=MeanTransmittance_LowInt1m_init_mean-MeanTransmittance_LowInt1m_init_se,
                    ymax=MeanTransmittance_LowInt1m_init_mean+MeanTransmittance_LowInt1m_init_se, colour = "Low altitude - initial coordinates"), width=.2, alpha=.4) +
  
  geom_errorbar(aes(ymin=MeanTransmittance_LowInt1m_best_mean-MeanTransmittance_LowInt1m_best_se,
                    ymax=MeanTransmittance_LowInt1m_best_mean+MeanTransmittance_LowInt1m_best_se, colour = "Low altitude - optimised coordinates"), width=.2, alpha=.4) +
  
  
  geom_point(aes(y = MeanTransmittance_LAI2200_mean, colour = "LAI2200"),size = 3) +
  geom_line(aes(y = MeanTransmittance_LAI2200_mean, colour = "LAI2200")) +
  
  # geom_point(aes(y = MeanTransmittance_LowInt1m_mean, colour = "Low altitude - shifted coordinates"),size = 3) +
  # geom_line(aes(y = MeanTransmittance_LowInt1m_mean, colour = "Low altitude - shifted coordinates")) +
  # geom_errorbar(aes(ymin=MeanTransmittance_LowInt1m_mean-MeanTransmittance_LowInt1m_se,
  #                   ymax=MeanTransmittance_LowInt1m_mean+MeanTransmittance_LowInt1m_se, colour = "Low altitude - shifted coordinates"), width=.2, alpha=.4) +
  
  geom_point(aes(y = MeanTransmittance_LowInt1m_init_mean,
                 colour = "Low altitude - initial coordinates"),size = 3) +
  geom_line(aes(y = MeanTransmittance_LowInt1m_init_mean,
                colour = "Low altitude - initial coordinates")) +
  
  geom_point(aes(y = MeanTransmittance_LowInt1m_best_mean,
                 colour = "Low altitude - optimised coordinates"),size = 3) +
  geom_line(aes(y = MeanTransmittance_LowInt1m_best_mean,
                colour = "Low altitude - optimised coordinates")) +
  
  scale_colour_manual(values = c(
    "Low altitude - shifted coordinates" = "#009E73",
    "Low altitude - optimised coordinates" = "#009E73",
    "Low altitude - initial coordinates" = "#56B4E9",
    "LAI2200" = "#D55E00"),
    breaks=c("LAI2200",
             "Low altitude - optimised coordinates",
             "Low altitude - initial coordinates"
             # "Low altitude - shifted coordinates"
    )) +
  
  theme_minimal() +
  theme(title= element_text(size=18), axis.title= element_text(size=18), axis.text= element_text(size=18), legend.title= element_text(size=18), legend.text= element_text(size=18)) +
  labs(title = "Both transect", y="Mean transmittance of the transect", x="Ring", color = "Acquisition")

ggsave(paste("Long_profile_The2_transects_MeanStandardErrorTransmittance_of_the_transect_byRing_LowAlt_Intensity1m_optimised_aftershift.png", sep=""),
       path = "D:/Mes Donnees/PhD/Figures/lidar/Correlations/Coord_optimised",
       width = 25, height = 20, units = "cm", dpi=800, bg="white")

```

# Each transect
```{r}
LAI2200_LiDAR_transect <- LAI2200_LiDAR %>%
  group_by(Transect,Ring) %>% # variables selon lesquelles grouper
  summarise(across(all_of(vars), # Variables à analyser
                   list(mean = ~mean(.), # les stats
                        sd = ~sd(.),
                        se = ~plotrix::std.error(.)),
                   .names = "{.col}_{.fn}"))

for(t in c("HOBO", "LAY")){
  
  idmax = max(LAI2200_LiDAR[LAI2200_LiDAR$Transect==t,]$Id) # last sensor Id
  
  print(
    LAI2200_LiDAR_transect %>% 
      filter(Transect==t) %>% # LAY # HOBO
      ggplot(aes(x = Ring)) +
      geom_errorbar(aes(ymin=MeanTransmittance_LAI2200_mean-MeanTransmittance_LAI2200_se,
                        ymax=MeanTransmittance_LAI2200_mean+MeanTransmittance_LAI2200_se,
                        colour = "LAI2200"), alpha =.4, width=.2) +
      
      geom_errorbar(aes(ymin=MeanTransmittance_LowInt1m_init_mean-MeanTransmittance_LowInt1m_init_se,
                        ymax=MeanTransmittance_LowInt1m_init_mean+MeanTransmittance_LowInt1m_init_se, colour = "Low altitude - initial coordinates"), width=.2, alpha=.4) +
      
      geom_errorbar(aes(ymin=MeanTransmittance_LowInt1m_best_mean-MeanTransmittance_LowInt1m_best_se,
                        ymax=MeanTransmittance_LowInt1m_best_mean+MeanTransmittance_LowInt1m_best_se, colour = "Low altitude - optimised coordinates"), width=.2, alpha=.4) +
      
      
      geom_point(aes(y = MeanTransmittance_LAI2200_mean, colour = "LAI2200"),size = 3) +
      geom_line(aes(y = MeanTransmittance_LAI2200_mean, colour = "LAI2200")) +
      
      # geom_point(aes(y = MeanTransmittance_LowInt1m_mean, colour = "Low altitude - shifted coordinates"),size = 3) +
      # geom_line(aes(y = MeanTransmittance_LowInt1m_mean, colour = "Low altitude - shifted coordinates")) +
      # geom_errorbar(aes(ymin=MeanTransmittance_LowInt1m_mean-MeanTransmittance_LowInt1m_se,
      #                   ymax=MeanTransmittance_LowInt1m_mean+MeanTransmittance_LowInt1m_se, colour = "Low altitude - shifted coordinates"), width=.2, alpha=.4) +
      
      geom_point(aes(y = MeanTransmittance_LowInt1m_init_mean,
                     colour = "Low altitude - initial coordinates"),size = 3) +
      geom_line(aes(y = MeanTransmittance_LowInt1m_init_mean,
                    colour = "Low altitude - initial coordinates")) +
      
      geom_point(aes(y = MeanTransmittance_LowInt1m_best_mean,
                     colour = "Low altitude - optimised coordinates"),size = 3) +
      geom_line(aes(y = MeanTransmittance_LowInt1m_best_mean,
                    colour = "Low altitude - optimised coordinates")) +
      
      scale_colour_manual(values = c(
        "Low altitude - shifted coordinates" = "#009E73",
        "Low altitude - optimised coordinates" = "#009E73",
        "Low altitude - initial coordinates" = "#56B4E9",
        "LAI2200" = "#D55E00"),
        breaks=c("LAI2200",
                 "Low altitude - optimised coordinates",
                 "Low altitude - initial coordinates"
                 # "Low altitude - shifted coordinates"
        )) +
      theme_minimal() +
      theme(title= element_text(size=18), axis.title= element_text(size=18), axis.text= element_text(size=18), legend.title= element_text(size=18), legend.text= element_text(size=18)) +
      labs(title = paste(t," transect"), y="Mean transmittance of the transect", x="Ring", color = "Acquisition")
  )
  # ggsave(paste("Long_profile_",t," transect","_MeanStandardErrorTransmittance_of_the_transect_byRing_LowAlt_Intensity1m_optimised_aftershift.png", sep=""),
  #        path = "D:/Mes Donnees/PhD/Figures/lidar/Correlations/Coord_optimised",
  #        width = 25, height = 20, units = "cm", dpi=800, bg="white")
}
```

# Correlation trans lidar coord optimisée avec trans lai2200
```{r}
DF_cor_LiDARvsLAI2200 <- LAI2200_LiDAR %>% 
  select(Ring, MeanTransmittance_LAI2200, MeanTransmittance_LowInt1m_init, MeanTransmittance_LowInt1m_best) %>%  
  unique() %>% 
  pivot_wider(names_from = Ring,
              values_from = c(MeanTransmittance_LAI2200,
                              MeanTransmittance_LowInt1m_init, MeanTransmittance_LowInt1m_best),
              values_fn = list,
              names_glue = "{.value}_Ring{Ring}") %>% 
  unnest(everything()) # pcq les colonnes sont en listes

names(DF_cor_LiDARvsLAI2200) <- str_remove(names(DF_cor_LiDARvsLAI2200), "MeanTransmittance_") # simplify the var names

nrow(DF_cor_LiDARvsLAI2200)

CorMatrixS <- Hmisc::rcorr(as.matrix(DF_cor_LiDARvsLAI2200))
CorMatrix <- round(CorMatrixS$r, digits = 2)  # matrice de corrélation
Pval_corr <- CorMatrixS$P # p-values

# Plot de la matrice de corrélation :
png("D:/Mes Donnees/PhD/Figures/lidar/Correlations/Coord_optimised/Correlation_plot_LiDARLowAltInt1m_vs_LAI2200_optimised_aftershift.png",
    width = 1000, height = 743, pointsize=20)

corrplot(CorMatrix, method="color", col=brewer.pal(n=8, name="PuOr"),  
         type="upper",
         # order="hclust",
         tl.col="black", tl.cex = 1,# tl.srt=45, #Text label color and rotation
         addCoef.col = "white", # Add coefficient of correlation
         number.cex = 0.8, # values
         p.mat = Pval_corr, # croix pour pvalue
         # hide correlation coefficient on the principal diagonal
         diag=FALSE) 

dev.off()
```