---
title: "Light maps"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: pdf_document
---

# Packages
```{r, include = F}
library(data.table)
library(tidyverse)
library(sf)
library(terra)
library(corrplot)
library(RColorBrewer)
```

# Spatial objects
```{r}
buffer <- st_as_sf(vect("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Plot16_4ha_buffer.shp")) # interest zone with buffer
zone <- st_as_sf(vect("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2022/Parcelles_Understory.shp")) # 4 carrés
Understory_stakes <- read.csv("D:/Mes Donnees/PhD/SIG_data/Understory-ALT/Understory_stakes_theoretical_UTM.csv") # stakes on the understory 4ha on P16


```

# Process raw data from AMAPVox
```{r}
# Echo weight by intensity (2 m res):  
path_High <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_2m/P16_2023_HighAlt_4ha_buffer_Light_annual_intensity2m.txt"
path_Low <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/Intensity_2m/P16_2023_LowAlt_4ha_buffer_Light_annual_intensity2m.txt"

path_High_Dry <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_2m/P16_2023_HighAlt_4ha_buffer_Light_Dry_intensity2m.txt"
path_High_Wet <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_2m/P16_2023_HighAlt_4ha_buffer_Light_Wet_intensity2m.txt"
path_Low_Dry <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/Intensity_2m/P16_2023_LowAlt_4ha_buffer_Light_Dry_intensity2m.txt"
path_Low_Wet <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/Intensity_2m/P16_2023_LowAlt_4ha_buffer_Light_Wet_intensity2m.txt"

path_High_grid <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_2m/P16_2023_4ha_HighAlt_Light_Grid10x10m_each1mZ_intensity2m.txt"
path_Low_grid <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/Intensity_2m/P16_2023_4ha_LowAlt_Light_Grid10x10m_each1mZ_intensity2m.txt"

path_High_Dry_grid <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_2m/P16_2023_HighAlt_4ha_buffer_Light_Dry_Grid10x10m_each1mZ_intensity2m.txt"
path_High_Wet_grid <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_2m/P16_2023_HighAlt_4ha_buffer_Light_Wet_Grid10x10m_each1mZ_intensity2m.txt"
path_Low_Dry_grid <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/Intensity_2m/P16_2023_LowAlt_4ha_buffer_Light_Dry_Grid10x10m_each1mZ_intensity2m.txt"
path_Low_Wet_grid <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/Intensity_2m/P16_2023_LowAlt_4ha_buffer_Light_Wet_Grid10x10m_each1mZ_intensity2m.txt"

# Equal echo weight :
# path_High <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_HighAlt_4ha_buffer_Light_annual_equalecho2m.txt"
# path_Low <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/P16_2023_4ha_buffer_LowAlt_Light_annual_equalecho2m.txt"

# Echo weight by intensity :  
# path_Low_lightgrid <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/P16_2023_4ha_LowAlt_Light_Grid10x10m_each1mZ.txt"
# path_High_lightgrid <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_4ha_HighAlt_Light_Grid10x10m_each1mZ.txt"
# path_High <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_HighAlt_4ha_buffer_Light_annual.txt"
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_HighAlt_4ha_buffer_Light_Dry.txt"
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_HighAlt_4ha_buffer_Light_Wet.txt"
# path_Low <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/P16_2023_4ha_buffer_LowAlt_Light_annual.txt"
# path_2022 <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2022/P16_2022_4ha_buffer_Light_annual.txt"
```

```{r}
ReadLightFile <- function(path, skiplines=10){
  Light <- fread(path, skip=skiplines) # skip the 10 1st lines of header
  Light <- Light[Y != "MEAN"] # enlever les 2 lignes mean
  Light <- janitor::remove_empty(Light,"cols")
  
  Light[, `:=`(X = as.numeric(X) , Y = as.numeric(Y))] # all as numeric
  Light <- Light[!is.na(X)] 
  return(Light)
}

Light_High <- ReadLightFile(path_High)
Light_High
Light_Low <- ReadLightFile(path_Low)
Light_Low

```

## Plot with buffer
```{r}
Plot_Light <- function(Light, acq){
  # Remove edges
  # Light <- Light[X<90 & X> -90 & Y<90 & Y> -90]
  
  lattice::levelplot(`Period 1` ~ X*Y, data = Light) # Transmittance
  lattice::levelplot(Z~X*Y, data = Light) # Z = Altitude
  
  ggplot() + 
    geom_raster(data = Light, aes(X, Y, fill = `Period 1`)) + 
    scale_fill_gradientn(name = "Light intensity (Transmittance)",
                         colors = terrain.colors(30, rev=T),
                         na.value="white") +
    ggtitle(paste("Paracou P16 4ha -", acq, "- Light map 1m", sep = " ")) +  
    coord_sf()
}

Plot_Light(Light_High, "High altitude")
Plot_Light(Light_Low, "Low altitude")
```

## Transformation des coordonnées relatives en UTM
On peut retrouver les cooordonnées UTM avec la VOP
```{r}
# Lecture matrice de transformation
VOP <- as.matrix(read.table("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/VOP_P16_9ha.txt"))

Relativ2UTM <- function(data, VOP){
  # Apply inverse of VOP matrix to convert back to UTM
  xyz <- tcrossprod(as.matrix(data[, .(X, Y, Z, c=1)]), solve(VOP))
  data[, `:=`(Xutm = xyz[, 1], Yutm = xyz[, 2], Zutm = xyz[, 3])]
  
  data <- unique(data)
  return(data)
}

Light_HighUTM <- Relativ2UTM(Light_High, VOP)
Light_LowUTM <- Relativ2UTM(Light_Low, VOP)

Plot_LightUTM <- function(Light, zone, buffer){
  ggplot() + 
    geom_point(data = Light, size = 1.28,
               aes(Xutm, Yutm, color = `Period 1`)) + 
    scale_color_gradientn(name = "Light intensity (Transmittance)",
                          colors = terrain.colors(30, rev=T),
                          na.value="white") +
    geom_sf(data = sf::st_cast(buffer, "LINESTRING")) + # buffer (to remove after)
    geom_sf(data = sf::st_cast(zone, "LINESTRING")) + # zone of interest
    ggtitle("Paracou P16 4ha - Light map 1m") +  
    coord_sf()
}

Plot_LightUTM(Light_HighUTM, zone, buffer)
Plot_LightUTM(Light_LowUTM, zone, buffer)
```

## Crop on the interest zone
```{r}
Crop <- function(data, zone){
  datasf <- st_as_sf(data, coords = c('Xutm','Yutm'))
  datasf <- st_set_crs(datasf, terra::crs(zone))
  datacrop <- st_intersection(datasf, zone)
  XY <- st_coordinates(datacrop) # stock coordinates
  colnames(XY) <- c("Xutm", "Yutm") 
  st_geometry(datacrop) <- NULL # no more sf object
  datacrop <- cbind(datacrop, XY) # bind XY coord
  return(datacrop)
}

Light_HighUTM <- Crop(Light_HighUTM, zone)
Light_LowUTM <- Crop(Light_LowUTM, zone)

Plot_LightUTM <- function(Lightcrop, zone, acq){
  ggplot() + 
    geom_point(data = Lightcrop, size = 1.28,
               aes(Xutm, Yutm, color = `Period.1`)) + 
    
    scale_color_gradientn(name = "Light intensity (Transmittance)",
                          colors = terrain.colors(30, rev=T),
                          na.value="white", limits = c(0,0.25)) +
    
    geom_sf(data = sf::st_cast(zone, "LINESTRING")) + # zone of interest
    ggtitle(paste("Paracou P16 4ha -", acq, "- Light map 1m", sep = " ")) +  
    coord_sf()
}

Plot_LightUTM(Light_HighUTM, zone, "High altitude")
Plot_LightUTM(Light_LowUTM, zone, "Low altitude")
```

## Write data cropped and in UTM
```{r}
Writedata_txt_csv <- function(data, path){
  fwrite(data, paste(path, ".txt"), row.names = F, col.names = T)
  write.csv(data, paste(path, ".csv"))
}

Writedata_txt_csv(Light_HighUTM, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_HighAlt_4ha_Light_annual_equalecho2m_UTM")
Writedata_txt_csv(Light_LowUTM, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/P16_2023_4ha_LowAlt_Light_annual_equalecho2m_UTM")


# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/P16_2023_4ha_LowAlt_Light_annual_1m_UTM.txt"
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_HighAlt_4ha_Light_annual_1m_UTM.txt"
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_HighAlt_4ha_Light_Dry_1m_UTM.txt"

# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_4ha_HighAlt_Light_Grid10x10m_each1mZ_UTM.txt"
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/P16_2023_4ha_LowAlt_Light_Grid10x10m_each1mZ_UTM.txt"

# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/P16_2023_4ha_LowAlt_Light_annual_1m_UTM.csv"
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_HighAlt_4ha_Light_annual_1m_UTM.csv"
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_HighAlt_4ha_Light_Dry_1m_UTM.csv"

# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_4ha_HighAlt_Light_Grid10x10m_each1mZ_UTM.csv"
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/P16_2023_4ha_LowAlt_Light_Grid10x10m_each1mZ_UTM.csv"
```

# Load data pré-processed
```{r}
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/P16_2023_4ha_LowAlt_Light_annual_1m_UTM.txt"
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_HighAlt_4ha_Light_annual_1m_UTM.txt"
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_HighAlt_4ha_Light_Dry_1m_UTM.txt"

Light_HighUTM <- fread("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_HighAlt_4ha_Light_annual_equalecho2m_UTM.txt")

Light_LowUTM <- fread("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/P16_2023_4ha_LowAlt_Light_annual_equalecho2m_UTM.txt")
```

# Maps

# Light differences
leftjoin by coordinates 
difference between `Period.1` of the 2 datasets
```{r}
# names(Light_HighUTM) # "X","Y","Z","Period.1","Zutm","SubPlotCon","Forest","Plot","SubPlot","Projet","Protocole","Xutm","Yutm"

ComputeLightDiff <- function(Light_HighUTM, Light_LowUTM){
  setDT(Light_HighUTM); setDT(Light_LowUTM)
  
  Light <- merge(Light_HighUTM, Light_LowUTM, by=c("Xutm","Yutm","Zutm", "X","Y","Z", "Forest","Plot","SubPlot","Projet","Protocole","SubPlotCon"), all=TRUE, suffixes = c("_HighAlt", "_LowAlt")) # merge datasets
  
  Light[,Lightdiff:=`Period.1_LowAlt`-`Period.1_HighAlt`] # compute differences (4-3=1, le rslt informe sur la valeur à laquelle on soustrait)
}

Light <- ComputeLightDiff(Light_HighUTM, Light_LowUTM)
Light
```

## Light differences maps
```{r}
hist(Light$Lightdiff, breaks = 15)
Min <- min(Light$Lightdiff)
Max <- max(Light$Lightdiff)

ggplot() + 
  geom_point(data = Light, size = 1.28,
             aes(Xutm, Yutm, color = Lightdiff)) + 
  scale_colour_gradient2(name = "Light intensity (Transmittance) difference", low="#000066", high="red", mid = "white", midpoint = 0)+
  # scale_colour_steps2(name = "Light intensity (Transmittance) difference",
  #                     low="#000066", high="red", mid = "white", midpoint = 0.00,
  #                     limits = c(Min, Max),
  #                     breaks = c(Min, -0.06, -0.04, -0.02, -0.01, 0.01, 0.02, 0.04, 0.06, Max), # c(Min, -0.08, -0.02, 0.02, 0.06, Max) ; seq(Min, Max, by = 0.02)
  #                     labels = as.character(round(c(Min, -0.06, -0.04, -0.02, -0.01, 0.01, 0.02, 0.04, 0.06, Max), digits = 2))) +
  # geom_sf(data = sf::st_cast(buffer, "LINESTRING")) + # buffer 
  geom_sf(data = sf::st_cast(zone, "LINESTRING")) + # zone of interest
  ggtitle("Paracou P16 4ha - ALS High vs Low Altitude 2023 - Light map difference (1m)") +  
  coord_sf()

ggplot() + 
  geom_point(data = Light, size = 1.28,
             aes(Xutm, Yutm, color = Lightdiff)) + 
  # scale_colour_gradient2(name = "Light intensity (Transmittance) difference", low="#00AFBB", high="#FC4E07", mid = "white", midpoint = 0)+
  scale_colour_steps2(name = "Light intensity (Transmittance) difference",
                      low="#000066", high="red", mid = "white", midpoint = 0.00,
                      limits = c(Min, Max) #,
                      # breaks = seq(-0.1, 0.1, by = 0.025) # c(Min, -0.08, -0.02, 0.02, 0.06, Max) ; seq(Min, Max, by = 0.02)
  ) +
  # geom_sf(data = sf::st_cast(buffer, "LINESTRING")) + # buffer 
  geom_sf(data = sf::st_cast(zone, "LINESTRING")) + # zone of interest
  ggtitle("Paracou P16 4ha - ALS High vs Low Altitude 2023 - Light map difference (1m)") +  
  coord_sf()
```

# Light profiles
```{r}
# Pathgrid_HighAlt <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_4ha_HighAlt_Light_Grid10x10m_each1mZ_equalecho2m.txt"
# Pathgrid_LowAlt <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/P16_2023_4ha_LowAlt_Light_Grid10x10m_each1mZ_equalecho2m.txt"

Pathgrid_HighAlt <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_2m/P16_2023_4ha_HighAlt_Light_Grid10x10m_each1mZ_intensity2m.txt"
Pathgrid_LowAlt <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/Intensity_2m/P16_2023_4ha_LowAlt_Light_Grid10x10m_each1mZ_intensity2m.txt"

Pathgrid_High_Dry <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_2m/P16_2023_HighAlt_4ha_buffer_Light_Dry_Grid10x10m_each1mZ_intensity2m.txt"
Pathgrid_High_Wet <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_2m/P16_2023_HighAlt_4ha_buffer_Light_Wet_Grid10x10m_each1mZ_intensity2m.txt"
Pathgrid_Low_Dry <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/Intensity_2m/P16_2023_LowAlt_4ha_buffer_Light_Dry_Grid10x10m_each1mZ_intensity2m.txt"
Pathgrid_Low_Wet <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/Intensity_2m/P16_2023_LowAlt_4ha_buffer_Light_Wet_Grid10x10m_each1mZ_intensity2m.txt"

Lightgrid_HighAlt <- ReadLightFile(Pathgrid_HighAlt)
Lightgrid_LowAlt <- ReadLightFile(Pathgrid_LowAlt)

Lightgrid_High_Dry <- ReadLightFile(Pathgrid_High_Dry, skiplines=14)
Lightgrid_High_Wet <- ReadLightFile(Pathgrid_High_Wet, skiplines=14)

Lightgrid_Low_Dry <- ReadLightFile(Pathgrid_Low_Dry, skiplines=14)
Lightgrid_Low_Wet <- ReadLightFile(Pathgrid_Low_Wet, skiplines=14)

# Lightgrid_HighUTM <- Relativ2UTM(Lightgrid_HighAlt, VOP)
# Lightgrid_LowUTM <- Relativ2UTM(Lightgrid_LowAlt, VOP)
# 
# Lightgrid_HighUTM <- Crop(Lightgrid_HighUTM, zone)
# Lightgrid_LowUTM <- Crop(Lightgrid_LowUTM, zone)

# Lightgrid_HighUTM ; Lightgrid_LowUTM

# Writedata_txt_csv(Lightgrid_HighUTM, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_4ha_HighAlt_Light_Grid10x10m_each1mZ_equalecho2m_UTM")
# Writedata_txt_csv(Lightgrid_LowUTM, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/P16_2023_4ha_LowAlt_Light_Grid10x10m_each1mZ_equalecho2m_UTM")

names(Lightgrid_High_Dry)
```

```{r}
average_Periods <- function(data){
  data <- data[, Transmittance := rowMeans(.SD), .SDcols = c("Period 1", "Period 2", "Period 3", "Period 4", "Period 5", "Period 6")]
}

Lightgrid_High_Dry <- average_Periods(Lightgrid_High_Dry)
Lightgrid_High_Wet <- average_Periods(Lightgrid_High_Wet)

Lightgrid_Low_Dry <- average_Periods(Lightgrid_Low_Dry)
Lightgrid_Low_Wet <- average_Periods(Lightgrid_Low_Wet)

setnames(Lightgrid_HighAlt, "Period 1", "Transmittance")
setnames(Lightgrid_LowAlt, "Period 1", "Transmittance")
```

## Compute Transmitance by altitude
```{r}
names(Lightgrid_HighAlt) # "X","Y","Z",  "Period 1",  "Xutm","Yutm","Zutm"    

compute_Transmitance_byAlt <- function(data){
  data <- setDF(data) %>% 
    mutate(Z_disc = as.integer(Z)) %>% 
    group_by(Z_disc) %>% 
    mutate(MeanTransmittance = mean(Transmittance)) %>% 
    mutate(MinTransmittance = min(Transmittance)) %>% 
    mutate(MaxTransmittance = max(Transmittance)) %>%
    mutate(SdTransmittance = sd(Transmittance)) %>% 
    ungroup() %>% 
    select(Z_disc, MeanTransmittance, MinTransmittance, MaxTransmittance, SdTransmittance) %>% unique()
}

Lightgrid_HighAlt <- compute_Transmitance_byAlt(Lightgrid_HighAlt)
Lightgrid_LowAlt <- compute_Transmitance_byAlt(Lightgrid_LowAlt)

Lightgrid_High_Dry <- compute_Transmitance_byAlt(Lightgrid_High_Dry)
Lightgrid_High_Wet <- compute_Transmitance_byAlt(Lightgrid_High_Wet)

Lightgrid_Low_Dry <- compute_Transmitance_byAlt(Lightgrid_Low_Dry)
Lightgrid_Low_Wet <- compute_Transmitance_byAlt(Lightgrid_Low_Wet)

```

## Light profiles plot
```{r}
# data1=Lightgrid_HighAlt ; data2=Lightgrid_LowAlt; Leg1="High altitude"; Leg2="Low altitude"; Title="High vs Low"
# LegCol= c("High altitude" = "blue","Low altitude" = "#56B4E9")

plotLightProfiles <- function(data1, data2, LegCol, Title){ # Leg1, Leg2,
  data1 %>% 
    # filter(Z_disc>=0 & Z_disc<=60) %>% 
    ggplot(aes(x= Z_disc, y= MeanTransmittance)) +
    
    geom_point(data = data1, aes(x = Z_disc, y = MeanTransmittance, colour = names(LegCol)[1])) +
    geom_line(data = data1, aes(x = Z_disc, y = MeanTransmittance, colour = names(LegCol)[1])) +
    
    geom_point(data = data2, aes(x = Z_disc, y = MeanTransmittance, colour = names(LegCol)[2])) +
    geom_line(data = data2, aes(x = Z_disc, y = MeanTransmittance, colour = names(LegCol)[2])) +
    
    # geom_errorbar(data = data2, aes(ymin=MinTransmittance, ymax=MaxTransmittance), colour = "darkgreen", width=.2) +
    # geom_errorbar(data = data1, aes(ymin=MinTransmittance, ymax=MaxTransmittance), colour = "green", width=.2) +
    # geom_errorbar(aes(ymin=MeanTransmittance-SdTransmittance, ymax=MeanTransmittance+SdTransmittance), width=.2)
    
    scale_colour_manual(values = LegCol) +
    theme_minimal() +
    ggtitle(paste("P16 - 2023 - 4ha - ", Title, "Light profile (Grid 10x10m, each 1m in Z)")) +
    labs(y="Transmittance", x="Altitude", color = "LiDAR acquisition") +
    xlim(0,70) +
    coord_flip() # coordonnées inversées au départ pour que la ligne suive la hauteur au sol et non le Transmittance
  
  ggsave(paste("ALS2023_P16_4ha_",Title,"_Light_profile_(Grid_10x10m_each_1m_in_Z)_intensity_2m.png"),
         path = "D:/Mes Donnees/PhD/Figures/lidar/Light_maps/Light_profil/Intensity_2m",
         width = 18, height = 20, units = "cm", dpi=800, bg="white")
}

plotLightProfiles(Lightgrid_HighAlt, Lightgrid_LowAlt,
                  c("High altitude" = "blue","Low altitude" = "#56B4E9"),
                  "High vs Low")
plotLightProfiles(Lightgrid_High_Dry, Lightgrid_High_Wet,
                  c("Dry season" = "#D55E00","Wet season" = "#56B4E9"),
                  "High alt Dry vs Wet")
plotLightProfiles(Lightgrid_Low_Dry, Lightgrid_Low_Wet,
                  c("Dry season" = "#D55E00","Wet season" = "#56B4E9"),
                  "Low alt Dry vs Wet")
```

# Spatial autoccorelation of the light
```{r}

```


# HOBO
## Load HOBO data
```{r, include = F}
HOBO_coord <- read_csv("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LAI2200_theoretical_UTMxyz.csv") %>% filter(Transect=="HOBO") # HOBO sensors coordinates
HOBO_data <- read_csv("D:/Mes Donnees/PhD/Microclimate/HOBO/HOBO_Light_stats.csv") %>%  # HOBO sensors data
  rename(Id = HoboID)

names(HOBO_data) # "HoboID" "HOBO_Light_annual_sum" "HOBO_Light_sum_Dry" "HOBO_Light_sum_Wet" "HOBO_Light_october_sum"

HOBO <- HOBO_coord %>% 
  left_join(HOBO_data, by= "Id") %>% 
  mutate(Xutm = round(Xutm), 
         Yutm = round(Yutm),
         Zutm = round(Zutm)) %>% 
  select(-c(Sensor,Transect))
```

## Plot HOBO data
```{r}
HOBOUTMsf <- st_as_sf(HOBO, coords = c('Xutm','Yutm'))
HOBOUTMsf <- st_set_crs(HOBOUTMsf, crs(zone))

ggplot() +
  geom_sf(data = sf::st_cast(zone, "LINESTRING")) + # zone of interest
  geom_sf(data = HOBOUTMsf, aes(color = HOBO_Light_october_sum), size = 1.5) +
  scale_colour_gradientn(name =,
                         colors = terrain.colors(30, rev=T),
                         na.value="grey", labels = scales::comma) + 
  ggtitle("Paracou P16 4ha - HOBO Light (lux)")
```

## Combine LiDAR and HOBO data
```{r}
HOBO_LiDAR <- Light %>% 
  mutate(Xutm = round(Xutm),
         Yutm = round(Yutm),
         Zutm = round(Zutm)) %>%
  left_join(HOBO, by= c("Xutm","Yutm","Zutm")) # coord pas les memes

names(HOBO_LiDAR) # "Period.1_HighAlt" "Period.1_LowAlt" HOBO_Light_annual_sum" "HOBO_Light_sum_Dry"     "HOBO_Light_sum_Wet" "HOBO_Light_october_sum"
```

## Correlations
```{r}
# Transmittance_LAI2200, Transmittance_Low, Transmittance_High, HOBO_Light_october_sum, HOBO_Light_annual_sum

DF_cor <- HOBO_LiDAR %>% 
  select(Period.1_HighAlt, Period.1_LowAlt, HOBO_Light_annual_sum, HOBO_Light_sum_Dry, HOBO_Light_sum_Wet, HOBO_Light_october_sum) %>% 
  unique() %>% 
  na.omit()


CorMatrixS <- Hmisc::rcorr(as.matrix(DF_cor))
CorMatrix <- round(CorMatrixS$r, digits = 2)  # matrice de corrélation
Pval_corr <- CorMatrixS$P # p-values

# Plot de la matrice de corrélation :
# png("D:/Mes Donnees/PhD/Figures/lidar/Correlations/Correlation_plot_HOBOLAI2200vsLiDAR_High_and_Low_altitude_byRing_equalecho2m_test.png", width = 900, height = 800)
corrplot(CorMatrix, method="circle", type="lower", diag = F, addCoef.col = 'white', 
         number.cex = 1, col=brewer.pal(n=8, name="PuOr"),
         tl.col="black", tl.cex = 1, tl.srt=45, p.mat = Pval_corr)
# dev.off()


```

## Regresion
```{r}
options(scipen = 999)
for(acq in c("Period.1_HighAlt", "Period.1_LowAlt")){
  print(
    HOBO_LiDAR %>% 
      na.omit() %>% 
      ggplot() +
      ggtitle("Paracou P16 4ha - LiDAR transmittances vs HOBO light (lux)") +
      aes(x = get(acq), y = HOBO_Light_annual_sum) +
      geom_point() +
      stat_smooth(method = "lm",
                  formula = y ~ x) +
      ggpubr::stat_cor(label.x = 0.01, label.y = 40000000) +
      ggpubr::stat_regline_equation(label.x = 0.01, label.y = 37000000) +
      scale_y_continuous(labels = scales::comma) +
      labs(x = acq, y = "HOBO light (lux)", color = "LiDAR acquisition") 
  )
}
```

