---
title: "Check_attenuation"
date: "`r Sys.Date()`"
format: html
self-contained: true
theme: cosmo
editor: source
code-fold: true
execute: 
  cache: true
---

Objective:  
Estimer la lumière au dessus de chaque arbre en n points moyennés.  
- voxélisation à 1m de résolution  
- calculer la lumière tous les 1m en x,y,z sur 25ha avec 46 orientations  
- enlever les colonnes dont on n'a pas besoin (data.table) pour alléger 
- trouver le voxel qui correspond aux à la cime x,y,z l'arbre +1m 
- trouver et moyenner la valeur des 8 voxels voisins (3x3, 9 valeurs moyennées) (en coordonnées locales)   

- essayer d’abord sur 1ha  
- plus coûteux en calcul et temps mais ce sera fait si on veut ajuster la méthode  

# Packages
```{r Setup, include = F}
library(tidyverse)
library(lidR)
library(readr)
library(data.table)
library(AMAPVox)
library(terra)
library(sf)
```

# Read light file
```{r}
source("~/PhD/R_codes/PhD/LiDAR_scripts/Functions/ReadLightFile.R")
path <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/ForTrees/P16C19_2023_1ha_HighAlt_Light_intensity2m_all2m.txt"
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/ForTrees/P16_2023_25ha_buffer_HighAlt_Light_intensity1m_all1m.txt"

# P16_2023_1ha_buffer_HighAlt_Light_intensity1m_all1m.txt # 10201 obs
# P16_2023_25ha_buffer_HighAlt_Light_intensity1m_all1m.txt # 491 401 obs

Light <- ReadLightFile(path, skiplines=9)

setnames(Light, "Period 1", "Transmittance")

Light <- Light[Transmittance>0,]

range(Light$Transmittance) # 0.000206811 - 1
any(is.na(Light$Transmittance)) # FALSE
nrow(Light[Transmittance<0.01, ])/nrow(Light)*100 # 7.8% 
nrow(Light[Transmittance<0.001, ])/nrow(Light)*100 # 0.2% 
hist(Light$Transmittance)
hist(Light$Z)
hist(Light[Transmittance<0.001, Z])
hist(Light[Transmittance<0.002, Z])
hist(Light[Transmittance<0.005, Z])
hist(Light[Transmittance<0.01, Z])
hist(Light[Transmittance<0.05, Z])


hist(Light[Transmittance>=1, Z])

```

```{r}
plotly::plot_ly(Light, x = ~X, y = ~Y, z = ~Z, color=~Transmittance)
```

# Trees coordinates and height
All the cirad trees on 25ha + ALT on 9 ha, with corrected coordinates and tree heights

```{r for the moment, eval=F}
warning("put 25ha complete data")
data <- read.csv(
  "~/PhD/Inventories/Data/Understory/Paracou/ALT_Paracou_9ha_CLEAN.csv" # en attendant
) %>% 
  # rename(SubPlot = Subplot) %>%
  filter(Subplot %in% c(14,15,19,20)) %>% # TEMPORAIRE 4ha seulement # 16 014 rows
  select(IdTree, Stem.nb, Xutm, Yutm) %>% 
  unique() %>% # to remove duplicated idtree TEMPORAIRE
  mutate(TreeHeight = sample(rep(1:10, length.out = n())))

data

IdTree <- unique(data$IdTree)
data[!is.na(data$IdTree) & duplicated(data$IdTree),] 

# IDtrees <- data %>% select(idTree)
```

```{r at final}
data <- read.csv(
  "~/PhD/Inventories/Data/Adults_Understory/Paracou/AllP16_TreeHeights.csv" # at final
) %>% 
  # rename(SubPlot = Subplot) %>%
  filter(SubPlot == 19) %>% # TEMPORAIRE 1ha seulement 
  select(idTree, ScientificName, Strategy, Xutm, Yutm, DBHcor, TreeHeight)

range(data$TreeHeight) # 1.980045 49.100730

idTrees <- unique(data$idTree)
data[!is.na(data$idTree) & duplicated(data$idTree),] 

# IDtrees <- data %>% select(idTree)
```

## Extract Zutm for each tree
```{r}
MNT <- terra::rast("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/MNT/dtm2023_25ha_HighAlt_buffer.asc") 
crs(MNT) <- crs("EPSG:2972")

datasf <- st_as_sf(data, coords = c('Xutm','Yutm'))
datasf <- st_set_crs(datasf, st_crs(MNT)) 

alt <- extract(MNT, datasf) %>% # extract z
  rename(Zutm = `MNT_0.5m_IRD_500m_Paracou_284000_579500`)

data <- data %>% cbind(alt) %>% setDT()
# data
```

## Coordinates in local positions (use VOP) as light file
```{r}
VOP <- as.matrix(read.table("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/VOP/VOP_P16_25ha.txt"))

data <- setDT(data)

matrix <- as.matrix(data[, `:=`(c = 0 , d = 1)][,.(Xutm, Yutm, c, d)]) # as matrix of the same dimensions, without Z

datalocal <- matrix %*% t(VOP) # same dimensions

datalocal <- as.data.frame(cbind(datalocal, data[,Zutm]))[, -c(3,4)]  # add Zutm
names(datalocal) <- c("X","Y","Z")
datalocal <- datalocal %>% cbind(data[,.(idTree, ScientificName, Strategy, Xutm, Yutm, Zutm, DBHcor, TreeHeight)]) %>% setDT()
# datalocal
```

## Coordinates 1m above each tree
```{r}
datalocal[,Z := Z+TreeHeight+1]
range(datalocal$Z) # 9.714853 63.537480

datalocal[Z>max(Light$Z),]

datalocal <- datalocal[Z<max(Light$Z),] # remove trees too tall


# datalocal
```

```{r}
summary(Light[, .(X, Y, Z)]) # max z=66
summary(datalocal[, .(X, Y, Z)]) # max tree height too big 72m
```

# Light per tree - 8 neighboors (3x3, 9 valeurs moyennées)
```{r}
# Get neighbors in immediate neighborhood (k  nearest voxels including target)
result <- RANN::nn2(data = Light[, .(X, Y, Z)], # Pool to search
                    query = datalocal[, .(X, Y, Z)], # [1,], # point of interest
                    # The maximum number of nearest neighbours to compute
                    k = 7, # including target # 5, 8, 9, 15, 27, 30, 35, 35
                    searchtype = "radius", radius = 5)
# k = 30, radius = 3
# k = 7, radius = 5

# une matrice où chaque ligne correspond à un point et contient les indices de ses voisins les plus proches
index <- result$nn.idx # the near neighbour indices
any(index==0)

# Light <- tibble::rownames_to_column(Light, "Rowname")
# Light[Rowname %in% c(8586286, 9077687, 8586285, 8585585, 8586987, 8586287, 9077686, 9076986, 9078388, 8094885, 9077688, 8585584, 8586986, 8585586, 8586988, 9076985, 9078387, 8094884, 8094184, 9076987, 8095586, 9078389, 8094886, 9569088, 8094183, 8095585, 8094185, 8095587, 8586284, 9569087),]

# Compute light from local neighborhood :
# each row of index is a point of interest

fill.value <- apply(index, 1, function(i) Light[as.vector(i), mean(Transmittance)] # for a matrix 1 indicates rows
)
any(fill.value==0 | is.na(fill.value))


datalocal$Transmittance <- fill.value  
```
```{r}
ggplot(datalocal, aes(x=TreeHeight, y=Transmittance, col=Strategy)) + 
  theme_minimal() +
  geom_point(size=0.3)
```

# Minimal values of transmittance
```{r, eval=F}
range(na.omit(datalocal$Transmittance)) # 0.0006453574 1.0000000894
hist(datalocal$Transmittance)
datalocal[Transmittance<0.001,] # 15 trees
range(datalocal[Transmittance<0.001, Z]) # 15.29792 23.84516
(nrow(datalocal[Transmittance<0.001,])/nrow(datalocal))*100 # 0.4%

hist(datalocal[Transmittance<0.001, TreeHeight])


toodark <- datalocal[Transmittance<0.001,]
length(unique(toodark$ScientificName)) # 14

table(toodark$ScientificName) # max 2 ind concerned

# Median : moins bon
#  0.0003992877 1.0000000894
# [1] 14.53144 31.46755 m height
# [1] 0.15 %
# [1] 47 sp
```
J'ai estimé la lumière des arbres sur 1ha, en prenant 8 voisins et un radius de 5m, on a des transmittances entre 0.001 et  0.996,
sans moyenner le voisinage, les transmittances au dessus des arbres sont entre 0.0002 et 0.9999

# Write data
Inv (idTree, ScientificName, Xutm, Yutm, Zutm, DBHcor, TreeHeight) + Transmittance
```{r}
datalocal <- datalocal %>% select(idTree, ScientificName, Strategy, Xutm, Yutm, Zutm, DBHcor, TreeHeight, Z, Transmittance)

write.csv(datalocal, "~/PhD/Inventories/Data/Adults_Understory/Paracou/AllP16_Light.csv") # 47 875
```

# Check
```{r}
DATA <- Light[, .(X, Y, Z)] 

plot(DATA, pch=16, col="blue")
points(DATA[result$nn.idx[1,],], col="red", pch=19)  # Mettre en rouge les voisins du premier point

# Générer une palette de couleurs unique pour chaque point
colors <- rainbow(nrow(datalocal))  # Un dégradé de couleurs
# Créer un plot des points initiaux
plot(DATA, pch=16, col="black", main="Plus proches voisins avec couleurs par point")
# Tracer les voisins avec une couleur différente pour chaque ligne
for (i in 1:nrow(datalocal)) {
  neighbors <- result$nn.idx[i,]  # Indices des voisins
  points(DATA[neighbors,], col=colors[i], pch=19)  # Afficher les voisins avec la couleur associée
  segments(DATA[i,1], DATA[i,2], DATA[neighbors,1], DATA[neighbors,2], col=colors[i], lwd=2)  # Lignes entre le point et ses voisins
}
```

