---
title: "Check_attenuation"
date: "`r Sys.Date()`"
format: html
self-contained: true
theme: cosmo
editor: source
code-fold: true
execute: 
  cache: true
---

Objective:  
Estimer la lumière au dessus de chaque arbre en n points moyennés.  
- voxélisation à 1m de résolution  
- calculer la lumière tous les 1m en x,y,z sur 25ha avec 46 orientations  
- enlever les colonnes dont on n'a pas besoin (data.table) pour alléger 
- trouver le voxel qui correspond aux à la cime x,y,z l'arbre +1m 
- trouver et moyenner la valeur des 8 voxels voisins (3x3, 9 valeurs moyennées) (en coordonnées locales)   

- essayer d’abord sur 1ha  
- plus coûteux en calcul et temps mais ce sera fait si on veut ajuster la méthode  

# Packages
```{r Setup, include = F}
library(tidyverse)
library(lidR)
library(readr)
library(data.table)
library(AMAPVox)
library(terra)
library(sf)
```

# Read light file
```{r}
source("~/PhD/R_codes/PhD/LiDAR_scripts/Functions/ReadLightFile.R")
path <-
  # "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/ForTrees/P16C19_2023_1ha_HighAlt_Light_intensity2m_all2m.txt"
  # "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/ForTrees/P16_2023_25ha_buffer_HighAlt_Light_intensity1m_all1m.txt"
  "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2019/Light/P16_2019_25ha_buffer_Light_grid_intensity2m.txt"

# P16_2023_1ha_buffer_HighAlt_Light_intensity1m_all1m.txt # 10201 obs
# P16_2023_25ha_buffer_HighAlt_Light_intensity1m_all1m.txt # 491 401 obs

Light <- ReadLightFile(path, skiplines=9)

setnames(Light, "Period 1", "Transmittance")

Light <- Light[Transmittance>0 & Z>2,] # remove Z=2m because all is equal to 100%T

range(Light$Transmittance) # 0.000206811 - 1 -> 2019: 1.363128e-10 - 1
any(is.na(Light$Transmittance)) # FALSE
nrow(Light[Transmittance<0.01, ])/nrow(Light)*100 # 7.8% -> 2019: 13%
nrow(Light[Transmittance<0.001, ])/nrow(Light)*100 # 0.2% -> 2019: 1%
hist(Light$Transmittance)
hist(Light$Z)
options(scipen=999)
Zinf20 <- Light[Z<20,]
quantile(Light[Z<20, Transmittance*100],  probs = c(0, .05, .5, .95, 1))
 # 0%            5%    50%    95%    100% 
 # 0.00000001   0.09   0.9    18.2    92.8 

hist(Light[Z<20, Transmittance*100])
under <- Light[Z==2,]
under <- Light[Z<20 & Transmittance<=1,]

hist(Light[Transmittance<0.001, Z])
hist(Light[Transmittance<0.002, Z])
hist(Light[Transmittance<0.005, Z])
hist(Light[Transmittance<0.01, Z])
hist(Light[Transmittance<0.05, Z])


hist(Light[Transmittance>=1, Z])

```

```{r}
# plotly::plot_ly(Light[Z<=2,], x = ~X, y = ~Y, z = ~Z, color=~Transmittance)
```

## Plot light
```{r}
  # Remove edges
  # Light <- Light[X<90 & X> -90 & Y<90 & Y> -90]
  
  lattice::levelplot(Transmittance ~ X*Y, data = Light[Z<2,]) # Transmittance
  lattice::levelplot(Z~X*Y, data = Light[Z<2,]) # Z = Altitude
  
  ggplot(data = Light[Z<=2,], aes(x=X, y=Y, col = Transmittance)) + 
    geom_point() + 
    scale_fill_gradientn(name = "Transmittance",
                         colors = terrain.colors(30, rev=T),
                         na.value="white") +
    # ggtitle(paste("Paracou P16 4ha -", acq, "- Light map 1m", sep = " ")) +  
    theme_classic() +
    coord_sf()

# ggsave(paste("Paracou_P16_4ha_buffer_UAV_Lightmap_1m_intensity_1m.png", sep = ""),
#        path = "D:/Mes Donnees/PhD/Figures/Art",
#        width = 18, height = 20, units = "cm", dpi=800, bg="white")
```


# Trees coordinates and height
All the cirad trees on 25ha + ALT on 9 ha, with corrected coordinates and tree heights

```{r for the moment, eval=F}
# warning("put 25ha complete data")
# data <- read.csv(
#   "~/PhD/Inventories/Data/Understory/Paracou/ALT_Paracou_9ha_CLEAN.csv" # en attendant
# ) %>% 
#   # rename(SubPlot = Subplot) %>%
#   filter(Subplot %in% c(14,15,19,20)) %>% # TEMPORAIRE 4ha seulement # 16 014 rows
#   select(IdTree, Stem.nb, Xutm, Yutm) %>% 
#   unique() %>% # to remove duplicated idtree TEMPORAIRE
#   mutate(TreeHeight = sample(rep(1:10, length.out = n())))
# 
# data
# 
# IdTree <- unique(data$IdTree)
# data[!is.na(data$IdTree) & duplicated(data$IdTree),] 

# IDtrees <- data %>% select(idTree)
```

```{r at final}
data <- read.csv(
  "~/PhD/Inventories/Data/Adults_Understory/Paracou/AllP16_TreeHeights.csv" # at final
) %>% 
  # rename(SubPlot = Subplot) %>%
  # filter(SubPlot == 19) %>% # TEMPORAIRE 1ha seulement 
  select(idTree, ScientificName, Strategy, Xutm, Yutm, SubPlot, DBHcor, TreeHeight)

range(data$TreeHeight) # 1.980045 49.100730 -> 2.034959 49.109834 after coord cor

idTrees <- unique(data$idTree)
data[!is.na(data$idTree) & duplicated(data$idTree),] 

# IDtrees <- data %>% select(idTree)
```

## Extract Zutm for each tree
```{r}
MNT <- terra::rast("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/MNT/dtm2023_25ha_HighAlt_buffer.asc") 
crs(MNT) <- crs("EPSG:2972")

datasf <- st_as_sf(data, coords = c('Xutm','Yutm'))
datasf <- st_set_crs(datasf, st_crs(MNT)) 

alt <- extract(MNT, datasf) %>% # extract z
  rename(Zutm = `MNT_0.5m_IRD_500m_Paracou_284000_579500`)

data <- data %>% cbind(alt) %>% setDT()
# data
```

## Coordinates in local positions (use VOP) as light file
```{r}
VOP <- as.matrix(read.table("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/VOP/VOP_P16_25ha.txt"))

data <- setDT(data)

matrix <- as.matrix(data[, `:=`(c = 0 , d = 1)][,.(Xutm, Yutm, c, d)]) # as matrix of the same dimensions, without Z

datalocal <- matrix %*% t(VOP) # same dimensions

datalocal <- as.data.frame(cbind(datalocal, data[,Zutm]))[, -c(3,4)]  # add Zutm
names(datalocal) <- c("X","Y","Z")
datalocal <- datalocal %>% cbind(data[,.(SubPlot, idTree, ScientificName, Strategy, Xutm, Yutm, Zutm, DBHcor, TreeHeight)]) %>% setDT()
# datalocal
```

## Coordinates 1m above each tree
```{r}
datalocal[,Z := Z+TreeHeight+1] # zutm + tree height +1
range(datalocal$Z) # 9.714853 63.537480 -> 9.728229 63.679834 after coord cor

datalocal[Z>max(Light$Z),]

datalocal <- datalocal[Z<max(Light$Z),] # remove trees too tall


# datalocal
```

```{r}
summary(Light[, .(X, Y, Z)]) # max z=66
summary(datalocal[, .(X, Y, Z)]) # max tree height too big 72m -> 63m after coord cor
```

# Light per tree
```{r}
# Get neighbors in immediate neighborhood (k  nearest voxels including target)
result <- RANN::nn2(data = Light[, .(X, Y, Z)], # Pool to search
                    query = datalocal[, .(X, Y, Z)], # [1,], # point of interest
                    # The maximum number of nearest neighbours to compute
                    k = 8, # including target # 5, 8, 9, 15, 27, 30, 35, 35
                    # !!!mettre 8 et augmenter potentiellment le radius pour éviter les NA en bord de scene 
                    searchtype = "radius", radius = 4)
# k = 30, radius = 3
# k = 7, radius = 5

# une matrice où chaque ligne correspond à un point et contient les indices de ses voisins les plus proches
index <- result$nn.idx # the near neighbour indices
any(index==0)

# Light <- tibble::rownames_to_column(Light, "Rowname")
# Light[Rowname %in% c(8586286, 9077687, 8586285, 8585585, 8586987, 8586287, 9077686, 9076986, 9078388, 8094885, 9077688, 8585584, 8586986, 8585586, 8586988, 9076985, 9078387, 8094884, 8094184, 9076987, 8095586, 9078389, 8094886, 9569088, 8094183, 8095585, 8094185, 8095587, 8586284, 9569087),]

# Compute light from local neighborhood :
# each row of index is a point of interest

fill.value <- apply(index, 1, function(i) Light[as.vector(i), mean(Transmittance)] # for a matrix 1 indicates rows
)
any(fill.value==0 | is.na(fill.value))


datalocal$Transmittance <- fill.value  
```
```{r}
ggplot(datalocal, aes(x=TreeHeight, y=Transmittance, col=Strategy)) + 
  theme_minimal() +
  geom_point(size=0.3)
```

# Minimal values of transmittance
```{r, eval=F}
range(na.omit(datalocal$Transmittance)) # 0.0006453574 1.0000000894 -> 0.0002028763 1.0000000894 after coord cor
# 2019 :  0.0002724181 1.0000000032
hist(datalocal$Transmittance)
datalocal[Transmittance<0.001,] # 46 trees
range(datalocal[Transmittance<0.001, Z]) # 10.34081 27.12297
(nrow(datalocal[Transmittance<0.001,])/nrow(datalocal))*100 # 0.4% ->  0.4% after coord cor
# 2019 : 0.1%

hist(datalocal[Transmittance<0.001, TreeHeight]) # max tree height : 9m


toodark <- datalocal[Transmittance<0.001,]
length(unique(toodark$ScientificName)) # 36

table(toodark$ScientificName) # max 3 ind concerned

# -> on n'applique pas de seuillage supp sur la transmittance. on utilise les données telles quelles (Greg 08/2025)

# Median : moins bon
#  0.0003992877 1.0000000894
# [1] 14.53144 31.46755 m height
# [1] 0.15 %
# [1] 47 sp
```


# Compare light before and after coordines correction
```{r eval=F}
before <- read_csv("~/PhD/Inventories/Data/Adults_Understory/Paracou/AllP16_Light_before_coor_cor.csv") %>% # 47 875
  select(idTree, Transmittance) %>% 
  rename(Transmittance_before = Transmittance)

compare <- datalocal %>% 
  left_join(before, by="idTree") %>% 
  mutate(Diff = Transmittance-Transmittance_before)

range(compare$Diff) # -0.49  0.49 -> -4 3
median(compare$Diff) # -0.0004277387

ggplot(compare, aes(x=Diff)) +
  geom_histogram(binwidth=.01) +
  labs(x="Transmittance difference between before and after coordinates correction")

compare %>% 
  # filter(Diff >log(0.01)) %>% 
  ggplot(aes(x=(abs(Diff)))) +
  geom_histogram(binwidth=.01) +
  # scale_x_continuous(trans="log") +
  # stat_ecdf(geom = "step") + # en cumulé et %
  labs(x="Transmittance absolute difference between before and after coordinates correction")


# en x corrigé en y la diff en geom point
compare %>% 
  filter(abs(Diff) >0.01) %>%
  ggplot(aes(x=Transmittance, y = abs(Diff))) +
  geom_point() +
  scale_x_continuous(trans="log") +
  scale_y_continuous(trans="log") +
  geom_density_2d_filled(alpha = 0.5, contour_var = "count") +  geom_density_2d(linewidth = 0.25, colour = "black")
# level = % de la distribution concernée


(nrow(compare[abs(Diff)>0.01,])/nrow(compare))*100 # 43% 
(nrow(compare[abs(Diff)>0.05,])/nrow(compare))*100 # 7% 
```


# Write data
Inv (idTree, ScientificName, Xutm, Yutm, Zutm, DBHcor, TreeHeight) + Transmittance
```{r}
datalocal <- datalocal %>% select(idTree, SubPlot, ScientificName, Strategy, Xutm, Yutm, Zutm, DBHcor, TreeHeight, Z, Transmittance)

write.csv(datalocal, "~/PhD/Inventories/Data/Adults_Understory/Paracou/AllP16_Light_2019_-1m.csv") # 47 875
```

# Compare with light 1m higher
```{r}
library(patchwork)
# sp <- read.csv("D:/Mes Donnees/PhD/Inventories/Data/Understory/Paracou/InterestSpecies.csv")[,3] # 75

twoM <- read_csv("~/PhD/Inventories/Data/Adults_Understory/Paracou/AllP16_Light_2019_2m.csv") %>% 
  select(idTree, Xutm, Yutm, Transmittance) %>% 
  rename(Transmittance_2m = Transmittance)

zeroM <- read_csv("~/PhD/Inventories/Data/Adults_Understory/Paracou/AllP16_Light_2019_-1m.csv") %>% 
  select(idTree, Xutm, Yutm, Transmittance) %>% 
  rename(Transmittance_0m = Transmittance)

oneM <- read_csv("~/PhD/Inventories/Data/Adults_Understory/Paracou/AllP16_Light_2019.csv") %>% 
  # filter(ScientificName %in% sp) %>% 
  select(idTree, Xutm, Yutm, ScientificName, TreeHeight, Transmittance) %>% 
  rename(Transmittance_1m = Transmittance) %>% 
  left_join(twoM, by=c('idTree', 'Xutm', 'Yutm')) %>% 
  mutate(Diff_plus = Transmittance_2m*100 - Transmittance_1m*100) %>%
  left_join(zeroM, by=c('idTree', 'Xutm', 'Yutm')) %>% 
  mutate(Diff_moins = Transmittance_0m*100 - Transmittance_1m*100) %>%
  # mutate(Diff = exp(log(Transmittance_2m) - log(Transmittance_1m))) %>% 
  arrange(abs(Diff_moins)) # TreeHeight

range(oneM$Diff_plus) # -19  71 %
median(oneM$Diff_plus) # 0.2 %
quantile(oneM$Diff_plus, c(.05,.95)) # -0.6  6.9 %

nrow(oneM %>% filter(Diff_plus>10))/nrow(oneM)*100 # 3%

range(oneM$Diff_moins) # -72  15 %
median(oneM$Diff_moins) # 0.2 %
quantile(oneM$Diff_moins, c(.05,.95)) # -6.6  0.5 %

nrow(oneM %>% filter(abs(Diff_moins)>10))/nrow(oneM)*100 # 3%

sp_bias <- oneM %>% 
  group_by(ScientificName) %>% 
  summarise(median = median(abs(Diff))) %>% 
  arrange(desc(median))
max(sp_bias$median) # 1.7 % when filtred for the 75 studied species

P2 <- ggplot(oneM, aes(x=Diff_plus)) +
  theme_minimal() +
  geom_histogram(binwidth=1, fill="#69b3a2", color="#e9ecef", alpha=0.9) +
  theme(axis.title.y= element_blank(), axis.text.y= element_blank()) +
  labs(x='Transmittance (%) difference\nbetween at 1 and 2m above the tree')

P1 <- ggplot(oneM, aes(x=Diff_moins)) +
  theme_minimal() +
  geom_histogram(binwidth=1, fill="#69b3a2", color="#e9ecef", alpha=0.9) +
  labs(x='Transmittance (%) difference\nbetween at 1 and 0m above the tree', y = 'Number of observations')

P1 + P2

ggsave("Light_diff_1mvs2_and_0m_above_tree_hist.png",
       path = "//amap-data.cirad.fr/work/users/VincyaneBadouard/Modelisation/Plots/Light_topo/Autocor",
       width = 15, height = 8, units = "cm", dpi=800, bg="white")

ggplot(oneM, aes(x=Xutm, y=Yutm, col = abs(Diff_moins))) +
  theme_minimal() +
  geom_point() +
  viridis::scale_color_viridis() +
  labs(col ='Absolute transmittance (%)\ndifference between at 1\nand 2m above the tree')

ggsave("Light_diff_1mvs0m_above_tree_spatial_distrib.png",
       path = "//amap-data.cirad.fr/work/users/VincyaneBadouard/Modelisation/Plots/Light_topo/Autocor",
       width = 18, height = 15, units = "cm", dpi=800, bg="white")
```


# Check
```{r}
DATA <- Light[, .(X, Y, Z)] 

plot(DATA, pch=16, col="blue")
points(DATA[result$nn.idx[1,],], col="red", pch=19)  # Mettre en rouge les voisins du premier point

# Générer une palette de couleurs unique pour chaque point
colors <- rainbow(nrow(datalocal))  # Un dégradé de couleurs
# Créer un plot des points initiaux
plot(DATA, pch=16, col="black", main="Plus proches voisins avec couleurs par point")
# Tracer les voisins avec une couleur différente pour chaque ligne
for (i in 1:nrow(datalocal)) {
  neighbors <- result$nn.idx[i,]  # Indices des voisins
  points(DATA[neighbors,], col=colors[i], pch=19)  # Afficher les voisins avec la couleur associée
  segments(DATA[i,1], DATA[i,2], DATA[neighbors,1], DATA[neighbors,2], col=colors[i], lwd=2)  # Lignes entre le point et ses voisins
}
```

