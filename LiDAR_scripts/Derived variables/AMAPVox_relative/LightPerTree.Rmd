---
title: "LightPerTree"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

# Packages
```{r Setup, include = F}
library(tidyverse)
library(lidR)
library(readr)
library(data.table)
library(AMAPVox)
# library(rgl) # visulaisation 3D
library(terra)
# library(raster)
# library(lidR)
# library(tidyterra)
library(sf)
```

# Data
All the cirad trees on 25ha + ALT on 9 ha
```{r}
data <- read.csv("~/PhD/Inventories/Data/Adults_Understory/Paracou/AllP16_filtred.csv") %>% 
  filter(SubPlot==20) %>% # TEMPORAIRE
  select(idTree, Xutm, Yutm, TreeHeight, CrownHeight, CrownRadius) # 23 631 rows

idTrees <- unique(data$idTree)
data[!is.na(data$idTree) & duplicated(data$idTree),] 
```

# Create Voxel space
ALS low altitude; 25ha + 100m buffer ; 1 m resolution ; intensity echo weight

1/ VOP de la P16 (centre de rotation = centre de la parcelle) (done)

2/ il ne faut pas d'intensité nulle ->  non géré par AMAPVox (remplace les 0 que tu obtiens par arrondi, par 0.01 ou 0.001) (done)

3/ essaie de travailler avec la bounding box de ta zone d'intérêt si tu galères (sans VOP du coup)

```{r, eval= F}
# ST <- readLAS("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/LAZ/P16_2023_25ha_LowAlt_buffer_intensitycor.laz")
# range(ST@data$Intensity) # 1-40
# table(ST@data$Classification)
# plot(ST, color="Classification", legend = T)

# View(ST@data)
# Get the configuration file
xmlfile <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/Intensity_1m/XML/P16_2023_25ha_buffer_LowAlt_Vox_intensity1m.xml"
# Run
AMAPVox::run(jvm.option = "-Xms16g") # v. 2.3.2
AMAPVox::run(xml = xmlfile, jvm.option = "-Xms16g") # v. 2.3.2

```

# Fill empty voxels
*voir Fill_empty_voxels.Rmd*

# For each tree
```{r}
Tree <- data[1,] # temporaire
idTree <- Tree$idTree
```

## Extract Zutm for each tree
```{r}
MNT <- terra::rast("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/MNT/dtm2023_LowAlt_25 ha_buffer.asc")
ROI <- terra::vect("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Plot16_25ha_buffer.shp") %>% st_as_sf() %>% st_set_crs(2972)
Treesf <- st_as_sf(Tree, coords = c('Xutm','Yutm'))
Treesf <- st_set_crs(Treesf, st_crs(ROI)) 

crs(MNT) <- crs(ROI)

alt <- extract(MNT, Treesf) %>% # extract z
  rename(Zutm = `dtm2023_LowAlt_25 ha_buffer`)

Tree <- Tree %>% cbind(alt)
foot <- Tree %>% select(Xutm, Yutm, Zutm) %>% setDT()
```

## Coordinates in local positions (use VOP)
```{r}
VOP <- as.matrix(read.table("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/VOP_P16_25ha.txt"))

matrix <- as.matrix(foot[, `:=`(c = 0 , d = 1)][,.(Xutm, Yutm, c, d)]) # as matrix of the same dimensions, without Z

footlocal <- matrix %*% t(VOP) # same dimensions

footlocal <- as.data.frame(cbind(footlocal, foot[,Zutm]))[, -c(3,4)]  # add Zutm
names(footlocal) <- c("x","y","z")
footlocal$ID <- "foot" 
```

## Create crown's bounding box
TreeHeight, CrownHeight, CrownRadius
```{r}
# 8 points
CrownRadius <- Tree$CrownRadius
TreeHeight <- Tree$TreeHeight
CrownHeight <- Tree$CrownHeight

lowleftfront = c(x = footlocal$x - CrownRadius, # left
                 y = footlocal$y + CrownRadius, # front
                 z = footlocal$z + (TreeHeight - CrownHeight)) # low
lowrightfront = c(x = footlocal$x + CrownRadius, # rght
                  y = footlocal$y + CrownRadius, # front
                  z = footlocal$z + (TreeHeight - CrownHeight)) # low

lowleftback = c(x = footlocal$x - CrownRadius, # left
                y = footlocal$y - CrownRadius, # back
                z = footlocal$z + (TreeHeight - CrownHeight)) # low
lowrightback = c(x = footlocal$x + CrownRadius, # right
                 y = footlocal$y - CrownRadius, # back
                 z = footlocal$z + (TreeHeight - CrownHeight)) # low

Highleftfront = c(x = footlocal$x - CrownRadius, # left
                  y = footlocal$y + CrownRadius, # front
                  z = footlocal$z + TreeHeight) # high
Highrightfront = c(x = footlocal$x + CrownRadius, # right
                   y = footlocal$y + CrownRadius, # front
                   z = footlocal$z + TreeHeight) # high

Highleftback = c(x = footlocal$x - CrownRadius, # left
                 y = footlocal$y - CrownRadius, # back
                 z = footlocal$z + TreeHeight) # high
Highrightback = c(x = footlocal$x + CrownRadius, # right
                  y = footlocal$y - CrownRadius, # back
                  z = footlocal$z + TreeHeight) # high

# Coordinates in the crown
CrownBase = c(x = footlocal$x, # as foot
              y = footlocal$y, # as foot
              z = footlocal$z + (TreeHeight - CrownHeight)) # base


points <- as.data.frame(rbind(lowleftfront, lowrightfront,
                              lowleftback, lowrightback,
                              Highleftfront, Highrightfront,
                              Highleftback, Highrightback,
                              CrownBase)) %>% 
  rownames_to_column(var= "ID") %>% setDT() %>% rbind(footlocal)

plotly::plot_ly(points, x = ~x, y = ~y, z = ~z, color= ~ID)

# Crown bounding box
boundingbox <- points %>% filter(ID != 'foot' & ID != "CrownBase") 

# Where estimate light
CrownBase <- points %>% filter(ID == "CrownBase")
```

## Empties crown voxels
Put 0 to attenatuation (HLE)
```{r}
VX <- readVoxelSpace("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/Intensity_1m/P16_2023_4ha_buffer_LowAlt_PadHLE_intensity1m.vox"
                     # "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/Intensity_1m/P16_2023_LowAlt_PadHLE_25ha_buffer_intensity1m.vox"
)
# View(test@data)

# i, j, k = index not coordinates
VX@data[, c("x", "y", "z") := getPosition(VX)[, .(x, y, z)]] # in relative coordinates
```

### Modify HLE and PAD
```{r}
VX@data[x>= min(boundingbox$x) & x <= max(boundingbox$x) & 
          y>= min(boundingbox$y) & y <= max(boundingbox$y) & 
          z>= min(boundingbox$z) & z <= max(boundingbox$z), `:=`(HLE = 0 , PadBVTotal = 0)] # empty voxels, PadBVTotal = 2*HLE

test <- VX
test@data <- VX@data[x>= min(boundingbox$x) & x <= max(boundingbox$x) & 
                            y>= min(boundingbox$y) & y <= max(boundingbox$y) & 
                            z>= min(boundingbox$z) & z <= max(boundingbox$z),] # 1331 vxls
AMAPVox::plot(test)

AMAPVox::plot(VX, variable.name = "HLE")
```


## Crop voxel space
100m in x, y around the crown
```{r}
I <- range(VX@data[x>=(-90) & x<=190 & y<=190,][z<66,i]) # 1m: 61 340 ; 2m: 31 170
J <- range(VX@data[x>=(-90) & x<=190 & y<=190,][z<66,j]) # 1m:  0 340 ; 2m: 0 170
K <- range(VX@data[x>=(-90) & x<=190 & y<=190,][z<66,k]) # 1m:  0 66 ; 2m: 0 33

VX <- crop(VX, imin = I[1], imax = I[2], jmin = J[1], jmax = J[2], kmin = K[1], kmax = K[2]) 

range(VX@data$z)

prod(VX@header$dim) == nrow(VX@data) # doit etre cohérent

AMAPVox::plot(VX, variable.name = "ground_distance") 

```

```{r}
writeVoxelSpace(VX, 
                paste("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/Intensity_1m/P16_2023_LowAlt_25ha_buffer_intensity1m_",idTree,".vox", sep="")
)
```





## Edit xml file
https://lecy.github.io/Open-Data-for-Nonprofit-Research/Quick_Guide_to_XML_in_R.html
```{r}
# Input voxelspace
paste("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/Intensity_1m/P16_2023_LowAlt_25ha_buffer_intensity1m_",idTree,".vox", sep="")

# Output path
paste("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/Intensity_1m/P16_2023_25ha_LowAlt_Light_intensity1m_",idTree,".txt", sep="")

# Coordinates
# <scanners-positions>
#       <position x= CrownBase$x y=  CrownBase$y z=  CrownBase$z />
#       <position x= X2 y= Y2 z= Z2 />
#       <position x= X3 y= Y3 z= Z3 />

# File name
paste("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/Intensity_1m/XML/Light/P16_2023_LowAlt_25ha_buffer_Light_intensity1m_",idTree,".xml", sep="")

```

## Compute light for the tree
```{r}
# Get the configuration file
xmlfile <- paste("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/Intensity_1m/XML/Light/P16_2023_LowAlt_25ha_buffer_Light_intensity1m_",idTree,".xml", sep="")
# Run
AMAPVox::run(xml = xmlfile, jvm.option = "-Xms16g")

```

