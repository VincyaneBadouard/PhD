---
title: "LightPerTree"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

**TOUT PASSER EN HIGH ALT 25HA BUFFER 50M + fill empty vox**
**quel inventaire cirad ?**
```{r}
warning("TOUT PASSER EN HIGH ALT 25HA BUFFER 50M + fill empty vox")  
warning("quel inventaire cirad ?")  
```
# Packages
```{r Setup, include = F}
library(tidyverse)
library(lidR)
library(readr)
library(data.table)
library(AMAPVox)
library(terra)
library(sf)
library(xml2)
```


# Data
All the cirad trees on 25ha + ALT on 9 ha
```{r}
data <- read.csv(
  "~/PhD/Inventories/Data/Adults_Understory/Paracou/AllP16_filtred.csv"
  # "~/PhD/Inventories/Data/Understory/Paracou/ALT_Paracou_9ha_Filtred.csv"
) %>% 
  # rename(SubPlot = Subplot) %>%
  filter(SubPlot==20) %>% # TEMPORAIRE
  select(idTree, Xutm, Yutm, TreeHeight, CrownHeight, CrownRadius) # 23 631 rows

idTrees <- unique(data$idTree)
data[!is.na(data$idTree) & duplicated(data$idTree),] 

# IDtrees <- data %>% select(idTree)
# write.table(IDtrees, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/ByTree_Input/IDtrees.txt", sep=";")
```

# Create Voxel space (A FAIRE, bug)
ALS High altitude (pcq meilleur couverture des lignes de vol); 25ha + 50m buffer ; 1 m resolution ; intensity echo weight

1/ VOP de la P16 (centre de rotation = centre de la parcelle) (done)

2/ il ne faut pas d'intensité nulle ->  non géré par AMAPVox (remplace les 0 que tu obtiens par arrondi, par 0.01 ou 0.001) (done)

3/ essaie de travailler avec la bounding box de ta zone d'intérêt si tu galères (sans VOP du coup)

```{r, eval= F}
ST <- readLAS("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/LAZ/P16_2023_25ha_HighAlt_buffer50m_intensitycor.laz")
range(ST@data$Intensity) # 12-6251
table(ST@data$Classification)
plot(ST, color="Classification", legend = T)

# View(ST@data)
# Get the configuration file
xmlfile <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_1m/XML/P16_2023_25ha_buffer_HighAlt_Vox_intensity1m.xml"
# Run
AMAPVox::run(jvm.option = "-Xms16g") # v. 2.3.2
AMAPVox::run(xml = xmlfile, jvm.option = "-Xms16g") # v. 2.3.2

```

# Fill empty voxels (A FAIRE)
*voir Fill_empty_voxels.Rmd*

# For each tree
```{r}
Tree <- data[10,] # temporaire
idTree <- Tree$idTree
```

## Extract Zutm for each tree
```{r}
MNT <- terra::rast("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/MNT/dtm2023_LowAlt_25 ha_buffer.asc") 
crs(MNT) <- crs("EPSG:2972")

Treesf <- st_as_sf(Tree, coords = c('Xutm','Yutm'))
Treesf <- st_set_crs(Treesf, st_crs(MNT)) 

alt <- extract(MNT, Treesf) %>% # extract z
  rename(Zutm = `dtm2023_LowAlt_25 ha_buffer`)

Tree <- Tree %>% cbind(alt)
foot <- Tree %>% select(Xutm, Yutm, Zutm) %>% setDT()
```

## Coordinates in local positions (use VOP)
```{r}
VOP <- as.matrix(read.table("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/VOP_P16_9ha.txt"))
# A CHANGER POUR 25ha

matrix <- as.matrix(foot[, `:=`(c = 0 , d = 1)][,.(Xutm, Yutm, c, d)]) # as matrix of the same dimensions, without Z

footlocal <- matrix %*% t(VOP) # same dimensions

footlocal <- as.data.frame(cbind(footlocal, foot[,Zutm]))[, -c(3,4)]  # add Zutm
names(footlocal) <- c("x","y","z")
footlocal$ID <- "foot" 
```

## Create crown's bounding box
TreeHeight, CrownHeight, CrownRadius
```{r}
# 8 points
CrownRadius <- Tree$CrownRadius
TreeHeight <- Tree$TreeHeight
CrownHeight <- Tree$CrownHeight

lowleftfront = c(x = footlocal$x - CrownRadius, # left
                 y = footlocal$y + CrownRadius, # front
                 z = footlocal$z + (TreeHeight - CrownHeight)) # low
lowrightfront = c(x = footlocal$x + CrownRadius, # rght
                  y = footlocal$y + CrownRadius, # front
                  z = footlocal$z + (TreeHeight - CrownHeight)) # low

lowleftback = c(x = footlocal$x - CrownRadius, # left
                y = footlocal$y - CrownRadius, # back
                z = footlocal$z + (TreeHeight - CrownHeight)) # low
lowrightback = c(x = footlocal$x + CrownRadius, # right
                 y = footlocal$y - CrownRadius, # back
                 z = footlocal$z + (TreeHeight - CrownHeight)) # low

Highleftfront = c(x = footlocal$x - CrownRadius, # left
                  y = footlocal$y + CrownRadius, # front
                  z = footlocal$z + TreeHeight) # high
Highrightfront = c(x = footlocal$x + CrownRadius, # right
                   y = footlocal$y + CrownRadius, # front
                   z = footlocal$z + TreeHeight) # high

Highleftback = c(x = footlocal$x - CrownRadius, # left
                 y = footlocal$y - CrownRadius, # back
                 z = footlocal$z + TreeHeight) # high
Highrightback = c(x = footlocal$x + CrownRadius, # right
                  y = footlocal$y - CrownRadius, # back
                  z = footlocal$z + TreeHeight) # high

# Coordinates in the crown
CrownBase = c(x = footlocal$x, # as foot
              y = footlocal$y, # as foot
              z = footlocal$z + (TreeHeight - CrownHeight)) # base
CrownCentre = c(x = footlocal$x, # as foot
                y = footlocal$y, # as foot
                z = footlocal$z + (TreeHeight - CrownHeight/2)) # base


points <- as.data.frame(rbind(lowleftfront, lowrightfront,
                              lowleftback, lowrightback,
                              Highleftfront, Highrightfront,
                              Highleftback, Highrightback,
                              CrownBase, CrownCentre)) %>% 
  rownames_to_column(var= "ID") %>% setDT() %>% rbind(footlocal)

plotly::plot_ly(points, x = ~x, y = ~y, z = ~z, color= ~ID)

# Crown bounding box in relative coord
boundingbox <- points %>% filter(ID != 'foot' & ID != "CrownBase" & ID != "CrownCentre")
source("~/PhD/R_codes/PhD/LiDAR_scripts/Functions/Relative2UTM.R")
boundingboxUTM <- Relativ2UTM(boundingbox, VOP)

# Where estimate light
CrownLight <- points %>% filter(ID == "CrownBase" | ID == "CrownCentre")
```

## Bounding box in the laz (to check)
```{r, eval=F}
ST <- readLAS("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/LAZ/P16_2023_4ha_HighAlt_buffer_intensitycor.laz")

ST@data <- ST@data[X>= min(boundingboxUTM$Xutm) & X <= max(boundingboxUTM$Xutm) & 
                     Y>= min(boundingboxUTM$Yutm) & Y <= max(boundingboxUTM$Yutm) & 
                     Z>= min(boundingboxUTM$Zutm) & Z <= max(boundingboxUTM$Zutm),]

plot(ST)
```

## Empties crown voxels
Put 0 to attenatuation (HLE)
```{r}
VX <- readVoxelSpace("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_1m/P16_2023_4ha_buffer_HighAlt_PadHLE_intensity1m.vox"
                     # "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_1m/P16_2023_HighAlt_PadHLE_25ha_buffer_intensity1m.vox"
)
# View(test@data)

# i, j, k = index not coordinates
VX@data[, c("x", "y", "z") := getPosition(VX)[, .(x, y, z)]] # in relative coordinates
```

### Modify HLE and PAD
```{r}
VX@data[x>= min(boundingbox$x) & x <= max(boundingbox$x) &
          y>= min(boundingbox$y) & y <= max(boundingbox$y) &
          z>= min(boundingbox$z) & z <= max(boundingbox$z), `:=`(HLE = 0 , PadBVTotal = 0)] # empty voxels, PadBVTotal = 2*HLE

VX@data[x>= min(boundingbox$x) & x <= max(boundingbox$x) &
          y>= min(boundingbox$y) & y <= max(boundingbox$y) &
          z>= min(boundingbox$z) & z <= max(boundingbox$z), ]

# Check
# test <- VX
# I <- range(test@data[x>= min(boundingbox$x) & x <= max(boundingbox$x) & 
#                        y>= min(boundingbox$y) & y <= max(boundingbox$y) & 
#                        z>= min(boundingbox$z) & z <= max(boundingbox$z), i]) 
# J <- range(test@data[x>= min(boundingbox$x) & x <= max(boundingbox$x) & 
#                        y>= min(boundingbox$y) & y <= max(boundingbox$y) & 
#                        z>= min(boundingbox$z) & z <= max(boundingbox$z), j])  
# K <- range(test@data[x>= min(boundingbox$x) & x <= max(boundingbox$x) & 
#                        y>= min(boundingbox$y) & y <= max(boundingbox$y) & 
#                        z>= min(boundingbox$z) & z <= max(boundingbox$z), k]) 
# 
# test_crop <- AMAPVox::crop(test, imin = I[1], imax = I[2], jmin = J[1], jmax = J[2], kmin = K[1], kmax = K[2])
# 
# prod(test_crop@header$dim) == nrow(test_crop@data) # doit etre cohérent
# View(test_crop@data) 
# AMAPVox::plot(test_crop, variable.name = "PadBVTotal", voxel.size = 5) 
```

## Crop voxel space with a 50m buffer around the crown
50m in x,y,z around the crown
```{r}
# range(VX@data$x) # -150.1270  249.3395
# range(VX@data$y) # -150.4118  249.2358
# range(VX@data$z) # 0.0000 102.6534

subset <- VX@data[x >= max(min(boundingbox$x)-50, min(VX@data$x)) & # xmin
                    x <= min(max(boundingbox$x)+50, max(VX@data$x)) & # xmax
                    y >= max(min(boundingbox$y)-50, min(VX@data$y)) & # ymin
                    y <= min(max(boundingbox$y)+50, max(VX@data$y)) & # ymax
                    z >= max(min(boundingbox$z)-50, min(VX@data$z)) & # zmin
                    z <= min(max(boundingbox$z)+50, max(VX@data$z)), .(i,j,k)] # zmax
I <- range(subset$i) 
J <- range(subset$j) 
K <- range(subset$k) 

VX_crop <- AMAPVox::crop(VX, imin = I[1], imax = I[2], jmin = J[1], jmax = J[2], kmin = K[1], kmax = K[2]) 

# prod(VX_crop@header$dim) == nrow(VX_crop@data) # doit etre cohérent

# AMAPVox::plot(VX_crop, variable.name = "PadBVTotal") 

# Only necessary columns
VX_crop@data <- VX_crop@data[, .(i,j,k, PadBVTotal)] 
```

```{r}
writeVoxelSpace(VX_crop, 
                paste("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_1m/ByTree/Tree_Vox/P16_2023_HighAlt_25ha_buffer_intensity1m_",idTree,".vox", sep="")
)
```


## Edit xml file
https://lecy.github.io/Open-Data-for-Nonprofit-Research/Quick_Guide_to_XML_in_R.html
```{r}
xml_file0 <- read_xml(
  # "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_1m/ByTree/XML/P16_2023_HighAlt_4ha_buffer_Light_template_intensity1m.xml"
  "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_1m/ByTree/XML/P16_2023_HighAlt_4ha_buffer_Light_template_severalpts_intensity1m.xml"
)

# Input voxelspace
VXin <- paste("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_1m/ByTree/Tree_Vox/P16_2023_HighAlt_25ha_buffer_intensity1m_",idTree,".vox", sep="")

# Output path
Outputpath <- paste(
  # "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_1m/ByTree/Tree_Light/P16_2023_25ha_HighAlt_Light_intensity1m_",
  "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_1m/ByTree/Tree_Light/P16_2023_25ha_HighAlt_Light_severalpts_intensity1m_",
  
  idTree,".txt", sep="")

# get node configuration/process
process <- xml_children(xml_file0)[[1]]

# update current input file
input_node <- xml_child(process, "input_file")
xml_attr(input_node, "src") <- VXin

# update current output file
output_node <- xml_child(xml_child(process, "output_files"))
xml_attr(output_node, "src") <- Outputpath

# update coordinates
# coord_node <- xml_child(xml_child(process, "scanners-positions"))
# xml_attr(coord_node, "x") <- as.character(CrownLight[ID=="CrownBase"]$x)
# xml_attr(coord_node, "y") <- as.character(CrownLight[ID=="CrownBase"]$y)
# xml_attr(coord_node, "z") <- as.character(CrownLight[ID=="CrownBase"]$z)


# If several points:
coord_node <- xml_child(process, "scanners-positions")
coord_1 <- xml_find_first(process, "//position[1]")
xml_attr(coord_1, "x") <- as.character(CrownLight[ID=="CrownBase"]$x)
xml_attr(coord_1, "y") <- as.character(CrownLight[ID=="CrownBase"]$y)
xml_attr(coord_1, "z") <- as.character(CrownLight[ID=="CrownBase"]$z)
coord_2 <- xml_find_first(process, "//position[2]")
xml_attr(coord_2, "x") <- as.character(CrownLight[ID=="CrownCentre"]$x)
xml_attr(coord_2, "y") <- as.character(CrownLight[ID=="CrownCentre"]$y)
xml_attr(coord_2, "z") <- as.character(CrownLight[ID=="CrownCentre"]$z)


# File name
xml_fileT <- paste(
  # "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_1m/ByTree/XML/Light/P16_2023_HighAlt_25ha_buffer_Light_intensity1m_", # 1 point
  "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_1m/ByTree/XML/P16_2023_HighAlt_4ha_buffer_Light_severalpts_intensity1m_", # several points
  idTree,".xml", sep=""
)
write_xml(xml_file0, xml_fileT)

```

## Compute light for the tree
Distribution plagiophile des feuilles
Pendant 1 an
```{r}
# Run
AMAPVox::run(jvm.option = "-Xms16g") # v. 2.3.2
AMAPVox::run(xml = xml_fileT, jvm.option = "-Xms16g") # v. 2.3.2
```

# Apply function for the all the trees
```{r}
# gc()
# lapply(data$idTree, LightPerTree, data=data, MNT=MNT, VOP=VOP, VX=VX)
```

# Check light results (pas sur cluster)
```{r}
source("~/PhD/R_codes/PhD/LiDAR_scripts/Functions/ReadLightFile.R")
path_1pt <- paste("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_1m/ByTree/Tree_Light/P16_2023_25ha_HighAlt_Light_intensity1m_", idTree,".txt", sep="")

path_2pts <- paste("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_1m/ByTree/Tree_Light/P16_2023_25ha_HighAlt_Light_severalpts_intensity1m_", idTree,".txt", sep="")


Light_1pt <- ReadLightFile(path_1pt, skiplines=9)
Light_2pts <- ReadLightFile(path_2pts, skiplines=9)
Light_1pt;Light_2pts # 0.5603481 ; 0.8722726	
```

```{r}
filenames <- list.files("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_1m/ByTree/Tree_Light", pattern="*.txt", full.names=TRUE) # catch the name of all the files of the folder

df_list <- lapply(filenames, ReadLightFile, skiplines=9) # read all the folder files

# keep the idTree
files <- str_remove(filenames, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_1m/ByTree/Tree_Light/P16_2023_25ha_HighAlt_Light_severalpts_intensity1m_")
files <- str_remove(files, ".txt")
names(df_list) <- files

datalight <- bind_rows(df_list, .id = "idTree") # bind all dat with an idTree column

write.csv(datalight, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_1m/ByTree/AllTreesLight.csv")
```

