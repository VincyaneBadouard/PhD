---
title: "Compare LiDAR with field sensors data"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: pdf_document
---


# LAI2200

## Positionner capteurs LAI2200 sur la carte de lumière dans AMAPvox

A cette étape la transmittance est calculée à des **angles déterminés** à **lumière diffuse du soleil** (+ sensible à l'erreur d'échantillonage du LiDAR).

## Metadata
* Ring : secteur angulaire, allant du zénith à l'horizon.
* transmittance
* GAP[1-5] : Gap fraction based on average of the log of the individual transmittances directionnelles calculées par positions (posX, posY, posZ) et par secteur angulaire (1 à 5) (pas intéressant pour nous)
* LAI (pas fiable)

* pathLength => distance entre position et sortie de la canopée

* isOut? => le rayon testé est-il arrivé en limite de l'espace voxel avant d'arriver en sortie de canopée ?

* azimut, elevation => les coordonnées sphériques du rayon
* cross_NA => le rayon a-til rencontré un voxel non échantilloné sur son trajet (voxel NA) ?

```{r Setup, include = F}
library(tidyverse)
library(data.table)
library(sf)
library(terra)
library(tidyverse)
library(corrplot)
library(RColorBrewer)
```

```{r}
zone <- st_as_sf(vect("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2022/Parcelles_Understory.shp")) # 4 carrés
```

## Load LiDAR data
LAI_GAP : "posX", "posY", "posZ", "LAI", "GAP[1]" "GAP[2]" "GAP[3]" "GAP[4]" "GAP[5]"
trans : "position.x", "position.y", "position.z", "ring", "transmittance", azimut

```{r, include = F}
Read_LAI2200_Transfile <- function(path){
  data <- read_table(path) %>% 
    # mutate(LiDAR = "HighAlt") %>% 
    rename(Transmittance = transmittance) %>% 
    select(-c(position.ID, pathLength, isOut, elevation, cross_NA))
}

# Weighted by intensity 
## ALS
HighAnnual_int2m <- unique(Read_LAI2200_Transfile("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_2m/P16_2023_HighAlt_4ha_buffer_LAI2200sim_coordshiftQgis_intensity2m_test.txt"))
LowAnnual_int2m <- unique(Read_LAI2200_Transfile("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/Intensity_2m/P16_2023_LowAlt_4ha_buffer_LAI2200sim_coordshiftQgis_intensity2m_test.txt"))

HighAnnual_int1m <- unique(Read_LAI2200_Transfile("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Intensity_1m/P16_2023_HighAlt_4ha_buffer_LAI2200sim_coordshiftQgis_intensity1m_test.txt"))
LowAnnual_int1m <- unique(Read_LAI2200_Transfile("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/Intensity_1m/P16_2023_LowAlt_4ha_buffer_LAI2200sim_coordshiftQgis_intensity1m_test.txt"))

## UAV
UAV_int2m <- unique(Read_LAI2200_Transfile("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/HovermapUAV2023/AMAPVox/Intensity_2m/P16_2023_UAV_4ha_bufferALS_LAI2200sim_coordshiftQgis_intensity2m_test.txt")) %>% mutate(Transmittance = as.numeric(Transmittance))
UAV_int1m <- unique(Read_LAI2200_Transfile("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/HovermapUAV2023/AMAPVox/Intensity_1m/P16_2023_UAV_4ha_bufferALS_LAI2200sim_coordshiftQgis_intensity1m_test.txt")) %>% mutate(Transmittance = as.numeric(Transmittance))

# DZ
# DZ <- (Read_LAI2200_Transfile("//amap-data.cirad.fr/work/users/VincyaneBadouard/DZ_test/AMAPVox/Paracou_2023_HighAlt_DZ_buffer_LAI2200sim_intensity1m_test.txt")) %>%
#   # group_by(position.x, position.y) %>%
#   mutate(ID = as.factor((group_indices(., position.x, position.y))))

# Equal echo weighting 
# HighAnnual_equal2m <- unique(Read_LAI2200_Transfile("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/Equal_echo_2m/P16_2023_HighAlt_4ha_buffer_LAI2200sim_Equalecho2m_test.txt"))
# LowAnnual_equal2m <- unique(Read_LAI2200_Transfile("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/Equal_echo_2m/P16_2023_4ha_buffer_LowAlt_LAI2200sim_equalecho2m_test.txt"))
```

```{r,eval = F}
nrow(unique(HighAnnual_int2m %>% select(position.x,position.y,position.z))) # 45
nrow(unique(LowAnnual_int2m %>% select(position.x,position.y,position.z))) # 45
nrow(unique(HighAnnual_int1m %>% select(position.x,position.y,position.z))) # 45
nrow(unique(LowAnnual_int1m %>% select(position.x,position.y,position.z))) # 45
nrow(unique(UAV_int2m %>% select(position.x,position.y,position.z))) # 45
nrow(unique(UAV_int1m %>% select(position.x,position.y,position.z))) # 45

# nrow(unique(HighAnnual_equal2m %>% select(position.x,position.y,position.z))) # 45
# nrow(unique(LowAnnual_equal2m %>% select(position.x,position.y,position.z))) # 45
# 45 <- 20+26 LAI2200 dont 1 en commun
```

# Fusion
```{r, include = F}
LiDAR <- HighAnnual_int2m %>%
  left_join(LowAnnual_int2m, by= c("position.x", "position.y", "position.z", "ring", "azimut"), suffix = c("_HighInt2m", "_LowInt2m"))

oneM <- HighAnnual_int1m %>%
  left_join(LowAnnual_int1m, by= c("position.x", "position.y", "position.z", "ring", "azimut"), suffix = c("_HighInt1m", "_LowInt1m")) %>% 
  unique()

UAV <- UAV_int2m %>%
  left_join(UAV_int1m, by= c("position.x", "position.y", "position.z", "ring", "azimut"), suffix = c("_UAVInt2m", "_UAVInt1m")) 

LiDAR <- LiDAR %>%
  left_join(oneM, by= c("position.x", "position.y", "position.z", "ring", "azimut")) %>%
  left_join(UAV, by= c("position.x", "position.y", "position.z", "ring", "azimut")) %>% 
  unique()

# EqualEch <- HighAnnual_equal2m %>%
#   left_join(LowAnnual_equal2m, by= c("position.x", "position.y", "position.z", "ring", "azimut"), suffix = c("_HighEqual2m", "_LowEqual2m"))
# 
# LiDAR <- LiDAR %>%
#   left_join(EqualEch, by= c("position.x", "position.y", "position.z", "ring", "azimut")) %>% 
#   unique()

rm(HighAnnual_int2m, LowAnnual_int2m, HighAnnual_int1m, LowAnnual_int1m, HighAnnual_equal2m, LowAnnual_equal2m, EqualEch, Read_LAI2200_Transfile, UAV_int1m, UAV_int2m)
```

# Rings & azimuts
```{R, eval = F}
RingAzimut <- LiDAR %>% 
  select(ring, azimut) %>% 
  unique()

RingAzimut %>% group_by(ring) %>% summarise(N = n())

ggplot(RingAzimut, aes(x = ring)) +
  # Inetnsity
  geom_point(aes(y = azimut))
# geom_line(aes(y = azimut, colour = Ring)) 
```

# Average azimut data
moyenne, ecart-type et l'erreur standard par capteur et par ring sur les azimuts
```{r, include = F}
LiDAR <- LiDAR %>% 
  group_by(`position.x`, `position.y`, `position.z`, ring) %>%
  # ALS
  mutate(MeanTransmittance_HighInt2m = mean(Transmittance_HighInt2m)) %>%
  mutate(SdTransmittance_HighInt2m = sd(Transmittance_HighInt2m)) %>% 
  mutate(SeTransmittance_HighInt2m = plotrix::std.error(Transmittance_HighInt2m)) %>%
  
  mutate(MeanTransmittance_LowInt2m = mean(Transmittance_LowInt2m)) %>%
  mutate(SdTransmittance_LowInt2m = sd(Transmittance_LowInt2m)) %>%
  mutate(SeTransmittance_LowInt2m = plotrix::std.error(Transmittance_LowInt2m)) %>%
  ## 1m
  mutate(MeanTransmittance_HighInt1m = mean(Transmittance_HighInt1m)) %>%
  mutate(SdTransmittance_HighInt1m = sd(Transmittance_HighInt1m)) %>%
  mutate(SeTransmittance_HighInt1m = plotrix::std.error(Transmittance_HighInt1m)) %>%
  
  mutate(MeanTransmittance_LowInt1m = mean(Transmittance_LowInt1m)) %>%
  mutate(SdTransmittance_LowInt1m = sd(Transmittance_LowInt1m)) %>%
  mutate(SeTransmittance_LowInt1m = plotrix::std.error(Transmittance_LowInt1m)) %>%
  
  # UAV
  mutate(MeanTransmittance_UAVInt2m = mean(Transmittance_UAVInt2m)) %>%
  mutate(SdTransmittance_UAVInt2m = sd(Transmittance_UAVInt2m)) %>% 
  mutate(SeTransmittance_UAVInt2m = plotrix::std.error(Transmittance_UAVInt2m)) %>%
  
  mutate(MeanTransmittance_UAVInt1m = mean(Transmittance_UAVInt1m)) %>%
  mutate(SdTransmittance_UAVInt1m = sd(Transmittance_UAVInt1m)) %>%
  mutate(SeTransmittance_UAVInt1m = plotrix::std.error(Transmittance_UAVInt1m)) %>%
  
  ungroup()
```

# DZ
```{r, include = F}
LiDAR <- DZ %>%
  filter(ID==2) %>% 
  group_by(`position.x`, `position.y`, `position.z`, ring) %>%
  mutate(MeanTransmittance = mean(Transmittance)) %>%
  mutate(SdTransmittance = sd(Transmittance)) %>%
  mutate(SeTransmittance = plotrix::std.error(Transmittance)) %>%
  ungroup() %>%
  select(!c(azimut, Transmittance, `position.x`, `position.y`, `position.z`,)) %>%
  unique()

DZ %>% filter(ID==2) %>%# mutate(azimut= sort(abs(azimut), decreasing = T)) %>% 
  ggplot(aes(x = ID, y= Transmittance)) +
  geom_point(aes(col = azimut)) +
  # theme_minimal() +
  scale_colour_gradient2(name = "Azimut (°)", low=scales::muted("lightblue"), high=scales::muted("lightblue"), mid = "red", midpoint = 0, space = "Lab") +
  facet_grid(vars(as.factor(ring)), scales = "free_y") +
  geom_hline(data = LiDAR, aes(yintercept = MeanTransmittance, linetype='Mean')) +
  geom_text(data = LiDAR,
            mapping = aes(y = MeanTransmittance,
                          label= as.character(round(MeanTransmittance, 2))),
            hjust = -1, vjust = 1.3, size = 3) +
  scale_linetype_manual(name = "", values = "dashed") +
  scale_y_continuous(labels = scales::label_number(accuracy = 0.01)) +
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(),
        # axis.title.y= element_text(size=14), axis.text.y= element_text(size=14),
        # legend.title= element_text(size=14), legend.text= element_text(size=14),
        plot.margin = unit(c(0.2,3,0.2,3),"cm")) +
  labs(y = "Transmittance")

ggsave("DZ_transmittances_mean.png",
       path = "D:/Mes Donnees/PhD/Figures/lidar/",
       width = 15, height = 22, units = "cm", dpi=800, bg="white")
```

## Local to UTM coord
```{r}
# Lecture matrice de transformation
VOP <- as.matrix(read.table("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/VOP_P16_9ha.txt"))

# Apply inverse of VOP matrix to convert back to UTM
LiDAR <- setDT(LiDAR)
xyz <- tcrossprod(as.matrix(LiDAR[, .(position.x, position.y, position.z, c=1)]), solve(VOP))
LiDAR[, `:=`(Xutm = xyz[, 1], Yutm = xyz[, 2], Zutm = xyz[, 3])]
LiDAR <- setDF(LiDAR) %>% rename(Ring= ring) %>%
  mutate(Xutm = round(Xutm),
         Yutm = round(Yutm),
         Zutm = round(Zutm))
rm(VOP,xyz)
```

## Load LAI2200 data
```{r, include = F}
LAI2200_coord <- read_csv("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Coordinates/LAI2200_coordshift_Qgis_local.csv") # LAI2200 sensors coordinates
LAI2200_data <- read_csv("D:/Mes Donnees/PhD/Microclimate/Light/LAI-2200/LAI2200_data.csv") # LAI2200 sensors data

LAI2200_data <- LAI2200_data %>% 
  mutate(Ring = case_when(
    Ring == "Ring1" ~ 1,
    Ring == "Ring2" ~ 2,
    Ring == "Ring3" ~ 3,
    Ring == "Ring4" ~ 4,
    Ring == "Ring5" ~ 5)) %>% 
  group_by(File_Id, Id) %>% 
  mutate(Transmittance_integrated = sum(BELOW)/sum(ABOVE)) %>% # transmittance integrated over all the rings (to validate with HOBOs)
  ungroup() %>% 
  group_by(Id) %>% 
  mutate(MeanTransmittance_integrated = mean(Transmittance_integrated)) %>% 
  ungroup() %>% 
  select(c(Transect, Id, Ring, MeanTransmittance_LAI2200, SdTransmittance_LAI2200, SeTransmittance_LAI2200, MeanTransmittance_integrated)) %>%
  unique()

# DZ <- LAI2200_data %>%
#   select(c(Date,TimeA,Ring,ABOVE)) %>%
#   unique()

LAI2200_data <- LAI2200_data %>% 
  select(c(Transect, Id, Ring, MeanTransmittance_LAI2200, SdTransmittance_LAI2200, SeTransmittance_LAI2200, MeanTransmittance_integrated)) %>%
  unique()

names(LAI2200_coord) # "Transect", "Id", "Xutm","Yutm","Zutm"
names(LAI2200_data) # "Id", "Transect", "Ring", "Transmittance_mean" (Transmittance_mean for each sensor and for each ring)


LAI2200 <- LAI2200_coord %>% 
  left_join(LAI2200_data, by= c("Transect", "Id")) %>% 
  mutate(Xutm = round(Xutm), 
         Yutm = round(Yutm),
         Zutm = round(Zutm)) %>% 
  filter(!(Transect=="HOBO" & Id==10))

HOBO10 <- LAI2200 %>% filter(Transect=="LAY" & Id==6) %>% 
  mutate(Transect = "HOBO") %>% mutate(Id= 10)

LAI2200 <- rbind(LAI2200, HOBO10) 

nrow(unique(LAI2200 %>% select(Xutm,Yutm,Zutm))) # 45 <- 20+26 LAI2200 dont 1 en commun

```

## Combine LiDAR and LAI2200 data
```{r}
LAI2200_LiDAR <- LAI2200 %>% 
  left_join(LiDAR, by= c("Xutm","Yutm","Zutm", "Ring"))

# NA_table <- LAI2200_LiDAR[rowSums(is.na(LAI2200_LiDAR[, c(25, 34:36)])) > 0,] # NA ?
```

```{r, eval=F}
unique(setDT(LAI2200_LiDAR)[Transmittance_HighInt2m ==0, .(Transect, Id, Ring)]) # 9 id : Ring 4-5
unique(setDT(LAI2200_LiDAR)[Transmittance_LowInt2m ==0, .(Transect, Id, Ring)]) # 7 id : Ring 4-5
unique(setDT(LAI2200_LiDAR)[Transmittance_HighInt1m ==0, .(Transect, Id, Ring)]) # 0
unique(setDT(LAI2200_LiDAR)[Transmittance_UAVInt2m ==0, .(Transect, Id, Ring)]) # 6 id : Ring 5
unique(setDT(LAI2200_LiDAR)[Transmittance_UAVInt1m ==0, .(Transect, Id, Ring)]) # HOBO 14 : Ring 3,4,5
```

```{r}
LAI2200_LiDAR %>% filter(is.nan(MeanTransmittance_UAVInt2m)) %>% select(Transect, Id, Ring) %>% unique()
```

```{r}
rm(NA_table)
```

```{r,eval = F }
test <- unique(LAI2200_LiDAR %>% filter(Ring==1) %>% select(Transect, Id, Xutm,Yutm, MeanTransmittance_LAI2200, Transmittance_sd, MeanTransmittance_HighInt2m)) # 46 
test[duplicated(test$MeanTransmittance_HighInt2m), ] 
test %>% filter(Xutm == 285517 & Yutm==581503) # c'est 6 du LAY et le 10 du HOBO qui sont communs
```

# Compute differences
```{r}
# "MeanTransmittance_HighInt2m", "MeanTransmittance_LowInt2m","MeanTransmittance_HighInt1m"
# names(LAI2200_LiDAR)
LAI2200_LiDAR <- LAI2200_LiDAR %>% 
  # select(-c("...1.x","...1.y")) %>% 
  select(Transect,Id, Xutm,Yutm, Ring,azimut,
         MeanTransmittance_LAI2200, SdTransmittance_LAI2200,SeTransmittance_LAI2200, MeanTransmittance_integrated,
         MeanTransmittance_HighInt2m, SdTransmittance_HighInt2m, SeTransmittance_HighInt2m,
         MeanTransmittance_LowInt2m, SdTransmittance_LowInt2m, SeTransmittance_LowInt2m,
         
         MeanTransmittance_HighInt1m, SdTransmittance_HighInt1m, SeTransmittance_HighInt1m,
         MeanTransmittance_LowInt1m, SdTransmittance_LowInt1m, SeTransmittance_LowInt1m,
         
         MeanTransmittance_UAVInt2m, SdTransmittance_UAVInt2m, SeTransmittance_UAVInt2m,
         MeanTransmittance_UAVInt1m, SdTransmittance_UAVInt1m, SeTransmittance_UAVInt1m,
         
         # MeanTransmittance_HighEqual2m, SdTransmittance_HighEqual2m, SeTransmittance_HighEqual2m,
         # MeanTransmittance_LowEqual2m, SdTransmittance_LowEqual2m, SeTransmittance_LowEqual2m
  ) %>%
  unique() %>% 
  # compute differences (4-3=1, le rslt informe sur la valeur à laquelle on soustrait)
  mutate(Transmittance_LowvsHigh_2m =  MeanTransmittance_LowInt2m - MeanTransmittance_HighInt2m) %>% 
  mutate(Transmittance_HighInt2mvsLAI2200 = MeanTransmittance_HighInt2m - MeanTransmittance_LAI2200) %>% 
  mutate(Transmittance_LowInt2mvsLAI2200 = MeanTransmittance_LowInt2m - MeanTransmittance_LAI2200) %>% 
  
  mutate(Transmittance_HighInt1mvsLAI2200 = MeanTransmittance_HighInt1m - MeanTransmittance_LAI2200) %>% 
  mutate(Transmittance_HighInt1mvsHigh2m = MeanTransmittance_HighInt1m - MeanTransmittance_HighInt2m) %>% 
  
  mutate(Transmittance_LowInt1mvsLAI2200 = MeanTransmittance_LowInt1m - MeanTransmittance_LAI2200) %>% 
  mutate(Transmittance_LowInt1mvsLow2m = MeanTransmittance_LowInt1m - MeanTransmittance_LowInt2m) %>% 
  
  # mutate(Transmittance_HighEqual2mvsLAI2200 = MeanTransmittance_HighEqual2m -MeanTransmittance_LAI2200) %>% 
  # mutate(Transmittance_LowEqual2mvsLAI2200 = MeanTransmittance_LowEqual2m - MeanTransmittance_LAI2200) %>% 
  # mutate(Transmittance_LowInt2mvsLowEqual2m = MeanTransmittance_LowInt2m - MeanTransmittance_LowEqual2m) %>% 
  # mutate(Transmittance_HighInt2mvsHighEqual2m = MeanTransmittance_HighInt2m - MeanTransmittance_HighEqual2m) %>% 
  
  mutate(Transmittance_UAVInt2mvsLAI2200 = MeanTransmittance_UAVInt2m - MeanTransmittance_LAI2200) %>% 
  mutate(Transmittance_UAVInt1mvsLAI2200 = MeanTransmittance_UAVInt1m -MeanTransmittance_LAI2200) %>% 
  mutate(Transmittance_UAVInt1mvsUAV2m = MeanTransmittance_UAVInt1m -MeanTransmittance_UAVInt2m) 

```

```{r}
range(LAI2200_LiDAR$Transmittance_HighInt2mvsLAI2200) # -0.54124286  0.06917472
range(LAI2200_LiDAR$Transmittance_LowInt2mvsLAI2200) # -0.49684541  0.06841737 : le plus proche du lAI2200
range(LAI2200_LiDAR$Transmittance_HighInt1mvsLAI2200) # -0.57688611  0.09193129 : le moins proche du lAI2200 (sousestime le plus)

range(LAI2200_LiDAR$Transmittance_LowInt1mvsLAI2200) #

range(LAI2200_LiDAR$Transmittance_UAVInt2mvsLAI2200) # -0.54234975 0.07404788
range(LAI2200_LiDAR$Transmittance_UAVInt1mvsLAI2200) # -0.5614362  0.1175349
range(LAI2200_LiDAR$Transmittance_UAVInt1mvsUAV2m) # -0.07240207  0.07948355
# New coord after shift:
# [1] -0.2934849  0.1277295
# [1] -0.3875990  0.1006225
# [1] -0.09805637  0.13728262
# [1] -0.08493047  0.15258004
# [1] -0.3962160  0.1515244
# [1] -0.1791319  0.1193880
# [1] -0.1053409  0.2170841


# range(LAI2200_LiDAR$Transmittance_HighEqual2mvsLAI2200) # -0.4999787  0.0849005 : eqEch sous-estime moins que le avec intensity, mais surrestime
# range(LAI2200_LiDAR$Transmittance_LowEqual2mvsLAI2200) # -0.4410783  0.1079312 : surrestime le plus
# range(LAI2200_LiDAR$Transmittance_LowInt2mvsLowEqual2m) # -0.0703229895 -0.0001377847
# range(LAI2200_LiDAR$Transmittance_HighInt2mvsHighEqual2m) # -0.047436156  0.005860184
```


## Plot LiDAR data
```{r, eval=F}
LiDARsf <- st_as_sf(LiDAR, coords = c('Xutm','Yutm'))
LiDARsf <- st_set_crs(LiDARsf, crs(zone))

LiDARsf <- LiDARsf %>% filter(Ring==1) # %>% filter(azimut==0)

for(acq in c("MeanTransmittance_HighInt2m", "MeanTransmittance_LowInt2m","MeanTransmittance_HighInt1m",
             "MeanTransmittance_UAVInt2m")){
  print(
    LiDARsf %>% 
      select(geometry, acq) %>% #  Transmittance_High,Transmittance_Low, `GAP[1]_High`,`GAP[1]_Low`, LAI_High, LAI_Low
      ggplot() +
      geom_sf(data = sf::st_cast(zone, "LINESTRING")) + # zone of interest
      geom_sf(data = LiDARsf, aes(color = get(acq)), size = 1.5) +
      scale_colour_gradientn(name = acq,
                             colors = terrain.colors(30, rev=T),
                             na.value="grey", limits = c(0,0.65)) + # limits comme LAI2200
      theme(title=element_text(size=16), axis.text=element_text(size=16), legend.title=element_text(size=16), legend.text=element_text(size=16)) +
      ggtitle("Paracou P16 4ha - LiDAR LAI2200 simulations")
  )
  
  # ggsave(paste("P16_2023_4ha_Lidar_simulations_",acq, ".png", sep=""),
  #        path = "D:/Mes Donnees/PhD/Figures/lidar/Correlations/Maps/Intensity_2m",
  #        width = 25, height = 25, units = "cm", dpi=800, bg="white")
}

```

## Plot LAI2200 data
```{r, eval=F}
LAI2200UTMsf <- st_as_sf(LAI2200, coords = c('Xutm','Yutm'))
LAI2200UTMsf <- st_set_crs(LAI2200UTMsf, crs(zone))

LAI2200UTMsf <- LAI2200UTMsf %>% filter(Ring==1)

ggplot() +
  geom_sf(data = sf::st_cast(zone, "LINESTRING")) + # zone of interest
  geom_sf(data = LAI2200UTMsf, aes(color = Transmittance_mean), size = 1.5) +
  scale_colour_gradientn(colors = terrain.colors(30, rev=T),
                         na.value="grey", limits = c(0,0.65)) +
  theme(title=element_text(size=16), axis.text=element_text(size=16), legend.title=element_text(size=16), legend.text=element_text(size=16)) +
  ggtitle("Paracou P16 4ha - LAI2200 Transmittances")

# ggsave(paste("P16_2023_4ha_LAI2200_Transmittances.png", sep=""),
#        path = "D:/Mes Donnees/PhD/Figures/lidar/Correlations/Maps",
#        width = 25, height = 25, units = "cm", dpi=800, bg="white")
```


# Difference plots
```{r, eval=F}
LAI2200_LiDAR1 <- LAI2200_LiDAR %>% filter(Ring==1)

LAI2200_LiDARsf <- st_as_sf(LAI2200_LiDAR1, coords = c('Xutm','Yutm'))
LAI2200_LiDARsf <- st_set_crs(LAI2200_LiDARsf, crs(zone))

# LAI2200_LiDARsf <- LAI2200_LiDARsf %>% filter(Ring==1)

for(v in c("Transmittance_LowvsHigh_2m", "Transmittance_HighInt2mvsLAI2200", "Transmittance_LowvsLAI2200", "Transmittance_HighInt1mvsLAI2200", "Transmittance_HighInt1mvsHigh2m")){
  print(
    ggplot() +
      geom_sf(data = sf::st_cast(zone, "LINESTRING")) + # zone of interest
      geom_sf(data = LAI2200_LiDARsf, aes(color = get(v)), size = 1.5) + 
      # scale_colour_gradientn(colors = terrain.colors(30, rev=T),
      #                        na.value="grey") +
      scale_color_gradient2(name = v,
                            low="blue", high="red", mid = "white", midpoint = 0) +
      theme(title=element_text(size=16), axis.text=element_text(size=16), legend.title=element_text(size=16), legend.text=element_text(size=16)) +
      ggtitle("Paracou P16 4ha - Transmittances differences") +
      labs(color = v)
  )
  # ggsave(paste("P16_2023_4ha_Transmittances_diff_",v, ".png", sep=""),
  #        path = "D:/Mes Donnees/PhD/Figures/lidar/Correlations/Maps/Intensity_2m",
  #        width = 25, height = 25, units = "cm", dpi=800, bg="white")
}
```

## Graph à segments
```{r}
# LAI2200_LiDAR %>% 
#   filter(Ring==1) %>%
#   ggplot() +
#   ggtitle("Paracou P16 4ha - Transmittances differences") +
#   aes(x = Transmittance_High, y = Transmittance_LowvsHigh) +
#   geom_point() +
#   geom_hline(yintercept=0) +
#   geom_segment(aes(yend=0)) +
#   coord_fixed(ratio=1) +
#   labs(x ="High altitude transmittance", y = "Low - High altitude transmittances")
# 
# for(v in c("Transmittance_HighvsLAI2200", "Transmittance_LowvsLAI2200")){
#   print(
#     LAI2200_LiDAR %>% 
#       filter(Ring==1) %>% 
#       ggplot() +
#       ggtitle("Paracou P16 4ha - Transmittances differences") +
#       aes(x = MeanTransmittance_LAI2200, y = get(v)) +
#       geom_point() +
#       geom_hline(yintercept=0) +
#       geom_segment(aes(yend=0)) +
#       coord_fixed(ratio=1) +# same axis size
#       labs(x ="LAI2200 transmittance", y = v)
#   ) 
# }
```

# Profils en long (Transmittances le long du transect)
Transmittances le long du transect pour les différentes acquisitions LiDAR et le LAI2200
pour chaque ring
## 1m
```{r}
LAI2200_LiDAR_corr <- LAI2200_LiDAR %>% 
# Correction des rings 4 et 5 d'après la transmittance estimée de la DZ au LiDAR
  mutate(MeanTransmittance_LAI2200 = ifelse(Ring==4, MeanTransmittance_LAI2200 * 0.96,
                                                 MeanTransmittance_LAI2200)) %>% 
  mutate(MeanTransmittance_LAI2200 = ifelse(Ring==5, MeanTransmittance_LAI2200 * 0.23,
                                                 MeanTransmittance_LAI2200))

for(t in c("HOBO", "LAY")){
  for(R in 1:5){
    
    idmax = max(LAI2200_LiDAR_corr[LAI2200_LiDAR_corr$Transect==t,]$Id) # last sensor Id
    
    print(
      LAI2200_LiDAR_corr %>% 
        filter(Transect==t) %>% # LAY # HOBO
        filter(Ring==R) %>%
        ggplot(aes(x = Id)) +
        
        geom_linerange(aes(ymin=MeanTransmittance_LAI2200-SeTransmittance_LAI2200,
                           ymax=MeanTransmittance_LAI2200+SeTransmittance_LAI2200, colour = "Standard error")) +
        
        # Validation data
        geom_point(aes(y = MeanTransmittance_LAI2200, colour = "LAI2200")) +
        geom_line(aes(y = MeanTransmittance_LAI2200, colour = "LAI2200"), linewidth = 1.2) +
        geom_linerange(aes(ymin=MeanTransmittance_LAI2200-SeTransmittance_LAI2200,
                           ymax=MeanTransmittance_LAI2200+SeTransmittance_LAI2200, colour = "LAI2200")) +
        # Intensity
        ## ALS
        # geom_point(aes(y = MeanTransmittance_HighInt2m, colour = "High altitude - Intens - 2m")) +
        # geom_line(aes(y = MeanTransmittance_HighInt2m, colour = "High altitude - Intens - 2m")) +
        # geom_linerange(aes(ymin=MeanTransmittance_HighInt2m-SeTransmittance_HighInt2m,
        #                    ymax=MeanTransmittance_HighInt2m+SeTransmittance_HighInt2m, colour = "High altitude - Intens - 2m")) +
        # 
        # geom_point(aes(y = MeanTransmittance_LowInt2m, colour = "Low altitude - Intens - 2m")) +
        # geom_line(aes(y = MeanTransmittance_LowInt2m, colour = "Low altitude - Intens - 2m")) +
        # geom_linerange(aes(ymin=MeanTransmittance_LowInt2m-SeTransmittance_LowInt2m,
        #                    ymax=MeanTransmittance_LowInt2m+SeTransmittance_LowInt2m, colour = "Low altitude - Intens - 2m")) +
      
      
      geom_point(aes(y = MeanTransmittance_HighInt1m, colour = "High altitude - Intens - 1m")) +
        geom_line(aes(y = MeanTransmittance_HighInt1m, colour = "High altitude - Intens - 1m")) +
        geom_linerange(aes(ymin=MeanTransmittance_HighInt1m-SeTransmittance_HighInt1m,
                           ymax=MeanTransmittance_HighInt1m+SeTransmittance_HighInt1m, colour = "High altitude - Intens - 1m")) +
        
        geom_point(aes(y = MeanTransmittance_LowInt1m, colour = "Low altitude - Intens - 1m")) +
        geom_line(aes(y = MeanTransmittance_LowInt1m, colour = "Low altitude - Intens - 1m")) +
        geom_linerange(aes(ymin=MeanTransmittance_LowInt1m-SeTransmittance_LowInt1m,
                           ymax=MeanTransmittance_LowInt1m+SeTransmittance_LowInt1m, colour = "Low altitude - Intens - 1m")) +
        
        ## UAV
        # geom_point(aes(y = MeanTransmittance_UAVInt2m, colour = "UAV - Intens - 2m")) +
        # geom_line(aes(y = MeanTransmittance_UAVInt2m, colour = "UAV - Intens - 2m")) +
        # geom_linerange(aes(ymin=MeanTransmittance_UAVInt2m-SeTransmittance_UAVInt2m,
        #                    ymax=MeanTransmittance_UAVInt2m+SeTransmittance_UAVInt2m, colour = "UAV - Intens - 2m")) +
        
        geom_point(aes(y = MeanTransmittance_UAVInt1m, colour = "UAV - Intens - 1m")) +
        geom_line(aes(y = MeanTransmittance_UAVInt1m, colour = "UAV - Intens - 1m")) +
        geom_linerange(aes(ymin=MeanTransmittance_UAVInt1m-SeTransmittance_UAVInt1m,
                           ymax=MeanTransmittance_UAVInt1m+SeTransmittance_UAVInt1m, colour = "UAV - Intens - 1m")) +
        
        
        scale_colour_manual(values = c("High altitude - Intens - 1m" = "blue",
                                       "Low altitude - Intens - 1m" = "#56B4E9",
                                       "UAV - Intens - 1m" = "#E69F00",
                                       # "High altitude - Intens - 2m" = "blue",
                                       # "Low altitude - Intens - 2m" = "#56B4E9",
                                       # "UAV - Intens - 2m" = "#E69F00",
                                       "LAI2200" = "#D55E00", 
                                       "Standard error" = "#666666"),
                            breaks=c("High altitude - Intens - 1m",
                                     "Low altitude - Intens - 1m",
                                     "UAV - Intens - 1m",
                                     # "High altitude - Intens - 2m", "Low altitude - Intens - 2m", 
                                     # "UAV - Intens - 2m",  
                                     "LAI2200", 
                                     "Standard error")) +
        
        guides(colour = guide_legend(
          override.aes = list(linetype = c("blank", "blank", "blank", "blank", "solid"),
                              linewidth = 0.4))) + 
        
        
        labs(title = paste(t," transect - Ring ",R), y="Mean transmittance", x="Sensor ID", color = "Acquisition") +
        scale_x_continuous(breaks = seq(1:idmax)) + # 26 # 20
        theme(title= element_text(size=18), axis.title= element_text(size=18), axis.text= element_text(size=18), legend.title= element_text(size=18), legend.text= element_text(size=18)) +
        theme_minimal()
    )
    ggsave(paste("P16_2023_4ha_Long_profile_",t,"_transect_Ring",R,"_se_Intensity1m.png", sep=""),
           path = "D:/Mes Donnees/PhD/Figures/lidar/Correlations/Long_profile/Intensity_1m/DZ_cor",
           width = 25, height = 20, units = "cm", dpi=800, bg="white")
  }
}

```

## 2m
```{r}
for(t in c("HOBO", "LAY")){
  for(R in 1:5){
    
    idmax = max(LAI2200_LiDAR[LAI2200_LiDAR$Transect==t,]$Id) # last sensor Id
    
    print(
      LAI2200_LiDAR %>% 
        filter(Transect==t) %>% # LAY # HOBO
        filter(Ring==R) %>%
        ggplot(aes(x = Id)) +
        
        geom_linerange(aes(ymin=MeanTransmittance_LAI2200-SeTransmittance_LAI2200,
                           ymax=MeanTransmittance_LAI2200+SeTransmittance_LAI2200, colour = "Standard error")) +
        
        # Validation data
        geom_point(aes(y = MeanTransmittance_LAI2200, colour = "LAI2200")) +
        geom_line(aes(y = MeanTransmittance_LAI2200, colour = "LAI2200"), linewidth = 1.2) +
        geom_linerange(aes(ymin=MeanTransmittance_LAI2200-SeTransmittance_LAI2200,
                           ymax=MeanTransmittance_LAI2200+SeTransmittance_LAI2200, colour = "LAI2200")) +
        # Intensity
        ## ALS
        geom_point(aes(y = MeanTransmittance_HighInt2m, colour = "High altitude - Intens - 2m")) +
        geom_line(aes(y = MeanTransmittance_HighInt2m, colour = "High altitude - Intens - 2m")) +
        geom_linerange(aes(ymin=MeanTransmittance_HighInt2m-SeTransmittance_HighInt2m,
                           ymax=MeanTransmittance_HighInt2m+SeTransmittance_HighInt2m, colour = "High altitude - Intens - 2m")) +
        
        geom_point(aes(y = MeanTransmittance_LowInt2m, colour = "Low altitude - Intens - 2m")) +
        geom_line(aes(y = MeanTransmittance_LowInt2m, colour = "Low altitude - Intens - 2m")) +
        geom_linerange(aes(ymin=MeanTransmittance_LowInt2m-SeTransmittance_LowInt2m,
                           ymax=MeanTransmittance_LowInt2m+SeTransmittance_LowInt2m, colour = "Low altitude - Intens - 2m")) +
        
        ## UAV
        geom_point(aes(y = MeanTransmittance_UAVInt2m, colour = "UAV - Intens - 2m")) +
        geom_line(aes(y = MeanTransmittance_UAVInt2m, colour = "UAV - Intens - 2m")) +
        geom_linerange(aes(ymin=MeanTransmittance_UAVInt2m-SeTransmittance_UAVInt2m,
                           ymax=MeanTransmittance_UAVInt2m+SeTransmittance_UAVInt2m, colour = "UAV - Intens - 2m")) +
        
        scale_colour_manual(values = c("High altitude - Intens - 2m" = "blue",
                                       "Low altitude - Intens - 2m" = "#56B4E9",
                                       "UAV - Intens - 2m" = "#E69F00",
                                       "LAI2200" = "#D55E00", 
                                       "Standard error" = "#666666"),
                            breaks=c(
                              "High altitude - Intens - 2m",
                              "Low altitude - Intens - 2m", 
                              "UAV - Intens - 2m", 
                              "LAI2200", 
                              "Standard error")) +
        
        guides(colour = guide_legend(
          override.aes = list(linetype = c("blank", "blank", "blank", "blank", "solid"),
                              linewidth = 0.4))) + 
        
        
        labs(title = paste(t," transect - Ring ",R), y="Mean transmittance", x="Sensor ID", color = "Acquisition") +
        scale_x_continuous(breaks = seq(1:idmax)) + # 26 # 20
        theme(title= element_text(size=18), axis.title= element_text(size=18), axis.text= element_text(size=18), legend.title= element_text(size=18), legend.text= element_text(size=18)) +
        theme_minimal()
    )
    ggsave(paste("P16_2023_4ha_Long_profile_",t,"_transect_Ring",R,"_se_Intensity2m.png", sep=""),
           path = "D:/Mes Donnees/PhD/Figures/lidar/Correlations/Long_profile/Intensity_2m",
           width = 25, height = 20, units = "cm", dpi=800, bg="white")
  }
}

```


# Profils en long (moyennes des Transmittances par acquisition, par ring)
```{r}
vars <- c("MeanTransmittance_HighInt2m", "MeanTransmittance_LowInt2m",
          "MeanTransmittance_HighInt1m", "MeanTransmittance_LowInt1m",
          "MeanTransmittance_UAVInt2m", "MeanTransmittance_UAVInt1m", 
          "MeanTransmittance_LAI2200")

LAI2200_LiDAR_ring <- LAI2200_LiDAR %>%
  group_by(Ring) %>% # variables selon lesquelles grouper
  summarise(across(c(all_of(vars)), # Variables à analyser
                   list(mean = ~mean(.), # les stats
                        sd = ~sd(.),
                        se = ~plotrix::std.error(.)),
                   .names = "{.col}_{.fn}")) %>% 
  # Correction des rings 4 et 5 d'après la transmittance estimée de la DZ au LiDAR
  mutate(MeanTransmittance_LAI2200_mean = ifelse(Ring==4, MeanTransmittance_LAI2200_mean*0.96,
                                                 MeanTransmittance_LAI2200_mean)) %>% 
  mutate(MeanTransmittance_LAI2200_mean = ifelse(Ring==5, MeanTransmittance_LAI2200_mean*0.23,
                                                 MeanTransmittance_LAI2200_mean))
label <- LAI2200_LiDAR_ring %>%
  group_by(Ring) %>%
  mutate(across(all_of(c("MeanTransmittance_HighInt1m_mean", "MeanTransmittance_LowInt1m_mean","MeanTransmittance_UAVInt1m_mean")),
                                   ~ (.x - across("MeanTransmittance_LAI2200_mean"))/across("MeanTransmittance_LAI2200_mean"),
             .names = "{col}_RD")) # calcul écart relative (estimé-mesuré)/mesuré

label <- label %>% select(Ring, MeanTransmittance_HighInt1m_mean_RD, MeanTransmittance_LowInt1m_mean_RD, MeanTransmittance_UAVInt1m_mean_RD) %>% as.data.frame() %>% 
  mutate(High_RD = round(as.vector(unlist(MeanTransmittance_HighInt1m_mean_RD)),2)) %>% 
  mutate(Low_RD = round(as.vector(unlist(MeanTransmittance_LowInt1m_mean_RD)),2)) %>% 
  mutate(UAV_RD = round(as.vector(unlist(MeanTransmittance_UAVInt1m_mean_RD)),2)) %>% 
  select(Ring, High_RD, Low_RD, UAV_RD)
  
write.csv(label, "D:/Mes Donnees/PhD/Figures/lidar/Correlations/Long_profile/Intensity_1m/Relative_differences_byRing.csv")

LAI2200_LiDAR_ring %>% 
  ggplot(aes(x = Ring)) +
  
  geom_linerange(aes(ymin=MeanTransmittance_LAI2200_mean-MeanTransmittance_LAI2200_se,
                     ymax=MeanTransmittance_LAI2200_mean+MeanTransmittance_LAI2200_se, colour = "Standard error")) +
  
  geom_linerange(aes(ymin=MeanTransmittance_LAI2200_mean-MeanTransmittance_LAI2200_se,
                     ymax=MeanTransmittance_LAI2200_mean+MeanTransmittance_LAI2200_se,
                     colour = "LAI2200"), alpha =1) +
  # ALS
  # geom_linerange(aes(ymin=MeanTransmittance_LowInt2m_mean-MeanTransmittance_LowInt2m_se,
  #                    ymax=MeanTransmittance_LowInt2m_mean+MeanTransmittance_LowInt2m_se,
  #                    colour = "Low altitude - Intens - 2m"),alpha =1) +
  # geom_linerange(aes(ymin=MeanTransmittance_HighInt2m_mean-MeanTransmittance_HighInt2m_se,
  #                    ymax=MeanTransmittance_HighInt2m_mean+MeanTransmittance_HighInt2m_se,
  #                    colour = "High altitude - Intens - 2m"),alpha =1) +
  ## 1m
  geom_linerange(aes(ymin=MeanTransmittance_HighInt1m_mean-MeanTransmittance_HighInt1m_se,
                     ymax=MeanTransmittance_HighInt1m_mean+MeanTransmittance_HighInt1m_se,
                     colour = "High altitude - Intens - 1m"),alpha =1) +
  geom_linerange(aes(ymin=MeanTransmittance_LowInt1m_mean-MeanTransmittance_LowInt1m_se,
                     ymax=MeanTransmittance_LowInt1m_mean+MeanTransmittance_LowInt1m_se,
                     colour = "Low altitude - Intens - 1m"),alpha =1) +
  
  # UAV
  # geom_linerange(aes(ymin=MeanTransmittance_UAVInt2m_mean-MeanTransmittance_UAVInt2m_se,
  #                    ymax=MeanTransmittance_UAVInt2m_mean+MeanTransmittance_UAVInt2m_se,
  #                    colour = "UAV - Intens - 2m"),alpha =1) +
  
  geom_linerange(aes(ymin=MeanTransmittance_UAVInt1m_mean-MeanTransmittance_UAVInt1m_se,
                     ymax=MeanTransmittance_UAVInt1m_mean+MeanTransmittance_UAVInt1m_se,
                     colour = "UAV - Intens - 1m"),alpha =1) +
  
  # ALS
  # geom_point(aes(y = MeanTransmittance_HighInt2m_mean, colour = "High altitude - Intens - 2m"),size = 3) +
  # geom_line(aes(y = MeanTransmittance_HighInt2m_mean, colour = "High altitude - Intens - 2m")) +
  # 
  # geom_point(aes(y = MeanTransmittance_LowInt2m_mean, colour = "Low altitude - Intens - 2m"),size = 3) +
  # geom_line(aes(y = MeanTransmittance_LowInt2m_mean, colour = "Low altitude - Intens - 2m")) +
  
  ## 1m
  geom_point(aes(y = MeanTransmittance_HighInt1m_mean, colour = "High altitude - Intens - 1m"),size = 3) +
  geom_line(aes(y = MeanTransmittance_HighInt1m_mean, colour = "High altitude - Intens - 1m")) +
  
  geom_point(aes(y = MeanTransmittance_LowInt1m_mean, colour = "Low altitude - Intens - 1m"),size = 3) +
  geom_line(aes(y = MeanTransmittance_LowInt1m_mean, colour = "Low altitude - Intens - 1m")) +
  
  # UAV
  # geom_point(aes(y = MeanTransmittance_UAVInt2m_mean, colour = "UAV - Intens - 2m"),size = 3) +
  # geom_line(aes(y = MeanTransmittance_UAVInt2m_mean, colour = "UAV - Intens - 2m")) +
  
  geom_point(aes(y = MeanTransmittance_UAVInt1m_mean, colour = "UAV - Intens - 1m"),size = 3) +
  geom_line(aes(y = MeanTransmittance_UAVInt1m_mean, colour = "UAV - Intens - 1m")) +
  
  geom_point(aes(y = MeanTransmittance_LAI2200_mean, colour = "LAI2200"),size = 3) +
  geom_line(aes(y = MeanTransmittance_LAI2200_mean, colour = "LAI2200")) +
  
  
  scale_colour_manual(values = c("High altitude - Intens - 1m" = "blue", # "#009E73",
                                 "Low altitude - Intens - 1m" = "#56B4E9", # "#CC79A7",
                                 "UAV - Intens - 1m" = "#E69F00", # "#F0E442", 
                                 
                                 # "High altitude - Intens - 2m" = "blue",
                                 # "Low altitude - Intens - 2m" = "#56B4E9",
                                 # "UAV - Intens - 2m" = "#E69F00",
                                 
                                 "LAI2200" = "#D55E00", 
                                 "Standard error" = "#666666"),
                      breaks=c(
                        # "High altitude - Intens - 2m", "Low altitude - Intens - 2m", 
                        # "UAV - Intens - 2m", 
                        "High altitude - Intens - 1m", "Low altitude - Intens - 1m",
                        "UAV - Intens - 1m", 
                        "LAI2200", 
                        "Standard error")) +
  
  guides(colour = guide_legend(
    override.aes = list(linetype = c("blank", "blank", "blank", "blank", "solid"),
                        linewidth = 0.4))) + 
  theme_minimal() +
  
  geom_text(data = label, aes(label = label), show.legend = F) +

  theme(title= element_text(size=18), axis.title= element_text(size=18), axis.text= element_text(size=18), legend.title= element_text(size=18), legend.text= element_text(size=18)) +
  labs(title = "Both transect", y="Mean transmittance of the transect", x="Ring", color = "Acquisition")

ggsave(paste("Long_profile_The2_transects_Transmittance_of_the_transect_byRing_Intensity1m_ring45corr.png", sep=""),
       path = "D:/Mes Donnees/PhD/Figures/lidar/Correlations/Long_profile/Intensity_1m",
       width = 25, height = 20, units = "cm", dpi=800, bg="white")

```
# Calibration
```{r}
# multiplicateur <- median((LAI2200_LiDAR_ring$MeanTransmittance_LAI2200_mean/LAI2200_LiDAR_ring$MeanTransmittance_LowInt2m_mean)[1:4])
# # pour 2x=a :
# puissance <- median(1/(log(LAI2200_LiDAR_ring$MeanTransmittance_LowInt2m_mean)/log(LAI2200_LiDAR_ring$MeanTransmittance_LAI2200_mean))[1:4])
# 
# LAI2200_LiDAR_ring %>% 
#   mutate(Calib_multiplicateur = MeanTransmittance_LowInt2m_mean*multiplicateur) %>% # 1.8
#   mutate(Calib_puissance = MeanTransmittance_LowInt2m_mean^puissance) %>% # 1.8
#   ggplot(aes(x = Ring)) +
#   
#   geom_linerange(aes(ymin=MeanTransmittance_LAI2200_mean-MeanTransmittance_LAI2200_se,
#                      ymax=MeanTransmittance_LAI2200_mean+MeanTransmittance_LAI2200_se, colour = "Standard error")) +
#   
#   geom_linerange(aes(ymin=MeanTransmittance_LAI2200_mean-MeanTransmittance_LAI2200_se,
#                      ymax=MeanTransmittance_LAI2200_mean+MeanTransmittance_LAI2200_se,
#                      colour = "LAI2200"), alpha =1) +
#   # Intensity
#   geom_linerange(aes(ymin=MeanTransmittance_LowInt2m_mean-MeanTransmittance_LowInt2m_se,
#                      ymax=MeanTransmittance_LowInt2m_mean+MeanTransmittance_LowInt2m_se,
#                      colour = "Low altitude - Intens - 2m"),alpha =1) +
#   
#   geom_point(aes(y = MeanTransmittance_LowInt2m_mean, colour = "Low altitude - Intens - 2m"),size = 3) +
#   geom_line(aes(y = MeanTransmittance_LowInt2m_mean, colour = "Low altitude - Intens - 2m")) +
#   
#   geom_point(aes(y = Calib_multiplicateur, colour = "Calibration multiplicateur: 1.8709"),size = 3) +
#   geom_line(aes(y = Calib_multiplicateur, colour = "Calibration multiplicateur: 1.8709")) +
#   
#   geom_point(aes(y = Calib_puissance, colour = "Calibration puissance: 0.823865"),size = 3) +
#   geom_line(aes(y = Calib_puissance, colour = "Calibration puissance: 0.823865")) +
#   
#   geom_point(aes(y = MeanTransmittance_LAI2200_mean, colour = "LAI2200"),size = 3) +
#   geom_line(aes(y = MeanTransmittance_LAI2200_mean, colour = "LAI2200")) +
#   
#   
#   scale_colour_manual(values = c("Low altitude - Intens - 2m" = "#56B4E9",
#                                  "Calibration puissance: 0.823865" = "#009E73",
#                                  "Calibration multiplicateur: 1.8709" = "#CC79A7",
#                                  "LAI2200" = "#D55E00", 
#                                  "Standard error" = "#666666"),
#                       breaks=c("Low altitude - Intens - 2m",
#                                "Calibration multiplicateur: 1.8709",
#                                "Calibration puissance: 0.823865",
#                                "LAI2200", 
#                                "Standard error")) +
#   
#   guides(colour = guide_legend(
#     override.aes = list(linetype = c("blank", "blank", "blank", "blank", "solid"),
#                         linewidth = 0.4))) + 
#   theme_minimal() +
#   theme(title= element_text(size=18), axis.title= element_text(size=18), axis.text= element_text(size=18), legend.title= element_text(size=18), legend.text= element_text(size=18)) +
#   labs(title = "Both transect", y="Mean transmittance of the transect", x="Ring", color = "Acquisition")
# 
# ggsave(paste("Long_profile_The2_transects_MeanStandardErrorTransmittance_of_the_transect_byRing_calibration_puissance_multiplicative.png", sep=""),
#        path = "D:/Mes Donnees/PhD/Figures/lidar/Correlations/Long_profile/Intensity_1m",
#        width = 25, height = 20, units = "cm", dpi=800, bg="white")
```

# Each transect
```{r}
LAI2200_LiDAR_transect <- LAI2200_LiDAR %>%
  group_by(Transect,Ring) %>% # variables selon lesquelles grouper
  summarise(across(all_of(vars), # Variables à analyser
                   list(mean = ~mean(.), # les stats
                        sd = ~sd(.),
                        se = ~plotrix::std.error(.)),
                   .names = "{.col}_{.fn}")) %>% 
  # Correction des rings 4 et 5 d'après la transmittance estimée de la DZ au LiDAR
  mutate(MeanTransmittance_LAI2200_mean = ifelse(Ring==4, MeanTransmittance_LAI2200_mean*0.96,
                                                 MeanTransmittance_LAI2200_mean)) %>% 
  mutate(MeanTransmittance_LAI2200_mean = ifelse(Ring==5, MeanTransmittance_LAI2200_mean*0.23,
                                                 MeanTransmittance_LAI2200_mean)) 


for(t in c("HOBO", "LAY")){
  
  idmax = max(LAI2200_LiDAR[LAI2200_LiDAR$Transect==t,]$Id) # last sensor Id
  
  print(
    LAI2200_LiDAR_transect %>% 
      filter(Transect==t) %>% # LAY # HOBO
      ggplot(aes(x = Ring)) +
      
      geom_linerange(aes(ymin=MeanTransmittance_LAI2200_mean-MeanTransmittance_LAI2200_se,
                         ymax=MeanTransmittance_LAI2200_mean+MeanTransmittance_LAI2200_se, colour = "Standard error")) +
      
      geom_linerange(aes(ymin=MeanTransmittance_LAI2200_mean-MeanTransmittance_LAI2200_se,
                         ymax=MeanTransmittance_LAI2200_mean+MeanTransmittance_LAI2200_se,
                         colour = "LAI2200"), alpha =1) +
      # ALS
      # geom_linerange(aes(ymin=MeanTransmittance_LowInt2m_mean-MeanTransmittance_LowInt2m_se,
      #                    ymax=MeanTransmittance_LowInt2m_mean+MeanTransmittance_LowInt2m_se,
      #                    colour = "Low altitude - Intens - 2m"),alpha =1) +
      # geom_linerange(aes(ymin=MeanTransmittance_HighInt2m_mean-MeanTransmittance_HighInt2m_se,
      #                    ymax=MeanTransmittance_HighInt2m_mean+MeanTransmittance_HighInt2m_se,
      #                    colour = "High altitude - Intens - 2m"),alpha =1) +
      ## 1m
      geom_linerange(aes(ymin=MeanTransmittance_HighInt1m_mean-MeanTransmittance_HighInt1m_se,
                         ymax=MeanTransmittance_HighInt1m_mean+MeanTransmittance_HighInt1m_se,
                         colour = "High altitude - Intens - 1m"),alpha =1) +
      geom_linerange(aes(ymin=MeanTransmittance_LowInt1m_mean-MeanTransmittance_LowInt1m_se,
                         ymax=MeanTransmittance_LowInt1m_mean+MeanTransmittance_LowInt1m_se,
                         colour = "Low altitude - Intens - 1m"),alpha =1) +
      
      # UAV
      # geom_linerange(aes(ymin=MeanTransmittance_UAVInt2m_mean-MeanTransmittance_UAVInt2m_se,
      #                    ymax=MeanTransmittance_UAVInt2m_mean+MeanTransmittance_UAVInt2m_se,
      #                    colour = "UAV - Intens - 2m"),alpha =1) +
      
      geom_linerange(aes(ymin=MeanTransmittance_UAVInt1m_mean-MeanTransmittance_UAVInt1m_se,
                         ymax=MeanTransmittance_UAVInt1m_mean+MeanTransmittance_UAVInt1m_se,
                         colour = "UAV - Intens - 1m"),alpha =1) +
      
      # ALS
      # geom_point(aes(y = MeanTransmittance_HighInt2m_mean, colour = "High altitude - Intens - 2m"),size = 3) +
      # geom_line(aes(y = MeanTransmittance_HighInt2m_mean, colour = "High altitude - Intens - 2m")) +
      # 
      # geom_point(aes(y = MeanTransmittance_LowInt2m_mean, colour = "Low altitude - Intens - 2m"),size = 3) +
      # geom_line(aes(y = MeanTransmittance_LowInt2m_mean, colour = "Low altitude - Intens - 2m")) +
      
      ## 1m
      geom_point(aes(y = MeanTransmittance_HighInt1m_mean, colour = "High altitude - Intens - 1m"),size = 3) +
      geom_line(aes(y = MeanTransmittance_HighInt1m_mean, colour = "High altitude - Intens - 1m")) +
      
      geom_point(aes(y = MeanTransmittance_LowInt1m_mean, colour = "Low altitude - Intens - 1m"),size = 3) +
      geom_line(aes(y = MeanTransmittance_LowInt1m_mean, colour = "Low altitude - Intens - 1m")) +
      
      # UAV
      # geom_point(aes(y = MeanTransmittance_UAVInt2m_mean, colour = "UAV - Intens - 2m"),size = 3) +
      # geom_line(aes(y = MeanTransmittance_UAVInt2m_mean, colour = "UAV - Intens - 2m")) +
      
      geom_point(aes(y = MeanTransmittance_UAVInt1m_mean, colour = "UAV - Intens - 1m"),size = 3) +
      geom_line(aes(y = MeanTransmittance_UAVInt1m_mean, colour = "UAV - Intens - 1m")) +
      
      geom_point(aes(y = MeanTransmittance_LAI2200_mean, colour = "LAI2200"),size = 3) +
      geom_line(aes(y = MeanTransmittance_LAI2200_mean, colour = "LAI2200")) +
      
      
      scale_colour_manual(values = c("High altitude - Intens - 1m" = "blue", # "#009E73",
                                     "Low altitude - Intens - 1m" = "#56B4E9", # "#CC79A7",
                                     "UAV - Intens - 1m" = "#E69F00", # "#F0E442", 
                                     
                                     # "High altitude - Intens - 2m" = "blue",
                                     # "Low altitude - Intens - 2m" = "#56B4E9",
                                     # "UAV - Intens - 2m" = "#E69F00",
                                     
                                     "LAI2200" = "#D55E00", 
                                     "Standard error" = "#666666"),
                          breaks=c(
                            # "High altitude - Intens - 2m", "Low altitude - Intens - 2m", 
                            # "UAV - Intens - 2m", 
                            "High altitude - Intens - 1m", "Low altitude - Intens - 1m",
                            "UAV - Intens - 1m", 
                            "LAI2200", 
                            "Standard error")) +
      
      guides(colour = guide_legend(
        override.aes = list(linetype = c("blank", "blank", "blank", "blank", "solid"),
                            linewidth = 0.4))) + 
      theme_minimal() +
      theme(title= element_text(size=18), axis.title= element_text(size=18), axis.text= element_text(size=18), legend.title= element_text(size=18), legend.text= element_text(size=18)) +
      labs(title = paste(t," transect"), y="Mean transmittance of the transect", x="Ring", color = "Acquisition")
  )
  ggsave(paste("Long_profile_",t," transect","_Transmittance_of_the_transect_byRing_Intensity1m_ring45corr.png", sep=""),
         path = "D:/Mes Donnees/PhD/Figures/lidar/Correlations/Long_profile/Intensity_1m",
         width = 25, height = 20, units = "cm", dpi=800, bg="white")
}
```


# Relations plots
```{r, eval=F}
LAI2200_LiDAR %>% 
  filter(Ring==1) %>%
  ggplot() +
  ggtitle("Paracou P16 4ha - LiDAR transmittance High vs Low altitude") +
  aes(x = Transmittance_HighInt2m, y = Transmittance_LowInt2m) +
  geom_point() +
  stat_smooth(method = "lm",
              formula = y ~ x) +
  geom_abline() +
  # xlim(0,1) +
  # ylim(0,1) +
  coord_fixed(ratio=1) # same axis size


LAI2200_LiDAR %>% 
  filter(Ring==1) %>%
  ggplot() +
  ggtitle("Paracou P16 4ha - High and Low altitude LiDAR vs LAI2200 transmittances") +
  aes(x = MeanTransmittance_LAI2200, y = Transmittance_Low) +
  geom_point(aes(y = Transmittance_LowInt2m, colour = "Low altitude - Intens - 2m")) +
  geom_point(aes(y = Transmittance_HighInt2m, colour = "High altitude - Intens - 2m")) +
  scale_colour_manual(values = c("Low altitude - Intens - 2m" = "green", 
                                 "High altitude - Intens - 2m" = "darkgreen")) +
  stat_smooth(method = "lm",
              formula = y ~ x) +
  geom_abline() +
  coord_fixed(ratio=1) + # same axis size
  labs(x ="LAI2200 transmittance", y = "LiDAR transmittance", color = "LiDAR acquisition")

```

## Zoom
```{r, eval=F}
LAI2200_LiDAR %>% 
  filter(Ring==1) %>%
  filter(Transmittance_HighInt2m<0.3) %>% 
  ggplot() +
  ggtitle("Paracou P16 4ha - LiDAR transmittance High vs Low altitude (< 0.3)") +
  aes(x = Transmittance_HighInt2m, y = Transmittance_LowInt2m) +
  geom_point() +
  stat_smooth(method = "lm",
              formula = y ~ x) +
  geom_abline() +
  xlim(0,0.3) +
  ylim(0,0.3) +
  coord_fixed(ratio=1) # same axis size

LAI2200_LiDAR %>% 
  filter(Ring==1) %>%
  filter(MeanTransmittance_LAI2200<0.1) %>% 
  ggplot() +
  ggtitle("Paracou P16 4ha - High and Low altitude LiDAR vs LAI2200 transmittances (< 0.1)") +
  aes(x = MeanTransmittance_LAI2200, y = Transmittance_Low) +
  geom_point(aes(y = Transmittance_LowInt2m, colour = "Low altitude")) +
  geom_point(aes(y = Transmittance_HighInt2m, colour = "High altitude")) +
  scale_colour_manual(values = c("Low altitude" = "green", 
                                 "High altitude" = "darkgreen")) +
  stat_smooth(method = "lm",
              formula = y ~ x) +
  geom_abline() +
  xlim(0,0.1) +
  ylim(0,0.1) +
  coord_fixed(ratio=1) + # same axis size
  labs(x ="LAI2200 transmittance", y = "LiDAR transmittance", color = "LiDAR acquisition")
```

## Correlation tests

### Only LIDAR
```{r}
DF_cor_LiDAR <- LAI2200_LiDAR %>% 
  select(Ring, MeanTransmittance_HighInt2m, MeanTransmittance_LowInt2m,
         MeanTransmittance_HighInt1m, MeanTransmittance_LowInt1m,
         MeanTransmittance_UAVInt2m, MeanTransmittance_UAVInt1m) %>%  
  unique() %>% 
  pivot_wider(names_from = Ring,
              values_from = c(MeanTransmittance_HighInt2m, MeanTransmittance_LowInt2m, 
                              MeanTransmittance_HighInt1m, MeanTransmittance_LowInt1m,
                              MeanTransmittance_UAVInt2m, MeanTransmittance_UAVInt1m),
              values_fn = list,
              names_glue = "{.value}_Ring{Ring}") %>% 
  unnest(cols = everything()) # pcq les colonnes sont en listes

names(DF_cor_LiDAR) <- str_remove(names(DF_cor_LiDAR), "MeanTransmittance_") # simplify the var names

nrow(DF_cor_LiDAR) # 45
# na.omit()

CorMatrixS <- Hmisc::rcorr(as.matrix(DF_cor_LiDAR))
CorMatrix <- round(CorMatrixS$r, digits = 2)  # matrice de corrélation
Pval_corr <- CorMatrixS$P # p-values

write.csv(CorMatrix, "D:/Mes Donnees/PhD/Figures/lidar/Correlations/Correlations/Intensity_1m/Correlation_plot_LiDAR_ALSvsUAV_Acquisitions.csv")

# Plot de la matrice de corrélation :
png("D:/Mes Donnees/PhD/Figures/lidar/Correlations/Correlations/Intensity_1m/Correlation_plot_LiDAR_ALSvsUAV_Acquisitions.png",
    width = 1000, height = 743, pointsize=20)

corrplot(CorMatrix, method="color", col=brewer.pal(n=8, name="PuOr"),  
         type="upper",
         # order="hclust", 
         tl.col="black", tl.cex = 0.8, tl.srt=45, #Text label color and rotation
         addCoef.col = "white", # Add coefficient of correlation
         number.cex = 0.5, # values
         # hide correlation coefficient on the principal diagonal
         diag=FALSE 
)
dev.off()
```

### LiDAR vs LAI2200
```{r}
# MeanTransmittance_LAI2200, Transmittance_Low, Transmittance_High

DF_cor_LiDARvsLAI2200 <- LAI2200_LiDAR %>% 
  filter(Ring==1|Ring==2) %>% 
  select(Ring, MeanTransmittance_LAI2200,
         MeanTransmittance_HighInt2m, MeanTransmittance_LowInt2m,
         MeanTransmittance_HighInt1m,  MeanTransmittance_LowInt1m,
         MeanTransmittance_UAVInt2m, MeanTransmittance_UAVInt1m) %>% 
  unique() %>% 
  pivot_wider(names_from = Ring,
              values_from = c(MeanTransmittance_LAI2200,
                              MeanTransmittance_HighInt2m, MeanTransmittance_LowInt2m,
                              MeanTransmittance_HighInt1m,  MeanTransmittance_LowInt1m,
                              MeanTransmittance_UAVInt2m, MeanTransmittance_UAVInt1m),
              values_fn = list,
              names_glue = "{.value}_Ring{Ring}") %>% 
  unnest(everything()) # pcq les colonnes sont en listes
# na.omit()

names(DF_cor_LiDARvsLAI2200) <- str_remove(names(DF_cor_LiDARvsLAI2200), "MeanTransmittance_") # simplify the var names
names(DF_cor_LiDARvsLAI2200) <- str_remove(names(DF_cor_LiDARvsLAI2200), "Transmittance_") # simplify the var names

CorMatrixS <- Hmisc::rcorr(as.matrix(DF_cor_LiDARvsLAI2200))
CorMatrix <- round(CorMatrixS$r, digits = 2)  # matrice de corrélation
Pval_corr <- CorMatrixS$P # p-values

write.csv(CorMatrix[,1:2], "D:/Mes Donnees/PhD/Figures/lidar/Correlations/Correlations/Intensity_1m/Correlation_plot_LiDAR_ALS_UAV_vs_LAI2200.csv")

# Plot de la matrice de corrélation :
png("D:/Mes Donnees/PhD/Figures/lidar/Correlations/Correlations/Intensity_1m/Correlation_plot_LiDAR_ALS_UAV_vs_LAI2200.png",
    width = 1600, height = 1200, pointsize=20) # width = 1000, height = 743

corrplot(CorMatrix[1:2,], method="color", col=brewer.pal(n=8, name="PuOr"),  
         type="upper",
         # order="hclust",
         tl.col="black", tl.cex = 0.9, #Text label color and rotation
         addCoef.col = "white", # Add coefficient of correlation
         number.cex = 0.6, # values
         # hide correlation coefficient on the principal diagonal
         cl.pos = "b", cl.cex =0.45, # legend
         sig.level = 0.0000001,
         p.mat = Pval_corr, #avec une croix pour les p-value > 0.05.
         diag=FALSE) 

dev.off()


```

# Version seulement corr >0.5
```{r}
# inspired by the function of Catherine Williams
onlySignCorr <- function(df, file){
  corr <- cor(df)
  
  #drop perfect correlations
  corr[corr == 1] <- NA 
  #turn into a 3-column table
  corr <- as.data.frame(as.table(corr))
  #remove the NA values from above 
  corr <- na.omit(corr) 
  
  #select significant values  
  corr <- subset(corr, abs(Freq) > 0.5) 
  #sort by highest correlation
  corr <- corr[order(-abs(corr$Freq)),] 
  # print(corr)
  #turn corr back into matrix in order to plot with corrplot
  mtx_corr <- reshape2::acast(corr, Var1~Var2, value.var="Freq")
  
  #plot correlations visually
  # corrplot(mtx_corr, type="upper", is.corr=FALSE, tl.col="black", na.label=" ")
  
  # file <- "LiDAR_vs_LAI2200"
  # file <- "LiDAR_Acquisitions"
  png(paste("D:/Mes Donnees/PhD/Figures/lidar/Correlations/Correlations/Intensity_1m/Correlation_plot_",file,"_sup0_5.png", sep=""),
      width = 1000, height = 743, pointsize=20)
  # 
  corrplot(mtx_corr, method="color", col=brewer.pal(n=8, name="PuOr"),  
           type="upper",
           # order="hclust",
           addCoef.col = "white", # Add coefficient of correlation
           tl.col="black", tl.cex = 0.8, #Text label color and rotation
           number.cex = 0.5, # values
           # hide correlation coefficient on the principal diagonal
           diag=FALSE, na.label=" ") 
  
  dev.off()
}

onlySignCorr(DF_cor_LiDARvsLAI2200, "LiDAR_ALS_UAV_vs_LAI2200")
onlySignCorr(DF_cor_LiDAR, "LiDAR_ALSvsUAV_Acquisitions")

```

```{r}
rm(corr, CorMatrix, CorMatrixS, DF_cor, DF_cor_LiDAR, DF_cor_LiDARvsLAI2200, LAI2200, mtx_corr, Pval_corr, LAI2200_LiDAR_transect, LAI2200_LiDAR_ring, LiDAR)
```
# DZ
```{r}
DZmean <- DZ %>% 
  group_by(Ring) %>% 
  mutate(MedianAbove_LAI2200 = median(ABOVE)) %>%
  mutate(MeanAbove_LAI2200 = mean(ABOVE)) %>%
  mutate(SdAbove_LAI2200 = sd(ABOVE)) %>%
  mutate(SeAbove_LAI2200 = plotrix::std.error(ABOVE)) %>%
  ungroup() %>% 
  select(Ring, MedianAbove_LAI2200, MeanAbove_LAI2200, SdAbove_LAI2200, SeAbove_LAI2200) %>% 
  unique()

ggplot(DZ, aes(x = TimeA, y = ABOVE)) + 
  geom_point(aes(col = as.factor(Date))) +
  scale_x_time(breaks = hms::hms(minutes = seq(0, 3600, 5))) +
  facet_grid(vars(Ring), scales = "free") +
  geom_hline(data = DZmean, aes(yintercept = MeanAbove_LAI2200, linetype='Mean')) +
  geom_text(data = DZmean,
            mapping = aes(x= hms::as_hms("17:15:00"), y = MeanAbove_LAI2200+30,
                          label= as.character(round(MeanAbove_LAI2200))),
            size = 3) +
  scale_linetype_manual(name = "", values = "solid") +
  labs(color= "Date", y = "DZ light")

ggsave("LAI2200_DZ(A)_mean.png",
       path = "D:/Mes Donnees/PhD/Figures/Sensors/LAI2200",
       width = 25, height = 20, units = "cm", dpi=800, bg="white")

```

# HOBO
## LAI2200 data with HOBO 10
```{r, include = F}
LAI2200_LiDAR <- LAI2200_coord %>% 
  left_join(LAI2200_data, by= c("Transect", "Id")) %>% 
  mutate(Xutm = round(Xutm), 
         Yutm = round(Yutm),
         Zutm = round(Zutm)) %>% 
  left_join(LiDAR, by= c("Xutm","Yutm","Zutm", "Ring"))
```

## Load HOBO data
```{r, include = F}
HOBO_coord <- filter(LAI2200_coord, Transect=="HOBO") # HOBO sensors coordinates
HOBO_data <- read_csv("D:/Mes Donnees/PhD/Microclimate/HOBO/HOBO_Light_stats.csv") %>%  # HOBO sensors data
  rename(Id = HoboID)

names(HOBO_data) # "HoboID" "HOBO_Light_annual_sum" "HOBO_Light_sum_Dry" "HOBO_Light_sum_Wet" "HOBO_Light_october_sum"

HOBO <- HOBO_coord %>% 
  left_join(HOBO_data, by= "Id") %>% 
  mutate(Xutm = round(Xutm), 
         Yutm = round(Yutm),
         Zutm = round(Zutm)) %>% 
  # filter(Id==7) %>% 
  select(-c(Transect))
```

## Plot HOBO data
```{r}
HOBOUTMsf <- st_as_sf(HOBO, coords = c('Xutm','Yutm'))
HOBOUTMsf <- st_set_crs(HOBOUTMsf, crs(zone))

options(scipen = 999)
ggplot() +
  geom_sf(data = sf::st_cast(zone, "LINESTRING")) + # zone of interest
  geom_sf(data = HOBOUTMsf, aes(color = HOBO_Light_october_sum), size = 1.5) +
  scale_colour_gradientn(name =,
                         colors = terrain.colors(30, rev=T),
                         na.value="grey", labels = scales::comma) + 
  ggtitle("Paracou P16 4ha - HOBO Light (lux)")
```
## Combine HOBO with LiDAR and LAI2200 data (transmittance angulaire)
```{r}
HOBO_LAI2200_LiDAR <- LAI2200_LiDAR %>% # LAI2200_LiDAR
  left_join(HOBO, by= c("Id","Xutm","Yutm")) %>% 
  select(-c("...1.x","...1.y"))

# names(HOBO_LAI2200_LiDAR)
```

# Profils en long (Lux le long du transect)
Lux le long du transect

```{r}
# names(HOBO) #  "Id" "x"  "y""Xutm" "Yutm"  "Zutm""HOBO_Light_annual_sum" "HOBO_Light_sum_Dry" "HOBO_Light_sum_Wet"   "HOBO_Light_october_sum"

idmax = max(HOBO_LAI2200_LiDAR$Id) # last sensor Id

coeff <- 13600 # 14795.46 # 21099.87 # mean(data$HOBO_Light_annual_mean/data$MeanTransmittance_LAI2200, na.rm=T)

HOBO_LAI2200_LiDAR %>% 
  filter(Transect=="HOBO") %>% filter(Ring==2) %>% 
  ggplot(aes(x = Id)) +
  
  # Standard error
  geom_linerange(aes(ymin=HOBO_Light_annual_mean-HOBO_Light_annual_se,
                     ymax=HOBO_Light_annual_mean+HOBO_Light_annual_se, color = "Standard error")) + # ,  color = "Standard error"
  
  # LAI2200
  geom_linerange(aes(ymin=(MeanTransmittance_LAI2200-SeTransmittance_LAI2200)*coeff,
                     ymax=(MeanTransmittance_LAI2200+SeTransmittance_LAI2200)*coeff,
                     colour = "LAI2200 - Ring2")) +
  geom_point(aes(y = MeanTransmittance_LAI2200*coeff, colour = "LAI2200 - Ring2"), size=2) + 
  geom_line(aes(y = MeanTransmittance_LAI2200*coeff, colour = "LAI2200 - Ring2"), size=1) +
  
  # HOBO annual
  geom_linerange(aes(ymin=HOBO_Light_annual_mean-HOBO_Light_annual_se,
                     ymax=HOBO_Light_annual_mean+HOBO_Light_annual_se, colour = "HOBO annual")) +
  geom_point(aes(y = HOBO_Light_annual_mean, colour = "HOBO annual"), size=2) + # , colour = "Annual"
  geom_line(aes(y = HOBO_Light_annual_mean, colour = "HOBO annual"), size=1) +
  
  # October
  # geom_linerange(aes(ymin=HOBO_Light_october_mean-HOBO_Light_october_se,
  #                    ymax=HOBO_Light_october_mean+HOBO_Light_october_se,  color = "October")) +
  # geom_point(aes(y = HOBO_Light_october_mean, colour = "October")) +
  # geom_line(aes(y = HOBO_Light_october_mean, colour = "October")) +
  # 
  # # Dry season
  # geom_linerange(aes(ymin=HOBO_Light_mean_Dry-HOBO_Light_se_Dry,
  #                    ymax=HOBO_Light_mean_Dry+HOBO_Light_se_Dry,  color = "Dry season")) +
  # geom_point(aes(y = HOBO_Light_mean_Dry, colour = "Dry season")) +
# geom_line(aes(y = HOBO_Light_mean_Dry, colour = "Dry season")) +
# 
# # Wet season
# geom_linerange(aes(ymin=HOBO_Light_mean_Wet-HOBO_Light_se_Wet,
#                    ymax=HOBO_Light_mean_Wet+HOBO_Light_se_Wet, color = "Wet season")) +
# geom_point(aes(y = HOBO_Light_mean_Wet, colour = "Wet season")) +
# geom_line(aes(y = HOBO_Light_mean_Wet, colour = "Wet season")) +


scale_colour_manual(values = c("HOBO annual" = "#0072B2", # "#CC79A7"
                               # "Wet season" = "#0072B2",
                               # "Dry season" = "#999999",
                               # "October" = "#D55E00",
                               "LAI2200 - Ring2" = "#D55E00", # "orange"
                               "Standard error"= "#666666"),
                    breaks=c("LAI2200 - Ring2", "HOBO annual",
                             # "Dry season",  "Wet season",
                             # "October",
                             "Standard error")) +
  
  scale_y_continuous(
    # Features of the first axis
    name = "Average annual light (lux)",
    # Add a second axis and specify its features
    sec.axis = sec_axis(~./coeff, name="Transmittance")
  ) +
  
  # guides(colour = guide_legend(override.aes = list(linetype = c("blank", "solid"),
  #                                                  linewidth = 0.4))) +
  
  # guides(color = guide_legend(override.aes = list(
  #   linetype = 1, size = 0.5, shape = NA,
  #   ymax = df$ymax, ymin = df$ymin, x = df$x, y = df$y, width = 0.2)))+
  labs(x="Sensors ID", color = "Acquisition") + 
  # labs(title = "HOBO sensors light", x="Sensors ID", color = "Period") +
  scale_x_continuous(breaks = seq(1:idmax)) + # 26 # 20
  theme_minimal() +
  theme(title= element_text(size=22),
        axis.title.y.left= element_text(size=24, color = "#0072B2"),
        axis.title.y.right= element_text(size=24, color = "#D55E00"),
        axis.text= element_text(size=22), legend.title= element_text(size=22), legend.text= element_text(size=22))

ggsave("P16_2023_4ha_HOBO_LAI2200_light_annual_mean_se.png",
       path = "D:/Mes Donnees/PhD/Figures/Sensors",
       width = 40, height = 30, units = "cm", dpi=800, bg="white")

# ggsave("P16_2023_4ha_HOBO_light_lux_annual_mean_se.png",
#        path = "D:/Mes Donnees/PhD/Figures/HOBO",
#        width = 20, height = 15, units = "cm", dpi=800, bg="white")

# ggsave("P16_2023_4ha_HOBO_light_lux_mean_se.png",
#        path = "D:/Mes Donnees/PhD/Figures/HOBO",
#        width = 20, height = 15, units = "cm", dpi=800, bg="white")

```

## Correlations

### LAI2200 vs HOBO
```{r}
# prendre le sensor 10 du HOBO
DF_cor_HOBO_LAI2200 <- HOBO_LAI2200_LiDAR %>% 
  filter(Transect=="HOBO") %>% 
  select(Ring, 
         MeanTransmittance_LAI2200, MeanTransmittance_integrated,
         HOBO_Light_annual_mean,
         # HOBO_Light_mean_Dry, HOBO_Light_mean_Wet, HOBO_Light_october_mean
  ) %>% 
  unique() %>% 
  pivot_wider(names_from = Ring,
              values_from = MeanTransmittance_LAI2200,
              values_fn = list,
              names_glue = "{.value}_Ring{Ring}")  #%>% 
# unnest(cols = everything()) # pcq les colonnes sont en listes


DF_cor_HOBO_LAI2200 <- as.data.frame(DF_cor_HOBO_LAI2200) # remove HOBO without values

DF_cor_HOBO_LAI2200 <- sapply(DF_cor_HOBO_LAI2200, as.numeric)
DF_cor_HOBO_LAI2200 <- as.data.frame(DF_cor_HOBO_LAI2200) %>% 
  # Correction des rings 4 et 5 d'après la transmittance estimée de la DZ au LiDAR
  mutate(MeanTransmittance_LAI2200_Ring4 = MeanTransmittance_LAI2200_Ring4*0.96) %>% 
  mutate(MeanTransmittance_LAI2200_Ring5 = MeanTransmittance_LAI2200_Ring5*0.23) 


names(DF_cor_HOBO_LAI2200) <- str_remove(names(DF_cor_HOBO_LAI2200), "MeanTransmittance_") # simplify the var names
names(DF_cor_HOBO_LAI2200) <- str_remove(names(DF_cor_HOBO_LAI2200), "_Light") # simplify the var names
names(DF_cor_HOBO_LAI2200) <- str_remove(names(DF_cor_HOBO_LAI2200), "_mean") # simplify the var names

DF_cor_HOBO_LAI2200 <- DF_cor_HOBO_LAI2200 %>% rename(LAI2200_integrated = integrated)

CorMatrixS <- Hmisc::rcorr(as.matrix(DF_cor_HOBO_LAI2200))
CorMatrix <- round(CorMatrixS$r, digits = 2)  # matrice de corrélation
Pval_corr <- CorMatrixS$P # p-values

write.csv(CorMatrix, "D:/Mes Donnees/PhD/Figures/lidar/Correlations/Correlations/Intensity_1m/Correlation_plot_HOBOvsLAI2200.csv")

# Plot de la matrice de corrélation :
png("D:/Mes Donnees/PhD/Figures/Sensors/Correlation_plot_HOBOvsLAI2200.png", width = 1000, height = 743, pointsize=20)

corrplot(CorMatrix, method="color", col=brewer.pal(n=6, name="PuBu")[2:6],  # "PuOr"
         type="upper",
         tl.col="black", tl.cex = 1, #Text label color
         addCoef.col = "white", # Add coefficient of correlation
         number.cex = 1, # values
         is.corr = F, # to range the legend with the values
         col.lim=c(0, 1), # to limit the legend
         p.mat = Pval_corr, #avec une croix pour les p-value > 0.05 (sig.level = 0.05)
         # hide correlation coefficient on the principal diagonal
         diag=FALSE) 

dev.off()
```


### HOBO vs LiDAR
```{r}
# MeanTransmittance_LAI2200, Transmittance_Low, Transmittance_High, HOBO_Light_october_sum, HOBO_Light_annual_sum

DF_cor_HOBO_LAI2200_LiDAR <- HOBO_LAI2200_LiDAR %>% 
  filter(Transect=="HOBO") %>%
  # filter(Ring==1 | Ring==2) %>%
  select(Ring, MeanTransmittance_HighInt2m,MeanTransmittance_LowInt2m,
         MeanTransmittance_HighInt1m, MeanTransmittance_LowInt1m,
         MeanTransmittance_UAVInt2m, MeanTransmittance_UAVInt1m, 
         MeanTransmittance_LAI2200,
         HOBO_Light_annual_mean,
         # HOBO_Light_mean_Dry, HOBO_Light_mean_Wet, HOBO_Light_october_mean
  ) %>% 
  unique() %>% 
  pivot_wider(names_from = Ring,
              values_from = c(
                MeanTransmittance_LAI2200,
                MeanTransmittance_HighInt2m, MeanTransmittance_LowInt2m,
                MeanTransmittance_HighInt1m, MeanTransmittance_LowInt1m,
                MeanTransmittance_UAVInt2m, MeanTransmittance_UAVInt1m),
              values_fn = list,
              names_glue = "{.value}_Ring{Ring}") %>% 
  # unnest() # pcq les colonnes sont en listes
  na.omit()
DF_cor_HOBO_LAI2200_LiDAR <- as.data.frame(DF_cor_HOBO_LAI2200_LiDAR) # remove HOBO without values

DF_cor_HOBO_LAI2200_LiDAR <- sapply(DF_cor_HOBO_LAI2200_LiDAR, as.numeric)
DF_cor_HOBO_LAI2200_LiDAR <- as.data.frame(DF_cor_HOBO_LAI2200_LiDAR)

names(DF_cor_HOBO_LAI2200_LiDAR) <- str_remove(names(DF_cor_HOBO_LAI2200_LiDAR), "MeanTransmittance_") # simplify the var names
names(DF_cor_HOBO_LAI2200_LiDAR) <- str_remove(names(DF_cor_HOBO_LAI2200_LiDAR), "_Light") # simplify the var names
names(DF_cor_HOBO_LAI2200_LiDAR) <- str_remove(names(DF_cor_HOBO_LAI2200_LiDAR), "_mean") # simplify the var names

CorMatrixS <- Hmisc::rcorr(as.matrix(DF_cor_HOBO_LAI2200_LiDAR))
CorMatrix <- round(CorMatrixS$r, digits = 2)  # matrice de corrélation
Pval_corr <- CorMatrixS$P # p-values

write.csv(CorMatrix, "D:/Mes Donnees/PhD/Figures/lidar/Correlations/Correlations/Intensity_1m/Correlation_plot_HOBOLAI2200vsLiDAR_ALS_and_UAV_byRing_intensity.csv")

# Plot de la matrice de corrélation :
png("D:/Mes Donnees/PhD/Figures/lidar/Correlations/Correlations/Intensity_1m/Correlation_plot_HOBOLAI2200vsLiDAR_ALS_and_UAV_byRing_intensity.png", width = 1000, height = 743, pointsize=20)

corrplot(CorMatrix[1:3,], method="color", col=brewer.pal(n=8, name="PuOr"),  
         type="full",
         # order="hclust",
         tl.col="black", tl.cex = 0.8, #Text label color
         addCoef.col = "white", # number.digits = 1, # Add coefficient of correlation
         number.cex = 0.5, # values
         sig.level = 0.0001,
         p.mat = Pval_corr, #avec une croix pour les p-value > 0.05 (sig.level = 0.05)
         # hide correlation coefficient on the principal diagonal
         diag=FALSE) 

dev.off()
```

### Version seulement corr >0.5
```{r}
# inspired by the function of Catherine Williams
onlySignCorr <- function(df, file){
  corr <- cor(df)
  
  #drop perfect correlations
  corr[corr == 1.00] <- NA 
  #turn into a 3-column table
  corr <- as.data.frame(as.table(corr))
  #remove the NA values from above 
  corr <- na.omit(corr) 
  
  #select significant values  
  corr <- subset(corr, abs(Freq) > 0.5) 
  #sort by highest correlation
  corr <- corr[order(-abs(corr$Freq)),] 
  # print(corr)
  #turn corr back into matrix in order to plot with corrplot
  mtx_corr <- reshape2::acast(corr, Var1~Var2, value.var="Freq")
  
  #plot correlations visually
  # corrplot(mtx_corr, type="upper", is.corr=FALSE, tl.col="black", na.label=" ")
  
  # file <- "LiDAR_vs_LAI2200"
  # file <- "LiDAR_Acquisitions"
  png(paste("D:/Mes Donnees/PhD/Figures/lidar/Correlations/Correlations/Intensity_2m/Correlation_plot_",file,"_sup0_5.png", sep=""),
      width = 1000, height = 743, pointsize=20)
  
  corrplot(mtx_corr, method="color", col=brewer.pal(n=8, name="PuOr"),  
           type="upper",
           # order="hclust",
           addCoef.col = "white", # Add coefficient of correlation
           tl.col="black", tl.cex = 0.8, #Text label color and rotation
           number.cex = 0.5, # number.digits = 1,# values
           # hide correlation coefficient on the principal diagonal
           diag=FALSE, na.label=" ") 
  
  dev.off()
}

onlySignCorr(DF_cor_HOBO_LAI2200_LiDAR, "LiDAR_vs_LAI2200_HOBO")

```

The HOBO are more correlated with the LAI2200 than with the LiDAR.
The HOBO are correlated only with the 1st and 2nd LiDAR Rings.
The annual HOBO are more correlated with the LiDAR than the October HOBO.
The HOBO are more correlated with the Low altitude than with the High altitude LiDAR.

```{r, eval=F}
LiDAR <- LowAnnual %>% 
  left_join(HighAnnual, by= c("Xutm","Yutm","Z")) %>% 
  left_join(HighWet, by= c("Xutm","Yutm","Z")) %>% 
  left_join(HighDry, by= c("Xutm","Yutm","Z")) %>%
  rename(Zutm = Z) %>%
  mutate(Xutm = round(Xutm), 
         Yutm = round(Yutm),
         Zutm = round(Zutm))

HOBO_LiDAR %>% 
  ggplot() +
  aes(x = Light, y = Transmittance_HighDry) +
  geom_point(aes(y = Transmittance_LowAnnual), color = "green") +
  geom_point(aes(y = Transmittance_HighAnnual), color = "darkgreen") +
  geom_point(aes(y = Transmittance_HighWet), color = "blue")  +
  geom_point(aes(y = Transmittance_HighDry), color = "orange")+
  stat_smooth(method = "lm",
              formula = y ~ x) +
  labs(x ="Light (lux)", y = "LiDAR transmittance")

# Correlation tests
# Light, Temperature, Transmittance_LowAnnual, Transmittance_HighAnnual,Transmittance_HighDry, Transmittance_HighWet

DF_cor <- HOBOTomst_LiDAR %>% 
  select(Light, Temperature,Transmittance_LowAnnual,Transmittance_HighAnnual,Transmittance_HighDry,Transmittance_HighWet) # 
# na.omit()

CorMatrixS <- Hmisc::rcorr(as.matrix(DF_cor))
CorMatrix <- round(CorMatrixS$r, digits = 2)  # matrice de corrélation
Pval_corr <- CorMatrixS$P # p-values

# Plot de la matrice de corrélation :
# png("D:/Mes Donnees/PhD/Figures/Corplot_pedo_chimie.png", width = 900, height = 800)
corrplot(CorMatrix, method="circle", type="lower", diag = F, addCoef.col = 'white', 
         number.cex = 0.7, col=brewer.pal(n=8, name="PuOr"),
         tl.col="black", tl.cex = 1, tl.srt=45, p.mat = Pval_corr)

```

## Regresion
```{r, eval=F}
options(scipen = 999)
for(acq in c("Period.1_HighAlt", "Period.1_LowAlt")){
  print(
    HOBO_LiDAR %>% 
      na.omit() %>% 
      ggplot() +
      ggtitle("Paracou P16 4ha - LiDAR transmittances vs HOBO light (lux)") +
      aes(x = get(acq), y = HOBO_Light_annual_sum) +
      geom_point() +
      stat_smooth(method = "lm",
                  formula = y ~ x) +
      ggpubr::stat_cor(label.x = 0.01, label.y = 40000000) +
      ggpubr::stat_regline_equation(label.x = 0.01, label.y = 37000000) +
      scale_y_continuous(labels = scales::comma) +
      labs(x = acq, y = "HOBO light (lux)", color = "LiDAR acquisition") 
  )
}
```