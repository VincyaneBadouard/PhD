---
title: "Compare LiDAR with field sensors data"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: pdf_document
---


# LAI2200

## Positionner capteurs LAI2200 sur la carte de lumière dans AMAPvox

A cette étape la transmittance est calculée à des **angles déterminés** à **lumière diffuse du soleil** (+ sensible à l'erreur d'échantillonage du LiDAR).

## Metadata
* Ring : secteur angulaire, allant du zénith à l'horizon.
* transmittance
* GAP[1-5] : Gap fraction based on average of the log of the individual transmittances directionnelles calculées par positions (posX, posY, posZ) et par secteur angulaire (1 à 5) (pas intéressant pour nous)
* LAI (pas fiable)

* pathLength => distance entre position et sortie de la canopée

* isOut? => le rayon testé est-il arrivé en limite de l'espace voxel avant d'arriver en sortie de canopée ?

* azimut, elevation => les coordonnées sphériques du rayon
* cross_NA => le rayon a-til rencontré un voxel non échantilloné sur son trajet (voxel NA) ?

```{r, include = F}
library(tidyverse)
library(data.table)
library(sf)
library(terra)
library(tidyverse)
library(corrplot)
library(RColorBrewer)
```

## Load Lidar data
LAI_GAP : "posX", "posY", "posZ", "LAI", "GAP[1]" "GAP[2]" "GAP[3]" "GAP[4]" "GAP[5]"
trans : "position.x", "position.y", "position.z", "ring", "transmittance", azimut
```{r, include = F}
# LowAnnual <- read_csv("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/P16_2023_4ha_LowAlt_Light_annual_1m_UTM.csv") %>% 
#   mutate(Transmittance_LowAnnual = `Period.1`) %>% select(Xutm, Yutm, Z, Transmittance_LowAnnual)
# HighAnnual <- read_csv("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_HighAlt_4ha_Light_annual_1m_UTM.csv") %>% 
#   mutate(Transmittance_HighAnnual = `Period.1`) %>% select(Xutm, Yutm, Z, Transmittance_HighAnnual)

HighAnnual_LAI_GAP <- read_table("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_HighAlt_4ha_buffer_LAI2200sim") %>% 
  # mutate(LiDAR = "HighAlt") %>% 
  rename_with(.fn = ~paste0(., "_High"), .cols = c("LAI", "GAP[1]", "GAP[2]", "GAP[3]", "GAP[4]", "GAP[5]"))
HighAnnual_trans <- read_table("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_HighAlt_4ha_buffer_LAI2200sim_test.txt") %>% 
  # mutate(LiDAR = "HighAlt") %>% 
  rename(Transmittance_High = transmittance) %>% 
  select(-c(position.ID, pathLength, isOut, elevation, cross_NA))
LowAnnual_LAI_GAP <- read_table("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/P16_2023_4ha_buffer_LowAlt_LAI2200sim") %>% 
  # mutate(LiDAR = "LowAlt") %>% 
  rename_with(.fn = ~paste0(., "_Low"), .cols = c("LAI", "GAP[1]", "GAP[2]", "GAP[3]", "GAP[4]", "GAP[5]"))
LowAnnual_trans <- read_table("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/P16_2023_4ha_buffer_LowAlt_LAI2200sim_test.txt") %>% 
  # mutate(LiDAR = "LowAlt") %>% 
  rename(Transmittance_Low = transmittance) %>% 
  select(-c(position.ID, pathLength, isOut, elevation, cross_NA))

names(HighAnnual_LAI_GAP) # "posX", "posY", "posZ", "LAI", "GAP[1]" "GAP[2]" "GAP[3]" "GAP[4]" "GAP[5]"
names(HighAnnual_trans) # "position.x", "position.y", "position.z", "ring", "transmittance", azimut
# elevation normal que >1 ? autres variables ?

Trans <- unique(HighAnnual_trans %>% left_join(LowAnnual_trans, by= c("position.x", "position.y", "position.z", "ring", "azimut")))

LAI_GAP <- unique(HighAnnual_LAI_GAP %>% left_join(LowAnnual_LAI_GAP, by= c("posX", "posY", "posZ")))

Lidar <- setDT(unique(Trans %>% left_join(LAI_GAP, by= c("position.x"="posX", "position.y"="posY", "position.z"="posZ"))))
```

## Local to UTM coord
```{r}
# Lecture matrice de transformation
VOP <- as.matrix(read.table("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/VOP_P16_9ha.txt"))

# Apply inverse of VOP matrix to convert back to UTM
xyz <- tcrossprod(as.matrix(Lidar[, .(position.x, position.y, position.z, c=1)]), solve(VOP))
Lidar[, `:=`(Xutm = xyz[, 1], Yutm = xyz[, 2], Zutm = xyz[, 3])]
Lidar <- setDF(Lidar) %>% rename(Ring= ring) %>% 
  mutate(Xutm = round(Xutm), 
         Yutm = round(Yutm),
         Zutm = round(Zutm))
```

## Plot Lidar data
```{r}
zone <- st_as_sf(vect("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2022/Parcelles_Understory.shp")) # 4 carrés

Lidarsf <- st_as_sf(Lidar, coords = c('Xutm','Yutm'))
Lidarsf <- st_set_crs(Lidarsf, crs(zone))

plot(Lidarsf$Transmittance_High)

Lidarsf <- Lidarsf %>% filter(Ring==1) %>% filter(azimut==0)

Lidarsf %>% 
  select(geometry, Transmittance_High) %>% #  Transmittance_High,Transmittance_Low, `GAP[1]_High`,`GAP[1]_Low`, LAI_High, LAI_Low
  ggplot() +
  geom_sf(data = sf::st_cast(zone, "LINESTRING")) + # zone of interest
  geom_sf(data = Lidarsf, aes(color = Transmittance_High), size = 1.5) +
  scale_colour_gradientn(colors = terrain.colors(30, rev=T),
                         na.value="grey") +
  ggtitle("Paracou P16 4ha - Lidar LAI2200 simulations")
```

## Load LAI2200 data
```{r}
LAI2200_coord <- read_csv("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LAI2200_theoretical_UTMxyz.csv") # LAI2200 sensors coordinates
LAI2200_data <- read_csv("D:/Mes Donnees/PhD/Light/LAI-2200/LAI2200_data.csv") # LAI2200 sensors data

names(LAI2200_coord) # "Transect", "Id", "Xutm","Yutm","Zutm"
names(LAI2200_data) # "Id", "Transect", "Ring", "Transmittance_mean" (Transmittance_mean for each sensor and for each ring)

LAI2200 <- LAI2200_coord %>% 
  left_join(LAI2200_data, by= c("Transect", "Id")) %>% 
  mutate(Xutm = round(Xutm), 
         Yutm = round(Yutm),
         Zutm = round(Zutm))
```

## Plot LAI2200 data
```{r}
LAI2200UTMsf <- st_as_sf(LAI2200, coords = c('Xutm','Yutm'))
LAI2200UTMsf <- st_set_crs(LAI2200UTMsf, crs(zone))

LAI2200UTMsf <- LAI2200UTMsf %>% filter(Ring=="Ring1")

ggplot() +
  geom_sf(data = sf::st_cast(zone, "LINESTRING")) + # zone of interest
  geom_sf(data = LAI2200UTMsf, aes(color = Transmittance_mean), size = 1.5) +
  scale_colour_gradientn(colors = terrain.colors(30, rev=T),
                         na.value="grey") +
  ggtitle("Paracou P16 4ha - LAI2200 Transmittances")
```

## Combine LiDAR and LAI2200 data
```{r}
LAI2200_Lidar <- LAI2200 %>% 
  mutate(Ring = case_when(
    Ring == "Ring1" ~ 1,
    Ring == "Ring2" ~ 2,
    Ring == "Ring3" ~ 3,
    Ring == "Ring4" ~ 4,
    Ring == "Ring5" ~ 5)) %>% 
  left_join(Lidar, by= c("Xutm","Yutm","Zutm", "Ring")) %>% 
  rename(Transmittance_LAI2200 = Transmittance_mean)

NA_table <- LAI2200_Lidar[rowSums(is.na(LAI2200_Lidar[, 34:47])) > 0,] # NA ?
```
# Difference plots
```{r}
LAI2200_Lidar <- LAI2200_Lidar %>% 
  select(Sensor,Transect,Id, Xutm,Yutm, Ring,azimut,Transmittance_LAI2200,Transmittance_High,Transmittance_Low, `GAP[1]_High`, `GAP[1]_Low`) %>% 
  unique() %>% 
  # compute differences (4-3=1, le rslt informe sur la valeur à laquelle on soustrait)
  mutate(Transmittance_LowvsHigh =  Transmittance_Low - Transmittance_High) %>% 
  mutate(Transmittance_HighvsLAI2200 = Transmittance_High -Transmittance_LAI2200) %>% 
  mutate(Transmittance_LowvsLAI2200 = Transmittance_Low - Transmittance_LAI2200)

LAI2200_Lidar1 <- LAI2200_Lidar %>% filter(Ring==1) %>% filter(azimut==0) 

LAI2200_Lidarsf <- st_as_sf(LAI2200_Lidar1, coords = c('Xutm','Yutm'))
LAI2200_Lidarsf <- st_set_crs(LAI2200_Lidarsf, crs(zone))

# LAI2200_Lidarsf <- LAI2200_Lidarsf %>% filter(Ring==1) %>% filter(azimut==0)

# Transmittance_LowvsHigh ; Transmittance_HighvsLAI2200 ; Transmittance_LowvsLAI2200

for(v in c("Transmittance_LowvsHigh", "Transmittance_HighvsLAI2200", "Transmittance_LowvsLAI2200")){
  print(
    ggplot() +
      geom_sf(data = sf::st_cast(zone, "LINESTRING")) + # zone of interest
      geom_sf(data = LAI2200_Lidarsf, aes(color = get(v)), size = 0.9) + 
      # scale_colour_gradientn(colors = terrain.colors(30, rev=T),
      #                        na.value="grey") +
      scale_color_gradient2(name = v,
                            low="blue", high="#FC4E07", mid = "white", midpoint = 0) +
      ggtitle("Paracou P16 4ha - Transmittances differences") +
      labs(color = v)
  )
}
```

```{r}
LAI2200_Lidar %>% 
  filter(Ring==1) %>% filter(azimut==0) %>%
  ggplot() +
  ggtitle("Paracou P16 4ha - Transmittances differences") +
  aes(x = Transmittance_High, y = Transmittance_LowvsHigh) +
  geom_point() +
  geom_hline(yintercept=0) +
  geom_segment(aes(yend=0)) +
  coord_fixed(ratio=1) +
  labs(x ="High altitude transmittance", y = "Low - High altitude transmittances")

for(v in c("Transmittance_HighvsLAI2200", "Transmittance_LowvsLAI2200")){
  print(
    LAI2200_Lidar %>% 
      filter(Ring==1) %>% filter(azimut==0) %>%
      ggplot() +
      ggtitle("Paracou P16 4ha - Transmittances differences") +
      aes(x = Transmittance_LAI2200, y = get(v)) +
      geom_point() +
      geom_hline(yintercept=0) +
      geom_segment(aes(yend=0)) +
      coord_fixed(ratio=1) +# same axis size
      labs(x ="LAI2200 transmittance", y = v)
  ) 
}
```
# Profils en long (Transmittances le long du transect)
Transmittances le long du transect pour les différentes acquisitions LiDAR et le LAI2200
pour chaque ring
```{r}
# Transmittance_LAI2200, Transmittance_Low, Transmittance_High

LAI2200_Lidar %>% 
  filter(Transect=="HOBO") %>% # LAY # HOBO
  filter(Ring==2) %>% filter(azimut==0) %>%
  ggplot(aes(x = Id)) +
  geom_point(aes(y = Transmittance_High, colour = "High altitude")) +
  geom_line(aes(y = Transmittance_High, colour = "High altitude")) +
  
  geom_point(aes(y = Transmittance_Low, colour = "Low altitude")) +
  geom_line(aes(y = Transmittance_Low, colour = "Low altitude")) +
  
  geom_point(aes(y = Transmittance_LAI2200, colour = "LAI2200")) +
  geom_line(aes(y = Transmittance_LAI2200, colour = "LAI2200"), linewidth = 1.5) +
  
  scale_colour_manual(values = c("High altitude" = "darkgreen",
                                 "Low altitude" = "#00CC66",
                                 "LAI2200" = "red"),
                      breaks=c("LAI2200", "High altitude", "Low altitude")) +
  labs(title = "HOBO tansect - Ring2", y="Transmittance", x="ID", color = "Acquisition") +
  scale_x_continuous(breaks = seq(1:20)) # 26 # 20

```

# Relations plots
```{r}
LAI2200_Lidar %>% 
  filter(Ring==1) %>% filter(azimut==0) %>%
  ggplot() +
  ggtitle("Paracou P16 4ha - Lidar transmittance High vs Low altitude") +
  aes(x = Transmittance_High, y = Transmittance_Low) +
  geom_point() +
  stat_smooth(method = "lm",
              formula = y ~ x) +
  geom_abline() +
  # xlim(0,1) +
  # ylim(0,1) +
  coord_fixed(ratio=1) # same axis size


LAI2200_Lidar %>% 
  filter(Ring==1) %>% filter(azimut==0) %>%
  ggplot() +
  ggtitle("Paracou P16 4ha - High and Low altitude Lidar vs LAI2200 transmittances") +
  aes(x = Transmittance_LAI2200, y = Transmittance_Low) +
  geom_point(aes(y = Transmittance_Low, colour = "Low altitude")) +
  geom_point(aes(y = Transmittance_High, colour = "High altitude")) +
  scale_colour_manual(values = c("Low altitude" = "green", 
                                 "High altitude" = "darkgreen")) +
  stat_smooth(method = "lm",
              formula = y ~ x) +
  geom_abline() +
  coord_fixed(ratio=1) + # same axis size
  labs(x ="LAI2200 transmittance", y = "LiDAR transmittance", color = "LiDAR acquisition")

LAI2200_Lidar %>% 
  filter(Ring==1) %>% filter(azimut==0) %>%
  ggplot() +
  ggtitle("Paracou P16 4ha - GAP of High and Low altitude Lidar vs LAI2200 transmittances") +
  aes(x = Transmittance_LAI2200, y = `GAP[1]_Low`) +
  geom_point(aes(y = `GAP[1]_Low`, colour = "Low altitude")) +
  geom_point(aes(y = `GAP[1]_High`, colour = "High altitude")) +
  scale_colour_manual(values = c("Low altitude" = "green", 
                                 "High altitude" = "darkgreen")) +
  stat_smooth(method = "lm",
              formula = y ~ x) +
  labs(x ="LAI2200 transmittance", y = "GAP[1]", color = "LiDAR acquisition")
```
## Zoom
```{r}
LAI2200_Lidar %>% 
  filter(Ring==1) %>% filter(azimut==0) %>%
  filter(Transmittance_High<0.3) %>% 
  ggplot() +
  ggtitle("Paracou P16 4ha - Lidar transmittance High vs Low altitude (< 0.3)") +
  aes(x = Transmittance_High, y = Transmittance_Low) +
  geom_point() +
  stat_smooth(method = "lm",
              formula = y ~ x) +
  geom_abline() +
  xlim(0,0.3) +
  ylim(0,0.3) +
  coord_fixed(ratio=1) # same axis size

LAI2200_Lidar %>% 
  filter(Ring==1) %>% filter(azimut==0) %>%
  filter(Transmittance_LAI2200<0.1) %>% 
  ggplot() +
  ggtitle("Paracou P16 4ha - High and Low altitude Lidar vs LAI2200 transmittances (< 0.1)") +
  aes(x = Transmittance_LAI2200, y = Transmittance_Low) +
  geom_point(aes(y = Transmittance_Low, colour = "Low altitude")) +
  geom_point(aes(y = Transmittance_High, colour = "High altitude")) +
  scale_colour_manual(values = c("Low altitude" = "green", 
                                 "High altitude" = "darkgreen")) +
  stat_smooth(method = "lm",
              formula = y ~ x) +
  geom_abline() +
  xlim(0,0.1) +
  ylim(0,0.1) +
  coord_fixed(ratio=1) + # same axis size
  labs(x ="LAI2200 transmittance", y = "LiDAR transmittance", color = "LiDAR acquisition")

LAI2200_Lidar %>% 
  filter(Ring==1) %>% filter(azimut==0) %>%
  filter(Transmittance_LAI2200<0.1) %>% 
  ggplot() +
  ggtitle("Paracou P16 4ha - GAP of High and Low altitude Lidar vs LAI2200 transmittances (< 0.1)") +
  aes(x = Transmittance_LAI2200, y = `GAP[1]_Low`) +
  geom_point(aes(y = `GAP[1]_Low`, colour = "Low altitude")) +
  geom_point(aes(y = `GAP[1]_High`, colour = "High altitude")) +
  scale_colour_manual(values = c("Low altitude" = "green", 
                                 "High altitude" = "darkgreen")) +
  stat_smooth(method = "lm",
              formula = y ~ x) +
  labs(x ="LAI2200 transmittance", y = "GAP[1]", color = "LiDAR acquisition")
```

## Correlation tests
```{r}
# Transmittance_LAI2200, Transmittance_Low, Transmittance_High

DF_cor <- LAI2200_Lidar %>% 
  filter(Ring==1) %>% filter(azimut==0) %>%
  select(Transmittance_LAI2200,Transmittance_High,Transmittance_Low, `GAP[1]_High`,`GAP[1]_Low`, LAI_High, LAI_Low) 
# na.omit()

CorMatrixS <- Hmisc::rcorr(as.matrix(DF_cor))
CorMatrix <- round(CorMatrixS$r, digits = 2)  # matrice de corrélation
Pval_corr <- CorMatrixS$P # p-values

# Plot de la matrice de corrélation :
# png("D:/Mes Donnees/PhD/Figures/Corplot_pedo_chimie.png", width = 900, height = 800)
corrplot(CorMatrix, method="circle", type="lower", diag = F, 
         col=brewer.pal(n=8, name="PuOr"), tl.col="black", tl.cex = 0.9, tl.srt=45, p.mat = Pval_corr)
# dev.off()

```


# HOBO & Tomst
```{r}
LowAnnual <- read_csv("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/P16_2023_4ha_LowAlt_Light_annual_1m_UTM.csv") %>% 
  mutate(Transmittance_LowAnnual = `Period.1`) %>% select(Xutm, Yutm, Z, Transmittance_LowAnnual)
HighAnnual <- read_csv("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_HighAlt_4ha_Light_annual_1m_UTM.csv") %>% 
  mutate(Transmittance_HighAnnual = `Period.1`) %>% select(Xutm, Yutm, Z, Transmittance_HighAnnual)
HighWet <- read_csv("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_HighAlt_4ha_Light_Wet_1m_UTM.csv") %>% 
  rowwise() %>% 
  mutate(Transmittance_HighWet = weighted.mean(c(`Period.1`, `Period.2`, `Period.3`), c(4, 2, 1)/7)) %>% # weighted mean by period size
  ungroup() %>%
  select(Xutm, Yutm, Z, Transmittance_HighWet)
HighDry <- read_csv("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/P16_2023_HighAlt_4ha_Light_Dry_1m_UTM.csv") %>% 
  rowwise() %>% 
  mutate(Transmittance_HighDry = weighted.mean(c(`Period.1`, `Period.2`), c(1, 4)/5)) %>% # weighted mean by period size
  ungroup() %>% 
  select(Xutm, Yutm, Z, Transmittance_HighDry)


LiDAR <- LowAnnual %>% 
  left_join(HighAnnual, by= c("Xutm","Yutm","Z")) %>% 
  left_join(HighWet, by= c("Xutm","Yutm","Z")) %>% 
  left_join(HighDry, by= c("Xutm","Yutm","Z")) %>%
  rename(Zutm = Z) %>%
  mutate(Xutm = round(Xutm), 
         Yutm = round(Yutm),
         Zutm = round(Zutm))

HOBO_Lidar %>% 
  ggplot() +
  aes(x = Light, y = Transmittance_HighDry) +
  geom_point(aes(y = Transmittance_LowAnnual), color = "green") +
  geom_point(aes(y = Transmittance_HighAnnual), color = "darkgreen") +
  geom_point(aes(y = Transmittance_HighWet), color = "blue")  +
  geom_point(aes(y = Transmittance_HighDry), color = "orange")+
  stat_smooth(method = "lm",
              formula = y ~ x) +
  labs(x ="Light (lux)", y = "LiDAR transmittance")

# Correlation tests
# Light, Temperature, Transmittance_LowAnnual, Transmittance_HighAnnual,Transmittance_HighDry, Transmittance_HighWet

DF_cor <- HOBOTomst_Lidar %>% 
  select(Light, Temperature,Transmittance_LowAnnual,Transmittance_HighAnnual,Transmittance_HighDry,Transmittance_HighWet) # 
# na.omit()

CorMatrixS <- Hmisc::rcorr(as.matrix(DF_cor))
CorMatrix <- round(CorMatrixS$r, digits = 2)  # matrice de corrélation
Pval_corr <- CorMatrixS$P # p-values

# Plot de la matrice de corrélation :
# png("D:/Mes Donnees/PhD/Figures/Corplot_pedo_chimie.png", width = 900, height = 800)
corrplot(CorMatrix, method="circle", type="lower", diag = F,
         col=brewer.pal(n=8, name="PuOr"), tl.col="black", tl.cex = 0.7, tl.srt=45)
# dev.off()

```

