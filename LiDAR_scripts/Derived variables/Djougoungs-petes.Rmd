---
title: "Djougoungs-petes"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: html_document
---
Est-ce qu’on les voit au LiDAR ?
voir sur Fugroviewer ou qgis (d'abord) : triangulation des points sols (tin)


# Packages
```{r, include = F}
library(tidyverse)
library(lidR)
library(data.table)
library(rgl) # visualisation 3D
library(terra)
library(sf)
library(ggplot2)
library(tidyterra)
```


## Import Djougoungs map
```{r}
Thalweg_Djougoung <- st_read("D:/Mes Donnees/PhD/SIG_data/Djougoung-petes/Thalwegs.shp")

Paracou <- st_read("D:/Mes Donnees/PhD/SIG_data/Plots Paracou/OverallPlots.shp")
```

```{r}
Paracou_Plot <- Paracou %>% 
  filter(Project == "ParacouCIRAD") %>% 
  filter(Subplot == 2) %>% 
  select(Plot, geometry) %>% 
  unique()

ggplot() + 
  geom_sf(data = Paracou) + 
  geom_sf_text(data = Paracou_Plot, aes(label = Plot), colour = "black") +
  geom_sf(data = Thalweg_Djougoung, aes(fill = Type)) + 
  ggtitle("Paracou 2019 - Thalwegs and Djougoung petes") + 
  coord_sf()
```
On trouve des Djougoungs pétés dans 8 parcelles (P2, P5, P6, P7, P9, P11, P13 et P15).

Leur superficie est la plus étendue dans les parcelles **P13** et **P11**.

# P13 scanned by ALS in 2022 

## Plot 13 geometry
```{r}
shpGuyafor <- raster::shapefile("D:/Mes Donnees/PhD/SIG_data/Guyafor/GuyaforSubPlots.shp")

shpParacou <- shpGuyafor[shpGuyafor@data$Forest == "Paracou",]
plot(shpParacou, col = shpParacou@data$Plot == "13")

Plot13 <- shpParacou[shpParacou@data$Plot == "13",]
plot(Plot13)
```

## Import P13 scanned by ALS in 2022  
```{r}
# "Y:/lidar/ALS/Paracou/2022/TiledClassified"
ctg <- readLAScatalog(folder= "D:/Mes Donnees/PhD/Lidar/ALS2022/P13" ) # las catalog
# 4 carrés
crs(ctg) # no crs
plot(ctg, map = TRUE)

ctg <- st_set_crs(ctg, 2972) # attribuer le dernier crs
```

```{r}
# trajfilenames <- list.files("D:/Mes Donnees/PhD/Lidar/ALS2022/P13", pattern="*.laz", full.names=TRUE) # catch the name of all the files of the folder
# 
# df_list <- lapply(trajfilenames, readLAS) # read all the folder files
# ALSP13 <- bind_rows(df_list)
```


# Clip for just the plot 13
```{r}
# Region of Interest (ROI): the plot 13
ROI <- Plot13
class(ROI) # SpatVector (terra)

ROI <- st_as_sf(ROI) # as sf object
ROI <- st_set_crs(ROI, 2972) # attribuer le dernier crs
crs(ROI)
plot(ROI)
# Clip the point cloud in region of interest
PC <- clip_roi(las = ctg, geometry = ROI) # très long
str(PC) # List of 4 las

# Join the 4 las
PC[[1]] <- st_set_crs(PC[[1]], 2972)
PC <- rbind(PC[[1]], PC[[2]], PC[[3]], PC[[4]])
lidR::plot(PC) 
```

```{r}
# las <- merge_spatial(ALSP13, Plot13, "inpoly")
# las$Classification[las$inpoly == TRUE] <- "IN"
# las$Classification[las$inpoly == FALSE & las$Classification != LASGROUND] <- "OUT"
# plot(las, color = "Classification")
# 
# P13las = filter_poi(las, inpoly == TRUE)
# plot(P13las)
```

## Enlever le bruit (sous sol et au dessus canopée)
```{r}
table(PC@data$Classification) # 7 = bruit, 2 = sol, veg = 3,4,5
PC@data <- PC@data[Classification != 7,]
lidR::plot(PC) 

# Write
# writeLAS(PC, "D:/Mes Donnees/PhD/Lidar/ALS2022/P13/P13_2022.laz")

# Read
PC <- lidR::readLAS(files = "D:/Mes Donnees/PhD/Lidar/ALS2022/P13/P13_2022.laz")

ST <- PC
plot(ST)
```

## Generate a DTM
https://r-lidar.github.io/lidRbook/dtm.html
```{r}
# triangulation sans rasteriser
dtm1 = grid_terrain(ST, 1, tin())
sdtm1 = shade(dtm1)

dtm2 = grid_terrain(ST, 1, tin(), is_concave = TRUE)
sdtm2 = shade(dtm2)

sdtm = addLayer(sdtm1, sdtm2)
plot(sdtm, col = gray.colors(50,0,1))


# Triangulation
dtm_tin <- rasterize_terrain(ST, res = 1, algorithm = tin())
plot_dtm3d(dtm_tin, bg = "black") 

# Invert distance weighting
dtm_idw <- rasterize_terrain(ST, algorithm = knnidw(k = 10L, p = 2))
plot_dtm3d(dtm_idw, bg = "black") # semble le plus fin

# Kriging
dtm_kriging <- rasterize_terrain(ST, algorithm = kriging(k = 40))
plot_dtm3d(dtm_kriging, bg = "black") 

mnt <- dtm_tin
```



# Keep only ground data
Que sur données sol de la dernière acquisition sur lidR (triangulation surface))
```{r}
# Modèle numérique de terrain
mnt <- rast("Z:/users/VincyaneBadouard/Lidar/ALS2022/mnt_roi36ha_1m.asc")
plot(mnt)

# Normaliser la hauteur du sol
ST_norm <- lidR::normalize_height(ST, mnt) # applati le relief
plot(ST_norm)# sol plat

# Classifier les points
ST_norm@data[(Z>(-0.2) & Z< 0.5), Classification := 2] 

table(ST_norm@data$Classification) # 7 = bruit, 2 = sol, vegetation = 3,4,5
# plot(ST_norm, color = "Classification") # trop long

# Dénormaliser la hauteur du sol
ST <- lidR::unnormalize_height(ST_norm) 
```

```{r}
# Prendre que ce qui concerne le sol
GP <- copy(ST)
GP@data=GP@data[(Classification==2 | Classification==7),] # Ground Points
GS=ST@data[gpstime %in% GP$gpstime,] # temps gps des tirs dont l'echo est au sol
# question : pq prendre tous les tirs pris en meme temps que les tirs ayant touché le sol, et pas juste prendre les données sol (=2) ?
# Question : pq prendre aussi les Classification = 7 (bruit)

```


# Can we see the Djougoungs?

```{r}
# plot(mnt)

Plot13 <- Paracou %>% 
  filter(Project == "ParacouCIRAD") %>% 
  filter(Plot == "13") %>%
  select(Plot, geometry) %>% 
  unique()

Djougoung_P13 <- Thalweg_Djougoung %>%
  filter(N_parcelle == 13) %>%
  filter(Type == "Djougoung Pété")

plot_dtm3d(mnt, bg = "black") 


plot(mnt, col = terrain.colors(30))
plot(Djougoung_P13, add=T)

ggplot() + 
  geom_sf(data = Plot13) + 
  geom_spatraster(data = mnt, aes(fill = Z)) +
  scale_fill_gradientn(name = "Elevation (m)",
                       colors = terrain.colors(20)) + 
  geom_sf(data = Djougoung_P13) +
  ggtitle("Paracou 2019 P13 - Djougoung petes") + 
  coord_sf()

```
Elevation in the Djougoungs zones different of outside?
```{r}
Djougoung_P13 <- st_set_crs(Djougoung_P13, 2972) # attribuer le dernier crs

In_Djoug1 <- mask(mnt, Djougoung_P13[1,])
In_Djoug2 <- mask(mnt, Djougoung_P13[2,])

plot(In_Djoug1, col = terrain.colors(30),
     main = "P13 - Djougoung Bas-Fond")
plot(In_Djoug2, col = terrain.colors(30),
     main = "P13 - Djougoung Plateau")

```

Dans fufro viewer on ne voit rien meme en ne prenant que les tirs verticaux (plus précis) : trop de bruit donc djougoungs pas différenciables du bruit
