---
title: "Minimise sensors positioning error"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: pdf_document
---
On cherche à minimiser l'écart entre les transmittances dérivées du LiDAR et celles de capteurs LAI2200 (données de validation).

1) Générer une grille dans R : res 0.5, max 2m (discret).
) Calculer les transmittances à ces coordonnées dans AMAPVox (xml LAI2200)

Décaller
- capteurs par capteurs pour le transect 10m (à traiter d’abord car plus simple car moins contraints)
- l’ensemble des capteurs pour le transect 2m (partir de la coordonnée géomètre) 
- si incohérent à notre protocole on reverra la méthode

```{r, include = F}
library(tidyverse)
library(sf)
library(terra)
library(data.table)
library(tidyterra)
```

```{r, include = F}
LAI2200_coord <- as.data.frame(read_csv("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Coordinates/LAI2200_theoretical_UTMxyz.csv")) # LAI2200 sensors coordinates
# names(LAI2200_coord)
LAI2200_coord <- LAI2200_coord %>% select(Id, x,y)
nrow(LAI2200_coord) # 46
```

# Generate a grid of 0.5 res and 2m max
```{r}
est <- data.frame(Id=LAI2200_coord$Id,
                  outer(LAI2200_coord$x, seq(0, 2, by=0.5), FUN = '+'),
                  y=LAI2200_coord$y)
ouest <- data.frame(Id=LAI2200_coord$Id,
                    outer(LAI2200_coord$x, seq(0, 2, by=0.5), FUN = '-'),
                    y=LAI2200_coord$y)

x <- rbind(est, ouest) # 46*2 =92

x <- pivot_longer(x,cols=X1:X5, names_to=NULL, values_to="x") # 46*2*5 = 460

x <- x %>%
  cbind(data.frame(outer(x$y, seq(0, 2, by=0.5), FUN = '+'))) %>%
  rename_with(.fn = tolower, .cols = X1:X5) %>% 
  cbind(data.frame(outer(x$y, seq(0, 2, by=0.5), FUN = '-')))

x <- pivot_longer(x,cols=x1:X5, names_to=NULL, values_to="Y") %>% select(-y) %>% rename(y=Y)

data <- x
```

```{r}
ggplot() +
  geom_point(data=data, aes(x = x, y = y), color = "red",  size = 0.1)+
  geom_point(data=LAI2200_coord, aes(x = x, y = y), color = "black",  size = 0.1)+
  coord_fixed(ratio=1)
```

# Coordinates in UTM 
P16 (x;y) :
NO (285056;581678)
NE (285536;581821)
SE (285680; 581343)
SO (285201; 581199)

```{r}
tab <- read_delim("D:/Mes Donnees/PhD/R_codes/PhD/local2UTM/CoordCoinsP1_16.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)

P=16 # Plot 16
limx = 500 # à changer pour la parcelle concernée
limy = 500 # à changer pour la parcelle concernée

dataUTM <- data %>% 
  mutate(Xutm = (1-x/limx)*(1-y/limy)*tab[P,]$`so x`+(x/limx)*(1-y/limy)*tab[P,]$`se x`+(y/limy)*(1-x/limx)*tab[P,]$`no x`+((x*y)/(limx*limy))*tab[P,]$`ne x`) %>% 
  mutate(Yutm = (1-x/limx)*(1-y/limy)*tab[P,]$`so y`+(x/limx)*(1-y/limy)*tab[P,]$`se y`+(y/limy)*(1-x/limx)*tab[P,]$`no y`+((x*y)/(limx*limy))*tab[P,]$`ne y`)

P16shp <- st_as_sf(terra::vect("D:/Mes Donnees/PhD/SIG_data/Understory-ALT/Parcelles_Understory.shp"))
dataUTMsf <- st_as_sf(dataUTM, coords = c('Xutm','Yutm'))
dataUTMsf <- st_set_crs(dataUTMsf, terra::crs(P16shp))
```

```{r}
ggplot() +
  geom_sf(data = sf::st_cast(P16shp, "LINESTRING")) +
  geom_sf(data = dataUTMsf, col = "red", size = 0.1) +
  ggtitle("Paracou P16 - LAI2200 grid simulation UTM")

# ggsave("Paracou_P16_LAI2200_grid_simulation_UTM_positions.png",
#          path = "D:/Mes Donnees/PhD/Figures/Sensors",
#          width = 15, height = 15, units = "cm", dpi=800, bg="white")
```

```{r}
# write.csv(dataUTM, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LAI2200_theoretical_UTM.csv")
```

# Extract Z coord MNT to Points
```{r}
MNT <- terra::rast("//amap-data.cirad.fr/safe/lidar/ALS/Paracou/2023/rasters/PARACOU2023_DTM_1m.tif") # MNT
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/dtm2023_4ha_HighAlt_buffer.asc"

crs(MNT) <- crs(P16shp)

alt <- extract(MNT, dataUTMsf) %>% # extract z
  rename(Zutm = MNT_0.5m_IRD_500m_Paracou_284000_579500) %>% 
  select(-ID) %>% 
  mutate(Zutm = Zutm +1) # 1 m above the ground

dataxyz <- dataUTM %>% cbind(alt)
```

```{r}
write.csv(dataxyz, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Coordinates/LAI2200_gridsimulation_UTMxyz.csv")
```

