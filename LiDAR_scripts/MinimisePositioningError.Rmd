---
title: "Minimise sensors positioning error"
author: "Vincyane Badouard"
date: "`r Sys.Date()`"
output: pdf_document
---
On cherche à minimiser l'écart entre les transmittances dérivées du LiDAR et celles de capteurs LAI2200 (données de validation).

1) Générer une grille dans R : res 0.5, max 2m (discret).
) Calculer les transmittances à ces coordonnées dans AMAPVox (xml LAI2200)

Décaller
- capteurs par capteurs pour le transect 10m (à traiter d’abord car plus simple car moins contraints)
- l’ensemble des capteurs pour le transect 2m (partir de la coordonnée géomètre) 
- si incohérent à notre protocole on reverra la méthode

```{r, include = F}
library(tidyverse)
library(sf)
library(terra)
library(data.table)
library(tidyterra)
```

```{r, include = F}
LAI2200_coord <- as.data.frame(read_csv("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Coordinates/LAI2200_theoretical_UTMxyz.csv")) # LAI2200 sensors coordinates
# names(LAI2200_coord)
LAI2200_coord <- LAI2200_coord %>% select(Transect, Id, x,y)
nrow(LAI2200_coord) # 46
```

# Generate a grid of 0.5 res and 2m max
```{r}
est <- data.frame(Transect = LAI2200_coord$Transect,
                  Id=LAI2200_coord$Id,
                  outer(LAI2200_coord$x, seq(0, 2, by=0.5), FUN = '+'),
                  y=LAI2200_coord$y)
ouest <- data.frame(Transect = LAI2200_coord$Transect,
                    Id=LAI2200_coord$Id,
                    outer(LAI2200_coord$x, seq(0, 2, by=0.5), FUN = '-'),
                    y=LAI2200_coord$y)

x <- rbind(est, ouest) # 46*2 =92

x <- pivot_longer(x,cols=X1:X5, names_to=NULL, values_to="x") # 46*2*5 = 460

x <- x %>%
  cbind(data.frame(outer(x$y, seq(0, 2, by=0.5), FUN = '+'))) %>%
  rename_with(.fn = tolower, .cols = X1:X5) %>% 
  cbind(data.frame(outer(x$y, seq(0, 2, by=0.5), FUN = '-')))

x <- pivot_longer(x,cols=x1:X5, names_to=NULL, values_to="Y") %>% select(-y) %>% rename(y=Y)

data <- x
```

```{r}
ggplot() +
  geom_point(data=data, aes(x = x, y = y), color = "red",  size = 0.1)+
  geom_point(data=LAI2200_coord, aes(x = x, y = y), color = "black",  size = 0.1)+
  coord_fixed(ratio=1)
```

# Coordinates in UTM 
P16 (x;y) :
NO (285056;581678)
NE (285536;581821)
SE (285680; 581343)
SO (285201; 581199)

```{r}
tab <- read_delim("D:/Mes Donnees/PhD/R_codes/PhD/local2UTM/CoordCoinsP1_16.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)

P=16 # Plot 16
limx = 500 # à changer pour la parcelle concernée
limy = 500 # à changer pour la parcelle concernée

dataUTM <- data %>% 
  mutate(Xutm = (1-x/limx)*(1-y/limy)*tab[P,]$`so x`+(x/limx)*(1-y/limy)*tab[P,]$`se x`+(y/limy)*(1-x/limx)*tab[P,]$`no x`+((x*y)/(limx*limy))*tab[P,]$`ne x`) %>% 
  mutate(Yutm = (1-x/limx)*(1-y/limy)*tab[P,]$`so y`+(x/limx)*(1-y/limy)*tab[P,]$`se y`+(y/limy)*(1-x/limx)*tab[P,]$`no y`+((x*y)/(limx*limy))*tab[P,]$`ne y`)

P16shp <- st_as_sf(terra::vect("D:/Mes Donnees/PhD/SIG_data/Understory-ALT/Parcelles_Understory.shp"))
dataUTMsf <- st_as_sf(dataUTM, coords = c('Xutm','Yutm'))
dataUTMsf <- st_set_crs(dataUTMsf, terra::crs(P16shp))
```

```{r}
ggplot() +
  geom_sf(data = sf::st_cast(P16shp, "LINESTRING")) +
  geom_sf(data = dataUTMsf, col = "red", size = 0.1) +
  ggtitle("Paracou P16 - LAI2200 grid simulation UTM")

# ggsave("Paracou_P16_LAI2200_grid_simulation_UTM_positions.png",
#          path = "D:/Mes Donnees/PhD/Figures/Sensors",
#          width = 15, height = 15, units = "cm", dpi=800, bg="white")
```

# Extract Z coord MNT to Points
```{r}
MNT <- terra::rast("//amap-data.cirad.fr/safe/lidar/ALS/Paracou/2023/rasters/PARACOU2023_DTM_1m.tif") # MNT
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/HighAltitudeFlight/dtm2023_4ha_HighAlt_buffer.asc"

crs(MNT) <- crs(P16shp)

alt <- extract(MNT, dataUTMsf) %>% # extract z
  rename(Zutm = MNT_0.5m_IRD_500m_Paracou_284000_579500) %>% 
  select(-ID) %>% 
  mutate(Zutm = Zutm +1) # 1 m above the ground

dataxyz <- dataUTM %>% cbind(alt)
```

```{r}
write.csv(dataxyz, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Coordinates/LAI2200_gridsimulation_UTMxyz.csv")
```

# Coordinates in local positions (use VOP)
```{r}
# path <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Grid_4ha_10x10m_each1mZ_UTMxyz.csv"
# "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LAI2200_theoretical_UTMxyz.csv"

dataxyz <- as.data.table(dataxyz)
# dataxyz <- as.data.table(read.csv(path))
VOP <- as.matrix(read.table("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/VOP_P16_9ha.txt"))

matrix <- as.matrix(dataxyz[, `:=`(c = 0 , d = 1)][,.(Xutm, Yutm, c, d)]) # as matrix of the same dimensions, without Z

datalocal <- matrix %*% t(VOP) # same dimensions

datalocal <- cbind(datalocal,dataxyz[,Zutm])[, -c(3,4)] # add Zutm

ggplot() +
  geom_point(data=as.data.frame(datalocal), aes(x = V1, y = V2), col = "red", size = 0.1) 

```

```{r}
write.csv(datalocal, "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Coordinates/LAI2200_gridsimulation_local.csv")
```

# AMAPVox
```{r}
# library(AMAPVox)
# 
# xmlfile <- "//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/LowAltitudeFlight/Intensity_2m/XML/Light/P16_2023_4ha_buffer_LowAlt_LAI2200_coordsimulations_intensity2m.xml"
# 
# # For the 1st time
# AMAPVox::run(xml = xmlfile, jvm.option = "-Xms16g") # pour allouer 16Go de RAM # 

```

# After AMAPVox
```{r}
Read_LAI2200_Transfile <- function(path){
  data <- read_table(path) %>% 
    # mutate(LiDAR = "HighAlt") %>% 
    rename(Transmittance = transmittance) %>% 
    select(-c(position.ID, pathLength, isOut, elevation, cross_NA))
}
```

```{r}
LiDAR <- unique(Read_LAI2200_Transfile("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/lowAltitudeFlight/Intensity_2m/P16_2023_LowAlt_4ha_buffer_LAI2200sim_coordsimulations_intensity2m_test.txt"))
```

```{r}
LiDAR <- LiDAR %>% 
  group_by(`position.x`, `position.y`, `position.z`, ring) %>%
  mutate(MeanTransmittance_LowInt2m = mean(Transmittance)) %>%
  mutate(SdTransmittance_LowInt2m = sd(Transmittance)) %>%
  mutate(SeTransmittance_LowInt2m = plotrix::std.error(Transmittance)) %>%
  ungroup() %>%
  select(-c(Transmittance, azimut)) %>%
  unique() 

```

## Local to UTM coord
```{r}
# Lecture matrice de transformation
VOP <- as.matrix(read.table("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/VOP_P16_9ha.txt"))

# Apply inverse of VOP matrix to convert back to UTM
LiDAR <- setDT(LiDAR)
xyz <- tcrossprod(as.matrix(LiDAR[, .(position.x, position.y, position.z, c=1)]), solve(VOP))
LiDAR[, `:=`(Xutm = xyz[, 1], Yutm = xyz[, 2], Zutm = xyz[, 3])]
LiDAR <- setDF(LiDAR) %>% rename(Ring = ring) # %>%
# mutate(Xutm = round(Xutm),
#        Yutm = round(Yutm),
#        Zutm = round(Zutm))
rm(VOP,xyz)
```

# Add transect and Id info in LiDAR data
```{r}
grid <- read.csv("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Coordinates/LAI2200_gridsimulation_UTMxyz.csv") %>% 
  select(Xutm,Yutm,Zutm, Transect, Id) %>% 
  mutate(Xutm = round(as.numeric(Xutm), digits = 1)) %>% 
  mutate(Yutm = round(as.numeric(Yutm), digits = 1)) %>% 
  mutate(Zutm = round(as.numeric(Zutm), digits = 1))


LiDAR <- LiDAR %>% 
  mutate(Xutm = round(as.numeric(Xutm), digits = 1)) %>% 
  mutate(Yutm = round(as.numeric(Yutm), digits = 1)) %>% 
  mutate(Zutm = round(as.numeric(Zutm), digits = 1)) %>% 
  left_join(grid, by= c("Xutm","Yutm","Zutm")) 
```

## Load LAI2200 data
```{r, include = F}
LAI2200_coord <- read_csv("//amap-data.cirad.fr/work/users/VincyaneBadouard/Lidar/ALS2023/Coordinates/LAI2200_theoretical_UTMxyz.csv") # LAI2200 sensors coordinates
LAI2200_data <- read_csv("D:/Mes Donnees/PhD/Light/LAI-2200/LAI2200_data.csv") # LAI2200 sensors data

names(LAI2200_coord) # "Transect", "Id", "Xutm","Yutm","Zutm"
names(LAI2200_data) # "Id", "Transect", "Ring", "Transmittance_mean" (Transmittance_mean for each sensor and for each ring)

LAI2200_data <- LAI2200_data %>% 
  select(Transect, Id, Ring, Transmittance_mean, Transmittance_sd) 

LAI2200 <- LAI2200_coord %>% 
  select(Transect, Id, Xutm, Yutm, Zutm) %>% 
  left_join(LAI2200_data, by= c("Transect", "Id")) %>% 
  mutate(Ring = case_when(
    Ring == "Ring1" ~ 1,
    Ring == "Ring2" ~ 2,
    Ring == "Ring3" ~ 3,
    Ring == "Ring4" ~ 4,
    Ring == "Ring5" ~ 5)) %>% 
  mutate(Xutm = round(as.numeric(Xutm), digits = 1)) %>% 
  mutate(Yutm = round(as.numeric(Yutm), digits = 1)) %>% 
  mutate(Zutm = round(as.numeric(Zutm), digits = 1)) 

nrow(unique(LAI2200 %>% select(Xutm,Yutm,Zutm))) # 45 <- 20+26 LAI2200 dont 1 en commun

rm(LAI2200_coord)
```

```{r}
LAI2200 <- LAI2200 %>%
  rename(MeanTransmittance_LAI2200 = Transmittance_mean) %>% # mean
  group_by(Transect, Id, Ring) %>%
  mutate(SeTransmittance_LAI2200 = plotrix::std.error(MeanTransmittance_LAI2200)) %>% # standard error
  ungroup() %>% 
  select(Transect,Id, Xutm,Yutm, Zutm, Ring, MeanTransmittance_LAI2200, Transmittance_sd, SeTransmittance_LAI2200) %>% 
  unique()
```

## Combine LiDAR and LAI2200 data
```{r}
LAI2200_LiDAR <- LiDAR %>% 
  left_join(LAI2200, by= c("Transect", "Id", "Ring"), suffix = c(".sim", ".init"))

# NA_table <- LAI2200_LiDAR[rowSums(is.na(LAI2200_LiDAR[, c(25, 34:36)])) > 0,] # NA ?
```

```{r}
rm(NA_table)
```

# Compute differences
```{r}
# names(LAI2200_LiDAR)
LAI2200_LiDAR <- LAI2200_LiDAR %>% 
  select(-c(position.x, position.y, position.z)) %>%
  unique() %>% 
  # compute differences (4-3=1, le rslt informe sur la valeur à laquelle on soustrait)
  mutate(Transmittance_LowInt2mvsLAI2200 = MeanTransmittance_LowInt2m - MeanTransmittance_LAI2200) 
```

```{r}
range(LAI2200_LiDAR$Transmittance_LowInt2mvsLAI2200) # -0.6222959  0.3474904
```
# Difference plots
```{r}
P16shp <- st_as_sf(terra::vect("D:/Mes Donnees/PhD/SIG_data/Understory-ALT/Parcelles_Understory.shp"))

LAI2200_LiDAR1 <- LAI2200_LiDAR %>% filter(Ring==1)

LAI2200_LiDARsf <- st_as_sf(LAI2200_LiDAR1, coords = c('Xutm.sim','Yutm.sim'))
LAI2200_LiDARsf <- st_set_crs(LAI2200_LiDARsf, crs(P16shp))

# LAI2200_LiDARsf <- LAI2200_LiDARsf %>% filter(Ring==1)

ggplot() +
  # geom_sf(data = sf::st_cast(P16shp, "LINESTRING")) + # zone of interest
  geom_sf(data = LAI2200_LiDARsf, aes(color = Transmittance_LowInt2mvsLAI2200), size = 0.5) + 
  scale_color_gradient2(name = "Transmittance LowInt2m vs LAI2200",
                        low="blue", high="red", mid = "white", midpoint = 0) +
  theme(title=element_text(size=16),  axis.text=element_text(size=14),
        legend.title=element_text(size=16), legend.text=element_text(size=16)) +
  ggtitle("Paracou P16 4ha - Transmittances differences - simulations")

ggsave("P16_2023_4ha_Transmittances_LowInt2m_diff_simulations.png",
       path = "D:/Mes Donnees/PhD/Figures/lidar/Coordinates_simulations",
       width = 30, height = 35, units = "cm", dpi=800, bg="white")
```

# Select the coordinates with the minimum difference
```{r}
Betters <- LAI2200_LiDAR %>%
  filter(Ring==1) %>%  
  group_by(Transect, Id) %>% 
  # mutate(Better = ifelse(Transmittance_LowInt2mvsLAI2200 == min(Transmittance_LowInt2mvsLAI2200, T, F)))
  # mutate(Better = sapply(seq_along(Transmittance_LowInt2mvsLAI2200),
  #                        function(i) Transmittance_LowInt2mvsLAI2200[i] == min(Transmittance_LowInt2mvsLAI2200[-i])
  # )) %>% 
  slice(which.min(Transmittance_LowInt2mvsLAI2200)) %>% 
  ungroup()
```

```{r}
range(Betters$Transmittance_LowInt2mvsLAI2200) # -0.6222959  0.3474904 -> -0.622295850  0.005005201
```

# Difference plots
```{r}
Betters_sf <- st_as_sf(Betters, coords = c('Xutm.sim','Yutm.sim'))
Betters_sf <- st_set_crs(Betters_sf, crs(P16shp))

ggplot() +
  # geom_sf(data = sf::st_cast(P16shp, "LINESTRING")) + # zone of interest
  geom_sf(data = Betters_sf, aes(color = Transmittance_LowInt2mvsLAI2200), size = 3) + 
  scale_color_gradient2(name = "Transmittance LowInt2m vs LAI2200",
                        low="blue", high="red", mid = "white", midpoint = 0) +
  theme(title=element_text(size=16),  axis.text=element_text(size=14),
        legend.title=element_text(size=16), legend.text=element_text(size=16)) +
  ggtitle("Paracou P16 4ha - Mimimum transmittances differences - simulations")

ggsave("P16_2023_4ha_Mimimum_transmittances_LowInt2m_diff_simulations.png",
       path = "D:/Mes Donnees/PhD/Figures/lidar/Coordinates_simulations",
       width = 30, height = 35, units = "cm", dpi=800, bg="white")
```

